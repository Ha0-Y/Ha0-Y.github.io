<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>D3CTF-d3lgfs - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
WDF PWN
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="D3CTF-d3lgfs" />
<meta property="og:description" content="
WDF PWN
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/d3ctf-d3lgfs/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-30T12:00:00+00:00" />
<meta property="article:modified_time" content="2024-04-30T12:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="D3CTF-d3lgfs"/>
<meta name="twitter:description" content="
WDF PWN
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">D3CTF-d3lgfs</h1>
			<div class="meta">Posted on Apr 30, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>WDF PWN</p>
</blockquote>
<p>çœ‹èµ·æ¥ä½œè€…æ·±å— CLFS.sys è¿«å®³</p>
<h2 id="wdf-æ¡†æ¶">WDF æ¡†æ¶</h2>
<p>å­¦ï¼<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/wdf/">Windows Driver Frameworks</a></p>
<h3 id="deviceentry">DeviceEntry</h3>
<p>ä¾ç„¶æ˜¯å…¥å£</p>
<ul>
<li>æ·»åŠ WDF Deviceçš„å›è°ƒå‡½æ•°</li>
<li>åˆ›å»ºWDF Driver</li>
</ul>
<h3 id="wdf_xxx">WDF_XXX</h3>
<h4 id="wdfdriver">WDFDRIVER</h4>
<h4 id="wdf_driver_config">WDF_DRIVER_CONFIG</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_WDF_DRIVER_CONFIG</span> {
</span></span><span style="display:flex;"><span>  ULONG                     Size;
</span></span><span style="display:flex;"><span>  PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd;
</span></span><span style="display:flex;"><span>  PFN_WDF_DRIVER_UNLOAD     EvtDriverUnload;
</span></span><span style="display:flex;"><span>  ULONG                     DriverInitFlags;
</span></span><span style="display:flex;"><span>  ULONG                     DriverPoolTag;
</span></span><span style="display:flex;"><span>} WDF_DRIVER_CONFIG, <span style="color:#ff79c6">*</span>PWDF_DRIVER_CONFIG;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">WDF_DRIVER_CONFIG_INIT</span>(
</span></span><span style="display:flex;"><span>  [out]          PWDF_DRIVER_CONFIG        Config,
</span></span><span style="display:flex;"><span>  [in, optional] PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>åˆ›å»ºé©±åŠ¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfDriverCreate</span>(
</span></span><span style="display:flex;"><span>  [in]            PDRIVER_OBJECT         DriverObject,
</span></span><span style="display:flex;"><span>  [in]            PCUNICODE_STRING       RegistryPath,
</span></span><span style="display:flex;"><span>  [in, optional]  PWDF_OBJECT_ATTRIBUTES DriverAttributes,
</span></span><span style="display:flex;"><span>  [in]            PWDF_DRIVER_CONFIG     DriverConfig,
</span></span><span style="display:flex;"><span>  [out, optional] WDFDRIVER              <span style="color:#ff79c6">*</span>Driver
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><h4 id="wdfdevice">WDFDEVICE</h4>
<p>åˆ›å»ºè®¾å¤‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>WDFDEVICE_INIT <span style="color:#ff79c6">*</span>DeviceInita
</span></span></code></pre></div><p>GUID interface</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfDeviceCreateDeviceInterface</span>(
</span></span><span style="display:flex;"><span>  [in]           WDFDEVICE        Device,
</span></span><span style="display:flex;"><span>  [in]           <span style="color:#ff79c6">const</span> GUID       <span style="color:#ff79c6">*</span>InterfaceClassGUID,
</span></span><span style="display:flex;"><span>  [in, optional] PCUNICODE_STRING ReferenceString
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>KMDFä¹Ÿå¯ä»¥æŒ‡å®šsymlinkï¼Œè¿™å°±ä¸WDMç±»ä¼¼äº†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfDeviceCreateSymbolicLink</span>(
</span></span><span style="display:flex;"><span>  [in] WDFDEVICE        Device,
</span></span><span style="display:flex;"><span>  [in] PCUNICODE_STRING SymbolicLinkName
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><h4 id="io-queue">IO Queue</h4>
<p>åˆå§‹åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE</span>(
</span></span><span style="display:flex;"><span>  [out] PWDF_IO_QUEUE_CONFIG       Config,
</span></span><span style="display:flex;"><span>  [in]  WDF_IO_QUEUE_DISPATCH_TYPE DispatchType
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">enum</span> <span style="color:#50fa7b">_WDF_IO_QUEUE_DISPATCH_TYPE</span> {
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchInvalid <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchSequential,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchParallel,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchManual,
</span></span><span style="display:flex;"><span>  WdfIoQueueDispatchMax
</span></span><span style="display:flex;"><span>} WDF_IO_QUEUE_DISPATCH_TYPE;
</span></span></code></pre></div><p><code>_WDF_IO_QUEUE_CONFIG</code>ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_WDF_IO_QUEUE_CONFIG</span> {
</span></span><span style="display:flex;"><span>  ULONG                                       Size;
</span></span><span style="display:flex;"><span>  WDF_IO_QUEUE_DISPATCH_TYPE                  DispatchType;
</span></span><span style="display:flex;"><span>  WDF_TRI_STATE                               PowerManaged;
</span></span><span style="display:flex;"><span>  BOOLEAN                                     AllowZeroLengthRequests;
</span></span><span style="display:flex;"><span>  BOOLEAN                                     DefaultQueue;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_DEFAULT                 EvtIoDefault;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_READ                    EvtIoRead;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_WRITE                   EvtIoWrite;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_DEVICE_CONTROL          EvtIoDeviceControl;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_INTERNAL_DEVICE_CONTROL EvtIoInternalDeviceControl;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_STOP                    EvtIoStop;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_RESUME                  EvtIoResume;
</span></span><span style="display:flex;"><span>  PFN_WDF_IO_QUEUE_IO_CANCELED_ON_QUEUE       EvtIoCanceledOnQueue;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">union</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">struct</span> {
</span></span><span style="display:flex;"><span>      ULONG NumberOfPresentedRequests;
</span></span><span style="display:flex;"><span>    } Parallel;
</span></span><span style="display:flex;"><span>  } Settings;
</span></span><span style="display:flex;"><span>  WDFDRIVER                                   Driver;
</span></span><span style="display:flex;"><span>} WDF_IO_QUEUE_CONFIG, <span style="color:#ff79c6">*</span>PWDF_IO_QUEUE_CONFIG;
</span></span></code></pre></div><h3 id="ring3-ä¸-ring0">Ring3 ä¸ Ring0</h3>
<p>é€šä¿¡ä¾ç„¶ä½¿ç”¨ <code>DeviceIoControl</code>ï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨ <code>GUID</code> è·å¾—é©±åŠ¨çš„åå­—</p>
<p>ring0è·å¾—ring3 bufferï¼šinbufferå’Œoutbuffer</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfRequestRetrieveInputBuffer</span>(
</span></span><span style="display:flex;"><span>  [in]            WDFREQUEST Request,
</span></span><span style="display:flex;"><span>                  size_t     MinimumRequiredLength,
</span></span><span style="display:flex;"><span>  [out]           PVOID      <span style="color:#ff79c6">*</span>Buffer,
</span></span><span style="display:flex;"><span>  [out, optional] size_t     <span style="color:#ff79c6">*</span>Length
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">WdfRequestRetrieveOutputBuffer</span>(
</span></span><span style="display:flex;"><span>  [in]            WDFREQUEST Request,
</span></span><span style="display:flex;"><span>  [in]            size_t     MinimumRequiredSize,
</span></span><span style="display:flex;"><span>  [out]           PVOID      <span style="color:#ff79c6">*</span>Buffer,
</span></span><span style="display:flex;"><span>  [out, optional] size_t     <span style="color:#ff79c6">*</span>Length
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>ring3é€šè¿‡guidä¸ring0é€šä¿¡</p>
<ul>
<li>å­˜åœ¨symlinkä¸WDMæ²¡æœ‰åŒºåˆ«</li>
</ul>
<p>WDFé€†å‘ï¼š<a href="https://ioactive.com/wp-content/uploads/2018/09/Reverse_Engineering_and_Bug_Hunting_On_KMDF_Drivers.pdf">Reverse_Engineering_and_Bug_Hunting_On_KMDF_Drivers</a></p>
<p>é€šä¿¡ï¼Œæ¥è‡ªä»£ç ä»“ - <a href="https://github.com/hustd10/Windows-Driver">hustd10/Windows-Driver</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEFINE_GUID(WDF_GUID, xxxx, xx, xx, x,x,x,x,x,x,x,x);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">GetInterfaceDevicePath</span>(GUID<span style="color:#ff79c6">*</span> guid) {
</span></span><span style="display:flex;"><span>	DWORD requiredSize;
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd">int</span> MemberIdx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	HDEVINFO hDeviceInfoset <span style="color:#ff79c6">=</span> SetupDiGetClassDevs(guid, <span style="color:#8be9fd;font-style:italic">NULL</span>, <span style="color:#bd93f9">0</span>, DIGCF_DEVICEINTERFACE <span style="color:#ff79c6">|</span> DIGCF_PRESENT);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (hDeviceInfoset <span style="color:#ff79c6">!=</span> INVALID_HANDLE_VALUE) {
</span></span><span style="display:flex;"><span>		SP_DEVICE_INTERFACE_DATA  DeviceInterfaceData <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>		DeviceInterfaceData.cbSize <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">sizeof</span>(SP_DEVICE_INTERFACE_DATA);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">while</span> (SetupDiEnumDeviceInterfaces(hDeviceInfoset, <span style="color:#8be9fd;font-style:italic">NULL</span>, guid, MemberIdx, <span style="color:#ff79c6">&amp;</span>DeviceInterfaceData)) {
</span></span><span style="display:flex;"><span>			MemberIdx<span style="color:#ff79c6">++</span>;
</span></span><span style="display:flex;"><span>			SP_DEVINFO_DATA DeviceInfoData <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>			DeviceInfoData.cbSize <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">sizeof</span>(SP_DEVINFO_DATA);
</span></span><span style="display:flex;"><span>			SetupDiGetDeviceInterfaceDetail(hDeviceInfoset, <span style="color:#ff79c6">&amp;</span>DeviceInterfaceData, <span style="color:#8be9fd;font-style:italic">NULL</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">&amp;</span>requiredSize, <span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>			SP_DEVICE_INTERFACE_DETAIL_DATA<span style="color:#ff79c6">*</span> DevIntfDetailData <span style="color:#ff79c6">=</span> HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY,
</span></span><span style="display:flex;"><span>				requiredSize);
</span></span><span style="display:flex;"><span>			DevIntfDetailData<span style="color:#ff79c6">-&gt;</span>cbSize <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">sizeof</span>(SP_DEVICE_INTERFACE_DETAIL_DATA);
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> (SetupDiGetDeviceInterfaceDetail(hDeviceInfoset, <span style="color:#ff79c6">&amp;</span>DeviceInterfaceData,
</span></span><span style="display:flex;"><span>				DevIntfDetailData, requiredSize, <span style="color:#ff79c6">&amp;</span>requiredSize, <span style="color:#ff79c6">&amp;</span>DeviceInfoData)) {
</span></span><span style="display:flex;"><span>				printf(<span style="color:#f1fa8c">&#34;DevicePath: %S</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, (TCHAR<span style="color:#ff79c6">*</span>)DevIntfDetailData<span style="color:#ff79c6">-&gt;</span>DevicePath);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			HeapFree(GetProcessHeap(), <span style="color:#bd93f9">0</span>, DevIntfDetailData);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		SetupDiDestroyDeviceInfoList(hDeviceInfoset);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å·¥å…·</p>
<ul>
<li>WinObjEx</li>
<li>deviceTree</li>
</ul>
<h3 id="åŠ è½½é©±åŠ¨">åŠ è½½é©±åŠ¨</h3>
<p>åˆšå¼€å§‹æ˜¯å’ŒWDMä¸€æ ·ï¼ŒOSRLoaderåŠ è½½ï¼Œä½†æ˜¯åé¢æ‰¾ä¸åˆ°è®¾å¤‡ã€‚å› æ­¤å¿«é€Ÿå…¥é—¨äº†ä¸€ä¸‹å¼€å‘ï¼Œå‘ç°å¯ä»¥ä½¿ç”¨WDKé‡Œé¢çš„å·¥å…·å®‰è£…</p>
<ul>
<li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-a-very-small-kmdf--driver#build-the-driver">ç¼–å†™ Hello World Windows é©±åŠ¨ç¨‹åº (KMDF)</a></li>
</ul>
<p>éœ€è¦æ ¹æ®<code>inf</code>æ–‡ä»¶çš„å†…å®¹ï¼Œä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼è¿›è¡Œå®‰è£…ï¼ˆç›´æ¥å®‰è£…åˆ°<code>C:\System32\drivers</code>ï¼Œå¼€æœºè‡ªå¯ï¼‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span><span style="color:#6272a4"># root\xxx éœ€è¦æ ¹æ®infæ–‡ä»¶è·å¾—</span>
</span></span><span style="display:flex;"><span>devcon.exe install xxx.inf root\xxx
</span></span></code></pre></div><p>WDMä¹Ÿå¯ä»¥æ ¹æ®å‘½ä»¤è¡Œè¿›è¡ŒåŠ è½½ <code>sc.exe</code></p>
<ul>
<li><a href="https://learn.microsoft.com/zh-cn/windows-server/administration/windows-commands/sc-create">sc.exe create | Microsoft Learn</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">sc </span>&lt;server&gt; [command] [service name] &lt;option1&gt; &lt;option2&gt;
</span></span></code></pre></div><h2 id="é©±åŠ¨é€†å‘">é©±åŠ¨é€†å‘</h2>
<p>æœ‰ç¬¦å·è¡¨ï¼Œæ¯”è¾ƒå‹å¥½</p>
<p>è·å¾—å¯¹åº”çš„ç›®å½•ï¼Œå°†pdbæ”¾å…¥ï¼Œå°±å¯ä»¥å¸¦ç¬¦å·è°ƒè¯•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span>!sym noisy
</span></span></code></pre></div><p>ceateMyLogFile</p>
<ul>
<li><code>InBuf</code> æŒ‡å®š filename</li>
<li><code>logfilemem</code>  BIGPOOL è½¬åŒ–ä¸º<code>struct myLOG_HEADER</code></li>
<li><code>logfilemem-&gt;logname</code> POOL</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">myLOG_HEADER</span>   <span style="color:#6272a4">// size 0x228
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>{
</span></span><span style="display:flex;"><span>  myCLFS_METADATA_RECORD_HEADER hdrBaseRecord;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> logID;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>logName;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> Containers;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbBusyContainers;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> rgContainers[<span style="color:#bd93f9">128</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbSymbolZone;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbSector;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">myCLFS_METADATA_RECORD_HEADER</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> magic;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>add container</p>
<ul>
<li>ä¼ é€’å‚æ•° <code>addLogContainer_parm</code>ï¼Œæ ¹æ®nameåˆ›å»ºä¸€ä¸ª myContainer</li>
<li>cbSymbolZone åç§»ï¼Œç»“æ„ä½“çš„ä¸‹ä¸€ä¸ªèµ·å§‹ä½ç½®</li>
<li>rgContainers åœ¨POOLä¸­çš„èµ·å§‹ä½ç½®</li>
<li>Containers è®°å½•ä¸ªæ•°</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span>  <span style="color:#50fa7b">addLogContainer_parm</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>logFile;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> nameLen;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> containerName[];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__cppobj</span> <span style="color:#8be9fd;font-style:italic">myContainer</span> : baseContainer
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__cppobj</span> baseContainer
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  baseContainer_vtbl <span style="color:#ff79c6">*</span>__vftable <span style="color:#6272a4">/*VFT*/</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>fileName;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> /*<span style="color:#50fa7b">VFT</span>*/ baseContainer_vtbl
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>write_data)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>removeContainer)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>releaseContainer)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>read_data)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>read_meta_data)(baseContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// vtable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">__fastcall</span> myContainer<span style="color:#ff79c6">::</span>write_data(myContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  strncpy_0(<span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data, data, <span style="color:#bd93f9">0x200u</span>i64);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">__fastcall</span> myContainer<span style="color:#ff79c6">::</span>read_data(myContainer <span style="color:#ff79c6">*</span><span style="color:#ff79c6">this</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  strncpy_0(data, <span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data, <span style="color:#bd93f9">0x200u</span>i64);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// data
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)ExAllocatePool2(<span style="color:#bd93f9">64</span>i64, <span style="color:#bd93f9">0x7228</span>i64, &#39;gl3d&#39;);<span style="color:#6272a4">// 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// #define POOL_FLAG_NON_PAGED               0x0000000000000040UI64     // Non paged pool NX
</span></span></span></code></pre></div><p>è®°å½•ä¸‹ä¸€ä¸ªå—çš„åç§»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> ( logFile<span style="color:#ff79c6">-&gt;</span>Containers )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	thisContainer<span style="color:#ff79c6">-&gt;</span>cbPrevOffset <span style="color:#ff79c6">=</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[logFile<span style="color:#ff79c6">-&gt;</span>Containers <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> <span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[<span style="color:#bd93f9">47</span>] <span style="color:#ff79c6">+</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[logFile<span style="color:#ff79c6">-&gt;</span>Containers <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]) <span style="color:#ff79c6">=</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[logFile<span style="color:#ff79c6">-&gt;</span>Containers];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>read/writeLogRecord</p>
<ul>
<li>containerå‡½æ•°è°ƒç”¨</li>
</ul>
<p>è¿™ä¸ªcontext</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__declspec</span>(align(<span style="color:#bd93f9">8</span>)) LogRecord_parm
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>logFile;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> ContainerID;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> data[<span style="color:#bd93f9">512</span>];        <span style="color:#6272a4">// ExAllocatePool 0x200
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// size 0xe0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">my_CLFS_CONTAINER_CONTEXT</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> cidContainer;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> containerName[<span style="color:#bd93f9">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">union</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  myContainer <span style="color:#ff79c6">*</span>pContainer;               <span style="color:#6272a4">// new myContainer, size 0x18
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> ullAlignment;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbPrevOffset;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbNextOffset;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>remove container</p>
<ul>
<li>ä¿®æ”¹äº† <code>cbNextOffset</code>ï¼Œä¿®æ”¹åç§» <code>cbSymbolZone</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">__declspec</span>(align(<span style="color:#bd93f9">8</span>)) removeLogContainer_parm
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>logFile;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> ContainerID;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">removeLogContainer</span>(myLOG_HEADER <span style="color:#ff79c6">*</span>logFile, <span style="color:#8be9fd">signed</span> <span style="color:#8be9fd">int</span> ContainerID)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  my_CLFS_CONTAINER_CONTEXT <span style="color:#ff79c6">*</span>thisContainer; <span style="color:#6272a4">// [rsp+28h] [rbp-30h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  myContainer <span style="color:#ff79c6">*</span>pContainer; <span style="color:#6272a4">// [rsp+30h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( ContainerID <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">||</span> ContainerID <span style="color:#ff79c6">&gt;</span> logFile<span style="color:#ff79c6">-&gt;</span>Containers )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0xFFFFFFFF</span>i64;
</span></span><span style="display:flex;"><span>  thisContainer <span style="color:#ff79c6">=</span> (my_CLFS_CONTAINER_CONTEXT <span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)logFile <span style="color:#ff79c6">+</span> logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[ContainerID]);
</span></span><span style="display:flex;"><span>  pContainer <span style="color:#ff79c6">=</span> thisContainer<span style="color:#ff79c6">-&gt;</span>pContainer;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( pContainer )
</span></span><span style="display:flex;"><span>    myContainer<span style="color:#ff79c6">::</span>`scalar deleting destructor&#39;(pContainer, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> <span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>logFile<span style="color:#ff79c6">-&gt;</span>rgContainers[<span style="color:#bd93f9">46</span>] <span style="color:#ff79c6">+</span> thisContainer<span style="color:#ff79c6">-&gt;</span>cbNextOffset) <span style="color:#ff79c6">=</span> thisContainer<span style="color:#ff79c6">-&gt;</span>cbPrevOffset;
</span></span><span style="display:flex;"><span>  logFile<span style="color:#ff79c6">-&gt;</span>cbSymbolZone <span style="color:#ff79c6">-=</span> <span style="color:#bd93f9">0xE0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">--</span>logFile<span style="color:#ff79c6">-&gt;</span>Containers;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>i64;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>closeLogFileï¼šæ¸…ç©ºæ‰€æœ‰çš„containerä»¥åŠlogfileMem</p>
<p>å…¶å¤§è‡´å†…å­˜ç»“æ„ï¼Œåœ¨ä¸€ä¸ªBIGPOOLä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>myLOG_HEADER           å¤§å°<span style="color:#bd93f9">0x228</span>
</span></span><span style="display:flex;"><span>	cbSymbolZone è¡¨ç¤ºå¯ç”¨å†…å­˜çš„èµ·å§‹åœ°å€
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>æ³¨å†Œä¸€ä¸ªcontainer æœ€å¤šå¯ä»¥æ³¨å†Œ<span style="color:#bd93f9">128</span>ä¸ª my_CLFS_CONTAINER_CONTEXT <span style="color:#bd93f9">0xe0</span>
</span></span><span style="display:flex;"><span>	pContainer <span style="color:#bd93f9">0x18</span> myContainer ç»“æ„ä½“
</span></span><span style="display:flex;"><span>	cbPrevOffset è®°å½•å‰ä¸€ä¸ª container èµ·å§‹åœ°å€åç§»
</span></span><span style="display:flex;"><span>	cbNextOffset è®°å½•åä¸€ä¸ªèµ·å§‹åœ°å€åç§»
</span></span></code></pre></div><p>è¿™ä¸ª<code>wstrcpy</code>æº¢å‡ºå†™ï¼ŒcontainerName æˆ‘ä»¬ä¼ å…¥ï¼Œé•¿åº¦éšæ„ï¼Œ<code>thisContainer-&gt;containerName</code> åªæœ‰100çš„é•¿åº¦ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>wstrcpy(thisContainer<span style="color:#ff79c6">-&gt;</span>containerName, containerName, len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// å‡½æ•°ä¹Ÿå­˜åœ¨ä¸€ä¸ªæº¢å‡º è¯»/å†™ wchar
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">wstrcpy</span>(<span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>dst, <span style="color:#8be9fd">wchar_t</span> <span style="color:#ff79c6">*</span>src, <span style="color:#8be9fd">int</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+0h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> len <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    dst[i] <span style="color:#ff79c6">=</span> src[i];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">my_CLFS_CONTAINER_CONTEXT</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> cidContainer;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">wchar_t</span> containerName[<span style="color:#bd93f9">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">union</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  myContainer <span style="color:#ff79c6">*</span>pContainer;               <span style="color:#6272a4">// new myContainer, size 0x18
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> ullAlignment;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbPrevOffset;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> cbNextOffset;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>æ²¡æœ‰é™åˆ¶çš„æº¢å‡ºï¼Œæˆ‘ä»¬æŸ¥ä¸€ä¸‹æ± çš„åŸºåœ°å€ï¼Œå°†containeråœ°å€æ”¹æˆæ± ä¸­çš„åœ°å€ï¼Œç„¶åè¦†ç›–containeråœ°å€ï¼Œä¼ªé€ ä¸€ä¸ªcontainer</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>logfileMem <span style="color:#ff79c6">=</span> (myLOG_HEADER <span style="color:#ff79c6">*</span>)ExAllocatePoolWithTag(NonPagedPool, <span style="color:#bd93f9">0x7228u</span>i64, <span style="color:#bd93f9">0x4C674673u</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// å¦ä¸€ä¸ªå¤§æ± ï¼ŒTAGä¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">-&gt;</span>data <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)ExAllocatePool2(<span style="color:#bd93f9">64</span>i64, <span style="color:#bd93f9">0x7228</span>i64, &#39;gl3d&#39;);
</span></span></code></pre></div><h3 id="exploit">Exploit</h3>
<p>æˆ‘é¦–å…ˆå°è¯•äº†ä½¿ç”¨ç»™å‡ºçš„ä»»æ„è¯»å†™åŸè¯­ã€‚</p>
<ul>
<li>å¤šæ¬¡è“å±åæ„è¯†åˆ°è¿™æ ¹æœ¬ä¸æ˜¯ <code>strcpy</code>ï¼Œè€Œæ˜¯ <code>memcpy</code> ï¼Œæ²¡æœ‰<code>\x00</code>æˆªæ–­</li>
<li>å› æ­¤å°è¯•è¯»å†™tokenæœ‰ç‚¹é—®é¢˜ï¼Œé•¿åº¦0x200çš„memcpyï¼Œå†™å…¥0x200 tokenç›´æ¥è“å±ï¼Œå¹¶ä¸”æ¥æ”¶ä¸åˆ°å†…å®¹</li>
</ul>
<p>NonPagedPoolæ˜¯å¯æ‰§è¡Œçš„ï¼Œä½†æ˜¯å› ä¸ºshellcodeé‡Œå­˜åœ¨ <code>0x0000</code> æ— æ³•ç›´æ¥å†™å…¥å…¨éƒ¨shellcodeï¼Œå¯ä»¥å°è¯•ROP</p>
<p>ä½¿ç”¨äº†HEVDï¼š<code>mov esp gadget</code>ï¼Œç›´æ¥å¤±è´¥äº†ï¼Œæ˜¾ç¤ºè®¿é—®éæ³•å†…å­˜ã€‚</p>
<p>CLFS ROP CVE å­˜åœ¨ç›¸å…³,ä¸é”™çš„gadget: <code>RtlClearBit</code> å’Œ <code>SeSetAccessStateGenericMapping</code></p>
<ul>
<li><a href="https://www.coresecurity.com/core-labs/articles/analysis-cve-2023-28252-clfs-vulnerability">Analysis of CVE-2023-28252 CLFS Vulnerability</a></li>
<li><a href="https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part2-exploit-analysis">CVE-2022-37969 | Windows CLFS Zero-Day</a></li>
<li><a href="https://mas0n.org/94f74a6b0a844648b46728a89c5cbb03#d8a5fc8f50974a07b90186c2cc43115d">CVE-2022-37969</a></li>
<li><a href="https://blog.qwerdf.com/2022/11/30/CVE-2022-37969/#%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF%E5%8F%82%E8%80%83">CVE-2022-37969</a></li>
</ul>
<p>SeSetAccessStateGenericMapping  ä¿®æ”¹ <code>_ETHREAD._KTHREAD.PreviousMode</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> u SeSetAccessStateGenericMapping
</span></span><span style="display:flex;"><span>nt<span style="color:#ff79c6">!</span><span style="color:#8be9fd;font-style:italic">SeSetAccessStateGenericMapping</span>:
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>b0 <span style="color:#bd93f9">488</span>b4148        mov     rax,qword ptr [rcx<span style="color:#ff79c6">+</span><span style="color:#bd93f9">48</span>h]
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>b4 <span style="color:#bd93f9">0f</span><span style="color:#bd93f9">1002</span>          movups  xmm0,xmmword ptr [rdx]
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>b7 f30f7f4008      movdqu  xmmword ptr [rax<span style="color:#ff79c6">+</span><span style="color:#bd93f9">8</span>],xmm0
</span></span><span style="display:flex;"><span>fffff800`<span style="color:#bd93f9">06e712</span>bc c3              ret
</span></span></code></pre></div><p>æ­¤å¤„rcxæ˜¯pContainerï¼Œå·²çŸ¥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>thisContainer<span style="color:#ff79c6">-&gt;</span>pContainer<span style="color:#ff79c6">-&gt;</span>read_data(thisContainer<span style="color:#ff79c6">-&gt;</span>pContainer, data);
</span></span></code></pre></div><p><code>[rdx]</code>å¯ä»¥æ˜¯0ï¼ˆç”¨æˆ·bufferï¼‰ï¼Œ<code>rax+8</code> è®¾ç½®ä¸º<code>_ETHREAD._KTHREAD.PreviousMode</code>åœ°å€ã€‚</p>
<p>SeSetAccessStateGenericMappingåç§»æˆ‘å®åœ¨windbgç›´æ¥æ‰¾ï¼Œä¸å¤Ÿè‡ªåŠ¨åŒ–ï¼Œçœ‹CVEæ—¶å‘ç°å¯ä»¥ä½¿ç”¨æ‰¾å‡½æ•°çš„æ–¹æ³•æ¥ç›´æ¥è·å¾—ğŸ˜‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// https://github.com/fortra/CVE-2022-37969/blob/main/CVE-2022-37969-PoC.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>HMODULE ntos_userBase <span style="color:#ff79c6">=</span> LoadLibraryExW(<span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;ntoskrnl.exe&#34;</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (ntos_userBase)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	v22a <span style="color:#ff79c6">=</span> GetProcAddress(ntos_userBase, <span style="color:#f1fa8c">&#34;SeSetAccessStateGenericMapping&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>offset_SeSetAccess <span style="color:#ff79c6">=</span> (UINT64)v22a <span style="color:#ff79c6">-</span> (UINT64)ntos_userBase;
</span></span><span style="display:flex;"><span>printf(<span style="color:#f1fa8c">&#34;[+] Offset SeSetAccessStateGenericMapping ----------&gt; %p</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, offset_SeSetAccess);
</span></span><span style="display:flex;"><span>fnSeSetAccessStateGenericMapping <span style="color:#ff79c6">=</span> ntos_kernelBase <span style="color:#ff79c6">+</span> offset_SeSetAccess;
</span></span></code></pre></div><p>å› æ­¤æœ€åä¿®æ”¹ <code>PreviousMode</code> ä¸º0ï¼Œä»»æ„åœ°å€è¯»å†™ï¼Œä¿®æ”¹tokenï¼ŒææƒæˆåŠŸã€‚</p>
<p>ä»£ç ä»“åº“ - <a href="https://github.com/ldrx30/WP">CTF WP</a></p>
<p>ä½¿ç”¨ <code>RtlClearBit</code> ä¹Ÿå¯ä»¥æ„é€ å‡ºåŒæ ·çš„æ•ˆæœ - æ˜¯å°† <code>[rcx+8]</code> åœ°å€åŠ ä¸Š <code>edx</code> åç§»ç½®ä¸º0ï¼Œä½†æ˜¯è¿™ä¸ªedxè¿˜æ˜¯å¾—æ§åˆ¶ä¸€ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> u nt<span style="color:#ff79c6">!</span>RtlClearBit
</span></span><span style="display:flex;"><span>nt<span style="color:#ff79c6">!</span><span style="color:#8be9fd;font-style:italic">RtlClearBit</span>:
</span></span><span style="display:flex;"><span>fffff802`<span style="color:#bd93f9">1615</span>c150 <span style="color:#bd93f9">488</span>b4108        mov     rax,qword ptr [rcx<span style="color:#ff79c6">+</span><span style="color:#bd93f9">8</span>]
</span></span><span style="display:flex;"><span>fffff802`<span style="color:#bd93f9">1615</span>c154 <span style="color:#bd93f9">0f</span>b310          btr     dword ptr [rax], edx
</span></span><span style="display:flex;"><span>fffff802`<span style="color:#bd93f9">1615</span>c157 c3              ret
</span></span></code></pre></div><h3 id="æ³¨æ„">æ³¨æ„</h3>
<p>WinDbgå‘½ä»¤è¡Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span>windbg.exe -k -d net:port=&lt;YourDebugPort&gt;,key=&lt;YourKey&gt;
</span></span></code></pre></div><p>éœ€è¦æ³¨æ„ <code>ZwCreateFile</code> è®¿é—®æ–‡ä»¶ <code>C:\\Users:\\Public\\tmp.log</code> éœ€è¦æ˜¯ <code>\\??\\C:\\Users\\Public\\tmp.log</code> æ‰èƒ½æ­£ç¡®è¯†åˆ«</p>
<ul>
<li>å†…æ ¸å’Œç”¨æˆ·çœ‹åˆ°çš„ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿</li>
<li><a href="https://www.cnblogs.com/geons/p/8685175.html">Windowså†…æ ¸é©±åŠ¨ä¸­æ“ä½œæ–‡ä»¶</a></li>
</ul>
<p>ä¼ å…¥æ•°æ®æ—¶ï¼Œå› ä¸ºwstrcpyæœ¬èº«å­˜åœ¨é—®é¢˜ï¼Œå› æ­¤å¯èƒ½è®¿é—®ä¸èƒ½è®¿é—®çš„é¡µ</p>
<p>æ¯”å¦‚æ•°æ®å¡«æ»¡ï¼Œå°±ä¼šè®¿é—®åé¢çš„æ•°æ®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>AAAAAAAAAA <span style="color:#ff79c6">&lt;-</span> è®¿é—®åˆ°è¿™é‡Œæ—¶ï¼Œæº¢å‡ºé¡µå¤§æ¦‚ç‡å´©æºƒ
</span></span><span style="display:flex;"><span>PAGE
</span></span></code></pre></div><p>å› æ­¤æˆ‘ä»¬ä¼ é€’å‚æ•°æ—¶ï¼Œbufferåé¢éœ€è¦åŠ ä¸€ä¸ªpadding <code>\x00\x00</code> é¿å…è®¿é—®æœªçŸ¥å†…å­˜è€Œè“å±ï¼ˆå› ä¸ºè¿™ä¸ªæ”¹äº†å‡ å°æ—¶çš„BUGğŸ˜­</p>
<p>æ„Ÿè§‰è¿˜ä¸é”™ï¼Œèµ¶åœ¨ç»“æŸå‰åšå‡ºæ¥äº†ï¼Œæœ‰ç‚¹é—æ†¾çš„æ˜¯åšå®Œè¿™ä¸ªä¹‹åæ²¡ç²¾åŠ›çœ‹qemué€ƒé€¸é‚£ä¸ªé¢˜ç›®äº†ã€‚</p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/windows">Windows</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Â© ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
