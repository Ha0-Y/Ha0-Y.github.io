<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>WDM - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
Window Driver Module
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="WDM" />
<meta property="og:description" content="
Window Driver Module
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/wdm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-01-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="WDM"/>
<meta name="twitter:description" content="
Window Driver Module
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">WDM</h1>
			<div class="meta">Posted on Jan 27, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>Window Driver Module</p>
</blockquote>
<h2 id="wdk">WDK</h2>
<p>VSä¸­æ²¡æœ‰æ‰¾åˆ°å•ä¸ªç»„ä»¶çš„è¿™äº›é€‰é¡¹ï¼Œå› æ­¤ä½¿ç”¨å®˜æ–¹çš„æ–¹æ³•ä¸‹è½½ï¼Œå•ç‹¬ä¸‹è½½sdkå’Œwdk</p>
<ul>
<li><a href="https://blog.csdn.net/qq_44240304/article/details/127549383">window10+vs2022é…ç½®windowé©±åŠ¨å¼€å‘ç¯å¢ƒ</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/download-the-wdk">ä¸‹è½½ Windows é©±åŠ¨ç¨‹åºå·¥å…·åŒ… (WDK) - Windows drivers</a></li>
</ul>
<p>ç„¶åä¼šæœ‰ä¸€ä¸ª <code>VSIX Installer</code>ï¼Œä¸‹è½½å¥½ä¹‹åï¼Œæˆ‘ä»¬çš„VSå°±å¯ä»¥å¼€å‘äº†</p>
<p>æ–°å»ºé¡¹ç›®ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ° <code>Driver</code> é€‰é¡¹</p>
<p>æˆ–è€…ä½¿ç”¨Windowsæä¾›çš„è™šæ‹Ÿæœº <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Windows VM</a></p>
<h2 id="é©±åŠ¨å¼€å‘">é©±åŠ¨å¼€å‘</h2>
<p>windowsé©±åŠ¨åˆ†ä¸¤ç±»ï¼ŒNTå¼é©±åŠ¨å’ŒWDMé©±åŠ¨ï¼Œåè€…æ”¯æŒå³æ’å³ç”¨ï¼›</p>
<p>å› æ­¤é€‰æ‹© <code>WDM(Windows Driver Model)</code>ï¼Œ æä¾›ä¸€ä¸ªé©±åŠ¨å…¥å£ <code>DriverEntry</code> å’Œ é©±åŠ¨å¸è½½ <code>DriverOnload</code> å‡½æ•°ã€‚éœ€è¦æ³¨æ„C++ çš„åç§°ç²‰ç¢æœºåˆ¶</p>
<p>å³é”®ï¼Œå±æ€§ï¼ŒDriver Setting</p>
<ul>
<li>target OS åœ¨VS2022 + win11 å·²ç»ä¸èƒ½æˆåŠŸç”Ÿæˆwin7ç‰ˆæœ¬</li>
<li>target paltform:<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/develop/target-platforms">é©±åŠ¨ç¨‹åºå‚è€ƒé¡µä¸Šçš„â€œç›®æ ‡å¹³å°â€</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;ntddk.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>EXTERN_C VOID <span style="color:#50fa7b">DriverUnload</span>(PDRIVER_OBJECT DriverObject) {
</span></span><span style="display:flex;"><span>	DbgPrint(<span style="color:#f1fa8c">&#34;Unload Module Demo</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXTERN_C NTSTATUS <span style="color:#50fa7b">DriverEntry</span>(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RigisterEntry) {
</span></span><span style="display:flex;"><span>	DriverObject<span style="color:#ff79c6">-&gt;</span>DriverUnload <span style="color:#ff79c6">=</span> DriverUnload;
</span></span><span style="display:flex;"><span>	DbgPrint(<span style="color:#f1fa8c">&#34;Load Module Demo</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å®˜æ–¹æ¡ˆä¾‹ä¸åƒ helloworld çš„æ ·å­ã€‚<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-your-first-driver">åˆ¶ä½œä½ çš„ç¬¬ä¸€ä¸ªé©±åŠ¨ç¨‹åº </a></p>
<ul>
<li>KMDFæ˜¯ç”±å¾®è½¯æä¾›çš„ä¸€ä¸ªé«˜çº§æŠ½è±¡å±‚ï¼Œå®ƒå»ºç«‹åœ¨WDMï¼ˆWindows Driver Modelï¼‰ä¹‹ä¸Šï¼Œå¹¶æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½å’Œç®€åŒ–é©±åŠ¨ç¨‹åºå¼€å‘çš„æ¥å£ã€‚KMDFæ—¨åœ¨ä½¿é©±åŠ¨ç¨‹åºå¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°ç¼–å†™å’Œç»´æŠ¤å¯é çš„å†…æ ¸æ¨¡å¼é©±åŠ¨ç¨‹åºã€‚</li>
</ul>
<h3 id="é©±åŠ¨å®‰è£…">é©±åŠ¨å®‰è£…</h3>
<p>OSRDriverLoader: <a href="https://www.osronline.com/article.cfm%5earticle=157.htm">Downloads:Driver Loader (osronline.com)</a></p>
<ul>
<li>w2k: windows 2000</li>
<li>WLH: windows vista</li>
<li>WNET: windows 7 åŠä»¥ä¸Šã€‚ä½¿ç”¨é‡Œé¢çš„ <code>AMD64 OSRLOADER</code></li>
<li>WXP: windows XP</li>
</ul>
<h3 id="debug">DEbug</h3>
<p><a href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/debugview">DebugView - Sysinternals</a>: å®ƒå¯ä»¥æ˜¾ç¤º DbgPrint æ‰“å°å‡ºæ¥çš„log</p>
<p>WinDbg: éœ€è¦è®¾ç½®ä¸€ä¸‹,<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-">å›æ˜¾å†…æ ¸æ¨¡å¼è°ƒè¯• Windows é©±åŠ¨ - Windows drivers</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># è°ƒè¯•å™¨ä¸­æ˜¾ç¤ºæ¥è‡ªç›®æ ‡ç³»ç»Ÿçš„æ‰€æœ‰è°ƒè¯•æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>ed nt!Kd_DEFAULT_MASK 0xFFFFFFFF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># æ‰€æœ‰è°ƒè¯•ä¿¡æ¯æœ‰ç‚¹å¤šï¼Œæ‰“å°è°ƒè¯•å­—ç¬¦ä¸²</span>
</span></span><span style="display:flex;"><span>ed nt!Kd_Default_Mask <span style="color:#bd93f9">8</span>
</span></span></code></pre></div><h3 id="r0-ä¸-r3-é€šä¿¡">R0 ä¸ R3 é€šä¿¡</h3>
<p>é©±åŠ¨ç¨‹åºçš„ä¸»è¦åŠŸèƒ½ä¹Ÿå°±æ˜¯è´Ÿè´£å¤„ç†IOè¯·æ±‚ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†IOè¯·æ±‚æ˜¯åœ¨æ´¾é£å‡½æ•°ä¸­å¤„ç†çš„ã€‚</p>
<h4 id="r0">R0</h4>
<p>åˆ›å»ºè®¾å¤‡å¯¹è±¡ï¼šä½¿ç”¨IoCreateDeviceå¿…é¡»ç®¡ç†å‘˜æ‰èƒ½æ‰“å¼€ è€Œä½¿ç”¨IoCreateDeviceSecure åˆ™å¯ä»¥æ™®é€šæƒé™æ‰“å¼€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">IoCreateDevice</span>(
</span></span><span style="display:flex;"><span>  [in]           PDRIVER_OBJECT  DriverObject,
</span></span><span style="display:flex;"><span>  [in]           ULONG           DeviceExtensionSize,
</span></span><span style="display:flex;"><span>  [in, optional] PUNICODE_STRING DeviceName,
</span></span><span style="display:flex;"><span>  [in]           DEVICE_TYPE     DeviceType,
</span></span><span style="display:flex;"><span>  [in]           ULONG           DeviceCharacteristics,
</span></span><span style="display:flex;"><span>  [in]           BOOLEAN         Exclusive,
</span></span><span style="display:flex;"><span>  [out]          PDEVICE_OBJECT  <span style="color:#ff79c6">*</span>DeviceObject
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>è®¾å¤‡åï¼šç¬¦å·é“¾æ¥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">IoCreateSymbolicLink</span>(
</span></span><span style="display:flex;"><span>  [in] PUNICODE_STRING SymbolicLinkName,
</span></span><span style="display:flex;"><span>  [in] PUNICODE_STRING DeviceName
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// MS-DOS å‘½åè§„èŒƒ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>UNICODE_STRING DeviceName;
</span></span><span style="display:flex;"><span>UNICODE_STRING DosDeviceName;
</span></span><span style="display:flex;"><span>NTSTATUS status;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>DeviceName, <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">Device</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DeviceName&#34;</span>);
</span></span><span style="display:flex;"><span>RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>DosDeviceName, <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DosDevices</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DosDeviceName&#34;</span>);
</span></span><span style="display:flex;"><span>status <span style="color:#ff79c6">=</span> IoCreateSymbolicLink(<span style="color:#ff79c6">&amp;</span>DosDeviceName, <span style="color:#ff79c6">&amp;</span>DeviceName);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status)) {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">/* Symbolic link creation failed.  Handle error appropriately. */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// NTè§„èŒƒï¼šæ¯ä¸ªè®¾å¤‡æ¥å£ç±»éƒ½ä¸ GUID ç›¸å…³è”ã€‚KMDF ç»™çš„ä»£ç 
</span></span></span></code></pre></div><p>æ³¨å†Œå›è°ƒå‡½æ•° <code>MajorFunction[IDX](IDX ä»£è¡¨æ³¨å†Œè¯»å†™å‡½æ•°ï¼Œå®å‡½æ•°ï¼Œä¸è¦è¶…è¿‡æœ€å¤§å€¼</code> ï¼›IRP (I/O Request Packet)ï¼›<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object">DRIVER_OBJECT (wdm.h) - Windows drivers </a>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>_Use_decl_annotations_
</span></span><span style="display:flex;"><span>NTSTATUS
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">DispatchXxx</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_DEVICE_OBJECT</span>  <span style="color:#ff79c6">*</span>DeviceObject,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_IRP</span>  <span style="color:#ff79c6">*</span>Irp
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// Function body
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  }
</span></span></code></pre></div><p>åˆ é™¤ç¬¦å·</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">IoDeleteSymbolicLink</span>(
</span></span><span style="display:flex;"><span>  [in] PUNICODE_STRING SymbolicLinkName
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>åˆ é™¤è®¾å¤‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">IoDeleteDevice</span>(
</span></span><span style="display:flex;"><span>  [in] PDEVICE_OBJECT DeviceObject
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>IOæ¡†æ¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;ntddk.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define DRIVER_NAME L&#34;\\Device\\Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define LINK_NAME L&#34;\\DosDevices\\Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">IOCTL æ§åˆ¶ç ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	I/O æ§åˆ¶ä»£ç æ˜¯ç”±å¤šä¸ªå­—æ®µç»„æˆçš„ 32 ä½å€¼ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	#define IOCTL_Device_Function CTL_CODE(DeviceType, Function, Method, Access)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">		DeviceType: æ ‡è¯†è®¾å¤‡ç±»å‹ã€‚ æ­¤å€¼å¿…é¡»ä¸åœ¨é©±åŠ¨ç¨‹åºDEVICE_OBJECTç»“æ„çš„ DeviceType æˆå‘˜ä¸­è®¾ç½®çš„å€¼åŒ¹é…
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">		FunctionCodeï¼š æ ‡è¯†é©±åŠ¨ç¨‹åºè¦æ‰§è¡Œçš„å‡½æ•°ã€‚ å°äº 0x800 çš„å€¼æ˜¯ä¸º Microsoft ä¿ç•™çš„ã€‚ ä¾›åº”å•†å¯ä»¥ä½¿ç”¨ 0x800 å’Œæ›´é«˜å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	#define CTL_CODE(DeviceType, Function, Method, Access) (
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">				(DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">			)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define IOCTRL_BASE 0x800
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MYIOCTRL_CODE(i)	\
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">	CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define CTL_HELLO MYIOCTRL_CODE( 0 )
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>EXTERN_C VOID <span style="color:#50fa7b">DriverUnload</span>(PDRIVER_OBJECT pDriverObject) {
</span></span><span style="display:flex;"><span>	DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;Unload Driver</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// è¿”å›å€¼å¹¶ä¸ä»£è¡¨æˆåŠŸï¼Œè€Œæ˜¯ pIrp-&gt;IoStatus.Status ä»£è¡¨IOæ˜¯å¦æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>NTSTATUS <span style="color:#50fa7b">DispatchCommon</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS; <span style="color:#6272a4">// IRPè®°å½•è¿™æ¬¡æ“ä½œæ˜¯å¦æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;         <span style="color:#6272a4">// Informationç”¨æ¥è®°å½•å®é™…ä¼ è¾“çš„å­—èŠ‚æ•°çš„.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//æäº¤è¯·æ±‚.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>	KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;DispatchCommon</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;                  <span style="color:#6272a4">// ä¸Šé¢çš„ STATUS_SUCCESSæ˜¯ç»™R3çœ‹çš„.ç°åœ¨çš„è¿”å›æ—¶ç»™IOç®¡ç†å™¨ç³»ç»Ÿçš„
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">DispatchRead</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID pReadBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uReadLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION pStack <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uMin <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	ULONG uHelloStr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	uHelloStr <span style="color:#ff79c6">=</span> (wcslen(<span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;Hello World&#34;</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">sizeof</span>(WCHAR);
</span></span><span style="display:flex;"><span>	pReadBuffer <span style="color:#ff79c6">=</span> pIrp<span style="color:#ff79c6">-&gt;</span>AssociatedIrp.SystemBuffer; <span style="color:#6272a4">//ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//è·å–IRPå †æ ˆ.æˆ‘ä»¬è¯´è¿‡3ç¯è°ƒç”¨0ç¯.éœ€è¦å°è£…åœ¨IRPç»“æ„ä¸­.windowsæ˜¯åˆ†å±‚é©±åŠ¨.æ‰€ä»¥IRPå¤´éƒ¨æ˜¯å…±ç”¨çš„.å…¶ä½™çš„æ˜¯æ ˆä¼ é€’.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pStack <span style="color:#ff79c6">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>	uReadLength <span style="color:#ff79c6">=</span> pStack<span style="color:#ff79c6">-&gt;</span>Parameters.Read.Length;
</span></span><span style="display:flex;"><span>	uMin <span style="color:#ff79c6">=</span> uReadLength <span style="color:#ff79c6">&gt;</span> uHelloStr <span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">uHelloStr</span> : uReadLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	RtlCopyMemory(pReadBuffer, <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;Hello World&#34;</span>, uMin); <span style="color:#6272a4">//æ‹·è´åˆ°ç¼“å†²åŒºä¸­ç»™3ç¯.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> uMin;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//æäº¤è¯·æ±‚.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">DispatchWrite</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID pWriteBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uWriteLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION pIrpStack <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	PVOID pBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//è·å–IRPå †æ ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pIrpStack <span style="color:#ff79c6">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//è·å–å†™çš„é•¿åº¦.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	uWriteLength <span style="color:#ff79c6">=</span> pIrpStack<span style="color:#ff79c6">-&gt;</span>Parameters.Write.Length;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pWriteBuffer <span style="color:#ff79c6">=</span> pIrp<span style="color:#ff79c6">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//ç”³è¯·å†…å­˜.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pBuffer <span style="color:#ff79c6">=</span> ExAllocatePoolWithTag(PagedPool, uWriteLength, &#39;DEMO&#39;);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">NULL</span> <span style="color:#ff79c6">==</span> pBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_INSUFFICIENT_RESOURCES;
</span></span><span style="display:flex;"><span>		pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>		IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> STATUS_INSUFFICIENT_RESOURCES;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//æäº¤è¯·æ±‚.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	RtlZeroMemory(pBuffer, uWriteLength);
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//æ‹·è´åˆ°0ç¯ç¼“å†²åŒº
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	RtlCopyMemory(pBuffer, pWriteBuffer, uWriteLength);
</span></span><span style="display:flex;"><span>	KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;Write %s</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>, (PCHAR)pBuffer));
</span></span><span style="display:flex;"><span>	ExFreePool(pBuffer);
</span></span><span style="display:flex;"><span>	pBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> uWriteLength;
</span></span><span style="display:flex;"><span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">DispatchControl</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//å†…æ ¸ä¸­å…±äº« SystemBuffer æœ‰æ—¶é—´å·®.å…ˆè¯»åœ¨å†™.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	PIO_STACK_LOCATION pIrpStack;
</span></span><span style="display:flex;"><span>	PVOID InPutBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	PVOID OutPutBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uInPutLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	ULONG uOutPutBufferLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	ULONG IoCtrl <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	InPutBuffer <span style="color:#ff79c6">=</span> OutPutBuffer <span style="color:#ff79c6">=</span> pIrp<span style="color:#ff79c6">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>	pIrpStack <span style="color:#ff79c6">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	IoCtrl <span style="color:#ff79c6">=</span> pIrpStack<span style="color:#ff79c6">-&gt;</span>Parameters.DeviceIoControl.IoControlCode;  <span style="color:#6272a4">//è·å–æ§åˆ¶ç .
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">switch</span>(IoCtrl)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">CTL_HELLO</span>:
</span></span><span style="display:flex;"><span>			KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;IOCTL HelloWorld</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>));
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">default</span><span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//æäº¤è¯·æ±‚.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXTERN_C NTSTATUS <span style="color:#50fa7b">DriverEntry</span>(PDRIVER_OBJECT pDriverObject, PUNICODE_STRING pRigisterEntry) {
</span></span><span style="display:flex;"><span>	UNICODE_STRING uDevName <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>	UNICODE_STRING uLinkName <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT pDevObj;
</span></span><span style="display:flex;"><span>	RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>uDevName, DRIVER_NAME);
</span></span><span style="display:flex;"><span>	RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>uLinkName, LINK_NAME);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;Init Driver</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>DriverUnload <span style="color:#ff79c6">=</span> DriverUnload;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// åˆ›å»ºè®¾å¤‡
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	status <span style="color:#ff79c6">=</span> IoCreateDevice(pDriverObject, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">&amp;</span>uDevName, FILE_DEVICE_UNKNOWN, <span style="color:#bd93f9">0</span>, FALSE, <span style="color:#ff79c6">&amp;</span>pDevObj);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;[-] Error IoCreateDevice</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> status;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// ä¸æ˜¯è¿™ä¸ª=&gt;è“å±
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pDevObj<span style="color:#ff79c6">-&gt;</span>Flags <span style="color:#ff79c6">|=</span> DO_BUFFERED_IO;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// åˆ›å»ºç¬¦å·é“¾æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	status <span style="color:#ff79c6">=</span> IoCreateSymbolicLink(<span style="color:#ff79c6">&amp;</span>uLinkName, <span style="color:#ff79c6">&amp;</span>uDevName);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;[-] Error IoCreateSymbolicLink</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>		IoDeleteDevice(pDevObj);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> status;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// IO 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> IRP_MJ_MAXIMUM_FUNCTION; i<span style="color:#ff79c6">++</span>) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[i] <span style="color:#ff79c6">=</span> DispatchCommon;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// Read Write IOCTL
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[IRP_MJ_READ] <span style="color:#ff79c6">=</span> DispatchRead;
</span></span><span style="display:flex;"><span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[IRP_MJ_WRITE] <span style="color:#ff79c6">=</span> DispatchWrite;
</span></span><span style="display:flex;"><span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[IRP_MJ_DEVICE_CONTROL] <span style="color:#ff79c6">=</span> DispatchControl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;[+] Create Driver Success</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="r3">R3</h4>
<p>åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰“å¼€ <code>\\DosDevices\\DosDeviceName</code>Â è®¾å¤‡ï¼Œè¯·åœ¨æ‰“å¼€æ–‡ä»¶åæ—¶æŒ‡å®šÂ <code>\\.\</code>ï¼Œéœ€è¦è½¬ä¹‰ç¬¦</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>file <span style="color:#ff79c6">=</span> CreateFileW(<span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\\\</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DosDeviceName&#34;</span>,
</span></span><span style="display:flex;"><span>	GENERIC_READ <span style="color:#ff79c6">|</span> GENERIC_WRITE,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>    OPEN_EXISTING,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span></code></pre></div><p>é€šè¿‡<code>ReadFile</code>å’Œ <code>WriteFile</code> ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè¯»å†™ï¼Œioctlä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>BOOL <span style="color:#50fa7b">DeviceIoControl</span>(
</span></span><span style="display:flex;"><span>  [in]                HANDLE       hDevice,
</span></span><span style="display:flex;"><span>  [in]                DWORD        dwIoControlCode,
</span></span><span style="display:flex;"><span>  [in, optional]      LPVOID       lpInBuffer,
</span></span><span style="display:flex;"><span>  [in]                DWORD        nInBufferSize,
</span></span><span style="display:flex;"><span>  [out, optional]     LPVOID       lpOutBuffer,
</span></span><span style="display:flex;"><span>  [in]                DWORD        nOutBufferSize,
</span></span><span style="display:flex;"><span>  [out, optional]     LPDWORD      lpBytesReturned,
</span></span><span style="display:flex;"><span>  [in, out, optional] LPOVERLAPPED lpOverlapped
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>äº¤äº’</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Windows.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;iostream&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define IOCTRL_BASE 0x800
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MYIOCTRL_CODE(i)	\
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">	CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define CTL_HELLO MYIOCTRL_CODE( 0 )
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	HANDLE hFile <span style="color:#ff79c6">=</span> CreateFileW(TEXT(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\\\</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">Demo&#34;</span>),
</span></span><span style="display:flex;"><span>		GENERIC_WRITE <span style="color:#ff79c6">|</span> GENERIC_READ,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		OPEN_EXISTING,
</span></span><span style="display:flex;"><span>		FILE_ATTRIBUTE_NORMAL,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (hFile <span style="color:#ff79c6">==</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		printf(<span style="color:#f1fa8c">&#34;CreateFile ErrorCode:%d</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, GetLastError());
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	system(<span style="color:#f1fa8c">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	TCHAR szBuff[<span style="color:#bd93f9">0X100</span>];
</span></span><span style="display:flex;"><span>	DWORD dwBytes <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>ReadFile(hFile, szBuff, <span style="color:#ff79c6">sizeof</span>(szBuff) <span style="color:#ff79c6">/</span> <span style="color:#ff79c6">sizeof</span>(szBuff[<span style="color:#bd93f9">0</span>]), <span style="color:#ff79c6">&amp;</span>dwBytes, <span style="color:#8be9fd;font-style:italic">NULL</span>))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		CloseHandle(hFile);
</span></span><span style="display:flex;"><span>		printf(<span style="color:#f1fa8c">&#34;ReadFile ErrorCode:%d</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, GetLastError());
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	printf(<span style="color:#f1fa8c">&#34;bytes:%d data:%ls</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, dwBytes, szBuff);
</span></span><span style="display:flex;"><span>	system(<span style="color:#f1fa8c">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	DeviceIoControl(
</span></span><span style="display:flex;"><span>		hFile,
</span></span><span style="display:flex;"><span>		CTL_HELLO,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>, 
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	CloseHandle(hFile);
</span></span><span style="display:flex;"><span>	system(<span style="color:#f1fa8c">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="more">more</h4>
<p>å…³äº DEBUG é—®é¢˜ï¼Œå¸¸è§ <code>DbgPrint</code>, <code>DbgPrintEx</code>ã€‚<code>KdPrintEx</code>è¿™ç§æ˜¯å®è¡¨ç¤ºã€‚Ex å‡½æ•°ä¸ºäº†æ›´å¥½çš„æ‰“å°å‡ºè°ƒè¯•ä¿¡æ¯ï¼ˆæ¶ˆæ¯è¿‡æ»¤æœºåˆ¶ï¼š<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/reading-and-filtering-debugging-messages">è¯»å–å’Œç­›é€‰è°ƒè¯•æ¶ˆæ¯ - Windows drivers</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#define KdPrintEx(_x_) DbgPrintEx _x_ 
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>NTSYSAPI ULONG <span style="color:#50fa7b">DbgPrintEx</span>(
</span></span><span style="display:flex;"><span>  [in] ULONG ComponentId,      <span style="color:#6272a4">// é¿å…å°†é©±åŠ¨ç¨‹åºçš„è¾“å‡ºä¸ Windows ç»„ä»¶çš„è¾“å‡ºæ··åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  [in] ULONG Level,            <span style="color:#6272a4">// æŒ‡å®šè¦å‘é€çš„æ¶ˆæ¯çš„ä¸¥é‡æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  [in] PCSTR Format,
</span></span><span style="display:flex;"><span>       ...   
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// DPF: Debug Print Filter
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// IHV: Independent Hardware Vendor
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;DPFLTR_ERROR_LEVEL</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>));  <span style="color:#6272a4">// éœ€è¦åŒæ‹¬å·
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;DPFLTR_ERROR_LEVEL</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span></code></pre></div><p>WDF&hellip;</p>
<p>é©±åŠ¨å†™å‡ºBUGç›´æ¥è“å±ğŸ˜¢</p>
<h2 id="library">Library</h2>
<h3 id="rtl">Rtl</h3>
<p>Windowsçš„Runtime Libraryï¼ˆRtlï¼‰å‡½æ•°æ˜¯ä¸€ç»„ä¾›Windowsæ“ä½œç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„å‡½æ•°ã€‚å®ƒä»¬æ˜¯ç”±å¾®è½¯æä¾›çš„ä½çº§åˆ«å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œæ“ä½œç³»ç»Ÿç®¡ç†åŠŸèƒ½ï¼Œå¦‚å†…å­˜ç®¡ç†ã€è¿›ç¨‹å’Œçº¿ç¨‹ç®¡ç†ã€æ–‡ä»¶æ“ä½œã€è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œåº•å±‚äº¤äº’ç­‰ã€‚</p>
<p>è¿™äº›Rtlå‡½æ•°ä¸»è¦ç”¨äºWindowså†…æ ¸å’Œç³»ç»Ÿçº§é©±åŠ¨ç¨‹åºå¼€å‘ï¼Œä¸æ˜¯æ™®é€šåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¸¸ç”¨çš„å‡½æ•°åº“ã€‚å®ƒä»¬æä¾›äº†ä¸€äº›é«˜çº§åˆ«å‡½æ•°å’ŒæŠ½è±¡å±‚ï¼Œä»¥æ–¹ä¾¿å¼€å‘äººå‘˜ä¸åº•å±‚æ“ä½œç³»ç»Ÿäº¤äº’å’Œç®¡ç†ã€‚</p>
<h3 id="nt">nt</h3>
<p>Windows NTæ˜¯ä¸€ä¸ªåŸºäºå†…æ ¸çš„æ“ä½œç³»ç»Ÿç³»åˆ—ï¼Œæœ€åˆç”±å¾®è½¯å…¬å¸åœ¨20ä¸–çºª90å¹´ä»£å¼€å‘å’Œæ¨å‡ºã€‚NTä»£è¡¨&quot;New Technology&quot;ï¼ˆæ–°æŠ€æœ¯ï¼‰ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ç§ç¨³å®šã€å¯é ã€å®‰å…¨çš„æ“ä½œç³»ç»Ÿå¹³å°ã€‚</p>
<p>ä¸€äº›å¸¸è§çš„Windows NTåº“ï¼š</p>
<ol>
<li>Kernel32.libï¼šè¿™æ˜¯Windows NTå†…æ ¸åº“ï¼Œæä¾›äº†è®¸å¤šç³»ç»Ÿçº§åˆ«çš„å‡½æ•°å’Œå·¥å…·ï¼ŒåŒ…æ‹¬å†…å­˜ç®¡ç†ã€è¿›ç¨‹å’Œçº¿ç¨‹ç®¡ç†ã€æ–‡ä»¶å’ŒI/Oæ“ä½œã€æ—¶é—´å’Œæ—¥æœŸå¤„ç†ç­‰ã€‚</li>
<li>User32.libï¼šè¿™æ˜¯ç”¨æˆ·ç•Œé¢åº“ï¼Œæä¾›äº†ä¸ç”¨æˆ·ç•Œé¢ç›¸å…³çš„å‡½æ•°ï¼Œå¦‚çª—å£ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€èœå•æ“ä½œã€å›¾å½¢è®¾å¤‡æ¥å£ç­‰ã€‚</li>
</ol>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/windows">Windows</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Â© ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
