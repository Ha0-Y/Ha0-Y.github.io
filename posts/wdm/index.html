<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>WDM - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
Window Driver Module
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="WDM" />
<meta property="og:description" content="
Window Driver Module
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/wdm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-01-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="WDM"/>
<meta name="twitter:description" content="
Window Driver Module
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">WDM</h1>
			<div class="meta">Posted on Jan 27, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>Window Driver Module</p>
</blockquote>
<h2 id="wdk">WDK</h2>
<p>VS中没有找到单个组件的这些选项，因此使用官方的方法下载，单独下载sdk和wdk</p>
<ul>
<li><a href="https://blog.csdn.net/qq_44240304/article/details/127549383">window10+vs2022配置window驱动开发环境</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/download-the-wdk">下载 Windows 驱动程序工具包 (WDK) - Windows drivers</a></li>
</ul>
<p>然后会有一个 <code>VSIX Installer</code>，下载好之后，我们的VS就可以开发了</p>
<p>新建项目，应该可以看到 <code>Driver</code> 选项</p>
<p>或者使用Windows提供的虚拟机 <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Windows VM</a></p>
<h2 id="驱动开发">驱动开发</h2>
<p>windows驱动分两类，NT式驱动和WDM驱动，后者支持即插即用；</p>
<p>因此选择 <code>WDM(Windows Driver Model)</code>， 提供一个驱动入口 <code>DriverEntry</code> 和 驱动卸载 <code>DriverOnload</code> 函数。需要注意C++ 的名称粉碎机制</p>
<p>右键，属性，Driver Setting</p>
<ul>
<li>target OS 在VS2022 + win11 已经不能成功生成win7版本</li>
<li>target paltform:<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/develop/target-platforms">驱动程序参考页上的“目标平台”</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;ntddk.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>EXTERN_C VOID <span style="color:#50fa7b">DriverUnload</span>(PDRIVER_OBJECT DriverObject) {
</span></span><span style="display:flex;"><span>	DbgPrint(<span style="color:#f1fa8c">&#34;Unload Module Demo</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXTERN_C NTSTATUS <span style="color:#50fa7b">DriverEntry</span>(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RigisterEntry) {
</span></span><span style="display:flex;"><span>	DriverObject<span style="color:#ff79c6">-&gt;</span>DriverUnload <span style="color:#ff79c6">=</span> DriverUnload;
</span></span><span style="display:flex;"><span>	DbgPrint(<span style="color:#f1fa8c">&#34;Load Module Demo</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>官方案例不像 helloworld 的样子。<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-your-first-driver">制作你的第一个驱动程序 </a></p>
<ul>
<li>KMDF是由微软提供的一个高级抽象层，它建立在WDM（Windows Driver Model）之上，并提供了一些额外的功能和简化驱动程序开发的接口。KMDF旨在使驱动程序开发人员能够更轻松地编写和维护可靠的内核模式驱动程序。</li>
</ul>
<h3 id="驱动安装">驱动安装</h3>
<p>OSRDriverLoader: <a href="https://www.osronline.com/article.cfm%5earticle=157.htm">Downloads:Driver Loader (osronline.com)</a></p>
<ul>
<li>w2k: windows 2000</li>
<li>WLH: windows vista</li>
<li>WNET: windows 7 及以上。使用里面的 <code>AMD64 OSRLOADER</code></li>
<li>WXP: windows XP</li>
</ul>
<h3 id="debug">DEbug</h3>
<p><a href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/debugview">DebugView - Sysinternals</a>: 它可以显示 DbgPrint 打印出来的log</p>
<p>WinDbg: 需要设置一下,<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-">回显内核模式调试 Windows 驱动 - Windows drivers</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># 调试器中显示来自目标系统的所有调试消息</span>
</span></span><span style="display:flex;"><span>ed nt!Kd_DEFAULT_MASK 0xFFFFFFFF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 所有调试信息有点多，打印调试字符串</span>
</span></span><span style="display:flex;"><span>ed nt!Kd_Default_Mask <span style="color:#bd93f9">8</span>
</span></span></code></pre></div><h3 id="r0-与-r3-通信">R0 与 R3 通信</h3>
<p>驱动程序的主要功能也就是负责处理IO请求，其中大部分IO请求是在派遣函数中处理的。</p>
<h4 id="r0">R0</h4>
<p>创建设备对象：使用IoCreateDevice必须管理员才能打开 而使用IoCreateDeviceSecure 则可以普通权限打开</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">IoCreateDevice</span>(
</span></span><span style="display:flex;"><span>  [in]           PDRIVER_OBJECT  DriverObject,
</span></span><span style="display:flex;"><span>  [in]           ULONG           DeviceExtensionSize,
</span></span><span style="display:flex;"><span>  [in, optional] PUNICODE_STRING DeviceName,
</span></span><span style="display:flex;"><span>  [in]           DEVICE_TYPE     DeviceType,
</span></span><span style="display:flex;"><span>  [in]           ULONG           DeviceCharacteristics,
</span></span><span style="display:flex;"><span>  [in]           BOOLEAN         Exclusive,
</span></span><span style="display:flex;"><span>  [out]          PDEVICE_OBJECT  <span style="color:#ff79c6">*</span>DeviceObject
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>设备名：符号链接</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">IoCreateSymbolicLink</span>(
</span></span><span style="display:flex;"><span>  [in] PUNICODE_STRING SymbolicLinkName,
</span></span><span style="display:flex;"><span>  [in] PUNICODE_STRING DeviceName
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// MS-DOS 命名规范
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>UNICODE_STRING DeviceName;
</span></span><span style="display:flex;"><span>UNICODE_STRING DosDeviceName;
</span></span><span style="display:flex;"><span>NTSTATUS status;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>DeviceName, <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">Device</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DeviceName&#34;</span>);
</span></span><span style="display:flex;"><span>RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>DosDeviceName, <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DosDevices</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DosDeviceName&#34;</span>);
</span></span><span style="display:flex;"><span>status <span style="color:#ff79c6">=</span> IoCreateSymbolicLink(<span style="color:#ff79c6">&amp;</span>DosDeviceName, <span style="color:#ff79c6">&amp;</span>DeviceName);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status)) {
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">/* Symbolic link creation failed.  Handle error appropriately. */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// NT规范：每个设备接口类都与 GUID 相关联。KMDF 给的代码
</span></span></span></code></pre></div><p>注册回调函数 <code>MajorFunction[IDX](IDX 代表注册读写函数，宏函数，不要超过最大值</code> ；IRP (I/O Request Packet)；<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ns-wdm-_driver_object">DRIVER_OBJECT (wdm.h) - Windows drivers </a>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>_Use_decl_annotations_
</span></span><span style="display:flex;"><span>NTSTATUS
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">DispatchXxx</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_DEVICE_OBJECT</span>  <span style="color:#ff79c6">*</span>DeviceObject,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_IRP</span>  <span style="color:#ff79c6">*</span>Irp
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// Function body
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  }
</span></span></code></pre></div><p>删除符号</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">IoDeleteSymbolicLink</span>(
</span></span><span style="display:flex;"><span>  [in] PUNICODE_STRING SymbolicLinkName
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>删除设备</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">IoDeleteDevice</span>(
</span></span><span style="display:flex;"><span>  [in] PDEVICE_OBJECT DeviceObject
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>IO框架</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;ntddk.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define DRIVER_NAME L&#34;\\Device\\Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define LINK_NAME L&#34;\\DosDevices\\Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">IOCTL 控制码：
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	I/O 控制代码是由多个字段组成的 32 位值。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	#define IOCTL_Device_Function CTL_CODE(DeviceType, Function, Method, Access)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">		DeviceType: 标识设备类型。 此值必须与在驱动程序DEVICE_OBJECT结构的 DeviceType 成员中设置的值匹配
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">		FunctionCode： 标识驱动程序要执行的函数。 小于 0x800 的值是为 Microsoft 保留的。 供应商可以使用 0x800 和更高值
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	#define CTL_CODE(DeviceType, Function, Method, Access) (
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">				(DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">			)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define IOCTRL_BASE 0x800
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MYIOCTRL_CODE(i)	\
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">	CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define CTL_HELLO MYIOCTRL_CODE( 0 )
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>EXTERN_C VOID <span style="color:#50fa7b">DriverUnload</span>(PDRIVER_OBJECT pDriverObject) {
</span></span><span style="display:flex;"><span>	DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;Unload Driver</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 返回值并不代表成功，而是 pIrp-&gt;IoStatus.Status 代表IO是否成功
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>NTSTATUS <span style="color:#50fa7b">DispatchCommon</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS; <span style="color:#6272a4">// IRP记录这次操作是否成功
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;         <span style="color:#6272a4">// Information用来记录实际传输的字节数的.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//提交请求.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>	KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;DispatchCommon</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;                  <span style="color:#6272a4">// 上面的 STATUS_SUCCESS是给R3看的.现在的返回时给IO管理器系统的
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">DispatchRead</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID pReadBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uReadLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION pStack <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uMin <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	ULONG uHelloStr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	uHelloStr <span style="color:#ff79c6">=</span> (wcslen(<span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;Hello World&#34;</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">sizeof</span>(WCHAR);
</span></span><span style="display:flex;"><span>	pReadBuffer <span style="color:#ff79c6">=</span> pIrp<span style="color:#ff79c6">-&gt;</span>AssociatedIrp.SystemBuffer; <span style="color:#6272a4">//缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//获取IRP堆栈.我们说过3环调用0环.需要封装在IRP结构中.windows是分层驱动.所以IRP头部是共用的.其余的是栈传递.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pStack <span style="color:#ff79c6">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>	uReadLength <span style="color:#ff79c6">=</span> pStack<span style="color:#ff79c6">-&gt;</span>Parameters.Read.Length;
</span></span><span style="display:flex;"><span>	uMin <span style="color:#ff79c6">=</span> uReadLength <span style="color:#ff79c6">&gt;</span> uHelloStr <span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">uHelloStr</span> : uReadLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	RtlCopyMemory(pReadBuffer, <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;Hello World&#34;</span>, uMin); <span style="color:#6272a4">//拷贝到缓冲区中给3环.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> uMin;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//提交请求.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">DispatchWrite</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID pWriteBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uWriteLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION pIrpStack <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	PVOID pBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//获取IRP堆栈
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pIrpStack <span style="color:#ff79c6">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//获取写的长度.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	uWriteLength <span style="color:#ff79c6">=</span> pIrpStack<span style="color:#ff79c6">-&gt;</span>Parameters.Write.Length;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pWriteBuffer <span style="color:#ff79c6">=</span> pIrp<span style="color:#ff79c6">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//申请内存.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pBuffer <span style="color:#ff79c6">=</span> ExAllocatePoolWithTag(PagedPool, uWriteLength, &#39;DEMO&#39;);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">NULL</span> <span style="color:#ff79c6">==</span> pBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_INSUFFICIENT_RESOURCES;
</span></span><span style="display:flex;"><span>		pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>		IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> STATUS_INSUFFICIENT_RESOURCES;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//提交请求.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	RtlZeroMemory(pBuffer, uWriteLength);
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//拷贝到0环缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	RtlCopyMemory(pBuffer, pWriteBuffer, uWriteLength);
</span></span><span style="display:flex;"><span>	KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;Write %s</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>, (PCHAR)pBuffer));
</span></span><span style="display:flex;"><span>	ExFreePool(pBuffer);
</span></span><span style="display:flex;"><span>	pBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> uWriteLength;
</span></span><span style="display:flex;"><span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#50fa7b">DispatchControl</span>(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//内核中共享 SystemBuffer 有时间差.先读在写.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	PIO_STACK_LOCATION pIrpStack;
</span></span><span style="display:flex;"><span>	PVOID InPutBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	PVOID OutPutBuffer <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG uInPutLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	ULONG uOutPutBufferLength <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	ULONG IoCtrl <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	InPutBuffer <span style="color:#ff79c6">=</span> OutPutBuffer <span style="color:#ff79c6">=</span> pIrp<span style="color:#ff79c6">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>	pIrpStack <span style="color:#ff79c6">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	IoCtrl <span style="color:#ff79c6">=</span> pIrpStack<span style="color:#ff79c6">-&gt;</span>Parameters.DeviceIoControl.IoControlCode;  <span style="color:#6272a4">//获取控制码.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">switch</span>(IoCtrl)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">CTL_HELLO</span>:
</span></span><span style="display:flex;"><span>			KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;IOCTL HelloWorld</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>));
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">default</span><span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Status <span style="color:#ff79c6">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ff79c6">-&gt;</span>IoStatus.Information <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//提交请求.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXTERN_C NTSTATUS <span style="color:#50fa7b">DriverEntry</span>(PDRIVER_OBJECT pDriverObject, PUNICODE_STRING pRigisterEntry) {
</span></span><span style="display:flex;"><span>	UNICODE_STRING uDevName <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>	UNICODE_STRING uLinkName <span style="color:#ff79c6">=</span> { <span style="color:#bd93f9">0</span> };
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT pDevObj;
</span></span><span style="display:flex;"><span>	RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>uDevName, DRIVER_NAME);
</span></span><span style="display:flex;"><span>	RtlInitUnicodeString(<span style="color:#ff79c6">&amp;</span>uLinkName, LINK_NAME);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;Init Driver</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>DriverUnload <span style="color:#ff79c6">=</span> DriverUnload;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// 创建设备
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	status <span style="color:#ff79c6">=</span> IoCreateDevice(pDriverObject, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">&amp;</span>uDevName, FILE_DEVICE_UNKNOWN, <span style="color:#bd93f9">0</span>, FALSE, <span style="color:#ff79c6">&amp;</span>pDevObj);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;[-] Error IoCreateDevice</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> status;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// 不是这个=&gt;蓝屏
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pDevObj<span style="color:#ff79c6">-&gt;</span>Flags <span style="color:#ff79c6">|=</span> DO_BUFFERED_IO;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// 创建符号链接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	status <span style="color:#ff79c6">=</span> IoCreateSymbolicLink(<span style="color:#ff79c6">&amp;</span>uLinkName, <span style="color:#ff79c6">&amp;</span>uDevName);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;[-] Error IoCreateSymbolicLink</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>		IoDeleteDevice(pDevObj);
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> status;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// IO 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> IRP_MJ_MAXIMUM_FUNCTION; i<span style="color:#ff79c6">++</span>) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[i] <span style="color:#ff79c6">=</span> DispatchCommon;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// Read Write IOCTL
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[IRP_MJ_READ] <span style="color:#ff79c6">=</span> DispatchRead;
</span></span><span style="display:flex;"><span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[IRP_MJ_WRITE] <span style="color:#ff79c6">=</span> DispatchWrite;
</span></span><span style="display:flex;"><span>	pDriverObject<span style="color:#ff79c6">-&gt;</span>MajorFunction[IRP_MJ_DEVICE_CONTROL] <span style="color:#ff79c6">=</span> DispatchControl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, <span style="color:#f1fa8c">&#34;[+] Create Driver Success</span><span style="color:#f1fa8c">\r\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="r3">R3</h4>
<p>在用户模式下打开 <code>\\DosDevices\\DosDeviceName</code> 设备，请在打开文件名时指定 <code>\\.\</code>，需要转义符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>file <span style="color:#ff79c6">=</span> CreateFileW(<span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\\\</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">DosDeviceName&#34;</span>,
</span></span><span style="display:flex;"><span>	GENERIC_READ <span style="color:#ff79c6">|</span> GENERIC_WRITE,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>    OPEN_EXISTING,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span></code></pre></div><p>通过<code>ReadFile</code>和 <code>WriteFile</code> 系统调用进行读写，ioctl使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>BOOL <span style="color:#50fa7b">DeviceIoControl</span>(
</span></span><span style="display:flex;"><span>  [in]                HANDLE       hDevice,
</span></span><span style="display:flex;"><span>  [in]                DWORD        dwIoControlCode,
</span></span><span style="display:flex;"><span>  [in, optional]      LPVOID       lpInBuffer,
</span></span><span style="display:flex;"><span>  [in]                DWORD        nInBufferSize,
</span></span><span style="display:flex;"><span>  [out, optional]     LPVOID       lpOutBuffer,
</span></span><span style="display:flex;"><span>  [in]                DWORD        nOutBufferSize,
</span></span><span style="display:flex;"><span>  [out, optional]     LPDWORD      lpBytesReturned,
</span></span><span style="display:flex;"><span>  [in, out, optional] LPOVERLAPPED lpOverlapped
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>交互</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Windows.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;iostream&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define IOCTRL_BASE 0x800
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MYIOCTRL_CODE(i)	\
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">	CTL_CODE(FILE_DEVICE_UNKNOWN, IOCTRL_BASE + i, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define CTL_HELLO MYIOCTRL_CODE( 0 )
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	HANDLE hFile <span style="color:#ff79c6">=</span> CreateFileW(TEXT(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\\\\</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">Demo&#34;</span>),
</span></span><span style="display:flex;"><span>		GENERIC_WRITE <span style="color:#ff79c6">|</span> GENERIC_READ,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		OPEN_EXISTING,
</span></span><span style="display:flex;"><span>		FILE_ATTRIBUTE_NORMAL,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (hFile <span style="color:#ff79c6">==</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		printf(<span style="color:#f1fa8c">&#34;CreateFile ErrorCode:%d</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, GetLastError());
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	system(<span style="color:#f1fa8c">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	TCHAR szBuff[<span style="color:#bd93f9">0X100</span>];
</span></span><span style="display:flex;"><span>	DWORD dwBytes <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>ReadFile(hFile, szBuff, <span style="color:#ff79c6">sizeof</span>(szBuff) <span style="color:#ff79c6">/</span> <span style="color:#ff79c6">sizeof</span>(szBuff[<span style="color:#bd93f9">0</span>]), <span style="color:#ff79c6">&amp;</span>dwBytes, <span style="color:#8be9fd;font-style:italic">NULL</span>))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		CloseHandle(hFile);
</span></span><span style="display:flex;"><span>		printf(<span style="color:#f1fa8c">&#34;ReadFile ErrorCode:%d</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, GetLastError());
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	printf(<span style="color:#f1fa8c">&#34;bytes:%d data:%ls</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, dwBytes, szBuff);
</span></span><span style="display:flex;"><span>	system(<span style="color:#f1fa8c">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	DeviceIoControl(
</span></span><span style="display:flex;"><span>		hFile,
</span></span><span style="display:flex;"><span>		CTL_HELLO,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>, 
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">NULL</span>
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	CloseHandle(hFile);
</span></span><span style="display:flex;"><span>	system(<span style="color:#f1fa8c">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="more">more</h4>
<p>关于 DEBUG 问题，常见 <code>DbgPrint</code>, <code>DbgPrintEx</code>。<code>KdPrintEx</code>这种是宏表示。Ex 函数为了更好的打印出调试信息（消息过滤机制：<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/reading-and-filtering-debugging-messages">读取和筛选调试消息 - Windows drivers</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#define KdPrintEx(_x_) DbgPrintEx _x_ 
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>NTSYSAPI ULONG <span style="color:#50fa7b">DbgPrintEx</span>(
</span></span><span style="display:flex;"><span>  [in] ULONG ComponentId,      <span style="color:#6272a4">// 避免将驱动程序的输出与 Windows 组件的输出混合
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  [in] ULONG Level,            <span style="color:#6272a4">// 指定要发送的消息的严重性
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  [in] PCSTR Format,
</span></span><span style="display:flex;"><span>       ...   
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// DPF: Debug Print Filter
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// IHV: Independent Hardware Vendor
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;DPFLTR_ERROR_LEVEL</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>));  <span style="color:#6272a4">// 需要双括号
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, <span style="color:#f1fa8c">&#34;DPFLTR_ERROR_LEVEL</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span></code></pre></div><p>WDF&hellip;</p>
<p>驱动写出BUG直接蓝屏😢</p>
<h2 id="library">Library</h2>
<h3 id="rtl">Rtl</h3>
<p>Windows的Runtime Library（Rtl）函数是一组供Windows操作系统内部使用的函数。它们是由微软提供的低级别函数，用于执行操作系统管理功能，如内存管理、进程和线程管理、文件操作、设备驱动程序和底层交互等。</p>
<p>这些Rtl函数主要用于Windows内核和系统级驱动程序开发，不是普通应用程序开发人员常用的函数库。它们提供了一些高级别函数和抽象层，以方便开发人员与底层操作系统交互和管理。</p>
<h3 id="nt">nt</h3>
<p>Windows NT是一个基于内核的操作系统系列，最初由微软公司在20世纪90年代开发和推出。NT代表&quot;New Technology&quot;（新技术），它的设计目标是提供一种稳定、可靠、安全的操作系统平台。</p>
<p>一些常见的Windows NT库：</p>
<ol>
<li>Kernel32.lib：这是Windows NT内核库，提供了许多系统级别的函数和工具，包括内存管理、进程和线程管理、文件和I/O操作、时间和日期处理等。</li>
<li>User32.lib：这是用户界面库，提供了与用户界面相关的函数，如窗口管理、消息处理、菜单操作、图形设备接口等。</li>
</ol>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/windows">Windows</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
