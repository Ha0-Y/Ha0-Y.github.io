<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>hypervisor-in-rust-0 - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
hypervisors and high-performance fuzzing.
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="hypervisor-in-rust-0" />
<meta property="og:description" content="
hypervisors and high-performance fuzzing.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/hypervisor-in-rust-0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="hypervisor-in-rust-0"/>
<meta name="twitter:description" content="
hypervisors and high-performance fuzzing.
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">hypervisor-in-rust-0</h1>
			<div class="meta">Posted on Jul 28, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>hypervisors and high-performance fuzzing.</p>
</blockquote>
<p>æœ€è¿‘å­¦ä¹ æ¨¡ç³Šæµ‹è¯•ï¼Œä¸€äº›fuzzerå€ŸåŠ©ç¡¬ä»¶è¾…åŠ©æ¥æé«˜æ•ˆç‡ï¼Œåœ¨æ‰¾èµ„æ–™æ—¶æ‰¾åˆ°äº†ä¸é”™çš„æ•™ç¨‹ï¼Œå› æ­¤å­¦ä¹ ~~ï¼ˆCV~~ä¸€ä¸‹ : <a href="https://tandasat.github.io/Hypervisor-101-in-Rust/">Hypervisor 101 in Rust</a></p>
<h2 id="ä»‹ç»">ä»‹ç»</h2>
<p><a href="https://gcc.ac/gcc_2023/">Global Cybersecurity Camp 2023 Singapore</a>.</p>
<p>ç¡¬ä»¶è¾…åŠ©çš„é«˜æ€§èƒ½fuzzerå¼€å‘ï¼ŒFuzzing UEFI + é…å¥—ç»ƒä¹ </p>
<h3 id="è¯¾ç¨‹å‰æ">è¯¾ç¨‹å‰æ</h3>
<ol>
<li>ç†Ÿæ‚‰x86_64æ¶æ„</li>
</ol>
<ul>
<li>å¦‚æœä¸ç†Ÿæ‚‰ï¼Œæ¨èäº†è¯¾ç¨‹ï¼š<a href="https://p.ost2.fyi/courses/course-v1:OpenSecurityTraining2+Arch2001_x86-64_OS_Internals+2021_v1/course/">Course | Arch2001 | OpenSecurityTraining2 (ost2.fyi)</a></li>
</ul>
<ol start="2">
<li>Rustç»å†æœ‰ç”¨ï¼Œä½†æ˜¯ä¸æ˜¯å¿…è¦çš„</li>
<li>ä¸‹è½½ç›¸å…³æ–‡æ¡£</li>
</ol>
<ul>
<li><a href="https://www.intel.com/sdm/">Intel 64 and IA-32 Architectures Software Developerâ€™s Manual Volume 3</a></li>
<li><a href="https://developer.amd.com/resources/developer-guides-manuals/">AMD64 Architecture Programmerâ€™s Manual Volume 2: System Programming</a></li>
</ul>
<ol start="4">
<li>éœ€è¦ä¸€å°èƒ½æ”¯æŒIntel-VT/AMD-Vçš„ç”µè„‘</li>
</ol>
<h3 id="è¯¾ç¨‹ç›®æ ‡">è¯¾ç¨‹ç›®æ ‡</h3>
<ul>
<li>ç†è§£x86_64ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æŠ€æœ¯</li>
<li>ç†Ÿæ‚‰å¦‚ä½•å°†è™šæ‹ŸåŒ–æŠ€æœ¯åº”ç”¨åˆ°é«˜æ€§èƒ½fuzzingä¸­</li>
</ul>
<h3 id="åŠ¨æœº">åŠ¨æœº</h3>
<p>Hypervisor</p>
<ul>
<li>cool: äº‘æœåŠ¡çš„åŸºç¡€ï¼ŒKVM, hyper-V, Xen, Nitro Hypervisor</li>
<li>æœ‰è¶£çš„:
<ul>
<li>ä¸»è¦çš„å®‰å…¨ç‰¹æ€§åŸºç¡€, Virtualization Based Security, Secured-core PC</li>
<li>å®‰å…¨ç ”ç©¶, Â <a href="https://github.com/matsu/bitvisor/tree/master/core">BitVisor</a>, Intel&rsquo;sÂ <a href="https://github.com/intel/vbh">Virtualization Based Hardening</a></li>
</ul>
</li>
<li>æ–¹ä¾¿:
<ul>
<li>ç³»ç»Ÿçº§éš”ç¦»: VMware Workstation/Fusion,Â <a href="https://github.com/projectacrn/acrn-hypervisor">ACRN</a>, Nitro Hypervisor,Â <a href="https://www.qubes-os.org/">Qubes OS</a></li>
<li>ç³»ç»Ÿçº§ç›‘è§†: Â <a href="https://github.com/AsahiLinux/m1n1">Asahi Linux m1n1 Hypervisor</a>,Â <a href="https://cuckoosandbox.org/">Cuckoo Sandbox</a>,Â <a href="https://github.com/hvmi">HVMI</a>,Â <a href="https://nyx-fuzz.com/">kAFL/Nyx</a>,Â <a href="https://github.com/cheat-engine/cheat-engine/">Cheat Engine DBVM</a>,Â <a href="https://en.wikipedia.org/wiki/Blue_Pill_(software)">Blue Pill</a>, antivirus-hypervisors</li>
</ul>
</li>
</ul>
<h3 id="å¦‚ä½•å®Œæˆ">å¦‚ä½•å®Œæˆ</h3>
<p>æˆ‘æ— æ³•åˆ›é€ çš„ï¼Œæˆ‘å°±ä¸ç†è§£ã€‚&ndash; è´¹æ›¼</p>
<p>ç†Ÿæ‚‰ç›¸å…³çš„ç‰¹æ€§ï¼Œå¼•ç”¨å¼€æºçš„å®ç°</p>
<ul>
<li>çœ‹æ–‡æ¡£ + çœ‹ä»£ç ï¼ŒçŸ¥é“å¦‚ä½•å®ç°æˆ–è€…CV</li>
</ul>
<h3 id="å¯ä»¥å­¦ä¹ åˆ°ä»€ä¹ˆ">å¯ä»¥å­¦ä¹ åˆ°ä»€ä¹ˆ</h3>
<ul>
<li>ä¸€ä¸ªå¯ä»¥è¿è¡Œå¹¶ä¸”fuzzç›®æ ‡çš„hypervisor</li>
<li>è·¨å¹³å°çš„hypervisorå¼€å‘å’Œdebug</li>
<li>ä¸ºè‡ªå·±çš„æµ‹è¯•æ‰©å±•åŠŸèƒ½</li>
<li>æ›´å¥½çš„ç†è§£/é˜…è¯»ç°å­˜çš„hypervisorç›¸å…³å®ç°çš„ä»£ç </li>
<li>å¼€å‘è‡ªå·±çš„hypervisor</li>
</ul>
<h3 id="fuzzerè®¾è®¡">fuzzerè®¾è®¡</h3>
<p>ç°ç›’æµ‹è¯•ï¼ŒåŸºäºå˜å¼‚ï¼Œè¾¹è¦†ç›–ç‡å¼•å¯¼
å¿«ç…§åŠŸèƒ½
è¾“å…¥ï¼šå¿«ç…§æ–‡ä»¶ï¼Œæ ·æœ¬åº“ï¼Œpatch æ–‡ä»¶</p>
<h3 id="hypervisorè®¾è®¡">hypervisorè®¾è®¡</h3>
<p>ä»å¿«ç…§åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœº
å¼€å§‹fuzzing</p>
<ul>
<li>å‘å†…å­˜æ³¨å…¥å˜å¼‚çš„è¾“å…¥</li>
<li>VMè¿è¡Œ</li>
<li>è§‚å¯Ÿ/æ”¶é›†å¯èƒ½çš„BUG
ä¸€æ¬¡è¿­ä»£åæ¢å¤å¿«ç…§
è¿è¡Œå°½å¯èƒ½å¤šçš„VM
ä½¿ç”¨Rustä¹¦å†™çš„UEFI
åœ¨Bochs/VMwareæµ‹è¯•ï¼Œé€‰æ‹©è£¸æœºå‹å·ï¼ˆåº”è¯¥æ—¶é€‰æ‹©Intel or AMD?ï¼‰</li>
</ul>
<h3 id="ä¸æ˜¯å¦‚ä¸‹çš„è¯¾ç¨‹ç±»å‹">ä¸æ˜¯å¦‚ä¸‹çš„è¯¾ç¨‹ç±»å‹</h3>
<ul>
<li>Rustç¼–ç¨‹è¯¾</li>
<li>æ¨¡ç³Šæµ‹è¯•è¯¾ç¨‹
<ul>
<li>å¯ä»¥åœ¨è¿™é‡Œå¯»æ±‚ç›¸å…³å»ºè®®: <a href="https://discord.com/invite/QxxTBCw">Awesome Fuzzing</a></li>
</ul>
</li>
<li>å­¦ä¹ å·²ç»å­˜åœ¨çš„è½¯ä»¶ç›¸å…³åŸç†</li>
<li>æ¯”è¾ƒè¯¦ç»†æä¾›ä»£ç çš„ç»†èŠ‚ï¼Œä¸€äº›æ³¨é‡Šå¯èƒ½è¿‡äºç®€å•å¹¶ä¸”å¯èƒ½æ˜¯ä¸æ­£ç¡®çš„</li>
</ul>
<h3 id="demo">Demo</h3>
<p>åº”è¯¥æ˜¯ä½œè€…ç°åœºæ¼”ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥cloneä¸‹æ¥ä»£ç ä»“åº“è¿è¡Œ</p>
<h3 id="ä¸ºä»€ä¹ˆæ˜¯hypervisor">ä¸ºä»€ä¹ˆæ˜¯Hypervisor</h3>
<p>ä¼˜ç‚¹</p>
<ul>
<li>ä¸å±€é™äºç”¨æˆ·æ€çš„fuzzing</li>
<li>æ¯”æ¨¡æ‹Ÿå™¨å—</li>
</ul>
<p>æ¯”è¾ƒä¼˜ç§€çš„æ¡ˆä¾‹</p>
<ul>
<li>Customized hypervisors:Â <a href="https://github.com/intel/kernel-fuzzer-for-xen-project">KF/x</a>Â (Xen),Â <a href="https://nyx-fuzz.com/">kAFL/Nyx</a>Â (KVM),Â <a href="https://www.microsoft.com/en-us/research/publication/hyperfuzzer-an-efficient-hybrid-fuzzer-for-virtual-cpus/">HyperFuzzer</a>Â (Hyper-V)</li>
<li>Using hypervisor API:Â <a href="https://github.com/0vercl0k/wtf">What The Fuzz</a>,Â <a href="https://github.com/quarkslab/rewind">Rewind</a>,Â <a href="https://github.com/Impalabs/hyperpom">Hyperpom</a>,Â <a href="https://aws.amazon.com/blogs/opensource/announcing-snapchange-an-open-source-kvm-backed-snapshot-fuzzing-framework/">Snapchange</a></li>
<li>Original hypervisors:Â <a href="https://github.com/gamozolabs/falkervisor_grilled_cheese">FalkVisor</a>,Â <a href="https://github.com/Cisco-Talos/Barbervisor">Barbervisor</a></li>
</ul>
<h3 id="uefi-åº”ç”¨">UEFI åº”ç”¨</h3>
<p>å…ˆäºæ“ä½œç³»ç»Ÿå¯åŠ¨ï¼Œæ›´å¿«çš„BIOS</p>
<p><a href="https://uefi.org/">Unified Extensible Firmware Interface Forum</a></p>
<p>UEFIå¥½å¤„</p>
<ul>
<li>å‡å°‘ç³»ç»Ÿèµ„æºçš„æµªè´¹</li>
<li>ä¸æ“ä½œç³»ç»Ÿæ— å…³çš„è®¾è®¡å’Œå¼€å‘ç¯å¢ƒ</li>
<li>å…¼å®¹æ€§å¥½</li>
<li>æ¯”è¾ƒå®¹æ˜“è®¿é—®ç¡¬ä»¶ç‰¹æ€§</li>
<li>æ–‡æ¡£æ¯”è¾ƒé½å…¨</li>
</ul>
<h3 id="rust">Rust</h3>
<p>ä¸ºä»€ä¹ˆé€‰æ‹©äº†rust</p>
<ul>
<li>ç›¸å¯¹ä¸C/C++æ¥è¯´ï¼Œæ›´æ–¹ä¾¿çš„UEFI</li>
<li>æ›´å¤šçš„libå’Œcrate</li>
<li>ç¼–è¯‘å™¨æ¯”è¾ƒä¸¥æ ¼ï¼Œå‡å°‘BUG</li>
<li>å…·æœ‰å®‰å…¨æ„è¯†çš„å·¥ç¨‹å¸ˆï¼Œç°å¦‚ä»Šåº”è¯¥é€‰æ‹©Rust</li>
</ul>
<p>hypervisor&hellip;</p>
<h2 id="hypervisor">Hypervisor</h2>
<p>VMM: Virtual Machine Monitorï¼Œå’Œ hypervisor ç­‰ä»·ã€‚</p>
<p>ä¸¤ç±»è™šæ‹ŸåŒ–æŠ€æœ¯ï¼š</p>
<ul>
<li>ç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šï¼šVMware ESXi, Windows Hyper-V&hellip;</li>
<li>è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¸Šï¼šVMware Workstationï¼ŒVirtualBoxï¼ŒQEMU&hellip;</li>
</ul>
<p>è™šæ‹ŸåŒ–ä¸»è¦åˆ†ä¸ºå‡ å¤§ç±»ï¼š</p>
<ul>
<li><strong>è®¡ç®—è™šæ‹ŸåŒ–</strong>ï¼Œé’ˆå¯¹CPUå’Œå†…å­˜èµ„æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚</li>
<li><strong>ç½‘ç»œè™šæ‹ŸåŒ–</strong>ï¼Œé’ˆå¯¹ç½‘ç»œé“¾è·¯èµ„æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚</li>
<li><strong>IOè™šæ‹ŸåŒ–</strong>ï¼Œé’ˆå¯¹IOèµ„æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚</li>
<li><strong>å­˜å‚¨è™šæ‹ŸåŒ–</strong>ï¼Œé’ˆå¯¹ç£ç›˜å­˜å‚¨èµ„æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚</li>
</ul>
<h2 id="intel-vt">Intel-VT</h2>
<p>è™½ç„¶è¯´æœ¬æœºç”µè„‘æ—¶AMD CPUï¼Œä½†æ˜¯ç½‘ä¸ŠIntel-VTå†…å®¹æ¯”è¾ƒå¤šï¼Œæœ‰é—®é¢˜ä¹Ÿå¥½è§£å†³ï¼Œå› æ­¤é¦–å…ˆå­¦ä¹ äº†éƒ¨åˆ†çŸ¥è¯†ã€‚<del>å¹¶ä¸”çŸ¥è¯†éƒ½æ˜¯ç›¸é€šçš„</del></p>
<p>å› æ­¤ä»‹ç»ä¸ä¼šå¾ˆç»†ğŸ˜‹ï¼Œæ¯•ç«Ÿæœ‰äº†æºç ä¹Ÿä¸èƒ½ç”¨ğŸ˜­</p>
<p>ä¸é”™çš„å­¦ä¹ èµ„æºï¼Œå› ä¸ºæ˜¯AMDçš„CPUï¼Œä¸»è¦è¿˜æ˜¯äº†è§£æ¦‚å¿µä»¥åŠæ€è·¯</p>
<ul>
<li><a href="https://space.bilibili.com/3493135044840333/channel/collectiondetail?sid=1118442">rust-hypervisor-x86</a></li>
<li><a href="https://blog.csdn.net/qq_41988448/category_11624333.html">Intel-VT</a></li>
<li><a href="https://bbs.kanxue.com/thread-281142.htm">Hypervisor From Scratch ç¿»è¯‘</a></li>
</ul>
<p>åœ¨<a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">IntelÂ® 64 and IA-32 Architectures Software Developer Manuals</a>æœç´¢<code>Intel 64 and IA-32 Architectures Software Developerâ€™s Manual Volume 3</code></p>
<p>éƒ¨åˆ†ä¸€äº›ä¸“ä¸šæœ¯è¯­</p>
<ul>
<li>Intel VT-X: Virtualization Technology for x86</li>
<li>guest-mode: VMX non-root operation</li>
<li>host-mode: VMX root operation</li>
<li>VMX: Virtual-Machine eXtensions</li>
<li>VMCS: virtual-machine control data structures</li>
<li>EPT: Extend Page Table</li>
<li>VT-D: Virtualization Technology for Directed I/O</li>
<li>GPA: Guest Physical Address</li>
<li>HPA: Host Physical Address</li>
</ul>
<h3 id="vmx">VMX</h3>
<p><strong>VMM host-guest</strong></p>
<ul>
<li>VMMé€šè¿‡æ‰§è¡Œ<code>VMXON</code>æŒ‡ä»¤è¿›å…¥VMXæ“ä½œï¼Œç„¶åå°±æ˜¯ç±»ä¼¼ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹ã€‚</li>
<li><code>VM Entry</code>ï¼šVMM å¯ä»¥è¿›å…¥ guestã€‚ VMMä½¿ç”¨æŒ‡ä»¤<code>VMLAUNCH</code>å’Œ<code>VMRESUME</code>è¿›è¡ŒVMåˆ‡æ¢ï¼ˆå¯ä»¥æœ‰å¾ˆå¤šguestï¼‰ï¼›ä½¿ç”¨ <code>VM Exit</code> è¿”å›hostã€‚</li>
<li><code>VM Exit</code>: å°†æ§åˆ¶è½¬ç§»åˆ°VMMæŒ‡å®šçš„å…¥å£ç‚¹ã€‚ VMMå¯ä»¥é’ˆå¯¹<code>VM Exit</code>çš„åŸå› é‡‡å–é€‚å½“çš„æ“ä½œ</li>
<li>æœ€ç»ˆï¼ŒVMM å¯èƒ½å†³å®šè‡ªè¡Œå…³é—­å¹¶ç¦»å¼€ VMX æ“ä½œã€‚ å®ƒé€šè¿‡æ‰§è¡Œ VMXOFF æŒ‡ä»¤æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</li>
</ul>
<p><strong>VMCS ç»„æˆ:</strong>ï¼ˆVMCS åŒºåŸŸæ˜¯4 KBï¼ˆä½ 11:0 å¿…é¡»ä¸ºé›¶ï¼‰ï¼Œå¿…é¡»ä¸ 4KB è¾¹ç•Œå¯¹é½ï¼‰</p>
<ul>
<li>guest state areaï¼šåœ¨ VM-entryæ—¶ï¼Œå¤„ç†å™¨çš„çŠ¶æ€ä¿¡æ¯ä»guest-stateåŒºåŸŸä¸­åŠ è½½ã€‚åœ¨VM-exitæ—¶ï¼Œå¤„ç†å™¨çš„å½“å‰çŠ¶æ€ä¿¡æ¯ä¿å­˜åœ¨guest-stateåŒºåŸŸã€‚</li>
<li>host state areaï¼šåœ¨VM-exitæ—¶ï¼Œå¤„ç†å™¨çš„çŠ¶æ€ä¿¡æ¯ä»host-stateåŒºåŸŸä¸­åŠ è½½ã€‚</li>
<li>VM-execution control fieldï¼šåœ¨è¿›å…¥VMåï¼Œå¤„ç†å™¨çš„è¡Œä¸ºç”±VM-executionæ§åˆ¶åŒºåŸŸä¸­çš„å­—æ®µæä¾›æ§åˆ¶ã€‚</li>
<li>VM-EXIT control fieldï¼šæ§åˆ¶å¤„ç†å™¨åœ¨å¤„ç†VM-exitæ—¶çš„è¡Œä¸ºï¼Œä¹Ÿå½±å“è¿”å›VMMåå¤„ç†å™¨çš„æŸäº›çŠ¶æ€ã€‚</li>
<li>VM-ENTRY control fieldï¼šæ§åˆ¶å¤„ç†å™¨åœ¨å¤„ç†VM-entryæ—¶çš„è¡Œä¸ºï¼Œä¹Ÿå†³å®šè¿›å…¥VMåå¤„ç†å™¨çš„æŸäº›çŠ¶æ€ã€‚</li>
<li>VM-EXIT infomation fieldï¼šè®°å½•å¼•èµ·VM-exitäº‹ä»¶çš„åŸå› åŠç›¸å…³çš„æ˜ç»†ä¿¡æ¯ã€‚</li>
</ul>
<p><strong>ä¸€ä¸ªå¤§è‡´çš„æ¡†æ¶ï¼š</strong></p>
<ol>
<li>æ£€æŸ¥ç¡¬ä»¶æ˜¯å¦æ”¯æŒVMX: <code>CPUID.1:ECX.VMX[bit 5] = 1</code></li>
<li>å¯ç”¨VMX: ä»¤<code>CR4.VMXE[bit 13] = 1</code>ï¼Œç„¶åé€šè¿‡æ‰§è¡ŒVMXONæŒ‡ä»¤è¿›å…¥VMXæ“ä½œã€‚</li>
<li>æ£€æŸ¥å†…æ ¸ä¸­çš„VMXæ”¯æŒæƒ…å†µ: Â <strong>IA32_FEATURE_CONTROL</strong>Â MSRï¼ˆMSR åœ°å€ 3AHï¼‰ä»¥æŸ¥çœ‹Â <strong>é”å®šä½</strong>Â æ˜¯å¦å·²è®¾ç½®</li>
<li>åˆ†é…VMXONåŒºåŸŸ: ç‰©ç†åœ°å€å¹¶ä½¿ç”¨åˆ†é…åŒºåŸŸçš„æŒ‡é’ˆæ‰§è¡ŒVMXONæŒ‡ä»¤ï¼Œå¹¶ä¸”æŸ¥è¯¢ <code>MSR_IA32_VMX_BASIC</code>ã€‚ï¼ˆIntel æ‰‹å†Œï¼šåœ¨æ‰§è¡Œ VMXON ä¹‹å‰ï¼Œè½¯ä»¶åº”å°† VMCS ä¿®è®¢æ ‡è¯†ç¬¦å†™å…¥ VMXON åŒºåŸŸã€‚ å…·ä½“æ¥è¯´ï¼Œå®ƒåº”è¯¥å°† 31 ä½ VMCS ä¿®è®¢æ ‡è¯†ç¬¦å†™å…¥ VMXON åŒºåŸŸå‰ 4 ä¸ªå­—èŠ‚çš„ä½ 30:0ï¼›ä½ 31 åº”æ¸…é™¤ä¸º 0ã€‚ï¼‰</li>
<li>åˆ†é…VMCSåŒºåŸŸ: VMPTRLDï¼Œå¤„ç†å™¨ä¸­å¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ª VMCSï¼Œä½†å½“å‰åªæœ‰å…¶ä¸­ä¸€ä¸ªå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶ä¸” VMLAUNCHã€VMREADã€VMRESUME å’Œ VMWRITE æŒ‡ä»¤ä»…åœ¨å½“å‰ VMCS ä¸Šè¿è¡Œã€‚</li>
<li>ç»ˆæ­¢VMXå¹¶é‡Šæ”¾æˆ‘ä»¬ä¹‹å‰åˆ†é…çš„æ‰€æœ‰å†…å­˜: VMOFFï¼Œå¹¶ä¸”é‡Šæ”¾åˆ†é…çš„å†…å­˜ï¼ˆå°†<code>VMXON</code>å’Œ<code>VMCS Region</code>è½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€</li>
</ol>
<h4 id="for-example">for example</h4>
<p>é˜…è¯»ä¸€ä¸‹ <a href="https://github.com/tandasat/HyperPlatform">Intel VT-x based hypervisor aiming to provide a thin VM-exit filtering platform on Windows</a></p>
<p><strong>ä¸€ä¸ªæ¡†æ¶ï¼Œè€Œä¸æ˜¯å…·ä½“åº”ç”¨</strong>ã€‚å› æ­¤å¯èƒ½ç¼ºå°‘ä¸€ç‚¹é€»è¾‘</p>
<h5 id="driverentry">DriverEntry</h5>
<p>DriverEntry() è°ƒç”¨äº† VmInitialization()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// Checks if a VMM can be installed, and so, installs it
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>_Use_decl_annotations_ NTSTATUS <span style="color:#50fa7b">VmInitialization</span>() {
</span></span><span style="display:flex;"><span>  PAGED_CODE()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (VmpIsHyperPlatformInstalled()) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> STATUS_CANCELLED;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>VmpIsVmxAvailable()) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> STATUS_HV_FEATURE_UNAVAILABLE;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> <span style="color:#ff79c6">auto</span> shared_data <span style="color:#ff79c6">=</span> VmpInitializeSharedData();
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>shared_data) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> STATUS_MEMORY_NOT_ALLOCATED;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Read and store all MTRRs to set a correct memory type for EPT
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  EptInitializeMtrrEntries();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Virtualize all processors
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">auto</span> status <span style="color:#ff79c6">=</span> UtilForEachProcessor(VmpStartVm, shared_data);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status)) {
</span></span><span style="display:flex;"><span>    UtilForEachProcessor(VmpStopVm, <span style="color:#ff79c6">nullptr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> status;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¦–å…ˆæ£€æŸ¥æ˜¯å¦ä¹‹å‰å®‰è£…è¿‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">__cpuid</span>( 
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd">int</span> cpuInfo[<span style="color:#bd93f9">4</span>],   <span style="color:#6272a4">// åŒ…å«åœ¨ EAXã€EBXã€ECX å’Œ EDX ä¸­è¿”å›çš„æœ‰å…³ CPU æ”¯æŒçš„åŠŸèƒ½çš„ä¿¡æ¯ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#8be9fd">int</span> function_id   <span style="color:#6272a4">// åœ¨ EAX ä¸­ä¼ é€’çš„æŒ‡å®šè¦æ£€ç´¢çš„ä¿¡æ¯çš„ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Tests if HyperPlatform is already installed
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>_Use_decl_annotations_ <span style="color:#ff79c6">static</span> <span style="color:#8be9fd">bool</span> <span style="color:#50fa7b">VmpIsHyperPlatformInstalled</span>() {
</span></span><span style="display:flex;"><span>  PAGED_CODE()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> cpu_info[<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">=</span> {};
</span></span><span style="display:flex;"><span>  __cpuid(cpu_info, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> CpuFeaturesEcx cpu_features <span style="color:#ff79c6">=</span> {<span style="color:#ff79c6">static_cast</span><span style="color:#ff79c6">&lt;</span>ULONG32<span style="color:#ff79c6">&gt;</span>(cpu_info[<span style="color:#bd93f9">2</span>])};
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>cpu_features.fields.not_used) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  __cpuid(cpu_info, kHyperVCpuidInterface);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> cpu_info[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">==</span> &#39;PpyH&#39;;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ£€æŸ¥CPUå’Œæ“ä½œç³»ç»Ÿæ”¯æŒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// Checks if the system supports virtualization
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>_Use_decl_annotations_ <span style="color:#ff79c6">static</span> <span style="color:#8be9fd">bool</span> <span style="color:#50fa7b">VmpIsVmxAvailable</span>() {
</span></span><span style="display:flex;"><span>  PAGED_CODE()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// See: DISCOVERING SUPPORT FOR VMX
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// If CPUID.1:ECX.VMX[bit 5]=1, then VMX operation is supported.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int</span> cpu_info[<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">=</span> {};
</span></span><span style="display:flex;"><span>  __cpuid(cpu_info, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> CpuFeaturesEcx cpu_features <span style="color:#ff79c6">=</span> {<span style="color:#ff79c6">static_cast</span><span style="color:#ff79c6">&lt;</span>ULONG32<span style="color:#ff79c6">&gt;</span>(cpu_info[<span style="color:#bd93f9">2</span>])};
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>cpu_features.fields.vmx) {
</span></span><span style="display:flex;"><span>    HYPERPLATFORM_LOG_ERROR(<span style="color:#f1fa8c">&#34;VMX features are not supported.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// See: BASIC VMX INFORMATION
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// The first processors to support VMX operation use the write-back type.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">const</span> Ia32VmxBasicMsr vmx_basic_msr <span style="color:#ff79c6">=</span> {UtilReadMsr64(Msr<span style="color:#ff79c6">::</span>kIa32VmxBasic)};
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">static_cast</span><span style="color:#ff79c6">&lt;</span>memory_type<span style="color:#ff79c6">&gt;</span>(vmx_basic_msr.fields.memory_type) <span style="color:#ff79c6">!=</span>
</span></span><span style="display:flex;"><span>      memory_type<span style="color:#ff79c6">::</span>kWriteBack) {
</span></span><span style="display:flex;"><span>    HYPERPLATFORM_LOG_ERROR(<span style="color:#f1fa8c">&#34;Write-back cache type is not supported.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// See: ENABLING AND ENTERING VMX OPERATION
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  Ia32FeatureControlMsr vmx_feature_control <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>      UtilReadMsr64(Msr<span style="color:#ff79c6">::</span>kIa32FeatureControl)};
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>vmx_feature_control.fields.lock) {
</span></span><span style="display:flex;"><span>    HYPERPLATFORM_LOG_INFO(<span style="color:#f1fa8c">&#34;The lock bit is clear. Attempting to set 1.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> <span style="color:#ff79c6">auto</span> status <span style="color:#ff79c6">=</span> UtilForEachProcessor(VmpSetLockBitCallback, <span style="color:#ff79c6">nullptr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status)) {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>vmx_feature_control.fields.enable_vmxon) {
</span></span><span style="display:flex;"><span>    HYPERPLATFORM_LOG_ERROR(<span style="color:#f1fa8c">&#34;VMX features are not enabled.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>EptIsEptAvailable()) {
</span></span><span style="display:flex;"><span>    HYPERPLATFORM_LOG_ERROR(<span style="color:#f1fa8c">&#34;EPT features are not fully supported.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="driverunload">DriverUnload</h5>
<p>è°ƒç”¨VmTerminationå…³é—­VMM</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// Terminates VM
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>_Use_decl_annotations_ <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">VmTermination</span>() {
</span></span><span style="display:flex;"><span>  PAGED_CODE()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  HYPERPLATFORM_LOG_INFO(<span style="color:#f1fa8c">&#34;Uninstalling VMM.&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">auto</span> status <span style="color:#ff79c6">=</span> UtilForEachProcessor(VmpStopVm, <span style="color:#ff79c6">nullptr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (NT_SUCCESS(status)) {
</span></span><span style="display:flex;"><span>    HYPERPLATFORM_LOG_INFO(<span style="color:#f1fa8c">&#34;The VMM has been uninstalled.&#34;</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>    HYPERPLATFORM_LOG_WARN(<span style="color:#f1fa8c">&#34;The VMM has not been uninstalled (%08x).&#34;</span>, status);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  NT_ASSERT(<span style="color:#ff79c6">!</span>VmpIsHyperPlatformInstalled());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å›è°ƒå‡½æ•°ï¼Œè°ƒç”¨<code>VmpStopVm</code>ï¼Œä½¿ç”¨Cr4 disable <code>VMX</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// Stops virtualization through a hypercall and frees all related memory
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>_Use_decl_annotations_ <span style="color:#ff79c6">static</span> NTSTATUS <span style="color:#50fa7b">VmpStopVm</span>(<span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>context) {
</span></span><span style="display:flex;"><span>  UNREFERENCED_PARAMETER(context);
</span></span><span style="display:flex;"><span>  PAGED_CODE()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  HYPERPLATFORM_LOG_INFO(<span style="color:#f1fa8c">&#34;Terminating VMX for the processor %lu.&#34;</span>,
</span></span><span style="display:flex;"><span>                         KeGetCurrentProcessorNumberEx(<span style="color:#ff79c6">nullptr</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Stop virtualization and get an address of the management structure
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  ProcessorData <span style="color:#ff79c6">*</span>processor_data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">nullptr</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">auto</span> status <span style="color:#ff79c6">=</span> UtilVmCall(HypercallNumber<span style="color:#ff79c6">::</span>kTerminateVmm, <span style="color:#ff79c6">&amp;</span>processor_data);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>NT_SUCCESS(status)) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> status;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Clear CR4.VMXE, as there is no reason to leave the bit after vmxoff
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  Cr4 cr4 <span style="color:#ff79c6">=</span> {__readcr4()};
</span></span><span style="display:flex;"><span>  cr4.fields.vmxe <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">false</span>;
</span></span><span style="display:flex;"><span>  __writecr4(cr4.all);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  VmpFreeProcessorData(processor_data);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>UtilVmCallè°ƒç”¨AsmVmxCallï¼Œæœ€åæ˜¯å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>; <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">__stdcall</span> AsmVmxCall(_In_ ULONG_PTR hypercall_number,
</span></span><span style="display:flex;"><span>;                                    _In_opt_ <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>context);
</span></span><span style="display:flex;"><span>AsmVmxCall PROC
</span></span><span style="display:flex;"><span>    vmcall                  ; vmcall(hypercall_number, context)
</span></span><span style="display:flex;"><span>    jz errorWithCode        ; <span style="color:#ff79c6">if</span> (ZF) jmp
</span></span><span style="display:flex;"><span>    jc errorWithoutCode     ; <span style="color:#ff79c6">if</span> (CF) jmp
</span></span><span style="display:flex;"><span>    xor rax, rax            ; <span style="color:#ff79c6">return</span> VMX_OK
</span></span><span style="display:flex;"><span>    ret
</span></span></code></pre></div><h5 id="vmm--vm">VMM &amp;&amp; VM</h5>
<p>æ ¸å¿ƒåŠŸèƒ½</p>
<p>VMMæ˜¯hostä¸»è¦è´Ÿè´£çš„åŠŸèƒ½ï¼Œå„ç§è¡Œä¸ºçš„handlerï¼Œå¤„ç†vmcall</p>
<ul>
<li>ring -1 æŒæ§ç€çœŸæ­£çš„ç¡¬ä»¶èµ„æº</li>
</ul>
<p>vmcall/hypercall</p>
<ul>
<li>ç±»ä¼¼syscallï¼Œä½†æ˜¯guest OS</li>
<li>vmcall ä¼š vmexit è¿›å…¥hostï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç›¸åº”çš„Exit Handleræ¥å¤„ç†</li>
</ul>
<p>VM Exit: å­˜åœ¨ä¸€ä¸ªreasonï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œåˆ†åˆ«çš„å¤„ç†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">switch</span> (exit_reason.fields.reason) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> VmxExitReason<span style="color:#ff79c6">::</span><span style="color:#8be9fd;font-style:italic">kExceptionOrNmi</span>:
</span></span><span style="display:flex;"><span>      VmmpHandleException(guest_context);
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>      ...
</span></span></code></pre></div><p>VMæ˜¯guest OSï¼Œç±»ä¼¼ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// åˆå§‹åŒ–VM
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>VmpInitializeVm()
</span></span><span style="display:flex;"><span>	VmpEnterVmxMode()
</span></span><span style="display:flex;"><span>		__vmx_on()
</span></span><span style="display:flex;"><span>	VmpInitializeVmcs()  <span style="color:#6272a4">// åˆå§‹åŒ– VMCS
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		__vmx_clear()
</span></span><span style="display:flex;"><span>		__vmx_vmptrld()
</span></span><span style="display:flex;"><span>	VmpSetupVmcs()   <span style="color:#6272a4">// VMCS æˆå‘˜
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		_sgdt()
</span></span><span style="display:flex;"><span>		_sidt()
</span></span><span style="display:flex;"><span>		UtilVmWrite()
</span></span><span style="display:flex;"><span>	VmpLaunchVm()    <span style="color:#6272a4">// å¯åŠ¨
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		UtilVmRead()
</span></span><span style="display:flex;"><span>	__vmx_off();
</span></span></code></pre></div><h3 id="ept">EPT</h3>
<p>å†…å­˜è™šæ‹ŸåŒ–</p>
<p>Shadow pagingï¼Œä¸éœ€è¦ç¡¬ä»¶æ”¯æŒ</p>
<ul>
<li>ç›´æ¥å°† gva -&gt; hpa</li>
<li>è¿è¡Œguestæ—¶ï¼Œåˆ‡æ¢ host CR3 åˆ° shadow paging ï¼ˆhypervisor æ‹¦æˆª guest å¯¹ CR3çš„ä¿®æ”¹</li>
</ul>
<p>EPT, nested paging, åµŒå¥—é¡µè¡¨</p>
<ul>
<li>guestæ“ä½œç³»ç»Ÿç»´æŠ¤ä¸€å¼ é¡µè¡¨ï¼Œç”¨äºç”Ÿæˆguestçš„ç‰©ç†åœ°å€ã€‚CR3/EPTP</li>
<li>å¦ä¸€ä¸ªé¡µè¡¨ç”± VMM ç»´æŠ¤ï¼Œå®ƒå°† guest çš„ç‰©ç†åœ°å€æ˜ å°„åˆ° host çš„ç‰©ç†åœ°å€ã€‚</li>
</ul>
<p>Windows å››çº§é¡µè¡¨ï¼š9-9-9-9-12 <a href="https://www.cnblogs.com/lanrenxinxin/p/4735027.html">(1)</a></p>
<ul>
<li>PML4T: page map level4 table</li>
<li>PDPT: page directory pointer table</li>
<li>PD: page directory</li>
<li>PT: page table</li>
<li>entry + offset</li>
</ul>
<p><code>Physical Address Extension</code>: PAEç‰©ç†åœ°å€æ‰©å±•ï¼Œå¤„ç†å™¨åŠŸèƒ½ï¼Œä½¿ x86 å¤„ç†å™¨èƒ½å¤Ÿåœ¨æ”¯æŒè®¿é—®è¶…è¿‡ 4 GB çš„ç‰©ç†å†…å­˜ã€‚
<code>Page Size Extension</code>: PSEï¼Œæ˜¯åœ¨IA32æ¶æ„ä¸­ï¼Œå®ç°å¤§äºä¼ ç»Ÿçš„4KBçš„é¡µé¢</p>
<h2 id="amd-v">AMD-V</h2>
<p>åœ¨<a href="https://www.amd.com/en/developer/browse-by-resource-type/documentation.html">AMD Developer Documentation</a>ä¸­æœç´¢<code>AMD64 Architecture Programmerâ€™s Manual Volume 2: System Programming</code>ï¼Œç¬¬15ç« </p>
<p>å› ä¸ºç¬”è€…çš„æœºå™¨æ˜¯AMD CPUï¼Œå› æ­¤ä¸»è¦å­¦ä¹ AMD-Vã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ğŸ˜‹</p>
<h2 id="more">More</h2>
<p>ä¸é”™çš„é¡¹ç›®æ–‡ç« ï¼š<a href="https://memn0ps.github.io/hypervisor-development-in-rust-part-1/">Hypervisor Development in Rust Part 1 - memN0ps</a></p>
<p>Cr8ï¼šIrqlæƒé™ç­‰çº§ã€‚CPUçš„å½“å‰ä¼˜å…ˆçº§ã€‚å½“ä¸­æ–­æŒ‚èµ·æ—¶ï¼Œå°†ä¸­æ–­å‘é‡å·çš„7:4ä½ä¸CR8è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå‘é‡æ›´å¤§ï¼Œå®ƒå°†è¢«æœåŠ¡ï¼Œå¦åˆ™å®ƒå°†è¢«æŒ‚èµ·ï¼Œç›´åˆ°CR8è¢«è®¾ç½®ä¸ºè¾ƒä½çš„å€¼</p>
<p>Windows hype-V å¯ä»¥å¼€å¯åµŒå¥—è™šæ‹ŸåŒ–ã€‚</p>
<p>kAFL: å€ŸåŠ©Intel PT å’Œ VT-x çš„ç¡¬ä»¶åé¦ˆfuzzer</p>
<ul>
<li>PT: Processor tracer, è·Ÿè¸ªä¿¡æ¯</li>
</ul>
<p>Ring -1: Intel VT</p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/fuzz">Fuzz</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Â© ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
