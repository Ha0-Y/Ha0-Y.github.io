<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>æ±‡ç¼–å­¦ä¹  - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
åŸºæœ¬çš„æ±‡ç¼–å­¦ä¹ ã€‚
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="æ±‡ç¼–å­¦ä¹ " />
<meta property="og:description" content="
åŸºæœ¬çš„æ±‡ç¼–å­¦ä¹ ã€‚
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-06-10T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="æ±‡ç¼–å­¦ä¹ "/>
<meta name="twitter:description" content="
åŸºæœ¬çš„æ±‡ç¼–å­¦ä¹ ã€‚
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">æ±‡ç¼–å­¦ä¹ </h1>
			<div class="meta">Posted on Jun 10, 2023</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>åŸºæœ¬çš„æ±‡ç¼–å­¦ä¹ ã€‚</p>
</blockquote>
<p>å­¦ä¹ ç›®æ ‡ï¼šé¦–å…ˆèƒ½çœ‹æ‡‚ã€‚ç„¶åå°è¯•ç¼–å†™ <code>shellcode</code>ã€‚</p>
<p>ä¸ªäººä¹ æƒ¯å°å†™æŒ‡ä»¤ã€‚</p>
<ul>
<li><code>little-endian</code></li>
</ul>
<p>å¸¸è§çš„æ±‡ç¼–æ ¼å¼</p>
<ul>
<li>Intelæ ¼å¼ã€‚</li>
<li>AT&amp;Tï¼Œå®é™…ä½¿ç”¨ä¹Ÿå¾ˆå¸¸è§(Linuxä¸­é»˜è®¤çš„æ ¼å¼)</li>
</ul>
<p>éƒ¨åˆ†åè¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ISA: Instruction Set Architecture, æŒ‡ä»¤é›†æ¶æ„
</span></span><span style="display:flex;"><span>RISC: Reduced Instruction Set Computer, ç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—æœº
</span></span><span style="display:flex;"><span>CISC: Complex Instruction Set Computer, å¤æ‚æŒ‡ä»¤é›†è®¡ç®—æœº
</span></span><span style="display:flex;"><span>ABI: application binary interface
</span></span></code></pre></div><h2 id="ç¯å¢ƒé—®é¢˜">ç¯å¢ƒé—®é¢˜</h2>
<p>æœ¬æœº linux: ubuntu &amp;&amp; kali virtual machineï¼›CPU: AMDã€‚</p>
<ul>
<li>æ— æ³•ç›´æ¥è¿è¡Œ <code>arm</code> å’Œ <code>mips</code> æ¶æ„çš„ç¨‹åº</li>
<li>armå¯ä»¥ä½¿ç”¨æ‰‹æœºç»ˆç«¯ <a href="https://termux.dev/en/">Termux</a> è¿›è¡Œè¿è¡Œã€‚æˆ–è€…è´­ä¹°äº‘æœåŠ¡å™¨?</li>
</ul>
<h3 id="ç¯å¢ƒå®‰è£…">ç¯å¢ƒå®‰è£…</h3>
<p>åŸºæœ¬ç¯å¢ƒ <code>user mode+kernel mode</code>ã€‚</p>
<ul>
<li>è¿è¡Œç¨‹åºåªéœ€è¦ä¸€ä¸ª<code>qemu-user</code> å°±è¡Œï¼Œå¯åŠ¨ç³»ç»Ÿéœ€è¦ <code>qemu-system-xxx</code></li>
<li>ç”šè‡³å¯ä»¥ <code>qemu-system</code> è·‘kernelï¼Œç„¶åè·‘ç¨‹åºğŸ˜‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># qemu userç”¨æˆ·æ€ systemå¯åŠ¨å†…æ ¸é•œåƒ</span>
</span></span><span style="display:flex;"><span>sudo apt install qemu-user
</span></span></code></pre></div><p>arm ç¯å¢ƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># gun ç¼–è¯‘å·¥å…·é“¾ + åŠ¨æ€é“¾æ¥åº“</span>
</span></span><span style="display:flex;"><span>sudo apt list gcc* | grep arm
</span></span><span style="display:flex;"><span>sudo apt install gcc-arm-linux-gnueabi gcc-aarch64-linux-gnu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># optional: qemu arm system mode</span>
</span></span><span style="display:flex;"><span>sudo apt list  <span style="color:#f1fa8c">&#34;qemu*&#34;</span> <span style="color:#6272a4"># å¯»æ‰¾å¯¹ç”¨çš„arch</span>
</span></span><span style="display:flex;"><span>sudo apt install qemu-system-arm qemu-system-aarch64
</span></span></code></pre></div><p>mips ç¯å¢ƒ.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># gun ç¼–è¯‘å·¥å…·é“¾</span>
</span></span><span style="display:flex;"><span>sudo apt install gcc-mips-linux-gnu gcc-mips64-linux-gnuabi64 gcc-mipsel-linux-gnu gcc-mips64el-linux-gnuabi64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># optional: qemu mips system mode, ç›®å‰æ²¡è§è¿‡ï¼Œ user mode åº”è¯¥å¤Ÿäº†</span>
</span></span><span style="display:flex;"><span>sudo apt install qemu-system-mips
</span></span></code></pre></div><p>gdb</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install gdb gdb-multiarch
</span></span></code></pre></div><h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<p>qemu-user ä½¿ç”¨ <code>-g</code> gdbæ¨¡å¼ ç¡®å®šgdbè°ƒè¯•ç«¯å£</p>
<p>qemu-system ä½¿ç”¨ <code>-s -S  æˆ–è€… -gdb tcp:1234</code> gdbserverç­‰å¾…è¿æ¥ï¼Œé»˜è®¤ç«¯å£ <code>1234</code></p>
<p>ç¼–ç¨‹æµ‹è¯•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;hello, world!&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯»æ‰¾åŠ¨æ€é“¾æ¥åº“ã€‚<code>lib-&gt;/usr/lib</code> çš„é“¾æ¥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -al /usr/lib | grep arm  <span style="color:#6272a4"># aarch64 mips...</span>
</span></span></code></pre></div><p>arm æµ‹è¯•ï¼Œä¸çŸ¥ä¸ºä»€ä¹ˆï¼Œæµ‹è¯•æ—¶ <code>-g</code>æ”¾å‰é¢æ‰æˆåŠŸ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># ç¼–è¯‘</span>
</span></span><span style="display:flex;"><span>arm-linux-gnueabi-gcc hello.c -o helloarm -g
</span></span><span style="display:flex;"><span>aarch64-linux-gnu-gcc hello.c -o helloaarch -g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>$ qemu-arm -L /usr/arm-linux-gnueabi ./helloarm
</span></span><span style="display:flex;"><span>$ qemu-aarch64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># è°ƒè¯•</span>
</span></span><span style="display:flex;"><span>$ qemu-arm -g <span style="color:#bd93f9">1234</span> -L /usr/arm-linux-gnueabi ./helloarm 
</span></span><span style="display:flex;"><span>$ gdb-multiarch
</span></span><span style="display:flex;"><span>gdb&gt; <span style="color:#8be9fd;font-style:italic">set</span> arch arm <span style="color:#6272a4"># aarch64</span>
</span></span><span style="display:flex;"><span>gdb&gt; target remote localhost:1234
</span></span><span style="display:flex;"><span>xxx 
</span></span></code></pre></div><p>mips æµ‹è¯•, ä¸armç±»ä¼¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ mips-linux-gnu-gcc hello.c -o hellomips -g
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="x86">x86</h2>
<p>CISC</p>
<h3 id="x86-1">x86</h3>
<p>intel x86 é€šç”¨å¯„å­˜å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; é€šç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">eax:</span> ç´¯åŠ å™¨
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ebx:</span> ä¸€èˆ¬åŸºå€å¯„å­˜å™¨ï¼Œ<span style="color:#50fa7b">base</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ecx:</span> <span style="color:#50fa7b">counter</span>, åœ¨loopæ—¶ï¼Œé»˜è®¤è®¡æ•°
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">edx:</span> ä¸€èˆ¬ç”¨äºå­˜æ”¾<span style="color:#50fa7b">data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">esi:</span> <span style="color:#50fa7b">source</span> index, å¤„ç†å­—ç¬¦ä¸²å¸¸ç”¨
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">edi:</span> <span style="color:#50fa7b">destinatin</span> index, å¤„ç†å­—ç¬¦ä¸²å¸¸ç”¨
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">esp:</span> <span style="color:#50fa7b">stack</span> pointer, æ ˆé¡¶
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ebp:</span> <span style="color:#50fa7b">base</span> pointer, æ ˆåŸºå€
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">eip:</span> æŒ‡å‘å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚
</span></span></code></pre></div><p>æ ‡å¿—ä½ <code>eflags</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">CF:</span> <span style="color:#50fa7b">carry</span> flag, è¿›ä½
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ZF:</span> <span style="color:#50fa7b">zero</span>, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SF:</span> <span style="color:#50fa7b">sign</span>, ç¬¦å·
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">OF:</span> <span style="color:#50fa7b">overflow</span>, æº¢å‡º
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">TF:</span> <span style="color:#50fa7b">trap</span>, è·Ÿè¸ª
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">IF:</span> <span style="color:#50fa7b">interrupt</span>, ä¸­æ–­
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PF:</span> <span style="color:#50fa7b">parity</span>, å¥‡å¶
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">...</span>
</span></span></code></pre></div><p>æ®µå¯„å­˜å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cs:</span> <span style="color:#50fa7b">code</span> segment ä»£ç æ®µ
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ds:</span> <span style="color:#50fa7b">data</span> æ•°æ®æ®µ
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ss:</span> <span style="color:#50fa7b">stack</span> å †æ ˆæ®µ
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">es:</span> <span style="color:#50fa7b">extend</span> æ‰©å±•æ®µ
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">fs:</span> æ•°æ®æ®µ
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">gs:</span> æ•°æ®æ®µ
</span></span></code></pre></div><p>æ§åˆ¶å¯„å­˜å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; æŸäº›ä¿æŠ¤æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cr0-cr4</span>
</span></span></code></pre></div><p>å¯»å€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#50fa7b">mov</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">lea</span>
</span></span></code></pre></div><p>ç®—æœ¯æŒ‡ä»¤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; åŸºæœ¬è¿ç®—
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">add</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">sub</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">mul</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">div</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">inc</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">dec</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; é€»è¾‘è¿ç®—
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cmp</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">and</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">or</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">xor</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">not</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; ç§»ä½æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">shl</span>  <span style="color:#6272a4">; shift left
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">shr</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">sal</span>  <span style="color:#6272a4">; shift arithmetic left ç®—æ•°å·¦ç§»
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">sar</span>
</span></span></code></pre></div><p>è·³è½¬</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; jmp ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">jmp</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">jb</span>   <span style="color:#6272a4">; blow
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">jg</span>   <span style="color:#6272a4">; greater
</span></span></span></code></pre></div><p>å‡½æ•°è°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#50fa7b">call</span> function
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; call æ‰§è¡Œæ—¶ï¼Œä¿å­˜ eip+4, å¹¶è·³è½¬åˆ°å¯¹åº”åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; å‚æ•°ä¼ é€’ï¼Œä½¿ç”¨æ ˆä¼ é€’å‚æ•°
</span></span></span></code></pre></div><p>æ ˆå¸§</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; åœ¨è°ƒç”¨å­ç¨‹åºæ—¶ï¼Œä¼šå¼€è¾Ÿå­ç¨‹åºçš„æ ˆå¸§ã€‚espå’Œebpä¿å­˜æ ˆé¡¶å’Œæ ˆåº•
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; åœ¨è¿”å›çˆ¶ç¨‹åºéœ€è¦è¿˜åŸesp, ebpæŒ‡é’ˆã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; æ ˆ ä½åœ°å€ç”Ÿé•¿
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; spè‡ªåŠ¨å˜åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">push</span> ebx  <span style="color:#6272a4">; sp-4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">pop</span> rax   <span style="color:#6272a4">; sp+4
</span></span></span></code></pre></div><p>ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; ç³»ç»Ÿä¸­æ–­å¤„ç†syscall
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">int</span> <span style="color:#bd93f9">0x80</span>            <span style="color:#6272a4">; eaxç³»ç»Ÿè°ƒç”¨å· ebx, ecx, edxå¯¹åº”å‡½æ•°å‰ä¸‰ä¸ªå‚æ•°
</span></span></span></code></pre></div><h3 id="x86-64">x86-64</h3>
<p>å®é™…ä¸Šx86-64ä¸AMD64åŸºæœ¬æ˜¯åŒä¸€ä¸ªISAï¼Œç°åœ¨æˆ‘ä»¬ä½¿ç”¨è´­ä¹°çš„Intelæˆ–è€…AMDç”Ÿäº§çš„CPUï¼Œéƒ½å±äºx86-64çš„ISAã€‚</p>
<p>x86-64: 64ä½ï¼Œå¯å¯»å€ <code>2^64</code>, å…¼å®¹x86</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; 32ä½ r-&gt;bæ¯”å¦‚ rax-&gt;eax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">rax</span>, rbx, rcx, rdx
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">rsi</span>, rdi
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">rsp</span>, rbp
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r8:</span> <span style="color:#50fa7b">r8d</span> <span style="color:#bd93f9">32</span>ä½ å¯„å­˜å™¨ï¼Œä½<span style="color:#bd93f9">32</span>ä½
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r9:</span> <span style="color:#50fa7b">r9d</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r10:</span> <span style="color:#50fa7b">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r11:</span> <span style="color:#50fa7b">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r12:</span> <span style="color:#50fa7b">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r13:</span> <span style="color:#50fa7b">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r14:</span> <span style="color:#50fa7b">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r15:</span> <span style="color:#50fa7b">...</span>
</span></span></code></pre></div><p>Linuxä¸‹å‡½æ•°è°ƒç”¨çº¦å®š, ä¸x86ç›¸å·®è¾ƒå¤§</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; å‡½æ•°å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">rdi</span>, rsi, rdx, rcx, r8, r9           <span style="color:#6272a4">; ä¼ é€’å‰6ä¸ªå‚æ•°ï¼Œç¬¬7ä¸ªå‚æ•°å¼€å§‹å’Œx86ä¸€æ ·ä½¿ç”¨æ ˆä¼ é€’
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; è¿”å›å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">rax</span>
</span></span></code></pre></div><p>ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; syscall
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">rax:</span> ç³»ç»Ÿè°ƒç”¨å·
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; å‚æ•°ä¼ é€’ä¸å‡½æ•°ä¸€è‡´ï¼Œ rdi, rsi...
</span></span></span></code></pre></div><h2 id="arm">ARM</h2>
<p>RISC</p>
<p>ARMæŒ‡ä»¤æ ¼å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#50fa7b">label</span> op-code oprand1 oprand2 oprand3 ...        @commit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ æ›´åŠ å­¦æœ¯ <span style="color:#8be9fd;font-style:italic">rd:</span> <span style="color:#50fa7b">destination</span><span style="color:#6272a4">; rn: å¯„å­˜å™¨ä¸­ç”¨äºç®—æœ¯è¿ç®—çš„æ“ä½œæ•°; shifter_operand: æ•°æ®å¤„ç†æŒ‡ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>&lt;<span style="color:#50fa7b">opcode</span>&gt; {&lt;cond&gt;} {S} &lt;rd&gt;,&lt;rn&gt;,&lt;shifter_operand&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ æ³¨é‡Š  `@`, `<span style="color:#6272a4">//`  `/**/` `;`
</span></span></span></code></pre></div><h3 id="armv7">ARMv7</h3>
<p>32ä½æŒ‡ä»¤é›†<code>A32</code>ï¼Œå…¼å®¹16ä½æŒ‡ä»¤é›†<code>T16</code></p>
<ul>
<li>ç”±äºARMv7 å…¼å®¹ <code>ARM</code>å’Œ <code>Thumb</code>æŒ‡ä»¤é›†ï¼ŒåŒºåˆ†ä¸¤ä¸ªæŒ‡ä»¤é›†ï¼š <code>addr &amp; 1 == 1</code>ä»£è¡¨<code>thumb</code>æŒ‡ä»¤é›†</li>
</ul>
<p>ARMv7é€šç”¨å¯„å­˜å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r0-r3:</span> <span style="color:#50fa7b">args</span>, å‡½æ•°å‰å››ä¸ªå‚æ•°ï¼Œè¿”å›å€¼ä¹Ÿä¼šå­˜å…¥r0. 
</span></span><span style="display:flex;"><span>r4-r10:  
</span></span><span style="display:flex;"><span>r11: fp, frame pointer
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r12:</span> <span style="color:#50fa7b">ip</span>, Intra-Procedure-call scratch register, åœ¨æ–°ç‰ˆæœ¬å½“ä½œé€šç”¨å¯„å­˜å™¨ä½¿ç”¨ï¼Œä¼šåœ¨blæ—¶å¼•å‘bug
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r13:</span> <span style="color:#50fa7b">sp</span>, stack pointer
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r14:</span> <span style="color:#50fa7b">lr</span>, link register
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">r15:</span> <span style="color:#50fa7b">pc</span>, program count, æŒ‡å‘ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤
</span></span></code></pre></div><p>æ ‡å¿—ä½(CPSR: program status reg),å¦‚æœæƒ³æ”¹å˜ï¼Œéœ€è¦åœ¨æŸäº›æŒ‡ä»¤ååŠ  <code>s</code> (sub -&gt; subs)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">N:</span> <span style="color:#50fa7b">negative</span>, è¿ç®—ç»“æœ&gt;=<span style="color:#bd93f9">0</span> N=<span style="color:#bd93f9">0</span>, è´Ÿæ•°ï¼ŒN=<span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Z:</span> <span style="color:#50fa7b">zero</span>, ä¸º<span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">C:</span> <span style="color:#50fa7b">carry</span>, è¿›ä½
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">V:</span> <span style="color:#50fa7b">overflow</span> æœ‰æº¢å‡º
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; cmp å¯ä»¥æ”¹å˜
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cmp</span> r0, r1
</span></span></code></pre></div><p>mov ç«‹å³æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#50fa7b">mov</span> r0, <span style="color:#6272a4">#1     @ r0 &lt;- 1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>@ ç‰¹æ®Šå¯„å­˜å™¨ <span style="color:#50fa7b">cpsr</span> || spsr
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">mrs</span> r0, cpsr   @ r0 &lt;- cpsr
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">msr</span> cpsr, r1   @ cpsr &lt;- r1
</span></span></code></pre></div><p>è®¿é—®å†…å­˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ ä¸èƒ½ç›´æ¥åƒ<span style="color:#50fa7b">intel</span> movè®¿é—®å†…å­˜, ä½¿ç”¨ load, storeå‘½ä»¤é—´æ¥è®¿é—®å†…å­˜
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">ldr</span> rd, [rn , <span style="color:#6272a4">#offset]   @ load register
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">str</span> rd, [rn, <span style="color:#6272a4">#offset]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ldm</span>                      @ load multiple
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">stm</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; ä¾‹å­
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ldr</span> r0, =<span style="color:#bd93f9">0X20000002</span>  @ r0=<span style="color:#bd93f9">0X20000002</span>ï¼ŒåŠ è½½åœ°å€åˆ°å¯„å­˜å™¨ 
</span></span><span style="display:flex;"><span>str r1, [r0]         @ r1 ä¸­çš„å€¼å†™å…¥åˆ° r0 ä¸­æ‰€ä¿å­˜çš„åœ°å€ä¸­
</span></span></code></pre></div><p>ç®—æœ¯æŒ‡ä»¤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ åŸºæœ¬ç®—æ•°è¿ç®—
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">add</span> rd, rn, rm   @ rd = rn + rm
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">sub</span> rd, rn, rm   @ rd = rn - rm
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">mul</span> rd, rn, rm   @ rd = rn * rm
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">sdiv</span> rd, rn, rm  @ rd = rn / rm, s(ign)div u(nsign)div
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ æƒ³æ”¹å˜æ ‡å¿—ä½, åŠ  &#39;<span style="color:#50fa7b">s</span>&#39; =&gt; subs...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ é€»è¾‘è¿ç®—
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">and</span> rd, rn       @ rd = rd &amp; rn
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">and</span> rd, rn, <span style="color:#6272a4">#imm @ rd = rn &amp; #imm
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">orr</span> rd, rn       @ rd = rd | rn
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">eor</span> rd, rn       @ rd = rd ^ rn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ ç§»ä½æ“ä½œ
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">lsl</span>   @ logic shift left é€»è¾‘å·¦ç§»
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">lsr</span>   @ é€»è¾‘å³ç§»
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">asr</span>   @ arithmetic shift right ç®—æ•°å³ç§»
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">ror</span>   @ rotate right å¾ªç¯å³ç§»
</span></span></code></pre></div><p>ç¨‹åºè·³è½¬</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">b:</span> ç›´æ¥è·³åˆ°<span style="color:#50fa7b">label</span>ã€‚ branch
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">bx:</span> è·³è½¬+çŠ¶æ€åˆ‡æ¢    @ <span style="color:#50fa7b">ARM</span>/Thumb æ¨¡å¼(ä½¿ç”¨ä¸€æ¬¡ï¼Œåˆ‡æ¢ä¸€æ¬¡)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">bl:</span> <span style="color:#50fa7b">b</span> + link, é¦–å…ˆä¿å­˜ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€åˆ°lr, ç„¶åæ”¹å˜pcã€‚
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">blx:</span> <span style="color:#50fa7b">bl</span>+bx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ æ¡ä»¶è·³è½¬, çŠ¶æ€å¯„å­˜å™¨
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">eq:</span> <span style="color:#50fa7b">equal</span> ç›¸ç­‰
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ne:</span> <span style="color:#50fa7b">not</span> eq
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">lt:</span> <span style="color:#50fa7b">less</span> 
</span></span><span style="display:flex;"><span>le: less equal
</span></span></code></pre></div><p>å‡½æ•°è°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ ä»ç„¶æ˜¯ä½¿ç”¨ `<span style="color:#50fa7b">b</span>` æŒ‡ä»¤è°ƒç”¨å‡½æ•°
</span></span></code></pre></div><p>æ ˆå¸§ç›¸å…³</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ <span style="color:#50fa7b">sp</span>, fp ç»´æŠ¤æ ˆå¸§çš„çŠ¶æ€, æ ˆå‘ ä½åœ°å€ç”Ÿé•¿
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">fp</span> -&gt; +-------+
</span></span><span style="display:flex;"><span>      | <span style="color:#50fa7b">frame</span> |
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">sp</span> -&gt; +-------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ <span style="color:#50fa7b">push</span>/pop å¯ä»¥æ“ä½œå¤šä¸ªå¯„å­˜å™¨ï¼Œç”šè‡³å¯ä»¥æ§åˆ¶pc<span style="color:#6272a4">; spè‡ªåŠ¨å˜åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@ ä¸‹é¢æ˜¯å¸¸è§çš„å‡½æ•°è°ƒç”¨å‡ºç°å‡ºç°çš„<span style="color:#50fa7b">gadget</span> 
</span></span><span style="display:flex;"><span>push {r0-r4, lr}           @ é¡ºåºæ˜¯ push r12<span style="color:#6272a4">; push r4; push r3 ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">...</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">pop</span> {r0-r4, pc}            @ é¡ºåºæ˜¯  pop r0<span style="color:#6272a4">; pop r1; ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>@ ç­‰ä»·äº <span style="color:#50fa7b">push</span>, å…ˆè®¡ç®—spçš„å€¼?
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">stmfd</span> sp!, {r0-r4, r12}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ ç­‰ä»·äº <span style="color:#50fa7b">pop</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">ldmfd</span> sp!, lr
</span></span></code></pre></div><p>ç³»ç»Ÿä¸­æ–­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ é€šè¿‡<span style="color:#50fa7b">vector_swi</span>/svc è·å¾—ç³»ç»Ÿè°ƒç”¨å·
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">swi</span> <span style="color:#6272a4">#imm
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">svc</span> <span style="color:#6272a4">#imm
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>@ <span style="color:#50fa7b">O</span>(old)ABI å½¢å¼
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">mov</span> r0, <span style="color:#6272a4">#34
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">swi</span> <span style="color:#bd93f9">12</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ <span style="color:#50fa7b">E</span>(extended)ABI å½¢å¼ï¼Œç«‹å³æ•° immè¢«å¿½ç•¥,ç”±r0å†³å®š
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">mov</span> r0, <span style="color:#6272a4">#12
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">mov</span> r1, <span style="color:#6272a4">#34
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">swi</span> <span style="color:#bd93f9">0</span>
</span></span></code></pre></div><h3 id="armv8">ARMv8</h3>
<p>ä¸ <code>armv7</code> å­˜åœ¨ä¸€å®šçš„åŒºåˆ«</p>
<p>64ä½æŒ‡ä»¤é›† <code>aarch64</code>, å…¼å®¹32ä½ <code>aarch32</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>aarch64: 64-bit registers and memory accesses, new instruction setï¼›
</span></span><span style="display:flex;"><span>aarch32: backwards compatible with ARMv7-A
</span></span></code></pre></div><p>ARMv8 é€šç”¨å¯„å­˜å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>x0-x31
</span></span><span style="display:flex;"><span>x0-x7: å‡½æ•°å‰8ä¸ªå‚æ•°å€¼
</span></span><span style="display:flex;"><span>x8: å‡½æ•°è¿”å›å€¼
</span></span><span style="display:flex;"><span>x19-x28: æ²¡ç‰¹æ®Šç”¨é€” 
</span></span><span style="display:flex;"><span>x29: fp frame pointer
</span></span><span style="display:flex;"><span>x30: lr
</span></span><span style="display:flex;"><span>x31: zr, zero register, æ’0
</span></span><span style="display:flex;"><span>x32: pc, ä¸èƒ½åƒarmv7ä¸€æ ·è¢«ä¿®æ”¹
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ ä¹Ÿå¯ä½¿ç”¨32ä½çš„ w0...å¯„å­˜å™¨, å¯æ‰©å±•ä½¿ç”¨
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ spå¯¹åº”çš„ç‰©ç†å¯„å­˜å™¨æœ‰å¦‚ä¸‹å››ä¸ª(æŸä¸€æ—¶åˆ»åªèƒ½å¯¹åº”ä¸‹é¢å…¶ä¸­ä¸€ä¸ª)
</span></span><span style="display:flex;"><span>SP_EL0å’ŒSP_EL1
</span></span><span style="display:flex;"><span>SP_EL2
</span></span><span style="display:flex;"><span>SP_EL3
</span></span></code></pre></div><p>SPSR æ›¿ä»£äº† CPSR</p>
<p>å†…å­˜è®¿é—®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ <span style="color:#50fa7b">load</span> &amp; store, å…¼å®¹armv7 ldr
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">ldp</span>  @ load pair ä¸€å¯¹ã€‚
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">ldp</span> x8, x2, [x0, <span style="color:#6272a4">#0x10]   @ å°†x8&lt;-(x0+0x10), x2&lt;-(x0+0x10+8)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">stp</span>  @ store pair
</span></span></code></pre></div><p>å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ å‚æ•°ä¼ é€’
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">x0-x7:</span> å‡½æ•°å‰8ä¸ªå‚æ•°å€¼
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">x8:</span> å‡½æ•°è¿”å›å€¼
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@ <span style="color:#50fa7b">aarch64æ²¡æœ‰pushå’Œpop</span> æŒ‡ä»¤
</span></span></code></pre></div><p>ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>@ <span style="color:#50fa7b">supervisor</span> call
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">svc</span> <span style="color:#6272a4">#imm
</span></span></span></code></pre></div><p>TrustZone ç›¸å…³</p>
<h3 id="armv9">ARMv9</h3>
<p>xxx</p>
<h2 id="mips">Mips</h2>
<p>RISCï¼Œ <code>Microprocessor without Interlocked Pipeline Stages</code></p>
<p><code>mips</code> æ˜¯<code>big-endian</code>, mipselæ˜¯ <code>little-endian</code></p>
<p>æ ¼å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4"># æ ¹æ®ä½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>31-26   25-21 20-16 15-11  10-6  5-0
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">op-code</span>   rs    rt   rd    shamt func
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># æ³¨é‡Šä½¿ç”¨ `#`
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">rd:</span> <span style="color:#50fa7b">register</span> destination
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">rt:</span> <span style="color:#50fa7b">target</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">rs:</span> <span style="color:#50fa7b">source</span>
</span></span></code></pre></div><p>é€šç”¨å¯„å­˜å™¨ï¼Œ 32ä¸ª</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$0-$31          # æœ‰å„è‡ªçš„åŠ©è®°ç¬¦ï¼Œçœ‹æ±‡ç¼–æ—¶å¤šä½¿ç”¨åŠ©è®°ç¬¦
</span></span><span style="display:flex;"><span>$0:    $zero    # æ’0
</span></span><span style="display:flex;"><span>1:     $at      # 
</span></span><span style="display:flex;"><span>2-3:   $v0-v1   # value å‡½æ•°è¿”å›å€¼
</span></span><span style="display:flex;"><span>4-7:   $a0-a3   # arg  å‡½æ•°å‚æ•°
</span></span><span style="display:flex;"><span>8-15:  $t0-t7   # temp
</span></span><span style="display:flex;"><span>16-23: $s0-s7   # save ä¿ç•™
</span></span><span style="display:flex;"><span>24-25: $t8-t9   # temp
</span></span><span style="display:flex;"><span>16-27: $k0-k1   # å¼‚å¸¸æˆ–ä¸­æ–­
</span></span><span style="display:flex;"><span>28:    $gp      # global pointer
</span></span><span style="display:flex;"><span>29:    $sp      # stack pointer
</span></span><span style="display:flex;"><span>30:    $fp, s8  # frame pointer 
</span></span><span style="display:flex;"><span>31:    $ra      # ret addr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; ç‰¹æ®Š
</span></span><span style="display:flex;"><span>pc: program cunter
</span></span></code></pre></div><p>æŒ‡ä»¤æ ¼å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>r: register format # ä½¿ç”¨å¯„å­˜å™¨
</span></span><span style="display:flex;"><span>i: immediate       # ä½¿ç”¨ç«‹å³æ•°
</span></span><span style="display:flex;"><span>j: jump
</span></span></code></pre></div><p>å¯»å€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>move $a0, $zero    # a0&lt;-0
</span></span></code></pre></div><p>è®¿é—®å†…å­˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#6272a4"># ä»ç„¶ load, store</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># b: byte; w: word; h: half word; ...</span>
</span></span><span style="display:flex;"><span>sw: sw <span style="color:#ff79c6">$</span>ra, <span style="color:#bd93f9">0x38</span>(<span style="color:#ff79c6">$</span>sp)   <span style="color:#6272a4"># å°†$raå­˜å…¥æ ˆä¸­ $sp+38çš„åœ°æ–¹</span>
</span></span><span style="display:flex;"><span>sb: <span style="color:#ff79c6">...</span>
</span></span><span style="display:flex;"><span>lw: <span style="color:#ff79c6">...</span>
</span></span><span style="display:flex;"><span>lb: <span style="color:#ff79c6">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ä¾‹å­</span>
</span></span><span style="display:flex;"><span>sb r1, <span style="color:#bd93f9">0</span>(R2)
</span></span><span style="display:flex;"><span>lb r1, <span style="color:#bd93f9">0</span>(r2)
</span></span></code></pre></div><p>ç®—æœ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>; åŸºæœ¬ç®—æœ¯
</span></span><span style="display:flex;"><span>add
</span></span><span style="display:flex;"><span>sub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; é€»è¾‘
</span></span><span style="display:flex;"><span>or
</span></span><span style="display:flex;"><span>xor
</span></span><span style="display:flex;"><span>nor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; ç§»ä½
</span></span><span style="display:flex;"><span>sll
</span></span><span style="display:flex;"><span>srl
</span></span></code></pre></div><p>è·³è½¬</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>; jmp
</span></span><span style="display:flex;"><span>j: jmp label
</span></span><span style="display:flex;"><span>jr: ç”¨æ³• jr $ra ç­‰
</span></span><span style="display:flex;"><span>jal: jmp and link, ä¿å­˜ ret addr(pc+4) åˆ° $ra
</span></span><span style="display:flex;"><span>jalr: å€Ÿç”¨å¯„å­˜å™¨è·³è½¬ï¼Œé“¾æ¥ï¼Œå¸¸ç”¨
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; branch, åé¢éœ€è¦è·Ÿæ“ä½œ
</span></span><span style="display:flex;"><span>beq: beq $s, $t, offset   # $s=$tè·³è½¬
</span></span><span style="display:flex;"><span>bne: b not eq
</span></span><span style="display:flex;"><span>bltz: branch less than zero
</span></span></code></pre></div><p>æ¶æ„ç¼“å­˜</p>
<ul>
<li>æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„cache: æŒ‡ä»¤ å’Œ æ•°æ®</li>
</ul>
<h2 id="risc-v">RISC-V</h2>
<p>xxx</p>
<h2 id="gcc-inline-assembly">GCC Inline Assembly</h2>
<p>å†…è”æ±‡ç¼–ï¼Œæˆ‘çš„ç†è§£æ˜¯ç›´æ¥å†™ æ±‡ç¼–è¯­å¥å°±è¡Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">asm</span>(<span style="color:#f1fa8c">&#34;mov $1, %eax&#34;</span>)
</span></span></code></pre></div><p>æ‰©å±•å†…é“¾æ±‡ç¼–ï¼Œæœ‰ç‚¹ä¸åŒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">asm</span> ( assembler <span style="color:#ff79c6">template</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">:</span> output operands                   <span style="color:#6272a4">/* optional è¾“å‡º */</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">:</span> input operands                    <span style="color:#6272a4">/* optional è¾“å…¥*/</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">:</span> list of clobbered registers       <span style="color:#6272a4">/* optional é€šçŸ¥ç¼–è¯‘å™¨å¯èƒ½é€ æˆå¯„å­˜å™¨æˆ–å†…å­˜æ•°æ®ç ´åï¼Œæå‰ä¿æŠ¤*/</span>  
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>æŸäº›è§„åˆ™ï¼Œä¸»è¦</p>
<ul>
<li>r: register</li>
<li>m:memory</li>
<li>å¸¸ç”¨å¯„å­˜å™¨</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>a rax/eax/ax/al
</span></span><span style="display:flex;"><span>b rbx
</span></span><span style="display:flex;"><span>c rcx
</span></span><span style="display:flex;"><span>d rdx
</span></span><span style="display:flex;"><span>S rsi
</span></span><span style="display:flex;"><span>D rdi
</span></span><span style="display:flex;"><span>I å¸¸æ•°å€¼
</span></span><span style="display:flex;"><span>q,r åŠ¨æ€åˆ†é…çš„å¯„å­˜å™¨
</span></span><span style="display:flex;"><span>g eax,ebx,ecx,edxæˆ–å†…å­˜å˜é‡
</span></span><span style="display:flex;"><span>A æŠŠeaxå’Œedxåˆæˆä¸€ä¸ª64ä½çš„å¯„å­˜å™¨(use long longs)
</span></span></code></pre></div><ol>
<li>ä½¿ç”¨ q æŒ‡ç¤ºç¼–è¯‘å™¨ä» eax, ebx, ecx, edx åˆ†é…å¯„å­˜å™¨ã€‚ ä½¿ç”¨ r æŒ‡ç¤ºç¼–è¯‘å™¨ä» eax, ebx, ecx, edx, esi, edi åˆ†é…å¯„å­˜å™¨ã€‚</li>
<li>ä¸å¿…æŠŠç¼–è¯‘å™¨åˆ†é…çš„å¯„å­˜å™¨æ”¾å…¥æ”¹å˜çš„å¯„å­˜å™¨åˆ—è¡¨ï¼Œå› ä¸ºå¯„å­˜å™¨å·²ç»è®°ä½äº†å®ƒä»¬ã€‚</li>
<li><code>&quot;=&quot;</code> æ˜¯æ ‡ç¤ºè¾“å‡ºå¯„å­˜å™¨ï¼Œ<strong>å¿…é¡»è¿™æ ·ç”¨</strong>ã€‚</li>
<li>æ•°å­— <code>%n</code> çš„ç”¨æ³•ï¼šæ•°å­—è¡¨ç¤ºçš„å¯„å­˜å™¨æ˜¯æŒ‰ç…§å‡ºç°å’Œä»å·¦åˆ°å³çš„é¡ºåºæ˜ å°„åˆ°ç”¨&quot;r&quot;æˆ–&quot;q&quot;è¯·æ±‚çš„å¯„å­˜å™¨ï¼å¦‚æœè¦é‡ç”¨&quot;r&quot;æˆ–&quot;q&quot;è¯·æ±‚çš„å¯„å­˜å™¨çš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚</li>
</ol>
<p>ä¾‹å­ 1</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">asm</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;cld/n/t&#34;</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;rep/n/t&#34;</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;stosl&#34;</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">:</span> <span style="color:#6272a4">/* no output registers */</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;c&#34;</span> (count), <span style="color:#f1fa8c">&#34;a&#34;</span> (fill_value), <span style="color:#f1fa8c">&#34;D&#34;</span> (dest)  
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;%edi&#34;</span> 
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// intel æ ¼å¼ï¼šcount ç­‰éƒ½æ˜¯å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>push edi
</span></span><span style="display:flex;"><span>mov ecx, count
</span></span><span style="display:flex;"><span>mov eax, fill_value
</span></span><span style="display:flex;"><span>mov edi, dest
</span></span><span style="display:flex;"><span>cld
</span></span><span style="display:flex;"><span>rep
</span></span><span style="display:flex;"><span>stosl
</span></span></code></pre></div><p>ä¾‹å­2ï¼šåŠ å…¥æ•°å­—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__asm__ (
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;push %%rax&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">&#34;pop %0&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;=m&#34;</span>(var)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;c&#34;</span>(count)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">:</span> memory
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://learningos.cn/ucore_os_webdocs/lab0/lab0_2_3_1_3_gcc_inline_asm.html">GCC åŸºæœ¬å†…è”æ±‡ç¼– Â· GitBook (learningos.cn)</a></p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/asm">asm</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Â© ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
